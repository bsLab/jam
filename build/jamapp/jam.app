#!/usr/bin/env jx
var CoreModule={};CoreModule['com/io']='com/io.app';CoreModule['assert']='os/assert';CoreModule['events']='os/events';CoreModule['path']='os/path';CoreModule['string_decoder']='os/string_decoder';CoreModule['crypto']='crypto';CoreModule['util']='os/util';CoreModule['http']='http';CoreModule['os']='os';CoreModule['fs']='fs';CoreModule['stream']='';CoreModule['url']='os/url';CoreModule['child_process']='child_process';CoreModule['zlib']='';var BundleModuleCode=[];var BundleObjectCode=[];var BundleModules=[];function _isdir(path){var stats=Fs.statSync(path);return stats&&stats.isDirectory()};function _search(index,file){if(PATH.length==index)return file;var path=PATH[index];if(Fs.existsSync(path+"/"+file+".js"))return path+"/"+file+".js";else if(Fs.existsSync(path+"/"+file)&&!_isdir(path+"/"+fil))return path+"/"+file;else return _search(index+1,file);}
var Fs=require("fs");if(typeof __dirname=='undefined')__dirname='';if(typeof __filename=='undefined')__filename='/home/sbosse/proj/jam/js/top/jamapp.js';if(typeof global=='undefined')global={};PATH=[process.cwd(),".","/home/sbosse/proj/jam/js"];function search(index,file){if(file.indexOf("/")==-1)return file;if(PATH.length==index)return file;var path=PATH[index];if(Fs.existsSync(path+"/"+file+".js"))return path+"/"+file+".js";else if(Fs.existsSync(path+"/"+file))return path+"/"+file;else return search(index+1,file);}
function Require(modupath){var file,filepath;if(BundleModules[modupath])return BundleModules[modupath];var exports={};var module={exports:exports};if(CoreModule[modupath]!=undefined)modupath=CoreModule[modupath];if(modupath=='')return undefined;if(BundleModuleCode[modupath])BundleModuleCode[modupath](module,exports);else if(BundleObjectCode[modupath])BundleObjectCode[modupath](module,exports);else{try{file=search(0,modupath);module=require(file)}
catch(e){var more="";if((e.name==="SyntaxError"||e.name==="TypeError")&&file){var src=Fs.readFileSync(file,"utf8");var Esprima=Require("parser/esprima");try{var ast=Esprima.parse(src,{tolerant:true,loc:true});if(ast.errors&&ast.errors.length>0)more=", "+ast.errors[0];}catch(e){if(e.lineNumber)more=", in line "+e.lineNumber;}}
console.log("Require import of "+file+" failed: "+e+more);throw e;}}
BundleModules[modupath]=module.exports||module;return module.exports||module;};FilesEmbedded=global.FilesEmbedded={};FileEmbedd=global.FileEmbedd=function(path,format){};FileEmbedded=global.FileEmbedded=function(path,format){return FilesEmbedded[path](format);};global.TARGET='node';BundleModuleCode['com/io.app']=function(module,exports){var util=Require('util');var GetEnv=Require('os/getenv');var Base64=Require('os/base64');var Fs=Require('fs');Require('os/polyfill')
var stderr_fun=function(str){process.stderr.write(str);};var stdout_fun=function(str){process.stdout.write(str);};var tracefile=undefined;var tracing=false;var timestamp=false;global.open=function(name,context,as){var module=Require(name);if(!context)context=global;for(var p in module){context[p]=module[p];};if(as)context[as]=module;}
global.print=console.log;global.checkOptions=function(options,defaultOptions){return Object.assign({},defaultOptions||{},options)};global.checkOption=function(option,defaultOption){return option==undefined?defaultOption:option};var io={options:{columns:undefined,rows:undefined,log:console.log,err:console.err,warn:console.warn,},close:function(fd){Fs.closeSync(fd);},Date:function()
{var now=new Date();var year=""+now.getFullYear();var month="0"+(now.getMonth()+1);month=month.substring(month.length-2);var date="0"+now.getDate();date=date.substring(date.length-2);return year+"-"+month+"-"+date;},debug:function(msg){this.options.err('Debug: '+msg);},exists:function(path){return Fs.existsSync(path);},error:undefined,err:function(msg){this.options.err('Error: '+msg);throw Error(msg);},exit:function(n){process.exit(n);},fail:function(msg){this.options.err('Fatal Error: '+msg);process.exit(0);},file_exists:function(path){return Fs.existsSync(path);},file_search:function(name){if(this.file_exists(name))return name;else if(typeof PATH!=='undefined'){for(var p in PATH){if(this.file_exists(PATH[p]+'/'+name))return(PATH[p]+'/'+name);}
return undefined;}else return undefined;},file_size:function(path){var stat=Fs.statSync(path);if(stat!=undefined)
return stat.size;else
return-1;},file_time:function(path,timekind){var stat=Fs.statSync(path);if(stat!=undefined)
switch(timekind){case'a':return stat.atime.getTime()/1000;case'c':return stat.ctime.getTime()/1000;case'm':return stat.mtime.getTime()/1000;default:return stat.mtime.getTime()/1000;}
else
return-1;},getargs:function(){return process.argv;},getenv:function(name,def){return GetEnv(name,def);},inspect:function(obj){return util&&util.inspect?util.inspect(obj):(typeof obj)},log:function(condmsg){if(condmsg==true)return;if(!timestamp)console.warn(condmsg);else{var date=new Date();var time=Math.floor(date.getTime());console.warn('['+process.pid+':'+time+']'+condmsg);}},mem:function(){var mem=process.memoryUsage();return{data:(mem.rss/1024)|0,heap:(mem.heapUsed/1024)|0};},open:function(path,mode){return Fs.openSync(path,mode);},out:function(msg){this.options.log(msg)},printstack:function(e,where){if(!e.stack)e=new Error(e);if(!e.stack)e.stack='empty stack';var stack=e.stack.replace(/^\s+at\s+/gm,'').replace(/^Object.<anonymous>\s*\(/gm,'{anonymous}()@').split('\n');if(where==undefined)this.out(e);else this.out(where+': '+e);this.out('Stack Trace');this.out('--------------------------------');for(var i in stack){if(i>0){var line=stack[i];if(line.indexOf('Module.',0)>=0)break;this.out('   at '+line);}}
this.out('--------------------------------');},read:function(fd,len,foff){},read_file:function(path){try{return Fs.readFileSync(path,'utf8');}catch(e){this.error=e;return undefined;}},read_file_bin:function(path){try{return Fs.readFileSync(path);}catch(e){this.error=e;return undefined;}},read_line:function(fd){},read_buf:function(fd,buf,boff,len,foff){return Fs.readSync(fd,buf,boff,len,foff);},sprintstack:function(e){var str='';if(e==_||!e.stack)e=new Error(e);if(!e.stack)e.stack='empty stack';var stack=e.stack.replace(/^\s+at\s+/gm,'').replace(/^Object.<anonymous>\s*\(/gm,'{anonymous}()@').replace(/^Object.eval\s*\(/gm,'').split('\n');for(var i in stack){if(i>0){var line=stack[i];if(line.indexOf('Module.',0)>=0)break;if(str!='')str+='\n';str+='  at '+line;}}
return str;},stacktrace:function(){var e=new Error('dummy');if(!e.stack)e.stack='empty stack';var stack=e.stack.replace(/^[^\(]+?[\n$]/gm,'').replace(/^\s+at\s+/gm,'').replace(/^Object.<anonymous>\s*\(/gm,'{anonymous}()@').split('\n');this.out('Stack Trace');this.out('--------------------------------');for(var i in stack){if(i>0){var line=stack[i];if(line.indexOf('Module.',0)>=0)break;this.out('  at '+line);}}
this.out('--------------------------------');},set_stderr:function(fun){stderr_fun=fun;},set_stdout:function(fun){stdout_fun=fun;},stderr:function(msg){stderr_fun(msg);},sleep:function(delay){var start=new Date().getTime();while(new Date().getTime()<start+delay);},stdout:function(msg){stdout_fun(msg);},sync:function(fd){Fs.fsyncSync(fd);},date:function(){var date=Date();return date.split(' ').slice(1,5).join(' ');},time:function(){var date=new Date();return Math.floor(date.getTime());},Time:function()
{var now=new Date();var hour="0"+now.getHours();hour=hour.substring(hour.length-2);var minute="0"+now.getMinutes();minute=minute.substring(minute.length-2);var second="0"+now.getSeconds();second=second.substring(second.length-2);return hour+":"+minute+":"+second;},trace:function(condmsg){if(condmsg!=true&&tracefile!=undefined){var date=new Date();var time=Math.floor(date.getTime());Fs.writeSync(tracefile,'['+time+'] '+condmsg+'\n');}},tracing:tracing,trace_open:function(path){tracefile=Fs.openSync(path,'w+');if(tracefile!=undefined)this.tracing=false;},warn:function(msg){if(!timestamp)this.options.warn('Warning: '+msg);else{var date=new Date();var time=Math.floor(date.getTime());console.warn('['+process.pid+':'+time+'] Warning: '+msg);}},workdir:function(){return this.getenv('PWD',this.getenv('CWD',''));},write:function(fd,data,foff){return Fs.writeSync(fd,data,foff);},write_buf:function(fd,buf,bpos,blen,foff){return Fs.writeSync(fd,buf,bpos,blen,foff);},write_file:function(path,str){try{Fs.writeFileSync(path,str,'utf8');return str.length;}catch(e){return-1;}},write_file_bin:function(path,buf){try{Fs.writeFileSync(path,buf,'binary');return buf.length;}catch(e){this.error=e;return-1;}},write_line:function(fd,str){return Fs.writeSync(fd,str+NL);},fork:undefined,exec:undefined,execSync:undefined,spawn:undefined,hostname:function(){return'localhost'}};module.exports=io;};BundleModuleCode['os/util']=function(module,exports){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]));}
return objects.join(' ');}
var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==='%%')return'%';if(i>=len)return x;switch(x){case'%s':return String(args[i++]);case'%d':return Number(args[i++]);case'%j':try{return JSON.stringify(args[i++]);}catch(_){return'[Circular]';}
default:return x;}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=' '+x;}else{str+=' '+inspect(x);}}
return str;};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments);};}
if(process.noDeprecation===true){return fn;}
var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg);}else if(process.traceDeprecation){console.trace(msg);}else{console.error(msg);}
warned=true;}
return fn.apply(this,arguments);}
return deprecated;};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))
debugEnviron=process.env.NODE_DEBUG||'';set=set.toUpperCase();if(!debugs[set]){if(new RegExp('\\b'+set+'\\b','i').test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error('%s %d: %s',set,pid,msg);};}else{debugs[set]=function(){};}}
return debugs[set];};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts;}else if(opts){exports._extend(ctx,opts);}
if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth);}
exports.inspect=inspect;inspect.colors={'bold':[1,22],'italic':[3,23],'underline':[4,24],'inverse':[7,27],'white':[37,39],'grey':[90,39],'black':[30,39],'blue':[34,39],'cyan':[36,39],'green':[32,39],'magenta':[35,39],'red':[31,39],'yellow':[33,39]};inspect.styles={'special':'cyan','number':'yellow','boolean':'yellow','undefined':'grey','null':'bold','string':'green','date':'magenta','regexp':'red'};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return'\u001b['+inspect.colors[style][0]+'m'+str+'\u001b['+inspect.colors[style][1]+'m';}else{return str;}}
function stylizeNoColor(str,styleType){return str;}
function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true;});return hash;}
function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes);}
return ret;}
var primitive=formatPrimitive(ctx,value);if(primitive){return primitive;}
var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value);}
if(isError(value)&&(keys.indexOf('message')>=0||keys.indexOf('description')>=0)){return formatError(value);}
if(keys.length===0){if(isFunction(value)){var name=value.name?': '+value.name:'';return ctx.stylize('[Function'+name+']','special');}
if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}
if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),'date');}
if(isError(value)){return formatError(value);}}
var base='',array=false,braces=['{','}'];if(isArray(value)){array=true;braces=['[',']'];}
if(isFunction(value)){var n=value.name?': '+value.name:'';base=' [Function'+n+']';}
if(isRegExp(value)){base=' '+RegExp.prototype.toString.call(value);}
if(isDate(value)){base=' '+Date.prototype.toUTCString.call(value);}
if(isError(value)){base=' '+formatError(value);}
if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1];}
if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}else{return ctx.stylize('[Object]','special');}}
ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys);}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array);});}
ctx.seen.pop();return reduceToSingleString(output,base,braces);}
function formatPrimitive(ctx,value){if(isUndefined(value))
return ctx.stylize('undefined','undefined');if(isString(value)){var simple='\''+JSON.stringify(value).replace(/^"|"$/g,'').replace(/'/g,"\\'").replace(/\\"/g,'"')+'\'';return ctx.stylize(simple,'string');}
if(isNumber(value))
return ctx.stylize(''+value,'number');if(isBoolean(value))
return ctx.stylize(''+value,'boolean');if(isNull(value))
return ctx.stylize('null','null');}
function formatError(value){return'['+Error.prototype.toString.call(value)+']';}
function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true));}else{output.push('');}}
keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true));}});return output;}
function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize('[Getter/Setter]','special');}else{str=ctx.stylize('[Getter]','special');}}else{if(desc.set){str=ctx.stylize('[Setter]','special');}}
if(!hasOwnProperty(visibleKeys,key)){name='['+key+']';}
if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null);}else{str=formatValue(ctx,desc.value,recurseTimes-1);}
if(str.indexOf('\n')>-1){if(array){str=str.split('\n').map(function(line){return'  '+line;}).join('\n').substr(2);}else{str='\n'+str.split('\n').map(function(line){return'   '+line;}).join('\n');}}}else{str=ctx.stylize('[Circular]','special');}}
if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str;}
name=JSON.stringify(''+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,'name');}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,'string');}}
return name+': '+str;}
function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf('\n')>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,'').length+1;},0);if(length>60){return braces[0]+
(base===''?'':base+'\n ')+' '+
output.join(',\n  ')+' '+
braces[1];}
return braces[0]+base+' '+output.join(', ')+' '+braces[1];}
function isArray(ar){return Array.isArray(ar);}
exports.isArray=isArray;function isBoolean(arg){return typeof arg==='boolean';}
exports.isBoolean=isBoolean;function isNull(arg){return arg===null;}
exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null;}
exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==='number';}
exports.isNumber=isNumber;function isString(arg){return typeof arg==='string';}
exports.isString=isString;function isSymbol(arg){return typeof arg==='symbol';}
exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0;}
exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==='[object RegExp]';}
exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==='object'&&arg!==null;}
exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==='[object Date]';}
exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==='[object Error]'||e instanceof Error);}
exports.isError=isError;function isFunction(arg){return typeof arg==='function';}
exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==='boolean'||typeof arg==='number'||typeof arg==='string'||typeof arg==='symbol'||typeof arg==='undefined';}
exports.isPrimitive=isPrimitive;exports.isBuffer=function isBuffer(arg){return arg&&typeof arg==='object'&&typeof arg.copy==='function'&&typeof arg.fill==='function'&&typeof arg.readUInt8==='function';};function objectToString(o){return Object.prototype.toString.call(o);}
function pad(n){return n<10?'0'+n.toString(10):n.toString(10);}
var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];function timestamp(){var d=new Date();var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(':');return[d.getDate(),months[d.getMonth()],time].join(' ');}
exports.log=function(){console.log('%s - %s',timestamp(),exports.format.apply(exports,arguments));};exports.inherits=Require('os/inherits');exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]];}
return origin;};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}};BundleModuleCode['os/inherits']=function(module,exports){if(typeof Object.create==='function'){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor
ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}});};}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor
var TempCtor=function(){}
TempCtor.prototype=superCtor.prototype
ctor.prototype=new TempCtor()
ctor.prototype.constructor=ctor}}};BundleModuleCode['os/getenv']=function(module,exports){var util=require("util");var fallbacksDisabled=false;function _value(varName,fallback){var value=process.env[varName];if(value===undefined){if(fallback===undefined){throw new Error('GetEnv.Nonexistent: '+varName+' does not exist '+'and no fallback value provided.');}
if(fallbacksDisabled){throw new Error('GetEnv.DisabledFallbacks: '+varName+' relying on fallback '+'when fallbacks have been disabled');}
return''+fallback;}
return value;}
var convert={string:function(value){return''+value;},int:function(value){var isInt=value.match(/^-?\d+$/);if(!isInt){throw new Error('GetEnv.NoInteger: '+value+' is not an integer.');}
return+value;},float:function(value){var isInfinity=(+value===Infinity||+value===-Infinity);if(isInfinity){throw new Error('GetEnv.Infinity: '+value+' is set to +/-Infinity.');}
var isFloat=!(isNaN(value)||value==='');if(!isFloat){throw new Error('GetEnv.NoFloat: '+value+' is not a number.');}
return+value;},bool:function(value){var isBool=(value==='true'||value==='false');if(!isBool){throw new Error('GetEnv.NoBoolean: '+value+' is not a boolean.');}
return(value==='true');}};function converter(type){return function(varName,fallback){if(typeof varName=='string'){var value=_value(varName,fallback);return convert[type](value);}else{return getenv.multi(varName);}};};var getenv=converter('string');Object.keys(convert).forEach(function(type){getenv[type]=converter(type);});getenv.array=function array(varName,type,fallback){type=type||'string';if(Object.keys(convert).indexOf(type)===-1){throw new Error('GetEnv.ArrayUndefinedType: Unknown array type '+type);}
var value=_value(varName,fallback);return value.split(/\s*,\s*/).map(convert[type]);};getenv.multi=function multi(spec){var key,value;var result={};for(var key in spec){var value=spec[key];if(util.isArray(value)){switch(value.length){case 1:case 2:result[key]=getenv(value[0],value[1]);break;case 3:result[key]=getenv[value[2]](value[0],value[1]);break;default:throw('getenv.multi(): invalid spec');break;}}else{result[key]=getenv(value);}}
return result;};getenv.disableFallbacks=function(){fallbacksDisabled=true;};getenv.enableFallbacks=function(){fallbacksDisabled=false;};module.exports=getenv;};BundleModuleCode['os/base64']=function(module,exports){var keyStr="ABCDEFGHIJKLMNOP"+"QRSTUVWXYZabcdef"+"ghijklmnopqrstuv"+"wxyz0123456789+/"+"=";var Base64={encode:function(input){input=escape(input);var output="";var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;do{chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output=output+
keyStr.charAt(enc1)+
keyStr.charAt(enc2)+
keyStr.charAt(enc3)+
keyStr.charAt(enc4);chr1=chr2=chr3="";enc1=enc2=enc3=enc4="";}while(i<input.length);return output;},encodeBuf:function(input){var output="";var NaN=output.charCodeAt(2);var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;var len=input.length;do{chr1=input.readUInt8(i++);chr2=(i<len)?input.readUInt8(i++):NaN;chr3=(i<len)?input.readUInt8(i++):NaN;enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output=output+
keyStr.charAt(enc1)+
keyStr.charAt(enc2)+
keyStr.charAt(enc3)+
keyStr.charAt(enc4);chr1=chr2=chr3="";enc1=enc2=enc3=enc4="";}while(i<len);return output;},decode:function(input){var output="";var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{enc1=keyStr.indexOf(input.charAt(i++));enc2=keyStr.indexOf(input.charAt(i++));enc3=keyStr.indexOf(input.charAt(i++));enc4=keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2);}
if(enc4!=64){output=output+String.fromCharCode(chr3);}
chr1=chr2=chr3="";enc1=enc2=enc3=enc4="";}while(i<input.length);return unescape(output);},decodeBuf:function(input){var len=input.length;var buf=new Buffer(len);var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;var buflen=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");buf.fill(0);do{enc1=keyStr.indexOf(input.charAt(i++));enc2=keyStr.indexOf(input.charAt(i++));enc3=keyStr.indexOf(input.charAt(i++));enc4=keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;buf.writeUInt8(chr1,buflen);buflen++;if(enc3!=64){buf.writeUInt8(chr2,buflen);buflen++;}
if(enc4!=64){buf.writeUInt8(chr3,buflen);buflen++;}
chr1=chr2=chr3="";enc1=enc2=enc3=enc4="";}while(i<input.length);return buf.slice(0,buflen);}};module.exports=Base64;};BundleModuleCode['os/polyfill']=function(module,exports){Object.addProperty=function(obj,name,fun){if(obj.prototype[name])return;obj.prototype[name]=fun;Object.defineProperty(obj.prototype,name,{enumerable:false});};Object.updateProperty=function(obj,name,fun){obj.prototype[name]=fun;Object.defineProperty(obj.prototype,name,{enumerable:false});};if(typeof Object.assign!='function'){Object.defineProperty(Object,"assign",{value:function assign(target,varArgs){'use strict';if(target==null){throw new TypeError('Cannot convert undefined or null to object');}
var to=Object(target);for(var index=1;index<arguments.length;index++){var nextSource=arguments[index];if(nextSource!=null){for(var nextKey in nextSource){if(Object.prototype.hasOwnProperty.call(nextSource,nextKey)){to[nextKey]=nextSource[nextKey];}}}}
return to;},writable:true,configurable:true});}
if(!Array.prototype.find){Object.addProperty(Array,'find',function(predicate){if(this==null){throw new TypeError('"this" is null or not defined');}
var o=Object(this);var len=o.length>>>0;if(typeof predicate!=='function'){throw new TypeError('predicate must be a function');}
var thisArg=arguments[1];var k=0;while(k<len){var kValue=o[k];if(predicate.call(thisArg,kValue,k,o)){return kValue;}
k++;}
return undefined;});}
if(!String.prototype.contains){Object.addProperty(String,'contains',function(el){return this.indexOf(el)!=-1})}
checkOptions=function(options,defaultOptions){return Object.assign({},defaultOptions||{},options)};checkOption=function(option,defaultOption){return option==undefined?defaultOption:option};};BundleModuleCode['com/path']=function(module,exports){var Fs=Require('fs');var _process=process||{};(function(){"use strict";var isWindows=_process.platform==='win32';var util=Require('util');if(!util.deprecate)util.deprecate=function(f,w){return f;};function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==='.'){parts.splice(i,1);}else if(last==='..'){parts.splice(i,1);up++;}else if(up){parts.splice(i,1);up--;}}
if(allowAboveRoot){for(;up--;up){parts.unshift('..');}}
return parts;}
if(isWindows){var splitDeviceRe=/^([a-zA-Z]:|[\\\/]{2}[^\\\/]+[\\\/]+[^\\\/]+)?([\\\/])?([\s\S]*?)$/;var splitTailRe=/^([\s\S]*?)((?:\.{1,2}|[^\\\/]+?|)(\.[^.\/\\]*|))(?:[\\\/]*)$/;var splitPath=function(filename){var result=splitDeviceRe.exec(filename),device=(result[1]||'')+(result[2]||''),tail=result[3]||'';var result2=splitTailRe.exec(tail),dir=result2[1],basename=result2[2],ext=result2[3];return[device,dir,basename,ext];};var normalizeUNCRoot=function(device){return'\\\\'+device.replace(/^[\\\/]+/,'').replace(/[\\\/]+/g,'\\');};exports.resolve=function(){var resolvedDevice='',resolvedTail='',resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1;i--){var path;if(i>=0){path=arguments[i];}else if(!resolvedDevice){path=_process.cwd();}else{path=_process.env['='+resolvedDevice];if(!path||path.substr(0,3).toLowerCase()!==resolvedDevice.toLowerCase()+'\\'){path=resolvedDevice+'\\';}}
if(!util.isString(path)){throw new TypeError('Arguments to path.resolve must be strings');}else if(!path){continue;}
var result=splitDeviceRe.exec(path),device=result[1]||'',isUnc=device&&device.charAt(1)!==':',isAbsolute=exports.isAbsolute(path),tail=result[3];if(device&&resolvedDevice&&device.toLowerCase()!==resolvedDevice.toLowerCase()){continue;}
if(!resolvedDevice){resolvedDevice=device;}
if(!resolvedAbsolute){resolvedTail=tail+'\\'+resolvedTail;resolvedAbsolute=isAbsolute;}
if(resolvedDevice&&resolvedAbsolute){break;}}
if(isUnc){resolvedDevice=normalizeUNCRoot(resolvedDevice);}
function f(p){return!!p;}
resolvedTail=normalizeArray(resolvedTail.split(/[\\\/]+/).filter(f),!resolvedAbsolute).join('\\');return(resolvedDevice+(resolvedAbsolute?'\\':'')+resolvedTail)||'.';};exports.normalize=function(path){var result=splitDeviceRe.exec(path),device=result[1]||'',isUnc=device&&device.charAt(1)!==':',isAbsolute=exports.isAbsolute(path),tail=result[3],trailingSlash=/[\\\/]$/.test(tail);if(device&&device.charAt(1)===':'){device=device[0].toLowerCase()+device.substr(1);}
tail=normalizeArray(tail.split(/[\\\/]+/).filter(function(p){return!!p;}),!isAbsolute).join('\\');if(!tail&&!isAbsolute){tail='.';}
if(tail&&trailingSlash){tail+='\\';}
if(isUnc){device=normalizeUNCRoot(device);}
return device+(isAbsolute?'\\':'')+tail;};exports.isAbsolute=function(path){var result=splitDeviceRe.exec(path),device=result[1]||'',isUnc=!!device&&device.charAt(1)!==':';return!!result[2]||isUnc;};exports.join=function(){function f(p){if(!util.isString(p)){throw new TypeError('Arguments to path.join must be strings');}
return p;}
var paths=Array.prototype.filter.call(arguments,f);var joined=paths.join('\\');if(!/^[\\\/]{2}[^\\\/]/.test(paths[0])){joined=joined.replace(/^[\\\/]{2,}/,'\\');}
return exports.normalize(joined);};exports.relative=function(from,to){from=exports.resolve(from);to=exports.resolve(to);var lowerFrom=from.toLowerCase();var lowerTo=to.toLowerCase();function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=='')break;}
var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=='')break;}
if(start>end)return[];return arr.slice(start,end+1);}
var toParts=trim(to.split('\\'));var lowerFromParts=trim(lowerFrom.split('\\'));var lowerToParts=trim(lowerTo.split('\\'));var length=Math.min(lowerFromParts.length,lowerToParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(lowerFromParts[i]!==lowerToParts[i]){samePartsLength=i;break;}}
if(samePartsLength==0){return to;}
var outputParts=[];for(var i=samePartsLength;i<lowerFromParts.length;i++){outputParts.push('..');}
outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join('\\');};exports.sep='\\';exports.delimiter=';';}else{var splitPathRe=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;var splitPath=function(filename){return splitPathRe.exec(filename).slice(1);};exports.resolve=function(){var resolvedPath='',resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=(i>=0)?arguments[i]:_process.cwd();if(!util.isString(path)){throw new TypeError('Arguments to path.resolve must be strings');}else if(!path){continue;}
resolvedPath=path+'/'+resolvedPath;resolvedAbsolute=path.charAt(0)==='/';}
resolvedPath=normalizeArray(resolvedPath.split('/').filter(function(p){return!!p;}),!resolvedAbsolute).join('/');return((resolvedAbsolute?'/':'')+resolvedPath)||'.';};exports.normalize=function(path){var isAbsolute=exports.isAbsolute(path),trailingSlash=path[path.length-1]==='/',segments=path.split('/'),nonEmptySegments=[];for(var i=0;i<segments.length;i++){if(segments[i]){nonEmptySegments.push(segments[i]);}}
path=normalizeArray(nonEmptySegments,!isAbsolute).join('/');if(!path&&!isAbsolute){path='.';}
if(path&&trailingSlash){path+='/';}
return(isAbsolute?'/':'')+path;};exports.isAbsolute=function(path){return path.charAt(0)==='/';};exports.join=function(){var path='';for(var i=0;i<arguments.length;i++){var segment=arguments[i];if(!util.isString(segment)){throw new TypeError('Arguments to path.join must be strings');}
if(segment){if(!path){path+=segment;}else{path+='/'+segment;}}}
return exports.normalize(path);};exports.relative=function(from,to){from=exports.resolve(from).substr(1);to=exports.resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=='')break;}
var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=='')break;}
if(start>end)return[];return arr.slice(start,end+1);}
var fromParts=trim(from.split('/'));var toParts=trim(to.split('/'));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break;}}
var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push('..');}
outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join('/');};exports.sep='/';exports.delimiter=':';}
exports.dirname=function(path){var result=splitPath(path),root=result[0],dir=result[1];if(!root&&!dir){return'.';}
if(dir){dir=dir.substr(0,dir.length-1);}
return root+dir;};exports.basename=function(path,ext){var f=splitPath(path)[2];if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length);}
return f;};exports.extname=function(path){return splitPath(path)[3];};exports.exists=util.deprecate(function(path,callback){if(Fs)Fs.exists(path,callback);else callback(false);},'path.exists is now called `fs.exists`.');exports.existsSync=util.deprecate(function(path){if(Fs)return Fs.existsSync(path);else return false;},'path.existsSync is now called `fs.existsSync`.');if(isWindows){exports._makeLong=function(path){if(!util.isString(path))
return path;if(!path){return'';}
var resolvedPath=exports.resolve(path);if(/^[a-zA-Z]\:\\/.test(resolvedPath)){return'\\\\?\\'+resolvedPath;}else if(/^\\\\[^?.]/.test(resolvedPath)){return'\\\\?\\UNC\\'+resolvedPath.substring(2);}
return path;};}else{exports._makeLong=function(path){return path;};}}());};BundleModuleCode['com/sprintf']=function(module,exports){(function(window){var re={not_string:/[^s]/,number:/[diefg]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijosuxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/}
function sprintf(){var key=arguments[0],cache=sprintf.cache
if(!(cache[key]&&cache.hasOwnProperty(key))){cache[key]=sprintf.parse(key)}
return sprintf.format.call(null,cache[key],arguments)}
sprintf.format=function(parse_tree,argv){var cursor=1,tree_length=parse_tree.length,node_type="",arg,output=[],i,k,match,pad,pad_character,pad_length,is_positive=true,sign=""
for(i=0;i<tree_length;i++){node_type=get_type(parse_tree[i])
if(node_type==="string"){output[output.length]=parse_tree[i]}
else if(node_type==="array"){match=parse_tree[i]
if(match[2]){arg=argv[cursor]
for(k=0;k<match[2].length;k++){if(!arg.hasOwnProperty(match[2][k])){throw new Error(sprintf("[sprintf] property '%s' does not exist",match[2][k]))}
arg=arg[match[2][k]]}}
else if(match[1]){arg=argv[match[1]]}
else{arg=argv[cursor++]}
if(get_type(arg)=="function"){arg=arg()}
if(re.not_string.test(match[8])&&re.not_json.test(match[8])&&(get_type(arg)!="number"&&isNaN(arg))){throw new TypeError(sprintf("[sprintf] expecting number but found %s",get_type(arg)))}
if(re.number.test(match[8])){is_positive=arg>=0}
switch(match[8]){case"b":arg=arg.toString(2)
break
case"c":arg=String.fromCharCode(arg)
break
case"d":case"i":arg=parseInt(arg,10)
break
case"j":arg=JSON.stringify(arg,null,match[6]?parseInt(match[6]):0)
break
case"e":arg=match[7]?arg.toExponential(match[7]):arg.toExponential()
break
case"f":arg=match[7]?parseFloat(arg).toFixed(match[7]):parseFloat(arg)
break
case"g":arg=match[7]?parseFloat(arg).toPrecision(match[7]):parseFloat(arg)
break
case"o":arg=arg.toString(8)
break
case"s":arg=((arg=String(arg))&&match[7]?arg.substring(0,match[7]):arg)
break
case"u":arg=arg>>>0
break
case"x":arg=arg.toString(16)
break
case"X":arg=arg.toString(16).toUpperCase()
break}
if(re.json.test(match[8])){output[output.length]=arg}
else{if(re.number.test(match[8])&&(!is_positive||match[3])){sign=is_positive?"+":"-"
arg=arg.toString().replace(re.sign,"")}
else{sign=""}
pad_character=match[4]?match[4]==="0"?"0":match[4].charAt(1):" "
pad_length=match[6]-(sign+arg).length
pad=match[6]?(pad_length>0?str_repeat(pad_character,pad_length):""):""
output[output.length]=match[5]?sign+arg+pad:(pad_character==="0"?sign+pad+arg:pad+sign+arg)}}}
return output.join("")}
sprintf.cache={}
sprintf.parse=function(fmt){var _fmt=fmt,match=[],parse_tree=[],arg_names=0
while(_fmt){if((match=re.text.exec(_fmt))!==null){parse_tree[parse_tree.length]=match[0]}
else if((match=re.modulo.exec(_fmt))!==null){parse_tree[parse_tree.length]="%"}
else if((match=re.placeholder.exec(_fmt))!==null){if(match[2]){arg_names|=1
var field_list=[],replacement_field=match[2],field_match=[]
if((field_match=re.key.exec(replacement_field))!==null){field_list[field_list.length]=field_match[1]
while((replacement_field=replacement_field.substring(field_match[0].length))!==""){if((field_match=re.key_access.exec(replacement_field))!==null){field_list[field_list.length]=field_match[1]}
else if((field_match=re.index_access.exec(replacement_field))!==null){field_list[field_list.length]=field_match[1]}
else{throw new SyntaxError("[sprintf] failed to parse named argument key")}}}
else{throw new SyntaxError("[sprintf] failed to parse named argument key")}
match[2]=field_list}
else{arg_names|=2}
if(arg_names===3){throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported")}
parse_tree[parse_tree.length]=match}
else{throw new SyntaxError("[sprintf] unexpected placeholder")}
try{_fmt=_fmt.substring(match[0].length)}catch(e){throw new SyntaxError("[sprintf] unexpected fromat")}}
return parse_tree}
var vsprintf=function(fmt,argv,_argv){_argv=(argv||[]).slice(0)
_argv.splice(0,0,fmt)
return sprintf.apply(null,_argv)}
function get_type(variable){return Object.prototype.toString.call(variable).slice(8,-1).toLowerCase()}
function str_repeat(input,multiplier){return Array(multiplier+1).join(input)}
if(typeof exports!=="undefined"){exports.sprintf=sprintf
exports.vsprintf=vsprintf}
else{window.sprintf=sprintf
window.vsprintf=vsprintf
if(typeof define==="function"&&define.amd){define(function(){return{sprintf:sprintf,vsprintf:vsprintf}})}}})(typeof window==="undefined"?this:window);};BundleModuleCode['/home/sbosse/proj/jam/js/top/jamapp.js']=function(module,exports){global.config={simulation:false};var options={version:'1.6.15'}
var Io=Require('com/io');var Comp=Require('com/compat');var JamLib=Require('top/jamlib');var Name=Require('com/pwgen');var Aios=JamLib.Aios;var Net=Require('dos/network');var Buf=Require('dos/buf');var Obj=Comp.obj;var Args=Comp.args;var Status=Net.Status;var Command=Net.Command;var Getenv=Require('com/getenv');var satelize=Require('dos/ext/satelize');var UI=Require('ui/app/app');var util=Require('util');var Proc=Require('child_process');var nameopts={length:8,memorable:true,lowercase:true},Nameopts={length:8,memorable:true,uppercase:true};var MB=function(bytes){return int(bytes/1024/1024)}
var styles={simple:{button:{border:{type:'none'},black:'blue',},info:{bg:'black',fg:'yellow',border:{type:'none'},label:{fg:'green',bold:true},},input:{bg:'lightgrey',text:{fg:'black'},border:{type:'none'},label:{fg:'green',bold:true},},label:{bold:true,fg:'green',},list:{bg:'black',border:{type:'none'},label:{fg:'green',bold:true},},log:{bg:'black',border:{type:'none'},label:{fg:'green',bold:true},},tree:{bg:'black',border:{type:'none'},label:{fg:'green',bold:true},},keyboard:{bg:'yellow',border:{type:'ch',ch:' ',bg:'yellow'},label:{bg:'yellow',fg:'black'}},filemanager:{bg:'yellow',fg:'black',arrows:{fg:'red',bg:'white',},border:{type:'ch',ch:' ',bg:'yellow'},box:{bg:'white'},label:{fg:'white',bg:'yellow'},input:{bg:'white',fg:'black',},},},black:{button:{border:{type:'line',fg:'white'},black:'blue',},info:{fg:'yellow',border:{type:'line',fg:'green'},label:{fg:'green',bold:true},},input:{fg:'yellow',border:{type:'line',fg:'green'},label:{fg:'green',bold:true},},label:{bold:true,fg:'green',},list:{border:{type:'line',fg:'green'},label:{fg:'green',bold:true},},tree:{border:{type:'line',fg:'green'},label:{fg:'green',bold:true},},keyboard:{border:{type:'line'}},filemanager:{border:{type:'line',fg:'green'},arrows:{fg:'red',bg:'default',},box:{bg:'default',fg:'white',border:{bg:'default',type:'line',fg:'green'}},input:{border:{type:'line'}},label:{fg:'white',}},},default:{button:{black:'black'},filemanager:{border:{type:'line'},arrows:{fg:'red',bg:'default',},box:{bg:'default',border:{bg:'default',type:'line'}},input:{border:{type:'line'}},label:{fg:'blue',}},keyboard:{border:{type:'line'}},label:{fg:'black',bold:true},}}
var appTerm=function(_options){var self=this,id=Name.generate(nameopts),log,log2,changed=false,p;this.config={agents:{level:1},autoconnect:false,domain:'default',expert:false,keyboard:false,public:{'IP(1)':{address:'ag-0.de',port:10001,local:'*',enable:true}},nodename:id,links:['IP(1)','IP(2)','IP(3)','IP(4)','NORTH','SOUTH','WEST','EAST'],log:{node:false,agent:false,class:false,time:false},logJam:{world:false,node:false,pid:false,time:false},mode:'gui',proto:'udp',script:'//Type Here\n',security:false,sensors:false,simple:false,verbose:0,worldname:id.toUpperCase()};this.options={configFile:JamLib.environment.config||'jam.app.config',env:{},geo:undefined,hostname:Io.hostname(),myip:'localhost',monitor:0,onexit:false,start:false,print:console.log,verbose:0,};for(p in _options)this.options[p]=_options[p];this.err=function(msg,err){console.log('[APP] Error: '+msg);throw(err||'[JAM] Error')}
this.warn=function(msg){console.log('[APP] Warning: '+msg);}
this.out=this.log=function(msg){console.log('[APP] '+msg);}
if(!this.options.terminal)this.options.terminal=(process.platform==='win32'?'windows-ansi':'xterm-color');if(process.platform==='android')this.config.keyboard=true;this.readConfig();if(JamLib.environment.mode=='server')this.config.mode='server';if(this.config.mode=='server'&&JamLib.environment.connect=='true')this.config.autoconnect=true;if(!this.config.nodename)this.out('Setting node name to '+id),this.config.nodename=id,changed=true;if(!this.config.worldname)this.config.worldname=id.toUpperCase(),changed=true;this.extensions={config:{levels:[3],fun:function(){return self.config},args:0},connect:{levels:[3],fun:function(to){self.jam.world.connectTo(to);},args:1}}
this.provider=function(pat){if(process.sensor)switch(pat.length){case 2:switch(pat[0]){case'SENSORS':return[pat[0],process.sensor.info()];}
break;case 3:switch(pat[0]){case'SENSOR':process.sensor.start(pat[1]);return[pat[0],pat[1],process.sensor.read(pat[1])];}
break;}}
this.events=[];this.todo=[];this.exit=[];this.status={initialized:false,run:false,connected:false,connecting:false,error:false};this.links={};this.config.links.forEach(function(dir){self.links[dir]=self.config.public[dir]||{};});this.classes={};if(this.config.mode!='server')log=function(msg){self.logWin.log(msg)};else log=console.log;Aios.config({print:log});this.err=function(msg,err){log('[APP] Error: '+msg);throw(err||'[JAM] Error')}
this.warn=function(msg){log('[APP] Warning: '+msg);}
this.out=this.log=function(msg){log('[APP] '+msg);}
if(this.config.mode!='server')log2=function(msg){self.msgWin.log(msg)};else log2=console.log;Aios.config({printAgent:log2});this.log2=log2;this.jam=undefined;if(this.config.mode!='server'){if(this.config.simple||process.argv.indexOf('style:simple')!=-1)
this.styles=styles.simple;else if(process.platform=='android'||process.platform=='win32'||process.argv.indexOf('style:invert')!=-1||process.argv.indexOf('style:black')!=-1)
this.styles=styles.black;else this.styles=styles.default;}else{this.dialog=console.log;}
if(changed)this.saveConfig();};appTerm.prototype.connect=function(){var self=this,p,to;if(!this.jam||!this.jam.world||this.status.connecting)return;this.status.connecting=true;setTimeout(function(){self.status.connecting=false;self.update('status')},5000);for(p in this.links){if(!this.links[p].enable)continue;if(p.indexOf('IP')==0&&this.links[p].address&&this.links[p].port){to=Aios.Chan.addr2url(this.links[p]);this.jam.world.connectTo(Aios.DIR.IP(to));}}}
appTerm.prototype.createAgent=function(cls,args,level,confirm){var msg;try{if(!args)throw'Invalid arguments';if(level==undefined)level=1;msg=cls+'('+util.inspect(args)+') Level '+level;id=this.jam.createAgent(cls,args,level);if(id==null)throw('Agent creation failed: '+this.jam.error);msg+=(' : '+id);this.log('Created agent '+msg);if(confirm)this.dialog('Created agent '+msg);}catch(e){this.dialog(msg+' Error: '+e);}}
appTerm.prototype.emit=function(event,args){var e;for(e in this.events){var ev=this.events[e];if(ev[0]==event)ev[1](args);}}
appTerm.prototype.init=function(){if(this.config.mode!='server')this.setupGui();}
appTerm.prototype.initJAM=function(){var self=this,options={},connected={},p,status;this.out('Creating JAM ..');options.log=this.config.log;options.logJam=this.config.logJam;options.verbose=this.options.verbose||1;options.id=this.config.nodename;options.world=this.config.worldname;options.provider=this.provider;options.connections={};for(p in this.links){if(!this.links[p].enable)continue;if(p.indexOf('IP')==0&&!options.connections.ip)options.connections.ip={from:this.links[p].local?this.links[p].local:'*',on:{'link+':function(url){connected[url]=true;self.status.connecting=false;self.status.connected=true;self.update('status')},'link-':function(url){var p,c=0;connected[url]=false;for(p in connected)if(connected[p])c++;if(c==0){self.status.connecting=false;self.status.connected=false;self.update('status')}}},proto:'udp',multicast:true}}
this.jam=JamLib.Jam(options);this.jam.init();for(var p in this.extensions){this.jam.extend(this.extensions[p].levels,p,this.extensions[p].fun,this.extensions[p].args);}
this.status.initialized=true;for(p in this.classes){status=this.jam.readClass(this.classes[p],{verbose:1});if(!status){this.status.error='Load failed';delete this.classes[p]};this.update('status');}}
appTerm.prototype.io=function(){}
appTerm.prototype.loadClassFile=function(file){var status,self=this,mod=Comp.filename.removeext(Comp.filename.basename(file));if(mod=='')mod=Comp.filename.basename(file);this.classes[mod]=file;if(this.status.initialized){try{status=this.jam.readClass(file,{verbose:1,error:function(e){throw e}});}catch(e){self.log(e);status=false};if(!status)this.status.error='Load failed',delete this.classes[mod];else this.status.error=false;this.update('status');if(!status)this.dialog(this.jam.error);}
if(this.config.mode!='server'&&this.UI.pages[this.CS.pages.classes]&&this.UI.pages[this.CS.pages.classes].tree1)
this.UI.pages[this.CS.pages.classes].tree1.set(this.classes);}
appTerm.prototype.on=function(event,callback){this.events.push([event,callback]);}
appTerm.prototype.print=function(msg,header,depth,logger){var self=this;var lines=[],line='';if(depth==_)depth=1;function isvec(obj){return(Comp.obj.isArray(obj)&&(obj.length==0||!Comp.obj.isArray(obj[0])))}
function ismat(obj){return(Comp.obj.isArray(obj)&&obj.length>0&&Comp.obj.isArray(obj[0]))}
function mat(o,depth){var lines=[];var line='';if(header){line=header;header=_};for(var j in o){var row=o[j];line+=Comp.printf.list(row,function(v){return(Comp.obj.isArray(v)?(depth>0?'['+vec(v,depth-1)+']':'[..]'):Comp.obj.isObj(v)?(depth>0?obj(v,depth-1):'{..}'):v);});lines.push(line);line='';}
return lines;}
function vec(v,depth){var lines=[];var line='';if(header){line=header;header=_};if(v.length==0)return(line+'[]');else{var sep='',sepi='';for(var p in v){if(ismat(v[p])){if(depth>0){lines=mat(v[p],depth-1);line+=sep+'[';sepi='';Comp.array.iter(lines,function(line2){line+=sepi+'['+line2+']';sepi=',';});line+=']';sep=',';}else{line+=sep+'[[..]]';sep=',';}}
else if(isvec(v[p])){line+=sep+vec(v[p],depth-1);sep=',';}
else{line+=sep+(Comp.obj.isArray(v[p])?(depth>0?vec(v[p],depth-1):'[..]'):Comp.obj.isObj(v[p])?(depth>0?obj(v[p],depth-1):'{..}'):v[p]);sep=',';}}
if(line!='')return line;}}
function obj(o,depth){var line='';var sep='';if(header){line=header;header=_};line+='{';for(var p in o){if(!Comp.obj.isFunction(o[p])){line+=sep+p+':'+
(Comp.obj.isArray(o[p])?(depth>0?vec(o[p],depth-1):'[..]'):Comp.obj.isObj(o[p])?(depth>0?obj(o[p],depth-1):'{..}'):o[p]);sep=',';}else{line+=sep+p+':'+'function()';sep=',';}}
return line+'}';}
function str(s){var line='';var lines=[];var lines2=Comp.string.split('\n',msg);if(header){line=header;header=_};if(lines2.length==1)
lines.push(line+msg);else{Comp.array.iter(lines2,function(line2,i){if(i==0)lines.push(line+line2);else lines.push(line2);});}
return lines;}
if(ismat(msg))lines=Comp.array.concat(lines,Comp.array.map(mat(msg,depth-1),function(line){return'    '+line}));else if(Comp.obj.isString(msg))lines=Comp.array.concat(lines,str(msg));else if(isvec(msg))lines.push(vec(msg,depth-1));else if(Comp.obj.isObj(msg))lines.push(obj(msg,depth-1));else{if(header){line=header;header=_};line+=msg;lines.push(line);}
if(logger==undefined)return lines;else
Comp.array.iter(lines,function(line){logger(line)});}
appTerm.prototype.quit=function(stat){this.saveConfig();return process.exit(stat);}
appTerm.prototype.readConfig=function(file){var text,config;if(!file)file=this.options.configFile;this.out('Reading config file '+file);text=Io.read_file(file);if(text){try{config=JSON.parse(text);for(var p in config)this.config[p]=config[p]}
catch(e){this.err('Parsing config file failed: '+e)};}}
appTerm.prototype.saveConfig=function(file){var text=JSON.stringify(this.config,null,2);if(!file)file=this.options.configFile;this.out('Saving config file '+file);Io.write_file(file,text);}
appTerm.prototype.setupGui=function(){var self=this,page,p,i,x,y,first;this.UI=UI.UI({pages:20,styles:this.styles,terminal:this.options.terminal,title:'JAMAPP (C) Stefan Bosse'});this.UI.init();this.UI.options.keyboard=this.config.keyboard;this.CF={fm:{height:this.UI.layout.small?this.UI.screen.height-4:Math.min(25,this.UI.screen.height-4),top:2,width:this.UI.layout.small?this.UI.screen.width:'60%',},info:{top:this.UI.layout.small?this.UI.screen.height-4:this.UI.screen.height-3,height:this.UI.layout.small?4:3},menu:{buttons:{top:4}},setup:{checkboxes:{x0:this.UI.layout.small?4:4,x1:this.UI.layout.small?20:int(this.UI.screen.width/2),y0:this.UI.layout.small?16:12,y1:this.UI.layout.small?24:20,left2:this.UI.layout.small?4:30,left3:this.UI.layout.small?4:4,top3:this.UI.layout.small?5:4,left4:this.UI.layout.small?4:50,top4:this.UI.layout.small?15:12,},labels:{input:{top:this.UI.layout.small?9:5,center:this.UI.layout.small?undefined:true,left:this.UI.layout.small?'65%':undefined,},top1:{content:this.UI.layout.small?'Setup':'Setup [Links]',},top2:{content:this.UI.layout.small?'Setup':'Setup [JAM]',},top23:{content:this.UI.layout.small?'Setup':undefined,},top3:{content:this.UI.layout.small?'Script':'Setup [Script]',},top4:this.UI.layout.small?13:10},inputs:{remoteip:{top:4,left:4,right:undefined,width:this.UI.layout.small?'80%':int(this.UI.screen.width/2)-10},remoteipp:{top:this.UI.layout.small?8:4,left:this.UI.layout.small?4:undefined,right:this.UI.layout.small?undefined:4,width:this.UI.layout.small?'50%':int(this.UI.screen.width/2)-10},localip:{top:this.UI.layout.small?12:8,left:this.UI.layout.small?4:undefined,right:this.UI.layout.small?undefined:4,width:this.UI.layout.small?'50%':int(this.UI.screen.width/2)-10},protect:{top:this.UI.layout.small?16:8,left:4,right:undefined,width:this.UI.layout.small?'50%':int(this.UI.screen.width/2)-10},script:{top:4,left:2,height:this.UI.screen.height-8,width:this.UI.screen.width-4}},},control:{center:this.UI.layout.small?undefined:true,left:this.UI.layout.small?1:undefined,left2:this.UI.layout.small?1:'10%',right2:this.UI.layout.small?1:'10%',width:this.UI.layout.small?this.UI.screen.width-2:'80%',width2:this.UI.layout.small?12:'30%',info1:{height:this.UI.layout.small?4:3,}},classes:{center:this.UI.layout.small?undefined:true,left:this.UI.layout.small?1:undefined,left2:this.UI.layout.small?1:'10%',right2:this.UI.layout.small?1:'10%',width:this.UI.layout.small?this.UI.screen.width-2:'80%',width2:this.UI.layout.small?this.UI.screen.width/2-2:'40%',labels:{center:this.UI.layout.small?undefined:true,right:this.UI.layout.small?4:undefined,top:this.UI.layout.small?'Classes':'Agent Classes',}},stats:{left:this.UI.layout.small?1:4,width:this.UI.layout.small?this.UI.screen.width-4:self.UI.screen.width-8,labels:{center:true,right:undefined,top:this.UI.layout.small?'Info':'System Info',}},explorer:{left:this.UI.layout.small?1:4,right:this.UI.layout.small?1:4,width:this.UI.layout.small?this.UI.screen.width-4:self.UI.screen.width-8,labels:{center:this.UI.layout.small?undefined:true,right:this.UI.layout.small?4:undefined,top:'Explorer',}},log1:{left:this.UI.layout.small?1:4,width:this.UI.layout.small?this.UI.screen.width-4:undefined},log2:{left:this.UI.layout.small?1:4,width:this.UI.layout.small?this.UI.screen.width-4:undefined}}
this.CS={agents:{buttons:{clear:this.UI.button({left:this.CF.log1.left,top:4,content:'Clear',bg:'green'}),},log1:this.UI.log({left:this.CF.log1.left,width:this.CF.log1.width,top:8,height:this.UI.screen.height-12,label:'Agent Messages',arrows:{up:'[-]',down:'[+]',width:3,height:1,fg:'red',bg:'default'}})},dialog:function(msg,callback){var lines=int(msg.length/(self.UI.screen.width/2-4))+2;var dia=self.UI.dialog({width:self.UI.layout.small?'80%':'50%',height:lines+4,center:true,okButton:'Okay'});dia.ask(msg,function(){dia.destroy();if(callback)callback()})},info:this.UI.info({top:this.CF.info.top,width:this.UI.screen.width-2,height:this.CF.info.height,wrap:true,label:'Information'}),menu:{buttons:{top:4,quit:this.UI.button({left:1,content:'QUIT'}),setup:this.UI.button({right:1,content:'SETUP'}),control:this.UI.button({top:this.CF.menu.buttons.top,center:true,bg:'blue',width:'80%',content:'Control'}),jam:this.UI.button({top:this.CF.menu.buttons.top+4,center:true,bg:'blue',width:'80%',content:'JAM'}),agents:this.UI.button({top:this.CF.menu.buttons.top+8,center:true,bg:'blue',width:'80%',content:'Agents'}),logging:this.UI.button({top:this.CF.menu.buttons.top+12,center:true,bg:'blue',width:'80%',content:'Logging'}),},labels:{top:this.UI.label({center:true,top:1,content:'JAMapp'+(this.UI.layout.small?'':(' '+options.version+' (Dr. Stefan Bosse)'))}),}},setup:{buttons:{less1:this.UI.button({left:1,content:'<< Less'}),less2:this.UI.layout.small?this.UI.button({left:1,content:'<< Less'}):undefined,less3:this.UI.button({left:1,content:'<< Less'}),menu:this.UI.button({left:1,content:'<< Menu'}),more1:this.UI.button({right:1,content:'More'}),more2:this.UI.layout.small?this.UI.button({right:1,content:'More'}):undefined,more3:this.UI.button({right:1,content:'Script'}),},checkboxes:{agentid:this.UI.checkbox({left:4,top:12,text:'Agent ID',value:this.config.log.agent}),parentid:this.UI.checkbox({left:4,top:14,text:'Parent ID',value:this.config.log.parent}),agenttime:this.UI.checkbox({left:4,top:16,text:'Time',value:this.config.log.time}),agentclass:this.UI.checkbox({left:4,top:18,text:'Class',value:this.config.log.class}),msgpid:this.UI.checkbox({left:this.CF.setup.checkboxes.left2,top:this.CF.setup.checkboxes.top4,text:'PID',value:this.config.logJam.pid}),msgnode:this.UI.checkbox({left:this.CF.setup.checkboxes.left2,top:this.CF.setup.checkboxes.top4+2,text:'Node',value:this.config.logJam.node}),msgworld:this.UI.checkbox({left:this.CF.setup.checkboxes.left2,top:this.CF.setup.checkboxes.top4+4,text:'World',value:this.config.logJam.world}),msgtime:this.UI.checkbox({left:this.CF.setup.checkboxes.left2,top:this.CF.setup.checkboxes.top4+6,text:'Time ',value:this.config.logJam.time}),verbose:this.UI.checkbox({left:this.CF.setup.checkboxes.left3,top:this.CF.setup.checkboxes.top3,text:'Verbose',value:false}),softkey:this.UI.checkbox({left:this.CF.setup.checkboxes.left3,top:this.CF.setup.checkboxes.top3+2,text:'Soft Keyboard',value:this.config.keyboard}),expert:!this.UI.layout.small?this.UI.checkbox({left:this.CF.setup.checkboxes.left3,top:this.CF.setup.checkboxes.top3+4,text:'Expert Mode',value:this.config.expert}):undefined,security:!this.UI.layout.small?this.UI.checkbox({left:this.CF.setup.checkboxes.left2,top:this.CF.setup.checkboxes.top3+4,text:'Security',value:this.config.security}):this.UI.checkbox({left:this.CF.setup.checkboxes.left3,top:this.CF.setup.checkboxes.top3+6,text:'Security',value:this.config.security}),sensors:!this.UI.layout.small?this.UI.checkbox({left:this.CF.setup.checkboxes.left2,top:this.CF.setup.checkboxes.top3+2,text:'Sensors',value:this.config.sensors}):undefined,simple:!this.UI.layout.small?this.UI.checkbox({left:this.CF.setup.checkboxes.left2,top:this.CF.setup.checkboxes.top3,text:'Simple UI',value:this.config.simple}):this.UI.checkbox({left:this.CF.setup.checkboxes.left3,top:this.CF.setup.checkboxes.top3+4,text:'Simple UI',value:this.config.simple}),http:this.UI.layout.small?this.UI.radiobutton({left:4,top:6,text:'HTTP',value:false,group:2}):this.UI.radiobutton({left:this.CF.setup.checkboxes.left4,top:12,text:'HTTP',value:false,noshow:config.expert,group:2}),udp:this.UI.layout.small?this.UI.radiobutton({left:4,top:8,text:'UDP',value:true,group:2}):this.UI.radiobutton({left:this.CF.setup.checkboxes.left4,top:14,text:'UDP',value:true,noshow:config.expert,group:2}),autoconnect:this.UI.layout.small?this.UI.checkbox({left:4,top:10,text:'Autoconnect',value:this.config.autoconnect}):this.UI.checkbox({left:this.CF.setup.checkboxes.left4,top:16,text:'Autoconnect',value:this.config.autoconnect}),},inputs:{remoteip:this.UI.input({top:this.CF.setup.inputs.remoteip.top,left:this.CF.setup.inputs.remoteip.left,width:this.CF.setup.inputs.remoteip.width,label:'Remote IP Address',value:this.links[this.config.links[0]].address||''}),remoteipp:this.UI.input({top:this.CF.setup.inputs.remoteipp.top,left:this.CF.setup.inputs.remoteipp.left,right:this.CF.setup.inputs.remoteipp.right,width:this.CF.setup.inputs.remoteipp.width,label:'Remote IP Port',value:String(this.links[this.config.links[0]].port||'')}),localip:this.UI.input({top:this.CF.setup.inputs.localip.top,left:this.CF.setup.inputs.localip.left,right:this.CF.setup.inputs.localip.right,width:this.CF.setup.inputs.localip.width,label:'Local IP Port',value:this.links[this.config.links[0]].local?String(this.links[this.config.links[0]].local):'*'}),protect:this.UI.input({top:this.CF.setup.inputs.protect.top,left:this.CF.setup.inputs.protect.left,right:this.CF.setup.inputs.protect.right,width:this.CF.setup.inputs.protect.width,label:'Security Key',value:'(00)[0:0:0:0:0:0]'}),script:this.UI.input({top:this.CF.setup.inputs.script.top,center:this.CF.setup.inputs.script.center,left:this.CF.setup.inputs.script.left,width:this.CF.setup.inputs.script.width,height:this.CF.setup.inputs.script.height,label:'Start Script',multiline:true,scrollable:true,value:this.config.script,}),},labels:{agentflags:this.UI.label({left:4,top:10,content:'Agent Message Flags'}),input:this.UI.label({center:this.CF.setup.labels.input.center,left:this.CF.setup.labels.input.left,right:this.CF.setup.labels.input.right,top:this.CF.setup.labels.input.top,content:'IP(1)',mutable:true}),messageflags:this.UI.label({left:this.CF.setup.checkboxes.left2,top:this.CF.setup.labels.top4,content:'JAM Message Flags'}),protocol:this.UI.layout.small?this.UI.label({left:4,top:4,content:'Link Protocol (IP)'}):this.UI.label({left:this.CF.setup.checkboxes.left4,top:10,content:'Link Protocol (IP)',noshow:options.expert}),top1:this.UI.label({center:true,top:1,content:this.CF.setup.labels.top1.content}),top2:this.UI.layout.large?undefined:this.UI.label({center:true,top:1,content:this.CF.setup.labels.top2.content}),top23:this.UI.layout.small?this.UI.label({center:true,top:1,content:this.CF.setup.labels.top23.content}):undefined,top3:this.UI.layout.small?this.UI.label({right:1,top:1,content:this.CF.setup.labels.top3.content}):this.UI.label({center:true,top:1,content:this.CF.setup.labels.top3.content}),},},control:{buttons:{start:this.UI.button({top:4,center:this.CF.control.center,left:this.CF.control.left,bg:'green',width:this.CF.control.width,content:'Start'}),stop:this.UI.button({top:8,center:this.CF.control.center,left:this.CF.control.left,bg:'lightgrey',width:this.CF.control.width,content:'Stop'}),connect:this.UI.button({top:12,left:this.CF.control.left2,bg:'blue',width:this.CF.control.width2,content:'Connect'}),reset:this.UI.button({top:12,right:this.CF.control.right2,bg:'blue',width:this.CF.control.width2,content:'Reset'}),},info1:this.UI.info({left:this.CF.control.left,center:this.CF.control.center,top:16,width:this.CF.control.width,height:this.CF.control.info1.height,wrap:true,label:'Status'}),labels:{top:this.UI.label({center:true,top:1,content:'Control'}),}},classes:{buttons:{load:this.UI.button({top:4,left:this.CF.classes.left2,bg:'green',width:this.CF.classes.width2,content:'Load'}),execute:this.UI.button({top:4,right:this.CF.classes.right2,bg:'blue',width:this.CF.classes.width2,content:'Execute'}),create:this.UI.button({top:8,center:this.CF.classes.center,left:this.CF.classes.left,bg:this.styles.button.black,width:this.CF.classes.width,content:'Create'}),},checkboxes:{level0:this.UI.radiobutton({left:'55%',top:17,text:'0',value:false,group:20}),level1:this.UI.radiobutton({left:'55%',top:19,text:'1',value:true,group:20}),level2:this.UI.radiobutton({left:'75%',top:17,text:'2',value:false,group:20}),level3:this.UI.radiobutton({left:'75%',top:19,text:'3',value:false,group:20})},labels:{top:this.UI.label({center:this.CF.classes.labels.center,right:this.CF.classes.labels.right,top:1,content:this.CF.classes.labels.top}),level:this.UI.label({left:'55%',top:15,content:'Level'}),},inputs:{arguments:this.UI.input({top:12,right:this.CF.classes.right2,width:this.CF.classes.width2,label:'Arguments',value:'{}'}),},lists:{classes:this.UI.list({top:12,left:this.CF.classes.left2,height:this.UI.screen.height-16,width:this.CF.classes.width2,label:'Classes',depth:1}),}},stats:{buttons:{back:this.UI.button({left:1,content:'<< Menu'}),explorer:this.UI.button({right:1,content:'Explorer'}),},infos:{mem:this.UI.info({top:4,left:this.CF.stats.left,width:this.CF.stats.width,label:'Memory'}),com:this.UI.info({top:8,left:this.CF.stats.left,width:this.CF.stats.width,label:'Communication'}),},labels:{top:this.UI.label({center:this.CF.stats.labels.center,right:this.CF.stats.labels.right,top:1,content:this.CF.stats.labels.top}),},tree1:this.UI.tree({top:12,left:this.CF.stats.left,width:this.CF.stats.width,height:self.UI.screen.height-16,label:'System',arrows:{up:'[-]',down:'[+]',width:3,height:1,fg:'red',bg:'default'}})},explorer:{buttons:{back:this.UI.button({left:1,content:'<< Info'}),killall:this.UI.button({left:this.CF.explorer.left,top:4,content:'KILL All'}),kill:this.UI.button({right:this.CF.explorer.right,top:4,content:'KILL'}),},labels:{top:this.UI.label({center:this.CF.explorer.labels.center,right:this.CF.explorer.labels.right,top:1,content:this.CF.explorer.labels.top}),},tree1:this.UI.tree({top:8,left:this.CF.explorer.left,width:this.CF.explorer.width,height:self.UI.screen.height-12,label:'Agents',arrows:{up:'[-]',down:'[+]',width:3,height:1,fg:'red',bg:'default'}})},log1:this.UI.log({left:this.CF.log1.left,top:4,width:this.CF.log1.width,label:'Logging',arrows:{up:'[-]',down:'[+]',width:3,height:1,fg:'red',bg:'default'}}),pages:{}}
this.dialog=this.CS.dialog;this.info=this.CS.info;this.info.setValue('Not started. Not connected. Screen '+this.UI.screen.width+'x'+this.UI.screen.height);function set(label,flag){switch(label){case'Agent ID':self.config.log.agent=flag;break;case'Parent ID':self.config.log.parent=flag;break;case'Time':self.config.log.time=flag;break;case'Class':self.config.log.class=flag;break;case'PID':self.config.logJam.pid=flag;break;case'Node':self.config.logJam.node=flag;break;case'World':self.config.logJam.world=flag;break;case'Time ':self.config.logJam.time=flag;break;case'Level':self.config.agents.level=flag;break;}}
page=1;this.CS.pages.menu=page;this.UI.pages[page].quit=this.CS.menu.buttons.quit;this.CS.menu.buttons.quit.on('press',function(data){return self.quit(0);});this.UI.pages[page].label1=this.CS.menu.labels.top;this.UI.pages[page].but2=this.CS.menu.buttons.setup;this.CS.menu.buttons.setup.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.setup);});this.UI.pages[page].but3=this.CS.menu.buttons.control;this.CS.menu.buttons.control.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.control);});this.UI.pages[page].but4=this.CS.menu.buttons.jam;this.CS.menu.buttons.jam.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.jam);});this.UI.pages[page].but5=this.CS.menu.buttons.agents;this.CS.menu.buttons.agents.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.agents);});this.UI.pages[page].but6=this.CS.menu.buttons.logging;this.CS.menu.buttons.logging.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.logging);});this.UI.pages[page].next=page+1;page=2;this.CS.pages.setup=page;this.UI.pages[page].but1=this.CS.setup.buttons.menu;this.CS.setup.buttons.menu.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('prev');});if(this.UI.layout.size!='large'){this.UI.pages[page].but2=this.CS.setup.buttons.more1;this.CS.setup.buttons.more1.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('next');});}
this.UI.pages[page].label1=this.CS.setup.labels.top1;this.UI.pages[page].input1=this.CS.setup.inputs.remoteip;this.UI.pages[page].input2=this.CS.setup.inputs.remoteipp;this.UI.pages[page].input3=this.CS.setup.inputs.localip;this.UI.pages[page].input4=this.CS.setup.inputs.protect;this.UI.pages[page].label2=this.CS.setup.labels.input;if(!this.config.security)this.CS.setup.inputs.protect.noshow=true;this.CS.setup.inputs.remoteip.on('set content',function(){var p=self.CS.setup.labels.input.getContent();self.links[p].address=self.CS.setup.inputs.remoteip.getValue();});this.CS.setup.inputs.remoteipp.on('set content',function(){var p=self.CS.setup.labels.input.getContent();self.links[p].port=Number(self.CS.setup.inputs.remoteipp.getValue());});this.CS.setup.inputs.localip.on('set content',function(){var p=self.CS.setup.labels.input.getContent(),v=self.CS.setup.inputs.localip.getValue();self.links[p].local=v;if(p.indexOf('IP')==0)
for(p in self.links)
if(p.indexOf('IP')==0)self.links[p].local=v;});x=this.CF.setup.checkboxes.x0,y=this.CF.setup.checkboxes.y0;for(p in this.links){function make(p){self.UI.pages[page][p]=self.UI.checkbox({left:x,top:y,text:p,value:self.links[p].enable});if(!self.UI.layout.small){if(p.indexOf('IP')==0){self.UI.pages[page][p+'-proto-udp']=self.UI.radiobutton({left:x+10,top:y,text:'UDP',value:true,group:p,hidden:!self.config.expert});self.UI.pages[page][p+'-proto-http']=self.UI.radiobutton({left:x+18,top:y,text:'HTTP',value:false,group:p,hidden:!self.config.expert});}}
self.UI.pages[page][p].on('check',function(){self.CS.setup.labels.input.setValue(p);self.CS.setup.inputs.remoteip.setValue(self.links[p].address||'');self.CS.setup.inputs.remoteipp.setValue(String(self.links[p].port||''));self.CS.setup.inputs.localip.setValue(String(self.links[p].local||'*'));self.links[p].enable=true;});self.UI.pages[page][p].on('uncheck',function(){self.CS.setup.labels.input.setValue(p);self.CS.setup.inputs.remoteip.setValue(self.links[p].address||'');self.CS.setup.inputs.remoteipp.setValue(String(self.links[p].port||''));self.CS.setup.inputs.localip.setValue(String(self.links[p].local||'*'));self.links[p].enable=false;});}
make(p);y+=2;if(y==this.CF.setup.checkboxes.y1)x=this.CF.setup.checkboxes.x1,y=this.CF.setup.checkboxes.y0;}
this.UI.pages[page].prev=page-1;if(this.UI.layout.small){this.UI.pages[page].next=3;page=3
this.CS.pages.setup2=page;this.UI.pages[page].but1=this.CS.setup.buttons.less1;this.UI.pages[page].label1=this.CS.setup.labels.top2;this.CS.setup.buttons.less1.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('prev');});this.UI.pages[page].but2=this.CS.setup.buttons.more2;this.CS.setup.buttons.more2.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('next');});this.UI.pages[page].label2=this.CS.setup.labels.protocol;this.UI.pages[page].checkbox21=this.CS.setup.checkboxes.http;this.UI.pages[page].checkbox22=this.CS.setup.checkboxes.udp;this.UI.pages[page].checkbox23=this.CS.setup.checkboxes.autoconnect;this.CS.setup.checkboxes.autoconnect.on('check',function(){self.config.autoconnect=true});this.CS.setup.checkboxes.autoconnect.on('uncheck',function(){self.config.autoconnect=false});this.UI.pages[page].label3=this.CS.setup.labels.agentflags;this.UI.pages[page].checkbox31=this.CS.setup.checkboxes.agentid;this.UI.pages[page].checkbox32=this.CS.setup.checkboxes.parentid;this.UI.pages[page].checkbox33=this.CS.setup.checkboxes.agenttime;this.UI.pages[page].checkbox34=this.CS.setup.checkboxes.agentclass;this.UI.pages[page].prev=page-1;this.UI.pages[page].next=page+1;page=4;this.CS.pages.setup3=page;this.UI.pages[page].but1=this.CS.setup.buttons.less2;this.UI.pages[page].label1=this.CS.setup.labels.top23;this.CS.setup.buttons.less2.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('prev');});this.UI.pages[page].but2=this.CS.setup.buttons.more3;this.CS.setup.buttons.more3.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('next');});this.UI.pages[page].checkbox5=this.CS.setup.checkboxes.softkey;this.CS.setup.checkboxes.softkey.on('check',function(){self.UI.options.keyboard=self.config.keyboard=true});this.CS.setup.checkboxes.softkey.on('uncheck',function(){self.UI.options.keyboard=self.config.keyboard=false});this.UI.pages[page].checkbox6=this.CS.setup.checkboxes.verbose;this.CS.setup.checkboxes.verbose.on('check',function(){self.options.verbose=2});this.CS.setup.checkboxes.verbose.on('uncheck',function(){self.options.verbose=1});this.UI.pages[page].checkbox7=this.CS.setup.checkboxes.simple;this.CS.setup.checkboxes.simple.on('check',function(){self.config.simple=true});this.CS.setup.checkboxes.simple.on('uncheck',function(){self.config.simple=false});this.UI.pages[page].checkbox8=this.CS.setup.checkboxes.security;this.CS.setup.checkboxes.security.on('check',function(){self.config.security=true});this.CS.setup.checkboxes.security.on('uncheck',function(){self.config.security=false});this.UI.pages[page].label4=this.CS.setup.labels.messageflags;this.UI.pages[page].checkbox41=this.CS.setup.checkboxes.msgpid;this.UI.pages[page].checkbox42=this.CS.setup.checkboxes.msgnode;this.UI.pages[page].checkbox43=this.CS.setup.checkboxes.msgworld;this.UI.pages[page].checkbox44=this.CS.setup.checkboxes.msgtime;this.UI.pages[page].prev=page-1;this.UI.pages[page].next=page+1;page++;this.CS.pages.setup4=page;this.UI.pages[page].but1=this.CS.setup.buttons.less3;this.UI.pages[page].label1=this.CS.setup.labels.top3;this.CS.setup.buttons.less3.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('prev');});this.UI.pages[page].input1=this.CS.setup.inputs.script;this.UI.pages[page].input1.on('set content',function(){self.config.script=self.CS.setup.inputs.script.getContent();});this.UI.pages[page].prev=page-1;}else if(this.UI.layout.normal){this.UI.pages[page].next=page+1;page=3;this.CS.pages.setup2=page;this.UI.pages[page].but1=this.CS.setup.buttons.less1;this.CS.setup.buttons.less1.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('prev');});this.UI.pages[page].but2=this.CS.setup.buttons.more3;this.CS.setup.buttons.more3.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('next');});this.UI.pages[page].label1=this.CS.setup.labels.top2;this.UI.pages[page].label2=this.CS.setup.labels.protocol;this.UI.pages[page].checkbox21=this.CS.setup.checkboxes.http;this.UI.pages[page].checkbox22=this.CS.setup.checkboxes.udp;this.UI.pages[page].checkbox23=this.CS.setup.checkboxes.autoconnect;this.CS.setup.checkboxes.autoconnect.on('check',function(){self.config.autoconnect=true});this.CS.setup.checkboxes.autoconnect.on('uncheck',function(){self.config.autoconnect=false});if(this.config.expert){this.CS.setup.labels.protocol.noshow=true;this.CS.setup.checkboxes.http.noshow=true;this.CS.setup.checkboxes.udp.noshow=true;}
this.UI.pages[page].label3=this.CS.setup.labels.agentflags;this.UI.pages[page].checkbox31=this.CS.setup.checkboxes.agentid;this.UI.pages[page].checkbox32=this.CS.setup.checkboxes.parentid;this.UI.pages[page].checkbox33=this.CS.setup.checkboxes.agenttime;this.UI.pages[page].checkbox34=this.CS.setup.checkboxes.agentclass;this.UI.pages[page].label4=this.CS.setup.labels.messageflags;this.UI.pages[page].checkbox41=this.CS.setup.checkboxes.msgpid;this.UI.pages[page].checkbox42=this.CS.setup.checkboxes.msgnode;this.UI.pages[page].checkbox43=this.CS.setup.checkboxes.msgworld;this.UI.pages[page].checkbox44=this.CS.setup.checkboxes.msgtime;this.UI.pages[page].checkbox5=this.CS.setup.checkboxes.expert;this.CS.setup.checkboxes.expert.on('check',function(){self.config.expert=true;for(var p in self.links){if(p.indexOf('IP')==0){self.UI.pages[self.CS.pages.setup][p+'-proto-udp'].noshow=false;self.UI.pages[self.CS.pages.setup][p+'-proto-http'].noshow=false;}}
self.CS.setup.labels.protocol.noshow=true;self.CS.setup.checkboxes.udp.noshow=true;self.CS.setup.checkboxes.http.noshow=true;});this.CS.setup.checkboxes.expert.on('uncheck',function(){self.config.expert=false;for(var p in self.links){if(p.indexOf('IP')==0){self.UI.pages[self.CS.pages.setup][p+'-proto-udp'].noshow=true;self.UI.pages[self.CS.pages.setup][p+'-proto-http'].noshow=true;}}
self.CS.setup.labels.protocol.noshow=false;self.CS.setup.checkboxes.udp.noshow=false;self.CS.setup.checkboxes.http.noshow=false;});this.UI.pages[page].checkbox6=this.CS.setup.checkboxes.softkey;this.CS.setup.checkboxes.softkey.on('check',function(){self.UI.options.keyboard=self.config.keyboard=true});this.CS.setup.checkboxes.softkey.on('uncheck',function(){self.UI.options.keyboard=self.config.keyboard=false});this.UI.pages[page].checkbox7=this.CS.setup.checkboxes.verbose;this.CS.setup.checkboxes.verbose.on('check',function(){self.options.verbose=2});this.CS.setup.checkboxes.verbose.on('uncheck',function(){self.options.verbose=1});this.UI.pages[page].checkbox8=this.CS.setup.checkboxes.security;this.CS.setup.checkboxes.security.on('check',function(){self.config.security=true;self.CS.setup.inputs.protect.noshow=false;});this.CS.setup.checkboxes.security.on('uncheck',function(){self.config.security=false;self.CS.setup.inputs.protect.noshow=true;});this.UI.pages[page].checkbox9=this.CS.setup.checkboxes.sensors;this.CS.setup.checkboxes.sensors.on('check',function(){self.config.sensors=true;});this.CS.setup.checkboxes.sensors.on('uncheck',function(){self.config.sensors=false;});this.UI.pages[page].checkbox10=this.CS.setup.checkboxes.simple;this.CS.setup.checkboxes.simple.on('check',function(){self.config.simple=true;});this.CS.setup.checkboxes.simple.on('uncheck',function(){self.config.simple=false;});for(i=1;i<=4;i++){this.UI.pages[page]['checkbox3'+i].on('check',function(arg){set(arg.text,true)});this.UI.pages[page]['checkbox3'+i].on('uncheck',function(arg){set(arg.text,false)});this.UI.pages[page]['checkbox4'+i].on('check',function(arg){set(arg.text,true)});this.UI.pages[page]['checkbox4'+i].on('uncheck',function(arg){set(arg.text,false)});}
this.UI.pages[page].prev=page-1;this.UI.pages[page].next=page+1;page++;this.CS.pages.setup3=page;this.UI.pages[page].but1=this.CS.setup.buttons.less3;this.UI.pages[page].label1=this.CS.setup.labels.top3;this.CS.setup.buttons.less3.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('prev');});this.UI.pages[page].input1=this.CS.setup.inputs.script;this.UI.pages[page].input1.on('set content',function(){self.config.script=self.CS.setup.inputs.script.getContent();});this.UI.pages[page].prev=page-1;}else{}
page++;this.CS.pages.control=page;this.UI.pages[page].but1=this.UI.button({left:1,content:'<< Menu'});this.UI.pages[page].but1.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(1);});if(process.platform==='android'){this.UI.pages[page].but1X=this.UI.button({right:1,content:'Hide KB'});this.UI.pages[page].but1X.on('press',function(data){if(Proc)Proc.exec('input keyevent 4',function(err,stdout,stderr){self.log('Hide KB: '+err+'/'+stdout+'/'+stderr);});});}
this.UI.pages[page].label1=this.CS.control.labels.top;this.UI.pages[page].but2=this.CS.control.buttons.start;this.UI.pages[page].but2.on('press',function(data){if(!self.run){if(!self.status.initialized)self.initJAM();self.startJAM();}
self.update('status');self.UI.pages[self.CS.pages.control].but2.setStyle({bg:'lightgrey'});self.UI.pages[self.CS.pages.control].but3.setStyle({bg:'red'});});this.UI.pages[page].but3=this.CS.control.buttons.stop;this.UI.pages[page].but3.on('press',function(data){if(self.run){self.stopJAM();}
self.update('status');self.UI.pages[self.CS.pages.control].but2.setStyle({bg:'green'});self.UI.pages[self.CS.pages.control].but3.setStyle({bg:'lightgrey'});});this.UI.pages[page].but4=this.CS.control.buttons.connect;this.UI.pages[page].but4.on('press',function(data){self.connect();self.update('status');});this.UI.pages[page].but5=this.CS.control.buttons.reset;this.UI.pages[page].but5.on('press',function(data){if(self.run){self.stopJAM();}
if(self.jam)self.jam=undefined,self.status.initialized=false;self.update('status');});this.UI.pages[page].info1=this.CS.control.info1;this.UI.pages[page].info1.setValue('Not connected.');this.UI.pages[page].prev=this.CS.pages.menu;page++;this.CS.pages.jam=page;this.UI.pages[page].but1=this.UI.button({left:1,content:'<< Menu'});this.UI.pages[page].but1.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.menu);});this.UI.pages[page].label1=this.UI.label({center:true,top:1,content:'JAM'});this.UI.pages[page].info1=this.UI.info({top:4,left:4,width:self.UI.screen.width-8,label:'JAM World'});this.UI.pages[page].info2=this.UI.info({top:8,left:4,width:self.UI.screen.width-8,label:'JAM Node'});this.UI.pages[page].info3=this.UI.info({top:12,left:4,width:self.UI.screen.width-8,label:'JAM Domain'});this.UI.pages[page].info4=this.UI.info({top:16,left:4,width:self.UI.screen.width-8,label:'JAM Status'});this.UI.pages[page].info1.setValue(this.config.worldname);this.UI.pages[page].info2.setValue(this.config.nodename);this.UI.pages[page].info3.setValue(this.config.domain);this.UI.pages[page].info4.setValue('Not started.');this.UI.pages[page].but2=this.UI.button({right:1,content:'Info'});this.UI.pages[page].but2.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.stats);});this.UI.pages[page].prev=this.CS.pages.menu;this.UI.pages[page].next=page+1;page++;this.CS.pages.stats=page;this.UI.pages[page].but1=this.CS.stats.buttons.back;this.CS.stats.buttons.back.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.jam);});this.UI.pages[page].but2=this.CS.stats.buttons.explorer;this.CS.stats.buttons.explorer.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('next');});this.UI.pages[page].label1=this.CS.stats.labels.top;this.UI.pages[page].info1=this.CS.stats.infos.mem;this.UI.pages[page].info2=this.CS.stats.infos.com;this.UI.pages[page].tree1=this.CS.stats.tree1;this.CS.stats.tree1.update({mem:0,heap:0,});function updateStatTree(element){var mem=process.memoryUsage(),stats={mem:{_value:mem.rss,_update:function(data){data._value=process.memoryUsage().rss}},heap:{_value:mem.heapUsed,_update:function(data){data._value=process.memoryUsage().heapUsed}}},p,q,node,id,pro,sensor,sensors=process.sensor&&process.sensor.info();var node=self.jam?self.jam.stats('node'):undefined;if(node){stats.node={};for(p in node){stats.node[p]={_value:node[p],_update:(function(p){return function(data){data._value=self.jam.stats('node')[p]}})(p)}}}
if(self.config.sensors&&sensors){stats.sensors={};for(p in sensors){sensor=sensors[p];stats.sensors[sensor]=(function(s){return{_value:process.sensor.read(s),_update:function(data){data._value=process.sensor.read(s)}}})(typeof sensor=='string'?sensor:sensor[2]);}}
if(element)element=stats;if(self.jam){node=self.jam.world.nodes[0];stats.connections={};for(q in node.connections){if(node.connections[q])stats.connections[q]={count:node.connections[q].count()+' Bytes'};}
stats.agents={};for(q in node.processes.table){if(!node.processes.table[q])continue;pro=node.processes.table[q];id=pro.agent.id;stats.agents[id]={pid:pro.pid,class:pro.agent.ac,time:pro.consumed,level:pro.level};}}
stats._update=updateStatTree;if(!element)self.UI.pages[self.CS.pages.stats].tree1.update(stats);}
this.UI.pages.on(page,'load',function(){var mem=process.memoryUsage();self.UI.pages[self.CS.pages.stats].info1.update('Total: '+String(MB(mem.rss))+' MB, Heap: '+String(MB(mem.heapUsed))+' MB');self.UI.pages[self.CS.pages.stats].info2.update('0 MB');updateStatTree();});this.UI.pages[page].prev=this.CS.pages.jam;this.UI.pages[page].next=page+1;page++;this.CS.pages.explorer=page;this.UI.pages[page].but1=this.CS.explorer.buttons.back;this.CS.explorer.buttons.back.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.stats);});this.UI.pages[page].but2=this.CS.explorer.buttons.killall;this.CS.explorer.buttons.killall.on('press',function(data){if(self.jam)self.jam.kill('*');updateAdminTree();});this.UI.pages[page].but3=this.CS.explorer.buttons.kill;this.CS.explorer.buttons.kill.on('press',function(data){updateAdminTree();});this.UI.pages[page].label1=this.CS.explorer.labels.top;this.UI.pages[page].prev=this.CS.pages.stats;this.UI.pages[page].tree1=this.CS.explorer.tree1;var _test=0;function updateAgent(node,id){return function(data){var p,pro=node.getAgentProcess(id);var pro=node.getAgentProcess(id);if(pro){for(p in pro.agent)data[p]=pro.agent[p];}else for(p in data)delete data[p];}}
function updateAdminTree(element){var stats={},p,q,node,id,pro;if(element)element=stats;if(self.jam){node=self.jam.world.nodes[0];for(q in node.processes.table){if(!node.processes.table[q])continue;pro=node.processes.table[q];id=pro.agent.ac+'.'+pro.agent.id+' (L'+pro.level+' T'+pro.consumed+')';stats[id]={};stats[id]._update=updateAgent(node,pro.agent.id);for(p in pro.agent){stats[id][p]=pro.agent[p];}}}
stats._update=updateAdminTree;if(!element)self.UI.pages[self.CS.pages.explorer].tree1.update(stats);}
this.UI.pages.on(page,'load',function(){updateAdminTree();});page++;this.CS.pages.agents=page;this.UI.pages[page].but1=this.UI.button({left:1,content:'<< Menu'});this.UI.pages[page].but1.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.menu);});this.UI.pages[page].but2=this.UI.button({right:1,content:'Config'});this.UI.pages[page].but2.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('next');});this.UI.pages[page].label1=this.UI.label({center:true,top:1,content:'Agents'});this.UI.pages[page].but3=this.CS.agents.buttons.clear;this.UI.pages[page].but3.on('press',function(data){self.msgWin.clear();});this.UI.pages[page].log1=this.CS.agents.log1;this.UI.pages[page].prev=this.CS.pages.menu;this.msgWin=this.CS.agents.log1;this.log2('Agent message window ready.');page++;this.CS.pages.classes=page;this.UI.pages[page].label1=this.CS.classes.labels.top;this.UI.pages[page].but1=this.UI.button({left:1,content:'<< Agents'});this.UI.pages[page].but1.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show('prev');});this.UI.pages[page].but2=this.CS.classes.buttons.load;this.UI.pages[page].but3=this.CS.classes.buttons.execute;this.CS.classes.buttons.load.on('press',function(data){var status;if(self.UI.pages[self.CS.pages.classes].fm&&!self.UI.pages[self.CS.pages.classes].fm.hidden){return};if(!self.UI.pages[self.CS.pages.classes].fm){self.UI.pages[self.CS.pages.classes].fm=self.UI.fileManager({cwd:process.env.CWD||process.env.PWD,parent:this.screen,top:self.CF.fm.top,hidden:true,autohide:true,width:self.CF.fm.width,height:self.CF.fm.height,input:{mutable:true},box:{},arrows:{up:'[-]',down:'[+]',width:3,height:1}});self.UI.pages[self.CS.pages.classes].fm.refresh();self.UI.pages[self.CS.pages.classes].fm.on('file',function(file){self.loadClassFile(file);});}
self.UI.pages[self.CS.pages.classes].fm.show();self.UI.pages[self.CS.pages.classes].fm.focus();});this.CS.classes.buttons.execute.on('press',function(data){var status;if(self.UI.pages[self.CS.pages.classes].fm&&!self.UI.pages[self.CS.pages.classes].fm.hidden){return};if(!self.UI.pages[self.CS.pages.classes].fm){self.UI.pages[self.CS.pages.classes].fm=self.UI.fileManager({cwd:process.env.CWD||process.env.PWD,parent:this.screen,top:self.CF.fm.top,hidden:true,autohide:true,width:self.CF.fm.width,height:self.CF.fm.height,input:{mutable:true},box:{},arrows:{up:'[-]',down:'[+]',width:3,height:1}});self.UI.pages[self.CS.pages.classes].fm.refresh();self.UI.pages[self.CS.pages.classes].fm.on('file',function(file){});}
self.UI.pages[self.CS.pages.classes].fm.show();self.UI.pages[self.CS.pages.classes].fm.focus();});this.UI.pages[page].but4=this.CS.classes.buttons.create;this.CS.classes.buttons.create.on('press',function(data){var args,cls,msg,id;if(!self.status.run)return self.dialog('You need to start JAM first!');if(!self.UI.pages[self.CS.pages.classes].tree1.getSelected())return self.dialog('No class selected!');cls=self.UI.pages[self.CS.pages.classes].tree1.getSelected().getContent();try{eval('args='+self.UI.pages[self.CS.pages.classes].input1.getValue());if(!args)throw'Invalid arguments';self.createAgent(cls,args,self.config.agents.level,true);}catch(e){self.dialog(msg+' Error: '+e);}});this.UI.pages[page].tree1=this.CS.classes.lists.classes;this.UI.pages[page].input1=this.CS.classes.inputs.arguments;this.UI.pages[page].label2=this.CS.classes.labels.level;this.UI.pages[page].checkbox21=this.CS.classes.checkboxes.level0;this.UI.pages[page].checkbox22=this.CS.classes.checkboxes.level1;this.UI.pages[page].checkbox23=this.CS.classes.checkboxes.level2;this.UI.pages[page].checkbox24=this.CS.classes.checkboxes.level3;for(i=1;i<=4;i++){this.UI.pages[page]['checkbox2'+i].on('check',function(arg){set('Level',Number(arg.text))});}
this.UI.pages.on(page,'load',function(){self.UI.pages[self.CS.pages.classes].tree1.set(self.classes);});this.UI.pages[page-1].next=page;this.UI.pages[page].prev=page-1;page++;this.CS.pages.logging=page;this.UI.pages[page].but1=this.UI.button({left:1,content:'<< Menu'});this.UI.pages[page].but1.on('press',function(data){self.UI.pages.hide('this');self.UI.pages.show(1);});this.UI.pages[page].but2=this.UI.button({right:1,content:'Clear',bg:'green'});this.UI.pages[page].but2.on('press',function(data){self.logWin.clear();});this.UI.pages[page].label1=this.UI.label({center:true,top:1,content:'Logging'});this.UI.pages[page].log1=this.CS.log1;this.logWin=this.CS.log1;this.log('JAMapp Version '+options.version+'. (c) Dr. Stefan Bosse');this.UI.pages[page].prev=this.CS.pages.menu;this.UI.pages.show(1);for(i=2;i<=20;i++)this.UI.pages.hide(i);this.info.setValue('Not connected. Not started. Screen '+
this.UI.screen.width+'x'+this.UI.screen.height+' '+(this.UI.layout.small?'S':'N')+' '+process.platform);this.UI.screen.key(['escape','q','C-c'],function(ch,key){return self.quit(0);});this.UI.screen.key(['left','right'],function(ch,key){if(key.name=='right'&&self.UI.pages[self.UI.page].next){if(self.UI.page==self.CS.pages.menu){switch(self.CS.menu.selected){case-1:self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.setup);break;case 0:self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.control);break;case 1:self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.jam);break;case 2:self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.agents);break;case 3:self.UI.pages.hide('this');self.UI.pages.show(self.CS.pages.logging);break;}}else{self.UI.pages.hide('this');self.UI.pages.show('next');}}else if(key.name=='left'&&self.UI.pages[self.UI.page].prev){self.UI.pages.hide('this');self.UI.pages.show('prev');}});this.CS.menu.selected=-1;this.UI.screen.key(['up','down'],function(ch,key){if(key.name=='up'&&self.UI.page==self.CS.pages.menu&&self.CS.menu.selected>=0){self.CS.menu.selected--;switch(self.CS.menu.selected){case-1:self.CS.menu.buttons.control.setStyle({bg:'blue'});break;case 0:self.CS.menu.buttons.jam.setStyle({bg:'blue'});self.CS.menu.buttons.control.setStyle({bg:'red'});break;case 1:self.CS.menu.buttons.agents.setStyle({bg:'blue'});self.CS.menu.buttons.jam.setStyle({bg:'red'});break;case 2:self.CS.menu.buttons.logging.setStyle({bg:'blue'});self.CS.menu.buttons.agents.setStyle({bg:'red'});break;}
self.UI.screen.render();}else if(key.name=='down'&&self.UI.page==self.CS.pages.menu&&self.CS.menu.selected<3){self.CS.menu.selected++;switch(self.CS.menu.selected){case 0:self.CS.menu.buttons.control.setStyle({bg:'red'});break;case 1:self.CS.menu.buttons.control.setStyle({bg:'blue'});self.CS.menu.buttons.jam.setStyle({bg:'red'});break;case 2:self.CS.menu.buttons.jam.setStyle({bg:'blue'});self.CS.menu.buttons.agents.setStyle({bg:'red'});break;case 3:self.CS.menu.buttons.agents.setStyle({bg:'blue'});self.CS.menu.buttons.logging.setStyle({bg:'red'});break;}
self.UI.screen.render();}});}
appTerm.prototype.start=function(){var self=this;if(this.config.mode!='server')this.UI.start();else{if(!self.run){if(!self.status.initialized)self.initJAM();self.startJAM();}}}
appTerm.prototype.startScript=function(script){var self=this;function load(file){self.out('[SCRIPT] Loading agent class file '+file);self.loadClassFile(file);}
function create(cls,args,level){self.out('[SCRIPT] Creating agent '+cls+'()');self.createAgent(cls,args,level);}
try{eval(script);}catch(e){self.out('Script execution failed: '+e);}}
appTerm.prototype.startJAM=function(){var self=this;this.run=true;if(this.config.mode!='server')this.UI.pages[this.CS.pages.control].info1.setValue('JAM starting ..');this.jam.start(function(){self.out('JAM started.');if(self.config.mode!='server'){self.UI.pages[self.CS.pages.control].info1.setValue('JAM and NET started.');self.UI.pages[self.CS.pages.jam].info4.setValue('JAM running.');}
self.status.run=true;self.update('status');if(self.config.autoconnect)
self.connect();self.startScript(self.config.script);});}
appTerm.prototype.stopJAM=function(){this.run=false;this.UI.pages[this.CS.pages.control].info1.setValue('JAM stopping ..');this.jam.stop();this.status.run=false;this.update('status');if(this.config.mode!='server'){this.UI.pages[this.CS.pages.control].info1.setValue('JAM and NET stopped.');this.UI.pages[this.CS.pages.jam].info4.setValue('JAM stopped.');}
this.out('JAM stopped.');}
appTerm.prototype.update=function(what){var s,sep;switch(what){case'status':s='';s+=this.status.initialized?'Initialized.':'Not initialized.';s+=this.status.run?' Running.':' Not running.';s+=this.status.connected?' Connected.':' Not connected.';s+=this.status.connecting?' Connecting ..':'';s+=this.status.error?(' Error:'+this.status.error):'';if(this.config.mode!='server')this.info.setValue(s);break;case true:break;}}
var App=function(options){var obj=none;obj=new appTerm(options);return obj;}
var JA=App();JA.init();JA.start();};BundleModuleCode['com/compat']=function(module,exports){var Io=Require('com/io');var Path=Require('com/path');var Sprintf=Require('com/sprintf');global.any=undefined;global._=undefined;global.none=null;global.empty=null;global.NL='\n';global.int=function(v){return v|0};global.div=function(a,b){return a/b|0};if(!Object.prototype.forEach){Object.defineProperties(Object.prototype,{'forEach':{value:function(callback){if(this==null){throw new TypeError('Not an object');}
var obj=this;for(var key in obj){if(obj.hasOwnProperty(key)){callback.call(obj,obj[key],key,obj);}}},writable:true}});}
function inherit(child,parent){for(var p in parent.prototype){if(p=='__proto__')continue;child.prototype[p]=parent.prototype[p];}}
function inheritPrototype(child,parent){var __proto__=child.__proto__;child.prototype.__proto__=parent.prototype;if(!__proto__)for(var p in parent.prototype){if(p=='__proto__')continue;child.prototype[p]=parent.prototype[p];}}
function instanceOf(obj,cla){var p=obj.__proto__;if(obj instanceof cla)return true;while(p){if(p===cla.prototype)return true;p=p.__proto__}
return false;}
function defineGetter(cla,prop,fun){Object.defineProperty(cla.prototype,prop,{configurable:true,get:fun});}
function defineSetter(cla,prop,fun){Object.defineProperty(cla.prototype,prop,{configurable:true,set:fun});}
Object.addProperty=function(obj,name,fun){if(obj.prototype[name])return;obj.prototype[name]=fun;Object.defineProperty(obj.prototype,name,{enumerable:false});};Object.updateProperty=function(obj,name,fun){obj.prototype[name]=fun;Object.defineProperty(obj.prototype,name,{enumerable:false});};Object.addProperty(Array,'contains',function(el){return this.indexOf(el)!=-1});Object.addProperty(Array,'last',function(){return this[this.length-1]});global.inherit=inherit;global.inheritPrototype=inheritPrototype;global.instanceOf=instanceOf;global.defineGetter=defineGetter;global.defineSetter=defineSetter;var assert=function(condmsg){if(condmsg!=true){Io.out('** Assertion failed: '+condmsg+' **');Io.stacktrace();throw Error(condmsg);}};global.assert=assert;function forof(obj,f){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=obj[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){element=_step.value;f(element);}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}}
global.forof=forof;var obj={compact:function(o){var a;if(obj.isArray(o)){if(o.length==1&&obj.isObject(o[0]))return obj.compact(o[0]);else return o;}else if(obj.isObject(o))for(a in o){var elem=o[a];o[a]=obj.compact(elem);}
return o;},copy:function(o){if(o===null||typeof o!=='object'){return o;}
var temp=(o instanceof Array)?[]:{};for(var key in o){temp[key]=obj.copy(o[key]);}
return temp;},equal:function(o1,o2){if(!o1||!o2)return false;for(var i in o1)if(o1[i]!=o2[i])return false;for(var i in o2)if(o1[i]!=o2[i])return false;return true;},extend:function(o1,o2){for(var i in o2)o1[i]=o2[i];return o1;},find:function(obj,fun){var p;for(p in obj){if(fun(obj[p],p))return obj[p];}},hasProperty:function(o,p){return o[p]!=undefined||(p in o);},head:function(o){for(var p in o)return p;return undefined;},inherit:function(dst,src){for(var i in src){if(typeof dst[i]=='object'&&typeof src[i]=='object')
inherit(dst[i],src[i]);else if(typeof dst[i]=='undefined')
dst[i]=src[i];}
return dst;},isArray:function(o){if(o==_||o==null)return false;else return typeof o=="array"||(typeof o=="object"&&o.constructor===Array);},isMatrix:function(o){if(o==_||o==null)return false;else return obj.isArray(o)&&obj.isArray(o[0]);},isEmpty:function(o){for(var prop in o){if(o[prop]!=undefined)return false;}
return true;},isError:function(o){return o instanceof Error},isFunction:function(o){return typeof o=="function";},isObj:function(o){return typeof o=="object";},isObject:function(o){return typeof o=="object";},isRegex:function(o){return o instanceof RegExp;},isString:function(o){return typeof o=="string"||(typeof o=="object"&&o.constructor===String);},isNumber:function(o){return typeof o=="number"||(typeof o=="object"&&o.constructor===Number);},iter:function(obj,fun){var p;for(p in obj){fun(obj[p],p)}}};var array={and:function(array,fun){var res=true;var i=0;var len=array.length;for(i=0;i<len;i++){var element=array[i];res=res&&fun(element,i)}
return res;},append:function(array,element){array.push(element);return array;},call:function(array,args){var i=0;var len=array.length;for(i=0;i<len;i++){var element=array[i];element()}},check:function(array,fun){var i,exist;exist=false;loop:for(i in array){var element=array[i];if(fun(element,i)){exist=true;break loop;}}
return exist;},concat:function(array,array2){for(var i in array2){array.push(array2[i]);}
return array;},conjunction:function(set1,set2,fun){return array.union(set1,set2,fun);},contains:function(array,elements,fun){var i=array.length;if(!fun)fun=function(o1,o2){return o1===o2};if(obj.isArray(elements)){while(i--){var j=elements.length;while(j--){if(fun(array[i],elements[j])){return true;}}}}
else while(i--){if(fun(array[i],elements)){return true;}}
return false;},copy:function(src,dst){var i;if(dst){for(i in src)dst[i]=src[i];}else return src.slice();},create:function(length,init){var arr=[],i=length;while(i--){arr[i]=init;}
return arr;},create_matrix:function(rows,cols,init){var m=[];var r=[];var i,j;for(i=0;i<rows;i++){r=[];for(j=0;j<cols;j++)r.push(init);m.push(r);}
return m;},disjunction:function(set1,set2,fun){return array.merge(set1,set2);},empty:function(array){return(array==undefined||array.length==0)},equal:function(a1,a2){if(a1.length!=a2.length)return false;for(var i in a1)if(a1[i]!=a2[i])return false;return true;},exclusive:function(set1,set2,fun){var i,j,found,res=[];for(i in set1){found=false;loop1:for(j in set2){if(fun!=undefined&&fun(set1[i],set2[j])){found=true;break loop1;}
else if(fun==undefined&&set1[i]==set2[j]){found=true;break loop1;};}
if(!found)res.push(set1[i]);}
for(i in set2){found=false;loop2:for(j in set1){if(fun!=undefined&&fun(set2[i],set1[j])){found=true;break loop2;}
else if(fun==undefined&&set2[i]==set1[j]){found=true;break loop2;};}
if(!found)res.push(set2[i]);}
return res;},find:function(array,fun){var i;for(i in array){if(fun(array[i],i))return array[i];}
return none;},findmap:function(array,fun){var i,found;for(i in array){found=fun(array[i],i);if(found)return found;}
return none;},filter:function(array,fun){if(array.filter)return array.filter(fun);else{var res=[],len=array.length,element,i;for(i=0;i<len;i++){element=array[i];if(fun(element,i))res.push(element);}
return res;}},filtermap:function(array,fun){var res=[],len=array.length,element,mapped,i;for(i=0;i<len;i++){element=array[i];mapped=fun(element,i);if(mapped!=undefined)res.push(mapped);}
return res;},flatten:function(array){var res=[];var len=array.length;var i;for(i=0;i<len;i++){var element=array[i];if(!obj.isArray(element))res.push(element);else{var j;var len2=element.length;for(j=0;j<len2;j++){var element2=element[j];res.push(element2);}}}
return res;},head:function(array){return array[0];},init:function(length,fun){var arr=[],i=length;while(i--){arr[i]=fun(i);}
return arr;},iter:function(array,fun){array.forEach(fun);},iter2:function(array1,array2,fun){var i=0;assert((array1.length==array2.length)||('Array.iter2: arrays of different lengths'));array1.forEach(function(e1,i){fun(e1,array2[i],i)});},iter_break:function(array,fun){var i=0;var len=array.length;for(i=0;i<len;i++){var element=array[i];if(fun(element,i))return;}},iter_rev:function(array,fun){var i;var len=array.length;for(i=len-1;i>=0;i--){fun(array[i],i)}},last:function(array){var len=array.length;if(len==0)return none;else return array[len-1];},length:function(array){return array.length;},map2:function(array1,array2,fun){var i=0;assert((array1.length==array2.length)||('Array.map2: arrays of different lengths'));var len=array1.length;var res=[];for(i=0;i<len;i++){res.push(fun(array1[i],array2[i],i));}
return res;},map:function(array,fun){var i=0;var len=array.length;var res=[];for(i=0;i<len;i++){var element=array[i];res.push(fun(element,i));}
return res;},match:function(array,fun_hdtl,fun_empty){if(array.length==0){if(fun_empty)fun_empty();}else if(array.length>1){var hd=this.head(array);var tl=this.tail(array);fun_hdtl(hd,tl);}else fun_hdtl(this.head(array),[]);},match2:function(array,fun_hd1hd2,fun_hdtl,fun_empty){if(array.length==0&&fun_empty)
fun_empty();else if(array.length==2){var hd1=this.head(array);var hd2=this.second(array);fun_hd1hd2(hd1,hd2);}
else if(array.length>1&&fun_hdtl){var hd=this.head(array);var tl=this.tail(array);fun_hdtl(hd,tl);}else if(fun_hdtl)fun_hdtl(this.head(array),[]);},max:function(array,fun){var res,max,num;for(var i in array){if(fun)num=fun(array[i]);else num=array[i];if(max==undefined){max=num;res=array[i]}
else if(num>max){max=num;res=array[i]}}
return res;},min:function(array,fun){var res,min,num;for(var i in array){if(fun)num=fun(array[i]);else num=array[i];if(min==undefined){min=num;res=array[i]}
else if(num<min){min=num;res=array[i]}}
return res;},member:function(array,element){var i,exist;var len=array.length;exist=false;loop:for(i=0;i<len;i++){var _element=array[i];if(_element==element){exist=true;break loop;}}
return exist;},merge:function(array1,array2,array3,array4){var arraynew=array1.slice();arraynew=arraynew.concat(array2);if(array3!=undefined)arraynew=arraynew.concat(array3);if(array4!=undefined)arraynew=arraynew.concat(array4);return arraynew;},next:function(array,val){var i;var len=array.length;if(obj.isString(val))
for(i=0;i<len;i++){if(string.equal(array[i],val)){if(i==len-1)return array[0];else return array[i+1];}}
else
for(i=0;i<len;i++){if(array[i]==val){if(i==len-1)return array[0];else return array[i+1];}}
return none;},or:function(array,fun){var res=false;var i=0;var len=array.length;for(i=0;i<len;i++){var element=array[i];res=res||fun(element,i)}
return res;},pluck:function(collection,key){return collection.map(function(object){return object==null?undefined:object[key];});},pop:function(array){var element=array[0];array.shift();return element;},print:function(array){var i;var len=array.length;var str='[';for(i=0;i<len;i++){var cell=array[i];str=str+cell;}
return str+']';},push:function(array,element){array.unshift(element);},range:function(a,b){var i;var array=[];for(i=a;i<=b;i++)array.push(i);return array;},remove:function(array,begin,end){var i,a;if(end==undefined)end=begin+1;if(begin<0||end>=array.length)return[];a=array.slice(0,begin);for(i=end;i<array.length;i++)a.push(array[i]);return a;},second:function(array){return array[1];},sort:function(array,fun){var array2=array.slice();array2.sort(fun);return array2;},split:function(array,pos,len){if(pos==0)return array.slice((len||1));else{var a1=array.slice(0,pos);var a2=array.slice(pos+(len||1));return a1.concat(a2);}},sum:function(array,fun){var res=0;for(var i in array){var num=0;if(fun)num=fun(array[i]);else num=array[i];if(!obj.isNumber(num))return undefined;res+=num;}
return res;},tail:function(array,top){var array2=array.slice();array2.shift();if(top)for(;top>1;top--)array2.shift();return array2;},union:function(set1,set2,fun){var i,j,res=[];for(i in set1){for(j in set2){if(fun!=undefined&&fun(set1[i],set2[j]))res.push(set1[i]);else if(fun==undefined&&set1[i]==set2[j])res.push(set1[i]);}}
return res;},unique:function(array){var length=array?array.length:0;function baseUniq(array){var index=-1,length=array.length,seen,result=[];seen=result;outer:while(++index<length){var value=array[index];var seenIndex=seen.length;while(seenIndex--){if(seen[seenIndex]===value){continue outer;}}
result.push(value);}
return result;}
if(!length){return[];}
return baseUniq(array);},without:function(){var array,values=[];for(var i in arguments){if(i==0)array=arguments[0];else values.push(arguments[i]);}
return array.filter(function(e){return values.indexOf(e)==-1;});},zero:function(array){for(var i in array)if(!!array[i])return false;return true;},};var string={contains:function(template,pattern){return template.indexOf(pattern)>-1;},copy:function(src){var i;var dst='';for(i=0;i<src.length;i++)dst=dst+src.charAt(i);return dst;},create:function(size)
{var i;var s='';var init=' ';for(i=0;i<size;i++)s=s+init;return s;},endsWith:function(str,tail){return str.indexOf(tail)==(str.length-tail.length);},empty:function(str){return this.equal(str,'');},equal:function(str1,str2){var i;var eq=true;if(str1.length!=str2.length)return false;for(i=0;i<str1.length;i++){if(string.get(str1,i)!=string.get(str2,i))eq=false;}
return eq;},find:function(search,str){return str.indexOf(search);},format_hex:function(n,len){switch(len){case 2:return(((n>>4)&0xf).toString(16))+
((n&0xf).toString(16));case 4:return(((n>>12)&0xf).toString(16)+
((n>>8)&0xf).toString(16)+
((n>>4)&0xf).toString(16)+
(n&0xf).toString(16));case 6:return(((n>>20)&0xf).toString(16)+
((n>>16)&0xf).toString(16)+
((n>>12)&0xf).toString(16)+
((n>>8)&0xf).toString(16)+
((n>>4)&0xf).toString(16)+
(n&0xf).toString(16));case 8:return(((n>>28)&0xf).toString(16)+
((n>>24)&0xf).toString(16)+
((n>>20)&0xf).toString(16)+
((n>>16)&0xf).toString(16)+
((n>>12)&0xf).toString(16)+
((n>>8)&0xf).toString(16)+
((n>>4)&0xf).toString(16)+
(n&0xf).toString(16));default:return'format_hex??';}},get:function(str,index){assert((str!=undefined&&index<str.length&&index>=0)||('string.get ('+str.length+')'));return str.charAt(index);},isBoolean:function(str){return(str=='true'||str=='false')},isNumeric:function(str){return!isNaN(parseFloat(str))&&isFinite(str);},isText:function(s){var is_text=true;string.iter(s,function(ch,i){string.match(ch,[['a','z',function(){}],['A','Z',function(){}],['0','9',function(){if(i==0)is_text=false;}],function(){is_text=false;}]);});return is_text;},iter:function(str,fun){var i;var len=str.length;for(i=0;i<len;i++){var c=str.charAt(i);fun(c,i);}},length:function(str){if(str!=undefined)return str.length;else return 0;},lowercase:function(str){return str.toLowerCase();},make:function(size,init)
{var i;var s='';for(i=0;i<size;i++)s=s+init;return s;},map:function(str,mapping){var i;var map;for(i in mapping){map=mapping[i];if(obj.isFunction(map))return map(str);else if(this.equal(str,map[0]))return map[1];}},match:function(str,cases){var i,j;var cas,cex,cv;for(i in cases){cas=cases[i];if(obj.isArray(cas)){switch(cas.length){case 2:cex=cas[0];if(!obj.isArray(cex)){if(this.equal(str,cex)){cas[1]();return;}}else{for(j in cex){cv=cex[j];if(this.equal(str,cv)){cas[1]();return;}}}
break;case 3:try{j=pervasives.int_of_char(str);if(j>=pervasives.int_of_char(cas[0])&&j<=pervasives.int_of_char(cas[1])){cas[2](str);return;}}catch(e){return};break;case 1:cas[0](str);return;default:throw'String.match #args';}}else if(obj.isFunction(cas)){cas(str);return;}}},pad:function(str,pre,post,char){var len=str.length;if(pre>0&&post==0)return string.make(len-pre,char||' ')+str;else if(post>0&&pre==0)return str+string.make(post-len,char||' ');else return string.make(len-pre/2,char||' ')+str+string.make(len-post/2,char||' ');},parse_hex:function(str,pos,len){return parseInt(this.sub(str,pos,len),16);},postfix:function(str,point){var n=str.indexOf(point||'.');if(n<=0)return str;else return str.substr(n+1);},prefix:function(str,point){var n=str.indexOf(point||'.');if(n<=0)return str;else return str.substr(0,n);},replace_first:function(pat,repl,str){return str.replace(pat,repl);},replace_all:function(pat,repl,str){return str.replace('/'+pat+'/g',repl);},set:function(str,index,char){assert((str!=undefined&&index<str.length&&index>=0)||'string.get');return str.substr(0,index)+char+str.substr(index+1)},split:function(delim,str){return str.split(delim);},startsWith:function(str,head){return!str.indexOf(head);},sub:function(str,off,len){if(len)
return str.substr(off,len);else
return str.substr(off);},trim:function(str,pref,post){if(str.length==0||pref>str.length||post>str.length||pref<0||post<0||(pref==0&&post==0))return str;return str.substr(pref,str.length-pref-post);},uppercase:function(str){return str.toUpperCase();},Uppercase:function(str){var len=str.length;if(len>1){var head=str.substr(0,1);var tail=str.substr(1,len-1);return head.toUpperCase()+tail.toLowerCase()}if(len==1)return str.toUpperCase();else return'';}};var rnd=Math.random;var seeder=function(s){var m_w=s;var m_z=987654321;var mask=0xffffffff;return function(){m_z=(36969*(m_z&65535)+(m_z>>16))&mask;m_w=(18000*(m_w&65535)+(m_w>>16))&mask;var result=((m_z<<16)+m_w)&mask;result/=4294967296;return result+0.5;}}
var random={float:function(max){return rnd()*max},int:function(max){return Math.floor(rnd()*max+0)},interval:function(min,max){return Math.round(min+rnd()*(max-min))},range:function(min,max){return min+rnd()*(max-min)},seed:function(s){rnd=seeder(s);}};var printf={align:function(str,indent,width,tab){var lines=string.split('\n',str);var form='';var sp=printf.spaces(indent);var spbreak=sp;array.iter(lines,function(line){var rest;function breakit(spbreak,str){if(width<(str.length+spbreak.length)){return spbreak+string.sub(str,0,width-spbreak.length)+'\n'+
breakit(spbreak,string.sub(str,width-spbreak.length,str.length-width+spbreak.length));}else return spbreak+str+'\n';}
if(width&&width<(line.length+indent)){if(tab){var pos=string.find(tab,line);if(pos>0&&pos<width)spbreak=printf.spaces(pos+indent+1);else spbreak=sp;}
form=form+sp+string.sub(line,0,width-indent)+'\n';rest=string.sub(line,width-indent,line.length-width+indent);form=form+breakit(spbreak,rest);}
else
form=form+sp+line+'\n';});return form;},list:function(array,fun,sep){var i,str='';if(sep==undefined)sep=',';if(fun==undefined)fun=function(s){return s;};if(!obj.isArray(array))array=[array];for(i in array){if(str==='')str=fun(array[i]);else str=str+sep+fun(array[i]);}
return str;},spaces:function(n){return string.make(n,' ');},sprintf2:function(args){var str='';array.iter(args,function(fmtarg){var len,n,fs;if(obj.isArray(fmtarg)){if(fmtarg.length==2){var fmt=fmtarg[0];var arg=fmtarg[1];var fc='';var fn=0;string.iter(fmt,function(c){if(c=='s'||c=='d'||c=='f'||c=='x'){fc=c;}else if(c!='%'){fn=fn*10;n=parseInt(c);if(!isNaN(n))fn=fn+n;}});if(fc=='s'&&obj.isString(arg)){str=str+arg;if(fn!=0){len=arg.length;if(len<fn)str=str+string.create(fn-len);}}else if(fc=='d'&&obj.isNumber(arg)){fs=pervasives.string_of_int(arg);if(fn!=0){len=fs.length;if(len<fn){str=str+string.create(fn-len);}}
str=str+fs;}else if(fc=='x'&&obj.isNumber(arg)){fs=string.format_hex(arg,fn||8);str=str+fs;}}}else if(obj.isString(fmtarg)){str=str+fmtarg;}});return str;},sprintf:Sprintf.sprintf};var filename={basename:function(path){return Path.basename(path);},dirname:function(path){return Path.dirname(path);},extname:function(path){return Path.extname(path)},is_relative:function(path){return!(path.length>0&&path[0]=='/');},join:function(pathl,absolute){var path=(absolute?'/':'');array.iter(pathl,function(name,index){if(index>0){path=path+'/'+name;}
else{path=path+name;}});return path;},normalize:function(path){return Path.normalize(path)},path_absolute:function(path){if(this.is_relative(path)){var workdir=Io.workdir();return this.path_normalize(workdir+'/'+path);}else return this.path_normalize(path);},path_normalize:function(path){var i;if(string.equal(path,''))path='/';var relpath=!(string.get(path,0)=='/');var pathlist=path.split('/');var pathlist2=pathlist.filter(function(s){return(!string.equal(s,'')&&!string.equal(s,'.'))});var pathlist3=[];array.iter(pathlist2,function(pe){if(!string.equal(pe,'..')){array.push(pathlist3,pe)}else{if(pathlist3.length==0)return'';else
pathlist3=array.tail(pathlist3);}});var path2='';i=0;array.iter(pathlist3,function(pe){var sep;if(i==0)sep='';else sep='/';path2=pe+sep+path2;i++;});if(relpath)return path2;else return'/'+path2;},removeext:function(path){return path.substr(0,path.lastIndexOf('.'));}};var pervasives={assert:assert,char_of_int:function(i){return String.fromCharCode(i)},div:function(a,b){return a/b|0;},failwith:function(msg){Io.err(msg);},float_of_string:function(s){var num=parseFloat(s);if(isNaN(num))throw'NaN';else return num;},int_of_char:function(c){return c.charCodeAt()},int_of_float:function(f){return f|0;},int_of_string:function(s){var num=parseInt(s);if(isNaN(num))throw'NaN';else return num;},map:function(value,mapping){function eq(v1,v2){if(v1==v2)return true;if(obj.isString(v1)&&obj.isString(v2))return string.equal(v1,v2);return false;}
if(!array.empty(mapping)){var hd=array.head(mapping);var tl=array.tail(mapping);if(eq(hd[0],value))return hd[1];else return pervasives.map(value,tl);}else return undefined;},match:function(matcher,expr,cases){var ret=undefined;array.iter_break(cases,function(match){var quit,succ,pat,fun;if(match.length==2){pat=match[0];fun=match[1];succ=matcher(expr,pat);if(succ)ret=fun(succ);quit=succ!=undefined;}else if(match.length==1){fun=match[0];ret=fun();quit=true;}
return quit;});return ret;},mtime:function(){var time=new Date();return time.getTime();},min:function(a,b){return(a<b)?a:b},max:function(a,b){return(a>b)?a:b},string_of_float:function(f){return f.toString()},string_of_int:function(i){return i.toString()},string_of_int64:function(i){return i.toString()},time:function(){var time=new Date();return(time.getTime()/1000)|0;}};var bit={get:function(v,b){return(v>>b)&&1;},isSet:function(v,b){return((v>>b)&&1)==1;},set:function(v,b){return v&(1<<b);}};var args={parse:function(argv,map,offset){var shift=undefined,in_shift=0,shift_args=[],names,mapfun,numarg,len=argv.length;if(offset==undefined)offset=1;argv.forEach(function(val,index){var last=index==(len-1);if(index>=offset){if(in_shift==0){array.check(map,function(onemap){assert(onemap!=undefined||'map');if(onemap.length==3){names=onemap[0];numarg=onemap[1];mapfun=onemap[2];if(!obj.isArray(names))names=[names];var found=array.find(names,function(name){if(string.equal(val,name))return name;else _;});if(found){if(numarg==0)mapfun(found);else{in_shift=numarg;shift_args=[];shift=mapfun;}
return true;}}else if(obj.isFunction(onemap)){onemap(val);return true;}else if(onemap.length==1){mapfun=onemap[0];mapfun(val);return true;}
return false;});}else{shift_args.push(val);if(in_shift!='*')in_shift--;if(in_shift==0&&shift!=undefined){numarg=shift_args.length;switch(numarg){case 0:shift(val);break;case 1:shift(shift_args[0],val);break;case 2:shift(shift_args[0],shift_args[1],val);break;case 3:shift(shift_args[0],shift_args[1],shift_args[2],val);break;default:break;}
shift=undefined;}else if(in_shift=='*'&&last)shift(shift_args);}}});}};var hashtbl={add:function(hash,key,data){hash[key]=data;},create:function(initial){return[];},empty:function(hash){for(var key in hash)return false;return true;},find:function(hash,key){return hash[key];},invalidate:function(hash,key){hash[key]=undefined;},iter:function(hash,fun){for(var key in hash){if(hash[key]!=undefined)fun(key,hash[key]);}},mem:function(hash,key){return hash[key]!=undefined;},remove:function(hash,key){if(!hash.hasOwnProperty(key))
return;if(isNaN(parseInt(key))||!(hash instanceof Array))
delete hash[key];else
hash.splice(key,1)}};var types=[];function register_type(name){var typoff=1000+types.length*1000;if(array.member(types,name))throw('[COMP] register_type: type '+name+' exists already.');types.push(name);return typoff;}
module.exports={args:args,assert:assert,array:array,bit:bit,div:pervasives.div,filename:filename,hashtbl:hashtbl,isNodeJS:function(){return(typeof global!=="undefined"&&{}.toString.call(global)=='[object global]');},obj:obj,pervasives:pervasives,printf:printf,random:random,string:string,isArray:obj.isArray,isString:obj.isString,isNumber:obj.isNumber,register_type:register_type,Tuple:function(tag,val1,val2,val3){if(val3)return{t:tag,v1:val1,v2:val2,v3:val3};else if(val2)return{t:tag,v1:val1,v2:val2};else if(val1)return{t:tag,v1:val1};else return{t:tag};}};};BundleModuleCode['top/jamlib']=function(module,exports){var onexit=false;var start=false;var options={geo:undefined,verbose:0,version:'1.34.1'};global.config={simulation:false,nonetwork:false};var Io=Require('com/io');var Comp=Require('com/compat');var Aios=Require('jam/aios');var Esprima=Require('parser/esprima');var Json=Require('jam/jsonfn');var fs=Require('fs');var Sat=Require('dos/ext/satelize');var GPS5=Require('geoip/gps5');var GeoLoc5=Require('geoip/geoloc5');var CBL=Require('com/cbl');var platform=Require('os/platform');var DIR=Aios.DIR;var environment=process.env;process.argv.slice(2).forEach(function(arg){var tokens=arg.match(/([a-zA-Z]+):(['"0-9a-zA-Z_:\->\.\{\},;]+)/);if(tokens&&tokens.length==3)environment[tokens[1]]=tokens[2];});function locationEvalError(e){return(e.lineNumber?(' at line '+e.lineNumber+
(e.columnNumber?(' column '+e.columnNumber):'')):'')}
if(typeof setImmediate=='undefined'){function setImmediate(callback){return setTimeout(callback,0)};}
DIR.North=function(ip){return{tag:DIR.NORTH,ip:ip}}
DIR.South=function(ip){return{tag:DIR.SOUTH,ip:ip}}
DIR.West=function(ip){return{tag:DIR.WEST,ip:ip}}
DIR.East=function(ip){return{tag:DIR.EAST,ip:ip}}
DIR.Up=function(ip){return{tag:DIR.UP,ip:ip}}
DIR.Down=function(ip){return{tag:DIR.DOWN,ip:ip}}
var jam=function(options){var self=this,p,conn,node;this.options=options||{};this.environment=environment;if(this.setup)this.setup();if(this.options.world&&!this.options.id)this.options.id=this.options.world;if(!this.options.id)this.options.id=Aios.aidgen();if(!this.options.log)this.options.log={};if(!this.options.logJam)this.options.logJam={pid:false,host:false,time:false};this.verbose=this.options.verbose||0;this.Aios=Aios;this.DIR=Aios.aios.DIR;Aios.options.verbose=this.verbose;if(options.scheduler)Aios.current.scheduler=scheduler;if(options.nolimits||options.nowatch||options.checkpoint)
Aios.config({nolimits:options.nolimits,nowatch:options.nowatch,checkpoint:options.checkpoint});if(this.options.print)Aios.print=Aios.printAgent=this.options.print;if(this.options.print2)Aios.printAgent=this.options.print2;if(this.options.printAgent)Aios.printAgent=this.options.printAgent;if(this.options.printAsync)Aios.printAsync=this.options.printAsync;this.log=function(msg){var s='[JAM',sep=' ';if(self.options.logJam.pid&&process)s+=(' '+process.pid),sep=':';if(self.options.logJam.world&&Aios.current.world)s+=(sep+Aios.current.world.id),sep=':';if(self.options.logJam.node&&Aios.current.node)s+=(sep+Aios.current.node.id),sep=':';if(self.options.logJam.time)s+=(sep+Aios.time());Aios.print(s+'] '+msg);};this.err=function(msg,err){self.log('Error: '+msg);throw(err||'JAMLIB');}
this.warn=function(msg){self.log('Warning: '+msg);}
this.error=undefined;this.world=Aios.World.World([],{id:this.options.world||this.options.id.toUpperCase(),classes:options.classes||[],scheduler:options.scheduler,verbose:options.verbose});if(this.verbose)this.log('Created world '+this.world.id+'.');this.node=none;this.run=false;this.ticks=0;this.steps=0;this.loop=none;this.looping=none;Aios.config({fastcopy:this.options.fastcopy,verbose:this.options.verbose});if(this.options.log)
for(p in this.options.log)Aios.config(this.options.log[p]?{"log+":p}:{"log-":p});this.process=Aios.Proc.Proc();this.process.agent={id:'jamlib'};this.events={};}
var JamAnal=Require('jam/analyzer');JamAnal.current(Aios);jam.prototype.analyzeSyntax=JamAnal.jamc.prototype.analyze;jam.prototype.syntax=JamAnal.jamc.prototype.syntax;jam.prototype.addClass=function(name,constructor,env){this.world.addClass(name,constructor,env);if(this.verbose)this.log('Agent class '+name+' added to world library.');};jam.prototype.addNode=function(nodeDesc){var node,x,y;x=nodeDesc.x;y=nodeDesc.y;if(Comp.array.find(this.world.nodes,function(node){return node.position.x==x&&node.position.y==y;})){this.err('addNodes: Node at positition ('+x+','+y+') exists already.');return;}
node=Aios.Node.Node({id:nodeDesc.id||Aios.aidgen(),position:{x:x,y:y}},true);if(this.verbose)this.log('Created node '+node.id+' ('+x+','+y+').');this.world.addNode(node);return node.id;}
jam.prototype.addNodes=function(nodes){var n,node,x,y,nodeids=[];for(n in nodes){nodeids.push(this.addNode(nodes[n]));}
return nodeids;}
jam.prototype.analyze=function(ac,options){var source,name,syntax,content,report,interface;if(Comp.obj.isString(ac)){}else if(Comp.obj.isObject(ac)){}else if(Comp.obj.isFunction(ac)){source=ac.toString();if(!options.classname){name=source.match(/^ *function *([^\s\(]*)\(/);if(name&&name[1]!='')options.classname=name[1];}
content='var ac ='+source;syntax=Esprima.parse(content,{tolerant:true,loc:true});try{interface=this.analyzeSyntax(syntax,{classname:options.classname||'anonymous',level:options.level==undefined?2:options.level,verbose:options.verbose,err:function(msg){throw msg},out:function(msg){if(!report)report=msg;else report=report+'\n'+msg;},warn:function(msg){if(!report)report=msg;else report=report+'\n'+msg;}});return{report:report||'OK',interface:interface};}catch(e){return{report:e,interface:interface};}}}
jam.prototype.clock=Aios.clock;jam.prototype.compileClass=function(name,constructor,options){var ac,p,verbose,content,syntax,report,text,env={ac:undefined},self=this,ac;if(typeof name=='function')constructor=name,name=undefined,options=constructor;if(typeof options=='object')verbose=options.verbose||0;else if(options!=undefined)verbose=options;else verbose=this.verbose;if(typeof constructor=='function')text=constructor.toString();else text=constructor;if(!name){name=text.match(/[\s]*function[\s]*([A-Za-z0-9_]+)[\s]*\(/);if(!name)throw('compileClass: No class name provided and no name found in constructor '+
text.substring(0,80));name=name[1];}
content='var ac = '+text;try{syntax=Esprima.parse(content,{tolerant:true,loc:true})}
catch(e){throw'compileClass('+name+'): Parsing failed with '+e}
report=this.analyzeSyntax(syntax,{classname:name,level:2,verbose:verbose||0,err:function(msg){self.log(msg)},out:function(msg){self.log(msg)},warn:function(msg){self.log(msg)}});if(report.errors.length){throw'compileClass('+name+'): failed with '+report.errors.join('; ')};for(p in report.activities)env[p]=p;try{with(env){eval(content)}}
catch(e){throw('compileClass('+name+'): failed with '+e+locationEvalError(e))};ac=env.ac;env.ac=undefined;this.addClass(name,ac,env);return name;}
jam.prototype.connectNodes=function(connections){var c,node1,node2,x1,y1,x2,y2,dir;if(connections[0].x!=undefined&&connections[0].y!=undefined){if(connections.length!=2)throw'INVALID';connections=[{x1:connections[0].x,x2:connections[1].x,y1:connections[0].y,y2:connections[1].y}];}
for(c in connections){x1=connections[c].x1;y1=connections[c].y1;x2=connections[c].x2;y2=connections[c].y2;if(this.verbose)this.log('Connecting ('+x1+','+y1+') -> ('+x2+','+y2+')');node1=Comp.array.find(this.world.nodes,function(node){return node.position.x==x1&&node.position.y==y1;});node2=Comp.array.find(this.world.nodes,function(node){return node.position.x==x2&&node.position.y==y2;});if(!node1)this.err('connectNodes: Node at positition ('+x1+','+y1+') does not exist.');if(!node2)this.err('connectNodes: Node at positition ('+x2+','+y2+') does not exist.');if((x2-x1)==0){if((y2-y1)>0)dir=Aios.DIR.SOUTH;else dir=Aios.DIR.NORTH;}else if((x2-x1)>0)dir=Aios.DIR.EAST;else dir=Aios.DIR.WEST;this.world.connect(dir,node1,node2);this.world.connect(Aios.DIR.opposite(dir),node2,node1);}}
jam.prototype.connectTo=function(to,nodeid){var node=this.getNode(nodeid),tokens=(typeof to=='string')?to.split('->'):null,dir;if(!node)return;if(to.tag)dir=to;else if(tokens.length==2){dir=Aios.DIR.from(tokens[0]);if(dir)dir.ip=tokens[1];}else dir={tag:'DIR.IP',ip:to};if(dir)this.world.connectTo(dir,node);}
jam.prototype.connected=function(dir,nodeid){var node=this.getNode(nodeid);if(!node)return;return this.world.connected(dir,node);}
jam.prototype.createAgent=function(ac,args,level,className,parent){var node=this.world.nodes[this.node],process=none,sac;if(level==undefined)level=Aios.options.LEVEL;if(!className&&typeof ac=='string')className=ac;if(!className&&typeof ac=='function')className=Aios.Code.className(ac);if(Comp.obj.isFunction(ac)||Comp.obj.isObject(ac)){process=Aios.Code.createOn(node,ac,args,level,className);if(process&&!process.agent.parent)process.agent.parent=parent;if(process)return process.agent.id;}else{if(this.world.classes[ac])
process=Aios.Code.createOn(node,this.world.classes[ac][level],args,level,className);else{this.error='createAgent: Cannot find agent class '+ac;this.log(this.error);return;}
if(process){if(!process.agent.parent)process.agent.parent=parent;process.agent.ac=ac;return process.agent.id;}else return none;}}
jam.prototype.createAgentOn=function(node,ac,args,level,className,parent){var res,_currentNode=this.node,found=this.getNode(node);if(found){this.setCurrentNode();res=this.createAgent(ac,args,level,className,parent);this.setCurrentNode(_currentNode);}
return res;}
jam.prototype.createPort=function(dir,options,nodeid){if(!options)options={};var multicast=options.multicast;switch(dir.tag){case Aios.DIR.NORTH:case Aios.DIR.SOUTH:case Aios.DIR.WEST:case Aios.DIR.EAST:case Aios.DIR.UP:case Aios.DIR.DOWN:multicast=false;break;}
if(dir.ip&&typeof dir.ip=='string'&&dir.ip.indexOf('//')>0){var addr=Aios.Amp.url2addr(dir.ip);if(!options.proto&&addr.proto)options.proto=addr.proto;dir.ip=Aios.Amp.addr2url(addr);}
if(options.from==undefined&&dir.ip)options.from=dir.ip.toString();var chan=this.world.connectPhy(dir,this.getNode(nodeid),{broker:options.broker,multicast:multicast,name:options.name,on:options.on,oneway:options.oneway,proto:options.proto||'udp',rcv:options.from,secure:options.secure,pem:options.pem,snd:options.to,verbose:(options.verbose!=undefined?options.verbose:this.verbose)});chan.init();chan.start();return chan;}
jam.prototype.disconnect=function(to,nodeid){var node=this.getNode(nodeid);if(node){this.world.disconnect(to,node);}}
jam.prototype.emit=function(){Aios.emit.apply(this,arguments);}
jam.prototype.execute=function(data,file){if(!data&&file&&fs)
try{data=fs.readFileSync(file,'utf8');}catch(e){this.log('Error: Reading file '+file+' failed: '+e);return undefined;}
if(data)return this.world.nodes[this.node].receive(data,true);}
jam.prototype.executeOn=function(data,node,file){node=this.getNode(node);if(!node)return;if(!data&&file&&fs)
try{data=fs.readFileSync(file,'utf8');}catch(e){this.log('Error: Reading file '+file+' failed: '+e);return undefined;}
if(data)return node.receive(data,true);}
jam.prototype.extend=function(level,name,funcOrObj,argn){var self=this;if(Comp.obj.isArray(level)){Comp.array.iter(level,function(l){self.extend(l,name,funcOrObj,argn)});return;}
function range(n){var l=[];for(var i=0;i<n+1;i++)l.push(i);return l;}
switch(level){case 0:if(Aios.aios0[name])throw Error('JAM: Cannot extend AIOS(0) with '+name+', existst already!');Aios.aios0[name]=funcOrObj;break;case 1:if(Aios.aios1[name])throw Error('JAM: Cannot extend AIOS(1) with '+name+', existst already!');Aios.aios1[name]=funcOrObj;break;case 2:if(Aios.aios2[name])throw Error('JAM: Cannot extend AIOS(2) with '+name+', existst already!');Aios.aios2[name]=funcOrObj;break;case 3:if(Aios.aios3[name])throw Error('JAM: Cannot extend AIOS(3) with '+name+', existst already!');Aios.aios3[name]=funcOrObj;break;default:throw Error('JAM: Extend: Invalid privilige level argument ([0,1,2,3])');}
if(!JamAnal.corefuncs[name]){if(typeof funcOrObj=='function')
JamAnal.corefuncs[name]={argn:Comp.obj.isArray(argn)?argn:argn!=undefined?range(argn):range(funcOrObj.length)};else{var obj={};Object.keys(funcOrObj).forEach(function(attr){obj[attr]={argn:range(funcOrObj[attr].length)};});JamAnal.corefuncs[name]={obj:obj};}}}
jam.prototype.getCurrentNode=function(asname){if(!asname)return this.node;else return this.world.nodes[this.node].id;}
jam.prototype.getNode=function(id){var node;if(id==undefined)return this.world.nodes[this.node];if(typeof id=='number')
node=this.world.nodes[id];else if(typeof id=='string'){loop:for(var i in this.world.nodes){if(this.world.nodes[i]&&this.world.nodes[i].id==id){node=this.world.nodes[i];break loop;}}}else if(id.x!=undefined&&id.y!=undefined){loop:for(var i in this.world.nodes){if(this.world.nodes[i]&&Comp.obj.equal(this.world.nodes[i].position,id)){node=this.world.nodes[i];break loop;}}}
return node;}
jam.prototype.getNodeName=function(nodeNumberorPosition){var node=this.getNode(nodeNumberorPosition);if(node)return node.id;}
jam.prototype.getProcess=function(agent){if(!agent)
return Aios.current.process;else{var node=this.getNode();if(node)return node.getAgentProcess(agent);}}
jam.prototype.getWorldName=function(){return this.world.id;}
jam.prototype.info=function(kind,id){switch(kind){case'node':var node=this.getNode(id);if(!node)return;return{id:node.id,position:node.position,location:node.location,type:node.type}
break;case'agent':var agent=this.getProcess(id);if(!agent)return;var code=Aios.Code.print(agent.agent,true);return{id:id,pid:agent.pid,level:agent.level,blocked:agent.blocked,suspended:agent.suspended,resources:agent.resources,code:code}
break;case'agent-data':var agent=this.getProcess(id);if(!agent)return;else return agent.agent;break;case'version':return Aios.options.version;case'host':return{type:global.TARGET,watchdog:Aios.watchdog?true:false,protect:Aios.watchdog&&Aios.watchdog.protect?true:false,jsonify:Aios.options.json,minify:!Aios.Code.options.compactit,};case'platform':return platform;}}
jam.prototype.init=function(callback){var i=0,j=0,n,p,id,node,connect=[],chan,dir,dirs,pos,self=this;this.node=0;if(!this.options.network){if(this.options.position)i=this.options.position.x,j=this.options.position.y;if(!this.getNode({x:i,y:j})){node=Aios.Node.Node({id:this.options.id,position:{x:i,y:j},TMO:this.options.TMO,type:this.options.type},true);if(this.verbose)this.log('Created '+(i==0&&j==0?'root ':'')+'node '+node.id+' ('+i+','+j+').');this.world.addNode(node);}
this.register(node);}else if(!this.options.network.cluster){if(this.options.network.rows&&this.options.network.columns){for(j=0;j<this.options.network.rows;j++)
for(i=0;i<this.options.network.columns;i++){node=Aios.Node.Node({id:Aios.aidgen(),position:{x:i,y:j},TMO:this.options.TMO},true);if(this.verbose)this.log('Created node '+node.id+' at ('+i+','+j+').');if(i==0&&j==0){this.register(node);}
this.world.addNode(node);}
for(j=0;j<this.options.network.rows;j++)
for(i=0;i<this.options.network.columns;i++){if(i+1<this.options.network.columns)connect.push({x1:i,y1:j,x2:i+1,y2:j});if(j+1<this.options.network.rows)connect.push({x1:i,y1:j,x2:i,y2:j+1});}
if(this.options.network.connect)connect=connect.filter(this.options.network.connect);this.connectNodes(connect);}}else if(this.options.network.cluster&&this.options.fork){dirs=[DIR.ORIGIN,DIR.EAST,DIR.SOUTH,DIR.SE,DIR.WEST,DIR.SW,DIR.NORTH,DIR.NW,DIR.NE];pos={x:[0,1,0,1,-1,-1,0,-1,1],y:[0,0,1,1,0,1,-1,-1,-1]};this.cluster=[];this.master=true;for(j=0;j<this.options.network.rows;j++)
for(i=0;i<this.options.network.columns;i++){id=Aios.aidgen();if(i==0&&j==0){dir=undefined;node=Aios.Node.Node({id:id,position:{x:i,y:j},TMO:this.options.TMO},true);if(this.verbose)this.log('Created root node '+node.id+' at ('+i+','+j+').');this.register(node);this.world.addNode(node);this.setCurrentNode(id);}else{n=i+j*this.options.network.columns;dir=dirs[n];if(this.verbose)this.log('Started cluster node '+id+' at ('+i+','+j+'). with link '+DIR.print(dir));this.cluster[id]=this.options.fork(process.argv[1],['autosetup:'+JSON.stringify({id:id,world:this.world.id,cluster:true,network:null,position:{x:pos.x[n],y:pos.y[n]},dir:dir,connections:{stream:{dir:DIR.opposite(dir)}}})]);this.cluster[id].dir=dir;}}
for(p in this.cluster){chan=this.world.connectPhy(this.cluster[p].dir,this.getNode(),{proto:'stream',sock:this.cluster[p],mode:'object',verbose:this.verbose});chan.init();}}
if(this.options.provider)this.world.nodes[this.node].ts.register(function(pat){return self.options.provider(pat);});if(this.options.consumer)this.world.nodes[this.node].ts.register(function(tuple){return self.options.consumer(tuple);},true);if(this.options.connections){for(p in this.options.connections){conn=this.options.connections[p];if(!conn)continue;if(p=='ip'||conn.proto){n=1;switch(p){case'ip':dir=this.DIR.IP(this.options.connections.ip.from||'*');n=(conn.range&&conn.range.length==2&&(conn.range[1]-conn.range[0]+1))||conn.num||1;break;case'north':dir=this.DIR.NORTH;break;case'south':dir=this.DIR.SOUTH;break;case'west':dir=this.DIR.WEST;break;case'east':dir=this.DIR.EAST;break;case'up':dir=this.DIR.UP;break;case'down':dir=this.DIR.DOWN;break;}
function makeAddr(ip,i){if(!conn.range)return ip;else return ip+':'+(conn.range[0]+i);}
for(i=0;i<n;i++){chan=this.world.connectPhy(dir,this.getNode(),{broker:conn.broker,multicast:conn.multicast,name:conn.name,on:conn.on,oneway:conn.oneway,proto:conn.proto||'udp',rcv:makeAddr(conn.from,i),snd:conn.to,verbose:this.verbose});chan.init();}}else if(conn.send){node=this.world.nodes[this.node];function makeconn(p,conn){var link={_handler:[],emit:function(event,msg){if(link._handler[event])link._handler[event](msg);},on:function(event,callback){link._handler[event]=callback;},send:function(data,dest,context){var res;self.world.nodes[self.node].connections[p]._count+=data.length;res=conn.send(data,dest);if(!res){context.error='Migration to destination '+dest+' failed';throw'MOVE';};context.process.finalize();},status:conn.status?conn.status:(function(){return true}),count:conn.count?conn.count:function(){return link._count},_count:0};if(conn.register)conn.register(link);return link;}
node.connections[p]=makeconn(p,conn);node.connections[p].on('agent',node.receive.bind(node));node.connections[p].on('signal',node.handle.bind(node));}else if(p=='stream'){chan=this.world.connectPhy(conn.dir,this.getNode(),{proto:'stream',sock:process,mode:'object',verbose:this.verbose});chan.init();}}}
if(callback)callback();}
jam.prototype.inp=function(pat,all){return this.world.nodes[this.node].ts.extern.inp(pat,all);}
jam.prototype.kill=function(id,node){if(id=='*'){this.world.nodes[this.node].processes.table.forEach(function(p){if(p)Aios.kill(p.agent.id);});}else
return Aios.kill(id);}
jam.prototype.locate=function(nodeid,cb,options){if(typeof nodeid=='function')options=cb,cb=nodeid,nodeid=0;var node=this.getNode(nodeid);if(!node)return;return GeoLoc5.locate(function(location,errors){node.location=node.location||{};Object.assign(node.location,location);if(cb)cb(location,errors);});}
jam.prototype.lookup=function(dir,callback,nodeid){var node=this.getNode(nodeid);if(!node)return;return this.world.lookup(dir,callback,node);}
jam.prototype.mark=function(tuple,tmo){return this.world.nodes[this.node].ts.extern.mark(tuple,tmo);}
jam.prototype.migrate=function(data){return this.world.nodes[this.node].receive(data,false);}
jam.prototype.on=function(event,handler){Aios.on(event,handler);}
jam.prototype.off=function(ev){Aios.off(event);}
jam.prototype.open=function(file,options){var self=this,res,text,name,ast=null;if(!options)options={};name=options.classname||'<unknown>';if(options.verbose>0)this.log('Reading agent class template '+name+' from '+file);function parseModel(text){var modu={},more,module={exports:{}},name=text.match(/[\s]*function[\s]*([a-z0-9]+)[\s]*\(/);if(name)name=name[1];function open(filename){var text;try{text=fs?fs.readFileSync(filename,'utf8'):null;return parseModel(text);}catch(e){self.log('Error: Opening of '+(fs?file:'text')+' failed: '+e);}}
try{with(module){eval('res = '+text)};if(name){modu[name]=res;return modu}
else if(module.exports)return module.exports;else return res;}catch(e){try{ast=Esprima.parse(text,{tolerant:true,loc:true});if(ast.errors&&ast.errors.length>0)more=', '+ast.errors[0];}catch(e){if(e.lineNumber)more=', in line '+e.lineNumber;}
self.log(e.name+(e.message?': '+e.message:'')+(more?more:''));}}
try{text=fs?fs.readFileSync(file,'utf8'):file;return parseModel(text);}catch(e){this.log('Error: Opening of '+(fs?file:'text')+' failed: '+e);}};jam.prototype.out=function(tuple){return this.world.nodes[this.node].ts.extern.out(tuple);}
jam.prototype.rd=function(pat,all){return this.world.nodes[this.node].ts.extern.rd(pat,all);}
if(fs)jam.prototype.readClass=function(file,options){var self=this,ac,name,env,interface,text,modu,path,p,m,regex1,ast=null,fileText=null,off=null;this.error=_;function errLoc(ast){var err;if(ast&&ast.errors&&ast.errors.length){err=ast.errors[0];if(err.lineNumber!=undefined)return'line '+err.lineNumber;}
return'unknown'}
try{if(!options)options={};if(options.verbose>0)this.log('Looking up agent class template(s) from '+file);if(Comp.obj.isEmpty(modu)){if(options.verbose>0)this.log('Reading agent class template(s) from file '+file);if(Comp.string.get(file,0)!='/')
path=(process.cwd?process.cwd()+'/':'./')+file;else
path=file;fileText=fs.readFileSync(path,'utf8');ast=Esprima.parse(fileText,{tolerant:true,loc:true});if(require.cache)delete require.cache[file];modu=require(path);if(Comp.obj.isEmpty(modu)){modu={};if(!fileText)throw'No such file!';name=fileText.match(/[\s]*function[\s]*([a-z0-9]+)[\s]*\(/);if(!name)throw('Export interface of module is empty and file contains no valid function definition!');name=name[1];eval('(function () {'+fileText+' modu["'+name+'"]='+name+'})()');}}
if(!modu||Comp.obj.isEmpty(modu))throw'Empty module.';for(m in modu){ac=modu[m];env={};if(fileText)off=this.syntax.find(fileText,'VariableDeclarator',m);if(off&&off.loc)this.syntax.offset=off.loc.start.line-1;content='var ac = '+ac;syntax=Esprima.parse(content,{tolerant:true,loc:true});interface=this.analyzeSyntax(syntax,{classname:m,level:2,verbose:options.verbose||0,err:options.error||function(msg){throw(msg)},out:function(msg){self.log(msg)},warn:function(msg){self.log(msg)}});for(var p in interface.activities)env[p]=p;with(env){eval(content)};if(options.verbose>0)this.log('Adding agent class constructor '+m+' ('+(typeof ac)+').');this.addClass(m,ac,env);this.syntax.offset=0;}
this.error=undefined;return true;}catch(e){this.error='Compiling agent class file "'+file+'" failed: '+e+
(ast&&ast.errors.length?', in '+errLoc(ast):'');if(options.error)
options.error(e+(ast&&ast.errors.length?', in '+errLoc(ast):''));else{this.log(this.error);}
return false;}};jam.prototype.register=function(node){this.on('agent',function(msg){node.receive(msg)});this.on('signal',function(msg){node.handle(msg)});}
jam.prototype.removeNode=function(nodeid){this.world.removeNode(nodeid);}
jam.prototype.rm=function(pat,all){return this.world.nodes[this.node].ts.extern.rm(pat,all);}
jam.prototype.saveSnapshotOn=function(aid,node,file,kill){var snapshot,pro;node=this.getNode(node);if(!node)return;pro=node.getAgentProcess(aid);if(!pro)return;snapshot=Aios.Code.ofCode(pro,false);if(kill)Aios.killOn(aid,node);if(!file)return snapshot;else if(fs)return fs.writeFileSync(file,snapshot,'utf8');}
jam.prototype.saveSnapshot=function(aid,file,kill){return this.saveSnapshotOn(aid,_,file,kill);}
jam.prototype.schedule=function(){if(this.loop){clearTimeout(this.loop);setImmediate(this.looping);}else if(!this.run)setImmediate(this.looping);}
jam.prototype.security=Aios.Sec;jam.prototype.setCurrentNode=function(n){if(typeof n=='number'){if(n>=0&&n<this.world.nodes.length)this.node=n;}else if(typeof n=='string'){this.node=this.world.nodes.indexOf(this.world.getNode(n))}
current.node=this.world.nodes[this.node];}
jam.prototype.signal=function(to,sig,arg,broadcast){var node=this.getNode(),_process=Aios.current.process;Aios.current.process=this.process;if(!broadcast)
Aios.aios.send(to,sig,arg);else
Aios.aios.broadcast(to,sig,arg);Aios.current.process=_process;this.schedule();}
jam.prototype.start0=function(callback){if(this.run)return;var self=this,cbl=CBL(callback);this.world.nodes.forEach(function(node){node.connections.forEach(function(chan,kind){if(!chan)return;if(chan.start)cbl.push(function(next){chan.start(next)});});});cbl.start();Aios.on('schedule',function(){self.schedule();});this.world.start();if(this.verbose)this.log('Starting JAM .. ');return;}
jam.prototype.start=function(callback){if(this.run)return;var self=this,current=Aios.current,cbl=CBL(callback);this.world.nodes.forEach(function(node){node.connections.forEach(function(chan,kind){if(!chan)return;if(chan.start)cbl.push(function(next){chan.start(next)});});});cbl.start();Aios.on('schedule',function(){self.schedule();});function loop(){var loop=function(){var nexttime,curtime;if(self.verbose>3)self.log('loop: Entering scheduler #'+self.ticks);self.ticks++;nexttime=Aios.scheduler();curtime=Aios.time();if(self.verbose>3)self.log('loop: Scheduler returned nexttime='+nexttime+' ('+(nexttime>0?nexttime-curtime:0)+')');if(!self.run)return;if(nexttime>0)
self.loop=setTimeout(loop,nexttime-curtime);else if(nexttime==0)
self.loop=setTimeout(loop,1000);else setImmediate(loop);};self.loop=setTimeout(loop,1);};this.looping=loop;Aios.config({iterations:100});this.run=true;this.world.start();if(this.verbose)this.log('Starting JAM loop .. ');if(!this.options.scheduler)loop();}
jam.prototype.stats=function(kind,id){var p,n,sys,conn,pro,agent,state,stats,allstats={},signals,node;switch(kind){case'process':case'agent':for(n in this.world.nodes){stats={};node=this.world.nodes[n];for(p in node.processes.table){if(node.processes.table[p]){pro=node.processes.table[p];if(pro.signals.length==0)signals=[];else signals=pro.signals.map(function(sig){return sig[0]});agent=pro.agent;if(pro.suspended)state='SUSPENDED';else if(pro.blocked)state='BLOCKED';else if(pro.dead)state='DEAD';else if(pro.kill)state='KILL';else if(pro.move)state='MOVE';else state='READY';stats[agent.id]={pid:pro.pid,gid:pro.gid,state:state,parent:pro.agent.parent,class:pro.agent.ac,next:agent.next,resources:Comp.obj.copy(pro.resources)};if(signals.length)stats[agent.id].signals=signals;}}
allstats[node.id]=stats;}
break;case'node':return Comp.obj.copy(this.getNode(id).stats);break;case'conn':for(n in this.world.nodes){stats={};node=this.world.nodes[n];for(p in node.connections){conn=node.connections[p];if(conn){stats[p]={count:conn.count(),conn:conn.status('%')};}}
allstats[node.id]=stats;}
break;case'vm':if(process&&process.memoryUsage){sys=process.memoryUsage();for(p in sys)sys[p]=(sys[p]/1024)|0;sys.v8=process.versions&&process.versions.v8;sys.node=process.versions&&process.versions.node;sys.arch=process.arch;sys.platform=process.platform;sys.watchdog=Aios.watchdog?(Aios.watchdog.checkPoint?'semi':'full'):'none';return sys;}
break;}
if(this.world.nodes.length==1)return stats;else return allstats;}
jam.prototype.step=function(steps,callback){var self=this,sync=callback===true,milliTime=function(){return Math.ceil(Date.now())},current=Aios.current,curtime=Aios.time(),lasttime=curtime;function loop(){var loop=function(){var nexttime,curtime;if(self.verbose>1)self.log('loop: Entering scheduler #'+self.ticks);self.ticks++,self.steps--;self.time=curtime=Aios.time();nexttime=Aios.scheduler();curtime=Aios.time();if(self.verbose>3)self.log('loop: Scheduler returned nexttime='+nexttime+' ('+(nexttime>0?nexttime-curtime:0)+')');if(sync){self.time=curtime;return;}
if(self.steps==0||!self.run){self.loop=none;self.run=false;self.time=curtime;if(callback)callback();return;}
if(nexttime>0)
self.loop=setTimeout(loop,nexttime-curtime);else if(nexttime<0)self.loop=setImmediate(loop);else{self.loop=none;self.run=false;self.time=curtime;if(callback)callback();}};if(sync)loop();else self.loop=setTimeout(loop,1);};this.looping=loop;Aios.config({iterations:1});this.steps=steps;this.run=true;if(this.time>0)current.world.lag=current.world.lag+(curtime-this.time);this.time=curtime;if(!this.options.scheduler){if(sync){this.run=true;for(var step=0;step<steps;step++)loop();this.run=false;}else
loop();}}
jam.prototype.stop=function(callback){if(!this.run)return;this.run=false,cbl=CBL(callback);this.log('Stopping JAM ..');Aios.off('schedule');if(this.loop)
clearTimeout(this.loop);this.world.nodes.forEach(function(node){node.connections.forEach(function(chan,kind){if(!chan)return;if(chan.stop)cbl.push(function(next){chan.stop(next)});});});cbl.start();}
jam.prototype.test=function(pat){return this.world.nodes[this.node].ts.extern.exists(pat);}
jam.prototype.ts=function(pat,callback){return this.world.nodes[this.node].ts.extern.ts(pat,callback);}
jam.prototype.time=function(){return Aios.time();}
jam.prototype.version=function(){return options.version;}
var Jam=function(options){var obj=new jam(options);return obj;};if(environment.autosetup){try{var _options=JSON.parse(environment.autosetup);jam.prototype.setup=function(){for(var p in _options)this.options[p]=_options[p];}}catch(e){console.log('['+process.pid+'] JAM auto setup failed: '+e);}}
module.exports={Aios:Aios,Comp:Comp,Esprima:Esprima,Io:Io,Jam:Jam,Json:Json,environment:environment,options:options}};BundleModuleCode['jam/aios']=function(module,exports){var Io=Require('com/io');var Comp=Require('com/compat');var Name=Require('com/pwgen');var Conf=Require('jam/conf');var Code=Require('jam/code');var Sig=Require('jam/sig');var Node=Require('jam/node');var Proc=Require('jam/proc');var Sec=Require('jam/security');var Ts=Require('jam/ts');var World=Require('jam/world');var Chan=Require('jam/chan');var Mobi=Require('jam/mobi');var Simu=global.config.simulation?Require(global.config.simulation):none;var Json=Require('jam/jsonfn');var watchdog=Require('jam/watchdog');var util=Require('util');var Amp=Require('jam/amp')
var aiosExceptions=['CREATE','MOVE','SIGNAL','SCHEDULE','WATCHDOG','KILL'];var aiosErrors=['SCHEDULE','CPU','EOL','EOM','EOT','EOA','EOR',];var aiosEvents=['agent','agent+','agent-','signal','signal+','node+','node-'];var options={version:"1.64.1",debug:{},fastcopy:false,json:false,log:{node:false,agent:true,parent:false,pid:false,host:false,time:false,Time:true,date:false,class:false},nameopts:{length:8,memorable:true,lowercase:true},nolimits:false,nostats:false,useproc:false,verbose:0,LIFETIME:Infinity,TIMESCHED:200,TIMEPOOL:5000,MEMPOOL:50000,TSPOOL:1000,TSTMO:0,AGENTPOOL:20,MINCOST:0.1,RUNTIME:1000,AGENTSIZE:60000,AGENTSIZEMAX:256000,IDLETIME:0,LEVEL:1,security:{}};var timer,ticks=0,iterations=0,events={};var current={process:none,world:none,node:none,network:none,error:none,scheduler:none};function clock(what){if(what==undefined)return Io.Time();else if(what=='date')return Io.Date();else return Io.time();}
function format(msg,cls){switch(cls){case'aios':return('['+(options.log.host?('#'+process.pid+'.'):'')+
(options.log.world&&current.world?(current.world.id+'.'):'')+
(options.log.node&&current.node?(current.node.id+'.'):'')+
(options.log.pid&&current.process?('('+current.process.pid+')'):'')+
(options.log.date?('@'+Io.date()):(options.log.time?('@'+Io.time()):(options.log.Time?('@'+Io.Time()):'')))+'] '+msg);case'agent':return('['+(options.log.host?('#'+process.pid+'.'):'')+
(options.log.world&&current.world?(current.world.id+'.'):'')+
(options.log.node&&current.node?(current.node.id+'.'):'')+
(options.log.class&&current.process?(current.process.agent.ac+'.'):'')+
(options.log.agent&&current.process?(current.process.agent.id):'')+
(options.log.parent&&current.process?('<'+current.process.agent.parent):'')+
(options.log.pid&&current.process?('('+current.process.pid+')'):'')+
(options.log.date?('@'+Io.date()):(options.log.time?('@'+Io.time()):(options.log.Time?('@'+Io.Time()):'')))+'] '+msg);default:return('['+
(options.log.date?('@'+Io.date()):(options.log.time?('@'+Io.time()):(options.log.Time?('@'+Io.Time()):'')))+'] '+msg)}}
var logAgent=function(){var msg='';arguments.forEach(function(arg,i){if(typeof arg=='string'||typeof arg==Number)msg+=(i>0?', '+arg:arg);else msg+=(i>0?' '+Io.inspect(arg):Io.inspect(arg));});(Aios.printAgent||Aios.print)(format(msg,'agent'))}
var logAIOS=function(){var msg='';arguments.forEach(function(arg,i){if(typeof arg=='string'||typeof arg==Number)msg+=(i>0?', '+arg:arg);else msg+=(i>0?' '+Io.inspect(arg):Io.inspect(arg));});if(current.process)(Aios.printAgent||Aios.print)(format(msg,'aios'));else(Aios.printAgent||Aios.print)(format(msg));}
var logAIOSasync=function(){var msg='';arguments.forEach(function(arg,i){if(typeof arg=='string'||typeof arg==Number)msg+=(i>0?', '+arg:arg);else msg+=(i>0?' '+Io.inspect(arg):Io.inspect(arg));});if(current.process)(Aios.printAsync||Aios.print)(Aios.printAgent||Aios.print)(format(msg,'aios'));else(Aios.printAsync||Aios.print)(format(msg));}
var log=function(){var msg='',pref='';arguments.forEach(function(arg,i){if(typeof arg=='string'||typeof arg==Number)msg+=(i>0?', '+arg:arg);else msg+=(i>0?', '+Io.inspect(arg):Io.inspect(arg));});if(options.log.host&&typeof process!='undefined')pref='#'+process.pid+': ';if(options.log.date)pref=pref+Io.date()+' ';else if(options.log.time)pref=pref+Io.time()+' ';else if(options.log.Time)pref=pref+Io.Time()+' ';if(msg[0]=='[')Aios.print(pref+msg);else Aios.print('[AIOS'+pref+'] '+msg);}
var logAsync=function(){var msg='',pref='';arguments.forEach(function(arg,i){if(typeof arg=='string'||typeof arg==Number)msg+=(i>0?', '+arg:arg);else msg+=(i>0?', '+Io.inspect(arg):Io.inspect(arg));});if(options.log.host&&typeof process!='undefined')pref='#'+process.pid+': ';if(options.log.date)pref=pref+Io.date()+' ';else if(options.log.time)pref=pref+Io.time()+' ';else if(options.log.Time)pref=pref+Io.Time()+' ';if(msg[0]=='[')(Aios.printAsync||Aios.print)(pref+msg);else(Aios.printAsync||Aios.print)('[AIOS'+pref+'] '+msg);}
var eval0=eval;var aios0={abs:Math.abs,add:function(a,b){var res,i;if(Comp.obj.isNumber(a)&&Comp.obj.isNumber(b))return a+b;if(Comp.obj.isArray(a)&&Comp.obj.isArray(b)){if(a.length!=b.length)return none;res=Comp.array.copy(a);for(i in a){res[i]=aios0.add(a[i],b[i]);}
return res;}
if(Comp.obj.isArray(a)&&Comp.obj.isFunction(b)){res=Comp.array.copy(a);for(i in a){res[i]=aios0.add(a[i],b.call(current.process.agent,a[i]));}
return res;}
if(Comp.obj.isObj(a)&&Comp.obj.isObj(b)){res={};for(i in a){res[i]=aios0.add(a[i],b[i]);}
return res;}
return none;},angle:function(p1,p2){var angle,v1,v2;if(Comp.obj.isArray(p1))v1=p1;else if(Comp.obj.isObj(p1))v1=[p1.x,p1.y];if(Comp.obj.isArray(p2))v2=p2;else if(Comp.obj.isObj(p2))v2=[p2.x,p2.y];if(p2==undefined){v2=v1;v1=[0,0]};angle=Math.atan2(v2[1]-v1[1],v2[0]-v1[0]);return 180*angle/Math.PI;},array:function(cols,init){if(init==undefined)init=0;var row=[];for(var j=0;j<cols;j++)row.push(typeof init=='function'?init(j):init);return row;},assign:function(src,dst){for(var p in src)dst[p]=src[p]
return dst;},Capability:Sec.Capability,clock:clock,concat:function(a,b,unique){var res,i;if(Comp.obj.isArray(a)&&Comp.obj.isArray(b)){if(!unique)return a.concat(b);res=a.slice();for(var i in b){if(res.indexOf(b[i])==-1)res.push(b[i]);}
return res;}else if(Comp.obj.isObj(a)&&Comp.obj.isObj(b)){res={};for(i in a){res[i]=a[i];}
for(i in b){res[i]=b[i];}
return res;}else if(Comp.obj.isString(a)&&Comp.obj.isString(b)){return a+b;}else
return undefined;},contains:function(o,e){if(Comp.obj.isArray(o))
return Comp.array.contains(o,e);else if(Comp.obj.isObj(o)&&(Comp.obj.isString(e)||Comp.obj.isNumber(e)))
return o[e]!=undefined;else if(Comp.obj.isString(o)&&Comp.obj.isString(e))
return o.indexOf(e)!=-1},copy:function(o){var _o,p;if(Comp.obj.isArray(o)){if(typeof o[0]!='object')return o.slice();else return o.map(function(e){if(typeof e=='object')return aios0.copy(e);else return e;});}else if(Comp.obj.isObject(o)){_o={};for(p in o)_o[p]=(typeof o[p]=='object'?aios0.copy(o[p]):o[p]);return _o;}
else if(Comp.obj.isString(o))
return o.slice();else return o;},delta:function(o1,o2){var res;if(Comp.obj.isArray(o1)&&Comp.obj.isArray(o2)){if(o1.length!=o2.length)return;res=[];for(var i in o1)res[i]=o1[i]-o2[i];}else if(Comp.obj.isObject(o1)&&Comp.obj.isObject(o2)){res={};for(var p in o1)res[p]=o1[p]-o2[p];}
return res;},distance:function(p1,p2){var y=0;if(p2)for(var p in p1)if(typeof p1[p]=='number'&&typeof p2[p]=='number')y+=Math.pow(p1[p]-p2[p],2);else for(var p in p1)if(typeof p1[p]=='number')y+=Math.pow(p1[p],2);return Math.sqrt(y)},div:div,dump:function(x){if(x=='res')x=Comp.obj.copy(current.process.resources);if(x=='?')x=this;logAgent(util.inspect(x));},empty:function(o){if(Comp.obj.isArray(o)||Comp.obj.isString(o))return o.length==0;else if(Comp.obj.isObj(o))return Comp.obj.isEmpty(o);else return false;},equal:function(a,b){var i;if(Comp.obj.isNumber(a)&&Comp.obj.isNumber(b))return a==b;else if(Comp.obj.isArray(a)&&Comp.obj.isArray(b)){if(a.length!=b.length)return false;for(i in a){if(!aios0.equal(a[i],b[i]))return false;}
return true;}
else if(Comp.obj.isObj(a)&&Comp.obj.isObj(b)){for(i in a){if(!aios0.equal(a[i],b[i]))return false;}
return true;}
else if(Comp.obj.isString(a)&&Comp.obj.isString(b))
return(a.length==b.length&&a==b)
return false;},filter:function(a,f){var element,res=[],len,len2,i,j,found;if(Comp.obj.isArray(a)&&Comp.obj.isFunction(f)){res=[];len=a.length;for(i=0;i<len;i++){element=a[i];if(f.call(current.process.agent,element,i))res.push(element);}
return res;}else if(Comp.obj.isArray(a)&&Comp.obj.isArray(f)){res=[];len=a.length;len2=f.length;for(i=0;i<len;i++){element=a[i];found=false;for(j=0;j<len2;j++)if(element==f[j]){found=true;break;}
if(!found)res.push(element);}
return res;}else return undefined;},flatten:function(a,level){if(Comp.obj.isMatrix(a)){return a.reduce(function(flat,toFlatten){return flat.concat(Array.isArray(toFlatten)&&level>1?aios0.flatten(toFlatten,level-1):toFlatten);},[]);}else if(Comp.obj.isObj(a)){function flo(o){var o2={},o3;for(var p in o){if(typeof o[p]=='object'){o3=flo(o[p]);for(var p2 in o3){o2[p+p2]=o3[p2];}}else o2[p]=o[p];}
return o2;}
return flo(a);}
return a;},head:function(a){if(Comp.obj.isArray(a))
return Comp.array.head(a);else return undefined;},id:aidgen,info:function(kind){switch(kind){case'node':return{id:current.node.id,position:current.node.position,location:current.node.location,type:current.node.type,};case'version':return options.version;case'host':return{type:global.TARGET};}},int:int,isin:function(o,v){var p;if(Comp.obj.isArray(o)){for(p in o)if(aios0.equal(o[p],v))return true;return false;}else if(Comp.obj.isObj(o)){for(p in o)if(aios0.equal(o[p],v))return true;return false;}else if(Comp.obj.isString(o)){return o.indexOf(v)!=-1}},iter:function(obj,fun){var p;if(Comp.obj.isArray(obj))
for(p in obj)fun.call(current.process.agent,obj[p],Number(p));else
for(p in obj)fun.call(current.process.agent,obj[p],p)},keys:Object.keys,kill:function(){kill(current.process.agent.id)},last:function(o){if(o==undefined)return;else if(Comp.obj.isArray(o)||Comp.obj.isString(o))
return o[o.length-1];else if(Comp.obj.isObj(o)){var p,l;for(p in o)if(o[p]!=undefined)l=o[p];return l;}},length:function(o){if(o==undefined)return 0;else if(Comp.obj.isObj(o)){var p,l=0;for(p in o)if(o[p]!=undefined)l++;return l;}else return o.length},log:function(){logAgent.apply(_,arguments)},map:function(a,f){var res,i,p;if(Comp.obj.isArray(a)&&Comp.obj.isFunction(f)){res=[];for(i in a){v=f.call(current.process.agent,a[i],i);if(v!=undefined)res.push(v);}
return res;}else if(Comp.obj.isObject(a)&&Comp.obj.isFunction(f)){res={};for(p in a){v=f.call(current.process.agent,a[p],p);if(v!=undefined)res[p]=v;}
return res;}else return undefined;},matrix:function(x,y,init){var row=[];var mat=[];for(var j=0;j<y;j++){row=[];for(var i=0;i<x;i++)
row.push(init||0)
mat.push(row)}
return mat;},max:function(a,b){if(Comp.obj.isArray(a)){var f=function(x){return x},v,vi;if(Comp.obj.isFunction(b))f=b;Comp.array.iter(a,function(a0,i){a0=f(a0);if(v==undefined||a0>v){v=a0;vi=i};});if(vi!=undefined)return a[vi];}else return Math.max(a,b);},me:function(){return current.process.agent.id;},min:function(a,b){if(Comp.obj.isArray(a)){var f=function(x){return x},v,vi;if(Comp.obj.isFunction(b))f=b;Comp.array.iter(a,function(a0,i){a0=f(a0);if(v==undefined||a0<v){v=a0;vi=i};});if(vi!=undefined)return a[vi];}else return Math.min(a,b);},myClass:function(){return current.process.agent.ac;},myNode:function(){return current.node.id;},myParent:function(){return current.process.agent.parent;},myPosition:function(){return current.node.location||current.node.position;},neg:function(v){var p;if(Comp.obj.isNumber(v))return-v;if(Comp.obj.isArray(v))return v.map(function(e){return aios0.neg(e)});if(Comp.obj.isObj(v)){var o=v,_o={};for(p in o)_o[p]=typeof o[p]=='number'?-o[p]:o[p];return _o;}},negotiate:function(res,val,cap){return negotiate(0,res,val,cap)},next:function(){},object:function(str){var myobj={data:null};with({myobj:myobj,str:str}){myobj.data=eval0('var _o='+str+';_o')};return myobj.data;},privilege:function(){return 0},Port:Sec.Port,Private:Sec.Private,random:function(a,b,frac){var r,n,p,i,keys,k;if(Comp.obj.isArray(a)){n=a.length;if(n>0)
return a[Comp.random.int(n)];else
return none;}else if(Comp.obj.isObj(a)){keys=Object.keys(a);n=keys.length;if(n>0)
return a[keys[Comp.random.int(n)]];else
return none;}else if(b==undefined){b=a;a=0};if(!frac||frac==1)
return Comp.random.interval(a,b);else{r=Comp.random.range(a,b);return((r/frac)|0)*frac;}},reduce:function(a,f){if(Comp.obj.isArray(a)){return a.reduce(function(a,b){return current.process?f.call(current.process.agent,a,b):f(a,b);});}},reverse:function(a){if(Comp.obj.isArray(a))
return a.slice().reverse();else if(Comp.obj.isString(a))
return a.split("").reverse().join("")},sleep:Sig.agent.sleep,sort:function(a,f){if(Comp.obj.isArray(a)&&Comp.obj.isFunction(f)){return Comp.array.sort(a,function(x,y){return f.call(current.process.agent,x,y);});}else return undefined;},sum:function(o,f){if(Comp.obj.isArray(o))return Comp.array.sum(o,f);else if(Comp.obj.isObject(o)){var s=0,p;if(!f)f=function(x){return x};for(p in o)s+=f(o[p]);return s;}},string:function(o){if(Comp.obj.isString(o))return o;else return o.toString()},tail:function(a){if(Comp.obj.isArray(a))
return Comp.array.tail(a);else return undefined;},time:function(){return time()-current.world.lag},without:function(a,b){if(Comp.obj.isArray(a)&&(Comp.obj.isArray(b)))
return a.filter(function(v){return!aios0.contains(b,v);});else if(Comp.obj.isArray(a))
return a.filter(function(v){return!aios0.equal(b,v);});},zero:function(a){var i;if(Comp.obj.isNumber(a))return a==0;if(Comp.obj.isArray(a)){for(i in a){if(!aios0.zero(a[i]))return false;}
return true;}
if(Comp.obj.isObj(a)){for(i in a){if(!aios0.zero(a[i]))return false;}
return true;}
return false;},Vector:function(x,y,z){var o={};if(x!=_)o['x']=x;if(y!=_)o['y']=y;if(z!=_)o['z']=z;return o},B:B,CP:CP,I:I,L:L,RT:RT,Math:Math}
var aios1={abs:aios0.abs,act:Conf.agent.act,add:aios0.add,angle:aios0.angle,alt:Ts.agent.alt,array:aios0.array,assign:aios0.assign,broadcast:Sig.agent.broadcast,Capability:Sec.Capability,clock:clock,collect:Ts.agent.collect,concat:aios0.concat,contains:aios0.contains,copy:aios0.copy,copyto:Ts.agent.copyto,create:function(ac,args,level){if(level==undefined||level>1)level=1;var process=none;if(!Comp.obj.isArray(args)&&!Comp.obj.isObject(args)){current.error='Invalid argument: Agent argument is neither array nor object';throw'CREATE';};current.process.resources.agents++;if(current.world.classes[ac]&&current.world.classes[ac][level])
process=Code.createOn(current.node,current.world.classes[ac][level],args,level,ac);else if(current.process.agent.subclass&&current.process.agent.subclass[ac]){process=Code.createOn(current.node,current.process.agent.subclass[ac],args,level,ac);}else{current.error='Invalid argument: Unknown agent class '+ac;throw'CREATE';}
if(process){if(current.process!=none&&process.gid==none){process.gid=current.process.pid;if(!process.agent.parent)
process.agent.parent=current.process.agent.id;}
return process.agent.id;}else return none;},delta:aios0.delta,distance:aios0.distance,div:aios0.div,dump:aios0.dump,empty:aios0.empty,evaluate:Ts.agent.evaluate,equal:aios0.equal,exists:Ts.agent.exists,Export:function(name,code){current.node.export(name,code)},filter:aios0.filter,flatten:aios0.flatten,fork:function(parameter){var process=current.process.fork(parameter,undefined,options.fastcopy);return process.agent.id},head:aios0.head,id:aidgen,Import:function(name){return current.node.import(name)},info:aios0.info,inp:Ts.agent.inp,int:aios0.int,isin:aios0.isin,iter:aios0.iter,keys:Object.keys,kill:function(aid){if(aid==undefined)kill(current.process.agent.id);else kill(aid)},last:aios0.last,length:aios0.length,link:function(dir){return current.world.connected(dir,current.node)},listen:Ts.agent.listen,log:aios0.log,me:aios0.me,mark:Ts.agent.mark,map:aios0.map,max:aios0.max,matrix:aios0.matrix,moveto:Mobi.agent.move,min:aios0.min,myClass:aios0.myClass,myNode:aios0.myNode,myParent:aios0.myParent,myPosition:aios0.myPosition,neg:aios0.neg,negotiate:function(res,val,cap){return negotiate(1,res,val,cap)},object:aios0.object,opposite:Mobi.agent.opposite,out:Ts.agent.out,Port:Sec.Port,position:function(){return current.node.position},Private:Sec.Private,privilege:function(){return 1},random:aios0.random,rd:Ts.agent.rd,reduce:aios0.reduce,reverse:aios0.reverse,rm:Ts.agent.rm,security:Sec,send:Sig.agent.send,sendto:Sig.agent.sendto,sleep:Sig.agent.sleep,sort:aios0.sort,store:Ts.agent.store,string:aios0.string,sum:aios0.sum,tail:aios0.tail,test:Ts.agent.exists,time:aios0.time,timer:Sig.agent.timer,trans:Conf.agent.trans,try_alt:Ts.agent.try.alt,try_inp:Ts.agent.try.inp,try_rd:Ts.agent.try.rd,ts:Ts.agent.ts,wakeup:Sig.agent.wakeup,without:aios0.without,zero:aios0.zero,B:B,CP:CP,I:I,L:L,RT:RT,Vector:aios0.Vector,DIR:Mobi.agent.DIR,Math:Math};var aios2={abs:aios0.abs,add:aios0.add,act:Conf.agent.act,angle:aios0.angle,alt:Ts.agent.alt,array:aios0.array,assign:aios0.assign,broadcast:Sig.agent.broadcast,Capability:Sec.Capability,clock:clock,collect:Ts.agent.collect,concat:aios0.concat,contains:aios0.contains,copy:aios0.copy,copyto:Ts.agent.copyto,create:function(ac,args,level){var process=none;if(level==undefined||level>2)level=2;if(!Comp.obj.isArray(args)&&!Comp.obj.isObject(args)){current.error='Invalid argument: Agent arguments is neither array nor object';throw'CREATE';};current.process.resources.agents++;if(current.world.classes[ac]&&current.world.classes[ac][level])
process=Code.createOn(current.node,current.world.classes[ac][level],args,level,ac);else if(current.process.agent.subclass&&current.process.agent.subclass[ac]){process=Code.createOn(current.node,current.process.agent.subclass[ac],args,level,ac);}else{current.error='Invalid argument: Unknown agent class '+ac;throw'CREATE';}
if(process){process.agent.ac=ac;if(current.process!=none&&process.gid==none){process.gid=current.process.pid;if(process.agent.parent==_||process.agent.parent==none)
process.agent.parent=current.process.agent.id;}
return process.agent.id;}else return none;},delta:aios0.delta,distance:aios0.distance,div:aios0.div,dump:aios0.dump,empty:aios0.empty,evaluate:Ts.agent.evaluate,equal:aios0.equal,exists:Ts.agent.exists,Export:function(name,code){current.node.export(name,code)},filter:aios0.filter,flatten:aios0.flatten,fork:function(parameter){var process=current.process.fork(parameter);return process.agent.id},head:aios0.head,id:aidgen,Import:function(name){return current.node.import(name)},info:aios0.info,inp:Ts.agent.inp,int:aios0.int,isin:aios0.isin,iter:aios0.iter,keys:Object.keys,kill:function(aid){if(aid==undefined)kill(current.process.agent.id);else kill(aid)},last:aios0.last,length:aios0.length,link:function(dir){return current.world.connected(dir,current.node)},listen:Ts.agent.listen,log:aios0.log,max:aios0.max,me:aios0.me,min:aios0.min,myClass:aios0.myClass,myNode:aios0.myNode,myParent:aios0.myParent,myPosition:aios0.myPosition,mark:Ts.agent.mark,map:aios0.map,matrix:aios0.matrix,moveto:Mobi.agent.move,neg:aios0.neg,negotiate:function(res,val,cap){return negotiate(2,res,val,cap)},object:aios0.object,opposite:Mobi.agent.opposite,out:Ts.agent.out,random:aios0.random,reduce:aios0.reduce,rd:Ts.agent.rd,reverse:aios0.reverse,rm:Ts.agent.rm,Port:Sec.Port,position:function(){return current.node.position},Private:Sec.Private,privilege:function(){return 2},security:Sec,send:Sig.agent.send,sendto:Sig.agent.sendto,sleep:Sig.agent.sleep,sort:aios0.sort,store:Ts.agent.store,string:aios0.string,sum:aios0.sum,tail:aios0.tail,test:Ts.agent.exists,time:aios0.time,timer:Sig.agent.timer,trans:Conf.agent.trans,try_alt:Ts.agent.try.alt,try_inp:Ts.agent.try.inp,try_rd:Ts.agent.try.rd,ts:Ts.agent.ts,wakeup:Sig.agent.wakeup,without:aios0.without,zero:aios0.zero,B:B,CP:CP,I:I,L:L,RT:RT,Vector:aios0.Vector,DIR:Mobi.agent.DIR,Math:Math,};var aios3={abs:aios0.abs,act:Conf.agent.act,add:aios0.add,angle:aios0.angle,alt:Ts.agent.alt,array:aios0.array,assign:aios0.assign,broadcast:Sig.agent.broadcast,Capability:Sec.Capability,clock:clock,collect:Ts.agent.collect,connectTo:function(dir,options){var node=current.node,world=current.world;if(!dir||!dir.tag)throw('CONNECT');world.connectTo(dir,node,options);},concat:aios0.concat,contains:aios0.contains,copy:aios0.copy,copyto:Ts.agent.copyto,create:function(ac,args,level){var process=none;if(level==undefined)level=3;if(!Comp.obj.isArray(args)&&!Comp.obj.isObject(args)){current.error='Invalid argument: Agent arguments is neither array nor object';throw'CREATE';};current.process.resources.agents++;if(current.world.classes[ac]&&current.world.classes[ac][level])
process=Code.createOn(current.node,current.world.classes[ac][level],args,level,ac);else if(current.process.agent.subclass&&current.process.agent.subclass[ac]){process=Code.createOn(current.node,current.process.agent.subclass[ac],args,level,ac);}else{current.error='Invalid argument: Unknown agent class '+ac;throw'CREATE';}
if(process){process.agent.ac=ac;if(current.process!=none&&process.gid==none){process.gid=current.process.pid;if(process.agent.parent==_||process.agent.parent==none)
process.agent.parent=current.process.agent.id;}
return process.agent.id;}else return none;},delta:aios0.delta,distance:aios0.distance,div:aios0.div,dump:aios0.dump,empty:aios0.empty,equal:aios0.equal,evaluate:Ts.agent.evaluate,exists:Ts.agent.exists,Export:aios2.Export,filter:aios0.filter,flatten:aios0.flatten,fork:aios2.fork,head:aios0.head,id:aidgen,Import:aios2.Import,info:aios0.info,inp:Ts.agent.inp,int:aios0.int,isin:aios0.isin,iter:aios0.iter,keys:Object.keys,kill:aios2.kill,last:aios0.last,length:aios0.length,link:aios2.link,listen:Ts.agent.listen,log:aios0.log,max:aios0.max,me:aios0.me,min:aios0.min,myClass:aios0.myClass,myNode:aios0.myNode,myParent:aios0.myParent,myPosition:aios0.myPosition,mark:Ts.agent.mark,map:aios0.map,matrix:aios0.matrix,moveto:function(){current.error='ENOTSUPPORTED';throw'MOVE';},neg:aios0.neg,negotiate:function(res,val,cap){return negotiate(3,res,val,cap)},object:aios0.object,opposite:Mobi.agent.opposite,out:Ts.agent.out,Port:Sec.Port,position:function(){return current.node.position},Private:Sec.Private,privilege:function(){return 3},reduce:aios0.reduce,random:aios0.random,rd:Ts.agent.rd,reverse:aios0.reverse,rm:Ts.agent.rm,send:Sig.agent.send,sendto:Sig.agent.sendto,sleep:aios0.sleep,sort:aios0.sort,store:Ts.agent.store,string:aios0.string,sum:aios0.sum,tail:aios0.tail,test:Ts.agent.exists,time:aios0.time,timer:Sig.agent.timer,trans:Conf.agent.trans,try_alt:Ts.agent.try.alt,try_inp:Ts.agent.try.inp,try_rd:Ts.agent.try.rd,ts:Ts.agent.ts,wakeup:Sig.agent.wakeup,without:aios0.without,zero:aios0.zero,B:B,CP:CP,I:I,L:L,RT:RT,Vector:aios0.Vector,DIR:Mobi.agent.DIR,Math:Math,IOB:function(block){var proc=current.process;setImmediate(function(){var index=0;function next(to){var _proc=current.process,_node=current.node;if(to==none){proc.mask.next=undefined;proc.wakeup();return;}
index=index+to;try{current.process=proc;current.node=proc.node;block[index].call(proc.agent);}catch(e){logAgent('Caught IOB error: '+e);}
current.process=_proc;current.node=_node;}
proc.mask.next=next;next(0);});proc.suspend();}};var aios=aios1;function B(block){if(current.process.schedule.length==0)
current.process.schedule=block;else
current.process.schedule=Comp.array.concat(block,current.process.schedule);}
function CB(process,cb,args){if(args)
Comp.array.push(process.schedule,function(){cb.apply(this,args)});else
Comp.array.push(process.schedule,cb);}
function CP(){if(current.process.runtime&&(current.process.runtime+current.world.lag-Date.now())<0)throw"SCHEDULE";return true;}
function RT(e){if(['WATCHDOG','SCHEDULE'].indexOf(e.toString())!=-1)throw(e);}
function I(obj,next,block,finalize){var index=0;var length=obj.length;var iterator=[function(){next(obj[index]);if(index<length){B(block.slice());index++;}},function(){if(index<length)B(iterator.slice());else if(finalize)finalize.call(this);}];B(iterator.slice());}
function L(init,cond,next,block,finalize){var loop=[function(){if(cond.call(this))B(block.slice());},next,function(){if(cond.call(this))B(loop.slice());}];B(loop.slice());B([init]);}
function aidgen(_options){return Name.generate(_options||options.nameopts);}
function config(settings){for(var p in settings){switch(p){case'iterations':iterations=settings[p];break;case'fastcopy':options.fastcopy=settings[p];break;case'verbose':options.verbose=settings[p];break;case'log+':options.log[settings[p]]=true;break;case'log-':options.log[settings[p]]=false;break;case'log':for(var l in settings[p])options.log[l]=settings[p][l];break;case'nolimits':if(settings[p])
Aios.watchdog=undefined,options.nolimits=true,Aios.Code.inject.cp=undefined,Aios.Code.inject.rt=undefined;break;case'nowatch':if(settings[p])
Aios.watchdog=undefined,Aios.Code.inject.cp=undefined,Aios.Code.inject.rt=undefined;break;case'checkpoint':if(settings[p])
Aios.watchdog=undefined,Aios.Code.inject.cp='CP',Aios.Code.inject.rt='RT';break;case'security':for(var q in settings[p]){var port=Sec.Port.ofString(q),random=Sec.Port.ofString(settings[p][q]);options.security[port]=random;}
break;case'print':Aios.print=settings[p];break;case'printAgent':Aios.printAgent=settings[p];break;case'printAsync':Aios.printAsync=settings[p];break;case'LEVEL':options.LEVEL=settings[p];break;case'LIFETIME':options.LIFETIME=settings[p];break;case'TIMESCHED':options.TIMESCHED=settings[p];break;case'TIMEPOOL':options.TIMEPOOL=settings[p];break;case'MEMPOOL':options.MEMPOOL=settings[p];break;case'TSPOOL':options.TSPOOL=settings[p];break;case'AGENTPOOL':options.AGENTPOOL=settings[p];break;case'MINCOST':options.MINCOST=settings[p];break;case'RUNTIME':options.RUNTIME=settings[p];break;case'IDLETIME':options.IDLETIME=settings[p];break;case'TSTMO':options.TSTMO=Aios.Ts.options.timeout=settings[p];break;case'time':time=settings[p];Aios.time=aios0.time=aios1.time=aios2.time=aios3.time=time;Aios.CP=aios0.CP=aios1.CP=aios2.CP=aios3.CP=function(){if(current.process.runtime&&(current.process.runtime+current.world.lag-time())<0)throw"SCHEDULE";return true;};break;}}}
function configGet(){return{LEVEL:options.LEVEL,LIFETIME:options.LIFETIME,TIMESCHED:options.TIMESCHED,TIMEPOOL:options.TIMEPOOL,TSPOOL:options.TSPOOL,AGENTPOOL:options.AGENTPOOL,MEMPOOL:options.MEMPOOL,MINCOST:options.MINCOST,RUNTIME:options.RUNTIME,IDLETIME:options.IDLETIME,TSTMO:Aios.Ts.options.timeout,security:Object.keys(options.security).map(function(port){return{port:Sec.Port.toString(port),random:Sec.Port.toString(options.security[port])}}),checkpoint:{cp:Aios.Code.inject.cp,rt:Aios.Code.inject.rt,watchdog:Aios.watchdog?true:fals},nolimits:options.nolimits,iterations:iterations,fastcopy:options.fastcopy,verbose:options.verbose,log:options.log,}}
function dump(e){var e=e||(new Error('dummy'));var stack=e.stack.replace(/^[^\(]+?[\n$]/gm,'').replace(/^\s+at\s+/gm,'').replace(/^Object.<anonymous>\s*\(/gm,'{anonymous}()@').split('\n');log(e);log('Stack Trace');log('--------------------------------');for(var i in stack){if(i>0){var line=stack[i];if(line.indexOf('Module.',0)>=0)break;log(line);}}
log('--------------------------------');};function emit(){if(events[arguments[0]])
events[arguments[0]](arguments[1],arguments[2],arguments[3],arguments[4],arguments[5]);}
function errorLocation(process,err){try{var stack=err.stack.split('\n');for(var i in stack){var line=stack[i];if(line.indexOf('at act.')>=0||line.indexOf('at F.act.')>=0){return line.replace(/\([^\)]+\)/,'').replace(/\)/,'');}
else if(line.indexOf('at trans.')>=0||line.indexOf('at F.trans.')>=0){return line.replace(/\([^\)]+\)/,'').replace(/\)/,'');}}
return'';}catch(e){return'';}}
function exec_block_fun(next){var fun=next[0]||next,argn=next.length-1;switch(argn){case 0:case-1:fun();break;case 1:fun(next[1]);break;case 2:fun(next[1],next[2]);break;case 3:fun(next[1],next[2],next[3]);break;case 4:fun(next[1],next[2],next[3],next[4]);break;case 5:fun(next[1],next[2],next[3],next[4],next[5]);break;case 6:fun(next[1],next[2],next[3],next[4],next[5],next[6]);break;case 7:fun(next[1],next[2],next[3],next[4],next[5],next[6],next[7]);break;case 8:fun(next[1],next[2],next[3],next[4],next[5],next[6],next[7],next[8]);break;case 9:fun(next[1],next[2],next[3],next[4],next[5],next[6],next[7],next[8],next[9]);break;default:Io.err('Aios.exec_block_fun: more than 9 function arguments');}}
function fork(parameters){return current.process.fork(parameters);}
function kill(agent){var process;if(!agent){process=current.process;}else{process=current.node.processes.process(agent);}
if(options.debug.kill)console.log('Aios.kill',agent,process!=null);if(process){process.kill=true;current.node.unregister(process);return true;}else if(current.node.processes.gone[agent]){Sig.agent.send(agent,'PROC.KILL',9,current.process.agent.id);}else return false;}
function killOn(agent,node){var process;process=node.processes.process(agent);if(process){process.kill=true;node.unregister(process);};}
function lock(){Object.preventExtensions(global);}
function loop(services){var nexttime=scheduler(services);if(nexttime>0){if(options.verbose>3)log('[LOOP '+current.node.id+'] next schedule on '+nexttime);timer=setTimeout(function(){loop(services)},nexttime-time());}}
function min0(a,b){return a==0?b:(b==0?a:Comp.pervasives.min(a,b))};function handleException(process,exc,arg1,arg2,arg3,arg4){var agent=process.agent;if(Aios.watchdog&&Aios.watchdog.protect){try{Aios.watchdog.protect(function(){agent.on[exc].call(agent,arg1,arg2,arg3,arg4)})}catch(e){if(options.verbose)logAIOS('Agent '+agent.id+' ['+agent.ac+'] failed handling '+exc+'('+arg1+')');process.kill=true
return false;};}else
try{agent.on[exc].call(agent,arg1,arg2,arg3,arg4)}catch(e){if(options.verbose)logAIOS('Agent '+agent.id+' ['+agent.ac+'] failed handling '+exc+'('+arg1+')');process.kill=true
return false;}
return true;}
function negotiate(level,resource,value,cap){var obj,security=options.security;function checkRights(r){return(level>1||(cap&&security[cap.cap_port]&&Sec.Private.rights_check(cap.cap_priv,security[cap.cap_port],r)))}
switch(resource){case'LIFE':case'LIFETIME':if(!checkRights(Sec.Rights.NEG_LIFE))return false;current.process.resources.LIFE=value;break;case'CPU':case'TIMEPOOL':if(!checkRights(Sec.Rights.NEG_CPU))return false;current.process.resources.CPU=value;break;case'SCHED':case'SCHEDULE':case'TIMESCHED':if(!checkRights(Sec.Rights.NEG_SCHED))return false;current.process.resources.SCHED=value;break;case'MEM':case'MEMORY':case'MEMPOOL':if(!checkRights(Sec.Rights.NEG_RES))return false;current.process.resources.MEM=value;break;case'TS':case'TSPOOL':if(!checkRights(Sec.Rights.NEG_RES))return false;current.process.resources.TS=value;break;case'AGENT':case'AGENTPPOL':if(!checkRights(Sec.Rights.NEG_RES))return false;current.process.resources.AGENT=value;break;case'LEVEL':if(!checkRights(Sec.Rights.NEG_LEVEL))return false;switch(value){case 1:case 2:current.process.upgrade(value);break;}
break;case'?':obj=Comp.obj.copy(current.process.resources);Comp.obj.extend(obj,{SCHED:current.process.resources.SCHED||options.TIMESCHED,CPU:current.process.resources.CPU||options.TIMEPOOL,MEM:current.process.resources.MEM||options.MEMPOOL,TS:current.process.resources.TS||options.TSPOOL,AGENT:current.process.resources.AGENT||options.AGENTPOOL,});return obj;break;default:return false;}
return true;}
function off(event){events[event]=undefined;}
function on(event,fun){if(events[event]){var funorig=events[event];events[event]=function(){funorig.apply(this,arguments);fun.apply(this,arguments);};}else
events[event]=fun;}
function out(str){log(str)};function resource(r0){var r;if(!options.useproc)return 0;r=process.memoryUsage();if(r0==undefined)
return{r:r.rss-r.heapTotal,h:r.heapUsed};else return int((Math.max(0,r.rss-r.heapTotal-r0.r)+Math.max(0,r.heapUsed-r0.h))/1024);}
var SA={NOOP:0,BLOCK:1,NORES:2,SIG:3,TRANS:4,SCHED:5,ACT:6,print:function(op){switch(op){case SA.NOOP:return'NOOP';case SA.BLOCK:return'BLOCK';case SA.NORES:return'NORES';case SA.SIG:return'SIG';case SA.TRANS:return'TRANS';case SA.SCHED:return'SCHED';case SA.ACT:return'ACT';}}}
function schedule(process){var exec,sig,start,delta,next,_current,node=current.node,agent=process.agent,action='',op=SA.NOOP,handled,exception,curtime,r0;ticks++;assert((process.agent!=undefined&&process.id=='agent')||('Aios.schedule: not an agent process: '+process.id));curtime=time();if(!options.nolimits&&!process.kill&&(process.resources.start+(process.resources.LIFE||options.LIFETIME))<(curtime-current.world.lag))op=SA.NORES;else if(process.blocked||(process.suspended==true&&process.block.length==0&&process.signals.length==0)||process.dead==true||(agent.next==none&&process.signals.length==0&&process.schedule.length==0))op=SA.NOOP;else if(!process.blocked&&process.block.length>0)op=SA.BLOCK;else if(!options.nolimits&&(process.resources.consumed>(process.resources.CPU||options.TIMEPOOL)||process.resources.memory>(process.resources.MEM||options.MEMPOOL)))
op=SA.NORES;else if(process.priority<Proc.PRIO.HIGH&&process.signals.length>0)op=SA.SIG;else if(!process.suspended&&process.transition)op=SA.TRANS;else if(!process.suspended&&process.schedule.length>0)op=SA.SCHED;else if(!process.suspended)op=SA.ACT;if(options.verbose>3)print('[SCH] '+time()+' '+process.agent.id+' : '+
SA.print(op)+' [susp='+process.suspended+',trans='+process.transition+',tmo='+process.timeout+']');if(op==SA.NOOP)return 0;start=curtime;if(Aios.watchdog)Aios.watchdog.start(process.resources.SCHED||options.TIMESCHED);else if(!options.nolimits)
process.runtime=start-current.world.lag+(process.resources.SCHED||options.TIMESCHED);if(!options.nolimits)
r0=resource();current.process=process;current.error=none;if(current.scheduler)_current=current.scheduler.SetCurrent(process);try{switch(op){case SA.BLOCK:schedule_block(process);break;case SA.NORES:throw'EOL';break;case SA.SIG:if(!process.suspended&&!process.transition)process.priority++;action='signal';sig=Comp.array.pop(process.signals);try{agent.on[sig[0]].call(agent,sig[1],sig[2]);if(process.suspended&&process.transition)process.suspended=false;}catch(e){if(!agent.on[sig[0]])
logAIOS('Signal handler '+sig[0]+' in agent '+agent.id+' ['+agent.ac+'] not defined, ignoring signal.');else
logAIOS('Signal handler '+sig[0]+' in agent '+agent.id+' ['+agent.ac+'] failed: '+e+
(current.error?' / '+current.error:'')+', in: \n'+Code.print(agent.on[sig[0]])+
+errorLocation(process,e))
current.error=none;process.kill=true;};Aios.emit('signal+',process,node,sig[0],sig[1],sig[2]);break;case SA.TRANS:try{action='transition';if(!agent.trans[agent.next])throw"NOTDEFINED";next=(typeof agent.trans[agent.next]=='function')?agent.trans[agent.next].call(agent):agent.trans[agent.next];if(next){agent.next=next;process.suspended=false;process.transition=false;}else{process.suspended=true;}}catch(e){if(agent.trans[agent.next]==undefined)
logAIOS('Transition table entry '+agent.next+' not defined in agent '+agent.id+' ['+agent.ac+'].');else
logAIOS('Agent '+agent.id+' ['+agent.ac+'] in transition '+agent.next+' failed:\n'+e+(current.error?' / '+current.error:'')+
+errorLocation(process,e));process.kill=true;current.error=none;}
break;case SA.SCHED:action='block';exec=Comp.array.pop(process.schedule);Aios.watchdog&&Aios.watchdog.protect?Aios.watchdog.protect(exec.bind(agent)):exec.call(agent);if(!process.kill&&!process.suspended&&process.schedule.length==0){if(process.notransition){process.notransition=false;}else{next=(typeof agent.trans[agent.next]=='function')?agent.trans[agent.next].call(agent):agent.trans[agent.next];if(!next)process.suspend(0,true);else agent.next=next;}}
break;case SA.ACT:if(process.priority==Proc.PRIO.HIGH)process.priority--;action='activity';if(agent.next==none)throw'KILL';Aios.watchdog&&Aios.watchdog.protect?Aios.watchdog.protect(agent.act[agent.next].bind(agent)):agent.act[agent.next].call(agent);if(!process.kill&&!process.suspended&&process.schedule.length==0){action='transition';if(!agent.trans[agent.next])throw"NOTDEFINED";next=(typeof agent.trans[agent.next]=='function')?agent.trans[agent.next].call(agent):agent.trans[agent.next];if(!next)process.suspend(0,true);else agent.next=next;}
break;}}catch(e){if(Aios.watchdog)Aios.watchdog.stop();curtime=time()-current.world.lag;exception=true;switch(e){case'SCHEDULE':case'WATCHDOG':e='SCHEDULE';if(Aios.watchdog)Aios.watchdog.start(options.TIMESCHED/10);else process.runtime=curtime+options.TIMESCHED/10;handleException(process,'error',e,options.TIMESCHED,agent.next);break;case'EOL':if(Aios.watchdog)Aios.watchdog.start(options.TIMESCHED/10);else
process.runtime=curtime+options.TIMESCHED/10;if(process.resources.consumed>=(process.resources.CPU||options.TIMEPOOL)){handleException(process,'error','CPU',e,process.resources.consumed,agent.next);if(process.resources.consumed>=(process.resources.CPU||options.TIMEPOOL))
process.kill=true;}else if(process.resources.memory>=(process.resources.MEM||options.MEMPOOL)){handleException(process,'error','EOM',process.resources.memory,agent.next);if(process.resources.memory>=(process.resources.MEM||options.MEMPOOL))
process.kill=true;}else if(process.resources.tuples>=(process.resources.TS||options.TSPOOL)){handleException(process,'error','EOT',process.resources.memory,agent.next);if(process.resources.tuples>=(process.resources.TS||options.TSPOOL))
process.kill=true;}else if((process.resources.start+(process.resources.LIFE||options.LIFETIME))<curtime){handleException(process,'error','EOL',process.resources.memory,agent.next);if((process.resources.start+(process.resources.LIFE||options.LIFETIME))<curtime)
process.kill=true;}else{handleException(process,'error','EOR',0,agent.next);process.kill=true;}
break;case'KILL':if(Aios.watchdog)Aios.watchdog.start(options.TIMESCHED/10);else process.runtime=curtime+options.TIMESCHED/10;handleException(process,'exit');process.kill=true;break;case'NOTDEFINED':if(agent.act[agent.next]==undefined&&options.verbose)
logAIOS('Activity '+agent.next+' not defined in agent '+
agent.id+' ['+agent.ac+'].');else if(agent.trans[agent.next]==undefined&&options.verbose)
logAIOS('Transition table entry '+agent.next+' not defined in agent '+agent.id+' ['+agent.ac+'].');process.kill=true;current.error=none;break;default:handled=handleException(process,aiosExceptions.indexOf(e.toString())!=-1?e:'error',e,current.error,agent.next);if(!handled&&options.verbose)
logAIOS('Agent '+agent.id+' ['+agent.ac+'] in '+(action=='block'?'block in':action)+' '+
(action=='signal'?sig[0]:agent.next)+' failed: Error '+e+(current.error?('; '+current.error):'')+
(options.verbose>1?(', in code: \n'+(action=='activity'?Code.print(agent.act[agent.next]):(action=='transition'?Code.print(agent.trans[agent.next]):(agent.on&&sig&&agent.on[sig[0]])?Code.print(agent.on[sig[0]]):'none'))+
errorLocation(process,e)):''));if(options.verbose>2&&['CREATE','MOVE','SIGNAL'].indexOf(e)==-1)Io.printstack(e);if(!handled)process.kill=true;else{action='transition';if(!agent.trans[agent.next])throw"NOTDEFINED";next=(typeof agent.trans[agent.next]=='function')?agent.trans[agent.next].call(agent):agent.trans[agent.next];if(!next)process.suspend(0,true);else agent.next=next;}
current.error=none;}}
if(Aios.watchdog)Aios.watchdog.stop();else process.runtime=0;if(!options.nostats){delta=(time()-start)||options.MINCOST;process.resources.consumed+=delta;process.resources.memory+=resource(r0);current.node.stats.cpu+=delta;}
if(options.verbose&&exception&&process.kill)logAIOS('Killed agent '+agent.id);if(current.scheduler)current.scheduler.SetCurrent(_current);current.process=none;if(options.verbose>3)print(time()+' <- '+process.print());return 1;}
function schedule_block(process){var next;if(!process.blocked){next=process.block[0];process.block.splice(0,1);while(!Comp.array.empty(process.block)&&next.handler!=undefined){next=process.block[0];process.block.splice(0,1);}
if(next.handler==undefined){try{exec_block_fun(next)}catch(e){while(next.handler==undefined&&!Comp.array.empty(process.block)){next=process.block[0];process.block.splice(0,1);}
if(next.handler!=undefined){try{exec_block_fun([next.handler,e])}
catch(e){Io.out('Aios.schedule_block [Internal B], in agent context '+
process.agent.id+', got exception in exception handler: '+e);Io.out(Json.stringify(next).replace(/\\n/g,'\n'));};}else{logAIOS('Agent '+process.agent.id+' ['+process.agent.ac+'] in activity '+
process.agent.next+' failed:\n'+e+(current.error?' / '+current.error:', in: \n'+
Code.print(process.agent.act[process.agent.next]))+'');process.kill=true;current.error=none;}}}}}
var scheduled=0;function scheduler(services){var run=1,nexttime=0,n=0,curtime,process,env,node,pro,timeout=time()+options.RUNTIME;scheduled=0;while(run&&(iterations==0||n<iterations)&&time()<timeout){run=0;n++;if(services)services();nexttime=options.IDLETIME?Sig.agent.timeout(options.IDLETIME):0;for(env in current.world.nodes){node=current.world.nodes[env];if(!node)continue;current.node=node;curtime=time()-current.world.lag;if(node.timers.length>0){remove=false;Comp.array.iter(node.timers,function(timer,i){if(timer&&timer[1]<=curtime){var process=timer[0],agent=process.agent,suspended=process.suspended,timeout=process.timeout;process.signals.push([timer[2],timer[3],agent.id]);run+=schedule(process);curtime=time()-current.world.lag;if(timer[4]>0){timer[1]=curtime+timer[4];}else{remove=true;node.timers[i]=undefined;}
process.timeout=timeout;}else if(timer)nexttime=min0(nexttime,timer[1]);});if(remove)
node.timers=Comp.array.filter(node.timers,function(timer){return timer!=undefined;});}
curtime=time()-current.world.lag;node.service(curtime);for(pro in node.processes.table){if(node.processes.table[pro]){curtime=time()-current.world.lag;process=node.processes.table[pro];if(process.suspended&&process.timeout&&process.timeout<=curtime){process.wakeup();}
run+=schedule(process);if(node.processes.table[pro]&&node.processes.table[pro].kill)
node.unregister(node.processes.table[pro]);if(node.processes.table[pro]&&process.suspended&&process.timeout>0)
nexttime=min0(nexttime,process.timeout);}}}
scheduled+=run;}
if(scheduled>0)return-scheduled;else if(nexttime>0)return nexttime;else return 0;}
var time=function(){return Math.ceil(Date.now())};var Aios={aidgen:aidgen,aios:aios1,aios0:aios0,aios1:aios1,aios2:aios2,aios3:aios3,aiosEvents:aiosEvents,Amp:Amp,callback:undefined,clock:clock,collect:Ts.agent.collect,config:config,configGet:configGet,current:current,emit:emit,err:function(msg){if(options.verbose)log('Error: '+msg)},fork:fork,kill:kill,killOn:killOn,lock:lock,loop:loop,log:log,logAgent:logAgent,logAIOS:logAIOS,logAIOSasync:logAIOSasync,logAsync:logAsync,off:off,on:on,options:options,print:Io.out,printAgent:undefined,printAsync:undefined,schedule:schedule,scheduled:scheduled,scheduler:scheduler,ticks:function(v){if(v!=undefined)ticks=v;else return ticks},time:time,timeout:function(tmo){return tmo>0?Aios.time()-current.world.lag+tmo:0},Chan:Chan,Code:Code,Json:Json,Mobi:Mobi,Name:Name,Node:Node,Proc:Proc,Sec:Sec,Sig:Sig,Simu:Simu,Ts:Ts,World:World,CB:CB,CP:CP,RT:RT,B:B,DIR:Mobi.DIR,I:I,L:L,warn:function(msg){if(options.verbose>1)log('Warning: '+msg)},watchdog:undefined}
if(watchdog&&watchdog.start)Aios.watchdog=watchdog;if(watchdog&&watchdog.init)watchdog.init('WATCHDOG');if(watchdog&&watchdog.checkPoint){aios0.CP=watchdog.checkPoint;aios1.CP=watchdog.checkPoint;aios2.CP=watchdog.checkPoint;aios3.CP=watchdog.checkPoint;Aios.CP=watchdog.checkPoint;}
Conf.current(Aios);Code.current(Aios);Sig.current(Aios);Sec.current(Aios);Ts.current(Aios);Proc.current(Aios);Node.current(Aios);World.current(Aios);Mobi.current(Aios);if(Simu)Simu.current(Aios);Chan.current(Aios);Json.current(Aios);module.exports=Aios;};BundleModuleCode['com/pwgen']=function(module,exports){var Crypto=Require('os/crypto.rand');module.exports.generate=function(options){function numgen(options){var arr=new Uint8Array(options.length||8);getRandomValues(arr);return arr;}
function pwgen(options){var localName,consonant,letter,vowel,pattern=options.pattern,char="",n,i,validChars=[],prefix=options.prefix;letter=/[a-zA-Z]$/;vowel=/[aeiouAEIOU]$/;consonant=/[bcdfghjklmnpqrstvwxyzBCDFGHJKLMNPQRSTVWXYZ]$/;if(options.length==null){options.length=10;}
if(pattern==null){pattern=/\w/;}
if(prefix==null){prefix='';}
if(!options.memorable){for(i=33;126>i;i+=1){char=String.fromCharCode(i);if(char.match(pattern)){validChars.push(char);}}
if(!validChars.length){throw new Error("Could not find characters that match the "+"password pattern "+pattern+". Patterns must match individual "+"characters, not the password as a whole.");}}
while(prefix.length<options.length){if(options.memorable){if(prefix.match(consonant)){pattern=vowel;}else{pattern=consonant;}
n=Crypto.randomByte(33,126);char=String.fromCharCode(n);}else{char=validChars[rand(0,validChars.length)];}
if(options.lowercase)char=char.toLowerCase();else if(options.uppercase)char=char.toUpperCase();if(char.match(pattern)){prefix=""+prefix+char;}}
return prefix;};function rand(min,max){var key,value,arr=new Uint8Array(max);getRandomValues(arr);for(key in arr){if(arr.hasOwnProperty(key)){value=arr[key];if(value>min&&value<max){return value;}}}
return rand(min,max);}
function getRandomValues(buf){var bytes=Crypto.randomBytes(buf.length);buf.set(bytes);}
if(options.number)
return numgen(options)
else
return pwgen(options);};};BundleModuleCode['os/crypto.rand']=function(module,exports){var crypto=global.crypto||global.msCrypto;if(!crypto&&typeof require!='undefined')try{crypto=global.crypto=require('require')}catch(e){};var twister;var MersenneTwister=function(seed){if(seed==undefined){seed=new Date().getTime();seed*=Math.random()*91713;seed|=0;}
this.N=624;this.M=397;this.MATRIX_A=0x9908b0df;this.UPPER_MASK=0x80000000;this.LOWER_MASK=0x7fffffff;this.mt=new Array(this.N);this.mti=this.N+1;if(seed.constructor==Array){this.init_by_array(seed,seed.length);}
else{this.init_seed(seed);}}
MersenneTwister.prototype.init_seed=function(s){this.mt[0]=s>>>0;for(this.mti=1;this.mti<this.N;this.mti++){var s=this.mt[this.mti-1]^(this.mt[this.mti-1]>>>30);this.mt[this.mti]=(((((s&0xffff0000)>>>16)*1812433253)<<16)+(s&0x0000ffff)*1812433253)
+this.mti;this.mt[this.mti]>>>=0;}}
MersenneTwister.prototype.init_by_array=function(init_key,key_length){var i,j,k;this.init_seed(19650218);i=1;j=0;k=(this.N>key_length?this.N:key_length);for(;k;k--){var s=this.mt[i-1]^(this.mt[i-1]>>>30)
this.mt[i]=(this.mt[i]^(((((s&0xffff0000)>>>16)*1664525)<<16)+((s&0x0000ffff)*1664525)))
+init_key[j]+j;this.mt[i]>>>=0;i++;j++;if(i>=this.N){this.mt[0]=this.mt[this.N-1];i=1;}
if(j>=key_length)j=0;}
for(k=this.N-1;k;k--){var s=this.mt[i-1]^(this.mt[i-1]>>>30);this.mt[i]=(this.mt[i]^(((((s&0xffff0000)>>>16)*1566083941)<<16)+(s&0x0000ffff)*1566083941))
-i;this.mt[i]>>>=0;i++;if(i>=this.N){this.mt[0]=this.mt[this.N-1];i=1;}}
this.mt[0]=0x80000000;}
MersenneTwister.prototype.random_int=function(){var y;var mag01=new Array(0x0,this.MATRIX_A);if(this.mti>=this.N){var kk;if(this.mti==this.N+1)
this.init_seed(5489);for(kk=0;kk<this.N-this.M;kk++){y=(this.mt[kk]&this.UPPER_MASK)|(this.mt[kk+1]&this.LOWER_MASK);this.mt[kk]=this.mt[kk+this.M]^(y>>>1)^mag01[y&0x1];}
for(;kk<this.N-1;kk++){y=(this.mt[kk]&this.UPPER_MASK)|(this.mt[kk+1]&this.LOWER_MASK);this.mt[kk]=this.mt[kk+(this.M-this.N)]^(y>>>1)^mag01[y&0x1];}
y=(this.mt[this.N-1]&this.UPPER_MASK)|(this.mt[0]&this.LOWER_MASK);this.mt[this.N-1]=this.mt[this.M-1]^(y>>>1)^mag01[y&0x1];this.mti=0;}
y=this.mt[this.mti++];y^=(y>>>11);y^=(y<<7)&0x9d2c5680;y^=(y<<15)&0xefc60000;y^=(y>>>18);return y>>>0;}
MersenneTwister.prototype.random_int31=function(){return(this.random_int()>>>1);}
MersenneTwister.prototype.random_incl=function(){return this.random_int()*(1.0/4294967295.0);}
MersenneTwister.prototype.random=function(){return this.random_int()*(1.0/4294967296.0);}
MersenneTwister.prototype.random_excl=function(){return(this.random_int()+0.5)*(1.0/4294967296.0);}
MersenneTwister.prototype.random_long=function(){var a=this.random_int()>>>5,b=this.random_int()>>>6;return(a*67108864.0+b)*(1.0/9007199254740992.0);}
function polyfill(){twister=new MersenneTwister();if(!crypto)crypto=global.crypto={};crypto.getRandomValues=function getRandomValues(abv){var l=abv.length
while(l--){abv[l]=Math.floor(twister.random()*256)}
return abv}
if(!global.Uint8Array&&!Uint8Array)throw new Error('crypto.rand: No Uint8Array found!');if(!global.Uint8Array)global.Uint8Array=Uint8Array;}
function randomByte(min,max){if(!twister)twister=new MersenneTwister();return Math.floor(twister.random()*(max-min))+min;}
function randomBytes(size,cb){if(size>65536)throw new Error('requested too many random bytes')
if(!crypto||!crypto.getRandomValues)polyfill();var rawBytes=new global.Uint8Array(size);if(size>0){crypto.getRandomValues(rawBytes);}
var bytes=new Buffer(rawBytes);if(typeof cb==='function'){cb(null,bytes)}
return bytes}
module.exports={randomByte:randomByte,randomBytes:randomBytes}};BundleModuleCode['jam/conf']=function(module,exports){var Json=Require('jam/jsonfn');var Comp=Require('com/compat');var current=none;var Aios=none;var act={add:function(act,code){if(typeof code=='function')current.process.agent.act[act]=code;else if(typeof code=='string'){with(current.process.mask){current.process.agent.act[act]=eval(code);}}
current.process.mask[act]=act;},delete:function(act){if(Comp.obj.isArray(act))Comp.array.iter(act,function(a){current.process.agent.act[a]=undefined});else current.process.agent.act[act]=undefined},update:function(act,code){if(typeof code=='function')current.process.agent.act[act]=code;else if(typeof code=='string')current.process.agent.act[act]=Json.parse(code,current.process.mask);}};var __eval=eval;function sandBoxCode(mask,code){var __code;with(mask){__code=__eval('__code='+code);}
return __code;}
var trans={add:function(from,cond,data){if(current.process.agent.trans[from]){function wrap(s){return s[0]=='"'||s[0]=="'"?s:'"'+s+'"'};var old=current.process.agent.trans[from];if(typeof old!='function')old='function () { return'+wrap(old)+'}';else old=old.toString();if(typeof cond!='function')cond='function () { return'+wrap(cond)+'}';else cond=cond.toString();if(data)data=JSON.stringify(data);else data='null';var merged='function () { var next = ('+cond+').call(this,'+data+'); if (next) return next; else return ('+old+').call(this) }';var code=sandBoxCode(current.process.mask,merged);current.process.agent.trans[from]=code;}else current.process.agent.trans[from]=cond;},delete:function(trans){if(Comp.obj.isArray(trans))Comp.array.iter(trans,function(t){current.process.agent.trans[t]=undefined});else current.process.agent.trans[trans]=undefined},update:function(from,cond){current.process.agent.trans[from]=cond;}}
module.exports={agent:{act:act,trans:trans},current:function(module){current=module.current;Aios=module;}}};BundleModuleCode['jam/jsonfn']=function(module,exports){var current=null;function typedarrayTObase64(ta,ftyp){var b,i;if(ta.buffer instanceof ArrayBuffer){b=Buffer(ta.buffer);if(b.length>0)return b.toString('base64');}
switch(ftyp){case Float32Array:b=Buffer(ta.length*4);for(i=0;i<ta.length;i++)b.writeFloatLE(ta[i],i*4);return b.toString('base64');case Float64Array:b=Buffer(ta.length*8);for(i=0;i<ta.length;i++)b.writeDoubleLE(ta[i],i*8);return b.toString('base64');case Int16Array:b=Buffer(ta.length*2);for(i=0;i<ta.length;i++)b.writeInt16LE(ta[i],i*2);return b.toString('base64');case Int32Array:b=Buffer(ta.length*4);for(i=0;i<ta.length;i++)b.writeInt32LE(ta[i],i*4);return b.toString('base64');}
return ta.toString();}
function base64TOtypedarray(buff,ftyp){var i,ta;if(buff.buffer instanceof ArrayBuffer){switch(ftyp){case Float32Array:return new Float32Array((new Uint8Array(buff)).buffer);case Float64Array:return new Float64Array((new Uint8Array(buff)).buffer);case Int16Array:return new Int16Array((new Uint8Array(buff)).buffer);case Int32Array:return new Int32Array((new Uint8Array(buff)).buffer);}}else if(typeof Uint8Array.from!='undefined'){switch(ftyp){case Float32Array:return new Float32Array(Uint8Array.from(buff).buffer);case Float64Array:return new Float64Array(Uint8Array.from(buff).buffer);case Int16Array:return new Int16Array(Uint8Array.from(buff).buffer);case Int32Array:return new Int32Array(Uint8Array.from(buff).buffer);}}else{switch(ftyp){case Float32Array:ta=new Float32Array(buff.length/4);for(i=0;i<ta.length;i++)
ta[i]=buff.readFloatLE(i*4);return ta;case Float64Array:ta=new Float64Array(buff.length/8);for(i=0;i<ta.length;i++)
ta[i]=buff.readDoubleLE(i*8);return ta;case Int16Array:ta=new Int16Array(buff.length/2);for(i=0;i<ta.length;i++)
ta[i]=buff.readInt16LE(i*2);return ta;case Int32Array:ta=new Int32Array(buff.length/4);for(i=0;i<ta.length;i++)
ta[i]=buff.readInt32LE(i*4);return ta;}}}
(function(exports){function stringify(obj){return JSON.stringify(obj,function(key,value){if(value instanceof Function||typeof value=='function')
return'_PxEnUf_'+Buffer(value.toString(true)).toString('base64');if(value instanceof Buffer)
return'_PxEfUb_'+value.toString('base64');if(typeof Float64Array!='undefined'&&value instanceof Float64Array)
return'_PxE6Lf_'+typedarrayTObase64(value,Float64Array);if(typeof Float32Array!='undefined'&&value instanceof Float32Array)
return'_PxE3Lf_'+typedarrayTObase64(value,Float32Array);if(typeof Int16Array!='undefined'&&value instanceof Int16Array)
return'_PxE1Ni_'+typedarrayTObase64(value,Int16Array);if(typeof Int32Array!='undefined'&&value instanceof Int32Array)
return'_PxE3Ni_'+typedarrayTObase64(value,Int32Array);if(value instanceof RegExp)
return'_PxEgEr_'+value;return value;});};function parse(str,mask){var code;try{with(mask||{}){code=JSON.parse(str,function(key,value){var prefix;try{if(typeof value!='string'){return value;}
if(value.length<8){return value;}
prefix=value.substring(0,8);if(prefix==='_PxEnUf_'){var code=value.slice(8);if(code.indexOf('function')==0)
return eval('('+code+')');else
return eval('('+Buffer(code,'base64').toString()+')');}
if(prefix==='_PxEfUb_')
return Buffer(value.slice(8),'base64');if(prefix==='_PxE6Lf_')
return base64TOtypedarray(Buffer(value.slice(8),'base64'),Float64Array);if(prefix==='_PxE3Lf_')
return base64TOtypedarray(Buffer(value.slice(8),'base64'),Float32Array);if(prefix==='_PxE1Ni_')
return base64TOtypedarray(Buffer(value.slice(8),'base64'),Int16Array);if(prefix==='_PxE3Ni_')
return base64TOtypedarray(Buffer(value.slice(8),'base64'),Int32Array);if(prefix==='_PxEgEr_')
return eval(value.slice(8));return value;}catch(e){throw{error:e,value:value};}});};}catch(e){throw e.error||e;}
return code;};exports.clone=function(obj,date2obj){return exports.parse(exports.stringify(obj),date2obj);};exports.current=function(module){current=module.current;};exports.serialize=stringify;exports.stringify=stringify;exports.deserialize=parse;exports.parse=parse;if(typeof Buffer!='undefined'&&Buffer.prototype.toJSON)delete Buffer.prototype.toJSON;if(typeof buffer=='object'&&buffer.Buffer)delete buffer.Buffer.prototype.toJSON;}(typeof exports==='undefined'?(window.JSONfn={}):exports));};BundleModuleCode['jam/code']=function(module,exports){var options={debug:{},compactit:false,version:'1.11.2'}
var minify=Require('com/minify');var Esprima=Require('parser/esprima');try{var M=process.binding('minify');Function.prototype._toString=Function.prototype.toString;Function.prototype.toString=function(compact){return compact?M.minify(this._toString()):this._toString();}
options.minifier=true;options.minifyC=true;minify=M.minify;}catch(e){Function.prototype._toString=Function.prototype.toString;Function.prototype.toString=function(compact){return compact?minify(this._toString()):this._toString();}
options.minifier=true;};var Io=Require('com/io');var Json=Require('jam/jsonfn');var Comp=Require('com/compat');var sandbox=Require('jam/sandbox')();var current=none;var Aios=none;var util=Require('util');function _testac(p1,p2){this.x=p1;this.y=p2;this.z=0;this.act={init:function(){this.z=this.x;this.x++;}}}
var _testobj=new _testac(1,2);options.compactit=Json.stringify(_testobj).length>93;var inject={cp:undefined,rt:undefined};function construct(constructor,argArray){var inst=Object.create(constructor.prototype);constructor.apply(inst,argArray);return inst;}
function copyProcess(process){var _process,_agent,agent=process.agent,mask=process.mask;process.node.stats.fastcopy++;agent.process={};for(var p in process){switch(p){case'schedule':if(process.schedule.length>0)
agent.process[p]=process.schedule;break;case'blocked':if(agent.process.suspended==true)
agent.process[p]=true;break;case'gid':case'pid':break;case'back':case'dir':agent.process[p]=process[p];break;}}
if(Comp.obj.isEmpty(agent.process))agent['process']=undefined;agent['self']=undefined;_agent=Comp.obj.copy(agent);if(!_agent.process)
_process=Aios.Proc.Proc({mask:mask,agent:_agent});else{_process=Aios.Proc.Proc(agent.process);_process.init({timeout:0,schedule:[],blocked:false,mask:mask,agent:_agent});_agent['process']=undefined;}
agent['self']=agent;return _process;}
function className(f){var name=f.toString().match(/[\s]*function[\s]*([a-z0-9]+)[\s]*\(/);return name?name[1]:"unknown"}
function create(constructor,args,level,className){return createOn(current.node,constructor,args,level,className);}
function createOn(node,constructor,args,level,className){if(!constructor.fun&&!Comp.obj.isFunction(constructor)){Aios.err('Code.create: No valid constructor function specified.');return;}
var code,agent0,agent,process,_process;_process=current.process;current.process={timeout:0};if(level==undefined)level=Aios.options.LEVEL;try{if(!constructor.fun)
constructor=makeSandbox(constructor,level);if(!(args instanceof Array))args=[args];agent0=construct(constructor.fun,args);if(!agent0){Aios.err('Code.createOn ('+className+'): Agent constructor failed.');current.process=_process;return null;}
process=makeProcess(agent0,constructor.mask);process.resources.memory=constructor.size||0;current.process=_process;}catch(e){current.process=_process;Aios.err('Code.createOn ('+className+'): '+e);return;}
agent=process.agent;if(!Comp.obj.isArray(args)&&Comp.obj.isObject(args))
for(var p in args){if(Comp.obj.hasProperty(agent,p))agent[p]=args[p];}
if(!agent['next']||!agent['trans']||!agent['act']){Aios.err('Code.createOn: Missing next/trans/act attribute in agent constructor '+className);return none;}
process.level=level;agent['self']=agent;if(className)agent['ac']=className;node.register(process);node.stats.create++;return process;}
function createAndReturn(constructor,ac,args,level){if(!(args instanceof Array))args=[args];var process,agent,code=ofCode({agent:construct(constructor,args)},true);if(level==undefined)level=Aios.options.LEVEL;process=toCode(code,level);agent=process.agent;agent.id=Aios.aidgen();agent.ac=ac;return{code:ofCode(process,false),process:process};}
function forkCode(process){var code='',p;var agent=process.agent;var self=agent.self;agent['process']=undefined;agent['self']=undefined;code=Aios.options.json?Json.stringify(agent):toString(agent);agent.process=process;agent.self=self;if(inject.cp||inject.rt)
code=removeInjection(code);return code;}
function ofCode(process,clean){var code='',p;var agent=process.agent;agent.process={};for(var p in process){switch(p){case'schedule':if(process.schedule.length>0)
agent.process[p]=process.schedule;break;case'blocked':if(agent.process.suspended==true)
agent.process[p]=true;break;case'gid':case'pid':break;case'back':case'dir':agent.process[p]=process[p];break;}}
if(Comp.obj.isEmpty(agent.process))agent['process']=undefined;agent['self']=undefined;try{code=Aios.options.json?Json.stringify(agent):toString(agent);}catch(e){throw'Code.ofCode: Code-Text serialization failed ('+e.toString()+')';}
if(clean&&!options.compactit)return code;if(!clean&&(inject.cp||inject.rt))
code=removeInjection(code);if(options.compactit)code=minimize(code);return code;}
function ofObject(agent){var process;if(!agent.process)
process=Aios.Proc.Proc({mask:agent.mask,agent:agent});else{process=Aios.Proc.Proc(agent.process);process.init({timeout:0,schedule:[],blocked:false,mask:agent.mask,agent:agent});agent['process']=undefined;}
agent['mask']=undefined;process.node.stats.fastcopy++;return process;}
function ofString(source,mask){var code;try{with(mask){eval('"use strict"; code = '+source);}}catch(e){console.log(e)};return code;}
function makeProcess(agent,mask){var process;if(mask)for(var p in agent.act){mask[p]=p;}
if(!agent.process)
process=Aios.Proc.Proc({mask:mask,agent:agent});else{process=Aios.Proc.Proc(agent.process);process.init({timeout:0,schedule:[],blocked:false,mask:mask,agent:agent});agent['process']=undefined;}
agent['self']=agent;return process;}
function makeSandbox(constructor,level,env){var _process,sac,aios;switch(level){case 0:aios=Aios.aios0;break;case 1:aios=Aios.aios1;break;case 2:aios=Aios.aios2;break;case 3:aios=Aios.aios3;break;default:aios=Aios.aios0;break;}
_process=current.process;current.process={timeout:0};sac=sandbox(constructor,aios,inject,env);current.process=_process;return sac;}
function minimize(code){return minify(code)}
function print(agent,compact){var process=agent.process;var self=agent.self;agent['process']=undefined;agent['self']=undefined;var text=Aios.options.json?Json.stringify(agent):toString(agent);agent.process=process;agent.self=self;if(!text)return'undefined';var regex4=/\\n/g;if(inject.cp||inject.rt)
text=removeInjection(text);if(compact&&options.compactit)
text=minimize(text);return text.replace(regex4,'\n');}
function removeInjection(text){if(inject.cp){var regex1=/CP\(\);/g;var regex2=/\(\(([^\)]+)\)\s&&\sCP\(\)\)/g;var regex3=/,CP\(\)/g;text=text.replace(regex1,"").replace(regex2,"($1)").replace(regex3,"");}
if(inject.rt){var regex4=/RT\(\);/g;text=text.replace(regex4,"");}
return text;}
function size(agent){var text='',p;var process=agent.process;var self=agent.self;agent['process']=undefined;agent['self']=undefined;text=Aios.options.json?Json.stringify(agent):toString(agent);agent.process=process;agent.self=self;if(inject.cp||inject.rt){text=removeInjection(text);}
return text.length;}
function test(what){switch(what){case'minify':if(minify.test)minify.test();break;}}
function toCode(text,level){var agent,process,p,aios,next;switch(level){case undefined:case 0:aios=Aios.aios0;break;case 1:aios=Aios.aios1;break;case 2:aios=Aios.aios2;break;case 3:aios=Aios.aios3;break;default:aios=Aios.aios0;break;}
if(inject.cp){var regex1=/while[\s]*\(([^\'")]+)\)/g;var regex2=/for[\s]*\(([^\)'"]+)\)/g;var regex3=/function([^\{'"]+)\{/g;text=text.replace(regex1,"while (($1) && CP())").replace(regex2,"for ($1,CP())").replace(regex3,"function $1{CP();");}
if(inject.rt){var regex4=/catch[\s]*\([\s]*([a-zA-Z0-9_]+)[\s]*\)[\s]*\{/g;text=text.replace(regex4,'catch ($1) {'+inject.rt+'($1);');}
var mask={current:undefined,require:undefined};for(p in this)
mask[p]=undefined;for(p in global)
mask[p]=undefined;for(p in aios){mask[p]=aios[p];}
var isjson=Comp.string.startsWith(text,'{"');try{agent=isjson?Json.parse(text,mask):ofString(text,mask);}
catch(e){if(Aios.options.verbose)Aios.log('Aios.code.toCode: '+e+(current.error?(',\nin: '+current.error):''));return null;}
if(!agent){var more;try{var ast=Esprima.parse('code='+text,{tolerant:true,loc:true});if(ast.errors&&ast.errors.length>0)console.log(ast.errors[0]);}catch(e){console.log(e);}
__LASTCODE=text;return Aios.log('Aios.code.toCode: Invalid agent code received (invalid source text?) See __LASTCODE');}
for(var p in agent.act){mask[p]=p;}
if(!agent.process)
process=Aios.Proc.Proc({mask:mask,agent:agent});else{process=Aios.Proc.Proc(agent.process);process.init({timeout:0,schedule:[],blocked:false,mask:mask,agent:agent});agent['process']=undefined;}
process.level=level;process.resources.memory=text.length;agent['self']=agent;return process;}
function toObject(process){var _process,_agent,agent=process.agent,mask=process.mask;agent.process={};for(var p in process){switch(p){case'schedule':if(process.schedule.length>0)
agent.process[p]=process.schedule;break;case'blocked':if(agent.process.suspended==true)
agent.process[p]=true;break;case'gid':case'pid':break;case'back':case'dir':agent.process[p]=process[p];break;}}
if(Comp.obj.isEmpty(agent.process))agent['process']=undefined;agent['self']=undefined;_agent=Comp.obj.copy(agent);_agent.mask=mask;agent['self']=agent;return _agent;}
function toString(o){var p,i,s='',sep;if(Comp.obj.isArray(o)){s='[';sep='';for(p in o){s=s+sep+toString(o[p]);sep=',';}
s+=']';}else if(o instanceof Buffer){s='[';sep='';for(i=0;i<o.length;i++){s=s+sep+toString(o[i]);sep=',';}
s+=']';}else if(typeof o=='object'){s='{';sep='';for(p in o){if(o[p]==undefined)continue;s=s+sep+"'"+p+"'"+':'+toString(o[p]);sep=',';}
s+='}';}else if(typeof o=='string')
s="'"+o.toString()+"'";else if(typeof o=='function')
s=o.toString(true);else if(o!=undefined)
s=o.toString();else s='undefined';return s;}
module.exports={className:className,copyProcess:copyProcess,create:create,createAndReturn:createAndReturn,createOn:createOn,forkCode:forkCode,ofCode:ofCode,ofObject:ofObject,ofString:ofString,inject:inject,Jsonf:Json,makeProcess:makeProcess,makeSandbox:makeSandbox,minimize:minimize,print:print,size:size,test:test,toCode:toCode,toObject:toObject,toString:toString,options:options,current:function(module){current=module.current;Aios=module;inject.cp=(Aios.watchdog&&!Aios.watchdog.checkPoint)?undefined:'CP';inject.rt=(Aios.watchdog&&Aios.watchdog.protect)?undefined:'RT';if(inject.cp||inject.rt)options.inject=inject;}}};BundleModuleCode['com/minify']=function(module,exports){var EOF=null;var theA;var theB;var theLookahead=EOF;var theX=EOF;var theY=EOF;var theInbuf=null;var theOutbuf=null;var theInbufIndex=0;var theOutbufIndex=0;function isAlphanum(c)
{return((c>='a'&&c<='z')||(c>='0'&&c<='9')||(c>='A'&&c<='Z')||c=='_'||c=='$'||c=='\\'||c>String.fromCharCode(126));}
function get(){var c=theLookahead;theLookahead=EOF;if(c==EOF){c=theInbuf[theInbufIndex++];}
if(c>=' '||c=='\n'||c==EOF){return c;}
if(c=='\r'){return'\n';}
return' ';}
function put(c){theOutbuf+=c;}
function peek()
{theLookahead=get();return theLookahead;}
function error(msg){throw msg}
function next()
{var c=get();if(c=='/'){switch(peek()){case'/':for(;;){c=get();if(c<='\n'){break;}}
break;case'*':get();while(c!=' '){switch(get()){case'*':if(peek()=='/'){get();c=' ';}
break;case EOF:error("Unterminated comment.");}}
break;}}
theY=theX;theX=c;return c;}
function action(d)
{switch(d){case 1:put(theA);if((theY=='\n'||theY==' ')&&(theA=='+'||theA=='-'||theA=='*'||theA=='/')&&(theB=='+'||theB=='-'||theB=='*'||theB=='/')){put(theY);}
case 2:theA=theB;if(theA=='\''||theA=='"'||theA=='`'){for(;;){put(theA);theA=get();if(theA==theB){break;}
if(theA=='\\'){put(theA);theA=get();}
if(theA==EOF){error("Unterminated string literal.");}}}
case 3:theB=next();if(theB=='/'&&(theA=='('||theA==','||theA=='='||theA==':'||theA=='['||theA=='!'||theA=='&'||theA=='|'||theA=='?'||theA=='+'||theA=='-'||theA=='~'||theA=='*'||theA=='/'||theA=='{'||theA=='\n')){put(theA);if(theA=='/'||theA=='*'){put(' ');}
put(theB);for(;;){theA=get();if(theA=='['){for(;;){put(theA);theA=get();if(theA==']'){break;}
if(theA=='\\'){put(theA);theA=get();}
if(theA==EOF){error("Unterminated set in Regular Expression literal.");}}}else if(theA=='/'){switch(peek()){case'/':case'*':error("Unterminated set in Regular Expression literal.");break;case'\n':put(theA);theA='\n';}
break;}else if(theA=='\\'){put(theA);theA=get();}
if(theA==EOF){error("Unterminated Regular Expression literal.");}
put(theA);}
theB=next();}}}
function minify(text){theA=0;theB=0;theLookahead=EOF;theX=EOF;theY=EOF;theInbuf=text;theInbufIndex=0;theOutbuf='';if(peek()==0xEF){get();get();get();}
theA=get();action(3);while(theA!=EOF){switch(theA){case' ':action(isAlphanum(theB)?1:2);break;case'\n':switch(theB){case'{':case'[':case'(':case'+':case'-':case'!':case'~':action(1);break;case' ':action(3);break;default:action(isAlphanum(theB)?1:2);}
break;default:switch(theB){case' ':action(isAlphanum(theA)?1:3);break;case'\n':switch(theA){case'}':case']':case')':case'+':case'-':case'"':case'\'':case'`':action(1);break;default:action(isAlphanum(theA)?1:3);}
break;default:action(1);break;}}}
return theOutbuf;}
function minimize0(code){var regex4=/\/\*([\S\s]*?)\*\//g;var regex5=/([^\\}])\\n/g;var regex6=/\/\/[^\n]+/g;var regex7=/[ ]*([{},; ]|else)[ ]*\n[\n]*/g;var regex8=/([^\'"]+)|([\'"](?:[^\'"\\]|\\.)+[\'"])/g;var regex9=/ [ ]+/g;var regex10=/}\s+(?!else|finally|catch)([a-zA-Z_]+)/g;var regex11=/\)\s+([a-zA-Z_]+)/g;code=code.replace(regex4,"").replace(regex5,'$1\n').replace(regex5,'$1\n').replace(regex6,"").replace(regex7,"$1").replace(regex8,function($0,$1,$2){if($1){return $1.replace(regex9,' ').replace(regex10,'};$1').replace(regex11,')\n$1');}else{return $2;}});return code;}
function test(){var n=1E4;var text=minify.toString();var t0=Date.now()
for(var i=0;i<n;i++){minify(text);}
var t1=Date.now();console.log('minify: '+((t1-t0)/n/text.length*1000)+' us/char');var t0=Date.now()
for(var i=0;i<n;i++){minimize0(text);}
var t1=Date.now();console.log('minimize0: '+((t1-t0)/n/text.length*1000)+' us/char');try{var M=process.binding('minify');var t0=Date.now()
for(var i=0;i<n;i++){M.minify(text);}
var t1=Date.now();console.log('minifyC: '+((t1-t0)/n/text.length*1000)+' us/char');}catch(e){}}
minify.test=test;module.exports=minify;};BundleModuleCode['parser/esprima']=function(module,exports){(function(root,factory){'use strict';if(typeof define==='function'&&define.amd){define(['exports'],factory);}else if(typeof exports!=='undefined'){factory(exports);}else{factory((root.esprima={}));}}(this,function(exports){'use strict';var Token,TokenName,FnExprTokens,Syntax,PlaceHolders,Messages,Regex,source,strict,index,lineNumber,lineStart,hasLineTerminator,lastIndex,lastLineNumber,lastLineStart,startIndex,startLineNumber,startLineStart,scanning,length,lookahead,state,extra,isBindingElement,isAssignmentTarget,firstCoverInitializedNameError;Token={BooleanLiteral:1,EOF:2,Identifier:3,Keyword:4,NullLiteral:5,NumericLiteral:6,Punctuator:7,StringLiteral:8,RegularExpression:9,Template:10};TokenName={};TokenName[Token.BooleanLiteral]='Boolean';TokenName[Token.EOF]='<end>';TokenName[Token.Identifier]='Identifier';TokenName[Token.Keyword]='Keyword';TokenName[Token.NullLiteral]='Null';TokenName[Token.NumericLiteral]='Numeric';TokenName[Token.Punctuator]='Punctuator';TokenName[Token.StringLiteral]='String';TokenName[Token.RegularExpression]='RegularExpression';TokenName[Token.Template]='Template';FnExprTokens=['(','{','[','in','typeof','instanceof','new','return','case','delete','throw','void','=','+=','-=','*=','/=','%=','<<=','>>=','>>>=','&=','|=','^=',',','+','-','*','/','%','++','--','<<','>>','>>>','&','|','^','!','~','&&','||','?',':','===','==','>=','<=','<','>','!=','!=='];Syntax={AssignmentExpression:'AssignmentExpression',AssignmentPattern:'AssignmentPattern',ArrayExpression:'ArrayExpression',ArrayPattern:'ArrayPattern',ArrowFunctionExpression:'ArrowFunctionExpression',BlockStatement:'BlockStatement',BinaryExpression:'BinaryExpression',BreakStatement:'BreakStatement',CallExpression:'CallExpression',CatchClause:'CatchClause',ClassBody:'ClassBody',ClassDeclaration:'ClassDeclaration',ClassExpression:'ClassExpression',ConditionalExpression:'ConditionalExpression',ContinueStatement:'ContinueStatement',DoWhileStatement:'DoWhileStatement',DebuggerStatement:'DebuggerStatement',EmptyStatement:'EmptyStatement',ExportAllDeclaration:'ExportAllDeclaration',ExportDefaultDeclaration:'ExportDefaultDeclaration',ExportNamedDeclaration:'ExportNamedDeclaration',ExportSpecifier:'ExportSpecifier',ExpressionStatement:'ExpressionStatement',ForStatement:'ForStatement',ForOfStatement:'ForOfStatement',ForInStatement:'ForInStatement',FunctionDeclaration:'FunctionDeclaration',FunctionExpression:'FunctionExpression',Identifier:'Identifier',IfStatement:'IfStatement',ImportDeclaration:'ImportDeclaration',ImportDefaultSpecifier:'ImportDefaultSpecifier',ImportNamespaceSpecifier:'ImportNamespaceSpecifier',ImportSpecifier:'ImportSpecifier',Literal:'Literal',LabeledStatement:'LabeledStatement',LogicalExpression:'LogicalExpression',MemberExpression:'MemberExpression',MetaProperty:'MetaProperty',MethodDefinition:'MethodDefinition',NewExpression:'NewExpression',ObjectExpression:'ObjectExpression',ObjectPattern:'ObjectPattern',Program:'Program',Property:'Property',RestElement:'RestElement',ReturnStatement:'ReturnStatement',SequenceExpression:'SequenceExpression',SpreadElement:'SpreadElement',Super:'Super',SwitchCase:'SwitchCase',SwitchStatement:'SwitchStatement',TaggedTemplateExpression:'TaggedTemplateExpression',TemplateElement:'TemplateElement',TemplateLiteral:'TemplateLiteral',ThisExpression:'ThisExpression',ThrowStatement:'ThrowStatement',TryStatement:'TryStatement',UnaryExpression:'UnaryExpression',UpdateExpression:'UpdateExpression',VariableDeclaration:'VariableDeclaration',VariableDeclarator:'VariableDeclarator',WhileStatement:'WhileStatement',WithStatement:'WithStatement',YieldExpression:'YieldExpression'};PlaceHolders={ArrowParameterPlaceHolder:'ArrowParameterPlaceHolder'};Messages={UnexpectedToken:'Unexpected token %0',UnexpectedNumber:'Unexpected number',UnexpectedString:'Unexpected string',UnexpectedIdentifier:'Unexpected identifier',UnexpectedReserved:'Unexpected reserved word',UnexpectedTemplate:'Unexpected quasi %0',UnexpectedEOS:'Unexpected end of input',NewlineAfterThrow:'Illegal newline after throw',InvalidRegExp:'Invalid regular expression',UnterminatedRegExp:'Invalid regular expression: missing /',InvalidLHSInAssignment:'Invalid left-hand side in assignment',InvalidLHSInForIn:'Invalid left-hand side in for-in',InvalidLHSInForLoop:'Invalid left-hand side in for-loop',MultipleDefaultsInSwitch:'More than one default clause in switch statement',NoCatchOrFinally:'Missing catch or finally after try',UnknownLabel:'Undefined label \'%0\'',Redeclaration:'%0 \'%1\' has already been declared',IllegalContinue:'Illegal continue statement',IllegalBreak:'Illegal break statement',IllegalReturn:'Illegal return statement',StrictModeWith:'Strict mode code may not include a with statement',StrictCatchVariable:'Catch variable may not be eval or arguments in strict mode',StrictVarName:'Variable name may not be eval or arguments in strict mode',StrictParamName:'Parameter name eval or arguments is not allowed in strict mode',StrictParamDupe:'Strict mode function may not have duplicate parameter names',StrictFunctionName:'Function name may not be eval or arguments in strict mode',StrictOctalLiteral:'Octal literals are not allowed in strict mode.',StrictDelete:'Delete of an unqualified identifier in strict mode.',StrictLHSAssignment:'Assignment to eval or arguments is not allowed in strict mode',StrictLHSPostfix:'Postfix increment/decrement may not have eval or arguments operand in strict mode',StrictLHSPrefix:'Prefix increment/decrement may not have eval or arguments operand in strict mode',StrictReservedWord:'Use of future reserved word in strict mode',TemplateOctalLiteral:'Octal literals are not allowed in template strings.',ParameterAfterRestParameter:'Rest parameter must be last formal parameter',DefaultRestParameter:'Unexpected token =',ObjectPatternAsRestParameter:'Unexpected token {',DuplicateProtoProperty:'Duplicate __proto__ fields are not allowed in object literals',ConstructorSpecialMethod:'Class constructor may not be an accessor',DuplicateConstructor:'A class may only have one constructor',StaticPrototype:'Classes may not have static property named prototype',MissingFromClause:'Unexpected token',NoAsAfterImportNamespace:'Unexpected token',InvalidModuleSpecifier:'Unexpected token',IllegalImportDeclaration:'Unexpected token',IllegalExportDeclaration:'Unexpected token',DuplicateBinding:'Duplicate binding %0'};Regex={NonAsciiIdentifierStart:/[\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0-\u08B2\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303C\u3041-\u3096\u309B-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6EF\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uAB65\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDE80-\uDE9C\uDEA0-\uDED0\uDF00-\uDF1F\uDF30-\uDF4A\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE33\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE4\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48]|\uD804[\uDC03-\uDC37\uDC83-\uDCAF\uDCD0-\uDCE8\uDD03-\uDD26\uDD50-\uDD72\uDD76\uDD83-\uDDB2\uDDC1-\uDDC4\uDDDA\uDE00-\uDE11\uDE13-\uDE2B\uDEB0-\uDEDE\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3D\uDF5D-\uDF61]|\uD805[\uDC80-\uDCAF\uDCC4\uDCC5\uDCC7\uDD80-\uDDAE\uDE00-\uDE2F\uDE44\uDE80-\uDEAA]|\uD806[\uDCA0-\uDCDF\uDCFF\uDEC0-\uDEF8]|\uD808[\uDC00-\uDF98]|\uD809[\uDC00-\uDC6E]|[\uD80C\uD840-\uD868\uD86A-\uD86C][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDED0-\uDEED\uDF00-\uDF2F\uDF40-\uDF43\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDF00-\uDF44\uDF50\uDF93-\uDF9F]|\uD82C[\uDC00\uDC01]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB]|\uD83A[\uDC00-\uDCC4]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D]|\uD87E[\uDC00-\uDE1D]/,NonAsciiIdentifierPart:/[\xAA\xB5\xB7\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0300-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0561-\u0587\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u05D0-\u05EA\u05F0-\u05F2\u0610-\u061A\u0620-\u0669\u066E-\u06D3\u06D5-\u06DC\u06DF-\u06E8\u06EA-\u06FC\u06FF\u0710-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u0800-\u082D\u0840-\u085B\u08A0-\u08B2\u08E4-\u0963\u0966-\u096F\u0971-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09F1\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AEF\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B6F\u0B71\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BEF\u0C00-\u0C03\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58\u0C59\u0C60-\u0C63\u0C66-\u0C6F\u0C81-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2\u0D01-\u0D03\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D57\u0D60-\u0D63\u0D66-\u0D6F\u0D7A-\u0D7F\u0D82\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2\u0DF3\u0E01-\u0E3A\u0E40-\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB9\u0EBB-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F29\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F71-\u0F84\u0F86-\u0F97\u0F99-\u0FBC\u0FC6\u1000-\u1049\u1050-\u109D\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1369-\u1371\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1714\u1720-\u1734\u1740-\u1753\u1760-\u176C\u176E-\u1770\u1772\u1773\u1780-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u180B-\u180D\u1810-\u1819\u1820-\u1877\u1880-\u18AA\u18B0-\u18F5\u1900-\u191E\u1920-\u192B\u1930-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19DA\u1A00-\u1A1B\u1A20-\u1A5E\u1A60-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1B00-\u1B4B\u1B50-\u1B59\u1B6B-\u1B73\u1B80-\u1BF3\u1C00-\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1CD0-\u1CD2\u1CD4-\u1CF6\u1CF8\u1CF9\u1D00-\u1DF5\u1DFC-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u200C\u200D\u203F\u2040\u2054\u2071\u207F\u2090-\u209C\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D7F-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2DE0-\u2DFF\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA674-\uA67D\uA67F-\uA69D\uA69F-\uA6F1\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA827\uA840-\uA873\uA880-\uA8C4\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA900-\uA92D\uA930-\uA953\uA960-\uA97C\uA980-\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA36\uAA40-\uAA4D\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEF\uAAF2-\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uAB65\uABC0-\uABEA\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE00-\uFE0F\uFE20-\uFE2D\uFE33\uFE34\uFE4D-\uFE4F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3F\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDDFD\uDE80-\uDE9C\uDEA0-\uDED0\uDEE0\uDF00-\uDF1F\uDF30-\uDF4A\uDF50-\uDF7A\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCA0-\uDCA9\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00-\uDE03\uDE05\uDE06\uDE0C-\uDE13\uDE15-\uDE17\uDE19-\uDE33\uDE38-\uDE3A\uDE3F\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE6\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48]|\uD804[\uDC00-\uDC46\uDC66-\uDC6F\uDC7F-\uDCBA\uDCD0-\uDCE8\uDCF0-\uDCF9\uDD00-\uDD34\uDD36-\uDD3F\uDD50-\uDD73\uDD76\uDD80-\uDDC4\uDDD0-\uDDDA\uDE00-\uDE11\uDE13-\uDE37\uDEB0-\uDEEA\uDEF0-\uDEF9\uDF01-\uDF03\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3C-\uDF44\uDF47\uDF48\uDF4B-\uDF4D\uDF57\uDF5D-\uDF63\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC80-\uDCC5\uDCC7\uDCD0-\uDCD9\uDD80-\uDDB5\uDDB8-\uDDC0\uDE00-\uDE40\uDE44\uDE50-\uDE59\uDE80-\uDEB7\uDEC0-\uDEC9]|\uD806[\uDCA0-\uDCE9\uDCFF\uDEC0-\uDEF8]|\uD808[\uDC00-\uDF98]|\uD809[\uDC00-\uDC6E]|[\uD80C\uD840-\uD868\uD86A-\uD86C][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE60-\uDE69\uDED0-\uDEED\uDEF0-\uDEF4\uDF00-\uDF36\uDF40-\uDF43\uDF50-\uDF59\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDF00-\uDF44\uDF50-\uDF7E\uDF8F-\uDF9F]|\uD82C[\uDC00\uDC01]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99\uDC9D\uDC9E]|\uD834[\uDD65-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDE42-\uDE44]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB\uDFCE-\uDFFF]|\uD83A[\uDC00-\uDCC4\uDCD0-\uDCD6]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D]|\uD87E[\uDC00-\uDE1D]|\uDB40[\uDD00-\uDDEF]/};function assert(condition,message){if(!condition){throw new Error('ASSERT: '+message);}}
function isDecimalDigit(ch){return(ch>=0x30&&ch<=0x39);}
function isHexDigit(ch){return'0123456789abcdefABCDEF'.indexOf(ch)>=0;}
function isOctalDigit(ch){return'01234567'.indexOf(ch)>=0;}
function octalToDecimal(ch){var octal=(ch!=='0'),code='01234567'.indexOf(ch);if(index<length&&isOctalDigit(source[index])){octal=true;code=code*8+'01234567'.indexOf(source[index++]);if('0123'.indexOf(ch)>=0&&index<length&&isOctalDigit(source[index])){code=code*8+'01234567'.indexOf(source[index++]);}}
return{code:code,octal:octal};}
function isWhiteSpace(ch){return(ch===0x20)||(ch===0x09)||(ch===0x0B)||(ch===0x0C)||(ch===0xA0)||(ch>=0x1680&&[0x1680,0x180E,0x2000,0x2001,0x2002,0x2003,0x2004,0x2005,0x2006,0x2007,0x2008,0x2009,0x200A,0x202F,0x205F,0x3000,0xFEFF].indexOf(ch)>=0);}
function isLineTerminator(ch){return(ch===0x0A)||(ch===0x0D)||(ch===0x2028)||(ch===0x2029);}
function fromCodePoint(cp){return(cp<0x10000)?String.fromCharCode(cp):String.fromCharCode(0xD800+((cp-0x10000)>>10))+
String.fromCharCode(0xDC00+((cp-0x10000)&1023));}
function isIdentifierStart(ch){return(ch===0x24)||(ch===0x5F)||(ch>=0x41&&ch<=0x5A)||(ch>=0x61&&ch<=0x7A)||(ch===0x5C)||((ch>=0x80)&&Regex.NonAsciiIdentifierStart.test(fromCodePoint(ch)));}
function isIdentifierPart(ch){return(ch===0x24)||(ch===0x5F)||(ch>=0x41&&ch<=0x5A)||(ch>=0x61&&ch<=0x7A)||(ch>=0x30&&ch<=0x39)||(ch===0x5C)||((ch>=0x80)&&Regex.NonAsciiIdentifierPart.test(fromCodePoint(ch)));}
function isFutureReservedWord(id){switch(id){case'enum':case'export':case'import':case'super':return true;default:return false;}}
function isStrictModeReservedWord(id){switch(id){case'implements':case'interface':case'package':case'private':case'protected':case'public':case'static':case'yield':case'let':return true;default:return false;}}
function isRestrictedWord(id){return id==='eval'||id==='arguments';}
function isKeyword(id){switch(id.length){case 2:return(id==='if')||(id==='in')||(id==='do');case 3:return(id==='var')||(id==='for')||(id==='new')||(id==='try')||(id==='let');case 4:return(id==='this')||(id==='else')||(id==='case')||(id==='void')||(id==='with')||(id==='enum');case 5:return(id==='while')||(id==='break')||(id==='catch')||(id==='throw')||(id==='const')||(id==='yield')||(id==='class')||(id==='super');case 6:return(id==='return')||(id==='typeof')||(id==='delete')||(id==='switch')||(id==='export')||(id==='import');case 7:return(id==='default')||(id==='finally')||(id==='extends');case 8:return(id==='function')||(id==='continue')||(id==='debugger');case 10:return(id==='instanceof');default:return false;}}
function addComment(type,value,start,end,loc){var comment;assert(typeof start==='number','Comment must have valid position');state.lastCommentStart=start;comment={type:type,value:value};if(extra.range){comment.range=[start,end];}
if(extra.loc){comment.loc=loc;}
extra.comments.push(comment);if(extra.attachComment){extra.leadingComments.push(comment);extra.trailingComments.push(comment);}
if(extra.tokenize){comment.type=comment.type+'Comment';if(extra.delegate){comment=extra.delegate(comment);}
extra.tokens.push(comment);}}
function skipSingleLineComment(offset){var start,loc,ch,comment;start=index-offset;loc={start:{line:lineNumber,column:index-lineStart-offset}};while(index<length){ch=source.charCodeAt(index);++index;if(isLineTerminator(ch)){hasLineTerminator=true;if(extra.comments){comment=source.slice(start+offset,index-1);loc.end={line:lineNumber,column:index-lineStart-1};addComment('Line',comment,start,index-1,loc);}
if(ch===13&&source.charCodeAt(index)===10){++index;}
++lineNumber;lineStart=index;return;}}
if(extra.comments){comment=source.slice(start+offset,index);loc.end={line:lineNumber,column:index-lineStart};addComment('Line',comment,start,index,loc);}}
function skipMultiLineComment(){var start,loc,ch,comment;if(extra.comments){start=index-2;loc={start:{line:lineNumber,column:index-lineStart-2}};}
while(index<length){ch=source.charCodeAt(index);if(isLineTerminator(ch)){if(ch===0x0D&&source.charCodeAt(index+1)===0x0A){++index;}
hasLineTerminator=true;++lineNumber;++index;lineStart=index;}else if(ch===0x2A){if(source.charCodeAt(index+1)===0x2F){++index;++index;if(extra.comments){comment=source.slice(start+2,index-2);loc.end={line:lineNumber,column:index-lineStart};addComment('Block',comment,start,index,loc);}
return;}
++index;}else{++index;}}
if(extra.comments){loc.end={line:lineNumber,column:index-lineStart};comment=source.slice(start+2,index);addComment('Block',comment,start,index,loc);}
tolerateUnexpectedToken();}
function skipComment(){var ch,start;hasLineTerminator=false;start=(index===0);while(index<length){ch=source.charCodeAt(index);if(isWhiteSpace(ch)){++index;}else if(isLineTerminator(ch)){hasLineTerminator=true;++index;if(ch===0x0D&&source.charCodeAt(index)===0x0A){++index;}
++lineNumber;lineStart=index;start=true;}else if(ch===0x2F){ch=source.charCodeAt(index+1);if(ch===0x2F){++index;++index;skipSingleLineComment(2);start=true;}else if(ch===0x2A){++index;++index;skipMultiLineComment();}else{break;}}else if(start&&ch===0x2D){if((source.charCodeAt(index+1)===0x2D)&&(source.charCodeAt(index+2)===0x3E)){index+=3;skipSingleLineComment(3);}else{break;}}else if(ch===0x3C){if(source.slice(index+1,index+4)==='!--'){++index;++index;++index;++index;skipSingleLineComment(4);}else{break;}}else{break;}}}
function scanHexEscape(prefix){var i,len,ch,code=0;len=(prefix==='u')?4:2;for(i=0;i<len;++i){if(index<length&&isHexDigit(source[index])){ch=source[index++];code=code*16+'0123456789abcdef'.indexOf(ch.toLowerCase());}else{return'';}}
return String.fromCharCode(code);}
function scanUnicodeCodePointEscape(){var ch,code;ch=source[index];code=0;if(ch==='}'){throwUnexpectedToken();}
while(index<length){ch=source[index++];if(!isHexDigit(ch)){break;}
code=code*16+'0123456789abcdef'.indexOf(ch.toLowerCase());}
if(code>0x10FFFF||ch!=='}'){throwUnexpectedToken();}
return fromCodePoint(code);}
function codePointAt(i){var cp,first,second;cp=source.charCodeAt(i);if(cp>=0xD800&&cp<=0xDBFF){second=source.charCodeAt(i+1);if(second>=0xDC00&&second<=0xDFFF){first=cp;cp=(first-0xD800)*0x400+second-0xDC00+0x10000;}}
return cp;}
function getComplexIdentifier(){var cp,ch,id;cp=codePointAt(index);id=fromCodePoint(cp);index+=id.length;if(cp===0x5C){if(source.charCodeAt(index)!==0x75){throwUnexpectedToken();}
++index;if(source[index]==='{'){++index;ch=scanUnicodeCodePointEscape();}else{ch=scanHexEscape('u');cp=ch.charCodeAt(0);if(!ch||ch==='\\'||!isIdentifierStart(cp)){throwUnexpectedToken();}}
id=ch;}
while(index<length){cp=codePointAt(index);if(!isIdentifierPart(cp)){break;}
ch=fromCodePoint(cp);id+=ch;index+=ch.length;if(cp===0x5C){id=id.substr(0,id.length-1);if(source.charCodeAt(index)!==0x75){throwUnexpectedToken();}
++index;if(source[index]==='{'){++index;ch=scanUnicodeCodePointEscape();}else{ch=scanHexEscape('u');cp=ch.charCodeAt(0);if(!ch||ch==='\\'||!isIdentifierPart(cp)){throwUnexpectedToken();}}
id+=ch;}}
return id;}
function getIdentifier(){var start,ch;start=index++;while(index<length){ch=source.charCodeAt(index);if(ch===0x5C){index=start;return getComplexIdentifier();}else if(ch>=0xD800&&ch<0xDFFF){index=start;return getComplexIdentifier();}
if(isIdentifierPart(ch)){++index;}else{break;}}
return source.slice(start,index);}
function scanIdentifier(){var start,id,type;start=index;id=(source.charCodeAt(index)===0x5C)?getComplexIdentifier():getIdentifier();if(id.length===1){type=Token.Identifier;}else if(isKeyword(id)){type=Token.Keyword;}else if(id==='null'){type=Token.NullLiteral;}else if(id==='true'||id==='false'){type=Token.BooleanLiteral;}else{type=Token.Identifier;}
return{type:type,value:id,lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}
function scanPunctuator(){var token,str;token={type:Token.Punctuator,value:'',lineNumber:lineNumber,lineStart:lineStart,start:index,end:index};str=source[index];switch(str){case'(':if(extra.tokenize){extra.openParenToken=extra.tokenValues.length;}
++index;break;case'{':if(extra.tokenize){extra.openCurlyToken=extra.tokenValues.length;}
state.curlyStack.push('{');++index;break;case'.':++index;if(source[index]==='.'&&source[index+1]==='.'){index+=2;str='...';}
break;case'}':++index;state.curlyStack.pop();break;case')':case';':case',':case'[':case']':case':':case'?':case'~':++index;break;default:str=source.substr(index,4);if(str==='>>>='){index+=4;}else{str=str.substr(0,3);if(str==='==='||str==='!=='||str==='>>>'||str==='<<='||str==='>>='){index+=3;}else{str=str.substr(0,2);if(str==='&&'||str==='||'||str==='=='||str==='!='||str==='+='||str==='-='||str==='*='||str==='/='||str==='++'||str==='--'||str==='<<'||str==='>>'||str==='&='||str==='|='||str==='^='||str==='%='||str==='<='||str==='>='||str==='=>'){index+=2;}else{str=source[index];if('<>=!+-*%&|^/'.indexOf(str)>=0){++index;}}}}}
if(index===token.start){throwUnexpectedToken();}
token.end=index;token.value=str;return token;}
function scanHexLiteral(start){var number='';while(index<length){if(!isHexDigit(source[index])){break;}
number+=source[index++];}
if(number.length===0){throwUnexpectedToken();}
if(isIdentifierStart(source.charCodeAt(index))){throwUnexpectedToken();}
return{type:Token.NumericLiteral,value:parseInt('0x'+number,16),lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}
function scanBinaryLiteral(start){var ch,number;number='';while(index<length){ch=source[index];if(ch!=='0'&&ch!=='1'){break;}
number+=source[index++];}
if(number.length===0){throwUnexpectedToken();}
if(index<length){ch=source.charCodeAt(index);if(isIdentifierStart(ch)||isDecimalDigit(ch)){throwUnexpectedToken();}}
return{type:Token.NumericLiteral,value:parseInt(number,2),lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}
function scanOctalLiteral(prefix,start){var number,octal;if(isOctalDigit(prefix)){octal=true;number='0'+source[index++];}else{octal=false;++index;number='';}
while(index<length){if(!isOctalDigit(source[index])){break;}
number+=source[index++];}
if(!octal&&number.length===0){throwUnexpectedToken();}
if(isIdentifierStart(source.charCodeAt(index))||isDecimalDigit(source.charCodeAt(index))){throwUnexpectedToken();}
return{type:Token.NumericLiteral,value:parseInt(number,8),octal:octal,lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}
function isImplicitOctalLiteral(){var i,ch;for(i=index+1;i<length;++i){ch=source[i];if(ch==='8'||ch==='9'){return false;}
if(!isOctalDigit(ch)){return true;}}
return true;}
function scanNumericLiteral(){var number,start,ch;ch=source[index];assert(isDecimalDigit(ch.charCodeAt(0))||(ch==='.'),'Numeric literal must start with a decimal digit or a decimal point');start=index;number='';if(ch!=='.'){number=source[index++];ch=source[index];if(number==='0'){if(ch==='x'||ch==='X'){++index;return scanHexLiteral(start);}
if(ch==='b'||ch==='B'){++index;return scanBinaryLiteral(start);}
if(ch==='o'||ch==='O'){return scanOctalLiteral(ch,start);}
if(isOctalDigit(ch)){if(isImplicitOctalLiteral()){return scanOctalLiteral(ch,start);}}}
while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++];}
ch=source[index];}
if(ch==='.'){number+=source[index++];while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++];}
ch=source[index];}
if(ch==='e'||ch==='E'){number+=source[index++];ch=source[index];if(ch==='+'||ch==='-'){number+=source[index++];}
if(isDecimalDigit(source.charCodeAt(index))){while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++];}}else{throwUnexpectedToken();}}
if(isIdentifierStart(source.charCodeAt(index))){throwUnexpectedToken();}
return{type:Token.NumericLiteral,value:parseFloat(number),lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}
function scanStringLiteral(){var str='',quote,start,ch,unescaped,octToDec,octal=false;quote=source[index];assert((quote==='\''||quote==='"'),'String literal must starts with a quote');start=index;++index;while(index<length){ch=source[index++];if(ch===quote){quote='';break;}else if(ch==='\\'){ch=source[index++];if(!ch||!isLineTerminator(ch.charCodeAt(0))){switch(ch){case'u':case'x':if(source[index]==='{'){++index;str+=scanUnicodeCodePointEscape();}else{unescaped=scanHexEscape(ch);if(!unescaped){throw throwUnexpectedToken();}
str+=unescaped;}
break;case'n':str+='\n';break;case'r':str+='\r';break;case't':str+='\t';break;case'b':str+='\b';break;case'f':str+='\f';break;case'v':str+='\x0B';break;case'8':case'9':str+=ch;tolerateUnexpectedToken();break;default:if(isOctalDigit(ch)){octToDec=octalToDecimal(ch);octal=octToDec.octal||octal;str+=String.fromCharCode(octToDec.code);}else{str+=ch;}
break;}}else{++lineNumber;if(ch==='\r'&&source[index]==='\n'){++index;}
lineStart=index;}}else if(isLineTerminator(ch.charCodeAt(0))){break;}else{str+=ch;}}
if(quote!==''){throwUnexpectedToken();}
return{type:Token.StringLiteral,value:str,octal:octal,lineNumber:startLineNumber,lineStart:startLineStart,start:start,end:index};}
function scanTemplate(){var cooked='',ch,start,rawOffset,terminated,head,tail,restore,unescaped;terminated=false;tail=false;start=index;head=(source[index]==='`');rawOffset=2;++index;while(index<length){ch=source[index++];if(ch==='`'){rawOffset=1;tail=true;terminated=true;break;}else if(ch==='$'){if(source[index]==='{'){state.curlyStack.push('${');++index;terminated=true;break;}
cooked+=ch;}else if(ch==='\\'){ch=source[index++];if(!isLineTerminator(ch.charCodeAt(0))){switch(ch){case'n':cooked+='\n';break;case'r':cooked+='\r';break;case't':cooked+='\t';break;case'u':case'x':if(source[index]==='{'){++index;cooked+=scanUnicodeCodePointEscape();}else{restore=index;unescaped=scanHexEscape(ch);if(unescaped){cooked+=unescaped;}else{index=restore;cooked+=ch;}}
break;case'b':cooked+='\b';break;case'f':cooked+='\f';break;case'v':cooked+='\v';break;default:if(ch==='0'){if(isDecimalDigit(source.charCodeAt(index))){throwError(Messages.TemplateOctalLiteral);}
cooked+='\0';}else if(isOctalDigit(ch)){throwError(Messages.TemplateOctalLiteral);}else{cooked+=ch;}
break;}}else{++lineNumber;if(ch==='\r'&&source[index]==='\n'){++index;}
lineStart=index;}}else if(isLineTerminator(ch.charCodeAt(0))){++lineNumber;if(ch==='\r'&&source[index]==='\n'){++index;}
lineStart=index;cooked+='\n';}else{cooked+=ch;}}
if(!terminated){throwUnexpectedToken();}
if(!head){state.curlyStack.pop();}
return{type:Token.Template,value:{cooked:cooked,raw:source.slice(start+1,index-rawOffset)},head:head,tail:tail,lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}
function testRegExp(pattern,flags){var astralSubstitute='\uFFFF',tmp=pattern;if(flags.indexOf('u')>=0){tmp=tmp.replace(/\\u\{([0-9a-fA-F]+)\}|\\u([a-fA-F0-9]{4})/g,function($0,$1,$2){var codePoint=parseInt($1||$2,16);if(codePoint>0x10FFFF){throwUnexpectedToken(null,Messages.InvalidRegExp);}
if(codePoint<=0xFFFF){return String.fromCharCode(codePoint);}
return astralSubstitute;}).replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,astralSubstitute);}
try{RegExp(tmp);}catch(e){throwUnexpectedToken(null,Messages.InvalidRegExp);}
try{return new RegExp(pattern,flags);}catch(exception){return null;}}
function scanRegExpBody(){var ch,str,classMarker,terminated,body;ch=source[index];assert(ch==='/','Regular expression literal must start with a slash');str=source[index++];classMarker=false;terminated=false;while(index<length){ch=source[index++];str+=ch;if(ch==='\\'){ch=source[index++];if(isLineTerminator(ch.charCodeAt(0))){throwUnexpectedToken(null,Messages.UnterminatedRegExp);}
str+=ch;}else if(isLineTerminator(ch.charCodeAt(0))){throwUnexpectedToken(null,Messages.UnterminatedRegExp);}else if(classMarker){if(ch===']'){classMarker=false;}}else{if(ch==='/'){terminated=true;break;}else if(ch==='['){classMarker=true;}}}
if(!terminated){throwUnexpectedToken(null,Messages.UnterminatedRegExp);}
body=str.substr(1,str.length-2);return{value:body,literal:str};}
function scanRegExpFlags(){var ch,str,flags,restore;str='';flags='';while(index<length){ch=source[index];if(!isIdentifierPart(ch.charCodeAt(0))){break;}
++index;if(ch==='\\'&&index<length){ch=source[index];if(ch==='u'){++index;restore=index;ch=scanHexEscape('u');if(ch){flags+=ch;for(str+='\\u';restore<index;++restore){str+=source[restore];}}else{index=restore;flags+='u';str+='\\u';}
tolerateUnexpectedToken();}else{str+='\\';tolerateUnexpectedToken();}}else{flags+=ch;str+=ch;}}
return{value:flags,literal:str};}
function scanRegExp(){var start,body,flags,value;scanning=true;lookahead=null;skipComment();start=index;body=scanRegExpBody();flags=scanRegExpFlags();value=testRegExp(body.value,flags.value);scanning=false;if(extra.tokenize){return{type:Token.RegularExpression,value:value,regex:{pattern:body.value,flags:flags.value},lineNumber:lineNumber,lineStart:lineStart,start:start,end:index};}
return{literal:body.literal+flags.literal,value:value,regex:{pattern:body.value,flags:flags.value},start:start,end:index};}
function collectRegex(){var pos,loc,regex,token;skipComment();pos=index;loc={start:{line:lineNumber,column:index-lineStart}};regex=scanRegExp();loc.end={line:lineNumber,column:index-lineStart};if(!extra.tokenize){if(extra.tokens.length>0){token=extra.tokens[extra.tokens.length-1];if(token.range[0]===pos&&token.type==='Punctuator'){if(token.value==='/'||token.value==='/='){extra.tokens.pop();}}}
extra.tokens.push({type:'RegularExpression',value:regex.literal,regex:regex.regex,range:[pos,index],loc:loc});}
return regex;}
function isIdentifierName(token){return token.type===Token.Identifier||token.type===Token.Keyword||token.type===Token.BooleanLiteral||token.type===Token.NullLiteral;}
function advanceSlash(){var regex,previous,check;function testKeyword(value){return value&&(value.length>1)&&(value[0]>='a')&&(value[0]<='z');}
previous=extra.tokenValues[extra.tokens.length-1];regex=(previous!==null);switch(previous){case'this':case']':regex=false;break;case')':check=extra.tokenValues[extra.openParenToken-1];regex=(check==='if'||check==='while'||check==='for'||check==='with');break;case'}':regex=false;if(testKeyword(extra.tokenValues[extra.openCurlyToken-3])){check=extra.tokenValues[extra.openCurlyToken-4];regex=check?(FnExprTokens.indexOf(check)<0):false;}else if(testKeyword(extra.tokenValues[extra.openCurlyToken-4])){check=extra.tokenValues[extra.openCurlyToken-5];regex=check?(FnExprTokens.indexOf(check)<0):true;}}
return regex?collectRegex():scanPunctuator();}
function advance(){var cp,token;if(index>=length){return{type:Token.EOF,lineNumber:lineNumber,lineStart:lineStart,start:index,end:index};}
cp=source.charCodeAt(index);if(isIdentifierStart(cp)){token=scanIdentifier();if(strict&&isStrictModeReservedWord(token.value)){token.type=Token.Keyword;}
return token;}
if(cp===0x28||cp===0x29||cp===0x3B){return scanPunctuator();}
if(cp===0x27||cp===0x22){return scanStringLiteral();}
if(cp===0x2E){if(isDecimalDigit(source.charCodeAt(index+1))){return scanNumericLiteral();}
return scanPunctuator();}
if(isDecimalDigit(cp)){return scanNumericLiteral();}
if(extra.tokenize&&cp===0x2F){return advanceSlash();}
if(cp===0x60||(cp===0x7D&&state.curlyStack[state.curlyStack.length-1]==='${')){return scanTemplate();}
if(cp>=0xD800&&cp<0xDFFF){cp=codePointAt(index);if(isIdentifierStart(cp)){return scanIdentifier();}}
return scanPunctuator();}
function collectToken(){var loc,token,value,entry;loc={start:{line:lineNumber,column:index-lineStart}};token=advance();loc.end={line:lineNumber,column:index-lineStart};if(token.type!==Token.EOF){value=source.slice(token.start,token.end);entry={type:TokenName[token.type],value:value,range:[token.start,token.end],loc:loc};if(token.regex){entry.regex={pattern:token.regex.pattern,flags:token.regex.flags};}
if(extra.tokenValues){extra.tokenValues.push((entry.type==='Punctuator'||entry.type==='Keyword')?entry.value:null);}
if(extra.tokenize){if(!extra.range){delete entry.range;}
if(!extra.loc){delete entry.loc;}
if(extra.delegate){entry=extra.delegate(entry);}}
extra.tokens.push(entry);}
return token;}
function lex(){var token;scanning=true;lastIndex=index;lastLineNumber=lineNumber;lastLineStart=lineStart;skipComment();token=lookahead;startIndex=index;startLineNumber=lineNumber;startLineStart=lineStart;lookahead=(typeof extra.tokens!=='undefined')?collectToken():advance();scanning=false;return token;}
function peek(){scanning=true;skipComment();lastIndex=index;lastLineNumber=lineNumber;lastLineStart=lineStart;startIndex=index;startLineNumber=lineNumber;startLineStart=lineStart;lookahead=(typeof extra.tokens!=='undefined')?collectToken():advance();scanning=false;}
function Position(){this.line=startLineNumber;this.column=startIndex-startLineStart;}
function SourceLocation(){this.start=new Position();this.end=null;}
function WrappingSourceLocation(startToken){this.start={line:startToken.lineNumber,column:startToken.start-startToken.lineStart};this.end=null;}
function Node(){if(extra.range){this.range=[startIndex,0];}
if(extra.loc){this.loc=new SourceLocation();}}
function WrappingNode(startToken){if(extra.range){this.range=[startToken.start,0];}
if(extra.loc){this.loc=new WrappingSourceLocation(startToken);}}
WrappingNode.prototype=Node.prototype={processComment:function(){var lastChild,innerComments,leadingComments,trailingComments,bottomRight=extra.bottomRightStack,i,comment,last=bottomRight[bottomRight.length-1];if(this.type===Syntax.Program){if(this.body.length>0){return;}}
if(this.type===Syntax.BlockStatement&&this.body.length===0){innerComments=[];for(i=extra.leadingComments.length-1;i>=0;--i){comment=extra.leadingComments[i];if(this.range[1]>=comment.range[1]){innerComments.unshift(comment);extra.leadingComments.splice(i,1);extra.trailingComments.splice(i,1);}}
if(innerComments.length){this.innerComments=innerComments;return;}}
if(extra.trailingComments.length>0){trailingComments=[];for(i=extra.trailingComments.length-1;i>=0;--i){comment=extra.trailingComments[i];if(comment.range[0]>=this.range[1]){trailingComments.unshift(comment);extra.trailingComments.splice(i,1);}}
extra.trailingComments=[];}else{if(last&&last.trailingComments&&last.trailingComments[0].range[0]>=this.range[1]){trailingComments=last.trailingComments;delete last.trailingComments;}}
while(last&&last.range[0]>=this.range[0]){lastChild=bottomRight.pop();last=bottomRight[bottomRight.length-1];}
if(lastChild){if(lastChild.leadingComments){leadingComments=[];for(i=lastChild.leadingComments.length-1;i>=0;--i){comment=lastChild.leadingComments[i];if(comment.range[1]<=this.range[0]){leadingComments.unshift(comment);lastChild.leadingComments.splice(i,1);}}
if(!lastChild.leadingComments.length){lastChild.leadingComments=undefined;}}}else if(extra.leadingComments.length>0){leadingComments=[];for(i=extra.leadingComments.length-1;i>=0;--i){comment=extra.leadingComments[i];if(comment.range[1]<=this.range[0]){leadingComments.unshift(comment);extra.leadingComments.splice(i,1);}}}
if(leadingComments&&leadingComments.length>0){this.leadingComments=leadingComments;}
if(trailingComments&&trailingComments.length>0){this.trailingComments=trailingComments;}
bottomRight.push(this);},finish:function(){if(extra.range){this.range[1]=lastIndex;}
if(extra.loc){this.loc.end={line:lastLineNumber,column:lastIndex-lastLineStart};if(extra.source){this.loc.source=extra.source;}}
if(extra.attachComment){this.processComment();}},finishArrayExpression:function(elements){this.type=Syntax.ArrayExpression;this.elements=elements;this.finish();return this;},finishArrayPattern:function(elements){this.type=Syntax.ArrayPattern;this.elements=elements;this.finish();return this;},finishArrowFunctionExpression:function(params,defaults,body,expression){this.type=Syntax.ArrowFunctionExpression;this.id=null;this.params=params;this.defaults=defaults;this.body=body;this.generator=false;this.expression=expression;this.finish();return this;},finishAssignmentExpression:function(operator,left,right){this.type=Syntax.AssignmentExpression;this.operator=operator;this.left=left;this.right=right;this.finish();return this;},finishAssignmentPattern:function(left,right){this.type=Syntax.AssignmentPattern;this.left=left;this.right=right;this.finish();return this;},finishBinaryExpression:function(operator,left,right){this.type=(operator==='||'||operator==='&&')?Syntax.LogicalExpression:Syntax.BinaryExpression;this.operator=operator;this.left=left;this.right=right;this.finish();return this;},finishBlockStatement:function(body){this.type=Syntax.BlockStatement;this.body=body;this.finish();return this;},finishBreakStatement:function(label){this.type=Syntax.BreakStatement;this.label=label;this.finish();return this;},finishCallExpression:function(callee,args){this.type=Syntax.CallExpression;this.callee=callee;this.arguments=args;this.finish();return this;},finishCatchClause:function(param,body){this.type=Syntax.CatchClause;this.param=param;this.body=body;this.finish();return this;},finishClassBody:function(body){this.type=Syntax.ClassBody;this.body=body;this.finish();return this;},finishClassDeclaration:function(id,superClass,body){this.type=Syntax.ClassDeclaration;this.id=id;this.superClass=superClass;this.body=body;this.finish();return this;},finishClassExpression:function(id,superClass,body){this.type=Syntax.ClassExpression;this.id=id;this.superClass=superClass;this.body=body;this.finish();return this;},finishConditionalExpression:function(test,consequent,alternate){this.type=Syntax.ConditionalExpression;this.test=test;this.consequent=consequent;this.alternate=alternate;this.finish();return this;},finishContinueStatement:function(label){this.type=Syntax.ContinueStatement;this.label=label;this.finish();return this;},finishDebuggerStatement:function(){this.type=Syntax.DebuggerStatement;this.finish();return this;},finishDoWhileStatement:function(body,test){this.type=Syntax.DoWhileStatement;this.body=body;this.test=test;this.finish();return this;},finishEmptyStatement:function(){this.type=Syntax.EmptyStatement;this.finish();return this;},finishExpressionStatement:function(expression){this.type=Syntax.ExpressionStatement;this.expression=expression;this.finish();return this;},finishForStatement:function(init,test,update,body){this.type=Syntax.ForStatement;this.init=init;this.test=test;this.update=update;this.body=body;this.finish();return this;},finishForOfStatement:function(left,right,body){this.type=Syntax.ForOfStatement;this.left=left;this.right=right;this.body=body;this.finish();return this;},finishForInStatement:function(left,right,body){this.type=Syntax.ForInStatement;this.left=left;this.right=right;this.body=body;this.each=false;this.finish();return this;},finishFunctionDeclaration:function(id,params,defaults,body,generator){this.type=Syntax.FunctionDeclaration;this.id=id;this.params=params;this.defaults=defaults;this.body=body;this.generator=generator;this.expression=false;this.finish();return this;},finishFunctionExpression:function(id,params,defaults,body,generator){this.type=Syntax.FunctionExpression;this.id=id;this.params=params;this.defaults=defaults;this.body=body;this.generator=generator;this.expression=false;this.finish();return this;},finishIdentifier:function(name){this.type=Syntax.Identifier;this.name=name;this.finish();return this;},finishIfStatement:function(test,consequent,alternate){this.type=Syntax.IfStatement;this.test=test;this.consequent=consequent;this.alternate=alternate;this.finish();return this;},finishLabeledStatement:function(label,body){this.type=Syntax.LabeledStatement;this.label=label;this.body=body;this.finish();return this;},finishLiteral:function(token){this.type=Syntax.Literal;this.value=token.value;this.raw=source.slice(token.start,token.end);if(token.regex){this.regex=token.regex;}
this.finish();return this;},finishMemberExpression:function(accessor,object,property){this.type=Syntax.MemberExpression;this.computed=accessor==='[';this.object=object;this.property=property;this.finish();return this;},finishMetaProperty:function(meta,property){this.type=Syntax.MetaProperty;this.meta=meta;this.property=property;this.finish();return this;},finishNewExpression:function(callee,args){this.type=Syntax.NewExpression;this.callee=callee;this.arguments=args;this.finish();return this;},finishObjectExpression:function(properties){this.type=Syntax.ObjectExpression;this.properties=properties;this.finish();return this;},finishObjectPattern:function(properties){this.type=Syntax.ObjectPattern;this.properties=properties;this.finish();return this;},finishPostfixExpression:function(operator,argument){this.type=Syntax.UpdateExpression;this.operator=operator;this.argument=argument;this.prefix=false;this.finish();return this;},finishProgram:function(body,sourceType){this.type=Syntax.Program;this.body=body;this.sourceType=sourceType;this.finish();return this;},finishProperty:function(kind,key,computed,value,method,shorthand){this.type=Syntax.Property;this.key=key;this.computed=computed;this.value=value;this.kind=kind;this.method=method;this.shorthand=shorthand;this.finish();return this;},finishRestElement:function(argument){this.type=Syntax.RestElement;this.argument=argument;this.finish();return this;},finishReturnStatement:function(argument){this.type=Syntax.ReturnStatement;this.argument=argument;this.finish();return this;},finishSequenceExpression:function(expressions){this.type=Syntax.SequenceExpression;this.expressions=expressions;this.finish();return this;},finishSpreadElement:function(argument){this.type=Syntax.SpreadElement;this.argument=argument;this.finish();return this;},finishSwitchCase:function(test,consequent){this.type=Syntax.SwitchCase;this.test=test;this.consequent=consequent;this.finish();return this;},finishSuper:function(){this.type=Syntax.Super;this.finish();return this;},finishSwitchStatement:function(discriminant,cases){this.type=Syntax.SwitchStatement;this.discriminant=discriminant;this.cases=cases;this.finish();return this;},finishTaggedTemplateExpression:function(tag,quasi){this.type=Syntax.TaggedTemplateExpression;this.tag=tag;this.quasi=quasi;this.finish();return this;},finishTemplateElement:function(value,tail){this.type=Syntax.TemplateElement;this.value=value;this.tail=tail;this.finish();return this;},finishTemplateLiteral:function(quasis,expressions){this.type=Syntax.TemplateLiteral;this.quasis=quasis;this.expressions=expressions;this.finish();return this;},finishThisExpression:function(){this.type=Syntax.ThisExpression;this.finish();return this;},finishThrowStatement:function(argument){this.type=Syntax.ThrowStatement;this.argument=argument;this.finish();return this;},finishTryStatement:function(block,handler,finalizer){this.type=Syntax.TryStatement;this.block=block;this.guardedHandlers=[];this.handlers=handler?[handler]:[];this.handler=handler;this.finalizer=finalizer;this.finish();return this;},finishUnaryExpression:function(operator,argument){this.type=(operator==='++'||operator==='--')?Syntax.UpdateExpression:Syntax.UnaryExpression;this.operator=operator;this.argument=argument;this.prefix=true;this.finish();return this;},finishVariableDeclaration:function(declarations){this.type=Syntax.VariableDeclaration;this.declarations=declarations;this.kind='var';this.finish();return this;},finishLexicalDeclaration:function(declarations,kind){this.type=Syntax.VariableDeclaration;this.declarations=declarations;this.kind=kind;this.finish();return this;},finishVariableDeclarator:function(id,init){this.type=Syntax.VariableDeclarator;this.id=id;this.init=init;this.finish();return this;},finishWhileStatement:function(test,body){this.type=Syntax.WhileStatement;this.test=test;this.body=body;this.finish();return this;},finishWithStatement:function(object,body){this.type=Syntax.WithStatement;this.object=object;this.body=body;this.finish();return this;},finishExportSpecifier:function(local,exported){this.type=Syntax.ExportSpecifier;this.exported=exported||local;this.local=local;this.finish();return this;},finishImportDefaultSpecifier:function(local){this.type=Syntax.ImportDefaultSpecifier;this.local=local;this.finish();return this;},finishImportNamespaceSpecifier:function(local){this.type=Syntax.ImportNamespaceSpecifier;this.local=local;this.finish();return this;},finishExportNamedDeclaration:function(declaration,specifiers,src){this.type=Syntax.ExportNamedDeclaration;this.declaration=declaration;this.specifiers=specifiers;this.source=src;this.finish();return this;},finishExportDefaultDeclaration:function(declaration){this.type=Syntax.ExportDefaultDeclaration;this.declaration=declaration;this.finish();return this;},finishExportAllDeclaration:function(src){this.type=Syntax.ExportAllDeclaration;this.source=src;this.finish();return this;},finishImportSpecifier:function(local,imported){this.type=Syntax.ImportSpecifier;this.local=local||imported;this.imported=imported;this.finish();return this;},finishImportDeclaration:function(specifiers,src){this.type=Syntax.ImportDeclaration;this.specifiers=specifiers;this.source=src;this.finish();return this;},finishYieldExpression:function(argument,delegate){this.type=Syntax.YieldExpression;this.argument=argument;this.delegate=delegate;this.finish();return this;}};function recordError(error){var e,existing;for(e=0;e<extra.errors.length;e++){existing=extra.errors[e];if(existing.index===error.index&&existing.message===error.message){return;}}
extra.errors.push(error);}
function constructError(msg,column){var error=new Error(msg);try{throw error;}catch(base){if(Object.create&&Object.defineProperty){error=Object.create(base);Object.defineProperty(error,'column',{value:column});}}finally{return error;}}
function createError(line,pos,description){var msg,column,error;column=pos-(scanning?lineStart:lastLineStart)+1;msg='Line '+line+' Column '+column+': '+description;error=constructError(msg,column);error.lineNumber=line;error.description=description;error.index=pos;return error;}
function throwError(messageFormat){var args,msg;args=Array.prototype.slice.call(arguments,1);msg=messageFormat.replace(/%(\d)/g,function(whole,idx){assert(idx<args.length,'Message reference must be in range');return args[idx];});throw createError(lastLineNumber,lastIndex,msg);}
function tolerateError(messageFormat){var args,msg,error;args=Array.prototype.slice.call(arguments,1);msg=messageFormat.replace(/%(\d)/g,function(whole,idx){assert(idx<args.length,'Message reference must be in range');return args[idx];});error=createError(lineNumber,lastIndex,msg);if(extra.errors){recordError(error);}else{throw error;}}
function unexpectedTokenError(token,message){var value,msg=message||Messages.UnexpectedToken;if(token){if(!message){msg=(token.type===Token.EOF)?Messages.UnexpectedEOS:(token.type===Token.Identifier)?Messages.UnexpectedIdentifier:(token.type===Token.NumericLiteral)?Messages.UnexpectedNumber:(token.type===Token.StringLiteral)?Messages.UnexpectedString:(token.type===Token.Template)?Messages.UnexpectedTemplate:Messages.UnexpectedToken;if(token.type===Token.Keyword){if(isFutureReservedWord(token.value)){msg=Messages.UnexpectedReserved;}else if(strict&&isStrictModeReservedWord(token.value)){msg=Messages.StrictReservedWord;}}}
value=(token.type===Token.Template)?token.value.raw:token.value;}else{value='ILLEGAL';}
msg=msg.replace('%0',value);return(token&&typeof token.lineNumber==='number')?createError(token.lineNumber,token.start,msg):createError(scanning?lineNumber:lastLineNumber,scanning?index:lastIndex,msg);}
function throwUnexpectedToken(token,message){throw unexpectedTokenError(token,message);}
function tolerateUnexpectedToken(token,message){var error=unexpectedTokenError(token,message);if(extra.errors){recordError(error);}else{throw error;}}
function expect(value){var token=lex();if(token.type!==Token.Punctuator||token.value!==value){throwUnexpectedToken(token);}}
function expectCommaSeparator(){var token;if(extra.errors){token=lookahead;if(token.type===Token.Punctuator&&token.value===','){lex();}else if(token.type===Token.Punctuator&&token.value===';'){lex();tolerateUnexpectedToken(token);}else{tolerateUnexpectedToken(token,Messages.UnexpectedToken);}}else{expect(',');}}
function expectKeyword(keyword){var token=lex();if(token.type!==Token.Keyword||token.value!==keyword){throwUnexpectedToken(token);}}
function match(value){return lookahead.type===Token.Punctuator&&lookahead.value===value;}
function matchKeyword(keyword){return lookahead.type===Token.Keyword&&lookahead.value===keyword;}
function matchContextualKeyword(keyword){return lookahead.type===Token.Identifier&&lookahead.value===keyword;}
function matchAssign(){var op;if(lookahead.type!==Token.Punctuator){return false;}
op=lookahead.value;return op==='='||op==='*='||op==='/='||op==='%='||op==='+='||op==='-='||op==='<<='||op==='>>='||op==='>>>='||op==='&='||op==='^='||op==='|=';}
function consumeSemicolon(){if(source.charCodeAt(startIndex)===0x3B||match(';')){lex();return;}
if(hasLineTerminator){return;}
lastIndex=startIndex;lastLineNumber=startLineNumber;lastLineStart=startLineStart;if(lookahead.type!==Token.EOF&&!match('}')){throwUnexpectedToken(lookahead);}}
function isolateCoverGrammar(parser){var oldIsBindingElement=isBindingElement,oldIsAssignmentTarget=isAssignmentTarget,oldFirstCoverInitializedNameError=firstCoverInitializedNameError,result;isBindingElement=true;isAssignmentTarget=true;firstCoverInitializedNameError=null;result=parser();if(firstCoverInitializedNameError!==null){throwUnexpectedToken(firstCoverInitializedNameError);}
isBindingElement=oldIsBindingElement;isAssignmentTarget=oldIsAssignmentTarget;firstCoverInitializedNameError=oldFirstCoverInitializedNameError;return result;}
function inheritCoverGrammar(parser){var oldIsBindingElement=isBindingElement,oldIsAssignmentTarget=isAssignmentTarget,oldFirstCoverInitializedNameError=firstCoverInitializedNameError,result;isBindingElement=true;isAssignmentTarget=true;firstCoverInitializedNameError=null;result=parser();isBindingElement=isBindingElement&&oldIsBindingElement;isAssignmentTarget=isAssignmentTarget&&oldIsAssignmentTarget;firstCoverInitializedNameError=oldFirstCoverInitializedNameError||firstCoverInitializedNameError;return result;}
function parseArrayPattern(params,kind){var node=new Node(),elements=[],rest,restNode;expect('[');while(!match(']')){if(match(',')){lex();elements.push(null);}else{if(match('...')){restNode=new Node();lex();params.push(lookahead);rest=parseVariableIdentifier(kind);elements.push(restNode.finishRestElement(rest));break;}else{elements.push(parsePatternWithDefault(params,kind));}
if(!match(']')){expect(',');}}}
expect(']');return node.finishArrayPattern(elements);}
function parsePropertyPattern(params,kind){var node=new Node(),key,keyToken,computed=match('['),init;if(lookahead.type===Token.Identifier){keyToken=lookahead;key=parseVariableIdentifier();if(match('=')){params.push(keyToken);lex();init=parseAssignmentExpression();return node.finishProperty('init',key,false,new WrappingNode(keyToken).finishAssignmentPattern(key,init),false,false);}else if(!match(':')){params.push(keyToken);return node.finishProperty('init',key,false,key,false,true);}}else{key=parseObjectPropertyKey();}
expect(':');init=parsePatternWithDefault(params,kind);return node.finishProperty('init',key,computed,init,false,false);}
function parseObjectPattern(params,kind){var node=new Node(),properties=[];expect('{');while(!match('}')){properties.push(parsePropertyPattern(params,kind));if(!match('}')){expect(',');}}
lex();return node.finishObjectPattern(properties);}
function parsePattern(params,kind){if(match('[')){return parseArrayPattern(params,kind);}else if(match('{')){return parseObjectPattern(params,kind);}else if(matchKeyword('let')){if(kind==='const'||kind==='let'){tolerateUnexpectedToken(lookahead,Messages.UnexpectedToken);}}
params.push(lookahead);return parseVariableIdentifier(kind);}
function parsePatternWithDefault(params,kind){var startToken=lookahead,pattern,previousAllowYield,right;pattern=parsePattern(params,kind);if(match('=')){lex();previousAllowYield=state.allowYield;state.allowYield=true;right=isolateCoverGrammar(parseAssignmentExpression);state.allowYield=previousAllowYield;pattern=new WrappingNode(startToken).finishAssignmentPattern(pattern,right);}
return pattern;}
function parseArrayInitializer(){var elements=[],node=new Node(),restSpread;expect('[');while(!match(']')){if(match(',')){lex();elements.push(null);}else if(match('...')){restSpread=new Node();lex();restSpread.finishSpreadElement(inheritCoverGrammar(parseAssignmentExpression));if(!match(']')){isAssignmentTarget=isBindingElement=false;expect(',');}
elements.push(restSpread);}else{elements.push(inheritCoverGrammar(parseAssignmentExpression));if(!match(']')){expect(',');}}}
lex();return node.finishArrayExpression(elements);}
function parsePropertyFunction(node,paramInfo,isGenerator){var previousStrict,body;isAssignmentTarget=isBindingElement=false;previousStrict=strict;body=isolateCoverGrammar(parseFunctionSourceElements);if(strict&&paramInfo.firstRestricted){tolerateUnexpectedToken(paramInfo.firstRestricted,paramInfo.message);}
if(strict&&paramInfo.stricted){tolerateUnexpectedToken(paramInfo.stricted,paramInfo.message);}
strict=previousStrict;return node.finishFunctionExpression(null,paramInfo.params,paramInfo.defaults,body,isGenerator);}
function parsePropertyMethodFunction(){var params,method,node=new Node(),previousAllowYield=state.allowYield;state.allowYield=false;params=parseParams();state.allowYield=previousAllowYield;state.allowYield=false;method=parsePropertyFunction(node,params,false);state.allowYield=previousAllowYield;return method;}
function parseObjectPropertyKey(){var token,node=new Node(),expr;token=lex();switch(token.type){case Token.StringLiteral:case Token.NumericLiteral:if(strict&&token.octal){tolerateUnexpectedToken(token,Messages.StrictOctalLiteral);}
return node.finishLiteral(token);case Token.Identifier:case Token.BooleanLiteral:case Token.NullLiteral:case Token.Keyword:return node.finishIdentifier(token.value);case Token.Punctuator:if(token.value==='['){expr=isolateCoverGrammar(parseAssignmentExpression);expect(']');return expr;}
break;}
throwUnexpectedToken(token);}
function lookaheadPropertyName(){switch(lookahead.type){case Token.Identifier:case Token.StringLiteral:case Token.BooleanLiteral:case Token.NullLiteral:case Token.NumericLiteral:case Token.Keyword:return true;case Token.Punctuator:return lookahead.value==='[';}
return false;}
function tryParseMethodDefinition(token,key,computed,node){var value,options,methodNode,params,previousAllowYield=state.allowYield;if(token.type===Token.Identifier){if(token.value==='get'&&lookaheadPropertyName()){computed=match('[');key=parseObjectPropertyKey();methodNode=new Node();expect('(');expect(')');state.allowYield=false;value=parsePropertyFunction(methodNode,{params:[],defaults:[],stricted:null,firstRestricted:null,message:null},false);state.allowYield=previousAllowYield;return node.finishProperty('get',key,computed,value,false,false);}else if(token.value==='set'&&lookaheadPropertyName()){computed=match('[');key=parseObjectPropertyKey();methodNode=new Node();expect('(');options={params:[],defaultCount:0,defaults:[],firstRestricted:null,paramSet:{}};if(match(')')){tolerateUnexpectedToken(lookahead);}else{state.allowYield=false;parseParam(options);state.allowYield=previousAllowYield;if(options.defaultCount===0){options.defaults=[];}}
expect(')');state.allowYield=false;value=parsePropertyFunction(methodNode,options,false);state.allowYield=previousAllowYield;return node.finishProperty('set',key,computed,value,false,false);}}else if(token.type===Token.Punctuator&&token.value==='*'&&lookaheadPropertyName()){computed=match('[');key=parseObjectPropertyKey();methodNode=new Node();state.allowYield=true;params=parseParams();state.allowYield=previousAllowYield;state.allowYield=false;value=parsePropertyFunction(methodNode,params,true);state.allowYield=previousAllowYield;return node.finishProperty('init',key,computed,value,true,false);}
if(key&&match('(')){value=parsePropertyMethodFunction();return node.finishProperty('init',key,computed,value,true,false);}
return null;}
function parseObjectProperty(hasProto){var token=lookahead,node=new Node(),computed,key,maybeMethod,proto,value;computed=match('[');if(match('*')){lex();}else{key=parseObjectPropertyKey();}
maybeMethod=tryParseMethodDefinition(token,key,computed,node);if(maybeMethod){return maybeMethod;}
if(!key){throwUnexpectedToken(lookahead);}
if(!computed){proto=(key.type===Syntax.Identifier&&key.name==='__proto__')||(key.type===Syntax.Literal&&key.value==='__proto__');if(hasProto.value&&proto){tolerateError(Messages.DuplicateProtoProperty);}
hasProto.value|=proto;}
if(match(':')){lex();value=inheritCoverGrammar(parseAssignmentExpression);return node.finishProperty('init',key,computed,value,false,false);}
if(token.type===Token.Identifier){if(match('=')){firstCoverInitializedNameError=lookahead;lex();value=isolateCoverGrammar(parseAssignmentExpression);return node.finishProperty('init',key,computed,new WrappingNode(token).finishAssignmentPattern(key,value),false,true);}
return node.finishProperty('init',key,computed,key,false,true);}
throwUnexpectedToken(lookahead);}
function parseObjectInitializer(){var properties=[],hasProto={value:false},node=new Node();expect('{');while(!match('}')){properties.push(parseObjectProperty(hasProto));if(!match('}')){expectCommaSeparator();}}
expect('}');return node.finishObjectExpression(properties);}
function reinterpretExpressionAsPattern(expr){var i;switch(expr.type){case Syntax.Identifier:case Syntax.MemberExpression:case Syntax.RestElement:case Syntax.AssignmentPattern:break;case Syntax.SpreadElement:expr.type=Syntax.RestElement;reinterpretExpressionAsPattern(expr.argument);break;case Syntax.ArrayExpression:expr.type=Syntax.ArrayPattern;for(i=0;i<expr.elements.length;i++){if(expr.elements[i]!==null){reinterpretExpressionAsPattern(expr.elements[i]);}}
break;case Syntax.ObjectExpression:expr.type=Syntax.ObjectPattern;for(i=0;i<expr.properties.length;i++){reinterpretExpressionAsPattern(expr.properties[i].value);}
break;case Syntax.AssignmentExpression:expr.type=Syntax.AssignmentPattern;reinterpretExpressionAsPattern(expr.left);break;default:break;}}
function parseTemplateElement(option){var node,token;if(lookahead.type!==Token.Template||(option.head&&!lookahead.head)){throwUnexpectedToken();}
node=new Node();token=lex();return node.finishTemplateElement({raw:token.value.raw,cooked:token.value.cooked},token.tail);}
function parseTemplateLiteral(){var quasi,quasis,expressions,node=new Node();quasi=parseTemplateElement({head:true});quasis=[quasi];expressions=[];while(!quasi.tail){expressions.push(parseExpression());quasi=parseTemplateElement({head:false});quasis.push(quasi);}
return node.finishTemplateLiteral(quasis,expressions);}
function parseGroupExpression(){var expr,expressions,startToken,i,params=[];expect('(');if(match(')')){lex();if(!match('=>')){expect('=>');}
return{type:PlaceHolders.ArrowParameterPlaceHolder,params:[],rawParams:[]};}
startToken=lookahead;if(match('...')){expr=parseRestElement(params);expect(')');if(!match('=>')){expect('=>');}
return{type:PlaceHolders.ArrowParameterPlaceHolder,params:[expr]};}
isBindingElement=true;expr=inheritCoverGrammar(parseAssignmentExpression);if(match(',')){isAssignmentTarget=false;expressions=[expr];while(startIndex<length){if(!match(',')){break;}
lex();if(match('...')){if(!isBindingElement){throwUnexpectedToken(lookahead);}
expressions.push(parseRestElement(params));expect(')');if(!match('=>')){expect('=>');}
isBindingElement=false;for(i=0;i<expressions.length;i++){reinterpretExpressionAsPattern(expressions[i]);}
return{type:PlaceHolders.ArrowParameterPlaceHolder,params:expressions};}
expressions.push(inheritCoverGrammar(parseAssignmentExpression));}
expr=new WrappingNode(startToken).finishSequenceExpression(expressions);}
expect(')');if(match('=>')){if(expr.type===Syntax.Identifier&&expr.name==='yield'){return{type:PlaceHolders.ArrowParameterPlaceHolder,params:[expr]};}
if(!isBindingElement){throwUnexpectedToken(lookahead);}
if(expr.type===Syntax.SequenceExpression){for(i=0;i<expr.expressions.length;i++){reinterpretExpressionAsPattern(expr.expressions[i]);}}else{reinterpretExpressionAsPattern(expr);}
expr={type:PlaceHolders.ArrowParameterPlaceHolder,params:expr.type===Syntax.SequenceExpression?expr.expressions:[expr]};}
isBindingElement=false;return expr;}
function parsePrimaryExpression(){var type,token,expr,node;if(match('(')){isBindingElement=false;return inheritCoverGrammar(parseGroupExpression);}
if(match('[')){return inheritCoverGrammar(parseArrayInitializer);}
if(match('{')){return inheritCoverGrammar(parseObjectInitializer);}
type=lookahead.type;node=new Node();if(type===Token.Identifier){if(state.sourceType==='module'&&lookahead.value==='await'){tolerateUnexpectedToken(lookahead);}
expr=node.finishIdentifier(lex().value);}else if(type===Token.StringLiteral||type===Token.NumericLiteral){isAssignmentTarget=isBindingElement=false;if(strict&&lookahead.octal){tolerateUnexpectedToken(lookahead,Messages.StrictOctalLiteral);}
expr=node.finishLiteral(lex());}else if(type===Token.Keyword){if(!strict&&state.allowYield&&matchKeyword('yield')){return parseNonComputedProperty();}
isAssignmentTarget=isBindingElement=false;if(matchKeyword('function')){return parseFunctionExpression();}
if(matchKeyword('this')){lex();return node.finishThisExpression();}
if(matchKeyword('class')){return parseClassExpression();}
if(!strict&&matchKeyword('let')){return node.finishIdentifier(lex().value);}
throwUnexpectedToken(lex());}else if(type===Token.BooleanLiteral){isAssignmentTarget=isBindingElement=false;token=lex();token.value=(token.value==='true');expr=node.finishLiteral(token);}else if(type===Token.NullLiteral){isAssignmentTarget=isBindingElement=false;token=lex();token.value=null;expr=node.finishLiteral(token);}else if(match('/')||match('/=')){isAssignmentTarget=isBindingElement=false;index=startIndex;if(typeof extra.tokens!=='undefined'){token=collectRegex();}else{token=scanRegExp();}
lex();expr=node.finishLiteral(token);}else if(type===Token.Template){expr=parseTemplateLiteral();}else{throwUnexpectedToken(lex());}
return expr;}
function parseArguments(){var args=[],expr;expect('(');if(!match(')')){while(startIndex<length){if(match('...')){expr=new Node();lex();expr.finishSpreadElement(isolateCoverGrammar(parseAssignmentExpression));}else{expr=isolateCoverGrammar(parseAssignmentExpression);}
args.push(expr);if(match(')')){break;}
expectCommaSeparator();}}
expect(')');return args;}
function parseNonComputedProperty(){var token,node=new Node();token=lex();if(!isIdentifierName(token)){throwUnexpectedToken(token);}
return node.finishIdentifier(token.value);}
function parseNonComputedMember(){expect('.');return parseNonComputedProperty();}
function parseComputedMember(){var expr;expect('[');expr=isolateCoverGrammar(parseExpression);expect(']');return expr;}
function parseNewExpression(){var callee,args,node=new Node();expectKeyword('new');if(match('.')){lex();if(lookahead.type===Token.Identifier&&lookahead.value==='target'){if(state.inFunctionBody){lex();return node.finishMetaProperty('new','target');}}
throwUnexpectedToken(lookahead);}
callee=isolateCoverGrammar(parseLeftHandSideExpression);args=match('(')?parseArguments():[];isAssignmentTarget=isBindingElement=false;return node.finishNewExpression(callee,args);}
function parseLeftHandSideExpressionAllowCall(){var quasi,expr,args,property,startToken,previousAllowIn=state.allowIn;startToken=lookahead;state.allowIn=true;if(matchKeyword('super')&&state.inFunctionBody){expr=new Node();lex();expr=expr.finishSuper();if(!match('(')&&!match('.')&&!match('[')){throwUnexpectedToken(lookahead);}}else{expr=inheritCoverGrammar(matchKeyword('new')?parseNewExpression:parsePrimaryExpression);}
for(;;){if(match('.')){isBindingElement=false;isAssignmentTarget=true;property=parseNonComputedMember();expr=new WrappingNode(startToken).finishMemberExpression('.',expr,property);}else if(match('(')){isBindingElement=false;isAssignmentTarget=false;args=parseArguments();expr=new WrappingNode(startToken).finishCallExpression(expr,args);}else if(match('[')){isBindingElement=false;isAssignmentTarget=true;property=parseComputedMember();expr=new WrappingNode(startToken).finishMemberExpression('[',expr,property);}else if(lookahead.type===Token.Template&&lookahead.head){quasi=parseTemplateLiteral();expr=new WrappingNode(startToken).finishTaggedTemplateExpression(expr,quasi);}else{break;}}
state.allowIn=previousAllowIn;return expr;}
function parseLeftHandSideExpression(){var quasi,expr,property,startToken;assert(state.allowIn,'callee of new expression always allow in keyword.');startToken=lookahead;if(matchKeyword('super')&&state.inFunctionBody){expr=new Node();lex();expr=expr.finishSuper();if(!match('[')&&!match('.')){throwUnexpectedToken(lookahead);}}else{expr=inheritCoverGrammar(matchKeyword('new')?parseNewExpression:parsePrimaryExpression);}
for(;;){if(match('[')){isBindingElement=false;isAssignmentTarget=true;property=parseComputedMember();expr=new WrappingNode(startToken).finishMemberExpression('[',expr,property);}else if(match('.')){isBindingElement=false;isAssignmentTarget=true;property=parseNonComputedMember();expr=new WrappingNode(startToken).finishMemberExpression('.',expr,property);}else if(lookahead.type===Token.Template&&lookahead.head){quasi=parseTemplateLiteral();expr=new WrappingNode(startToken).finishTaggedTemplateExpression(expr,quasi);}else{break;}}
return expr;}
function parsePostfixExpression(){var expr,token,startToken=lookahead;expr=inheritCoverGrammar(parseLeftHandSideExpressionAllowCall);if(!hasLineTerminator&&lookahead.type===Token.Punctuator){if(match('++')||match('--')){if(strict&&expr.type===Syntax.Identifier&&isRestrictedWord(expr.name)){tolerateError(Messages.StrictLHSPostfix);}
if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInAssignment);}
isAssignmentTarget=isBindingElement=false;token=lex();expr=new WrappingNode(startToken).finishPostfixExpression(token.value,expr);}}
return expr;}
function parseUnaryExpression(){var token,expr,startToken;if(lookahead.type!==Token.Punctuator&&lookahead.type!==Token.Keyword){expr=parsePostfixExpression();}else if(match('++')||match('--')){startToken=lookahead;token=lex();expr=inheritCoverGrammar(parseUnaryExpression);if(strict&&expr.type===Syntax.Identifier&&isRestrictedWord(expr.name)){tolerateError(Messages.StrictLHSPrefix);}
if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInAssignment);}
expr=new WrappingNode(startToken).finishUnaryExpression(token.value,expr);isAssignmentTarget=isBindingElement=false;}else if(match('+')||match('-')||match('~')||match('!')){startToken=lookahead;token=lex();expr=inheritCoverGrammar(parseUnaryExpression);expr=new WrappingNode(startToken).finishUnaryExpression(token.value,expr);isAssignmentTarget=isBindingElement=false;}else if(matchKeyword('delete')||matchKeyword('void')||matchKeyword('typeof')){startToken=lookahead;token=lex();expr=inheritCoverGrammar(parseUnaryExpression);expr=new WrappingNode(startToken).finishUnaryExpression(token.value,expr);if(strict&&expr.operator==='delete'&&expr.argument.type===Syntax.Identifier){tolerateError(Messages.StrictDelete);}
isAssignmentTarget=isBindingElement=false;}else{expr=parsePostfixExpression();}
return expr;}
function binaryPrecedence(token,allowIn){var prec=0;if(token.type!==Token.Punctuator&&token.type!==Token.Keyword){return 0;}
switch(token.value){case'||':prec=1;break;case'&&':prec=2;break;case'|':prec=3;break;case'^':prec=4;break;case'&':prec=5;break;case'==':case'!=':case'===':case'!==':prec=6;break;case'<':case'>':case'<=':case'>=':case'instanceof':prec=7;break;case'in':prec=allowIn?7:0;break;case'<<':case'>>':case'>>>':prec=8;break;case'+':case'-':prec=9;break;case'*':case'/':case'%':prec=11;break;default:break;}
return prec;}
function parseBinaryExpression(){var marker,markers,expr,token,prec,stack,right,operator,left,i;marker=lookahead;left=inheritCoverGrammar(parseUnaryExpression);token=lookahead;prec=binaryPrecedence(token,state.allowIn);if(prec===0){return left;}
isAssignmentTarget=isBindingElement=false;token.prec=prec;lex();markers=[marker,lookahead];right=isolateCoverGrammar(parseUnaryExpression);stack=[left,token,right];while((prec=binaryPrecedence(lookahead,state.allowIn))>0){while((stack.length>2)&&(prec<=stack[stack.length-2].prec)){right=stack.pop();operator=stack.pop().value;left=stack.pop();markers.pop();expr=new WrappingNode(markers[markers.length-1]).finishBinaryExpression(operator,left,right);stack.push(expr);}
token=lex();token.prec=prec;stack.push(token);markers.push(lookahead);expr=isolateCoverGrammar(parseUnaryExpression);stack.push(expr);}
i=stack.length-1;expr=stack[i];markers.pop();while(i>1){expr=new WrappingNode(markers.pop()).finishBinaryExpression(stack[i-1].value,stack[i-2],expr);i-=2;}
return expr;}
function parseConditionalExpression(){var expr,previousAllowIn,consequent,alternate,startToken;startToken=lookahead;expr=inheritCoverGrammar(parseBinaryExpression);if(match('?')){lex();previousAllowIn=state.allowIn;state.allowIn=true;consequent=isolateCoverGrammar(parseAssignmentExpression);state.allowIn=previousAllowIn;expect(':');alternate=isolateCoverGrammar(parseAssignmentExpression);expr=new WrappingNode(startToken).finishConditionalExpression(expr,consequent,alternate);isAssignmentTarget=isBindingElement=false;}
return expr;}
function parseConciseBody(){if(match('{')){return parseFunctionSourceElements();}
return isolateCoverGrammar(parseAssignmentExpression);}
function checkPatternParam(options,param){var i;switch(param.type){case Syntax.Identifier:validateParam(options,param,param.name);break;case Syntax.RestElement:checkPatternParam(options,param.argument);break;case Syntax.AssignmentPattern:checkPatternParam(options,param.left);break;case Syntax.ArrayPattern:for(i=0;i<param.elements.length;i++){if(param.elements[i]!==null){checkPatternParam(options,param.elements[i]);}}
break;case Syntax.YieldExpression:break;default:assert(param.type===Syntax.ObjectPattern,'Invalid type');for(i=0;i<param.properties.length;i++){checkPatternParam(options,param.properties[i].value);}
break;}}
function reinterpretAsCoverFormalsList(expr){var i,len,param,params,defaults,defaultCount,options,token;defaults=[];defaultCount=0;params=[expr];switch(expr.type){case Syntax.Identifier:break;case PlaceHolders.ArrowParameterPlaceHolder:params=expr.params;break;default:return null;}
options={paramSet:{}};for(i=0,len=params.length;i<len;i+=1){param=params[i];switch(param.type){case Syntax.AssignmentPattern:params[i]=param.left;if(param.right.type===Syntax.YieldExpression){if(param.right.argument){throwUnexpectedToken(lookahead);}
param.right.type=Syntax.Identifier;param.right.name='yield';delete param.right.argument;delete param.right.delegate;}
defaults.push(param.right);++defaultCount;checkPatternParam(options,param.left);break;default:checkPatternParam(options,param);params[i]=param;defaults.push(null);break;}}
if(strict||!state.allowYield){for(i=0,len=params.length;i<len;i+=1){param=params[i];if(param.type===Syntax.YieldExpression){throwUnexpectedToken(lookahead);}}}
if(options.message===Messages.StrictParamDupe){token=strict?options.stricted:options.firstRestricted;throwUnexpectedToken(token,options.message);}
if(defaultCount===0){defaults=[];}
return{params:params,defaults:defaults,stricted:options.stricted,firstRestricted:options.firstRestricted,message:options.message};}
function parseArrowFunctionExpression(options,node){var previousStrict,previousAllowYield,body;if(hasLineTerminator){tolerateUnexpectedToken(lookahead);}
expect('=>');previousStrict=strict;previousAllowYield=state.allowYield;state.allowYield=true;body=parseConciseBody();if(strict&&options.firstRestricted){throwUnexpectedToken(options.firstRestricted,options.message);}
if(strict&&options.stricted){tolerateUnexpectedToken(options.stricted,options.message);}
strict=previousStrict;state.allowYield=previousAllowYield;return node.finishArrowFunctionExpression(options.params,options.defaults,body,body.type!==Syntax.BlockStatement);}
function parseYieldExpression(){var argument,expr,delegate,previousAllowYield;argument=null;expr=new Node();expectKeyword('yield');if(!hasLineTerminator){previousAllowYield=state.allowYield;state.allowYield=false;delegate=match('*');if(delegate){lex();argument=parseAssignmentExpression();}else{if(!match(';')&&!match('}')&&!match(')')&&lookahead.type!==Token.EOF){argument=parseAssignmentExpression();}}
state.allowYield=previousAllowYield;}
return expr.finishYieldExpression(argument,delegate);}
function parseAssignmentExpression(){var token,expr,right,list,startToken;startToken=lookahead;token=lookahead;if(!state.allowYield&&matchKeyword('yield')){return parseYieldExpression();}
expr=parseConditionalExpression();if(expr.type===PlaceHolders.ArrowParameterPlaceHolder||match('=>')){isAssignmentTarget=isBindingElement=false;list=reinterpretAsCoverFormalsList(expr);if(list){firstCoverInitializedNameError=null;return parseArrowFunctionExpression(list,new WrappingNode(startToken));}
return expr;}
if(matchAssign()){if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInAssignment);}
if(strict&&expr.type===Syntax.Identifier){if(isRestrictedWord(expr.name)){tolerateUnexpectedToken(token,Messages.StrictLHSAssignment);}
if(isStrictModeReservedWord(expr.name)){tolerateUnexpectedToken(token,Messages.StrictReservedWord);}}
if(!match('=')){isAssignmentTarget=isBindingElement=false;}else{reinterpretExpressionAsPattern(expr);}
token=lex();right=isolateCoverGrammar(parseAssignmentExpression);expr=new WrappingNode(startToken).finishAssignmentExpression(token.value,expr,right);firstCoverInitializedNameError=null;}
return expr;}
function parseExpression(){var expr,startToken=lookahead,expressions;expr=isolateCoverGrammar(parseAssignmentExpression);if(match(',')){expressions=[expr];while(startIndex<length){if(!match(',')){break;}
lex();expressions.push(isolateCoverGrammar(parseAssignmentExpression));}
expr=new WrappingNode(startToken).finishSequenceExpression(expressions);}
return expr;}
function parseStatementListItem(){if(lookahead.type===Token.Keyword){switch(lookahead.value){case'export':if(state.sourceType!=='module'){tolerateUnexpectedToken(lookahead,Messages.IllegalExportDeclaration);}
return parseExportDeclaration();case'import':if(state.sourceType!=='module'){tolerateUnexpectedToken(lookahead,Messages.IllegalImportDeclaration);}
return parseImportDeclaration();case'const':return parseLexicalDeclaration({inFor:false});case'function':return parseFunctionDeclaration(new Node());case'class':return parseClassDeclaration();}}
if(matchKeyword('let')&&isLexicalDeclaration()){return parseLexicalDeclaration({inFor:false});}
return parseStatement();}
function parseStatementList(){var list=[];while(startIndex<length){if(match('}')){break;}
list.push(parseStatementListItem());}
return list;}
function parseBlock(){var block,node=new Node();expect('{');block=parseStatementList();expect('}');return node.finishBlockStatement(block);}
function parseVariableIdentifier(kind){var token,node=new Node();token=lex();if(token.type===Token.Keyword&&token.value==='yield'){if(strict){tolerateUnexpectedToken(token,Messages.StrictReservedWord);}if(!state.allowYield){throwUnexpectedToken(token);}}else if(token.type!==Token.Identifier){if(strict&&token.type===Token.Keyword&&isStrictModeReservedWord(token.value)){tolerateUnexpectedToken(token,Messages.StrictReservedWord);}else{if(strict||token.value!=='let'||kind!=='var'){throwUnexpectedToken(token);}}}else if(state.sourceType==='module'&&token.type===Token.Identifier&&token.value==='await'){tolerateUnexpectedToken(token);}
return node.finishIdentifier(token.value);}
function parseVariableDeclaration(options){var init=null,id,node=new Node(),params=[];id=parsePattern(params,'var');if(strict&&isRestrictedWord(id.name)){tolerateError(Messages.StrictVarName);}
if(match('=')){lex();init=isolateCoverGrammar(parseAssignmentExpression);}else if(id.type!==Syntax.Identifier&&!options.inFor){expect('=');}
return node.finishVariableDeclarator(id,init);}
function parseVariableDeclarationList(options){var list=[];do{list.push(parseVariableDeclaration({inFor:options.inFor}));if(!match(',')){break;}
lex();}while(startIndex<length);return list;}
function parseVariableStatement(node){var declarations;expectKeyword('var');declarations=parseVariableDeclarationList({inFor:false});consumeSemicolon();return node.finishVariableDeclaration(declarations);}
function parseLexicalBinding(kind,options){var init=null,id,node=new Node(),params=[];id=parsePattern(params,kind);if(strict&&id.type===Syntax.Identifier&&isRestrictedWord(id.name)){tolerateError(Messages.StrictVarName);}
if(kind==='const'){if(!matchKeyword('in')&&!matchContextualKeyword('of')){expect('=');init=isolateCoverGrammar(parseAssignmentExpression);}}else if((!options.inFor&&id.type!==Syntax.Identifier)||match('=')){expect('=');init=isolateCoverGrammar(parseAssignmentExpression);}
return node.finishVariableDeclarator(id,init);}
function parseBindingList(kind,options){var list=[];do{list.push(parseLexicalBinding(kind,options));if(!match(',')){break;}
lex();}while(startIndex<length);return list;}
function tokenizerState(){return{index:index,lineNumber:lineNumber,lineStart:lineStart,hasLineTerminator:hasLineTerminator,lastIndex:lastIndex,lastLineNumber:lastLineNumber,lastLineStart:lastLineStart,startIndex:startIndex,startLineNumber:startLineNumber,startLineStart:startLineStart,lookahead:lookahead,tokenCount:extra.tokens?extra.tokens.length:0};}
function resetTokenizerState(ts){index=ts.index;lineNumber=ts.lineNumber;lineStart=ts.lineStart;hasLineTerminator=ts.hasLineTerminator;lastIndex=ts.lastIndex;lastLineNumber=ts.lastLineNumber;lastLineStart=ts.lastLineStart;startIndex=ts.startIndex;startLineNumber=ts.startLineNumber;startLineStart=ts.startLineStart;lookahead=ts.lookahead;if(extra.tokens){extra.tokens.splice(ts.tokenCount,extra.tokens.length);}}
function isLexicalDeclaration(){var lexical,ts;ts=tokenizerState();lex();lexical=(lookahead.type===Token.Identifier)||match('[')||match('{')||matchKeyword('let')||matchKeyword('yield');resetTokenizerState(ts);return lexical;}
function parseLexicalDeclaration(options){var kind,declarations,node=new Node();kind=lex().value;assert(kind==='let'||kind==='const','Lexical declaration must be either let or const');declarations=parseBindingList(kind,options);consumeSemicolon();return node.finishLexicalDeclaration(declarations,kind);}
function parseRestElement(params){var param,node=new Node();lex();if(match('{')){throwError(Messages.ObjectPatternAsRestParameter);}
params.push(lookahead);param=parseVariableIdentifier();if(match('=')){throwError(Messages.DefaultRestParameter);}
if(!match(')')){throwError(Messages.ParameterAfterRestParameter);}
return node.finishRestElement(param);}
function parseEmptyStatement(node){expect(';');return node.finishEmptyStatement();}
function parseExpressionStatement(node){var expr=parseExpression();consumeSemicolon();return node.finishExpressionStatement(expr);}
function parseIfStatement(node){var test,consequent,alternate;expectKeyword('if');expect('(');test=parseExpression();expect(')');consequent=parseStatement();if(matchKeyword('else')){lex();alternate=parseStatement();}else{alternate=null;}
return node.finishIfStatement(test,consequent,alternate);}
function parseDoWhileStatement(node){var body,test,oldInIteration;expectKeyword('do');oldInIteration=state.inIteration;state.inIteration=true;body=parseStatement();state.inIteration=oldInIteration;expectKeyword('while');expect('(');test=parseExpression();expect(')');if(match(';')){lex();}
return node.finishDoWhileStatement(body,test);}
function parseWhileStatement(node){var test,body,oldInIteration;expectKeyword('while');expect('(');test=parseExpression();expect(')');oldInIteration=state.inIteration;state.inIteration=true;body=parseStatement();state.inIteration=oldInIteration;return node.finishWhileStatement(test,body);}
function parseForStatement(node){var init,forIn,initSeq,initStartToken,test,update,left,right,kind,declarations,body,oldInIteration,previousAllowIn=state.allowIn;init=test=update=null;forIn=true;expectKeyword('for');expect('(');if(match(';')){lex();}else{if(matchKeyword('var')){init=new Node();lex();state.allowIn=false;declarations=parseVariableDeclarationList({inFor:true});state.allowIn=previousAllowIn;if(declarations.length===1&&matchKeyword('in')){init=init.finishVariableDeclaration(declarations);lex();left=init;right=parseExpression();init=null;}else if(declarations.length===1&&declarations[0].init===null&&matchContextualKeyword('of')){init=init.finishVariableDeclaration(declarations);lex();left=init;right=parseAssignmentExpression();init=null;forIn=false;}else{init=init.finishVariableDeclaration(declarations);expect(';');}}else if(matchKeyword('const')||matchKeyword('let')){init=new Node();kind=lex().value;if(!strict&&lookahead.value==='in'){init=init.finishIdentifier(kind);lex();left=init;right=parseExpression();init=null;}else{state.allowIn=false;declarations=parseBindingList(kind,{inFor:true});state.allowIn=previousAllowIn;if(declarations.length===1&&declarations[0].init===null&&matchKeyword('in')){init=init.finishLexicalDeclaration(declarations,kind);lex();left=init;right=parseExpression();init=null;}else if(declarations.length===1&&declarations[0].init===null&&matchContextualKeyword('of')){init=init.finishLexicalDeclaration(declarations,kind);lex();left=init;right=parseAssignmentExpression();init=null;forIn=false;}else{consumeSemicolon();init=init.finishLexicalDeclaration(declarations,kind);}}}else{initStartToken=lookahead;state.allowIn=false;init=inheritCoverGrammar(parseAssignmentExpression);state.allowIn=previousAllowIn;if(matchKeyword('in')){if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInForIn);}
lex();reinterpretExpressionAsPattern(init);left=init;right=parseExpression();init=null;}else if(matchContextualKeyword('of')){if(!isAssignmentTarget){tolerateError(Messages.InvalidLHSInForLoop);}
lex();reinterpretExpressionAsPattern(init);left=init;right=parseAssignmentExpression();init=null;forIn=false;}else{if(match(',')){initSeq=[init];while(match(',')){lex();initSeq.push(isolateCoverGrammar(parseAssignmentExpression));}
init=new WrappingNode(initStartToken).finishSequenceExpression(initSeq);}
expect(';');}}}
if(typeof left==='undefined'){if(!match(';')){test=parseExpression();}
expect(';');if(!match(')')){update=parseExpression();}}
expect(')');oldInIteration=state.inIteration;state.inIteration=true;body=isolateCoverGrammar(parseStatement);state.inIteration=oldInIteration;return(typeof left==='undefined')?node.finishForStatement(init,test,update,body):forIn?node.finishForInStatement(left,right,body):node.finishForOfStatement(left,right,body);}
function parseContinueStatement(node){var label=null,key;expectKeyword('continue');if(source.charCodeAt(startIndex)===0x3B){lex();if(!state.inIteration){throwError(Messages.IllegalContinue);}
return node.finishContinueStatement(null);}
if(hasLineTerminator){if(!state.inIteration){throwError(Messages.IllegalContinue);}
return node.finishContinueStatement(null);}
if(lookahead.type===Token.Identifier){label=parseVariableIdentifier();key='$'+label.name;if(!Object.prototype.hasOwnProperty.call(state.labelSet,key)){throwError(Messages.UnknownLabel,label.name);}}
consumeSemicolon();if(label===null&&!state.inIteration){throwError(Messages.IllegalContinue);}
return node.finishContinueStatement(label);}
function parseBreakStatement(node){var label=null,key;expectKeyword('break');if(source.charCodeAt(lastIndex)===0x3B){lex();if(!(state.inIteration||state.inSwitch)){throwError(Messages.IllegalBreak);}
return node.finishBreakStatement(null);}
if(hasLineTerminator){if(!(state.inIteration||state.inSwitch)){throwError(Messages.IllegalBreak);}}else if(lookahead.type===Token.Identifier){label=parseVariableIdentifier();key='$'+label.name;if(!Object.prototype.hasOwnProperty.call(state.labelSet,key)){throwError(Messages.UnknownLabel,label.name);}}
consumeSemicolon();if(label===null&&!(state.inIteration||state.inSwitch)){throwError(Messages.IllegalBreak);}
return node.finishBreakStatement(label);}
function parseReturnStatement(node){var argument=null;expectKeyword('return');if(!state.inFunctionBody){tolerateError(Messages.IllegalReturn);}
if(source.charCodeAt(lastIndex)===0x20){if(isIdentifierStart(source.charCodeAt(lastIndex+1))){argument=parseExpression();consumeSemicolon();return node.finishReturnStatement(argument);}}
if(hasLineTerminator){return node.finishReturnStatement(null);}
if(!match(';')){if(!match('}')&&lookahead.type!==Token.EOF){argument=parseExpression();}}
consumeSemicolon();return node.finishReturnStatement(argument);}
function parseWithStatement(node){var object,body;if(strict){tolerateError(Messages.StrictModeWith);}
expectKeyword('with');expect('(');object=parseExpression();expect(')');body=parseStatement();return node.finishWithStatement(object,body);}
function parseSwitchCase(){var test,consequent=[],statement,node=new Node();if(matchKeyword('default')){lex();test=null;}else{expectKeyword('case');test=parseExpression();}
expect(':');while(startIndex<length){if(match('}')||matchKeyword('default')||matchKeyword('case')){break;}
statement=parseStatementListItem();consequent.push(statement);}
return node.finishSwitchCase(test,consequent);}
function parseSwitchStatement(node){var discriminant,cases,clause,oldInSwitch,defaultFound;expectKeyword('switch');expect('(');discriminant=parseExpression();expect(')');expect('{');cases=[];if(match('}')){lex();return node.finishSwitchStatement(discriminant,cases);}
oldInSwitch=state.inSwitch;state.inSwitch=true;defaultFound=false;while(startIndex<length){if(match('}')){break;}
clause=parseSwitchCase();if(clause.test===null){if(defaultFound){throwError(Messages.MultipleDefaultsInSwitch);}
defaultFound=true;}
cases.push(clause);}
state.inSwitch=oldInSwitch;expect('}');return node.finishSwitchStatement(discriminant,cases);}
function parseThrowStatement(node){var argument;expectKeyword('throw');if(hasLineTerminator){throwError(Messages.NewlineAfterThrow);}
argument=parseExpression();consumeSemicolon();return node.finishThrowStatement(argument);}
function parseCatchClause(){var param,params=[],paramMap={},key,i,body,node=new Node();expectKeyword('catch');expect('(');if(match(')')){throwUnexpectedToken(lookahead);}
param=parsePattern(params);for(i=0;i<params.length;i++){key='$'+params[i].value;if(Object.prototype.hasOwnProperty.call(paramMap,key)){tolerateError(Messages.DuplicateBinding,params[i].value);}
paramMap[key]=true;}
if(strict&&isRestrictedWord(param.name)){tolerateError(Messages.StrictCatchVariable);}
expect(')');body=parseBlock();return node.finishCatchClause(param,body);}
function parseTryStatement(node){var block,handler=null,finalizer=null;expectKeyword('try');block=parseBlock();if(matchKeyword('catch')){handler=parseCatchClause();}
if(matchKeyword('finally')){lex();finalizer=parseBlock();}
if(!handler&&!finalizer){throwError(Messages.NoCatchOrFinally);}
return node.finishTryStatement(block,handler,finalizer);}
function parseDebuggerStatement(node){expectKeyword('debugger');consumeSemicolon();return node.finishDebuggerStatement();}
function parseStatement(){var type=lookahead.type,expr,labeledBody,key,node;if(type===Token.EOF){throwUnexpectedToken(lookahead);}
if(type===Token.Punctuator&&lookahead.value==='{'){return parseBlock();}
isAssignmentTarget=isBindingElement=true;node=new Node();if(type===Token.Punctuator){switch(lookahead.value){case';':return parseEmptyStatement(node);case'(':return parseExpressionStatement(node);default:break;}}else if(type===Token.Keyword){switch(lookahead.value){case'break':return parseBreakStatement(node);case'continue':return parseContinueStatement(node);case'debugger':return parseDebuggerStatement(node);case'do':return parseDoWhileStatement(node);case'for':return parseForStatement(node);case'function':return parseFunctionDeclaration(node);case'if':return parseIfStatement(node);case'return':return parseReturnStatement(node);case'switch':return parseSwitchStatement(node);case'throw':return parseThrowStatement(node);case'try':return parseTryStatement(node);case'var':return parseVariableStatement(node);case'while':return parseWhileStatement(node);case'with':return parseWithStatement(node);default:break;}}
expr=parseExpression();if((expr.type===Syntax.Identifier)&&match(':')){lex();key='$'+expr.name;if(Object.prototype.hasOwnProperty.call(state.labelSet,key)){throwError(Messages.Redeclaration,'Label',expr.name);}
state.labelSet[key]=true;labeledBody=parseStatement();delete state.labelSet[key];return node.finishLabeledStatement(expr,labeledBody);}
consumeSemicolon();return node.finishExpressionStatement(expr);}
function parseFunctionSourceElements(){var statement,body=[],token,directive,firstRestricted,oldLabelSet,oldInIteration,oldInSwitch,oldInFunctionBody,oldParenthesisCount,node=new Node();expect('{');while(startIndex<length){if(lookahead.type!==Token.StringLiteral){break;}
token=lookahead;statement=parseStatementListItem();body.push(statement);if(statement.expression.type!==Syntax.Literal){break;}
directive=source.slice(token.start+1,token.end-1);if(directive==='use strict'){strict=true;if(firstRestricted){tolerateUnexpectedToken(firstRestricted,Messages.StrictOctalLiteral);}}else{if(!firstRestricted&&token.octal){firstRestricted=token;}}}
oldLabelSet=state.labelSet;oldInIteration=state.inIteration;oldInSwitch=state.inSwitch;oldInFunctionBody=state.inFunctionBody;oldParenthesisCount=state.parenthesizedCount;state.labelSet={};state.inIteration=false;state.inSwitch=false;state.inFunctionBody=true;state.parenthesizedCount=0;while(startIndex<length){if(match('}')){break;}
body.push(parseStatementListItem());}
expect('}');state.labelSet=oldLabelSet;state.inIteration=oldInIteration;state.inSwitch=oldInSwitch;state.inFunctionBody=oldInFunctionBody;state.parenthesizedCount=oldParenthesisCount;return node.finishBlockStatement(body);}
function validateParam(options,param,name){var key='$'+name;if(strict){if(isRestrictedWord(name)){options.stricted=param;options.message=Messages.StrictParamName;}
if(Object.prototype.hasOwnProperty.call(options.paramSet,key)){options.stricted=param;options.message=Messages.StrictParamDupe;}}else if(!options.firstRestricted){if(isRestrictedWord(name)){options.firstRestricted=param;options.message=Messages.StrictParamName;}else if(isStrictModeReservedWord(name)){options.firstRestricted=param;options.message=Messages.StrictReservedWord;}else if(Object.prototype.hasOwnProperty.call(options.paramSet,key)){options.stricted=param;options.message=Messages.StrictParamDupe;}}
options.paramSet[key]=true;}
function parseParam(options){var token,param,params=[],i,def;token=lookahead;if(token.value==='...'){param=parseRestElement(params);validateParam(options,param.argument,param.argument.name);options.params.push(param);options.defaults.push(null);return false;}
param=parsePatternWithDefault(params);for(i=0;i<params.length;i++){validateParam(options,params[i],params[i].value);}
if(param.type===Syntax.AssignmentPattern){def=param.right;param=param.left;++options.defaultCount;}
options.params.push(param);options.defaults.push(def);return!match(')');}
function parseParams(firstRestricted){var options;options={params:[],defaultCount:0,defaults:[],firstRestricted:firstRestricted};expect('(');if(!match(')')){options.paramSet={};while(startIndex<length){if(!parseParam(options)){break;}
expect(',');}}
expect(')');if(options.defaultCount===0){options.defaults=[];}
return{params:options.params,defaults:options.defaults,stricted:options.stricted,firstRestricted:options.firstRestricted,message:options.message};}
function parseFunctionDeclaration(node,identifierIsOptional){var id=null,params=[],defaults=[],body,token,stricted,tmp,firstRestricted,message,previousStrict,isGenerator,previousAllowYield;previousAllowYield=state.allowYield;expectKeyword('function');isGenerator=match('*');if(isGenerator){lex();}
if(!identifierIsOptional||!match('(')){token=lookahead;id=parseVariableIdentifier();if(strict){if(isRestrictedWord(token.value)){tolerateUnexpectedToken(token,Messages.StrictFunctionName);}}else{if(isRestrictedWord(token.value)){firstRestricted=token;message=Messages.StrictFunctionName;}else if(isStrictModeReservedWord(token.value)){firstRestricted=token;message=Messages.StrictReservedWord;}}}
state.allowYield=!isGenerator;tmp=parseParams(firstRestricted);params=tmp.params;defaults=tmp.defaults;stricted=tmp.stricted;firstRestricted=tmp.firstRestricted;if(tmp.message){message=tmp.message;}
previousStrict=strict;body=parseFunctionSourceElements();if(strict&&firstRestricted){throwUnexpectedToken(firstRestricted,message);}
if(strict&&stricted){tolerateUnexpectedToken(stricted,message);}
strict=previousStrict;state.allowYield=previousAllowYield;return node.finishFunctionDeclaration(id,params,defaults,body,isGenerator);}
function parseFunctionExpression(){var token,id=null,stricted,firstRestricted,message,tmp,params=[],defaults=[],body,previousStrict,node=new Node(),isGenerator,previousAllowYield;previousAllowYield=state.allowYield;expectKeyword('function');isGenerator=match('*');if(isGenerator){lex();}
state.allowYield=!isGenerator;if(!match('(')){token=lookahead;id=(!strict&&!isGenerator&&matchKeyword('yield'))?parseNonComputedProperty():parseVariableIdentifier();if(strict){if(isRestrictedWord(token.value)){tolerateUnexpectedToken(token,Messages.StrictFunctionName);}}else{if(isRestrictedWord(token.value)){firstRestricted=token;message=Messages.StrictFunctionName;}else if(isStrictModeReservedWord(token.value)){firstRestricted=token;message=Messages.StrictReservedWord;}}}
tmp=parseParams(firstRestricted);params=tmp.params;defaults=tmp.defaults;stricted=tmp.stricted;firstRestricted=tmp.firstRestricted;if(tmp.message){message=tmp.message;}
previousStrict=strict;body=parseFunctionSourceElements();if(strict&&firstRestricted){throwUnexpectedToken(firstRestricted,message);}
if(strict&&stricted){tolerateUnexpectedToken(stricted,message);}
strict=previousStrict;state.allowYield=previousAllowYield;return node.finishFunctionExpression(id,params,defaults,body,isGenerator);}
function parseClassBody(){var classBody,token,isStatic,hasConstructor=false,body,method,computed,key;classBody=new Node();expect('{');body=[];while(!match('}')){if(match(';')){lex();}else{method=new Node();token=lookahead;isStatic=false;computed=match('[');if(match('*')){lex();}else{key=parseObjectPropertyKey();if(key.name==='static'&&(lookaheadPropertyName()||match('*'))){token=lookahead;isStatic=true;computed=match('[');if(match('*')){lex();}else{key=parseObjectPropertyKey();}}}
method=tryParseMethodDefinition(token,key,computed,method);if(method){method['static']=isStatic;if(method.kind==='init'){method.kind='method';}
if(!isStatic){if(!method.computed&&(method.key.name||method.key.value.toString())==='constructor'){if(method.kind!=='method'||!method.method||method.value.generator){throwUnexpectedToken(token,Messages.ConstructorSpecialMethod);}
if(hasConstructor){throwUnexpectedToken(token,Messages.DuplicateConstructor);}else{hasConstructor=true;}
method.kind='constructor';}}else{if(!method.computed&&(method.key.name||method.key.value.toString())==='prototype'){throwUnexpectedToken(token,Messages.StaticPrototype);}}
method.type=Syntax.MethodDefinition;delete method.method;delete method.shorthand;body.push(method);}else{throwUnexpectedToken(lookahead);}}}
lex();return classBody.finishClassBody(body);}
function parseClassDeclaration(identifierIsOptional){var id=null,superClass=null,classNode=new Node(),classBody,previousStrict=strict;strict=true;expectKeyword('class');if(!identifierIsOptional||lookahead.type===Token.Identifier){id=parseVariableIdentifier();}
if(matchKeyword('extends')){lex();superClass=isolateCoverGrammar(parseLeftHandSideExpressionAllowCall);}
classBody=parseClassBody();strict=previousStrict;return classNode.finishClassDeclaration(id,superClass,classBody);}
function parseClassExpression(){var id=null,superClass=null,classNode=new Node(),classBody,previousStrict=strict;strict=true;expectKeyword('class');if(lookahead.type===Token.Identifier){id=parseVariableIdentifier();}
if(matchKeyword('extends')){lex();superClass=isolateCoverGrammar(parseLeftHandSideExpressionAllowCall);}
classBody=parseClassBody();strict=previousStrict;return classNode.finishClassExpression(id,superClass,classBody);}
function parseModuleSpecifier(){var node=new Node();if(lookahead.type!==Token.StringLiteral){throwError(Messages.InvalidModuleSpecifier);}
return node.finishLiteral(lex());}
function parseExportSpecifier(){var exported,local,node=new Node(),def;if(matchKeyword('default')){def=new Node();lex();local=def.finishIdentifier('default');}else{local=parseVariableIdentifier();}
if(matchContextualKeyword('as')){lex();exported=parseNonComputedProperty();}
return node.finishExportSpecifier(local,exported);}
function parseExportNamedDeclaration(node){var declaration=null,isExportFromIdentifier,src=null,specifiers=[];if(lookahead.type===Token.Keyword){switch(lookahead.value){case'let':case'const':declaration=parseLexicalDeclaration({inFor:false});return node.finishExportNamedDeclaration(declaration,specifiers,null);case'var':case'class':case'function':declaration=parseStatementListItem();return node.finishExportNamedDeclaration(declaration,specifiers,null);}}
expect('{');while(!match('}')){isExportFromIdentifier=isExportFromIdentifier||matchKeyword('default');specifiers.push(parseExportSpecifier());if(!match('}')){expect(',');if(match('}')){break;}}}
expect('}');if(matchContextualKeyword('from')){lex();src=parseModuleSpecifier();consumeSemicolon();}else if(isExportFromIdentifier){throwError(lookahead.value?Messages.UnexpectedToken:Messages.MissingFromClause,lookahead.value);}else{consumeSemicolon();}
return node.finishExportNamedDeclaration(declaration,specifiers,src);}
function parseExportDefaultDeclaration(node){var declaration=null,expression=null;expectKeyword('default');if(matchKeyword('function')){declaration=parseFunctionDeclaration(new Node(),true);return node.finishExportDefaultDeclaration(declaration);}
if(matchKeyword('class')){declaration=parseClassDeclaration(true);return node.finishExportDefaultDeclaration(declaration);}
if(matchContextualKeyword('from')){throwError(Messages.UnexpectedToken,lookahead.value);}
if(match('{')){expression=parseObjectInitializer();}else if(match('[')){expression=parseArrayInitializer();}else{expression=parseAssignmentExpression();}
consumeSemicolon();return node.finishExportDefaultDeclaration(expression);}
function parseExportAllDeclaration(node){var src;expect('*');if(!matchContextualKeyword('from')){throwError(lookahead.value?Messages.UnexpectedToken:Messages.MissingFromClause,lookahead.value);}
lex();src=parseModuleSpecifier();consumeSemicolon();return node.finishExportAllDeclaration(src);}
function parseExportDeclaration(){var node=new Node();if(state.inFunctionBody){throwError(Messages.IllegalExportDeclaration);}
expectKeyword('export');if(matchKeyword('default')){return parseExportDefaultDeclaration(node);}
if(match('*')){return parseExportAllDeclaration(node);}
return parseExportNamedDeclaration(node);}
function parseImportSpecifier(){var local,imported,node=new Node();imported=parseNonComputedProperty();if(matchContextualKeyword('as')){lex();local=parseVariableIdentifier();}
return node.finishImportSpecifier(local,imported);}
function parseNamedImports(){var specifiers=[];expect('{');while(!match('}')){specifiers.push(parseImportSpecifier());if(!match('}')){expect(',');if(match('}')){break;}}}
expect('}');return specifiers;}
function parseImportDefaultSpecifier(){var local,node=new Node();local=parseNonComputedProperty();return node.finishImportDefaultSpecifier(local);}
function parseImportNamespaceSpecifier(){var local,node=new Node();expect('*');if(!matchContextualKeyword('as')){throwError(Messages.NoAsAfterImportNamespace);}
lex();local=parseNonComputedProperty();return node.finishImportNamespaceSpecifier(local);}
function parseImportDeclaration(){var specifiers=[],src,node=new Node();if(state.inFunctionBody){throwError(Messages.IllegalImportDeclaration);}
expectKeyword('import');if(lookahead.type===Token.StringLiteral){src=parseModuleSpecifier();}else{if(match('{')){specifiers=specifiers.concat(parseNamedImports());}else if(match('*')){specifiers.push(parseImportNamespaceSpecifier());}else if(isIdentifierName(lookahead)&&!matchKeyword('default')){specifiers.push(parseImportDefaultSpecifier());if(match(',')){lex();if(match('*')){specifiers.push(parseImportNamespaceSpecifier());}else if(match('{')){specifiers=specifiers.concat(parseNamedImports());}else{throwUnexpectedToken(lookahead);}}}else{throwUnexpectedToken(lex());}
if(!matchContextualKeyword('from')){throwError(lookahead.value?Messages.UnexpectedToken:Messages.MissingFromClause,lookahead.value);}
lex();src=parseModuleSpecifier();}
consumeSemicolon();return node.finishImportDeclaration(specifiers,src);}
function parseScriptBody(){var statement,body=[],token,directive,firstRestricted;while(startIndex<length){token=lookahead;if(token.type!==Token.StringLiteral){break;}
statement=parseStatementListItem();body.push(statement);if(statement.expression.type!==Syntax.Literal){break;}
directive=source.slice(token.start+1,token.end-1);if(directive==='use strict'){strict=true;if(firstRestricted){tolerateUnexpectedToken(firstRestricted,Messages.StrictOctalLiteral);}}else{if(!firstRestricted&&token.octal){firstRestricted=token;}}}
while(startIndex<length){statement=parseStatementListItem();if(typeof statement==='undefined'){break;}
body.push(statement);}
return body;}
function parseProgram(){var body,node;peek();node=new Node();body=parseScriptBody();return node.finishProgram(body,state.sourceType);}
function filterTokenLocation(){var i,entry,token,tokens=[];for(i=0;i<extra.tokens.length;++i){entry=extra.tokens[i];token={type:entry.type,value:entry.value};if(entry.regex){token.regex={pattern:entry.regex.pattern,flags:entry.regex.flags};}
if(extra.range){token.range=entry.range;}
if(extra.loc){token.loc=entry.loc;}
tokens.push(token);}
extra.tokens=tokens;}
function tokenize(code,options,delegate){var toString,tokens;toString=String;if(typeof code!=='string'&&!(code instanceof String)){code=toString(code);}
source=code;index=0;lineNumber=(source.length>0)?1:0;lineStart=0;startIndex=index;startLineNumber=lineNumber;startLineStart=lineStart;length=source.length;lookahead=null;state={allowIn:true,allowYield:true,labelSet:{},inFunctionBody:false,inIteration:false,inSwitch:false,lastCommentStart:-1,curlyStack:[]};extra={};options=options||{};options.tokens=true;extra.tokens=[];extra.tokenValues=[];extra.tokenize=true;extra.delegate=delegate;extra.openParenToken=-1;extra.openCurlyToken=-1;extra.range=(typeof options.range==='boolean')&&options.range;extra.loc=(typeof options.loc==='boolean')&&options.loc;if(typeof options.comment==='boolean'&&options.comment){extra.comments=[];}
if(typeof options.tolerant==='boolean'&&options.tolerant){extra.errors=[];}
try{peek();if(lookahead.type===Token.EOF){return extra.tokens;}
lex();while(lookahead.type!==Token.EOF){try{lex();}catch(lexError){if(extra.errors){recordError(lexError);break;}else{throw lexError;}}}
tokens=extra.tokens;if(typeof extra.errors!=='undefined'){tokens.errors=extra.errors;}}catch(e){throw e;}finally{extra={};}
return tokens;}
function parse(code,options){var program,toString;toString=String;if(typeof code!=='string'&&!(code instanceof String)){code=toString(code);}
source=code;index=0;lineNumber=(source.length>0)?1:0;lineStart=0;startIndex=index;startLineNumber=lineNumber;startLineStart=lineStart;length=source.length;lookahead=null;state={allowIn:true,allowYield:true,labelSet:{},inFunctionBody:false,inIteration:false,inSwitch:false,lastCommentStart:-1,curlyStack:[],sourceType:'script'};strict=false;extra={};if(typeof options!=='undefined'){extra.range=(typeof options.range==='boolean')&&options.range;extra.loc=(typeof options.loc==='boolean')&&options.loc;extra.attachComment=(typeof options.attachComment==='boolean')&&options.attachComment;if(extra.loc&&options.source!==null&&options.source!==undefined){extra.source=toString(options.source);}
if(typeof options.tokens==='boolean'&&options.tokens){extra.tokens=[];}
if(typeof options.comment==='boolean'&&options.comment){extra.comments=[];}
if(typeof options.tolerant==='boolean'&&options.tolerant){extra.errors=[];}
if(extra.attachComment){extra.range=true;extra.comments=[];extra.bottomRightStack=[];extra.trailingComments=[];extra.leadingComments=[];}
if(options.sourceType==='module'){state.sourceType=options.sourceType;strict=true;}}
try{program=parseProgram();if(typeof extra.comments!=='undefined'){program.comments=extra.comments;}
if(typeof extra.tokens!=='undefined'){filterTokenLocation();program.tokens=extra.tokens;}
if(typeof extra.errors!=='undefined'){program.errors=extra.errors;}}catch(e){throw e;}finally{extra={};}
return program;}
exports.version='2.7.0';exports.tokenize=tokenize;exports.parse=parse;exports.Syntax=(function(){var name,types={};if(typeof Object.create==='function'){types=Object.create(null);}
for(name in Syntax){if(Syntax.hasOwnProperty(name)){types[name]=Syntax[name];}}
if(typeof Object.freeze==='function'){Object.freeze(types);}
return types;}());}));};BundleModuleCode['jam/sandbox']=function(module,exports){var Json=Require('jam/jsonfn');function sandbox(f,modules,inject,env)
{var p,F,mask,source;mask={mask:undefined,modules:undefined,require:undefined,cp:undefined,f:undefined};for(p in this)
mask[p]=undefined;for(p in modules)
mask[p]=modules[p];if(env)for(p in env)
mask[p]=env[p];if(typeof f=='function')source=f.toString(true);else source=f;if(inject.cp){var regex1=/while[\s]*\(([^\)]+)\)/g;var regex2=/for[\s]*\(([^\)]+)\)/g;var regex3=/function([^\{]+)\{/g;source=source.replace(regex1,"while (($1) && "+inject.cp+"())").replace(regex2,"for ($1,"+inject.cp+"())").replace(regex3,"function $1{"+inject.cp+"();");}
if(inject.rt){var regex4=/catch[\s]*\([\s]*([a-zA-Z0-9_]+)[\s]*\)[\s]*\{/g;source=source.replace(regex4,'catch ($1) {'+inject.rt+'($1);');}
function evalInContext(context,js){return eval('with(context) { "use strict"; F='+js+' }');}
mask.eval=undefined;evalInContext(mask,source);return{fun:F,mask:mask,size:source.length};}
function Sandbox(f,modules,inject,env){var p,mask={},_mask='process';for(p in global){if(p.indexOf('Array')>0)continue;_mask=_mask+','+p;}
for(p in modules)
mask[p]=modules[p];if(env)for(p in env)
mask[p]=env[p];if(typeof f=='function')source=f.toString(true);else source=f;if(inject.cp){var regex1=/while[\s]*\(([^\)]+)\)/g;var regex2=/for[\s]*\(([^\)]+)\)/g;var regex3=/function([^\{]+)\{/g;source=source.replace(regex1,"while (($1) && "+inject.cp+"())").replace(regex2,"for ($1,"+inject.cp+"())").replace(regex3,"function $1{"+inject.cp+"();");}
if(inject.rt){var regex4=/catch[\s]*\([\s]*([a-zA-Z0-9_]+)[\s]*\)[\s]*\{/g;source=source.replace(regex4,'catch ($1) {'+inject.rt+'($1);');}
mask.eval=undefined;_mask+=',eval'
mask.require=undefined;_mask+=',require'
var F=new Function(_mask,'"use strict"; with(this) { f=('+source+').bind(this)} return f').bind(mask);return{fun:F(),mask:mask,_mask:_mask};}
function sandboxObject(obj,mask){var objS;if(typeof obj=='object')obj=Json.stringify(obj);return Json.parse(obj,mask);}
module.exports={sandbox:sandbox,sandboxObject:sandboxObject,Sandbox:Sandbox}
module.exports=function(){return sandbox}};BundleModuleCode['jam/sig']=function(module,exports){var Io=Require('com/io');var Comp=Require('com/compat');var current=none;var Aios=none;var options={debug:{},version:'1.5.3'}
function lookup(node,destnode){var chan,url;if(node.connections.ip&&node.connections.ip.lookup){url=node.connections.ip.lookup(destnode);if(url)return{chan:node.connections.ip,url:url};}}
var sig={broadcast:function(ac,range,sig,arg){var delivered=0;if(!Comp.obj.isString(ac)){current.error='broadcast, invalid class '+ac;throw'SIGNAL'};if(!Comp.obj.isString(sig)&&!Comp.obj.isNumber(sig)){current.error='broadcast, invalid signal '+sig;throw'SIGNAL'};if(range!=0){current.error='broadcast, invalid range '+range;throw'SIGNAL'};for(var p in current.node.processes.table){var proc=current.node.processes.table[p];if(proc&&proc.agent.ac==ac&&proc.agent.on[sig]){proc.signals.push([sig,arg,current.process.agent.id]);delivered++;}}
return delivered;},send:function(to,sig,arg,from,hop){var p,node,delivered,curtime;var pid=current.node.processes.lookup(to);if(options.debug.send)console.log('sig.send',to,sig,arg,from,hop,pid);if(!Comp.obj.isString(sig)&&!Comp.obj.isNumber(sig)){current.error='send, invalid signal';throw'SIGNAL'};current.node.stats.signal++;if(pid!=none){switch(sig){case'PROC.KILL':Aios.kill(to);return true;}
current.node.processes.table[pid].signals.push([sig,arg,from||current.process.agent.id]);return true;}else{if(current.node.processes.gone[to]){if(options.debug.send)print('sig.send',to,sig,arg,from,hop,current.node.processes.gone[to].dir);curtime=Aios.time()-current.world.lag;current.node.processes.gone[to].timeout=curtime+current.node.TMO*10;return route(current.node.processes.gone[to].dir,to,sig,arg,from||current.process.agent.id);}
if(hop>2)return true;if(current.node.parent){return current.node.parent.handle({to:to,sig:sig,arg:arg,from:from,hop:hop?hop+1:1})}else if(current.node.children){delivered=false;for(p in current.node.children){node=current.node.children[p];delivered=node.handle({to:to,sig:sig,arg:arg,from:from,hop:hop?hop+1:1});if(delivered)break;}
if(delivered)return true;}
if(current.node.signals[to]){curtime=Aios.time()-current.world.lag;current.node.signals[to].timeout=curtime+current.node.TMO*10;return route(current.node.signals[to].dir,to,sig,arg,from||current.process.agent.id);}}
return false;},sendto:function(to,sig,arg,from){var delivered=0,i;if(!Comp.obj.isString(sig)&&!Comp.obj.isNumber(sig)){current.error='sendto, invalid signal '+sig;throw'SIGNAL'};if((to.tag||to).indexOf('DIR')!=0){current.error='sendto, invalid destination '+to;throw'SIGNAL'};if(to==Aios.DIR.ORIGIN||(to.delta&&Comp.array.zero(to.delta))){if(sig=='TS.SIG'){for(i in arg){Aios.Ts.agent.out(arg[i]);}}else for(var p in current.node.processes.table){var proc=current.node.processes.table[p];if(proc&&proc.agent.on&&proc.agent.on[sig]){proc.signals.push([sig,arg,from||current.process.agent.id]);delivered++;}}
return delivered;}else{return route(to,none,sig,arg,current.process.agent.id);}},sleep:function(tmo){current.process.suspend(tmo?Aios.time()-current.world.lag+tmo:0);},timer:{add:function(tmo,sig,arg,repeat){if(!Comp.obj.isNumber(tmo)){current.error='timer, invalid timeout '+tmo;throw'SIGNAL'};if(!Comp.obj.isString(sig)){current.error='timer, invalid signal '+sig;throw'SIGNAL'};current.node.timers.push([current.process,(Aios.time()-current.world.lag+tmo),sig,arg,repeat?tmo:0]);return sig;},delete:function(sig){current.node.timers=current.node.timers.filter(function(t){return t[2]!=sig});}},timeout:function(tmo){return Aios.time()-current.world.lag+tmo},wakeup:function(process){if(!process)current.process.wakeup();else process.wakeup();}}
function route(dir,to,sig,arg,from){var node1=current.node,chan=none,dest,stat,alive=function(){return 1},sigobj={sig:sig,to:to||dir,from:from,arg:arg,back:Aios.DIR.opposite(dir,true)},msg;switch(dir.tag||dir){case Aios.DIR.NORTH:chan=node1.connections.north;break;case Aios.DIR.SOUTH:chan=node1.connections.south;break;case Aios.DIR.WEST:chan=node1.connections.west;break;case Aios.DIR.EAST:chan=node1.connections.east;break;case Aios.DIR.UP:chan=node1.connections.up;break;case Aios.DIR.DOWN:chan=node1.connections.down;break;case Aios.DIR.NW:chan=node1.connections.nw;break;case Aios.DIR.NE:chan=node1.connections.ne;break;case Aios.DIR.SE:chan=node1.connections.se;break;case Aios.DIR.SW:chan=node1.connections.sw;break;case'DIR.IP':chan=node1.connections.ip;dest=dir.ip;break;case'DIR.DELTA':sigobj.to=Comp.obj.copy(sigobj.to);if(dir.delta[0]>0&&node1.connections.east&&node1.connections.east.status())
sigobj.to.delta[0]--,chan=node1.connections.east;else if(dir.delta[0]<0&&node1.connections.west&&node1.connections.west.status())
sigobj.to.delta[0]++,chan=node1.connections.west;else if(dir.delta[1]>0&&node1.connections.south&&node1.connections.south.status())
sigobj.to.delta[1]--,chan=node1.connections.south;else if(dir.delta[1]<0&&node1.connections.north&&node1.connections.north.status())
sigobj.to.delta[1]++,chan=node1.connections.north;else if(dir.delta[2]>0&&node1.connections.up&&node1.connections.up.status())
sigobj.to.delta[2]--,chan=node1.connections.up;else if(dir.delta[2]<0&&node1.connections.down&&node1.connections.down.status())
sigobj.to.delta[2]++,chan=node1.connections.down;break;case'DIR.PATH':chan=node1.connections.path;dest=dir.path;break;case'DIR.CAP':if(!current.network){current.error='No connection to server '+dir.cap;return false;};chan=node1.connections.dos;dest=Net.Parse.capability(dir.cap).cap;break;case'DIR.NODE':if(node1.connections.range&&node1.connections.range[dir.node]&&node1.connections.range[dir.node].status())
chan=node1.connections.range[dir.node],dest=dir.node;else{dest=lookup(node1,dir.node);if(dest)chan=dest.chan,dest=dest.url;}
break;default:return false;}
switch(dir.tag||dir){case Aios.DIR.NORTH:case Aios.DIR.SOUTH:case Aios.DIR.WEST:case Aios.DIR.EAST:case Aios.DIR.UP:case Aios.DIR.DOWN:case Aios.DIR.NW:case Aios.DIR.NE:case Aios.DIR.SE:case Aios.DIR.SW:sigobj.to=Aios.DIR.ORIGIN;break;}
if(options.debug.route)console.log('sig.route',node1.id,dir,sigobj,chan!=null);if(chan==none||!chan.status(dest)){current.error='No connection to direction '+dir;return false;};node1.stats.signal++;if(Aios.options.fastcopy&&chan.virtual)msg=sigobj;else msg=Aios.Code.toString(sigobj);chan.send({signal:msg,to:dest});return true;}
module.exports={agent:sig,options:options,route:route,current:function(module){current=module.current;Aios=module;}}};BundleModuleCode['jam/node']=function(module,exports){var Io=Require('com/io');var Comp=Require('com/compat');var Security=Require('jam/security');var current=none;var Aios=none;var options={debug:{},verbose:0,version:'1.13.2'}
function aid(process){return process.agent.id+':'+process.pid}
function min0(a,b){return a==0?b:(b==0?a:Comp.pervasives.min(a,b))};var node=function(options){var self=this;options=checkOptions(options,{});this.options=options;this.id=checkOption(this.options.id,Aios.aidgen());this.position=checkOption(this.options.position,Aios.DIR.ORIGIN);this.type=checkOption(this.options.type,'generic');this.verbose=checkOption(this.options.verbose,0);this.defaultLevel=checkOption(this.options.defaultLevel,Aios.options.LEVEL);this.processes={free:none,max:checkOption(this.options.maxpro,100),table:[],hash:[],top:0,used:0,gone:[]};this.processes.lookup=function(aid){if(self.processes.hash[aid]!=undefined)
return self.processes.hash[aid];else
return none;};this.processes.process=function(aid){if(self.processes.hash[aid]!=_)
return self.processes.table[self.processes.hash[aid]];else
return none;};this.signals=[];this.timers=[];this.connections={north:none,south:none,west:none,east:none};this.ts=Aios.Ts.create({maxn:checkOption(this.options.maxts,8),id:this.id,node:self});this.random={};this.port=Security.Port.unique();this.random[this.port]=Security.Port.unique();this.library={};this.location=null;this.position=options.position;this.stats={cpu:0,create:0,fastcopy:0,fork:0,handled:0,migrate:0,received:0,signal:0,error:0,tsout:0,tsin:0,agents:0,}
this.TMO=checkOption(this.options.TMO,100000);this.timeout=0;Aios.emit('node+',self);};node.prototype.destroy=function(){var p,pro,_node=current.node,self=this;this.connections={};if(this.verbose>2)console.log('node.destroy',this)
current.node=this;for(p in this.processes.table){pro=this.processes.table[p];if(!pro)continue;pro.kill=true;this.unregister(pro);}
this.processes.gone=[];this.ts=none;current.node=_node;if(this.parent){this.parent.children=this.parent.children.filter(function(node){return node!=self});}
if(this.children){this.children.forEach(function(node){node.parent=null;})}
Aios.emit('node-',self);}
node.prototype.export=function(name,code){if(!this.library[name])
this.library[name]=Aios.Code.toString(code);}
node.prototype.getAgent=function(id,ac){var pros=this.getAgentProcess(id,ac);if(pros&&Comp.obj.isArray(pros))
return Comp.array.map(pros,function(pro){return pro.agent});else if(pros)return pros.agent;};node.prototype.getAgentProcess=function(id,ac){var matches=Comp.obj.isRegex(id)?[]:undefined,table=this.processes.table,p;if(!matches&&this.processes.hash[id]!=undefined){p=table[this.processes.hash[id]];if(!ac||p.agent.ac==ac)return p;}
if(typeof id=='number')return table[id];for(var p in table){if(!table[p])continue;if(!matches&&table[p].agent.id==id&&(!ac||table[p].agent.ac==ac))
return table[p];if(matches&&id.test(table[p].agent.id)&&(!ac||table[p].agent.ac==ac))
matches.push(table[p]);}
return matches;};node.prototype.handle=function(msg){var delivered,tmo,curtime=Aios.time()-current.world.lag,_node=current.node,self=this,sigobj=(typeof msg=='string')?Aios.Code.ofString(msg,{}):msg;if(options.debug.handle)console.log('node.handle',this.id,sigobj);if(!sigobj)return;current.node=this;delivered=(Aios.Mobi.DIR.isDir(sigobj.to)?Aios.Sig.agent.sendto:Aios.Sig.agent.send)
(sigobj.to,sigobj.sig,sigobj.arg,sigobj.from,sigobj.hop);if(delivered&&sigobj.back){tmo=curtime+this.TMO;this.signals[sigobj.from]={dir:sigobj.back,timeout:tmo};this.timeout=min0(this.timeout,tmo);};this.stats.handled++;current.node=_node;Aios.emit('schedule',self);return delivered;}
node.prototype.import=function(name){var code;if(this.library[name])code=Aios.Code.ofString(this.library[name],current.process.mask);return code;}
node.prototype.info=function(){var self=this,p,obj={};ovj.stats=this.stats;obj.id=this.id;obj.position=this.position;obj.agents={};var update=function(obj){var p;for(p in obj){if(p!='_update')delete obj[p];}
for(p in self.processes.hash){if(self.processes.hash[p]!=_)
obj[p]=self.processes.table[self.processes.hash[p]];};}
obj.agents._update=update;update(obj.agents);obj.signals=this.signals;obj.timers=this.timers;obj.ts=this.ts;obj.connections=this.connections;return obj;}
node.prototype.print=function(summary){var i,blocked,pending,total,ghost=0;var str='==== NODE '+this.id+' ===='+NL;str+='SYSTIME='+Aios.time()+NL;str+='PROCESS TABLE >>'+NL;if(summary){blocked=0;pending=0;total=0;ghost=0;for(i in this.processes.table){if(this.processes.table[i]!=_){total++;if(this.processes.table[i].blocked)blocked++;if(this.processes.table[i].signals.length>0)pending++;if(this.processes.table[i].agent.next==undefined)ghost++;};}
str+='  TOTAL='+total+' BLOCKED='+blocked+' DYING='+ghost+' SIGPEND='+pending+NL;}else{for(i in this.processes.table){if(this.processes.table[i]!=_){str+='  ['+aid(this.processes.table[i])+'] '+'NEXT='+this.processes.table[i].agent.next+' '+
this.processes.table[i].print();};}}
if(this.timers.length>0){str+='TIMER TABLE >>'+NL;for(i in this.timers){str+='  ['+aid(this.timers[i][0])+'] TMO='+this.timers[i][1]+' SIG='+this.timers[i][2]+NL;}}
str+='TUPLE SPACES >>'+NL;if(summary)str+='  '+this.ts.print(summary);else str+=this.ts.print(summary);return str;}
node.prototype.receive=function(msg,start,from){var _process=current.process,_node=current.node,self=this,process,agent;if(options.debug.receive)console.log('node.receive (start='+start+',length='+msg.length+'):\n<'+msg+'>');if(typeof msg!=='object')process=Aios.Code.toCode(msg,this.defaultLevel);else process=Aios.Code.ofObject(msg);if(!process)return;agent=process.agent;agent['self']=agent;this.register(process);this.stats.received++;if(process.dir||process.delta){return;};if((!process.back||process.back.tag=='DIR.IP')&&from&&from.address&&from.port)
process.back=Aios.DIR.IP(from.address+':'+from.port);if(process.back&&process.agent.parent){tmo=Aios.time()-current.world.lag+this.TMO;this.signals[process.agent.parent]={dir:process.back,timeout:tmo};this.timeout=min0(this.timeout,tmo);}
if(process.schedule.length==0){current.node=this;current.process=process;try{if(!start)
agent.next=(typeof agent.trans[agent.next]=='function')?agent.trans[agent.next].call(agent):agent.trans[agent.next];if(process.blocked)throw'BLOCKING';}catch(e){Aios.aios.log('Node.receive: Agent '+agent.id+' ['+agent.ac+'] in transition '+agent.next+' failed:\n'+e+(current.error?' / '+current.error:', in: \n'+Aios.Code.print(agent.trans[agent.next]))+'\nat:\n'+Io.sprintstack(e));this.unregister(process);};current.node=_node;current.process=_process;}}
node.prototype.register=function(process){var i,p,self=this,agent=process.agent;if(this.processes.free==none){loop:for(i in this.processes.table){if(this.processes.table[i]==_){this.processes.free=i;break loop};}}
if(this.processes.free!=none){this.processes.table[this.processes.free]=process;process.pid=this.processes.free;process.agent=agent;this.processes.free=none;}else{this.processes.table[this.processes.top]=process;process.agent=agent;process.pid=this.processes.top;this.processes.top++;}
if(agent.id==undefined)agent.id=Aios.aidgen();this.processes.hash[agent.id]=process.pid;this.processes.used++;this.stats.agents++;if(this.processes.gone[process.agent.id])
this.processes.gone[process.agent.id]=undefined;process.node=this;Aios.emit('agent+',{agent:agent,proc:process,node:self},self);Aios.emit('schedule',self);}
node.prototype.service=function(curtime){var nexttime=0,p,pro,sig;this.ts.service(curtime);if(curtime<this.timeout)return;for(p in this.processes.gone){pro=this.processes.gone[p];if(pro==undefined)continue;if(pro.timeout<curtime){this.processes.gone[p]=undefined;}
else
nexttime=min0(nexttime,pro.timeout);}
for(p in this.signals){sig=this.signals[p];if(sig==undefined)continue;if(sig.timeout<curtime){this.signals[p]=undefined;}
else
nexttime=min0(nexttime,sig.timeout);}
this.timeout=nexttime;}
node.prototype.std_info=function(what){if(what==undefined)return{defaultLevel:this.defaultLevel,id:this.id,location:this.location,position:this.position,type:this.type,}
if(what.agent){}}
node.prototype.std_status=function(what){var data,self=this;if(!what||what=='node')return this.stats;if(what=='agents')return Comp.array.filtermap(this.processes.table,function(pro,index){if(pro)return{index:index,agent:pro.agent.id,blocked:pro.blocked,suspended:pro.suspended,signals:pro.signals.length,next:pro.agent.next,}})
if(what=='links'){data={}
for(var p in this.connections){if(!this.connections[p])continue;if(p=='ip')data.ip=Comp.array.map(this.connections[p].links,function(link){return{ip:link.ip,stats:link.stats(),status:link.status('%'),}})}
return data;}}
node.prototype.unregister=function(process){var i,p,remove,self=this,tmo,agent=process.agent,curtime=Aios.time()-current.world.lag;remove=false;Comp.array.iter(this.timers,function(timer,i){if(timer&&timer[0].pid==process.pid){self.timers[i]=_;remove=true;}});if(remove)
this.timers=Comp.array.filter(this.timers,function(timer){return timer!=undefined;});this.processes.table[process.pid]=_;delete this.processes.hash[agent.id];if(this.processes.free==none)this.processes.free=process.pid;this.ts.cleanup(process);process.pid=none;process.signals=[];process.dead=true;this.processes.used--;this.stats.agents--;if(process.move){tmo=curtime+this.TMO;this.processes.gone[process.agent.id]={dir:process.move,timeout:tmo};this.timeout=min0(this.timeout,tmo);}
Aios.emit('agent-',{agent:agent,node:self,proc:process},self);}
var Node=function(options,setcurrent){var obj=new node(options);if(setcurrent)current.node=obj;return obj;}
module.exports={isNode:function(o){return o instanceof Node},Node:Node,options:options,current:function(module){current=module.current;Aios=module;}}};BundleModuleCode['jam/security']=function(module,exports){var Io=Require('com/io');var Des48=Require('dos/des48');var Base64=Require('os/base64');var Comp=Require('com/compat');var String=Comp.string;var Array=Comp.array;var Perv=Comp.pervasives;var current=none;var Aios=none;var Rnd=Require('com/pwgen');var PORT_SIZE=6;var PRIV_SIZE=4+PORT_SIZE;var CAP_SIZE=16;var PRV_ALL_RIGHTS=0xff;var priv2pub_cache=[];var uniquePorts={};var Rights={HOST_INFO:0x01,HOST_READ:0x02,HOST_WRITE:0x04,HOST_EXEC:0x08,PSR_READ:0x01,PSR_WRITE:0x02,PSR_CREATE:0x04,PSR_DELETE:0x08,PSR_EXEC:0x10,PSR_KILL:0x20,PSR_ALL:0xff,NEG_SCHED:0x08,NEG_CPU:0x10,NEG_RES:0x20,NEG_LIFE:0x40,NEG_LEVEL:0x80,PRV_ALL_RIGHTS:0xff};var Port=function(port_vals){if(port_vals==undefined)port_vals=[0,0,0,0,0,0];var port='';for(var i=0;i<PORT_SIZE;i++){port=port+Perv.char_of_int(port_vals[i]);}
return port;};var Private=function(obj,rights,rand){if(obj==undefined){return{prv_obj:0,prv_rights:0,prv_rand:Port()}}else{return{prv_obj:obj,prv_rights:rights,prv_rand:rand}}}
var Capability=function(cap_port,cap_priv){if(cap_port==undefined){return{cap_port:Port(),cap_priv:Private()}}else{return{cap_port:cap_port,cap_priv:cap_priv?cap_priv:Private()}}}
function cap_parse(str,offset){var cap=Capability(),pos=0;if(offset!=undefined)pos=offset;var pp=port_parse(str,pos);if(pp==undefined)return undefined;cap.cap_port=pp.port;pos=pp.pos;pp=prv_parse(str,pos);if(pp==undefined)return undefined;cap.cap_priv=pp.priv;pos=pp.pos;return{cap:cap,pos:pos};}
function cap_of_string(str){var pp=cap_parse(str,0);return pp?pp.cap:undefined}
function cap_to_string(cap){var str='';if(cap==undefined)return'undefined';if(cap.cap_port!=undefined)str='['+port_to_string(cap.cap_port)+']';else str='[]';if(cap.cap_priv!=undefined)str=str+'('+prv_to_string(cap.cap_priv)+')';else str=str+'()';return str;}
function get_portbyte(port,i){return Perv.int_of_char(String.get(port,i))}
function set_portbyte(port,i,byte){return String.set(port,i,(Perv.char_of_int(byte)));}
function one_way(port){var key=Array.create(64,0);var block=Array.create(48,0);var pubport=String.make(PORT_SIZE,'\0');var i,j,k;j=0;for(i=0;i<64;i++){if((i&7)>5)
key[i]=0;else{if((get_portbyte(port,(j>>3))&(1<<(j&7)))!=0)
key[i]=1;else
key[i]=0;j++;}}
Des48.des_OWsetkey(key);block=Des48.des_OWcrypt48(block);var pb=0;for(i=0;i<PORT_SIZE;i++){var pbyte=0;for(j=0;j<8;j++){pbyte=pbyte|(block[pb]<<j);pb++;}
pubport=set_portbyte(pubport,i,pbyte);}
return pubport;}
function pad(str,size){while(str.length<(size||2)){str="0"+str;}
return str;}
function port_cmp(port1,port2){if(port1==undefined||port2==undefined)return(port1==port2);else return String.equal(port1,port2);}
function port_copy(port){return String.copy(port);}
function port_of_string(str,compact){var tokens=str.split(':'),i,port='';for(i=0;i<PORT_SIZE;i++){var num='0x'+tokens[i];port=port+Perv.char_of_int(parseInt(num,16));}
return port;}
function port_parse(str,pos){var port='';var len=str.length;if(pos==undefined)pos=0;if(len<(pos+17))return undefined;if(str[pos]=='[')pos++;for(var i=0;i<6;i++){var sv='0x'+str[pos]+str[pos+1];port=port+Perv.char_of_int(Perv.int_of_string(sv));pos=pos+2;if(str[pos]==':')pos++;}
if(str[pos]==']')pos++;return{port:port,pos:pos};}
function port_to_string(port,compact){var i,str='';if(port){for(i=0;i<PORT_SIZE;i++){var num=Perv.int_of_char(String.get(port,i));if(!compact&&i>0)str=str+':';str=str+pad(num.toString(16).toUpperCase(),2);}}else str='undefined';return str;}
function prv2pub(port){var putport;if(priv2pub_cache[port]==undefined){putport=one_way(port);priv2pub_cache[port]=putport;}else putport=priv2pub_cache[port];return putport;}
function prv_cmp(prv1,prv2){return(prv1==undefined&&prv2==undefined)||(prv1.prv_obj==prv2.prv_obj&&prv1.prv_rights==prv2.prv_rights&&port_cmp(prv1.prv_rand,prv2.prv_rand))}
function prv_decode(prv,rand){if(prv.prv_rights==PRV_ALL_RIGHTS)
return port_cmp(prv.prv_rand,rand);else{var tmp_port=port_copy(rand),pt0=get_portbyte(tmp_port,0),pr0=prv.prv_rights;tmp_port=set_portbyte(tmp_port,0,(pt0^pr0));tmp_port=one_way(tmp_port);return port_cmp(prv.prv_rand,tmp_port)}}
function prv_encode(obj,rights,rand){var tmp_port=port_copy(rand),r1=rights,rmask=PRV_ALL_RIGHTS;if(rights==PRV_ALL_RIGHTS)
return Private(obj,r1&rmask,tmp_port);else{var pt0=get_portbyte(tmp_port,0);tmp_port=set_portbyte(tmp_port,0,pt0^r1);tmp_port=one_way(tmp_port);return Private(obj,r1&rmask,tmp_port)}}
function prv_of_string(str){var pp=prv_parse(str,0);return pp?pp.priv:undefined}
function prv_number(prv){return prv.prv_obj;}
function prv_parse(str,offset){var priv=Private();var sv;var len=str.length,pos=offset;if(str[pos]=='(')pos++;sv='';while(str[pos]!='('){sv=sv+str[pos];pos++;}
priv.prv_obj=Perv.int_of_string(sv);sv='';if(str[pos]=='(')pos++;while(str[pos]!=')'){sv=sv+str[pos];pos++;}
priv.prv_rights=Perv.int_of_string('0x'+sv);if(str[pos]==')')pos++;var pp=port_parse(str,pos);if(pp==undefined)return undefined;priv.prv_rand=pp.port;pos=pp.pos;return{priv:priv,pos:pos};}
function prv_to_string(priv){var str='';if(priv==undefined)return'undefined';str=priv.prv_obj;str=str+'('+String.format_hex(priv.prv_rights,2).toUpperCase()+')[';str=str+port_to_string(priv.prv_rand)+']';return str;}
function prv_restrict(priv,mask,random){var pr=prv_encode(priv.prv_obj,priv.prv_rights&mask,random);return pr;}
function prv_rights(prv){return prv.prv_rights&Rights.PRV_ALL_RIGHTS;}
function prv_rights_check(prv,rand,required){if(!prv_decode(prv,rand))return false;return(prv.prv_rights&required)==required;}
function uniqport(){var port=String.create(PORT_SIZE);var i,values;do{values=Rnd.generate({number:true,length:PORT_SIZE});for(i=0;i<=(PORT_SIZE-1);i++)
port=String.set(port,i,(Perv.char_of_int(values[i])));if(uniquePorts[port])uniquePorts[port]++;else uniquePorts[port]=1;}while(uniquePorts[port]>1);return port;}
Port.equal=port_cmp
Port.toString=port_to_string
Port.ofString=port_of_string
Port.prv2pub=prv2pub
Port.random=uniqport
Port.unique=uniqport
Private.decode=prv_decode
Private.encode=prv_encode
Private.equal=prv_cmp
Private.number=prv_number
Private.ofString=prv_of_string
Private.restrict=prv_restrict
Private.rights=prv_rights
Private.rights_check=prv_rights_check
Private.toString=prv_to_string
Capability.toString=cap_to_string
Capability.ofString=cap_of_string
var Security={current:function(module){current=module.current;Aios=module;},PORT_SIZE:PORT_SIZE,PRIV_SIZE:PRIV_SIZE,Rights:Rights,Private:Private,Capability:Capability,Port:Port,nilport:Port(),nilpriv:Private(0,0,Port()),nilcap:Capability(Port(),Private(0,0,Port())),one_way:one_way,prv2pub:prv2pub,}
module.exports=Security;};BundleModuleCode['dos/des48']=function(module,exports){var util=Require('util');var Io=Require('com/io');var Comp=Require('com/compat');var Array=Comp.array;var assert=Comp.assert;const des_HBS=24;const des_BS=des_HBS*2;var des_IP=[23,27,34,44,37,17,12,42,3,32,41,29,20,2,1,10,0,28,40,6,7,11,16,8,25,30,14,26,47,38,19,43,18,5,35,39,36,21,4,45,24,22,13,33,31,9,15,46];var des_FP=[16,14,13,8,38,33,19,20,23,45,15,21,6,42,26,46,22,5,32,30,12,37,41,0,40,24,27,1,17,11,25,44,9,43,2,34,36,4,29,35,18,10,7,31,3,39,47,28];var des_PC1_C=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36];var des_PC1_D=[63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4];var des_shifts=[1,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1];var des_PC2_C=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2];var des_PC2_D=[41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32];var des_C=Array.create(56,0);var des_D_get=function(i){return des_C[i+28]};var des_D_set=function(i,sval){des_C[i+28]=sval};var des_KS=Array.create_matrix(16,48,0);var des_OWsetkey=function(key){var ks=[];var t=0;var i,j,k;for(i=0;i<28;i++){var index1=des_PC1_C[i]-1;var index2=des_PC1_D[i]-1;des_C[i]=key[index1];des_D_set(i,key[index2]);}
for(i=0;i<16;i++){ks=des_KS[i];for(k=0;k<des_shifts[i];k++){t=des_C[0];for(j=0;j<27;j++){des_C[j]=-des_C[j+1];}
des_C[27]=t;t=des_D_get(0);for(j=0;j<27;j++){des_D_set(j,des_D_get(j+1));}
des_D_set(27,t);}
for(j=0;j<24;j++){ks[j]=des_C[des_PC2_C[j]-1];ks[j+24]=des_D_get(des_PC2_D[j]-28-1);}}};var des_E=[22,15,12,3,8,2,23,16,14,13,9,10,0,1,21,19,18,6,11,7,17,4,20,5,5,17,11,13,12,14,8,7,19,22,18,9,3,4,1,6,16,2,20,15,10,23,0,21];var des_S=[[14,4,13,1,2,15,11,8,3,10,6,12,5,9,0,7,0,15,7,4,14,2,13,1,10,6,12,11,9,5,3,8,4,1,14,8,13,6,2,11,15,12,9,7,3,10,5,0,15,12,8,2,4,9,1,7,5,11,3,14,10,0,6,13],[15,1,8,14,6,11,3,4,9,7,2,13,12,0,5,10,3,13,4,7,15,2,8,14,12,0,1,10,6,9,11,5,0,14,7,11,10,4,13,1,5,8,12,6,9,3,2,15,13,8,10,1,3,15,4,2,11,6,7,12,0,5,14,9],[10,0,9,14,6,3,15,5,1,13,12,7,11,4,2,8,13,7,0,9,3,4,6,10,2,8,5,14,12,11,15,1,13,6,4,9,8,15,3,0,11,1,2,12,5,10,14,7,1,10,13,0,6,9,8,7,4,15,14,3,11,5,2,12],[7,13,14,3,0,6,9,10,1,2,8,5,11,12,4,15,13,8,11,5,6,15,0,3,4,7,2,12,1,10,14,9,10,6,9,0,12,11,7,13,15,1,3,14,5,2,8,4,3,15,0,6,10,1,13,8,9,4,5,11,12,7,2,14],[2,12,4,1,7,10,11,6,8,5,3,15,13,0,14,9,14,11,2,12,4,7,13,1,5,0,15,10,3,9,8,6,4,2,1,11,10,13,7,8,15,9,12,5,6,3,0,14,11,8,12,7,1,14,2,13,6,15,0,9,10,4,5,3],[12,1,10,15,9,2,6,8,0,13,3,4,14,7,5,11,10,15,4,2,7,12,9,5,6,1,13,14,0,11,3,8,9,14,15,5,2,8,12,3,7,0,4,10,1,13,11,6,4,3,2,12,9,5,15,10,11,14,1,7,6,0,8,13],[4,11,2,14,15,0,8,13,3,12,9,7,5,10,6,1,13,0,11,7,4,9,1,10,14,3,5,12,2,15,8,6,1,4,11,13,12,3,7,14,10,15,6,8,0,5,9,2,6,11,13,8,1,4,10,7,9,5,0,15,14,2,3,12],[13,2,8,4,6,15,11,1,10,9,3,14,5,0,12,7,1,15,13,8,10,3,7,4,12,5,6,11,0,14,9,2,7,11,4,1,9,12,14,2,0,6,10,13,15,3,5,8,2,1,14,7,4,10,8,13,15,12,9,0,3,5,6,11]];var des_P=[3,13,9,12,8,20,21,7,5,23,16,1,14,18,4,15,22,10,2,0,11,19,17,6];var des_L=Array.create(des_BS,0);var des_R_get=function(i){return des_L[(i+des_HBS)]};var des_R_set=function(i,sval){des_L[i+des_HBS]=sval};var des_tempL=Array.create(des_HBS,0);var des_f=Array.create(32,0);var des_preS=Array.create(48,0);var des_OWcrypt48=function(block){var ks=[];var t1=0;var t2=0;var i,j,k;for(j=0;j<=(des_BS-1);j++){des_L[j]=block[des_IP[j]];}
for(i=0;i<=15;i++){ks=des_KS[i];for(j=0;j<(des_HBS-1);j++){des_tempL[j]=des_R_get(j);}
for(j=0;j<=47;j++){des_preS[j]=(des_R_get(des_E[j]))^ks[j];}
t1=0;t2=0;for(j=0;j<=7;j++){var sind2=((des_preS[t1+0]<<5)&0xff)+
((des_preS[t1+1]<<3)&0xff)+
((des_preS[t1+2]<<2)&0xff)+
((des_preS[t1+3]<<1)&0xff)+
((des_preS[t1+4]<<0)&0xff)+
((des_preS[t1+5]<<4)&0xff);k=des_S[j][sind2];des_f[t2+0]=(k>>3)&0x1;des_f[t2+1]=(k>>2)&0x1;des_f[t2+2]=(k>>1)&0x1;des_f[t2+3]=(k>>0)&0x1;t1=t1+6;t2=t2+4;}
for(j=0;j<des_HBS;j++){des_R_set(j,(des_L[j]^des_f[des_P[j]]));}
for(j=0;j<des_HBS;j++){des_L[j]=des_tempL[j];}}
for(j=0;j<des_HBS;j++){t1=des_L[j];des_L[j]=des_R_get(j);des_R_set(j,t1);}
for(j=0;j<des_BS;j++){block[j]=des_L[des_FP[j]];}
return block;};module.exports={des_OWsetkey:des_OWsetkey,des_OWcrypt48:des_OWcrypt48};};BundleModuleCode['jam/proc']=function(module,exports){var Comp=Require('com/compat');var current=none;var Aios=none;var options={debug:{},version:'1.7.2'}
var PRIO={LOW:0,NORMAL:1,HIGH:2}
var proc=function(properties){this.agent={};this.block=[];this.blocked=false;this.timeout=0;this.runtime=0;this.resources={start:Aios.clock('ms'),consumed:0,memory:0,tuples:0,agents:0,}
this.level=undefined;this.priority=PRIO.NORMAL;this.schedule=[];this.suspended=false;this.suspendedIn=undefined;this.error=none;this.pid=none;this.gid=none;this.id='agent';this.mask={};this.signals=[];this.move=none;this.kill=false;this.dead=false;this.transition=false;this.notransition=false;for(var p in properties){if(properties[p]!=undefined)this[p]=properties[p];}
this.shape=undefined;if(current.world)this.parent=current.world.context;this.node=current.node;}
proc.prototype.callback=function(cb,args){var _process=current.process,_node=current.node,res;current.node=this.node;current.process=this;try{res=cb.apply(this.agent,args||[]);}catch(e){Aios.aios.log('Caught callback error: '+e);}
current.process=_process;current.node=_node;return res;}
proc.prototype.exec=function(){var _process=current.process,_node=current.node,res;current.node=this.node;res=Aios.schedule(this);current.process=_process;current.node=_node;return res;}
proc.prototype.finalize=function(){this.kill=true;this.suspended=false;current.node.unregister(this);}
proc.prototype.fork=function(parameters,level,dirty){var code,_process=current.process,agent=current.process.agent,process_,agent_,p;parameters=parameters||{};current.process.resources.agents++;if(dirty&&level!=undefined)dirty=false;if(level==undefined)level=current.process.mask.privilege();else level=Math.min(current.process.mask.privilege(),level);if(!dirty){code=Aios.Code.forkCode(current.process);process_=Aios.Code.toCode(code,level);}else{process_=Aios.Code.copyProcess(current.process);}
agent_=process_.agent
agent_.id=Aios.aidgen();agent_.parent=current.process.agent.id;process_.init({gid:current.process.pid});current.process=process_;current.node.register(process_);for(p in agent){if(agent[p]===null)agent_[p]=null;}
for(p in parameters){if(Comp.obj.hasProperty(agent_,p))agent_[p]=parameters[p];}
if(!parameters.next)try{agent_.next=(typeof agent_.trans[agent_.next]=='function')?agent_.trans[agent_.next].call(agent_):agent_.trans[agent_.next];}catch(e){process_.kill=true;};this.node.stats.fork++;current.process=_process;return process_;}
proc.prototype.init=function(properties){for(var p in properties){if(this[p]!=undefined)this[p]=properties[p];}}
proc.prototype.print=function(){var str='',agent=this.agent;str='PID='+this.pid+
(this.gid?' GID='+this.gid:'')+
(this.timeout?(' TMO='+this.timeout):'')+
(this.blocked?' BLOCKED':'')+
(this.suspended?' SUSP':'')+
(this.kill?' KILL':'')+
(this.dead?' DEAD':'');if(this.schedule.length>0)str+=' SCHEDULE='+this.schedule.length;if(this.block.length>0)str+=' BLOCK='+this.block.length;if(this.signals.length>0)str+=' SIGNALS('+this.signals.length+'):'+
Comp.printf.list(this.signals,function(s){return s[0]});if(this.transition)str+=' TRANS';if(this.consumed|0)str+=' CONS='+(this.consumed|0);if(agent)str+=' AGENT '+agent.id+' next='+agent.next;return str;}
proc.prototype.suspend=function(timeout,transition,suspendedIn){if(!this.kill&&!this.dead){this.suspended=true;if(timeout!=undefined)this.timeout=timeout;if(transition)this.transition=true;this.suspendedIn=suspendedIn;}}
proc.prototype.update=function(properties){for(var p in properties){this[p]=properties[p];}}
proc.prototype.upgrade=function(level){var aios;switch(level){case undefined:case 0:aios=Aios.aios0;break;case 1:aios=Aios.aios1;break;case 2:aios=Aios.aios2;break;case 3:aios=Aios.aios3;break;default:aios=Aios.aios0;break;}
for(p in aios){this.mask[p]=aios[p];}}
proc.prototype.wakeup=function(immediate){this.suspended=false;this.timeout=0;if(!this.kill&&!this.dead&&(immediate||this.schedule.length==0)){var _process=current.process,_node=current.node;current.node=this.node;if(this.suspendedIn=='ts')this.node.ts.cleanup(this,true);this.suspendedIn=undefined;this.transition=this.schedule.length==0;Aios.schedule(this);current.process=_process;current.node=_node;}else Aios.scheduled++;}
function Proc(properties){var obj=new proc(properties);return obj;}
module.exports={agent:{fork:function fork(parameters){return current.process.fork(parameters);}},isProc:function(o){return o instanceof Proc},Proc:Proc,PRIO:PRIO,current:function(module){current=module.current;Aios=module;},options:options}};BundleModuleCode['jam/ts']=function(module,exports){var Io=Require('com/io');var Comp=Require('com/compat');var current=none;var Aios=none;var verbose=false;var options={debug:{},version:'1.10.3',timeout:0,}
function aid(process){return process.agent.id+':'+process.pid}
function log(tsi,process,msg){if(verbose&&process)Aios.aios.log('[TS'+(tsi.i)+':'+current.node.ts.id+'] Ag '
+aid(process)+' '+msg);else if(verbose)Io.log('[TS'+(tsi.i)+':'+current.node.ts.id+'] SYS'+msg);}
function min0(a,b){return a==0?b:(b==0?a:Comp.pervasives.min(a,b))};var addwaiter=function(tsi,waiter){var index,key;if(tsi.waiters.free.length==0){index=tsi.waiters.length;tsi.waiters.push(waiter);}else{index=tsi.waiters.free[0];tsi.waiters[index]=waiter;tsi.waiters.free.shift();}
if(typeof(key=waiter.pat[0])=='string')switch(waiter.op){case'listen':tsi.waiters.hash[key]=index;break;}}
var checkwaiter=function(tsi,tuple,callback){var res,consumed=false,i,waiter;function cb(waiter,res){Aios.CB(waiter.pro,function(){waiter.cb.call(waiter.pro.agent,res)});}
for(i=0;i<tsi.waiters.length;i++){if(!tsi.waiters[i])continue;waiter=tsi.waiters[i];if(!consumed)switch(waiter.op){case'rd':case'rd-all':res=match(tuple,waiter.pat);log(tsi,current.process,' rd waiter? '+res);if(res!=none){cb(waiter,(waiter.op=='rd'?res:[res])),waiter.pro.wakeup();removewaiter(tsi,i);}
break;case'in':case'in-all':res=match(tuple,waiter.pat);log(tsi,current.process,' in waiter? '+res);if(res!=none){cb(waiter,(waiter.op=='in'?res:[res])),waiter.pro.wakeup();consumed=true;removewaiter(tsi,i);}
break;case'listen':res=match(tuple,waiter.pat);log(tsi,current.process,' listen waiter? '+res);if(res!=none){res=waiter.pro.callback(waiter.cb,[res]);if(callback)callback.apply(current.process.agent,[res]);consumed=true;}
break;}else break;}
if(!consumed&&current.node.ts.consumers.length>0){consumed=Comp.array.findmap(current.node.ts.consumers,function(consumer){return consumer(tuple);});}
return consumed;}
var findwaiter=function(tsi,waiter){var i;for(i=0;i<tsi.waiters.length;i++){if(!tsi.waiters[i])continue;if(tsi.waiters[i].pro.pid!=waiter.pro.pid)continue;if(equal(tsi.waiters[i].pat,waiter.pat))return i;}
return;}
var removewaiter=function(tsi,index){var waiter=tsi.waiters[index],_tsi,_index;tsi.waiters[index]=undefined;tsi.waiters.free.push(index);if(waiter.prev){waiter.prev.next=undefined;_tsi=current.node.ts.db[waiter.prev.pat.length];_index=findwaiter(_tsi,waiter.prev);if(_index!=undefined)removewaiter(_tsi,_index);};if(waiter.next){waiter.next.prev=undefined;_tsi=current.node.ts.db[waiter.next.pat.length];_index=findwaiter(_tsi,waiter.next);if(_index!=undefined)removewaiter(_tsi,_index);};}
var count=function(tsi){var data=tsi.data,i,n=0;for(i in data){if(data[i]!=undefined)n++};return n;}
var lookup=function(pat,all){var tsi,nary=pat.length,res=none;if(nary>current.node.ts.n||nary==0)return;tsi=current.node.ts.db[nary];if(!all&&Comp.isString(pat[0])&&tsi.hash[pat[0]]!=undefined){res=match(tsi.data[tsi.hash[pat[0]]],pat);}
if(res==none){res=(all?Comp.array.filtermap:Comp.array.findmap)(tsi.data,function(tuple){if(tuple==_)return none;else return match(tuple,pat);});if(res&&res.length==0)res=none;if(res==none&&current.node.ts.providers.length>0){res=Comp.array.findmap(current.node.ts.providers,function(provider){return provider(pat);});}}
return res;}
var lookupIndex=function(pat,all){var tsi,nary=pat.length,res=none;if(nary>current.node.ts.n||nary==0)return;tsi=current.node.ts.db[nary];if(!all&&Comp.isString(pat[0])&&tsi.hash[pat[0]]!=undefined){res=match(tsi.data[tsi.hash[pat[0]]],pat);if(res!=none)return tsi.hash[pat[0]];}
if(res==none){res=(all?Comp.array.filtermap:Comp.array.findmap)(tsi.data,function(tuple,index){if(tuple==_)return none;else return match(tuple,pat)?index:none;});if(res&&res.length==0)res=none;}
return res;}
var equal=function(x,y){var i;if(x==y)return true;if(Comp.obj.isArray(x)&&Comp.obj.isArray(y)){if(x.length!=y.length)return false;for(i in x){if(x[i]!=y[i])return false;}
return true;}
return false;}
var match1=function(x,y){if(y==any)return true;if(x==y)return true;if((x instanceof Array)&&(y instanceof Array))return match(x,y)!=none;if(y instanceof RegExp&&typeof x=='string'&&y.test(x))return true;return false;}
var match=function(tuple,templ){var i;if(tuple.length!=templ.length)return none;for(i in tuple){if(!match1(tuple[i],templ[i]))return none;};return tuple;}
var remove=function(pat,all){var tsi,nary=pat.length,res=none,removed=false,hashed=_;if(nary>current.node.ts.n||nary==0)return;tsi=current.node.ts.db[nary];if(!all&&Comp.isString(pat[0]))hashed=tsi.hash[pat[0]];if(hashed!=_){res=match(tsi.data[hashed],pat);if(res){removed=true;tsi.data[hashed]=_;tsi.tmo[hashed]=0;if(tsi.free==none)tsi.free=hashed;delete tsi.hash[pat[0]];}}
if(res==none||removed==false){res=(all?Comp.array.filtermap:Comp.array.findmap)(tsi.data,function(tuple,i){if(tuple==_)return none;var res_=match(tuple,pat);if(res_!=none){if(Comp.isString(pat[0])&&tsi.hash[pat[0]]==i){delete tsi.hash[pat[0]];}
tsi.data[i]=_;tsi.tmo[i]=0;if(tsi.free==none)tsi.free=i;return res_;}else return none;});if(res&&res.length==0)res=none;}
return res;}
var ts={alt:function(pats,callback,all,tmo){var tsi,nary,res,i,p,pat,waiters=none,last=none;for(i in pats){pat=pats[i];nary=pat.length;if(nary>current.node.ts.n||nary==0)return none;res=remove(pat,all);if(res&&res.length)current.node.stats.tsin+=(all?res.length:1);if(res&&callback){callback.call(current.process.agent,res);return;}
else if(res)return res;}
if(callback&&tmo==0)return callback();if(tmo==0)return;for(i in pats){pat=pats[i];nary=pat.length;if(callback&&(tmo==undefined||tmo>0)){if(waiters==none)
waiters={pat:pat,pro:current.process,cb:callback,op:'in'+(all?'-all':''),tmo:tmo>0?Aios.time()-current.world.lag+tmo:0},last=waiters;else{last.next={pat:pat,pro:current.process,cb:callback,op:'in'+(all?'-all':''),tmo:tmo>0?Aios.time()-current.world.lag+tmo:0,prev:last},last=last.next;}}}
if(waiters!=none){p=waiters;while(p){tsi=current.node.ts.db[p.pat.length];addwaiter(tsi,p);p=p.next;}
log(tsi,current.process,' +waiter');current.process.suspend(tmo>0?Aios.time()-current.world.lag+tmo:0,_,'ts');}},collect:function(to,pat){var tsi,nary=pat.length,res;if(nary>current.node.ts.n||nary==0)return none;tsi=current.node.ts.db[nary];res=remove(pat,true);if(res.length>0){current.node.stats.tsin+=res.length;Aios.Sig.agent.sendto(to,'TS.SIG',res);}
return res.length;},copyto:function(to,pat){var tsi,nary=pat.length,res;if(nary>current.node.ts.n||nary==0)return 0;tsi=current.node.ts.db[nary];res=lookup(pat,true);if(res.length>0){Aios.Sig.agent.sendto(to,'TS.SIG',res);}
return res.length;},evaluate:function(pat,callback,tmo){var tsi,nary=pat.length,res;if(nary>current.node.ts.n||nary==0)return none;tsi=current.node.ts.db[nary];consumed=checkwaiter(tsi,pat,callback);if(!consumed&&callback)callback.call(current.process.agent,null);},exists:function(pat){var tsi,nary=pat.length,res;if(nary>current.node.ts.n||nary==0)return none;tsi=current.node.ts.db[nary];res=lookup(pat);return res!=none;},inp:function(pat,callback,all,tmo){var tsi,nary=pat.length,res;if(nary>current.node.ts.n||nary==0||typeof pat!='object')throw'TS';tsi=current.node.ts.db[nary];res=remove(pat,all);log(tsi,current.process,' in? '+res+' []='+count(tsi));if(res&&res.length)current.node.stats.tsin+=(all?res.length:1);if(res==none&&callback&&(tmo==undefined||tmo>0)){addwaiter(tsi,{pat:pat,pro:current.process,cb:callback,op:'in'+(all?'-all':''),tmo:tmo>0?Aios.time()-current.world.lag+tmo:0});log(tsi,current.process,' +waiter');current.process.suspend(tmo>0?Aios.time()-current.world.lag+tmo:0,_,'ts');return none;}else if(callback)callback.call(current.process.agent,res);else return res;},listen:function(pat,callback){var tsi,nary=pat.length,res;if(nary>current.node.ts.n||nary==0||typeof pat!='object')throw'TS';tsi=current.node.ts.db[nary];addwaiter(tsi,{pat:pat,pro:current.process,cb:callback,op:'listen',tmo:0});},mark:function(tuple,tmo){var p,tsi,nary=tuple.length,consumed=false;if(nary>current.node.ts.n||nary==0||typeof tuple!='object')throw'TS';if(current.process&&(current.process.resources.tuples+1)>(current.process.resources.TS||Aios.options.TSPOOL))throw'EOL';tsi=current.node.ts.db[nary];current.node.stats.tsout++;consumed=checkwaiter(tsi,tuple);if(!consumed){if(tsi.free==none){loop:for(var i in tsi.data){if(tsi.data[i]==_){tsi.free=i;break loop}}}
if(options.timeout)tmo=min0(options.timeout,tmo);tmo=Aios.time()-current.world.lag+tmo;if(tsi.free!=none){tsi.data[tsi.free]=tuple;tsi.tmo[tsi.free]=tmo;current.node.ts.timeout=min0(current.node.ts.timeout,tsi.tmo[tsi.free]);if(Comp.obj.isString(tuple[0]))
tsi.hash[tuple[0]]=tsi.free;tsi.free=none;}else{tsi.data.push(tuple);tsi.tmo.push(tmo);if(Comp.obj.isString(tuple[0]))
tsi.hash[tuple[0]]=tsi.data.length-1;}}else current.node.stats.tsin++;},out:function(tuple){var tsi,tmo=0,nary=tuple.length,consumed=false,res;if(nary>current.node.ts.n||nary==0||typeof tuple!='object')throw'TS';if(current.process&&(current.process.resources.tuples+1)>(current.process.resources.TS||Aios.options.TSPOOL))throw'EOL';tsi=current.node.ts.db[nary];current.node.stats.tsout++;consumed=checkwaiter(tsi,tuple);if(!consumed){if(tsi.free==none){loop:for(var i in tsi.data){if(tsi.data[i]==_){tsi.free=i;break loop}}}
if(options.timeout)tmo=Aios.time()-current.world.lag+options.timeout;if(tmo)current.node.ts.timeout=min0(current.node.ts.timeout,tmo);if(tsi.free!=none){tsi.data[tsi.free]=tuple;tsi.tmo[tsi.free]=tmo;if(Comp.obj.isString(tuple[0]))
tsi.hash[tuple[0]]=tsi.free;tsi.free=none;}
else{tsi.data.push(tuple);tsi.tmo.push(tmo);if(Comp.obj.isString(tuple[0]))
tsi.hash[tuple[0]]=tsi.data.length-1;}}else current.node.stats.tsin++;log(tsi,current.process,' out '+tuple+'  ['+nary+'] consumed='+consumed+' []='+count(tsi));},rd:function(pat,callback,all,tmo){var tsi,nary=pat.length,res;if(nary>current.node.ts.n||nary==0||typeof pat!='object')throw'TS';tsi=current.node.ts.db[nary];res=lookup(pat,all);if(res==none&&callback&&(tmo==_||tmo>0)){addwaiter(tsi,{pat:pat,pro:current.process,cb:callback,op:'rd'+(all?'-all':''),tmo:tmo>0?Aios.time()-current.world.lag+tmo:0});current.process.suspend(tmo>0?Aios.time()-current.world.lag+tmo:0,_,'ts');return none;}else if(callback)callback.call(current.process.agent,res);else return res;},rm:function(pat,all){var tsi,nary=pat.length,res;if(nary>current.node.ts.n||nary==0||typeof pat!='object')throw'TS';tsi=current.node.ts.db[nary];res=remove(pat,all);if(res&&res.length)current.node.stats.tsin+=(all?res.length:1);return(res!=none);},store:function(to,tuple){Aios.Sig.agent.sendto(to,'TS.SIG',[tuple]);return 1;},ts:function(pat,callbackOrTimeout){var tsi,nary=pat.length,index,res,ret,tmo;if(nary>current.node.ts.n||nary==0||!Comp.obj.isArray(pat))throw'TS';tsi=current.node.ts.db[nary];index=lookupIndex(pat,false);if(index!=none)res=tsi.data[index];else return;log(tsi,current.process,' test? '+res+' []='+count(tsi));if(typeof callbackOrTimeout=='function'){if(current.process)
ret=callbackOrTimeout.call(current.process.agent,res);else
ret=callbackOrTimeout(res);if(ret&&ret.length==res.length)Comp.array.copy(ret,res);res=ret;}else if(typeof callbackOrTimeout=='number'){tmo=min0(options.timeout,callbackOrTimeout);tmo=Aios.time()-current.world.lag+tmo;tsi.tmo[index]=Math.max(tmo,tsi.tmo[index]);}
return res;},try:{alt:function(tmo,pats,callback,all){return ts.alt(pats,callback,all,tmo);},evaluate:function(tmo,pat,callback){return ts.evaluate(pat,callback,tmo);},inp:function(tmo,pat,callback,all){return ts.inp(pat,callback,all,tmo);},rd:function(tmo,pat,callback,all){return ts.rd(pat,callback,all,tmo);}}}
ts.alt.try=ts.try.alt
ts.evaluate.try=ts.try.evaluate
ts.inp.try=ts.try.inp
ts.rd.try=ts.try.rd
var tsd=function(options){var self=this;if(!options)options={};this.n=options.maxn||8;this.id=options.id||'TS';this.timeout=0;this.db=Comp.array.init(this.n+1,function(i){var tsi;if(i==0)return none;tsi={i:i,hash:[],free:none,data:[],tmo:[],waiters:[]};tsi.waiters.free=[];tsi.waiters.hash={};return tsi;});this.providers=[];this.consumers=[];this.node=options.node;this.extern={exists:function(pat,callback){var res,_node=current.node;current.node=self.node||_node;res=ts.exists(pat,callback);current.node=_node;return res;},inp:function(pat,all){var res,tsi,nary=pat.length,_node=current.node;current.node=self.node||_node;if(nary>current.node.ts.n||nary==0)return none;tsi=current.node.ts.db[nary];res=remove(pat,all);if(res&&res.length)current.node.stats.tsin+=(all?res.length:1);current.node=_node;return res;},mark:function(pat,tmo){var res,_node=current.node,_proc=current.process;current.node=self.node||_node;current.process=null;res=ts.mark(pat,tmo);current.node=_node;current.process=_proc;return res;},out:function(pat){var res,_node=current.node,_proc=current.process;current.node=self.node||_node;current.process=null;res=ts.out(pat)
current.node=_node;current.process=_proc;return res;},rd:function(pat,all){var res,tsi,nary=pat.length,_node=current.node;current.node=self.node||_node;if(nary>current.node.ts.n||nary==0)return none;tsi=current.node.ts.db[nary];res=lookup(pat,all);if(res&&res.length)current.node.stats.tsin+=(all?res.length:1);current.node=_node;return res;},rm:function(pat,all){var res,_node=current.node;current.node=self.node||_node;res=ts.rm(pat,all);current.node=_node;return res;},ts:function(pat,callback){var res,_node=current.node;current.node=self.node||_node;res=ts.ts(pat,callback);current.node=_node;return res;},}}
var create=function(options){return new tsd(options);}
tsd.prototype.checkwaiter=function(tuple){var tsi,nary=tuple.length;if(nary>this.n||nary==0)return none;tsi=current.node.ts.db[nary];return checkwaiter(tsi,tuple);}
tsd.prototype.cleanup=function(process,doCallback){var i,j,tsi,p,waiter,node=process.node;function cb(waiter){Aios.CB(waiter.pro,function(){waiter.cb.call(waiter.pro.agent,null)});}
for(i in node.ts.db){if(i==0)continue;tsi=node.ts.db[i];for(j=0;j<tsi.waiters.length;j++){if(!tsi.waiters[j])continue;waiter=tsi.waiters[j];if(waiter.pro.pid==process.pid){if(doCallback&&waiter.cb)cb(waiter);removewaiter(tsi,j);}}}}
tsd.prototype.register=function(func,consumer){if(consumer)this.consumers.push(func)
else this.providers.push(func);};tsd.prototype.print=function(summary){var i,tsi,num,str='',sep='';if(summary){str+='[';for(i in current.node.ts.db){if(i==0)continue;tsi=current.node.ts.db[i];num=count(tsi);if(num>0){str+=sep+'TS'+(int(i)+1)+'='+num;sep=' ';}}
str+=']'+NL;}
else for(i in current.node.ts.db){if(i==0)continue;tsi=current.node.ts.db[i];str+='['+Comp.printf.sprintf('%2d',tsi.i)+' free='+(tsi.free?Comp.printf.sprintf('%4d',tsi.free):'none')+' data='+Comp.printf.sprintf('%4d(%4d)',count(tsi),tsi.data.length)+' waiters='+Comp.printf.sprintf('%4d',tsi.waiters.length)+']'+NL;}
return str;}
tsd.prototype.service=function(curtime){var i,hashed,tsi,nexttime=0;for(i in this.db){tsi=this.db[i];hashed;if(tsi==_)continue;Comp.array.iter(tsi.tmo,function(tmo,i){var tuple=tsi.data[i];if(tuple&&tmo){if(tmo<curtime){if(Comp.isString(tuple[0]))hashed=tsi.hash[tuple[0]];if(hashed!=_&&hashed==i)delete tsi.hash[tuple[0]];tsi.data[i]=_;tsi.tmo[i]=0;if(tsi.free==none)tsi.free=i;}else nexttime=min0(nexttime,tmo);}});}
this.timeout=nexttime;}
module.exports={agent:ts,count:count,create:create,current:function(module){current=module.current;Aios=module;},match:match,options:options}};BundleModuleCode['jam/world']=function(module,exports){var Io=Require('com/io');var Comp=Require('com/compat');var current=none;var Aios=none;var options={debug:{},version:'1.11.3',verbose:0,}
var world=function(nodes,options){var main=this;options=checkOptions(options,{});this.options=options;this.nodes=nodes||[];this.verbose=checkOption(this.options.verbose,0);this.hash={};this.id=checkOption(this.options.id,Aios.aidgen().toUpperCase());this.classes=checkOption(this.options.classes,[]);this.lag=0;this.scheduler=this.options.scheduler;this.log=Aios.log;this.out=function(msg){main.log('[JAW '+this.id+'] '+msg)};this.thread=function(arg){var thr=this;var dying=false;this.nexttime=0;this.number=arg;this.curtime=0;this.init=function(){main.out('JAM World is starting ..');};this.run=function(){thr.nexttime=Aios.scheduler();thr.curtime=Aios.time();if(main.verbose>3)main.out(' .. nexttime = '+thr.nexttime+' ('+(thr.nexttime>0?thr.nexttime-thr.curtime:0)+')');};this.sleep=function(){var delta;thr.curtime=Aios.time();delta=thr.nexttime>0?thr.nexttime-thr.curtime:1000;if(main.verbose>3)main.out(' .. sleeping for '+delta+' ms');main.scheduler.Delay(delta);};this.transitions=function(){var trans;trans=[[undefined,this.init,function(thr){return true}],[this.init,this.run,function(thr){return true}],[this.run,this.run,function(thr){return thr.nexttime<0;}],[this.run,this.sleep,function(thr){return!dying;}],[this.run,this.terminate,function(thr){return dying}],[this.sleep,this.run,function(thr){return true;}]];return trans;};this.context=main.scheduler.TaskContext('JAM World'+main.id,thr);}};world.prototype.addClass=function(name,constructor,env){this.classes[name]=[Aios.Code.makeSandbox(constructor,0,env),Aios.Code.makeSandbox(constructor,1,env),Aios.Code.makeSandbox(constructor,2,env),Aios.Code.makeSandbox(constructor,3,env)];}
world.prototype.addNode=function(node){this.nodes.push(node);if(node.id)this.hash[node.id]=node;if(options.verbose)Io.out('World.addNode <'+node.id+'>');};world.prototype.connect=function(dir,node1,node2,options){if(!options)options={};var chan=Aios.Chan.Virtual(node1,node2,dir,options);switch(dir){case Aios.DIR.NORTH:node1.connections.north=chan.link1;node2.connections.south=chan.link2;break;case Aios.DIR.SOUTH:node1.connections.south=chan.link1;node2.connections.north=chan.link2;break;case Aios.DIR.WEST:node1.connections.west=chan.link1;node2.connections.east=chan.link2;break;case Aios.DIR.EAST:node1.connections.east=chan.link1;node2.connections.west=chan.link2;break;case Aios.DIR.NE:node1.connections.ne=chan.link1;node2.connections.sw=chan.link2;break;case Aios.DIR.NW:node1.connections.nw=chan.link1;node2.connections.se=chan.link2;break;case Aios.DIR.SE:node1.connections.se=chan.link1;node2.connections.nw=chan.link2;break;case Aios.DIR.SW:node1.connections.sw=chan.link1;node2.connections.ne=chan.link2;break;case Aios.DIR.UP:node1.connections.up=chan.link1;node2.connections.down=chan.link2;break;case Aios.DIR.DOWN:node1.connections.down=chan.link1;node2.connections.up=chan.link2;break;default:if(current)current.error='EINVALID';throw'CONNECT';}
chan.link2.on('agent',node1.receive.bind(node2));chan.link1.on('agent',node2.receive.bind(node1));chan.link2.on('signal',node1.handle.bind(node2));chan.link1.on('signal',node2.handle.bind(node1));chan.link1.end=node2.id;chan.link2.end=node1.id;return chan;};world.prototype.connectPhy=function(dir,node,options){var self=this,chan,name=Aios.DIR.to(dir);if(!options)options={};chan=Aios.Chan.Physical(node,dir,options);switch(dir.tag||dir){case'DIR.IP':if(!node.connections.ip)node.connections.ip=new Aios.Chan.iprouter();node.connections.ip.addLink(chan.link);chan.router=node.connections.ip;break;default:if(!name){if(current)current.error='ENOCHANNEL';throw'CONNECT';}
node.connections[name]=chan.link;}
chan.link.on('agent',node.receive.bind(node));chan.link.on('signal',node.handle.bind(node));chan.link.on('class',function(obj){for(var p in obj)self.addClass(p,obj[p].fun,obj[p].env)});return chan;};world.prototype.connectTo=function(dir,node,options){var chan,tokens,to=dir.ip,name=Aios.DIR.to(dir);if(!node)node=current.node;chan=node.connections[name];if(chan&&(chan.status(to)||!chan.connect))chan=undefined;if(chan)chan.connect(to,options);}
world.prototype.connected=function(dir,node){var name=Aios.DIR.to(dir),list;chan=node.connections[name];switch(dir.tag||dir){case Aios.DIR.tag.PATH:return chan&&chan.status(dir.path);break;case Aios.DIR.tag.IP:return chan&&chan.status(dir.ip);break;case Aios.DIR.tag.NODE:if(dir.node=='*'){list=[];if(node.connections.ip)list=list.concat(node.connections.ip.status('%'));return list;}else if(typeof dir.node=='string'){if(node.connections.ip&&node.connections.ip.lookup){found=node.connections.ip.lookup(dir.node);return found?Aios.DIR.IP(found):none;}}
break;case Aios.DIR.tag.DELTA:if(dir.delta[0]==1)chan=node.connections.east;else if(dir.delta[0]==-1)chan=node.connections.west;else if(dir.delta[1]==1)chan=node.connections.north;else if(dir.delta[1]==-1)chan=node.connections.south;else if(dir.delta[2]==1)chan=node.connections.up;else if(dir.delta[2]==-1)chan=node.connections.down;return chan&&chan.status();break;default:return(chan&&chan.status(dir.ip||dir.node||dir.path))||false;}}
world.prototype.disconnect=function(dir,node){var chan;switch(dir.tag||dir){case'DIR.IP':if(node.connections.ip&&node.connections.ip.status(dir.ip)&&node.connections.ip.disconnect)
node.connections.ip.disconnect(dir.ip);break;}}
world.prototype.getAgent=function(id,ac){var res=this.getAgentProcess(id,ac);if(res&&Comp.obj.isArray(res))return res.map(function(ap){return ap.agent});if(res)return res.agent;return;};world.prototype.getAgentProcess=function(id,ac){var matches=Comp.obj.isRegex(id)?[]:undefined;for(var n in this.nodes){var table=this.nodes[n].processes.table;for(var p in table){if(!table[p])continue;if(!matches&&table[p].agent.id==id&&(!ac||table[p].agent.ac==ac))
return table[p];if(matches&&id.test(table[p].agent.id)&&(!ac||table[p].agent.ac==ac))
matches.push(table[p]);}}
return matches;};world.prototype.getNode=function(nodeid){if(Comp.obj.isRegex(nodeid)){var res=[];for(var n in this.nodes){if(nodeid.test(this.nodes[n].id))res.push(this.nodes[n]);}
return res;}else{if(!this.hash[nodeid]&&options.verbose)Io.out('World.getNode: not found <'+nodeid+'>');return this.hash[nodeid];}};world.prototype.info=function(){var obj={},stat;obj.agents=0;obj.transferred=0;obj.links=0;obj.ports=0;for(var n in this.nodes){obj.agents+=this.nodes[n].processes.used;for(var l in this.nodes[n].connections){if(this.nodes[n].connections[l]){obj.ports++;obj.transferred+=this.nodes[n].connections[l].count();if(this.nodes[n].connections[l].stats){stat=this.nodes[n].connections[l].stats();obj.links+=(stat.links||0);}}}}
return obj;}
world.prototype.init=function(){}
world.prototype.lookup=function(dir,callback,node){switch(dir.tag||dir){case Aios.DIR.tag.PATH:if(node.connections.ip&&node.connections.ip.lookup)return node.connections.ip.lookup(dir.path,callback);break;default:if(callback)callback();}}
world.prototype.print=function(summary){var str='**** WORLD '+this.id+' ****'+NL;var res=Io.mem();str+='DATA='+int(res.data/1024)+' MB HEAP='+int(res.heap/1024)+' MB'+NL;for(var n in this.nodes){str+=this.nodes[n].print(summary);}
return str;}
world.prototype.removeNode=function(nodeid){var c,c2,conn,thenode,chan,node2;this.nodes=Comp.array.filter(this.nodes,function(node){if(node.id==nodeid)thenode=node;return node.id!=nodeid;});this.hash[nodeid]=undefined;if(thenode)for(c in thenode.connections){conn=thenode.connections[c];if(conn&&conn.end){node2=this.getNode(conn.end);if(node2)for(c2 in node2.connections){if(node2.connections[c2]&&node2.connections[c2].end==nodeid)
node2.connections[c2]=undefined;}}}
if(options.verbose)Io.out('World.removeNode <'+nodeid+'>');};world.prototype.start=function(){var self=this;if(this.scheduler){proc=new this.thread(0);this.context=proc.context;this.scheduler.Add(proc.context);}
this.gc=setInterval(function(){var node,n,p;if(self.verbose>3)self.out('GC');for(n in self.nodes){node=self.nodes[n];for(p in node.processes.gone){if(node.processes.gone[p]){node.processes.gone[p].tmo-=500;if(node.processes.gone[p].tmo<=0)node.processes.gone[p]=undefined;}}}},500);}
world.prototype.stop=function(){}
var World=function(nodes,options){var obj=new world(nodes,options);current.world=obj;return obj;}
module.exports={options:options,World:World,current:function(module){current=module.current;Aios=module}}};BundleModuleCode['jam/chan']=function(module,exports){var Io=Require('com/io');var Lz=Require('os/lz-string');var Comp=Require('com/compat');var Buf=Require('dos/buf');var Net=Require('dos/network');var Command=Net.Command;var Status=Net.Status;var current=none;var Aios=none;var CBL=Require('com/cbl');var Amp=Require('jam/amp');var Sec=Require('jam/security');var options={debug:{},verbose:1,version:'1.15.6'}
module.exports.options=options;var SLINK={INIT:'INIT',INITED:'INITED',RUNNING:'RUNNING'}
var virtual=function(node1,node2,dir,options){var self=this;this.node1=node1;this.node2=node2;this.dir=dir;this.buffer1=[];this.buffer2=[];this.count1={rcv:0,snd:0};this.count2={rcv:0,snd:0};this.compress=options.compress;this.handler1=[];this.handler2=[];this.link1={control:function(msg,to,callback){},on:function(event,callback){var data;self.handler1[event]=callback;if(event=='agent'&&self.buffer2.length>0){data=Comp.array.pop(self.buffer2);if(self.compress)data=Lz.decompress(data);callback(data);}},send:function(msg){var data;if(msg.agent){data=msg.agent;if(self.compress)data=Lz.compress(data);if(self.handler2.agent)self.handler2.agent(self.compress?Lz.decompress(data):data);else self.buffer1.push(data);if(data.length)self.count1.snd+=data.length;else self.count1.snd++;}else if(msg.signal){data=msg.signal;if(data.length)self.count1.snd+=data.length;else self.count1.snd++;if(self.handler2.signal)self.handler2.signal(data);}},count:function(){return self.count1.snd},status:function(){return true},virtual:true}
this.link2={control:function(msg,to,callback){},on:function(event,callback){var data;self.handler2[event]=callback;if(event=='agent'&&self.buffer1.length>0){data=Comp.array.pop(self.buffer1);if(self.compress)data=Lz.decompress(data);callback(data);}},send:function(msg){var data;if(msg.agent){data=msg.agent;if(self.compress)data=Lz.compress(data);if(self.handler1.agent)self.handler1.agent(self.compress?Lz.decompress(data):data);else self.buffer2.push(data);if(data.length)self.count2.snd+=data.length;else self.count2.snd++;}else if(msg.signal){data=msg.signal;if(data.length)self.count2.snd+=data.length;else self.count2.snd++;if(self.handler1.signal)self.handler1.signal(data);}},count:function(){return self.count2.snd},status:function(){return true},virtual:true}};virtual.prototype.init=function(){};virtual.prototype.start=function(){};virtual.prototype.stop=function(){};var Virtual=function(node1,node2,dir,options){var obj=new virtual(node1,node2,dir,options);return obj;}
module.exports.Virtual=Virtual;module.exports.current=function(module){current=module.current;Aios=module;Amp.current(module);};if(global.config.nonetwork)return;var physical=function(node,dir,options){var self=this;options=checkOptions(options,{});this.options=options;this.ip=none;if(options.rcv)this.ip=url2addr(options.rcv);else this.ip={address:Amp.options.localhost,port:undefined};if(options.proto&&this.ip)this.ip.proto=options.proto;this.node=node;this.dir=dir;this.count=0;this.broker=options.broker;this.mode=this.options.compress?Amp.AMMode.AMO_COMPRESS:0;this.state=SLINK.INIT;this.linked=0;this.events=[];this.callbacks=[];this.out=function(msg,async){async?Aios.logAsync(msg):Aios.log(msg)};if(this.ip.parameter&&this.ip.parameter.secure){this.options.secure=Sec.Port.ofString(this.ip.parameter.secure);delete this.ip.parameter;this.dir.ip=addr2url(this.ip);}
this.amp=Amp.Amp({broker:options.broker?url2addr(options.broker,this.ip.address):undefined,dir:this.dir,mode:this.options.mode,name:this.options.name,node:node,nodeid:this.options.nodeid,oneway:this.options.oneway,multicast:this.options.multicast,proto:this.options.proto,pem:this.options.pem,rcv:this.ip,secure:this.options.secure,snd:options.snd?url2addr(options.snd):undefined,sock:options.sock,verbose:options.verbose,});this.link={control:function(msg,to,callback){var buf,data,addr=to?url2addr(to):{};buf=Buf.Buffer();msg.tid=Comp.random.int(65536/2);self.callbacks[msg.tid]=callback;Buf.buf_put_int16(buf,msg.tid);Buf.buf_put_string(buf,JSON.stringify(msg.args||{}));self.amp.request(msg.cmd,buf,self.amp.mode&Amp.AMMode.AMO_MULTICAST?addr:undefined);},on:function(event,callback){self.events[event]=callback;},send:function(msg,to){var buf,data,addr=to?url2addr(to):{};if(msg.agent){data=msg.agent;buf=Buf.Buffer();if(self.mode&Amp.AMMode.AMO_COMPRESS)data=Lz.compress(data);Buf.buf_put_string(buf,data);self.amp.request(Command.PS_MIGRATE,buf,self.amp.mode&Amp.AMMode.AMO_MULTICAST?addr:undefined);}else if(msg.signal){data=msg.signal;buf=Buf.Buffer();if(self.mode&Amp.AMMode.AMO_COMPRESS)data=Lz.compress(data);Buf.buf_put_string(buf,data);self.amp.request(Command.PS_SIGNAL,buf,self.amp.mode&Amp.AMMode.AMO_MULTICAST?addr:undefined);}},count:function(){return self.amp.count.rcv+self.amp.count.snd},status:function(to){if(self.amp){switch(to){case'%':return self.amp.status(to);break;default:if(to)to=url2addr(to);return to?self.amp.status(to.address,to.port):self.amp.status();}}},stats:function(){return{transferred:(self.amp.count.rcv+self.amp.count.snd),linked:self.linked}},ip:this.ip,mode:this.amp.mode}
this.link.connect=function(to,key){url2addr(to,self.ip.address,function(addr){self.amp.link(addr,true,key);})};this.link.disconnect=function(to){var tokens;if(!to){if(self.amp.snd&&self.amp.snd.address&&self.amp.snd.port)
self.amp.unlink(self.amp.snd);}else{var addr=url2addr(to,self.ip.address);self.amp.unlink(addr);}};this.link.init=function(cb){if(self.state!=SLINK.INIT)return cb?cb():null;self.state=SLINK.INITED;return self.amp.init(cb);}
this.link.start=function(cb){if(self.state!=SLINK.INITED)return cb?cb():null;self.state=SLINK.RUNNING;return self.amp.start(cb);}
this.link.stop=function(cb){if(self.state!=SLINK.RUNNING)return cb?cb():null;self.state=SLINK.INITED;return self.amp.stop(cb);}
if(this.broker)this.link.lookup=function(path,callback){if(self.amp.lookup)self.amp.lookup(path,callback);else if(callback)callback([]);}
this.amp.on('route+',function(url,node,remote){if(remote)self.ip.public=remote;if(self.router)self.router.add(url,self.link,node);self.emit('link+',url,node);Aios.emit('link+',url,node);self.linked++;});this.amp.on('route-',function(url){if(self.router)self.router.delete(url,self.link);self.emit('link-',url);Aios.emit('link-',url);self.linked--;});this.amp.on('error',function(err,arg){self.emit('error',err,arg);});if(options.on){for(var p in options.on)this.on(p,options.on[p]);}
this.amp.receiver(function(handler){var code,name,env,agentid,stat,obj,buf,status,tid;if(!handler)return;if(self.options.verbose>2){self.out('AMP: got request: '+Io.inspect(handler),true);};switch(handler.cmd){case Command.PS_MIGRATE:code=Buf.buf_get_string(handler.buf);if(self.mode&Amp.AMMode.AMO_COMPRESS)code=Lz.decompress(code);if(self.events.agent)self.events.agent(code,false,handler.remote);break;case Command.PS_CREATE:code=Buf.buf_get_string(handler.buf);if(self.mode&Amp.AMMode.AMO_COMPRESS)code=Lz.decompress(code);if(self.events.agent)self.events.agent(code,true);break;case Command.PS_WRITE:name=Buf.buf_get_string(handler.buf);code=Buf.buf_get_string(handler.buf);env=Buf.buf_get_string(handler.buf);if(self.mode&Amp.AMMode.AMO_COMPRESS)code=Lz.decompress(code);obj={};try{eval("env = "+env)}catch(e){};obj[name]={fun:code,env:env}
if(self.events['class'])self.events['class'](obj);break;case Command.PS_SIGNAL:code=Buf.buf_get_string(handler.buf);if(self.mode&Amp.AMMode.AMO_COMPRESS)code=Lz.decompress(code);if(self.events.signal)self.events.signal(code,handler.remote);break;case Command.PS_STUN:code=Buf.buf_get_string(handler.buf);break;case Command.STD_STATUS:tid=Buf.buf_get_int16(handler.buf);code=Buf.buf_get_string(handler.buf);code=JSON.parse(code);status={};if(typeof code=='string'){switch(code){case'node':case'links':case'ports':case'agents':status=self.node.std_status(code);break;}}
buf=Buf.Buffer();Buf.buf_put_int16(buf,tid);Buf.buf_put_string(buf,JSON.stringify(status));self.amp.reply(Command.STD_MONITOR,buf,self.amp.mode&Amp.AMMode.AMO_MULTICAST?handler.remote:undefined);break;case Command.STD_INFO:tid=Buf.buf_get_int16(handler.buf);code=JSON.parse(Buf.buf_get_string(handler.buf));status={};if(typeof code=='string'){switch(code){case'node':status=self.node.std_info();break;}}else if(typeof code=='object'){if(code.node){if(code.node==self.node.id)status=self.node.std_info();else{var to=COM.lookupNode(self.node,code.node);console.log(to);}}
if(code.agent){status=self.node.std_info(code);}}
buf=Buf.Buffer();Buf.buf_put_int16(buf,tid);Buf.buf_put_string(buf,JSON.stringify(status));self.amp.reply(Command.STD_MONITOR,buf,self.amp.mode&Amp.AMMode.AMO_MULTICAST?handler.remote:undefined);break;case Command.STD_MONITOR:tid=Buf.buf_get_int16(handler.buf);code=Buf.buf_get_string(handler.buf);code=JSON.parse(code);if(self.callbacks[tid]){self.callbacks[tid](code);delete self.callbacks[tid];}
break;}});};physical.prototype.emit=function(event,arg,aux1,aux2){if(this.events[event])this.events[event](arg,aux1,aux2)};physical.prototype.on=function(event,handler){this.events[event]=handler};physical.prototype.init=function(callback){return this.link.init(callback)};physical.prototype.start=function(callback){return this.link.start(callback)};physical.prototype.stop=function(){return this.link.stop()};var Physical=function(node,dir,options){var obj=new physical(node,dir,options);return obj;}
module.exports.Physical=Physical;var url2addr=Amp.url2addr;var addr2url=Amp.addr2url;var resolve=Amp.resolve;function addrequal(addr1,addr2){return ipequal(addr1.address,addr2.address)&&addr1.port==addr2.port;}
function ipequal(ip1,ip2){if(ip1==undefined||ip2==undefined)return false;else if((Comp.string.equal(ip1,'localhost')||Comp.string.equal(ip1,'127.0.0.1'))&&(Comp.string.equal(ip2,'localhost')||Comp.string.equal(ip2,'127.0.0.1')))return true;else return ip1==ip2;}
function iprouter(){this.routingTable={};this.nodeTable={};this.links=[];}
iprouter.prototype.add=function(to,link,node){to=resolve(to);if(options.verbose)Aios.logAsync('[IP] iprouter: add route '+addr2url(link.ip)+' -> '+to+(node?'#'+node:''));this.routingTable[to]=link;this.nodeTable[to]=node;}
iprouter.prototype.addLink=function(link){if(!link.ip)link.ip='*';if(options.verbose)Aios.logAsync('[IP] iprouter: add link '+addr2url(link.ip));this.links.push(link);}
iprouter.prototype.connect=function(to,key){var link,p,addr;to=resolve(to);addr=url2addr(to);for(p in this.links){if(this.links[p].status(to))return;if(!(this.links[p].mode&Amp.AMMode.AMO_MULTICAST)&&this.links[p].status())continue;if(addr.proto&&this.links[p].ip&&this.links[p].ip.proto!=addr.proto)continue;link=this.links[p];break;}
if(link&&link.connect){link.connect(to,key);}}
iprouter.prototype.count=function(dest){var res=0;for(var i in this.links){res+=this.links[i].count();}
return res;}
iprouter.prototype.delete=function(to){to=resolve(to);if(this.routingTable[to]){if(options.verbose)Aios.logAsync('[IP] iprouter: remove route '+addr2url(this.routingTable[to].ip)+' -> '+to);delete this.routingTable[to];delete this.nodeTable[to];}}
iprouter.prototype.disconnect=function(to){to=resolve(to);if(this.routingTable[to]&&this.routingTable[to].status(to)){this.routingTable[to].disconnect(to);}}
iprouter.prototype.lookup=function(nodeid,callback){var p,result=[],n=0;if(nodeid.indexOf('*')!=-1){for(p in this.links){if(this.links[p].lookup){n++;this.links[p].lookup(nodeid,function(_result){if(_result&&_result.length)result=result.concat(_result);n--;if(n==0)callback(result);});}}}else for(p in this.nodeTable){if(this.nodeTable[p]==nodeid&&this.routingTable[p])return p;}}
iprouter.prototype.ip=function(){for(var i in this.links){if(this.links[i].ip)return this.links[i].ip;}}
iprouter.prototype.reverse=function(ip){return this.nodeTable[ip];}
iprouter.prototype.send=function(msg){msg.to=resolve(msg.to);if(this.routingTable[msg.to]){this.routingTable[msg.to].send(msg,msg.to);}else{}}
iprouter.prototype.start=function(callback){var cbl=CBL(callback||function(){});this.links.forEach(function(link){cbl.push(function(next){link.start(next)});});cbl.start();}
iprouter.prototype.stats=function(){return{links:Object.keys(this.routingTable).length}}
iprouter.prototype.status=function(dest){var res,p;if(dest==undefined){for(p in this.routingTable){if(this.routingTable[p])return true}}else if(dest=='*'){res=[];for(p in this.routingTable){if(this.routingTable[p])res.push(p)}
return res;}else if(dest=='%'){res=[];for(p in this.nodeTable){if(this.nodeTable[p]&&this.routingTable[p])res.push(this.nodeTable[p]);}
return res;}else{dest=resolve(dest);if(this.routingTable[dest])
return this.routingTable[dest].status(dest);else
return false;}
return false;}
iprouter.prototype.stop=function(callback){var cbl=CBL(callback||function(){});this.links.forEach(function(link){cbl.push(function(next){link.stop(next)});});cbl.start();}
module.exports.iprouter=iprouter;module.exports.Command=Command
module.exports.Status=Status
module.exports.url2addr=url2addr;module.exports.addr2url=addr2url;};BundleModuleCode['os/lz-string']=function(module,exports){var LZString=(function(){var f=String.fromCharCode;var keyStrBase64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var keyStrUriSafe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";var baseReverseDic={};function getBaseValue(alphabet,character){if(!baseReverseDic[alphabet]){baseReverseDic[alphabet]={};for(var i=0;i<alphabet.length;i++){baseReverseDic[alphabet][alphabet.charAt(i)]=i;}}
return baseReverseDic[alphabet][character];}
var LZString={compressToBase64:function(input){if(input==null)return"";var res=LZString._compress(input,6,function(a){return keyStrBase64.charAt(a);});switch(res.length%4){default:case 0:return res;case 1:return res+"===";case 2:return res+"==";case 3:return res+"=";}},decompressFromBase64:function(input){if(input==null)return"";if(input=="")return null;return LZString._decompress(input.length,32,function(index){return getBaseValue(keyStrBase64,input.charAt(index));});},compressToUTF16:function(input){if(input==null)return"";return LZString._compress(input,15,function(a){return f(a+32);})+" ";},decompressFromUTF16:function(compressed){if(compressed==null)return"";if(compressed=="")return null;return LZString._decompress(compressed.length,16384,function(index){return compressed.charCodeAt(index)-32;});},compressToUint8Array:function(uncompressed){var compressed=LZString.compress(uncompressed);var buf=new Uint8Array(compressed.length*2);for(var i=0,TotalLen=compressed.length;i<TotalLen;i++){var current_value=compressed.charCodeAt(i);buf[i*2]=current_value>>>8;buf[i*2+1]=current_value%256;}
return buf;},decompressFromUint8Array:function(compressed){if(compressed===null||compressed===undefined){return LZString.decompress(compressed);}else{var buf=new Array(compressed.length/2);for(var i=0,TotalLen=buf.length;i<TotalLen;i++){buf[i]=compressed[i*2]*256+compressed[i*2+1];}
var result=[];buf.forEach(function(c){result.push(f(c));});return LZString.decompress(result.join(''));}},compressToEncodedURIComponent:function(input){if(input==null)return"";return LZString._compress(input,6,function(a){return keyStrUriSafe.charAt(a);});},decompressFromEncodedURIComponent:function(input){if(input==null)return"";if(input=="")return null;input=input.replace(/ /g,"+");return LZString._decompress(input.length,32,function(index){return getBaseValue(keyStrUriSafe,input.charAt(index));});},compress:function(uncompressed){return LZString._compress(uncompressed,16,function(a){return f(a);});},_compress:function(uncompressed,bitsPerChar,getCharFromInt){if(uncompressed==null)return"";var i,value,context_dictionary={},context_dictionaryToCreate={},context_c="",context_wc="",context_w="",context_enlargeIn=2,context_dictSize=3,context_numBits=2,context_data=[],context_data_val=0,context_data_position=0,ii;for(ii=0;ii<uncompressed.length;ii+=1){context_c=uncompressed.charAt(ii);if(!Object.prototype.hasOwnProperty.call(context_dictionary,context_c)){context_dictionary[context_c]=context_dictSize++;context_dictionaryToCreate[context_c]=true;}
context_wc=context_w+context_c;if(Object.prototype.hasOwnProperty.call(context_dictionary,context_wc)){context_w=context_wc;}else{if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1);if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}}
value=context_w.charCodeAt(0);for(i=0;i<8;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}
value=value>>1;}}else{value=1;for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|value;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}
value=0;}
value=context_w.charCodeAt(0);for(i=0;i<16;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}
value=value>>1;}}
context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++;}
delete context_dictionaryToCreate[context_w];}else{value=context_dictionary[context_w];for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}
value=value>>1;}}
context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++;}
context_dictionary[context_wc]=context_dictSize++;context_w=String(context_c);}}
if(context_w!==""){if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1);if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}}
value=context_w.charCodeAt(0);for(i=0;i<8;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}
value=value>>1;}}else{value=1;for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|value;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}
value=0;}
value=context_w.charCodeAt(0);for(i=0;i<16;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}
value=value>>1;}}
context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++;}
delete context_dictionaryToCreate[context_w];}else{value=context_dictionary[context_w];for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}
value=value>>1;}}
context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++;}}
value=2;for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}
value=value>>1;}
while(true){context_data_val=(context_data_val<<1);if(context_data_position==bitsPerChar-1){context_data.push(getCharFromInt(context_data_val));break;}
else context_data_position++;}
return context_data.join('');},decompress:function(compressed){if(compressed==null)return"";if(compressed=="")return null;return LZString._decompress(compressed.length,32768,function(index){return compressed.charCodeAt(index);});},_decompress:function(length,resetValue,getNextValue){var dictionary=[],next,enlargeIn=4,dictSize=4,numBits=3,entry="",result=[],i,w,bits,resb,maxpower,power,c,data={val:getNextValue(0),position:resetValue,index:1};for(i=0;i<3;i+=1){dictionary[i]=i;}
bits=0;maxpower=Math.pow(2,2);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}
bits|=(resb>0?1:0)*power;power<<=1;}
switch(next=bits){case 0:bits=0;maxpower=Math.pow(2,8);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}
bits|=(resb>0?1:0)*power;power<<=1;}
c=f(bits);break;case 1:bits=0;maxpower=Math.pow(2,16);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}
bits|=(resb>0?1:0)*power;power<<=1;}
c=f(bits);break;case 2:return"";}
dictionary[3]=c;w=c;result.push(c);while(true){if(data.index>length){return"";}
bits=0;maxpower=Math.pow(2,numBits);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}
bits|=(resb>0?1:0)*power;power<<=1;}
switch(c=bits){case 0:bits=0;maxpower=Math.pow(2,8);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}
bits|=(resb>0?1:0)*power;power<<=1;}
dictionary[dictSize++]=f(bits);c=dictSize-1;enlargeIn--;break;case 1:bits=0;maxpower=Math.pow(2,16);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}
bits|=(resb>0?1:0)*power;power<<=1;}
dictionary[dictSize++]=f(bits);c=dictSize-1;enlargeIn--;break;case 2:return result.join('');}
if(enlargeIn==0){enlargeIn=Math.pow(2,numBits);numBits++;}
if(dictionary[c]){entry=dictionary[c];}else{if(c===dictSize){entry=w+w.charAt(0);}else{return null;}}
result.push(entry);dictionary[dictSize++]=w+entry.charAt(0);enlargeIn--;w=entry;if(enlargeIn==0){enlargeIn=Math.pow(2,numBits);numBits++;}}}};return LZString;})();if(typeof define==='function'&&define.amd){define(function(){return LZString;});}else if(typeof module!=='undefined'&&module!=null){module.exports=LZString}};BundleModuleCode['dos/buf']=function(module,exports){"use strict";var log=0;var util=Require('util');var Io=Require('com/io');var Comp=Require('com/compat');var String=Comp.string;var Array=Comp.array;var Perv=Comp.pervasives;var des48=Require('dos/des48');var Rand=Comp.random;var Net=Require('dos/network');var Status=Net.Status;var Fs=Require('fs');var SIZEOF_INT16=2;var SIZEOF_INT32=4;var PORT_SIZE=6;var PRIV_SIZE=PORT_SIZE+SIZEOF_INT32;var CAP_SIZE=PORT_SIZE+PRIV_SIZE;var buffer=function(data){var size;this.pos=0;if(Comp.isNumber(data)){this.data=new Buffer(data);}else if(Comp.isString(data)){this.data=new Buffer('');buf_of_hex(this,data)}else if(Comp.isArray(data)){this.data=new Buffer(data);}else if(typeof data=="object"&&data.constructor===Buffer){this.data=data;}else this.data=new Buffer('');};function buf_extend(buf,off){if(buf.data.length<(buf.pos+off)){buf.data=Buffer.concat([buf.data,new Buffer(off-(buf.data.length-buf.pos))]);}}
function buf_expand(buf,size){if(buf.data.length<size){buf.data=Buffer.concat([buf.data,new Buffer(size-buf.data.length)]);}}
function buf_shrink(buf,size){if(buf.data.length>size){buf.data=Buffer.slice(buf.data,size);}}
function buf_put_string(buf,str){buf_extend(buf,str.length+1);for(var i=0;i<str.length;i++){buf.data[buf.pos]=Perv.int_of_char(String.get(str,i));buf.pos++;}
buf.data[buf.pos]=0;buf.pos++;}
function buf_get_string(buf){var str='';var end=buf.data.length;var finished=false;while(!finished&&buf.pos<end){if(buf.data[buf.pos]==0)finished=true;else{str=str+Perv.char_of_int(buf.data[buf.pos]);buf.pos++;}}
buf.pos++;return str;}
function buf_to_hex(buf){return buf.data.toString('hex');}
function buf_of_hex(buf,str){buf.pos=0;buf.data=new Buffer(str,'hex');}
function buf_to_str(buf){var str=buf.data.toString('binary');return str;}
function buf_of_str(buf,str){buf.pos=0;buf.data=new Buffer(str,'binary');return buf;}
function buf_put_bytes(buf,str){buf_extend(buf,str.length);for(var i=0;i<str.length;i++){var n=Perv.int_of_char(String.get(str,i));buf.data[buf.pos]=n;buf.pos++;}}
function buf_get_bytes(buf,size){var i=0;var str='';var end=buf.data.length;var finished=false;while(!finished&&buf.pos<end){if(i==size)finished=true;else{str=str+Perv.char_of_int(buf.data[buf.pos]);buf.pos++;i++;}}
return str;}
function buf_put_int16(buf,n){buf_extend(buf,2);buf.data[buf.pos]=n&0xff;buf.data[buf.pos+1]=(n>>8)&0xff;buf.pos=buf.pos+2;}
function buf_get_int16(buf){var n=0;var end=buf.data.length;if(buf.pos+2<=end){n=buf.data[buf.pos];n=n|(buf.data[buf.pos+1]<<8);buf.pos=buf.pos+2;if(n&0x8000)return(n-0x10000);else return(n);}else throw Status.BUF_OVERFLOW;}
function buf_put_int32(buf,n){buf_extend(buf,4);buf.data[buf.pos]=n&0xff;buf.data[buf.pos+1]=(n>>8)&0xff;buf.data[buf.pos+2]=(n>>16)&0xff;buf.data[buf.pos+3]=(n>>24)&0xff;buf.pos=buf.pos+4;}
function buf_get_int32(buf){var n=0;var end=buf.data.length;if(buf.pos+4<=end){n=buf.data[buf.pos];n=n|(buf.data[buf.pos+1]<<8);n=n|(buf.data[buf.pos+2]<<16);n=n|(buf.data[buf.pos+3]<<24);buf.pos=buf.pos+4;return(n);}else throw Status.BUF_OVERFLOW;}
function buf_put_port(buf,port){buf_extend(buf,Net.PORT_SIZE);for(var i=0;i<Net.PORT_SIZE;i++){var n=Perv.int_of_char(String.get(port,i));buf.data[buf.pos]=n;buf.pos++;}}
function buf_get_port(buf){var port='';var end=buf.data.length;if(buf.pos+Net.PORT_SIZE<=end){for(var i=0;i<Net.PORT_SIZE;i++){port=port+Perv.char_of_int(buf.data[buf.pos]);buf.pos++;}
return port;}else throw Status.BUF_OVERFLOW;}
function buf_put_priv(buf,priv){buf_extend(buf,Net.PRIV_SIZE);buf.data[buf.pos]=priv.prv_obj&0xff;buf.data[buf.pos+1]=(priv.prv_obj>>8)&0xff;buf.data[buf.pos+2]=(priv.prv_obj>>16)&0xff;buf.data[buf.pos+3]=priv.prv_rights&0xff;buf.pos=buf.pos+4;buf_put_port(buf,priv.prv_rand);}
function buf_get_priv(buf,priv){var n;var end=buf.data.length;if(buf.pos+(Net.PRIV_SIZE)<=end){if(priv==undefined)priv=Net.Private();n=buf.data[buf.pos];n=n|(buf.data[buf.pos+1]<<8);n=n|(buf.data[buf.pos+2]<<16);priv.prv_obj=n;priv.prv_rights=buf.data[buf.pos+3];buf.pos=buf.pos+4;priv.prv_rand=buf_get_port(buf);return priv;}else throw Status.BUF_OVERFLOW;}
function buf_put_cap(buf,cap){buf_put_port(buf,cap.cap_port);buf_put_priv(buf,cap.cap_priv);}
function buf_get_cap(buf,cap){var end=buf.data.length;if(buf.pos+(Net.CAP_SIZE)<=end){if(cap==undefined)cap=Net.Capability();cap.cap_port=buf_get_port(buf);buf_get_priv(buf,cap.cap_priv);return cap;}else throw Status.BUF_OVERFLOW;}
function buf_put_hdr(buf,hdr){buf_put_port(buf,hdr.h_port);buf_put_priv(buf,hdr.h_priv);buf_put_int32(buf,hdr.h_command);buf_put_int32(buf,hdr.h_status);}
function buf_get_hdr(buf,hdr){if(hdr==undefined)hdr=Net.Header();hdr.h_port=buf_get_port(buf);buf_get_priv(buf,hdr.h_priv);hdr.h_command=buf_get_int32(buf);hdr.h_status=buf_get_int32(buf);return hdr;}
function buf_put_buf(buf,bufsrc,srcoff,len){if(srcoff==undefined)srcoff=0;if(len==undefined)len=bufsrc.data.length;buf_extend(buf,len);for(var i=0;i<len;i++){buf.data[buf.pos]=bufsrc.data[srcoff+i];buf.pos++;}}
function buf_get_buf(buf,bufdst,dstoff,len){buf_extend(bufdst,dstoff+len);for(var i=0;i<len;i++){bufdst.data[dstoff+i]=buf.data[buf.pos];buf.pos++;}}
function buf_pad(buf,size,byte){if(buf.data.length<size)buf_extend(buf,size-buf.data.length);if(byte!=undefined){while(buf.pos<size){buf.data[buf.pos]=byte;buf.pos++;}}else buf.pos=size-1;}
function buf_set_pos(buf,off){if(off>=buf.data.length)buf_expand(buf,off+1);buf.pos=off;}
function buf_write(fd,buf,off,len){var n;if(off==undefined)n=Io.write_buf(fd,buf.data,0,buf.data.length);else{if(len==undefined)len=buf.data.length;n=Io.write_buf(fd,buf.data,0,len,off);}
return n;}
function buf_read(fd,buf,off,len){var n;buf_expand(buf,len);n=Io.read_buf(fd,buf.data,0,len,off);buf.pos=0;return n;}
function buf_print(buf){var str='[';for(var i=0;i<buf.data.length;i++){if(i>0)str=str+','+buf.data[i];else str=str+buf.data[i];}
return str+']'+buf.pos+':'+buf.data.length;}
function buf_set(buf,off,byte){if(off>=buf.data.length)buf_expand(buf,off+1);buf.data[off]=byte;}
function buf_get(buf,off){return buf.data[off];}
function buf_init(buf){buf.data=new Buffer('');buf.pos=0;}
function buf_copy(dst,src){dst.data=new Buffer(src.data);dst.pos=0;}
function buf_blit(dst,dstoff,src,srcoff,len){buf_expand(dst,dstoff+len);src.data.copy(dst.data,dstoff,srcoff,srcoff+len);dst.pos=0;}
module.exports={SIZEOF_INT16:SIZEOF_INT16,SIZEOF_INT32:SIZEOF_INT32,PORT_SIZE:PORT_SIZE,PRIV_SIZE:PRIV_SIZE,CAP_SIZE:CAP_SIZE,Buffer:function Buffer(data){var obj=new buffer(data);Object.preventExtensions(obj);return obj;},buf_put_string:buf_put_string,buf_put_int16:buf_put_int16,buf_put_int32:buf_put_int32,buf_put_port:buf_put_port,buf_put_priv:buf_put_priv,buf_put_cap:buf_put_cap,buf_put_hdr:buf_put_hdr,buf_put_buf:buf_put_buf,buf_put_bytes:buf_put_bytes,buf_get_string:buf_get_string,buf_get_int16:buf_get_int16,buf_get_int32:buf_get_int32,buf_get_port:buf_get_port,buf_get_priv:buf_get_priv,buf_get_cap:buf_get_cap,buf_get_hdr:buf_get_hdr,buf_get_buf:buf_get_buf,buf_get_bytes:buf_get_bytes,buf_pad:buf_pad,buf_set:buf_set,buf_get:buf_get,buf_set_pos:buf_set_pos,buf_init:buf_init,buf_blit:buf_blit,buf_copy:buf_copy,buf_extend:buf_extend,buf_expand:buf_expand,buf_shrink:buf_shrink,buf_read:buf_read,buf_write:buf_write,buf_print:buf_print,buf_to_hex:buf_to_hex,buf_of_hex:buf_of_hex,buf_to_str:buf_to_str,buf_of_str:buf_of_str,length:function(buf){if(buf.data==undefined)return 0;else return buf.data.length;}};};BundleModuleCode['dos/network']=function(module,exports){"use strict";var log=0;var util=Require('util');var Io=Require('com/io');var Comp=Require('com/compat');var String=Comp.string;var Array=Comp.array;var Perv=Comp.pervasives;var Des48=Require('dos/des48');var Base64=Require('os/base64');var Rand=Comp.random;var Fs=Require('fs');function pad(str,size){while(str.length<(size||2)){str="0"+str;}
return str;}
var STD_FIRST_COM=1000;var STD_LAST_COM=1999;var STD_FIRST_ERR=(-STD_FIRST_COM);var STD_LAST_ERR=(-STD_LAST_COM);var AFS_FIRST_COM=2000;var AFS_LAST_COM=2099;var AFS_FIRST_ERR=(-AFS_FIRST_COM);var AFS_LAST_ERR=(-AFS_LAST_COM);var AFS_REQBUFSZ=1024*32;var DNS_FIRST_COM=2100;var DNS_LAST_COM=2199;var DNS_FIRST_ERR=(-DNS_FIRST_COM);var DNS_LAST_ERR=(-DNS_LAST_COM);var DNS_MAXCOLUMNS=4;var PS_FIRST_COM=2200;var PS_LAST_COM=2299;var PS_FIRST_ERR=(-PS_FIRST_COM);var PS_LAST_ERR=(-PS_LAST_COM);var BR_FIRST_COM=2300;var BR_LAST_COM=2399;var BR_FIRST_ERR=(-BR_FIRST_COM);var BR_LAST_ERR=(-BR_LAST_COM);var Status={STD_OK:0,STD_CAPBAD:STD_FIRST_ERR,STD_COMBAD:(STD_FIRST_ERR-1),STD_ARGBAD:(STD_FIRST_ERR-2),STD_NOTNOW:(STD_FIRST_ERR-3),STD_NOSPACE:(STD_FIRST_ERR-4),STD_DENIED:(STD_FIRST_ERR-5),STD_NOMEM:(STD_FIRST_ERR-6),STD_EXISTS:(STD_FIRST_ERR-7),STD_NOTFOUND:(STD_FIRST_ERR-8),STD_SYSERR:(STD_FIRST_ERR-9),STD_INTR:(STD_FIRST_ERR-10),STD_OVERFLOW:(STD_FIRST_ERR-11),STD_WRITEPROT:(STD_FIRST_ERR-12),STD_NOMEDIUM:(STD_FIRST_ERR-13),STD_IOERR:(STD_FIRST_ERR-14),STD_WRONGSRV:(STD_FIRST_ERR-15),STD_OBJBAD:(STD_FIRST_ERR-16),STD_UNKNOWN:(STD_FIRST_ERR-17),DNS_UNAVAIL:(DNS_FIRST_ERR-1),DNS_NOTEMPTY:(DNS_FIRST_ERR-2),DNS_UNREACH:(DNS_FIRST_ERR-3),DNS_CLASH:(DNS_FIRST_ERR-4),RPC_FAILURE:-1,BUF_OVERFLOW:-2,print:function(stat){switch(stat){case Status.STD_OK:return'STD_OK';case Status.STD_CAPBAD:return'STD_CAPBAD';case Status.STD_COMBAD:return'STD_COMBAD';case Status.STD_ARGBAD:return'STD_ARGBAD';case Status.STD_NOTNOW:return'STD_NOTNOW';case Status.STD_NOSPACE:return'STD_NOSPACE';case Status.STD_DENIED:return'STD_DENIED';case Status.STD_NOMEM:return'STD_NOMEM';case Status.STD_EXISTS:return'STD_EXISTS';case Status.STD_NOTFOUND:return'STD_NOTFOUND';case Status.STD_SYSERR:return'STD_SYSERR';case Status.STD_INTR:return'STD_INTR';case Status.STD_OVERFLOW:return'STD_OVERFLOW';case Status.STD_WRITEPROT:return'STD_WRITEPROT';case Status.STD_NOMEDIUM:return'STD_NOMEDIUM';case Status.STD_IOERR:return'STD_IOERR';case Status.STD_WRONGSRV:return'STD_WRONGSRV';case Status.STD_OBJBAD:return'STD_OBJBAD';case Status.STD_UNKNOWN:return'STD_UNKNOWN';case Status.DNS_UNAVAIL:return'DNS_UNAVAIL';case Status.DNS_NOTEMPTY:return'DNS_NOTEMPTY';case Status.DNS_UNREACH:return'DNS_UNREACH';case Status.DNS_CLASH:return'DNS_CLASH';case Status.RPC_FAILURE:return'RPC_FAILURE';case Status.BUF_OVERFLOW:return'BUF_OVERFLOW';default:return'"'+stat+'"';}}};var Command={STD_MONITOR:STD_FIRST_COM,STD_AGE:(STD_FIRST_COM+1),STD_COPY:(STD_FIRST_COM+2),STD_DESTROY:(STD_FIRST_COM+3),STD_INFO:(STD_FIRST_COM+4),STD_RESTRICT:(STD_FIRST_COM+5),STD_STATUS:(STD_FIRST_COM+6),STD_TOUCH:(STD_FIRST_COM+7),STD_GETPARAMS:(STD_FIRST_COM+8),STD_SETPARAMS:(STD_FIRST_COM+9),STD_NTOUCH:(STD_FIRST_COM+10),STD_EXIT:(STD_FIRST_COM+11),STD_RIGHTS:(STD_FIRST_COM+12),STD_EXEC:(STD_FIRST_COM+13),STD_LOCATION:(STD_FIRST_COM+20),STD_LABEL:(STD_FIRST_COM+21),AFS_CREATE:(AFS_FIRST_COM+1),AFS_DELETE:(AFS_FIRST_COM+2),AFS_FSCK:(AFS_FIRST_COM+3),AFS_INSERT:(AFS_FIRST_COM+4),AFS_MODIFY:(AFS_FIRST_COM+5),AFS_READ:(AFS_FIRST_COM+6),AFS_SIZE:(AFS_FIRST_COM+7),AFS_DISK_COMPACT:(AFS_FIRST_COM+8),AFS_SYNC:(AFS_FIRST_COM+9),AFS_DESTROY:(AFS_FIRST_COM+10),DNS_CREATE:(DNS_FIRST_COM),DNS_DISCARD:(DNS_FIRST_COM+1),DNS_LIST:(DNS_FIRST_COM+2),DNS_APPEND:(DNS_FIRST_COM+3),DNS_CHMOD:(DNS_FIRST_COM+4),DNS_DELETE:(DNS_FIRST_COM+5),DNS_LOOKUP:(DNS_FIRST_COM+6),DNS_SETLOOKUP:(DNS_FIRST_COM+7),DNS_INSTALL:(DNS_FIRST_COM+8),DNS_REPLACE:(DNS_FIRST_COM+10),DNS_GETMASKS:(DNS_FIRST_COM+11),DNS_GETSEQNR:(DNS_FIRST_COM+12),DNS_RENAME:(DNS_FIRST_COM+13),DNS_GETROOT:(DNS_FIRST_COM+14),DNS_GETDEFAFS:(DNS_FIRST_COM+15),PS_STUN:(PS_FIRST_COM),PS_MIGRATE:(PS_FIRST_COM+1),PS_EXEC:(PS_FIRST_COM+2),PS_WRITE:(PS_FIRST_COM+4),PS_READ:(PS_FIRST_COM+5),PS_CREATE:(PS_FIRST_COM+6),PS_FORK:(PS_FIRST_COM+7),PS_SIGNAL:(PS_FIRST_COM+8),BR_CONNECT:(BR_FIRST_COM),BR_DISCONN:(BR_FIRST_COM+1),print:function(cmd){switch(cmd){case Command.STD_MONITOR:return'STD_MONITOR';case Command.STD_AGE:return'STD_AGE';case Command.STD_COPY:return'STD_COPY';case Command.STD_DESTROY:return'STD_DESTROY';case Command.STD_INFO:return'STD_INFO';case Command.STD_RESTRICT:return'STD_RESTRICT';case Command.STD_STATUS:return'STD_STATUS';case Command.STD_TOUCH:return'STD_TOUCH';case Command.STD_GETPARAMS:return'STD_GETPARAMS';case Command.STD_SETPARAMS:return'STD_SETPARAMS';case Command.STD_NTOUCH:return'STD_NTOUCH';case Command.STD_EXIT:return'STD_EXIT';case Command.STD_RIGHTS:return'STD_RIGHTS';case Command.STD_EXEC:return'STD_EXEC';case Command.STD_LOCATION:return'STD_LOCATION';case Command.STD_LABEL:return'STD_LABEL';case Command.AFS_CREATE:return'AFS_CREATE';case Command.AFS_DELETE:return'AFS_DELETE';case Command.AFS_FSCK:return'AFS_FSCK';case Command.AFS_INSERT:return'AFS_INSERT';case Command.AFS_MODIFY:return'AFS_MODIFY';case Command.AFS_READ:return'AFS_READ';case Command.AFS_SIZE:return'AFS_SIZE';case Command.AFS_DISK_COMPACT:return'AFS_DISK_COMPACT';case Command.AFS_SYNC:return'AFS_SYNC';case Command.AFS_DESTROY:return'AFS_DESTROY';case Command.DNS_CREATE:return'DNS_CREATE';case Command.DNS_DISCARD:return'DNS_DISCARD';case Command.DNS_LIST:return'DNS_LIST';case Command.DNS_APPEND:return'DNS_APPEND';case Command.DNS_CHMOD:return'DNS_CHMOD';case Command.DNS_DELETE:return'DNS_DELETE';case Command.DNS_LOOKUP:return'DNS_LOOKUP';case Command.DNS_SETLOOKUP:return'DNS_SETLOOKUP';case Command.DNS_INSTALL:return'DNS_INSTALL';case Command.DNS_REPLACE:return'DNS_REPLACE';case Command.DNS_GETMASKS:return'DNS_GETMASKS';case Command.DNS_GETSEQNR:return'DNS_GETSEQNR';case Command.DNS_RENAME:return'DNS_RENAME';case Command.DNS_GETROOT:return'DNS_GETRROT';case Command.DNS_GETDEFAFS:return'DNS_GETDEFAFS';case Command.PS_STUN:return'PS_STUN';case Command.PS_EXEC:return'PS_EXEC';case Command.PS_MIGRATE:return'PS_MIGRATE';case Command.PS_READ:return'PS_READ';case Command.PS_WRITE:return'PS_WRITE';case Command.PS_CREATE:return'PS_CREATE';case Command.PS_FORK:return'PS_FORK';case Command.PS_SIGNAL:return'PS_SIGNAL';case Command.BR_CONNECT:return'BR_CONNECT';case Command.BR_DISCONN:return'BR_DISCONN';default:return'"'+cmd+'"';}}};var PORT_SIZE=6;var PRIV_SIZE=4+PORT_SIZE;var CAP_SIZE=16;var Rights={AFS_RGT_READ:0x1,AFS_RGT_CREATE:0x2,AFS_RGT_MODIFY:0x4,AFS_RGT_DESTROY:0x8,AFS_RGT_ADMIN:0x80,DNS_COLMASK:((1<<DNS_MAXCOLUMNS)-1),DNS_RGT_COLALL:((1<<DNS_MAXCOLUMNS)-1),DNS_RGT_COL1:0x01,DNS_RGT_OWNER:0x01,DNS_RGT_COL2:0x02,DNS_RGT_GROUP:0x02,DNS_RGT_COL3:0x04,DNS_RGT_OTHERS:0x04,DNS_RGT_COL4:0x08,DNS_RGT_READ:0x10,DNS_RGT_CREATE:0x20,DNS_RGT_MODIFY:0x40,DNS_RGT_DELETE:0x80,HOST_INFO:0x01,HOST_READ:0x02,HOST_WRITE:0x04,HOST_EXEC:0x08,PSR_READ:0x01,PSR_WRITE:0x02,PSR_CREATE:0x04,PSR_DELETE:0x08,PSR_EXEC:0x10,PSR_KILL:0x20,PSR_ALL:0xff,NEG_SCHED:0x08,NEG_CPU:0x10,NEG_RES:0x20,NEG_LEVEL:0x40,PRV_ALL_RIGHTS:0xff};var DEF_RPC_MAX_HOP=4;var priv2pub_cache=[];var port=function(port_vals){if(port_vals==undefined)port_vals=[0,0,0,0,0,0];var port='';for(var i=0;i<PORT_SIZE;i++){port=port+Perv.char_of_int(port_vals[i]);}
return port;};var privat=function(obj,rights,rand){if(obj==undefined){this.prv_obj=0;this.prv_rights=0;this.prv_rand=port();}else{this.prv_obj=obj;this.prv_rights=rights;this.prv_rand=rand;}};var capability=function(cap_port,cap_priv){if(cap_port==undefined){this.cap_port=port();this.cap_priv=new privat();}else{this.cap_port=cap_port;if(cap_priv==undefined)
this.cap_priv=new privat();else
this.cap_priv=cap_priv;}};var header=function(h_port,h_priv,h_command,h_status){if(h_port==undefined){this.h_port=port();this.h_priv=new privat();this.h_command=undefined;this.h_status=undefined;}else{this.h_port=h_port;this.h_priv=h_priv;this.h_command=h_command;this.h_status=h_status;}};function Private(obj,rights,rand){var _obj=new privat(obj,rights,rand);Object.preventExtensions(_obj);return _obj;}
function Capability(cap_port,cap_priv){var obj=new capability(cap_port,cap_priv);Object.preventExtensions(obj);return obj;}
function Header(h_port,h_priv,h_command,h_status){var obj=new header(h_port,h_priv,h_command,h_status);Object.preventExtensions(obj);return obj;}
var uniqports=[];var Net={PORT_SIZE:PORT_SIZE,PRIV_SIZE:PRIV_SIZE,AFS_REQBUFSZ:AFS_REQBUFSZ,CAP_SIZE:CAP_SIZE,DNS_MAXCOLUMNS:DNS_MAXCOLUMNS,TIMEOUT:5000,DEF_RPC_MAX_HOP:DEF_RPC_MAX_HOP,Status:Status,Command:Command,Rights:Rights,Private:Private,Capability:Capability,Header:Header,Port:port,nilport:port(),nilpriv:Private(0,0,this.nilport),nilcap:Capability(this.nilport,this.nilpriv),get_portbyte:function(port,i){return Perv.int_of_char(String.get(port,i))},set_portbyte:function(port,i,byte){return String.set(port,i,(Perv.char_of_int(byte)));},key:function(cap){return cap.cap_port+
cap.cap_priv.prv_obj+
cap.cap_priv.prv_rights+
cap.cap_priv.prv_rand;},one_way:function(port){var key=Array.create(64,0);var block=Array.create(48,0);var pubport=String.make(PORT_SIZE,'\0');var i,j,k;j=0;for(i=0;i<64;i++){if((i&7)>5)
key[i]=0;else{if((this.get_portbyte(port,(j>>3))&(1<<(j&7)))!=0)
key[i]=1;else
key[i]=0;j++;}}
Des48.des_OWsetkey(key);block=Des48.des_OWcrypt48(block);var pb=0;for(i=0;i<PORT_SIZE;i++){var pbyte=0;for(j=0;j<8;j++){pbyte=pbyte|(block[pb]<<j);pb++;}
pubport=this.set_portbyte(pubport,i,pbyte);}
return pubport;},rights_req:function(rights,required){var all=true;Array.iter(required,function(rq){if(rq&rights==0)all=false;});return all;},port_cmp:function(port1,port2){var i;var eq=true;for(i=0;i<PORT_SIZE;i++){if(String.get(port1,i)!=String.get(port2,i))eq=false;}
return eq;},port_copy:function(port){return String.copy(port);},port_name:function(name){var p=String.make(PORT_SIZE,'\0');var i;var n=name.length;for(i=0;i<n;i++){var k=i%PORT_SIZE;p=String.set(p,k,Perv.char_of_int((Perv.int_of_char(String.get(p,k))+
Perv.int_of_char(String.get(name,i)))&0xff));}
return p;},port_to_str:function(port,compact){var i,str='';if(port){for(i=0;i<PORT_SIZE;i++){var num=Perv.int_of_char(String.get(port,i));if(!compact&&i>0)str=str+':';str=str+pad(num.toString(16).toUpperCase(),2);}}else str='undefined';return str;},port_of_str:function(str,compact){var tokens=str.split(':'),i,port='';for(i=0;i<PORT_SIZE;i++){var num='0x'+tokens[i];port=port+Perv.char_of_int(parseInt(num,16));}
return port;},port_of_param:function(str){if(str==undefined||String.equal(str,'undefined'))return undefined;var tokens=str.split(':');var i;var port='';for(i=0;i<PORT_SIZE;i++){var num='0x'+tokens[i];port=port+Perv.char_of_int(parseInt(num,16));}
return port;},prv2pub:function(port){var putport;if(priv2pub_cache[port]==undefined){putport=this.one_way(port);priv2pub_cache[port]=putport;}else putport=priv2pub_cache[port];return putport;},prv_decode:function(prv,rand){if(prv.prv_rights==Rights.PRV_ALL_RIGHTS)
return this.port_cmp(prv.prv_rand,rand);else{var tmp_port=this.port_copy(rand),pt0=this.get_portbyte(tmp_port,0),pr0=prv.prv_rights;tmp_port=this.set_portbyte(tmp_port,0,(pt0^pr0));tmp_port=this.one_way(tmp_port);return this.port_cmp(prv.prv_rand,tmp_port)}},prv_encode:function(obj,rights,rand){var tmp_port=this.port_copy(rand);var r1=rights;var rmask=Rights.PRV_ALL_RIGHTS;if(rights==Rights.PRV_ALL_RIGHTS)
return this.Private(obj,r1&rmask,tmp_port);else{var pt0=this.get_portbyte(tmp_port,0);tmp_port=this.set_portbyte(tmp_port,0,pt0^r1);tmp_port=this.one_way(tmp_port);return this.Private(obj,r1&rmask,tmp_port)}},prv_number:function(prv){return prv.prv_obj;},prv_rights:function(prv){return prv.prv_rights&Rights.PRV_ALL_RIGHTS;},prv_rights_check:function(prv,rand,required){if(!Net.prv_decode(prv,rand))return false;return(prv.prv_rights&required)==required;},restrict:function(priv,mask,random){var pr=this.prv_encode(priv.prv_obj,priv.prv_rights&mask,random);return pr;},uniqport:function(){var port=String.create(PORT_SIZE);var exists=true;while(exists){var i;for(i=0;i<=(PORT_SIZE-1);i++){port=String.set(port,i,(Perv.char_of_int(Rand.int(256))));}
if(uniqports[port]==undefined)
{uniqports[port]=port;exists=false;}}
return port;},cap_to_file:function(cap,path){try{Fs.writeFileSync(path,this.Print.capability(cap));}catch(e){}},cap_of_file:function(path){try{var cap=undefined;var data=Fs.readFileSync(path);var cp=this.Parse.capability(data.toString(),0);cap=cp.cap;return cap;}catch(e){return undefined;}},Position:function(x,y){this.x=x;this.y=y;},Copy:{port:function(src){return String.copy(src);},private:function(src,dst){if(dst!=undefined){dst.prv_obj=src.prv_obj;dst.prv_rights=src.prv_rights;dst.prv_rand=this.port(src.prv_rand);return dst;}else{var dstnew=Private();dstnew.prv_obj=src.prv_obj;dstnew.prv_rights=src.prv_rights;dstnew.prv_rand=this.port(src.prv_rand);return dstnew;}},capability:function(src,dst){if(dst!=undefined){dst.cap_port=this.port(src.cap_port);this.private(src.cap_priv,dst.cap_priv);return dst;}
else{var dstnew=Capability();dstnew.cap_port=this.port(src.cap_port);this.private(src.cap_priv,dstnew.cap_priv);return dstnew;}},header:function(src,dst){dst.h_port=this.port(src.h_port);dst.h_status=src.h_status;dst.h_command=src.h_command;if(src.h_priv!=undefined){if(dst.h_priv==undefined){var obj=new privat();Object.preventExtensions(obj);dst.h_priv=obj;}
this.private(src.h_priv,dst.h_priv);}else dst.h_priv=undefined;}},Equal:{port:function(port1,port2){if(port1==undefined||port2==undefined)return(port1==port2);else return String.equal(port1,port2);},private:function(prv1,prv2){return(prv1==undefined&&prv2==undefined)||(prv1.prv_obj==prv2.prv_obj&&prv1.prv_rights==prv2.prv_rights&&this.port(prv1.prv_rand,prv2.prv_rand))},capability:function(cap1,cap2){return(cap1==undefined&&cap2==undefined)||(this.private(cap1.cap_priv,cap2.cap_priv)&&this.port(cap1.cap_port,cap2.cap_port))},header:function(hdr1,hdr2){return(hdr1==undefined&&hdr2==undefined)||(this.private(hdr1.h_priv,hdr1.h_priv)&&this.port(hdr1.h_port,hdr2.h_port)&&hdr1.h_status==hdr2.h_status&&hdr1.h_command==hdr2.h_command)}},Parse:{port:function(str,pos){var port='';var len=str.length;if(pos==undefined)pos=0;if(len<(pos+17))return undefined;if(str[pos]=='[')pos++;for(var i=0;i<6;i++){var sv='0x'+str[pos]+str[pos+1];port=port+Perv.char_of_int(Perv.int_of_string(sv));pos=pos+2;if(str[pos]==':')pos++;}
if(str[pos]==']')pos++;return{port:port,pos:pos};},private:function(str,pos){var priv=Private();var sv;var len=str.length;if(pos==undefined)pos=0;if(len<(pos+25))return undefined;if(str[pos]=='(')pos++;sv='';while(str[pos]!='('){sv=sv+str[pos];pos++;}
priv.prv_obj=Perv.int_of_string(sv);sv='';if(str[pos]=='(')pos++;while(str[pos]!=')'){sv=sv+str[pos];pos++;}
priv.prv_rights=Perv.int_of_string('0x'+sv);if(str[pos]==')')pos++;var pp=this.port(str,pos);if(pp==undefined)return undefined;priv.prv_rand=pp.port;pos=pp.pos;return{priv:priv,pos:pos};},capability:function(str,pos){var cap=Capability();if(pos==undefined)pos=0;var pp=this.port(str,pos);if(pp==undefined)return undefined;cap.cap_port=pp.port;pos=pp.pos;pp=this.private(str,pos);if(pp==undefined)return undefined;cap.cap_priv=pp.priv;pos=pp.pos;return{cap:cap,pos:pos};}},Print:{capability:function(cap){var str='';if(cap==undefined)return'undefined';if(cap.cap_port!=undefined)str='['+this.port(cap.cap_port)+']';else str='[]';if(cap.cap_priv!=undefined)str=str+'('+this.private(cap.cap_priv)+')';else str=str+'()';return str;},command:Command.print,header:function(hdr){var str='';if(hdr==undefined)return'undefined';if(hdr.h_port!=undefined)str='['+this.port(hdr.h_port)+']';else str='[]';if(hdr.h_command!=undefined)str=str+': '+Command.print(hdr.h_command);if(hdr.h_priv!=undefined)str=str+'('+this.private(hdr.h_priv)+')';else str=str+'()';if(hdr.h_status!=undefined)str=str+' ?'+Status.print(hdr.h_status);return str;},port:function(port){var i;var str='';if(port!=undefined){for(i=0;i<PORT_SIZE;i++){var num=Perv.int_of_char(String.get(port,i));if(i>0)str=str+':';str=str+pad(num.toString(16).toUpperCase(),2);}}else str='undefined';return str;},private:function(priv){var str='';if(priv==undefined)return'undefined';str=priv.prv_obj;str=str+'('+String.format_hex(priv.prv_rights,2).toUpperCase()+')[';str=str+this.port(priv.prv_rand)+']';return str;},status:Status.print}};module.exports=Net;};BundleModuleCode['com/cbl']=function(module,exports){function CBL(callback){if(!(this instanceof CBL))return new CBL(callback);this.schedules=[];this.callback=callback;}
CBL.prototype.next=function(status){var f=this.schedules.shift();if(f){f(this.next.bind(this),status);}else if(this.callback)this.callback(status);}
CBL.prototype.push=function(f){this.schedules.push(f);}
CBL.prototype.start=function(){this.next();}
CBL.prototype.top=function(f){this.schedules.unshift(f);}
module.exports=CBL;};BundleModuleCode['jam/amp']=function(module,exports){var Io=Require('com/io');var Lz=Require('os/lz-string');var Comp=Require('com/compat');var Buf=Require('dos/buf');var Net=Require('dos/network');var Command=Net.Command;var Status=Net.Status;var current=none;var Aios=none;var CBL=Require('com/cbl');var COM=Require('jam/ampCOM'),AMMode=COM.AMMode,AMMessageType=COM.AMMessageType,AMState=COM.AMState,amp=COM.amp,options=COM.options,url2addr=COM.url2addr,addr2url=COM.addr2url,addrequal=COM.addrequal,resolve=COM.resolve,ipequal=COM.ipequal,getNetworkIP=COM.getNetworkIP,doUntilAck=COM.doUntilAck;options.localhost='localhost';options.version='1.11.1',options.AMC_MAXLIVE=5,options.TIMER=500,options.TRIES=10;options.REGTMO=1000;options.pem={};var ampMAN=Require('jam/ampMAN');var ampRPC=Require('jam/ampRPC');if(global.TARGET!='browser'){var ampUDP=Require('jam/ampUDP');var ampTCP=Require('jam/ampTCP');var ampStream=Require('jam/ampStream');}
var ampHTTP=Require('jam/ampHTTP');var ampHTTPS=Require('jam/ampHTTPS');var Amp=function(options){var obj;switch(options.proto){case'stream':obj=new amp.stream(options);break;case'http':obj=new amp.http(options);break;case'https':obj=new amp.https(options);break;case'tcp':obj=new amp.tcp(options);break;case'udp':default:obj=new amp.udp(options);}
return obj;}
module.exports.current=function(module){current=module.current;Aios=module;if(ampMAN)ampMAN.current(module);if(ampUDP)ampUDP.current(module);if(ampHTTP)ampHTTP.current(module);if(ampHTTPS)ampHTTPS.current(module);if(ampTCP)ampTCP.current(module);if(ampStream)ampStream.current(module);if(ampRPC)ampRPC.current(module);};module.exports.Amp=Amp;module.exports.AMMessageType=AMMessageType;module.exports.AMState=AMState;module.exports.AMMode=AMMode;module.exports.Com=COM;module.exports.Rpc=ampRPC;module.exports.url2addr=url2addr;module.exports.addr2url=addr2url;module.exports.resolve=resolve;module.exports.Command=Command
module.exports.Status=Status
module.exports.options=options;};BundleModuleCode['jam/ampCOM']=function(module,exports){var options={debug:{},magic:0x6dab,peekIP:'134.102.22.124',localhost:'localhost',}
var Comp=Require('com/compat');var Dns=Require('dns');var AMMode={AMO_UNICAST:1,AMO_MULTICAST:2,AMO_STATIC:4,AMO_BUFFER:8,AMO_OBJECT:16,AMO_COMPRESS:32,AMO_SERVER:64,AMO_CLIENT:128,AMO_ONEWAY:256,print:function(m){var s='',sep='';if(m&AMMode.AMO_UNICAST)s+=(sep+'UNI'),sep='|';if(m&AMMode.AMO_MULTICAST)s+=(sep+'MUL'),sep='|';if(m&AMMode.AMO_STATIC)s+=(sep+'STA'),sep='|';if(m&AMMode.AMO_BUFFER)s+=(sep+'BUF'),sep='|';if(m&AMMode.AMO_OBJECT)s+=(sep+'OBJ'),sep='|';if(m&AMMode.AMO_COMPRESS)s+=(sep+'ZIP'),sep='|';if(m&AMMode.AMO_CLIENT)s+=(sep+'CLI'),sep='|';if(m&AMMode.AMO_SERVER)s+=(sep+'SRV'),sep='|';if(m&AMMode.AMO_ONEWAY)s+=(sep+'ONE'),sep='|';return s;}}
var AMMessageType={AMMACK:0,AMMPING:1,AMMPONG:2,AMMLINK:3,AMMUNLINK:4,AMMRPCHEAD:6,AMMRPCDATA:7,AMMCONTROL:8,AMMRPC:9,AMMCOLLECT:10,AMMRPCHEADDATA:11,AMMSCAN:12,AMMINFO:13,print:function(op){switch(op){case AMMessageType.AMMACK:return"AMMACK";case AMMessageType.AMMPING:return"AMMPING";case AMMessageType.AMMPONG:return"AMMPONG";case AMMessageType.AMMLINK:return"AMMLINK";case AMMessageType.AMMUNLINK:return"AMMUNLINK";case AMMessageType.AMMRPCHEAD:return"AMMRPCHEAD";case AMMessageType.AMMRPCHEADDATA:return"AMMRPCHEADDATA";case AMMessageType.AMMRPCDATA:return"AMMRPCDATA";case AMMessageType.AMMRPC:return"AMMRPC";case AMMessageType.AMMCOLLECT:return"AMMCOLLECT";case AMMessageType.AMMCONTROL:return"AMMCONTROL";case AMMessageType.AMMSCAN:return"AMMSCAN";case AMMessageType.AMMINFO:return"AMMINFO";default:return"Chan.AMMessageType?";}}};var AMState={AMS_NOTINIT:1,AMS_INIT:2,AMS_READY:3,AMS_NEGOTIATE:4,AMS_CONNECTED:5,AMS_AWAIT:6,AMS_NOTCONNECTED:10,AMS_RENDEZVOUS:7,AMS_REGISTERED:8,AMS_PAIRING:9,AMS_PAIRED:10,print:function(op){switch(op){case AMState.AMS_NOTINIT:return"AMS_NOTINIT";case AMState.AMS_INIT:return"AMS_INIT";case AMState.AMS_READY:return"AMS_READY";case AMState.AMS_NEGOTIATE:return"AMS_NEGOTIATE";case AMState.AMS_CONNECTED:return"AMS_CONNECTED";case AMState.AMS_AWAIT:return"AMS_AWAIT";case AMState.AMS_NOTCONNECTED:return"AMS_NOTCONNECTED";case AMState.AMS_RENDEZVOUS:return"AMS_RENDEZVOUS";case AMState.AMS_REGISTERED:return"AMS_REGISTERED";case AMState.AMS_PAIRING:return"AMS_PAIRING";case AMState.AMS_PAIRED:return"AMS_PAIRED";default:return"Chan.AMState?";}}};var STD_FIRST_COM=1000;var STD_LAST_COM=1999;var STD_FIRST_ERR=(-STD_FIRST_COM);var STD_LAST_ERR=(-STD_LAST_COM);var PS_FIRST_COM=2200;var PS_LAST_COM=2299;var PS_FIRST_ERR=(-PS_FIRST_COM);var PS_LAST_ERR=(-PS_LAST_COM);var Command={STD_MONITOR:STD_FIRST_COM,STD_AGE:(STD_FIRST_COM+1),STD_COPY:(STD_FIRST_COM+2),STD_DESTROY:(STD_FIRST_COM+3),STD_INFO:(STD_FIRST_COM+4),STD_RESTRICT:(STD_FIRST_COM+5),STD_STATUS:(STD_FIRST_COM+6),STD_TOUCH:(STD_FIRST_COM+7),STD_GETPARAMS:(STD_FIRST_COM+8),STD_SETPARAMS:(STD_FIRST_COM+9),STD_NTOUCH:(STD_FIRST_COM+10),STD_EXIT:(STD_FIRST_COM+11),STD_RIGHTS:(STD_FIRST_COM+12),STD_EXEC:(STD_FIRST_COM+13),STD_LOCATION:(STD_FIRST_COM+20),STD_LABEL:(STD_FIRST_COM+21),PS_STUN:(PS_FIRST_COM),PS_MIGRATE:(PS_FIRST_COM+1),PS_EXEC:(PS_FIRST_COM+2),PS_WRITE:(PS_FIRST_COM+4),PS_READ:(PS_FIRST_COM+5),PS_CREATE:(PS_FIRST_COM+6),PS_FORK:(PS_FIRST_COM+7),PS_SIGNAL:(PS_FIRST_COM+8),};var Status={STD_OK:0,STD_CAPBAD:STD_FIRST_ERR,STD_COMBAD:(STD_FIRST_ERR-1),STD_ARGBAD:(STD_FIRST_ERR-2),STD_NOTNOW:(STD_FIRST_ERR-3),STD_NOSPACE:(STD_FIRST_ERR-4),STD_DENIED:(STD_FIRST_ERR-5),STD_NOMEM:(STD_FIRST_ERR-6),STD_EXISTS:(STD_FIRST_ERR-7),STD_NOTFOUND:(STD_FIRST_ERR-8),STD_SYSERR:(STD_FIRST_ERR-9),STD_INTR:(STD_FIRST_ERR-10),STD_OVERFLOW:(STD_FIRST_ERR-11),STD_WRITEPROT:(STD_FIRST_ERR-12),STD_NOMEDIUM:(STD_FIRST_ERR-13),STD_IOERR:(STD_FIRST_ERR-14),STD_WRONGSRV:(STD_FIRST_ERR-15),STD_OBJBAD:(STD_FIRST_ERR-16),STD_UNKNOWN:(STD_FIRST_ERR-17),RPC_FAILURE:-1,BUF_OVERFLOW:-2,}
var amp={AMMessageType:AMMessageType,AMState:AMState};function lookupNode(node,destnode){var chan,url;if(node.connections.ip&&node.connections.ip.lookup){url=node.connections.ip.lookup(destnode);if(url)return{chan:node.connections.ip,url:url,link:node.connections.ip.routingTable[url]};}}
function isLocal(addr){return addr=='localhost'||addr=='127.0.0.1'}
function isIpAddr(addr){return(/[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/.test(addr))}
function parseUrl(url){if(!isNaN(Number(url))||url=='*')return{proto:undefined,address:undefined,port:url,param:undefined,value:undefined}
var tokens=url.match(/((http|https|udp|tcp):\/\/)?([a-zA-Z0-9_\.\-]+):(\[?[a-zA-Z0-9]+\]?|\*)(\?([a-zA-z0-9]+)=([a-zA-Z0-9:]+))?/)
if(!tokens)
tokens=url.match(/((http|https|udp|tcp):\/\/)?([a-zA-Z0-9_\.\-]+)/);return{proto:tokens[2],address:tokens[3],port:tokens[4],param:tokens[6],value:tokens[7]}}
function url2addr(url,defaultIP,callback){var addr={address:defaultIP||options.localhost,port:undefined},parts=parseUrl(url);if(parts.proto)addr.proto=parts.proto;if(parts.address)addr.address=parts.address;if(parts.port&&parts.port!='*')
addr.port=!isNaN(Number(parts.port))?Number(parts.port):parts.port;if(parts.param){addr.parameter={};addr.parameter[parts.param]=parts.value;}
if(!isLocal(parts.address)&&!isIpAddr(parts.address)){if(Dns)
Dns.lookup(parts.address,function(err,_addr){if(!err)addr.address=_addr;if(callback)callback(addr);});else if(callback)callback(addr);return addr;}
if(callback)callback(addr);else return addr;};function params(po){var s='?',sep='';for(var p in po){s+=(sep+p+'='+po[p]);sep='&';}
return s;}
function addr2url(addr,noproto){return(!noproto&&addr.proto?(addr.proto+'://'):'')+
(isLocal(addr.address)?options.localhost:addr.address)+':'+
(addr.port?addr.port:'*')+
(!noproto&&addr.parameter?params(addr.parameter):'')};function obj2url(obj){if(!obj)return'*';if(obj.name&&!obj.address)return obj.name+':*';if(!obj.address)return'*';return(isLocal(obj.address)?options.localhost:obj.address)+':'+(obj.port?obj.port:'*')};function addrequal(addr1,addr2){return ipequal(addr1.address,addr2.address)&&addr1.port==addr2.port;}
function addrempty(addr){return!(addr&&addr.address&&addr.port);}
function resolve(url){return addr2url(url2addr(url))}
function ipequal(ip1,ip2){if(ip1==undefined||ip2==undefined)return false;else if((Comp.string.equal(ip1,'localhost')||Comp.string.equal(ip1,'127.0.0.1'))&&(Comp.string.equal(ip2,'localhost')||Comp.string.equal(ip2,'127.0.0.1')))return true;else return ip1==ip2;}
var ipnet=Require('net');var myip;function getNetworkInterfaces(){var results=null;try{var networkInterfaces=require('os').networkInterfaces;var nets=networkInterfaces();for(var name of Object.keys(nets)){for(var net of nets[name]){if(net.family==='IPv4'&&!net.internal){results=results||{};if(!results[name]){results[name]=[];}
results[name].push(net.address);}}}}catch(e){};return results}
function getNetworkIP(server,callback){var socket;try{if(typeof process!='undefined'&&process.env&&process.env['HOSTIP'])
return callback(undefined,process.env['HOSTIP']);}catch(e){}
if(!ipnet)return callback('Not supported','error');if(myip)return callback(undefined,myip);if(!server)server={address:options.peekIP,port:80};socket=ipnet.createConnection(server.port,server.address);socket.on('connect',function(){myip=socket.address().address;callback(undefined,socket.address().address);socket.end();});socket.on('error',function(e){var results=getNetworkInterfaces();if(!results)
return callback(e,'error');else{for(var i in results)return callback(undefined,results[i]);}});}
function doUntilAck(interval,fn,ack,arg){if(ack())return;fn(arg);return setTimeout(function(){doUntilAck(interval,fn,ack,arg);},interval);}
module.exports={AMMode:AMMode,AMMessageType:AMMessageType,AMState:AMState,doUntilAck:doUntilAck,getNetworkIP:getNetworkIP,amp:amp,options:options,addrempty:addrempty,addrequal:addrequal,addr2url:addr2url,ipequal:ipequal,isLocal:isLocal,lookupNode:lookupNode,obj2url:obj2url,resolve:resolve,url2addr:url2addr,Command:Command,Status:Status,}};BundleModuleCode['jam/ampMAN']=function(module,exports){var Io=Require('com/io');var Lz=Require('os/lz-string');var Comp=Require('com/compat');var Buf=Require('dos/buf');var Net=Require('dos/network');var Sec=Require('jam/security');var Command=Net.Command;var Status=Net.Status;var current=none;var Aios=none;var CBL=Require('com/cbl');var COM=Require('jam/ampCOM'),AMMode=COM.AMMode,AMMessageType=COM.AMMessageType,AMState=COM.AMState,amp=COM.amp,options=COM.options,url2addr=COM.url2addr,addr2url=COM.addr2url,addrequal=COM.addrequal,resolve=COM.resolve,ipequal=COM.ipequal,addrempty=COM.addrempty,getNetworkIP=COM.getNetworkIP;function msgData(msg){return msg.data&&msg.data.data?msg.data.data:msg.data;}
module.exports.current=function(module){current=module.current;Aios=module;};amp.man=function(options){}
amp.man.prototype.LOG=function(op,msg){if(!this.logging)return;switch(op){case'print':for(var i in this.logs){Aios.log(this.logs[i].op,this.logs[i].time,this.logs[i].msg,AMState.print(this.logs[i].state));}
this.logs=[];break;case'enable':this.logging=true;break;case'disable':this.logging=false;break;default:var date=new Date();var time=Math.floor(date.getTime());this.logs.push({op:op,time:time,msg:msg,state:(this.url&&this.links[this.url].state)});}}
amp.man.prototype.addTransaction=function(remote,tid,data){if(this.mode&AMMode.AMO_MULTICAST)
this.transactions[remote.address+remote.port+tid]=data;else
this.transactions[tid]=data;}
amp.man.prototype.deleteTransaction=function(remote,tid){if(this.mode&AMMode.AMO_MULTICAST)
delete this.transactions[remote.address+remote.port+tid];else
delete this.transactions[tid];}
amp.man.prototype.findTransaction=function(remote,tid){if(this.mode&AMMode.AMO_MULTICAST)
return this.transactions[remote.address+remote.port+tid];else
return this.transactions[tid];}
amp.man.prototype.checkState=function(state,addr){switch(state){case AMState.AMS_CONNECTED:if(this.mode&AMMode.AMO_ONEWAY)return true;if(this.mode&AMMode.AMO_MULTICAST)return this.links[addr2url(addr,true)];if(this.url&&this.links[this.url].state==AMState.AMS_CONNECTED)return true;break;}
return false;}
amp.man.prototype.config=function(options){for(var p in options)this[p]=options[p];}
amp.man.prototype.emit=function(event,arg,aux,aux2){if(this.events[event])this.events[event](arg,aux,aux2);}
amp.man.prototype.handle=function(msg,remote,response){var handler,thisnum,ipport,cmsg,url,ack,info;if(this.verbose>1)this.out('handle '+AMMessageType.print(msg.type)+' from '+addr2url(remote),true);switch(msg.type){case AMMessageType.AMMRPCHEAD:case AMMessageType.AMMRPCHEADDATA:if(!this.checkState(AMState.AMS_CONNECTED,remote))return;handler={};handler.tid=msg.tid;handler.remote=remote;handler.cmd=msg.cmd;handler.size=msg.size;handler.frags=msg.frags;if(msg.size<0)this.err('Got invalid message (size<0) from '+addr2url(remote));if(handler.size>0&&handler.frags>0){handler.buf=Buf.Buffer();dlist=Comp.array.range(0,handler.frags-1);this.addTransaction(remote,handler.tid,[handler,dlist,1000]);}else if(handler.size>0){handler.buf=msg.data;this.callback(handler);}else{handler.buf=Buf.Buffer();this.callback(handler);}
break;case AMMessageType.AMMRPCDATA:if(!this.checkState(AMState.AMS_CONNECTED,remote))return;thisnum=msg.off/this.dlimit;transaction=this.findTransaction(remote,msg.tid);if(transaction!=undefined){handler=transaction[0];if(this.verbose>1)
this.out('receiver: adding data num='+
thisnum+' off='+msg.off+' size='+msg.size+' dlist='+transaction[1],true);Buf.buf_get_buf(msg.data,handler.buf,msg.off,msg.size);transaction[1]=Comp.array.filter(transaction[1],function(num){return(num!=thisnum)});if(Comp.array.empty(transaction[1])){if(this.verbose>2)this.out('[AMP] receiver: finalize '+addr2url(remote),true);this.callback(handler);this.deleteTransaction(remote,msg.tid);}}
break;case AMMessageType.AMMRPC:if(!this.checkState(AMState.AMS_CONNECTED,remote))return;handler={};handler.tid=msg.tid;handler.remote=remote;handler.cmd=msg.cmd;handler.size=msg.size;handler.frags=msg.frags;handler.buf=Buf.Buffer(msgData(msg));this.callback(handler);if(this.ack&&response)this.ack(response);break;case AMMessageType.AMMPING:url=addr2url(remote,true);ipport=remote.port;if(this.mode&AMMode.AMO_MULTICAST){if(!this.links[url]||this.links[url].state!=AMState.AMS_CONNECTED)return;}else if(this.url){if(this.links[this.url].state!=AMState.AMS_CONNECTED)return;}
this.pong({address:remote.address,port:ipport},response);break;case AMMessageType.AMMPONG:ipport=remote.port;if(this.mode&AMMode.AMO_MULTICAST){url=addr2url(remote,true);if(this.links[url]&&this.links[url].state==AMState.AMS_CONNECTED){this.links[url].live=options.AMC_MAXLIVE;}}else if(this.url&&this.links[this.url].state==AMState.AMS_CONNECTED){this.links[this.url].live=options.AMC_MAXLIVE;}
if(this.ack&&response)this.ack(response);break;case AMMessageType.AMMACK:if(msg.status=="ELINKED"){if(this.mode&AMMode.AMO_MULTICAST){url=addr2url(remote,true);if(!this.links[url]||this.links[url].state==AMState.AMS_NOTCONNECTED){if(!this.links[url])this.links[url]={};this.links[url].snd=remote;this.links[url].live=options.AMC_MAXLIVE;this.links[url].port=msg.port;this.links[url].ipport=remote.port;this.links[url].state=AMState.AMS_CONNECTED;this.links[url].node=msg.node;this.emit('route+',url,msg.node);this.watchdog(true);if(this.verbose)
this.out('Linked with ad-hoc '+this.proto+' '+url+', AMP '+
Net.Print.port(msg.port)+', Node '+msg.node,true);}}}
break;case AMMessageType.AMMLINK:ipport=remote.port;url=addr2url(remote,true);if(this.secure&&(!msg.secure||!Sec.Port.equal(this.secure,msg.secure)))return;if(this.mode&AMMode.AMO_MULTICAST){if(!this.links[url]||this.links[url].state==AMState.AMS_NOTCONNECTED){if(!this.links[url])this.links[url]={};this.links[url].snd=remote;this.links[url].live=options.AMC_MAXLIVE;this.links[url].port=msg.port;this.links[url].ipport=remote.port;this.link(this.links[url].snd,false,none,response);this.links[url].state=AMState.AMS_CONNECTED;this.links[url].node=msg.node;this.emit('route+',url,msg.node,msg.remote);this.watchdog(true);if(this.verbose)
this.out('Linked with ad-hoc '+this.proto+' '+url+', AMP '+
Net.Print.port(msg.port)+', Node '+msg.node,true);}else if(this.links[url].state==AMState.AMS_CONNECTED){ack="ELINKED";}}else{if(this.links[url]&&!addrempty(this.links[url].snd)&&this.links[url].state==AMState.AMS_NOTCONNECTED&&ipequal(this.links[url].snd.address,remote.address)&&this.links[url].snd.port==ipport)
{this.links[url].snd=remote;this.links[url].port=msg.port;this.links[url].ipport=remote.port;this.links[url].node=msg.node;this.links[url].live=options.AMC_MAXLIVE;this.link(this.links[url].snd);this.links[url].state=AMState.AMS_CONNECTED;this.emit('route+',url,msg.node,msg.remote);this.watchdog(true);if(this.verbose)
this.out('Linked with preferred '+this.proto+' '+url+', '+
Net.Print.port(msg.port),true);}else if((!this.links[url]&&!this.url)||(this.links[url]&&this.links[url].state==AMState.AMS_NOTCONNECTED)||(this.broker&&this.url&&this.links[this.url].state==AMState.AMS_NOTCONNECTED)){if(!this.links[url])this.links[url]={};this.links[url].snd=remote;this.links[url].live=options.AMC_MAXLIVE;this.links[url].port=msg.port;this.links[url].ipport=remote.port;this.links[url].node=msg.node;this.link(this.links[url].snd,false,none,response);this.links[url].state=AMState.AMS_CONNECTED;this.url=url;this.emit('route+',url,msg.node);this.watchdog(true);if(this.verbose)
this.out('Linked with ad-hoc '+this.proto+' '+url+', '+
Net.Print.port(msg.port),true);}}
if(ack&&this.ack&&response)this.ack(response,ack);break;case AMMessageType.AMMUNLINK:ipport=remote.port;if(this.mode&AMMode.AMO_MULTICAST){url=addr2url(remote,true);if(this.links[url]&&!addrempty(this.links[url].snd)&&ipequal(this.links[url].snd.address,remote.address)&&this.links[url].snd.port==ipport&&this.links[url].state==AMState.AMS_CONNECTED){this.links[url].state=AMState.AMS_NOTCONNECTED;if(this.verbose)
this.out('Unlinked '+url+', '+
Net.Print.port(msg.port),true);this.emit('route-',url);if(!this.links[url].snd.connect)this.links[url].snd={};if(this.cleanup)this.cleanup(url);}}else{if(this.url&&!addrempty(this.links[this.url].snd)&&ipequal(this.links[this.url].snd.address,remote.address)&&this.links[this.url].snd.port==ipport&&this.links[this.url].state==AMState.AMS_CONNECTED)
{this.links[this.url].state=AMState.AMS_NOTCONNECTED;addr=this.links[this.url].snd;if(this.verbose)
this.out('Unlinked '+this.url+', '+
Net.Print.port(msg.port),true);this.emit('route-',addr2url(addr));if(!this.links[this.url].snd.connect)this.links[this.url].snd=null;if(this.cleanup)this.cleanup(url);}}
if(this.ack&&response)this.ack(response);break;case AMMessageType.AMMCONTROL:cmsg=JSON.parse(msgData(msg));if(this.verbose>1)this.out('# got message '+msgData(msg),true);this.LOG('rcv',cmsg);if(this.control&&this.links['*'])
this.control(this.links['*'],cmsg,remote);break;case AMMessageType.AMMSCAN:url=addr2url(remote,true);ipport=remote.port;info={world:(current.world&&current.world.id),stats:(current.world&&current.world.info()),};this.scan({address:remote.address,port:ipport,info:info},response);break;default:this.out('handle: Unknown message type '+msg.type,true);}}
amp.man.prototype.on=function(event,handler){this.events[event]=handler;}
amp.man.prototype.status=function(ip,ipport){var p,url,sl=[];if(ip=='%'){for(p in this.links)if(this.links[p]&&this.links[p].state==AMState.AMS_CONNECTED)
sl.push(this.links[p].node);return sl;}
if(this.mode&AMMode.AMO_MULTICAST){if(!ip){for(p in this.links)if(this.links[p]&&this.links[p].state==AMState.AMS_CONNECTED)return true;return false;}else{url=addr2url({address:ip,port:ipport});if(!this.links[url])return false;return this.links[url].state==AMState.AMS_CONNECTED;}}
if(!ip&&this.url)return this.links[this.url].state==AMState.AMS_CONNECTED||(this.mode&AMMode.AMO_ONEWAY)==AMMode.AMO_ONEWAY;return(this.url&&ipequal(this.links[this.url].snd.address,ip)&&this.links[this.url].snd.port==ipport);}};BundleModuleCode['jam/ampRPC']=function(module,exports){var Buf=Require('dos/buf');var Net=Require('dos/network');var Command=Net.Command;var Status=Net.Status;var COM=Require('jam/ampCOM');var current=none;var Aios=none;var Std={info:function(node,obj,callback){var node0=current.node;var to=COM.lookupNode(node0,node);if(to){to.link.control({cmd:COM.Command.STD_INFO,args:obj,},to.url,function(reply){callback(reply)})}},status:function(node,obj,callback){var node0=current.node;var to=COM.lookupNode(node0,node);if(to){to.link.control({cmd:COM.Command.STD_STATUS,args:obj,},to.url,function(reply){callback(reply)})}},}
var Run={stun:function(node,agent){},}
module.exports={current:function(module){current=module.current;Aios=module;},Run:Run,Std:Std};};BundleModuleCode['jam/ampUDP']=function(module,exports){var Io=Require('com/io');var Lz=Require('os/lz-string');var Comp=Require('com/compat');var Buf=Require('dos/buf');var Net=Require('dos/network');var Sec=Require('jam/security');var Command=Net.Command;var Status=Net.Status;var current=none;var Aios=none;var CBL=Require('com/cbl');var COM=Require('jam/ampCOM'),AMMode=COM.AMMode,AMMessageType=COM.AMMessageType,AMState=COM.AMState,amp=COM.amp,options=COM.options,url2addr=COM.url2addr,addr2url=COM.addr2url,obj2url=COM.obj2url,addrequal=COM.addrequal,resolve=COM.resolve,ipequal=COM.ipequal,doUntilAck=COM.doUntilAck,getNetworkIP=COM.getNetworkIP,magic=COM.options.magic;module.exports.current=function(module){current=module.current;Aios=module;};var dgram=Require('dgram');amp.udp=function(options){var self=this;options=checkOptions(options,{});this.proto='udp';this.options=options;if(options.oneway&&options.multicast)this.err('Invalid: Both ONEWAY and MULTICAST modes enabled!');this.verbose=checkOption(options.verbose,0);if(!options.rcv)options.rcv=url2addr('localhost:*');this.dir=options.dir;this.rcv=options.rcv;this.broker=options.broker;this.node=options.node;this.port=options.port||Net.uniqport();this.secure=this.options.secure;if(this.broker&&!this.broker.port)
Io.err('['+Io.Time()+' AMP] No broker port specified!');this.out=function(msg){Aios.print('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] '+msg);}
this.err=function(msg){Aios.print('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] Error: '+msg);throw'AMP';}
this.links={};if(options.snd){url=addr2url(options.snd,true);this.links[url]={snd:options.snd,tries:0,state:this.broker?AMState.AMS_AWAIT:AMState.AMS_NOTCONNECTED,live:COM.AMC_MAXLIVE};if(this.verbose>0)this.out('Added destiantion route '+url+', '+Io.inspect(this.links[url]));if(!options.multicast)this.url=url;}
if(this.broker){url='*';this.links[url]={tries:0,state:AMState.AMS_RENDEZVOUS,live:COM.options.AMC_MAXLIVE,queue:{pairing:[],lookup:[]}};if(this.verbose>0)this.out('Added default registration route '+url);}
this.rcv.name=options.name;this.mode=options.multicast?AMMode.AMO_MULTICAST:AMMode.AMO_UNICAST;if(options.oneway)this.mode|=AMMode.AMO_ONEWAY;this.sock=dgram.createSocket("udp4");this.dlimit=options.dlimit||512;this.count={rcv:0,snd:0,lnk:0,png:0};this.timer=undefined;this.inwatchdog=false;this.events=[];this.transactions=Comp.hashtbl.create();this.logs=[];this.logging=options.logging||false;if(this.logging){setInterval(function(){self.LOG('print')},5000);}};amp.udp.prototype.LOG=amp.man.prototype.LOG;amp.udp.prototype.addTransaction=amp.man.prototype.addTransaction;amp.udp.prototype.checkState=amp.man.prototype.checkState;amp.udp.prototype.deleteTransaction=amp.man.prototype.deleteTransaction;amp.udp.prototype.emit=amp.man.prototype.emit;amp.udp.prototype.findTransaction=amp.man.prototype.findTransaction;amp.udp.prototype.handle=amp.man.prototype.handle;amp.udp.prototype.on=amp.man.prototype.on;amp.udp.prototype.status=amp.man.prototype.status;amp.udp.prototype.control=function(link,msg,remote){var self=this;switch(msg.type){case'lookup':if(link.queue.lookup[msg.path]){link.queue.lookup[msg.path](msg.data);delete link.queue.lookup[msg.path];}
break;case'registered':if(link.state==AMState.AMS_RENDEZVOUS){link.state=AMState.AMS_REGISTERED;if(this.verbose)self.out('Registered on broker with name '+this.rcv.name);}
break;case'pairing':if(link.state==AMState.AMS_REGISTERED){var punch={type:'punch',from:this.rcv.name,to:msg.client.name},counter=options.TRIES;link.state=AMState.AMS_PAIRING;for(var con in msg.client.connections){doUntilAck(options.TIMER,function(i){counter--;self.send(punch,msg.client.connections[i]);},function(){return counter==0||link.state!=AMState.AMS_PAIRING;},con);}}
break;case'ack':if(link.state==AMState.AMS_PAIRING){if(this.verbose)self.out('Paired with '+msg.from+'('+addr2url(remote)+')');self.links.forEach(function(link2,url){if(url=='*')return;if(link2&&link2.state==AMState.AMS_AWAIT&&link2.snd.name==link.snd.name){var newurl=addr2url(remote,true);self.links[url]=undefined;self.links[newurl]=link2;link2.state=AMState.AMS_NOTCONNECTED;link2.snd.address=remote.address;link2.snd.port=remote.port;if(self.mode&AMMode.AMO_UNICAST)self.url=newurl,self;}});link.state=AMState.AMS_RENDEZVOUS;if(link.queue.pairing.length)
link.snd={name:link.queue.pairing.shift().snd.name};else
link.snd=undefined;self.watchdog(true);}
break;case'punch':if(msg.to==this.rcv.name){this.send({type:'ack',from:this.rcv.name},remote);}
break;}}
amp.udp.prototype.init=function(callback){if(callback)callback();};amp.udp.prototype.link=function(snd,connect,key){var self=this,url,buf=Buf.Buffer(),sock=this.sock;if(this.verbose>1)this.out('amp.link: to '+(snd&&snd.address)+':'+((snd&&snd.port)||'*'));snd=this.updateLinkTable(snd||(this.url&&this.links[this.url].snd),connect,key);if(snd&&snd.parameter&&snd.parameter.secure)key=snd.parameter.secure;if(!snd)return this.watchdog(true);Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMLINK);Buf.buf_put_port(buf,this.port);Buf.buf_put_string(buf,this.node?this.node.id:'*');Buf.buf_put_string(buf,key?key:'');this.count.snd+=Buf.length(buf);this.count.lnk++;sock.send(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err){sock.close();self.emit('error',err);}});};amp.udp.prototype.lookup=function(path,callback){var link=this.links['*'];if(!link&&callback)return callback([]);if(callback)link.queue.lookup[path]=callback;this.send({type:'lookup',name:this.rcv.name,linfo:this.rcv,data:path},this.broker,function(){});}
amp.udp.prototype.lookupLinkTable=function(snd){if(this.url)return this.links[this.url];if(!snd)return;var url=obj2url(snd);return this.links[url];}
amp.udp.prototype.pairing=function(link){if(!this.links['*'].snd){this.links['*'].snd={name:link.snd.name};this.watchdog(true);}else{this.links['*'].queue.pairing.push(link);}}
amp.udp.prototype.ping=function(snd){var self=this,buf=Buf.Buffer(),sock=this.sock;Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMPING);Buf.buf_put_port(buf,this.port);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;}
if(snd==undefined)this.err('amp.udp.ping: no destinataion set (snd==null)');if(this.verbose>1)this.out('amp.ping: to '+addr2url(snd));this.count.snd+=Buf.length(buf);this.count.png++;sock.send(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err){sock.close();self.emit('error',err);}});};amp.udp.prototype.pong=function(snd){var self=this,buf=Buf.Buffer(),sock=this.sock;Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMPONG);Buf.buf_put_port(buf,this.port);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;}
if(snd==undefined)this.err('amp.udp.pong: no destinataion set (snd==null)');if(this.verbose>1)this.out('amp.pong: to '+addr2url(snd));this.count.snd+=Buf.length(buf);this.count.png++;sock.send(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err){sock.close();self.emit('error',err);}});};amp.udp.prototype.receiver=function(callback,rcv){var self=this;if(rcv==undefined||rcv.address==undefined)rcv={},rcv.address=this.rcv.address;if(rcv.port==undefined)rcv.port=this.rcv.port;if(callback)this.callback=callback;var buf=Buf.Buffer();var sock=this.sock;sock.on('listening',function(){var address=sock.address();if(!rcv.port)self.rcv.port=rcv.port=address.port;if(self.verbose>1)self.out('UDP receiver listening on '+addr2url(rcv));if(self.dir.ip=='*')self.dir=Aios.DIR.IP(self.rcv.port);getNetworkIP(undefined,function(err,ip){if(!err)self.rcv.address=ip;if(self.verbose)self.out('IP port '+addr2url(self.rcv)+' (proto '+self.options.proto+')');if(err)return self.out("! Unable to obtain network connection information: "+err);});});sock.on('error',function(err){Io.out('[AMP] UDP error: '+err);self.sock.close();});sock.on('message',function(message,remote){var handler,dfrags,dlist,msgtyp,tid,ipport,discard,off,size,thisnum,transaction,more,port,addr,url,data,msg;remote.address=remote.address.replace(/^::ffff:/,'')
Buf.buf_init(buf);Buf.buf_of_str(buf,message);self.count.rcv+=message.length;msg={};if(message.length>=10){msg.magic=Buf.buf_get_int16(buf);if(msg.magic!=magic)return;msg.type=Buf.buf_get_int16(buf);discard=false;if(self.verbose>1){url=addr2url(remote,true);self.out('receiver: Receiving Message from '+url+' ['+message.length+'] '+
AMMessageType.print(msg.type)+' in state '+
(self.mode&AMMode.AMO_MULTICAST?(self.links[url]&&AMState.print(self.links[url].state)):(self.links[self.url]&&AMState.print(self.links[self.url].state))));}
switch(msg.type){case AMMessageType.AMMRPCHEAD:if(!self.checkState(AMState.AMS_CONNECTED,remote))return;msg.tid=Buf.buf_get_int16(buf);msg.port=Buf.buf_get_port(buf);msg.cmd=Buf.buf_get_int16(buf);msg.size=Buf.buf_get_int32(buf);msg.frags=Buf.buf_get_int16(buf);msg.data=Buf.Buffer();self.handle(msg,remote);break;case AMMessageType.AMMRPCDATA:if(!self.checkState(AMState.AMS_CONNECTED,remote))return;msg.tid=Buf.buf_get_int16(buf);msg.port=Buf.buf_get_port(buf);msg.off=Buf.buf_get_int32(buf);msg.size=Buf.buf_get_int16(buf);msg.more=Buf.buf_get_int16(buf);msg.data=buf;self.handle(msg,remote);break;case AMMessageType.AMMPING:msg.port=Buf.buf_get_port(buf);self.handle(msg,remote);break;case AMMessageType.AMMPONG:msg.port=Buf.buf_get_port(buf);self.handle(msg,remote);break;case AMMessageType.AMMLINK:msg.port=Buf.buf_get_port(buf);msg.node=Buf.buf_get_string(buf);msg.secure=Buf.buf_get_string(buf);if(msg.secure!='')msg.secure=Sec.Port.ofString(msg.secure);self.handle(msg,remote);break;case AMMessageType.AMMUNLINK:msg.port=Buf.buf_get_port(buf);self.handle(msg,remote);break;case AMMessageType.AMMCONTROL:msg.port=Buf.buf_get_port(buf);msg.data=Buf.buf_get_string(buf);self.handle(msg,remote);break;}}});};amp.udp.prototype.request=function(cmd,msg,snd){var self=this,buf=Buf.Buffer(),sock=this.sock,size=msg.data.length,frags=div((size+self.dlimit-1),self.dlimit),tid=msg.tid||Comp.random.int(65536/2);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;}
if(snd==undefined)this.err('amp.udp.request: no destinataion set(snd==null)');Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMRPCHEAD);Buf.buf_put_int16(buf,tid);Buf.buf_put_port(buf,this.port);Buf.buf_put_int16(buf,cmd);Buf.buf_put_int32(buf,size);Buf.buf_put_int16(buf,frags);if(self.verbose>1)self.out('Send AMMRPCHEAD tid='+tid+' @'+Comp.pervasives.mtime());this.count.snd+=Buf.length(buf);sock.send(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(self.verbose>1)self.out('Send AMMRPCHEAD tid='+tid+'. Done @'+Comp.pervasives.mtime());if(err){if(self.verbose>1)self.out('AMMRPCHEAD Error: '+err);sock.close();if(callback)callback(Status.STD_IOERR,err);}else{if(size>0){var dsend=function(n,off){var fsize,more;if(frags==1)fsize=size;else if(n<frags)fsize=self.dlimit;else fsize=size-off;if(n==frags)more=0;else more=1;Buf.buf_init(buf);Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMRPCDATA);Buf.buf_put_int16(buf,tid);Buf.buf_put_port(buf,self.port);Buf.buf_put_int32(buf,off);Buf.buf_put_int16(buf,fsize);Buf.buf_put_int16(buf,more);Buf.buf_put_buf(buf,msg,off,fsize);if(self.verbose>1)self.out('Send AMMRPCDATA tid='+tid+'. Start #'+n+'/'+frags+'  @'+Comp.pervasives.mtime());self.count.snd+=Buf.length(buf);sock.send(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(self.verbose>1)self.out('Send AMMRPCDATA tid='+tid+'. Done #'+n+'/'+frags+' @'+Comp.pervasives.mtime());if(err){if(self.verbose>1)self.out('AMMRPCDATA Error: '+err);sock.close();self.emit('error',err);}
else if(n<frags)dsend(n+1,off+fsize);});};dsend(1,0);}}});};amp.udp.prototype.reply=function(cmd,msg,snd){this.request(cmd,msg,snd);}
amp.udp.prototype.scan=function(snd,response,callback){var self=this,msg={magic:magic};msg.type=response?AMMessageType.AMMACK:AMMessageType.AMMSCAN;if(this.verbose>1)this.out('amp.scan: to '+addr2url(snd));}
amp.udp.prototype.send=function(msg,snd){var buf=Buf.Buffer(),sock=this.sock,data=JSON.stringify(msg);this.LOG('snd',msg);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;}
if(snd==undefined)this.err('amp.udp.send: no destinataion set (snd==null)');if(this.verbose>1)this.out('amp.send: to '+addr2url(snd)+': '+data);Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMCONTROL);Buf.buf_put_port(buf,this.port);Buf.buf_put_string(buf,data);this.count.snd+=Buf.length(buf);sock.send(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err)self.emit('error',err);});};amp.udp.prototype.start=function(callback){var self=this,link,startwatch=false
s=this.secure?' (security port '+Sec.Port.toString(this.secure)+')':'';if(this.verbose>0)this.out('Starting '+(this.rcv.name?(this.rcv.name+' '):'')+addr2url(this.rcv)+
(this.mode&AMMode.AMO_UNICAST&&this.url?(' -> '+this.url):'')+' ['+AMMode.print(this.mode)+'] (proto '+this.proto+')'+s);if(this.mode&AMMode.AMO_UNICAST){if(this.url){link=this.links[this.url];link.state=this.broker?AMState.AMS_AWAIT:AMState.AMS_NOTCONNECTED;if(link.snd&&!(this.mode&AMMode.AMO_ONEWAY))
startwatch=true;if(link.snd&&(this.mode&AMMode.AMO_ONEWAY))
this.emit('route+',addr2url(link.snd,true));if(this.broker)this.pairing(link);}}
if(this.broker){startwatch=true;}
if(startwatch)this.watchdog(true);if(!this.sock){this.sock=dgram.createSocket("udp4");this.receiver();}
this.sock.bind(this.rcv.port,undefined,function(arg){if(callback)callback();});}
amp.udp.prototype.stop=function(callback){if(this.mode&AMMode.AMO_MULTICAST)
for(var p in this.links){if(this.links[p]){this.unlink(this.links[p].snd);this.links[p].state=AMState.AMS_NOTCONNECTED;}}
else
this.links.state=AMState.AMS_NOTCONNECTED;if(this.timer)clearTimeout(this.timer),this.timer=undefined;if(this.sock)this.sock.close(),this.sock=undefined;if(callback)callback();}
amp.udp.prototype.unlink=function(snd){var self=this,buf=Buf.Buffer(),url=snd?addr2url(snd,true):null,sock=this.sock;if(!this.links[url||this.url]||this.links[url||this.url].state!=AMState.AMS_CONNECTED)return;this.emit('route-',addr2url(snd,true));if(this.mode&AMMode.AMO_ONEWAY)return;Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMUNLINK);Buf.buf_put_port(buf,this.port);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;url=this.url;}
if(snd==undefined)this.err('amp.udp.unlink: no destination (snd==null)');if(this.verbose>1)this.out('amp.unlink: to '+addr2url(snd));this.count.snd+=Buf.length(buf);sock.send(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err){sock.close();self.emit('error',err)}});this.links[url].state=AMState.AMS_NOTCONNECTED;if(!this.links[url].snd.connect)this.links[url].snd={};if(this.broker){this.links[url]=undefined;if(this.url)this.url=undefined;}
if(this.verbose)this.out('Unlinked '+addr2url(snd));};amp.udp.prototype.updateLinkTable=function(snd,connect){var link;if(!snd)this.err('amp.udp.link: no destinataion set (snd==null)');url=addr2url(snd,true);if(this.broker&&!snd.port&&!this.links[url]){link=this.links[url]={state:AMState.AMS_AWAIT,tries:0,connect:connect,live:options.AMC_MAXLIVE,snd:{name:snd.address}};if(connect)link.snd.connect=true;if(this.mode&AMMode.AMO_UNICAST)this.url=url;this.pairing(link);return;}else if(this.mode&AMMode.AMO_UNICAST){if(!this.links[url])link=this.links[url]={state:AMState.AMS_NOTCONNECTED};else link=this.links[url];if(snd!=undefined&&snd.address!=undefined&&snd.port!=undefined&&!link.snd)
link.snd=snd;if(snd!=undefined&&snd.address!=undefined&&snd.port!=undefined&&snd.port!='*'&&link.snd.address==undefined)
link.snd.address=snd.address;if(snd!=undefined&&snd.port!=undefined&&link.snd.port==undefined)
link.snd.port=snd.port;if(connect)link.snd.connect=true;if((link.state&&link.state!=AMState.AMS_NOTCONNECTED&&link.state!=AMState.AMS_PAIRED)||this.mode&AMMode.AMO_ONEWAY)return;if(typeof link.snd.port=='string')return;if(snd==undefined||snd.address==undefined)snd={},snd.address=link.snd.address;if(snd.port==undefined)snd.port=link.snd.port;this.url=url;}else{if(!this.links[url]||!this.links[url].snd.address)
link=this.links[url]={snd:snd,state:AMState.AMS_NOTCONNECTED,tries:0,connect:connect,live:options.AMC_MAXLIVE};if(!this.inwatchdog&&connect){this.watchdog(true);return;}}
return snd;}
amp.udp.prototype.watchdog=function(run,immed){var self=this;if(this.timer)clearTimeout(self.timer),this.timer=undefined;if(run)this.timer=setTimeout(function(){var con,to,tokens;if(!self.timer||!self.sock||self.inwatchdog)return;self.timer=undefined;self.inwatchdog=true;function handle(obj,url){if(self.verbose>1)self.out('Watchdog: handle link '+
url+(obj.snd?('('+obj2url(obj.snd)+')'):'')+' in state '+AMState.print(obj.state)+'['+obj.live+'] '+
(obj.tries!=undefined?('[#'+obj.tries+']'):''));switch(obj.state){case AMState.AMS_CONNECTED:if(obj.live==0){if(self.verbose>0)
self.out('Endpoint '+addr2url(obj.snd)+' not responding, propably dead. Unlinking...');if(self.mode&AMMode.AMO_MULTICAST)self.unlink(obj.snd);else self.unlink();obj.state=AMState.AMS_NOTCONNECTED;if(!obj.snd.connect)obj.snd={};if(self.broker){self.watchdog(true);if(self.links['*']){self.links['*'].state=AMState.AMS_RENDEZVOUS;}}}else{obj.tries=0;obj.live--;self.watchdog(true);if(self.mode&AMMode.AMO_MULTICAST)self.ping(obj.snd);else self.ping();}
break;case AMState.AMS_NOTCONNECTED:if(!obj.snd)return;if(obj.snd.port&&typeof obj.snd.port=='string'){tokens=obj.snd.port.split('-');if(tokens.length==2)obj.range=[Number(tokens[0]),Number(tokens[1])];}
if(obj.range){obj.snd.port=Comp.random.interval(obj.range[0],obj.range[1]);if(self.verbose>0)
self.out('Trying link to '+addr2url(obj.snd));if(self.mode&AMMode.AMO_MULTICAST)self.link(obj.snd);else self.link();obj.tries++;if(obj.tries<options.TRIES)self.watchdog(true);else{obj.snd={},obj.tries=0,obj.range=undefined;}}else if(obj.snd.port&&typeof obj.snd.port=='number'){if(self.verbose>0&&obj.tries==0)
self.out('Trying link to '+addr2url(obj.snd));if(self.mode&AMMode.AMO_MULTICAST)self.link(obj.snd);else self.link();obj.tries++;if(obj.tries<options.TRIES)self.watchdog(true);else{self.out('Giving up to link '+addr2url(obj.snd));self.emit('error','link',addr2url(obj.snd,true));obj.snd={},obj.tries=0;}}
break;case AMState.AMS_RENDEZVOUS:obj.next=Aios.time()+options.REGTMO;obj.interval=options.REGTMO;self.send({type:'register',name:self.rcv.name,linfo:self.rcv},self.broker,function(){});self.watchdog(true);break;case AMState.AMS_REGISTERED:if(obj.snd&&obj.snd.name&&obj.tries<options.TRIES){obj.tries++;self.send({type:'pair',from:self.rcv.name,to:obj.snd.name},self.broker,function(){});}else if(options.REGTMO&&Aios.time()>obj.next){obj.interval*=2;obj.interval=Math.min(obj.interval,options.REGTMO*8);obj.next=Aios.time()+obj.interval;self.send({type:'register',name:self.rcv.name,linfo:self.rcv},self.broker,function(){});}
self.watchdog(true);break;}}
for(var p in self.links)if(self.links[p])handle(self.links[p],p);self.inwatchdog=false;},immed?0:options.TIMER);};};BundleModuleCode['jam/ampTCP']=function(module,exports){var Io=Require('com/io');var Lz=Require('os/lz-string');var Comp=Require('com/compat');var Buf=Require('dos/buf');var Net=Require('dos/network');var Sec=Require('jam/security');var Command=Net.Command;var Status=Net.Status;var current=none;var Aios=none;var CBL=Require('com/cbl');var COM=Require('jam/ampCOM'),AMMode=COM.AMMode,AMMessageType=COM.AMMessageType,AMState=COM.AMState,amp=COM.amp,options=COM.options,url2addr=COM.url2addr,addr2url=COM.addr2url,obj2url=COM.obj2url,addrequal=COM.addrequal,resolve=COM.resolve,ipequal=COM.ipequal,doUntilAck=COM.doUntilAck,getNetworkIP=COM.getNetworkIP,magic=COM.options.magic;module.exports.current=function(module){current=module.current;Aios=module;};var net=require('net');var dgram=Require('dgram');amp.tcp=function(options){var self=this;options=checkOptions(options,{});this.options=options;this.proto='tcp';if(options.oneway&&options.multicast)this.err('Invalid: Both ONEWAY and MULTICAST modes enabled!');this.verbose=checkOption(options.verbose,0);if(!options.rcv)options.rcv=url2addr('localhost:*');this.dir=options.dir;this.rcv=options.rcv;this.broker=options.broker;this.node=options.node;this.port=options.port||Net.uniqport();this.secure=this.options.secure;if(this.broker&&!this.broker.port)
Io.err('[AMP] No broker port specified!');this.out=function(msg){Aios.print('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] '+msg);}
this.err=function(msg){Aios.print('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] Error: '+msg);throw'AMP';}
this.links={};if(options.snd){url=addr2url(options.snd,true);this.links[url]={snd:options.snd,tries:0,state:this.broker?AMState.AMS_AWAIT:AMState.AMS_NOTCONNECTED,live:COM.AMC_MAXLIVE};if(this.verbose>0)this.out('Added destiantion route '+url+', '+Io.inspect(this.links[url]));if(!options.multicast)this.url=url;}
if(this.broker){url='*';this.links[url]={tries:0,state:AMState.AMS_RENDEZVOUS,live:COM.options.AMC_MAXLIVE,queue:{pairing:[],lookup:[]}};if(this.verbose>0)this.out('Added default registration route '+url);}
this.rcv.name=options.name;this.mode=options.multicast?AMMode.AMO_MULTICAST:AMMode.AMO_UNICAST;if(options.oneway)this.mode|=AMMode.AMO_ONEWAY;this.sock=undefined;this.count={rcv:0,snd:0,lnk:0,png:0};this.timer=undefined;this.inwatchdog=false;this.events=[];this.transactions=Comp.hashtbl.create();this.logs=[];this.logging=options.logging||false;if(this.logging){setInterval(function(){self.LOG('print')},5000);}};amp.tcp.prototype.LOG=amp.man.prototype.LOG;amp.tcp.prototype.addTransaction=amp.man.prototype.addTransaction;amp.tcp.prototype.checkState=amp.man.prototype.checkState;amp.tcp.prototype.deleteTransaction=amp.man.prototype.deleteTransaction;amp.tcp.prototype.emit=amp.man.prototype.emit;amp.tcp.prototype.findTransaction=amp.man.prototype.findTransaction;amp.tcp.prototype.handle=amp.man.prototype.handle;amp.tcp.prototype.on=amp.man.prototype.on;amp.tcp.prototype.status=amp.man.prototype.status;amp.tcp.prototype.init=function(callback){if(callback)callback();};amp.tcp.prototype.link=function(snd,connect,key){var self=this,url,buf=Buf.Buffer();if(this.verbose>1)this.out('amp.link: to '+(snd&&snd.address)+':'+((snd&&snd.port)||'*'));snd=this.updateLinkTable(snd||(this.url&&this.links[this.url].snd),connect,key);if(snd&&snd.parameter&&snd.parameter.secure)key=snd.parameter.secure;if(!snd)return this.watchdog(true);Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMLINK);Buf.buf_put_port(buf,this.port);Buf.buf_put_string(buf,this.node?this.node.id:'*');Buf.buf_put_string(buf,key?key:'');Buf.buf_put_int32(buf,this.rcv.port);this.count.snd+=Buf.length(buf);this.count.lnk++;this.write(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err){self.emit('error',err);}});};amp.tcp.prototype.lookup=function(path,callback){var link=this.links['*'];if(!link&&callback)return callback([]);if(callback)link.queue.lookup[path]=callback;this.send({type:'lookup',name:this.rcv.name,linfo:this.rcv,data:path},this.broker,function(){});}
amp.tcp.prototype.lookupLinkTable=function(snd){if(this.url)return this.links[this.url];if(!snd)return;var url=obj2url(snd);return this.links[url];}
amp.tcp.prototype.ping=function(snd){var self=this,buf=Buf.Buffer();Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMPING);Buf.buf_put_port(buf,this.port);Buf.buf_put_int32(buf,this.rcv.port);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;}
if(snd==undefined)this.err('ping: snd=null');if(this.verbose>1)this.out('amp.ping: to '+addr2url(snd));this.count.snd+=Buf.length(buf);this.count.png++;this.write(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err){self.emit('error',err);}});};amp.tcp.prototype.pong=function(snd){var self=this,buf=Buf.Buffer();Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMPONG);Buf.buf_put_port(buf,this.port);Buf.buf_put_int32(buf,this.rcv.port);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;}
if(snd==undefined)this.err('pong: snd=null');if(this.verbose>1)this.out('amp.pong: to '+addr2url(snd));this.count.snd+=Buf.length(buf);this.count.png++;this.write(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err){self.emit('error',err);}});};amp.tcp.prototype.receiver=function(callback,rcv){var self=this;if(rcv==undefined||rcv.address==undefined)rcv={},rcv.address=this.rcv.address;if(rcv.port==undefined)rcv.port=this.rcv.port;if(callback)this.callback=callback;this.sock=net.createServer(function(sock){var chunks,remote;sock.on('data',function(message){if(!remote)remote={address:sock.remoteAddress.replace(/^::ffff:/,''),port:sock.remotePort};if(!chunks)chunks=message;else chunks=Buffer.concat([chunks,message]);});sock.on('end',function(){var message=chunks,handler,dfrags,dlist,msgtyp,tid,ipport,discard,off,size,thisnum,transaction,more,port,addr,url,data,msg;var buf=Buf.Buffer();Buf.buf_init(buf);Buf.buf_of_str(buf,message);self.count.rcv+=message.length;msg={};if(message.length>=10){msg.magic=Buf.buf_get_int16(buf);if(msg.magic!=magic)return;msg.type=Buf.buf_get_int16(buf);discard=false;if(self.verbose>1){url=addr2url(remote,true);self.out('receiver: Receiving Message from '+url+' ['+message.length+'] '+
AMMessageType.print(msg.type));}
switch(msg.type){case AMMessageType.AMMRPCHEADDATA:msg.tid=Buf.buf_get_int16(buf);msg.port=Buf.buf_get_port(buf);msg.sndport=Buf.buf_get_int32(buf);remote.port=msg.sndport;url=addr2url(remote,true);if(self.verbose>1)self.out('receiver: Receiving Message in state '+
(self.mode&AMMode.AMO_MULTICAST?(self.links[url]&&AMState.print(self.links[url].state)):(self.links[self.url]&&AMState.print(self.links[self.url].state))));if(!self.checkState(AMState.AMS_CONNECTED,remote))return;msg.cmd=Buf.buf_get_int16(buf);msg.size=Buf.buf_get_int32(buf);msg.data=buf;msg.frags=0;msg.more=false;self.handle(msg,remote);break;case AMMessageType.AMMPING:msg.port=Buf.buf_get_port(buf);msg.sndport=Buf.buf_get_int32(buf);remote.port=msg.sndport;url=addr2url(remote,true);if(self.verbose>1)self.out('receiver: Receiving Message in state '+
(self.mode&AMMode.AMO_MULTICAST?(self.links[url]&&AMState.print(self.links[url].state)):(self.links[self.url]&&AMState.print(self.links[self.url].state))));self.handle(msg,remote);break;case AMMessageType.AMMPONG:msg.port=Buf.buf_get_port(buf);msg.sndport=Buf.buf_get_int32(buf);remote.port=msg.sndport;url=addr2url(remote,true);if(self.verbose>1)self.out('receiver: Receiving Message in state '+
(self.mode&AMMode.AMO_MULTICAST?(self.links[url]&&AMState.print(self.links[url].state)):(self.links[self.url]&&AMState.print(self.links[self.url].state))));self.handle(msg,remote);break;case AMMessageType.AMMLINK:msg.port=Buf.buf_get_port(buf);msg.node=Buf.buf_get_string(buf);msg.secure=Buf.buf_get_string(buf);if(msg.secure!='')msg.secure=Sec.Port.ofString(msg.secure);msg.sndport=Buf.buf_get_int32(buf);remote.port=msg.sndport;url=addr2url(remote,true);if(self.verbose>1)self.out('receiver: Receiving Message in state '+
(self.mode&AMMode.AMO_MULTICAST?(self.links[url]&&AMState.print(self.links[url].state)):(self.links[self.url]&&AMState.print(self.links[self.url].state))));self.handle(msg,remote);break;case AMMessageType.AMMUNLINK:msg.port=Buf.buf_get_port(buf);msg.sndport=Buf.buf_get_int32(buf);remote.port=msg.sndport;url=addr2url(remote,true);self.handle(msg,remote);break;case AMMessageType.AMMCONTROL:msg.port=Buf.buf_get_port(buf);msg.data=Buf.buf_get_string(buf);self.handle(msg,remote);break;}}});sock.on('close',function(data){});});this.sock.on('listening',function(){var address=self.sock.address();if(!rcv.port)self.rcv.port=rcv.port=address.port;if(self.verbose>1)self.out('TCP receiver listening on '+addr2url(rcv));if(self.dir.ip=='*')self.dir=Aios.DIR.IP(self.rcv.port);getNetworkIP(undefined,function(err,ip){if(!err)self.rcv.address=ip;if(self.verbose)self.out('IP port '+addr2url(self.rcv)+' (proto '+self.options.proto+')');if(err)return self.out("! Unable to obtain network connection information: "+err);});});this.sock.on('error',function(err){Io.out('[AMP] TCP error: '+err);self.sock.close();});};amp.tcp.prototype.request=function(cmd,msg,snd){var self=this,buf=Buf.Buffer(),size=msg.data.length,tid=msg.tid||Comp.random.int(65536/2);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;}
if(snd==undefined)this.err('request: request=null');Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMRPCHEADDATA);Buf.buf_put_int16(buf,tid);Buf.buf_put_port(buf,this.port);Buf.buf_put_int32(buf,self.rcv.port);Buf.buf_put_int16(buf,cmd);Buf.buf_put_int32(buf,size);Buf.buf_put_buf(buf,msg,0,size);if(self.verbose>1)self.out('Send AMMRPCHEAD tid='+tid+' @'+Comp.pervasives.mtime());this.count.snd+=Buf.length(buf);this.write(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(self.verbose>1)self.out('Send AMMRPCHEADDATA tid='+tid+'. Done @'+Comp.pervasives.mtime());if(err){if(self.verbose>1)self.out('AMMRPCHEADDATA Error: '+err);if(callback)callback(Status.STD_IOERR,err);}});};amp.tcp.prototype.reply=function(cmd,msg,snd){this.request(cmd,msg,snd);}
amp.tcp.prototype.send=function(msg,snd){var buf=Buf.Buffer(),data=JSON.stringify(msg);this.LOG('snd',msg);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;}
if(snd==undefined)this.err('send: snd=null');if(this.verbose>1)this.out('amp.send: to '+addr2url(snd)+': '+data);Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMCONTROL);Buf.buf_put_port(buf,this.port);Buf.buf_put_string(buf,data);this.count.snd+=Buf.length(buf);this.write(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err)self.emit('error',err);});};amp.tcp.prototype.start=function(callback){var self=this,link,startwatch=false,s=this.secure?' (security port '+Sec.Port.toString(this.secure)+')':'';if(this.verbose>0)this.out('Starting '+(this.rcv.name?(this.rcv.name+' '):'')+addr2url(this.rcv)+
(this.mode&AMMode.AMO_UNICAST&&this.url?(' -> '+this.url):'')+' ['+AMMode.print(this.mode)+'] (proto '+this.proto+') '+s);if(this.mode&AMMode.AMO_UNICAST){if(this.url){link=this.links[this.url];link.state=this.broker?AMState.AMS_AWAIT:AMState.AMS_NOTCONNECTED;if(link.snd&&!(this.mode&AMMode.AMO_ONEWAY))
startwatch=true;if(link.snd&&(this.mode&AMMode.AMO_ONEWAY))
this.emit('route+',addr2url(link.snd,true));if(this.broker)this.pairing(link);}}
if(startwatch)this.watchdog(true);if(!this.sock){this.receiver();}
this.sock.listen(this.rcv.port,undefined);if(callback)callback();}
amp.tcp.prototype.stop=function(callback){if(this.mode&AMMode.AMO_MULTICAST)
for(var p in this.links){if(this.links[p]){this.unlink(this.links[p].snd);this.links[p].state=AMState.AMS_NOTCONNECTED;}}
else
this.links.state=AMState.AMS_NOTCONNECTED;if(this.timer)clearTimeout(this.timer),this.timer=undefined;if(this.sock)this.sock.close(),this.sock=undefined;if(callback)callback();}
amp.tcp.prototype.unlink=function(snd){var self=this,buf=Buf.Buffer(),url=snd?addr2url(snd,true):null;if(!this.links[url||this.url]||this.links[url||this.url].state!=AMState.AMS_CONNECTED)return;this.emit('route-',addr2url(snd,true));if(this.mode&AMMode.AMO_ONEWAY)return;Buf.buf_put_int16(buf,magic);Buf.buf_put_int16(buf,AMMessageType.AMMUNLINK);Buf.buf_put_port(buf,this.port);Buf.buf_put_int32(buf,this.rcv.port);if(this.mode&AMMode.AMO_UNICAST){if(snd==undefined||snd.address==undefined)snd={},snd.address=this.links[this.url].snd.address;if(snd.port==undefined)snd.port=this.links[this.url].snd.port;url=this.url;}
if(snd==undefined)this.err('unlink: no destination');if(this.verbose>1)this.out('amp.unlink: to '+addr2url(snd));this.count.snd+=Buf.length(buf);this.write(buf.data,0,Buf.length(buf),snd.port,snd.address,function(err){if(err){self.emit('error',err)}});this.links[url].state=AMState.AMS_NOTCONNECTED;if(!this.links[url].snd.connect)this.links[url].snd={};if(this.broker){this.links[url]=undefined;if(this.url)this.url=undefined;}
if(this.verbose)this.out('Unlinked '+addr2url(snd));};amp.tcp.prototype.updateLinkTable=function(snd,connect){var link;if(!snd)this.err('link: no destinataion set');url=addr2url(snd,true);if(this.broker&&!snd.port&&!this.links[url]){link=this.links[url]={state:AMState.AMS_AWAIT,tries:0,connect:connect,live:options.AMC_MAXLIVE,snd:{name:snd.address}};if(connect)link.snd.connect=true;if(this.mode&AMMode.AMO_UNICAST)this.url=url;this.pairing(link);return;}else if(this.mode&AMMode.AMO_UNICAST){if(!this.links[url])link=this.links[url]={state:AMState.AMS_NOTCONNECTED};else link=this.links[url];if(snd!=undefined&&snd.address!=undefined&&snd.port!=undefined&&!link.snd)
link.snd=snd;if(snd!=undefined&&snd.address!=undefined&&snd.port!=undefined&&snd.port!='*'&&link.snd.address==undefined)
link.snd.address=snd.address;if(snd!=undefined&&snd.port!=undefined&&link.snd.port==undefined)
link.snd.port=snd.port;if(connect)link.snd.connect=true;if((link.state&&link.state!=AMState.AMS_NOTCONNECTED&&link.state!=AMState.AMS_PAIRED)||this.mode&AMMode.AMO_ONEWAY)return;if(typeof link.snd.port=='string')return;if(snd==undefined||snd.address==undefined)snd={},snd.address=link.snd.address;if(snd.port==undefined)snd.port=link.snd.port;this.url=url;}else{url=addr2url(snd,true);if(!this.links[url]||!this.links[url].snd.address)
link=this.links[url]={snd:snd,state:AMState.AMS_NOTCONNECTED,tries:0,connect:connect,live:options.AMC_MAXLIVE};if(!this.inwatchdog&&connect){this.watchdog(true);return;}}
return snd;}
amp.tcp.prototype.watchdog=function(run,immed){var self=this;if(this.timer)clearTimeout(self.timer),this.timer=undefined;if(run)this.timer=setTimeout(function(){var con,to,tokens;if(!self.timer||!self.sock||self.inwatchdog)return;self.timer=undefined;self.inwatchdog=true;function handle(obj,url){if(self.verbose>1)self.out('Watchdog: handle link '+
url+(obj.snd?('('+obj2url(obj.snd)+')'):'')+' in state '+AMState.print(obj.state)+
(obj.tries!=undefined?('[#'+obj.tries+']'):''));switch(obj.state){case AMState.AMS_CONNECTED:if(obj.live==0){if(self.verbose>0)
self.out('(TCP) Endpoint '+addr2url(obj.snd)+' not responding, propably dead. Unlinking...');if(self.mode&AMMode.AMO_MULTICAST)self.unlink(obj.snd);else self.unlink();obj.state=AMState.AMS_NOTCONNECTED;if(!obj.snd.connect)obj.snd={};if(self.broker){self.watchdog(true);if(self.links['*']){self.links['*'].state=AMState.AMS_RENDEZVOUS;}}}else{obj.tries=0;obj.live--;self.watchdog(true);if(self.mode&AMMode.AMO_MULTICAST)self.ping(obj.snd);else self.ping();}
break;case AMState.AMS_NOTCONNECTED:if(!obj.snd)return;if(obj.snd.port&&typeof obj.snd.port=='string'){tokens=obj.snd.port.split('-');if(tokens.length==2)obj.range=[Number(tokens[0]),Number(tokens[1])];}
if(obj.range){obj.snd.port=Comp.random.interval(obj.range[0],obj.range[1]);if(self.verbose>0)
self.out('Trying link to '+addr2url(obj.snd));if(self.mode&AMMode.AMO_MULTICAST)self.link(obj.snd);else self.link();obj.tries++;if(obj.tries<options.TRIES)self.watchdog(true);else{obj.snd={},obj.tries=0,obj.range=undefined;}}else if(obj.snd.port&&typeof obj.snd.port=='number'){if(self.verbose>0&&obj.tries==0)
self.out('(TCP) Trying link to '+addr2url(obj.snd));if(self.mode&AMMode.AMO_MULTICAST)self.link(obj.snd);else self.link();obj.tries++;if(obj.tries<options.TRIES)self.watchdog(true);else{self.out('(TCP) Giving up to link '+addr2url(obj.snd));self.emit('error','link',addr2url(obj.snd,true));obj.snd={},obj.tries=0;}}
break;case AMState.AMS_RENDEZVOUS:obj.next=Aios.time()+options.REGTMO;obj.interval=options.REGTMO;self.send({type:'register',name:self.rcv.name,linfo:self.rcv},self.broker,function(){});self.watchdog(true);break;case AMState.AMS_REGISTERED:if(obj.snd&&obj.snd.name&&obj.tries<options.TRIES){obj.tries++;self.send({type:'pair',from:self.rcv.name,to:obj.snd.name},self.broker,function(){});}else if(options.REGTMO&&Aios.time()>obj.next){obj.interval*=2;obj.interval=Math.min(obj.interval,options.REGTMO*8);obj.next=Aios.time()+obj.interval;self.send({type:'register',name:self.rcv.name,linfo:self.rcv},self.broker,function(){});}
self.watchdog(true);break;}}
for(var p in self.links)if(self.links[p])handle(self.links[p],p);self.inwatchdog=false;},immed?0:options.TIMER);};amp.tcp.prototype.write=function(data,off,len,port,address,cb){var self=this;if(off!=0)this.err('tpc.socket.write: buffer offset <> 0');var client=new net.Socket();client.on('error',function(e){if(cb)cb(e.toString())})
client.connect(port,address,function(){client.write(data,function(){client.destroy();if(cb)cb();});});}};BundleModuleCode['jam/ampStream']=function(module,exports){var Io=Require('com/io');var Lz=Require('os/lz-string');var Comp=Require('com/compat');var Buf=Require('dos/buf');var Net=Require('dos/network');var Command=Net.Command;var Status=Net.Status;var current=none;var Aios=none;var CBL=Require('com/cbl');var COM=Require('jam/ampCOM'),AMMode=COM.AMMode,AMMessageType=COM.AMMessageType,AMState=COM.AMState,amp=COM.amp,options=COM.options,url2addr=COM.url2addr,addr2url=COM.addr2url,addrequal=COM.addrequal,resolve=COM.resolve,ipequal=COM.ipequal,getNetworkIP=COM.getNetworkIP;module.exports.current=function(module){current=module.current;Aios=module;};amp.stream=function(options){var self=this;options=checkOptions(options,{});this.options=options;this.verbose=checkOption(options.verbose,0);this.dir=options.dir;this.mode=AMMode.AMO_UNICAST|AMMode.AMO_STATIC|(options.mode=='object'?AMMode.AMO_OBJECT:AMMode.AMO_BUFFER);this.port=options.port||Net.uniqport();this.id=Net.Print.port(this.port);this.links={state:AMState.AMS_NOTCONNECTED};this.sock=options.sock;this.dlimit=options.dlimit||512;this.out=function(msg){Aios.print('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] '+msg);}
this.state=AMState.AMS_INIT;this.events=[];this.logs=[];this.logging=options.logging||false;if(this.logging){setInterval(function(){self.LOG('print')},5000);}
if(this.mode&AMMode.AMO_OBJECT)
this.receiver=this.receiverObj,this.request=this.requestObj;};amp.stream.prototype.LOG=amp.udp.prototype.LOG;amp.stream.prototype.emit=amp.udp.prototype.emit;amp.stream.prototype.init=amp.udp.prototype.init;amp.stream.prototype.on=amp.udp.prototype.on;amp.stream.prototype.receiver=function(callback,rcv){var self=this;if(rcv==undefined||rcv.address==undefined)rcv={},rcv.address=this.rcv.address;if(rcv.port==undefined)rcv,port=this.rcv.port;var cache=Comp.hashtbl.create();var buf=Buf.Buffer();var sock=this.sock;sock.on('message',function(message,remote){var handler,dfrags,dlist,msgtyp,tid,ipport,discard,off,size,thisnum,transaction,more,port,ip,data,msg;handler={};Buf.buf_init(buf);Buf.buf_of_str(buf,message);self.count.rcv+=message.length;if(message.length>=12){msgtyp=Buf.buf_get_int16(buf);discard=false;if(self.verbose>1)
self.out('receiver: Receiving Message  ['+message.length+'] '+AMMessageType.print(msgtyp));switch(msgtyp){case AMMessageType.AMMRPCHEAD:tid=Buf.buf_get_int16(buf);port=Buf.buf_get_port(buf);handler.tid=tid;handler.remote=remote.address+':'+Buf.buf_get_int16(buf);handler.cmd=Buf.buf_get_int16(buf);handler.size=Buf.buf_get_int16(buf);handler.frags=Buf.buf_get_int16(buf);handler.buf=Buf.Buffer();if(handler.size>0){dlist=Comp.array.range(0,handler.frags-1);Comp.hashtbl.add(cache,handler.tid,[handler,dlist,1000]);}else{callback(handler);}
break;case AMMessageType.AMMRPCDATA:tid=Buf.buf_get_int16(buf);port=Buf.buf_get_port(buf);off=Buf.buf_get_int32(buf);size=Buf.buf_get_int16(buf);more=Buf.buf_get_int16(buf);thisnum=off/self.dlimit;transaction=Comp.hashtbl.find(cache,tid);if(transaction!=undefined){handler=transaction[0];if(self.verbose>1)
self.out('receiver: adding data num='+
thisnum+' off='+off+' size='+size+' dlist='+transaction[1]);Buf.buf_get_buf(buf,handler.buf,off,size);transaction[1]=Comp.array.filter(transaction[1],function(num){return(num!=thisnum)});if(Comp.array.empty(transaction[1])){if(self.verbose>1)self.out('[AMP] receiver: finalize '+addr2url(remote));callback(handler);Comp.hashtbl.remove(cache,tid);}
handler=undefined;}
break;}}});};amp.stream.prototype.receiverObj=function(callback,rcv){this.sock.on('message',function(obj){var handler={cmd:obj.cmd,buf:Buf.Buffer(obj.msg)};self.count.rcv+=obj.msg.length;if(callback)callback(handler);});}
amp.stream.prototype.request=amp.udp.prototype.request;amp.stream.prototype.requestObj=function(cmd,msg,callback){this.count.snd+=msg.data.length;this.sock.send({cmd:cmd,msg:msg.data});if(callback)callback()}
amp.stream.prototype.start=function(callback){if(this.verbose)this.out('Stream link '+Aios.DIR.print(this.dir)+' started.');this.links.state=AMState.AMS_CONNECTED;if(callback)callback()};amp.stream.prototype.stop=function(callback){if(callback)callback()};amp.stream.prototype.status=amp.udp.prototype.status;};BundleModuleCode['jam/ampHTTP']=function(module,exports){var Io=Require('com/io');var Lz=Require('os/lz-string');var Comp=Require('com/compat');var Buf=Require('dos/buf');var Net=Require('dos/network');var Command=Net.Command;var Status=Net.Status;var current=none;var Aios=none;var CBL=Require('com/cbl');var Bas64=Require('os/base64');var Sec=Require('jam/security')
var JSONfn=Require('jam/jsonfn')
var options={version:"1.14.7"}
var COM=Require('jam/ampCOM'),AMMode=COM.AMMode,AMMessageType=COM.AMMessageType,AMState=COM.AMState,amp=COM.amp,options=COM.options,url2addr=COM.url2addr,addr2url=COM.addr2url,addrequal=COM.addrequal,resolve=COM.resolve,ipequal=COM.ipequal,isLocal=COM.isLocal,getNetworkIP=COM.getNetworkIP
magic=COM.options.magic;var debug=false;module.exports.current=function(module){current=module.current;Aios=module;};function parseQueryString(url){var queryString=url.substring(url.indexOf('?')+1);if(queryString==url)return[];var params={},queries,temp,i,l;queries=queryString.split("&");for(i=0,l=queries.length;i<l;i++){temp=queries[i].split('=');if(temp[1]==undefined)temp[1]='true';params[temp[0]]=temp[1].replace('%20',' ');}
return params;}
function formatQueryString(msg){var path='/?';path+="magic="+msg.magic;path+="&type="+AMMessageType.print(msg.type);if(msg.cmd)path+='&cmd='+msg.cmd;if(msg.tid)path+='&tid='+msg.tid;if(msg.port)path+='&port='+Net.port_to_str(msg.port);if(msg.timeout)path+='&timeout='+msg.timeout;if(msg.node)path+='&node='+msg.node.replace(' ','%20');if(msg.index)path+='&index='+msg.index;if(msg.secure)path+='&secure='+(msg.secure.length==8?Net.port_to_str(msg.secure):msg.secure);return path;}
function msg2JSON(msg){if(msg.port)msg.port=Net.port_to_str(msg.port);if(msg.msg&&msg.msg.length)Comp.array.iter(msg.msg,function(msg){if(msg.port)msg.port=Net.port_to_str(msg.port);});return JSONfn.stringify(msg);}
function JSON2msg(data){var msg=JSONfn.parse(data);if(msg.port)msg.port=Net.port_of_str(msg.port);if(msg.msg&&msg.msg.length)Comp.array.iter(msg.msg,function(msg){if(msg.port)msg.port=Net.port_of_str(msg.port);});return msg;}
function getData(data){if(data==undefined)return undefined;else if(data.val!='')return data.val;else return data.children.toString();}
function is_error(data,err){if(data==undefined)return true;if(err==undefined)
return(data.length>0&&Comp.string.get(data,0)=='E');else
return(Comp.string.equal(data,err));};var http=Require('http');amp.http=function(options){var self=this;this.proto='http';this.options=checkOptions(options,{});this.verbose=checkOption(this.options.verbose,0);this.dir=options.dir;this.rcv=options.rcv;this.mode=AMMode.AMO_MULTICAST;this.node=options.node;if(options.nodeid)this.node={id:options.nodeid};if(options.rcv&&options.rcv.address!='*'&&options.rcv.port)this.mode|=AMMode.AMO_SERVER;else this.mode|=AMMode.AMO_CLIENT;this.options.keepalive=true;this.secure=this.options.secure;this.port=options.port||Net.uniqport();this.id=Net.Print.port(this.port);this.out=function(msg,async){(async?Aios.logAsync:Aios.log)
('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] '+msg);}
this.debug=function(msg){Aios.logAsync
('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] '+msg);}
this.err=function(msg,async){(async?Aios.logAsync:Aios.log)
('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] Error: '+msg);throw'AMP';}
this.events=[];this.links={};this.count={rcv:0,snd:0,lnk:0,png:0};if(options.snd){url=addr2url(options.snd,true);this.links[url]={snd:options.snd,tries:0,state:AMState.AMS_NOTCONNECTED,live:options.AMC_MAXLIVE};}
this.collector=undefined;this.logs=[];this.logging=options.logging||false;if(this.logging){setInterval(function(){self.LOG('print')},5000);}
this.index=0;};amp.http.prototype.LOG=amp.man.prototype.LOG;amp.http.prototype.checkState=amp.man.prototype.checkState;amp.http.prototype.config=amp.man.prototype.config;amp.http.prototype.emit=amp.man.prototype.emit;amp.http.prototype.on=amp.man.prototype.on;amp.http.prototype.handle=amp.man.prototype.handle;amp.http.prototype.status=amp.man.prototype.status;amp.http.prototype.ack=function(snd,status){this.response(snd,{type:AMMessageType.AMMACK,status:status||"EOK",port:this.port,node:this.node?this.node.id:'*'});}
amp.http.prototype.cleanup=function(url,keep){var obj=this.links[url];if(!obj)return;obj.state=AMState.AMS_NOTCONNECTED
if(obj.collect)clearTimeout(obj.collect),obj.collect=undefined;if(obj.collecting)this.response(obj.collecting,{status:'ENOENTRY'}),obj.collecting=undefined;if(!keep){obj.snd={};this.links[url]=undefined;}}
amp.http.prototype.collect=function(snd){var self=this,url=addr2url(snd,true),msg={type:AMMessageType.AMMCOLLECT,port:this.port,index:this.index++,magic:magic};if(this.links[url]&&this.links[url].state==AMState.AMS_CONNECTED)
this.send(snd,msg,function(reply){var err=is_error(reply);if(err)return;if(reply.msg)Comp.array.iter(reply.msg,function(msg){self.handle(msg,snd);});if(!self.links[url])return;self.links[url].collect=setTimeout(function(){self.collect(snd);},0);});}
amp.http.prototype.collecting=function(msg,remote,response){var url;if(this.verbose>2)this.debug('handle AMMCOLLECT from '+addr2url(remote));url=addr2url(remote,true);if(this.links[url]&&this.links[url].msgqueue&&this.links[url].msgqueue.length){this.response(response,{msg:this.links[url].msgqueue});this.links[url].msgqueue=[];}
else if(this.links[url])this.links[url].collecting=response;else this.response(response,{status:'ENOENTRY'});}
amp.http.prototype.get=function(snd,path,callback){var body,req,self=this;if(this.verbose>2)this.debug('get '+addr2url(snd)+path);this.count.snd=this.count.snd+path.length;if(!http.xhr){req=http.request({host:snd.address,port:snd.port,path:path,method:'GET',keepAlive:this.options.keepalive,headers:{}},function(res){if(self.verbose>2)self.debug('got '+addr2url(snd)+path);if(res.setEncoding!=null)res.setEncoding('utf8');body='';res.on('data',function(chunk){body=body+chunk;});res.once('end',function(){self.count.rcv+=body.length;if(callback)callback(body);});});req.once('error',function(err){if(self.verbose)self.out('Warning: request to '+addr2url(snd)+' '+path+' failed: '+err,true);self.emit('error',err);if(callback)callback();});req.end();}else{http.request({host:snd.address,port:snd.port,path:path,proto:'http',method:'GET',headers:{}},function(err,xhr,body){if(err){if(self.verbose)self.out('Warning: request to '+addr2url(snd)+' '+path+' failed: '+err,true);self.emit('error',err);if(callback)callback();}else{self.count.rcv+=body.length;if(callback)callback(body);}});}};amp.http.prototype.init=function(callback){if(callback)callback();};amp.http.prototype.link=function(snd,connect,key,response){var self=this,msg,url;if(this.verbose>1)this.out('amp.link: to '+addr2url(snd),true);if(!snd)this.err(true,'link: no destinataion set in MULTICAST mode');if(snd.parameter&&snd.parameter.secure)key=snd.parameter.secure;url=addr2url(snd,true);if(!this.links[url]||!this.links[url].snd.address){if(connect)snd.connect=true;this.links[url]={snd:snd,state:AMState.AMS_NOTCONNECTED,tries:0,connect:connect,live:options.AMC_MAXLIVE};}
if(!this.inwatchdog&&connect)
return this.watchdog(true);msg={type:AMMessageType.AMMLINK,port:this.port,node:this.node?this.node.id:'*',index:this.index++,magic:magic,remote:snd.address,};if(key)msg.secure=key;this.count.lnk++;if(response)
this.response(response,msg);else this.send(snd,msg,function(reply){if(is_error(reply))return;if((self.mode&AMMode.AMO_CLIENT)&&!self.links[url].collect){self.links[url].collect=setTimeout(function(){self.collect(snd);},0);}
self.handle(reply,snd);});};amp.http.prototype.ping=function(snd,response){var self=this,msg={};msg.type=AMMessageType.AMMPING;msg.port=this.port;msg.index=this.index++;msg.magic=magic;if(this.verbose>1)this.debug('amp.ping'+(response?'in response':'')+': to '+addr2url(snd));this.count.png++;if(response)
this.response(response,msg);else this.send(snd,msg,function(reply){if(is_error(reply))return;self.handle(reply,snd);});}
amp.http.prototype.pong=function(snd,response){var self=this,msg={};msg.type=AMMessageType.AMMPONG;msg.port=this.port;msg.index=this.index++;msg.magic=magic;if(this.verbose>1)this.debug('amp.pong '+(response?'in response':'')+': to '+addr2url(snd));this.count.png++;if(response)
this.response(response,msg);else this.send(snd,msg,function(reply){if(is_error(reply)){self.emit('error',reply);}});}
amp.http.prototype.put=function(snd,path,data){var self=this,req,body;this.count.snd=this.count.snd+path.length+data.length;if(!http.xhr){req=http.request({host:snd.address,port:snd.port,path:path,method:'POST',keepAlive:this.options.keepalive,headers:{'Content-Type':'application/x-www-form-urlencoded','Content-Length':data.length}},function(res){if(res.setEncoding!=null)res.setEncoding('utf8');res.once('data',function(chunk){});});req.once('error',function(err){self.out('Warning: request to '+addr2url(snd)+' failed: '+err,true);self.emit('error',err);});req.write(data);req.end();}else{http.request({host:snd.address,port:snd.port,path:path,method:'POST',body:data,keepAlive:this.options.keepalive,headers:{'Content-Type':'application/x-www-form-urlencoded','Content-Length':data.length}},function(err,xhr,body){if(err){if(self.verbose)self.out('Warning: request to '+addr2url(snd)+' failed: '+err,true);self.emit('error',err);}})}};amp.http.prototype.receiver=function(callback,rcv){var self=this;if(callback)this.callback=callback;if(this.mode&AMMode.AMO_SERVER){if(rcv==undefined||rcv.address==undefined)rcv={},rcv.address=this.rcv.address;if(rcv.port==undefined)rcv.port=this.rcv.port;this.server=http.createServer(function(request,response){if(parseQueryString(request.url).length==0)return response.end('EINVALID');var i,body,msg=parseQueryString(request.url),remote={address:request.connection.remoteAddress.replace(/^::ffff:/,'').replace(/^::1/,'localhost'),port:'['+msg.port.replace(/:/g,'')+']'};if(self.verbose>2)
console.log(request.method,request.url,msg,addr2url(remote),url2addr(addr2url(remote)));if(msg.magic!=magic)return;self.count.rcv+=1;msg.type=AMMessageType[msg.type];if(msg.secure)msg.secure=Net.port_of_str(msg.secure);if(debug)console.log(Io.Time(),msg)
response.origin=request.headers.origin||request.headers.Origin;Comp.string.match(request.method,[['GET',function(){if(msg.type==AMMessageType.AMMCOLLECT)
self.collecting(msg,remote,response);else
self.handle(msg,remote,response);}],['POST',function(){body='';request.on('data',function(chunk){body=body+chunk;});request.on('end',function(){msg.data=Buffer(body,'hex');self.count.rcv+=msg.data.length;if(msg.cmd)msg.cmd=Number(msg.cmd);self.handle(msg,remote,response);});}]])});this.server.on("connection",function(socket){socket.setNoDelay(true);});this.server.on("error",function(err){self.out('Warning: receiver failed: '+err,true);if(err)self.err(true,err);});this.server.listen(rcv.port,function(err){if(!err)getNetworkIP(undefined,function(err,ip){if(!err)self.rcv.address=isLocal(ip)?options.localhost:ip;if(self.verbose)self.out('IP port '+addr2url(self.rcv)+' (proto '+self.options.proto+')',true);if(err)return self.out("! Unable to obtain network connection information: "+err,true);});if(callback)callback(err);});}
if(this.mode&AMMode.AMO_CLIENT){if(callback)this.callback=callback;}}
amp.http.prototype.reply=function(cmd,msg,snd){this.request(cmd,msg,snd);}
amp.http.prototype.response=function(response,msg){var data=msg2JSON(msg),header;if(response.origin!=undefined)
header={'Access-Control-Allow-Origin':response.origin,'Access-Control-Allow-Credentials':'true','Content-Type':'text/plain'};else
header={'Content-Type':'text/plain'};if(this.options.keepalive)header["Connection"]="keep-alive";response.writeHead(200,header);response.write(data);if(debug)console.log(Io.Time(),msg)
response.end();}
amp.http.prototype.request=function(cmd,msg,snd){var self=this,req={},size=msg.data.length,tid=msg.tid||Comp.random.int(65536/2);if(snd==undefined)this.err(true,'request: snd=null');req.type=AMMessageType.AMMRPC;req.tid=tid;req.port=this.port;req.cmd=cmd;req.size=size;req.magic=magic;req.data=msg.data;this.send(snd,req);}
amp.http.prototype.scan=function(snd,response,callback){var self=this,msg={};msg.type=response?AMMessageType.AMMACK:AMMessageType.AMMSCAN;msg.port=this.port;msg.magic=magic;if(response)msg.info=snd.info;if(this.verbose>1&&snd)this.debug('amp.scan: to '+addr2url(snd));if(response)
this.response(response,msg);else
this.send(snd,msg,function(reply){callback(reply)});}
amp.http.prototype.send=function(snd,msg,callback){var path,url,body,self=this;path=formatQueryString(msg);if(typeof snd.port=='string'){url=addr2url(snd,true);if(this.links[url]){if(!this.links[url].msgqueue)this.links[url].msgqueue=[];if(this.links[url].collecting){if(this.verbose>1)this.debug('REPLY msg '+AMMessageType.print(msg.type)+' to '+url);this.response(this.links[url].collecting,{msg:[msg]});this.links[url].collecting=undefined;}else{if(this.verbose>1)this.debug('QUEUE msg '+AMMessageType.print(msg.type)+' for '+url);this.links[url].msgqueue.push(msg);}}}else if(msg.data!=undefined){body=msg.data.toString('hex');this.put(snd,path,body,function(body){if(is_error(body))self.emit('error',body);else if(!is_status(body))self.emit('error','EINVALID');});}else{this.get(snd,path,function(body){var xml,i,reply;if(!body||is_error(body)){self.emit('error','EINVALID');}else{reply=JSON2msg(body);}
if(callback)callback(reply);});}}
amp.http.prototype.start=function(callback){var self=this,s=this.secure?' (security port '+Sec.Port.toString(this.secure)+')':'';if(this.verbose>0&&this.mode&AMMode.AMO_SERVER)
this.out('Starting '+addr2url(this.rcv)+' ['+AMMode.print(this.mode)+'] (proto '+this.proto+')'+s);if(this.verbose>0&&this.mode&AMMode.AMO_CLIENT)
this.out('Starting ['+AMMode.print(this.mode)+'] (proto http)');this.watchdog(true);if(!this.server&&this.mode&AMMode.AMO_SERVER){this.receiver();}
if(callback)callback();}
amp.http.prototype.stop=function(callback){if(this.links)for(var p in this.links){if(this.links[p]){if(this.links[p].collect)clearTimeout(this.links[p].collect),this.links[p].collect=undefined;this.unlink(this.links[p].snd);if(this.links[p])this.links[p].state=AMState.AMS_NOTCONNECTED;}}
if(this.verbose>0&&this.mode&AMMode.AMO_SERVER)
this.out('Stopping '+addr2url(this.rcv)+' ['+AMMode.print(this.mode)+'] (proto '+this.proto+')'+s);if(this.verbose>0&&this.mode&AMMode.AMO_CLIENT)
this.out('Stopping ['+AMMode.print(this.mode)+'] (proto http)');if(this.timer)clearTimeout(this.timer),this.timer=undefined;if(this.server)this.server.close(),this.server=undefined;if(callback)callback();}
amp.http.prototype.unlink=function(snd){var self=this,msg,url=snd?addr2url(snd,true):null;if(this.mode&AMMode.AMO_MULTICAST){if(!this.links[url]||this.links[url].state!=AMState.AMS_CONNECTED)return;}else{if(this.links.state!=AMState.AMS_CONNECTED)return;}
msg={type:AMMessageType.AMMUNLINK,port:this.port,node:this.node?this.node.id:'*',index:this.index++,magic:magic};this.send(snd,msg,function(reply){if(reply){}});this.emit('route-',addr2url(snd,true));if(this.mode&AMMode.AMO_MULTICAST){this.links[url].state=AMState.AMS_NOTCONNECTED;if(!this.links[url].snd.connect)this.links[url].snd={};}else{this.links.state=AMState.AMS_NOTCONNECTED;if(!this.links.snd.connect)this.links.snd={};}
this.cleanup(url);}
amp.http.prototype.watchdog=function(run,immedOrDelay){var self=this;if(this.timer)clearTimeout(self.timer),this.timer=undefined;if(run)self.timer=setTimeout(function(){if(!self.timer||self.inwatchdog)return;self.timer=undefined;self.inwatchdog=true;function handle(obj,url){if(self.verbose>1)self.debug('Watchdog: handle link ('+url+') '+
(obj.snd?addr2url(obj.snd):'')+' in state '+
AMState.print(obj.state)+' live '+obj.live,true);switch(obj.state){case AMState.AMS_CONNECTED:if(obj.live==0){if(self.verbose>0)
self.out('Endpoint '+addr2url(obj.snd)+' not responding, propably dead. Unlinking...',true);obj.state=AMState.AMS_NOTCONNECTED;self.emit('route-',addr2url(obj.snd,true));self.cleanup(url,obj.snd.connect);if(obj.snd.connect)self.watchdog(true,2000);}else{obj.tries=0;obj.live--;self.watchdog(true);if(self.mode&AMMode.AMO_MULTICAST)self.ping(obj.snd);else self.ping();}
break;case AMState.AMS_NOTCONNECTED:case AMState.AMS_PAIRED:if(obj.snd.port&&typeof obj.snd.port=='number'){if(self.verbose>0&&obj.tries==0)
self.out('Trying link to '+addr2url(obj.snd),true);self.link(obj.snd);obj.tries++;if(obj.tries<options.TRIES)self.watchdog(true);else{self.out('Giving up to link '+addr2url(obj.snd),true);self.emit('error','link',addr2url(obj.snd));obj.snd={},obj.tries=0;}}
break;case AMState.AMS_RENDEZVOUS:obj.send({type:'register',name:self.rcv.name,linfo:self.rcv},self.broker,function(){});self.watchdog(true);break;case AMState.AMS_REGISTERED:if(obj.tries<options.TRIES&&obj.snd.name){obj.tries++;self.send({type:'pair',from:self.rcv.name,to:obj.snd.name},self.broker,function(){});}
if(obj.tries<options.TRIES)self.watchdog(true);break;}}
for(var p in self.links)if(self.links[p])handle(self.links[p],p);self.inwatchdog=false;},immedOrDelay==true?0:immedOrDelay||options.TIMER);};};BundleModuleCode['jam/ampHTTPS']=function(module,exports){var Io=Require('com/io');var Lz=Require('os/lz-string');var Comp=Require('com/compat');var Buf=Require('dos/buf');var Net=Require('dos/network');var Command=Net.Command;var Status=Net.Status;var current=none;var Aios=none;var CBL=Require('com/cbl');var Bas64=Require('os/base64');var Sec=Require('jam/security')
var JSONfn=Require('jam/jsonfn')
var options={version:"1.14.7",}
var COM=Require('jam/ampCOM'),AMMode=COM.AMMode,AMMessageType=COM.AMMessageType,AMState=COM.AMState,amp=COM.amp,options=COM.options,url2addr=COM.url2addr,addr2url=COM.addr2url,addrequal=COM.addrequal,resolve=COM.resolve,ipequal=COM.ipequal,isLocal=COM.isLocal,getNetworkIP=COM.getNetworkIP,pem=COM.options.pem,magic=COM.options.magic;var debug=false;module.exports.current=function(module){current=module.current;Aios=module;};function parseQueryString(url){var queryString=url.substring(url.indexOf('?')+1);if(queryString==url)return[];var params={},queries,temp,i,l;queries=queryString.split("&");for(i=0,l=queries.length;i<l;i++){temp=queries[i].split('=');if(temp[1]==undefined)temp[1]='true';params[temp[0]]=temp[1].replace('%20',' ');}
return params;}
function formatQueryString(msg){var path='/?';path+="magic="+msg.magic;path+="&type="+AMMessageType.print(msg.type);if(msg.cmd)path+='&cmd='+msg.cmd;if(msg.tid)path+='&tid='+msg.tid;if(msg.port)path+='&port='+Net.port_to_str(msg.port);if(msg.timeout)path+='&timeout='+msg.timeout;if(msg.node)path+='&node='+msg.node.replace(' ','%20');if(msg.index)path+='&index='+msg.index;if(msg.secure)path+='&secure='+(msg.secure.length==8?Net.port_to_str(msg.secure):msg.secure);return path;}
function msg2JSON(msg){if(msg.port)msg.port=Net.port_to_str(msg.port);if(msg.msg&&msg.msg.length)Comp.array.iter(msg.msg,function(msg){if(msg.port)msg.port=Net.port_to_str(msg.port);});return JSONfn.stringify(msg);}
function JSON2msg(data){var msg=JSONfn.parse(data);if(msg.port)msg.port=Net.port_of_str(msg.port);if(msg.msg&&msg.msg.length)Comp.array.iter(msg.msg,function(msg){if(msg.port)msg.port=Net.port_of_str(msg.port);});return msg;}
function getData(data){if(data==undefined)return undefined;else if(data.val!='')return data.val;else return data.children.toString();}
function is_error(data,err){if(data==undefined)return true;if(err==undefined)
return(data.length>0&&Comp.string.get(data,0)=='E');else
return(Comp.string.equal(data,err));};var https;var http=Require('http');amp.https=function(options){var self=this;this.proto='http';this.options=checkOptions(options,{});this.verbose=checkOption(this.options.verbose,0);if(global.TARGET!='browser'&&!https)try{https=require('https');}catch(e){throw'amp.https: no https/crypto support ('+e+')';}
this.dir=options.dir;this.rcv=options.rcv;this.mode=AMMode.AMO_MULTICAST;this.node=options.node;if(options.rcv&&options.rcv.address!='*'&&options.rcv.port)this.mode|=AMMode.AMO_SERVER;else this.mode|=AMMode.AMO_CLIENT;if(!options.pem)this.options.pem=pem;if((this.mode&AMMode.AMO_CLIENT)==0&&(!this.options.pem||!this.options.pem.key||!this.options.pem.cert))
throw"amp.https: no pem certificate and key provided like pem:{key,cert}";this.options.keepalive=true;this.secure=this.options.secure;this.port=options.port||Net.uniqport();this.id=Net.Print.port(this.port);this.out=function(msg,async){(async?Aios.logAsync:Aios.log)
('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] '+msg);}
this.debug=function(msg){Aios.logAsync
('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] '+msg);}
this.err=function(msg,async){(async?Aios.logAsync:Aios.log)
('[AMP '+Net.Print.port(self.port)+
(self.dir?(' '+Aios.DIR.print(self.dir)):'')+'] Error: '+msg);throw'AMP';}
this.events=[];this.links={};this.count={rcv:0,snd:0,lnk:0,png:0};if(options.snd){url=addr2url(options.snd,true);this.links[url]={snd:options.snd,tries:0,state:AMState.AMS_NOTCONNECTED,live:options.AMC_MAXLIVE};}
this.collector=undefined;this.logs=[];this.logging=options.logging||false;if(this.logging){setInterval(function(){self.LOG('print')},5000);}
this.index=0;};amp.https.prototype.LOG=amp.man.prototype.LOG;amp.https.prototype.checkState=amp.man.prototype.checkState;amp.https.prototype.config=amp.man.prototype.config;amp.https.prototype.emit=amp.man.prototype.emit;amp.https.prototype.on=amp.man.prototype.on;amp.https.prototype.handle=amp.man.prototype.handle;amp.https.prototype.status=amp.man.prototype.status;amp.https.prototype.ack=function(snd,status){this.response(snd,{type:AMMessageType.AMMACK,status:status||"EOK",port:this.port,node:this.node?this.node.id:'*'});}
amp.https.prototype.cleanup=function(url,keep){var obj=this.links[url];if(!obj)return;obj.state=AMState.AMS_NOTCONNECTED
if(obj.collect)clearTimeout(obj.collect),obj.collect=undefined;if(obj.collecting)this.response(obj.collecting,{status:'ENOENTRY'}),obj.collecting=undefined;if(!keep){obj.snd={};this.links[url]=undefined;}}
amp.https.prototype.collect=function(snd){var self=this,url=addr2url(snd,true),msg={type:AMMessageType.AMMCOLLECT,port:this.port,index:this.index++,magic:magic};if(this.links[url]&&this.links[url].state==AMState.AMS_CONNECTED)
this.send(snd,msg,function(reply){var err=is_error(reply);if(err)return;if(reply.msg)Comp.array.iter(reply.msg,function(msg){self.handle(msg,snd);});if(!self.links[url])return;self.links[url].collect=setTimeout(function(){self.collect(snd);},0);});}
amp.https.prototype.collecting=function(msg,remote,response){var url;if(this.verbose>2)this.debug('handle AMMCOLLECT from '+addr2url(remote));url=addr2url(remote,true);if(this.links[url]&&this.links[url].msgqueue&&this.links[url].msgqueue.length){this.response(response,{msg:this.links[url].msgqueue});this.links[url].msgqueue=[];}
else if(this.links[url])this.links[url].collecting=response;else this.response(response,{status:'ENOENTRY'});}
amp.https.prototype.get=function(snd,path,callback){var body,req,self=this;if(this.verbose>2)this.debug('get '+addr2url(snd)+path);this.count.snd=this.count.snd+path.length;if(https){req=https.request({host:snd.address,port:snd.port,path:path,method:'GET',keepAlive:this.options.keepalive,headers:{}},function(res){if(self.verbose>2)self.debug('got '+addr2url(snd)+path);if(res.setEncoding!=null)res.setEncoding('utf8');body='';res.on('data',function(chunk){body=body+chunk;});res.once('end',function(){self.count.rcv+=body.length;if(callback)callback(body);});});req.once('error',function(err){if(self.verbose)self.out('Warning: request to '+addr2url(snd)+' '+path+' failed: '+err,true);self.emit('error',err);if(callback)callback();});req.end();}else{http.request({host:snd.address,port:snd.port,path:path,proto:'https',method:'GET',headers:{}},function(err,xhr,body){if(err){if(self.verbose)self.out('Warning: request to '+addr2url(snd)+' '+path+' failed: '+err,true);self.emit('error',err);if(callback)callback();}else{self.count.rcv+=body.length;if(callback)callback(body);}});}};amp.https.prototype.init=function(callback){if(callback)callback();};amp.https.prototype.link=function(snd,connect,key,response){var self=this,msg,url;if(this.verbose>1)this.debug('amp.link: to '+addr2url(snd));if(!snd)this.err('link: no destinataion set in MULTICAST mode');if(snd.parameter&&snd.parameter.secure)key=snd.parameter.secure;url=addr2url(snd,true);if(!this.links[url]||!this.links[url].snd.address){if(connect)snd.connect=true;this.links[url]={snd:snd,state:AMState.AMS_NOTCONNECTED,tries:0,connect:connect,live:options.AMC_MAXLIVE};}
if(!this.inwatchdog&&connect)
return this.watchdog(true);msg={type:AMMessageType.AMMLINK,port:this.port,node:this.node?this.node.id:'*',index:this.index++,magic:magic,remote:snd.address,};if(key)msg.secure=key;this.count.lnk++;if(response)
this.response(response,msg);else this.send(snd,msg,function(reply){if(is_error(reply))return;if((self.mode&AMMode.AMO_CLIENT)&&!self.links[url].collect){self.links[url].collect=setTimeout(function(){self.collect(snd);},0);}
self.handle(reply,snd);});};amp.https.prototype.ping=function(snd,response){var self=this,msg={};msg.type=AMMessageType.AMMPING;msg.port=this.port;msg.index=this.index++;msg.magic=magic;if(this.verbose>1)this.debug('amp.ping'+(response?'in response':'')+': to '+addr2url(snd));this.count.png++;if(response)
this.response(response,msg);else this.send(snd,msg,function(reply){if(is_error(reply))return;self.handle(reply,snd);});}
amp.https.prototype.pong=function(snd,response){var self=this,msg={};msg.type=AMMessageType.AMMPONG;msg.port=this.port;msg.index=this.index++;msg.magic=magic;if(this.verbose>1)this.debug('amp.pong '+(response?'in response':'')+': to '+addr2url(snd));this.count.png++;if(response)
this.response(response,msg);else this.send(snd,msg,function(reply){if(is_error(reply)){self.emit('error',reply);}});}
amp.https.prototype.put=function(snd,path,data){var self=this,req,body;this.count.snd=this.count.snd+path.length+data.length;if(https){req=https.request({host:snd.address,port:snd.port,path:path,method:'POST',keepAlive:this.options.keepalive,headers:{'Content-Type':'application/x-www-form-urlencoded','Content-Length':data.length}},function(res){if(res.setEncoding!=null)res.setEncoding('utf8');res.once('data',function(chunk){});});req.once('error',function(err){self.out('Warning: request to '+addr2url(snd)+' failed: '+err,true);self.emit('error',err);});req.write(data);req.end();}else{http.request({host:snd.address,port:snd.port,path:path,proto:'https',method:'POST',body:data,keepAlive:this.options.keepalive,headers:{'Content-Type':'application/x-www-form-urlencoded','Content-Length':data.length}},function(err,xhr,body){if(err){if(self.verbose)self.out('Warning: request to '+addr2url(snd)+' failed: '+err,true);self.emit('error',err);}})}};amp.https.prototype.receiver=function(callback,rcv){var self=this;if(callback)this.callback=callback;if(this.mode&AMMode.AMO_SERVER){if(rcv==undefined||rcv.address==undefined)rcv={},rcv.address=this.rcv.address;if(rcv.port==undefined)rcv.port=this.rcv.port;var _options={key:this.options.pem.key,cert:this.options.pem.cert,};this.server=https.createServer(_options,function(request,response){if(parseQueryString(request.url).length==0)return response.end('EINVALID');var i,body,msg=parseQueryString(request.url),remote={address:request.connection.remoteAddress.replace(/^::ffff:/,'').replace(/^::1/,'localhost'),port:'['+msg.port.replace(/:/g,'')+']'};if(self.verbose>2)
console.log(request.method,request.url,msg,addr2url(remote),url2addr(addr2url(remote)));if(msg.magic!=magic)return;self.count.rcv+=msg.length;msg.type=AMMessageType[msg.type];if(msg.secure)msg.secure=Net.port_of_str(msg.secure);if(debug)console.log(Io.Time(),msg)
response.origin=request.headers.origin||request.headers.Origin;Comp.string.match(request.method,[['GET',function(){if(msg.type==AMMessageType.AMMCOLLECT)
self.collecting(msg,remote,response);else
self.handle(msg,remote,response);}],['POST',function(){body='';request.on('data',function(chunk){body=body+chunk;});request.on('end',function(){msg.data=Buffer(body,'hex');self.count.rcv+=msg.data.length;if(msg.cmd)msg.cmd=Number(msg.cmd);self.handle(msg,remote,response);});}]])});this.server.on("connection",function(socket){socket.setNoDelay(true);});this.server.on("error",function(err){self.out('Warning: receiver failed: '+err,true);if(err)self.err(err);});this.server.listen(rcv.port,function(err){if(!err)getNetworkIP(undefined,function(err,ip){if(!err)self.rcv.address=isLocal(ip)?options.localhost:ip;if(self.verbose)self.out('IP port '+addr2url(self.rcv)+' (proto '+self.options.proto+')',true);if(err)return self.out("! Unable to obtain network connection information: "+err,true);});if(callback)callback(err);});}
if(this.mode&AMMode.AMO_CLIENT){if(callback)this.callback=callback;}}
amp.http.prototype.reply=function(cmd,msg,snd){this.request(cmd,msg,snd);}
amp.https.prototype.response=function(response,msg){var data=msg2JSON(msg),header;if(response.origin!=undefined)
header={'Access-Control-Allow-Origin':response.origin,'Access-Control-Allow-Credentials':'true','Content-Type':'text/plain'};else
header={'Content-Type':'text/plain'};if(this.options.keepalive)header["Connection"]="keep-alive";response.writeHead(200,header);response.write(data);if(debug)console.log(Io.Time(),msg)
response.end();}
amp.https.prototype.request=function(cmd,msg,snd){var self=this,req={},size=msg.data.length,tid=msg.tid||Comp.random.int(65536/2);if(snd==undefined)this.err('request: snd=null');req.type=AMMessageType.AMMRPC;req.tid=tid;req.port=this.port;req.cmd=cmd;req.size=size;req.magic=magic;req.data=msg.data;this.send(snd,req);}
amp.https.prototype.scan=function(snd,response,callback){var self=this,msg={};msg.type=response?AMMessageType.AMMACK:AMMessageType.AMMSCAN;msg.port=this.port;msg.magic=magic;if(response)msg.info=snd.info;if(this.verbose>1&&snd)this.debug('amp.scan: to '+addr2url(snd)+' '+(response?'R':''));if(response)
this.response(response,msg);else
this.send(snd,msg,function(reply){callback(reply)});}
amp.https.prototype.send=function(snd,msg,callback){var path,url,body,self=this;path=formatQueryString(msg);if(typeof snd.port=='string'){url=addr2url(snd,true);if(this.links[url]){if(!this.links[url].msgqueue)this.links[url].msgqueue=[];if(this.links[url].collecting){if(this.verbose>1)this.debug('REPLY msg '+AMMessageType.print(msg.type)+' to '+url);this.response(this.links[url].collecting,{msg:[msg]});this.links[url].collecting=undefined;}else{if(this.verbose>1)this.debug('QUEUE msg '+AMMessageType.print(msg.type)+' for '+url);this.links[url].msgqueue.push(msg);}}}else if(msg.data!=undefined){body=msg.data.toString('hex');this.put(snd,path,body,function(body){if(is_error(body))self.emit('error',body);else if(!is_status(body))self.emit('error','EINVALID');});}else{this.get(snd,path,function(body){var xml,i,reply;if(!body||is_error(body)){self.emit('error','EINVALID');}else{reply=JSON2msg(body);}
if(callback)callback(reply);});}}
amp.https.prototype.start=function(callback){var self=this,s=this.secure?' (security port '+Sec.Port.toString(this.secure)+')':'';if(this.verbose>0&&this.mode&AMMode.AMO_SERVER)
this.out('Starting '+addr2url(this.rcv)+' ['+AMMode.print(this.mode)+'] (proto '+this.proto+')'+s);if(this.verbose>0&&this.mode&AMMode.AMO_CLIENT)
this.out('Starting ['+AMMode.print(this.mode)+'] (proto http)');this.watchdog(true);if(!this.server&&this.mode&AMMode.AMO_SERVER){this.receiver();}
if(callback)callback();}
amp.https.prototype.stop=function(callback){if(this.verbose>0&&this.mode&AMMode.AMO_SERVER)
this.out('Stopping '+addr2url(this.rcv)+' ['+AMMode.print(this.mode)+'] (proto '+this.proto+')'+s);if(this.verbose>0&&this.mode&AMMode.AMO_CLIENT)
this.out('Stopping ['+AMMode.print(this.mode)+'] (proto http)');if(this.links)for(var p in this.links){if(this.links[p]){this.unlink(this.links[p].snd);this.links[p].state=AMState.AMS_NOTCONNECTED;if(this.links[p].collect)clearTimeout(this.links[p].collect),this.links[p].collect=undefined;}}
if(this.timer)clearTimeout(this.timer),this.timer=undefined;if(this.server)this.server.close(),this.server=undefined;if(callback)callback();}
amp.https.prototype.unlink=function(snd){var self=this,msg,url=snd?addr2url(snd,true):null;if(this.mode&AMMode.AMO_MULTICAST){if(!this.links[url]||this.links[url].state!=AMState.AMS_CONNECTED)return;}else{if(this.links.state!=AMState.AMS_CONNECTED)return;}
msg={type:AMMessageType.AMMUNLINK,port:this.port,node:this.node?this.node.id:'*',index:this.index++,magic:magic};this.send(snd,msg,function(reply){if(reply){}});this.emit('route-',addr2url(snd,true));if(this.mode&AMMode.AMO_MULTICAST){this.links[url].state=AMState.AMS_NOTCONNECTED;if(!this.links[url].snd.connect)this.links[url].snd={};}else{this.links.state=AMState.AMS_NOTCONNECTED;if(!this.links.snd.connect)this.links.snd={};}
this.cleanup(url);}
amp.https.prototype.watchdog=function(run,immedOrDelay){var self=this;if(this.timer)clearTimeout(self.timer),this.timer=undefined;if(run)self.timer=setTimeout(function(){if(!self.timer||self.inwatchdog)return;self.timer=undefined;self.inwatchdog=true;function handle(obj,url){if(self.verbose>1)self.debug('Watchdog: handle link ('+url+') '+
(obj.snd?addr2url(obj.snd):'')+' in state '+
AMState.print(obj.state)+' live '+obj.live);switch(obj.state){case AMState.AMS_CONNECTED:if(obj.live==0){if(self.verbose>0)
self.out('Endpoint '+addr2url(obj.snd)+' not responding, propably dead. Unlinking...',true);obj.state=AMState.AMS_NOTCONNECTED;self.emit('route-',addr2url(obj.snd,true));self.cleanup(url,obj.snd.connect);if(obj.snd.connect)self.watchdog(true,2000);}else{obj.tries=0;obj.live--;self.watchdog(true);if(self.mode&AMMode.AMO_MULTICAST)self.ping(obj.snd);else self.ping();}
break;case AMState.AMS_NOTCONNECTED:case AMState.AMS_PAIRED:if(obj.snd.port&&typeof obj.snd.port=='number'){if(self.verbose>0&&obj.tries==0)
self.out('Trying link to '+addr2url(obj.snd),true);self.link(obj.snd);obj.tries++;if(obj.tries<options.TRIES)self.watchdog(true);else{self.out('Giving up to link '+addr2url(obj.snd),true);self.emit('error','link',addr2url(obj.snd));obj.snd={},obj.tries=0;}}
break;case AMState.AMS_RENDEZVOUS:obj.send({type:'register',name:self.rcv.name,linfo:self.rcv},self.broker,function(){});self.watchdog(true);break;case AMState.AMS_REGISTERED:if(obj.tries<options.TRIES&&obj.snd.name){obj.tries++;self.send({type:'pair',from:self.rcv.name,to:obj.snd.name},self.broker,function(){});}
if(obj.tries<options.TRIES)self.watchdog(true);break;}}
for(var p in self.links)if(self.links[p])handle(self.links[p],p);self.inwatchdog=false;},immedOrDelay==true?0:immedOrDelay||options.TIMER);};};BundleModuleCode['jam/mobi']=function(module,exports){var Comp=Require('com/compat');var Net;var options={debug:{},version:'1.10.2'}
function addr2url(addr){return typeof addr=='number'?String(addr):(addr.proto?addr.proto+'://':'')+addr.address+':'+addr.port;}
if(global.config.dos)Net=Require('dos/network');var current=none;var Aios=none;var DIRS=['NORTH','SOUTH','WEST','EAST','LEFT','RIGHT','UP','DOWN','ORIGIN','NW','NE','SW','SE','DELTA','RANGE','NODE','IP','PATH','CAP'];var DIR={NORTH:'DIR.NORTH',SOUTH:'DIR.SOUTH',WEST:'DIR.WEST',EAST:'DIR.EAST',LEFT:'DIR.LEFT',RIGHT:'DIR.RIGHT',UP:'DIR.UP',DOWN:'DIR.DOWN',ORIGIN:'DIR.ORIGIN',NW:'DIR.NW',NE:'DIR.NE',SW:'DIR.SW',SE:'DIR.SE',BACKWARD:'DIR.BACKWARD',FORWARD:'DIR.FORWARD',OPPOSITE:'DIR.OPPOSITE',DELTA:function(addr){return{tag:"DIR.DELTA",delta:addr}},RANGE:function(r){return{tag:"DIR.RANGE",radius:r}},NODE:function(node){return{tag:"DIR.NODE",node:node}},IP:function(addr){return{tag:"DIR.IP",ip:addr}},PATH:function(path){return{tag:"DIR.PATH",path:path}},CAP:function(cap){return{tag:"DIR.CAP",cap:cap}}}
DIR.tag={NORTH:'DIR.NORTH',SOUTH:'DIR.SOUTH',WEST:'DIR.WEST',EAST:'DIR.EAST',LEFT:'DIR.LEFT',RIGHT:'DIR.RIGHT',UP:'DIR.UP',DOWN:'DIR.DOWN',ORIGIN:'DIR.ORIGIN',NW:'DIR.NW',NE:'DIR.NE',SW:'DIR.SW',SE:'DIR.SE',BACKWARD:'DIR.BACKWARD',FORWARD:'DIR.FORWARD',OPPOSITE:'DIR.OPPOSITE',DELTA:'DIR.DELTA',RANGE:'DIR.RANGE',NODE:'DIR.NODE',IP:'DIR.IP',PATH:'DIR.PATH',CAP:'DIR.CAP',}
function opposite(dir,next){var chan;switch(dir.tag||dir){case DIR.NORTH:return DIR.SOUTH;case DIR.SOUTH:return DIR.NORTH;case DIR.WEST:return DIR.EAST;case DIR.EAST:return DIR.WEST;case DIR.LEFT:return DIR.RIGHT;case DIR.RIGHT:return DIR.LEFT;case DIR.UP:return DIR.DOWN;case DIR.DOWN:return DIR.UP;case DIR.NW:return DIR.SE;case DIR.NE:return DIR.SW;case DIR.SE:return DIR.NW;case DIR.SW:return DIR.NE;case DIR.BACKWARD:return DIR.FORWARD;case DIR.FORWARD:return DIR.BACKWARD;case DIR.OPPOSITE:return DIR.OPPOSITE;case DIR.tag.DELTA:if(!next)return DIR.DELTA(dir.delta.map(function(v){return-v}));else return;case DIR.tag.IP:if(current.process&&current.process.back&&current.process.back.tag==DIR.tag.IP)return current.process.back;else return none;case DIR.tag.NODE:if(current.process&&current.process.back){switch(current.process.back.tag){case DIR.tag.IP:if(current.node&&current.node.connections.ip&&current.node.connections.ip.reverse)
return DIR.NODE(current.node.connections.ip.reverse(current.process.back.ip));else
return current.process.back;case DIR.tag.NODE:return current.process.back;default:return none;}}else return none;case'DIR.PATH':return none;case'DIR.CAP':return none;default:return none;}};DIR.from=function(name){var Dir=name.toUpperCase();if(DIRS.indexOf(Dir)==-1)return;return{tag:'DIR.'+Dir}}
DIR.to=function(dir){if((dir.tag||dir).substr(0,4)!='DIR.')return;return(dir.tag||dir).substr(4).toLowerCase();}
DIR.isDir=function(o){return(o.tag||o).indexOf('DIR')==0;}
DIR.opposite=opposite;DIR.print=function(dir){if(!dir)return'undefined';var name=(dir.tag||dir).substring(4);switch(dir.tag||dir){case'DIR.DELTA':return name+'('+Comp.printf.list(dir.delta)+')';case'DIR.RANGE':return name+'('+dir.radius+')';case'DIR.NODE':return name+'('+dir.node+')';case'DIR.IP':return name+'('+(dir.ip==undefined?'*':dir.ip)+')';case'DIR.PATH':return name+'('+dir.path+')';case'DIR.CAP':return name+'('+dir.cao+')';default:if(!dir.ip)return name
else return name+'('+addr2url(dir.ip)+')';}};DIR.toString=function(dir){function format(ip){if(ip==undefined)return'';if(typeof ip=='number')return ip;if(typeof ip=='string')return'"'+ip+'"';}
switch(dir.tag){case DIR.NORTH:return'DIR.North('+format(dir.ip)+')';case DIR.SOUTH:return'DIR.South('+format(dir.ip)+')';case DIR.WEST:return'DIR.West('+format(dir.ip)+')';case DIR.EAST:return'DIR.East('+format(dir.ip)+')';case DIR.tag.IP:return'DIR.IP('+format(dir.ip)+')';}
return dir;}
function lookup(node,destnode){var chan,path;if(node.connections.ip&&node.connections.ip.lookup){path=node.connections.ip.lookup(destnode);if(path)return{chan:node.connections.ip,dest:path};}}
function move(dir){var node1=current.node,chan=none,dest,stat,path,alive=function(){return 1},nokill=false,name=DIR.to(dir),msg;switch(dir.tag||dir){case'DIR.IP':chan=node1.connections.ip;dest=dir.ip;break;case'DIR.DELTA':current.process.dir=Comp.obj.copy(dir);if(dir.delta[0]>0&&node1.connections.east&&node1.connections.east.status())
current.process.dir.delta[0]--,chan=node1.connections.east;else if(dir.delta[0]<0&&node1.connections.west&&node1.connections.west.status())
current.process.dir.delta[0]++,chan=node1.connections.west;else if(dir.delta[1]>0&&node1.connections.south&&node1.connections.south.status())
current.process.dir.delta[1]--,chan=node1.connections.south;else if(dir.delta[1]<0&&node1.connections.north&&node1.connections.north.status())
current.process.dir.delta[1]++,chan=node1.connections.north;else if(dir.delta[2]>0&&node1.connections.up&&node1.connections.up.status())
current.process.dir.delta[2]--,chan=node1.connections.up;else if(dir.delta[2]<0&&node1.connections.down&&node1.connections.down.status())
current.process.dir.delta[2]++,chan=node1.connections.down;break;case'DIR.NODE':if(node1.connections.range&&node1.connections.range[dir.node]&&node1.connections.range[dir.node].status())
chan=node1.connections.range[dir.node],dest=dir.node;else{dest=lookup(node1,dir.node);if(dest)chan=dest.chan,dest=dest.dest;}
break;case'DIR.PATH':if(Comp.obj.isArray(dir.path)){path=Comp.array.pop(dir.path);}else path=dir.path;chan=node1.connections.path;dest=path;nokill=true;break;case'DIR.CAP':if(!current.network){current.error='No connection to server '+dir.cap;throw'MOVE'};chan=node1.connections.dos;dest=Net.Parse.capability(dir.cap).cap;nokill=true;break;default:if(!name){current.error='ENOCHANNEL';throw'MOVE';}
chan=node1.connections[name];}
if(chan==none||!chan.status(dest)){current.error='No connection to direction '+DIR.print(dir);throw'MOVE'};if(!current.process.back)current.process.back=Aios.DIR.opposite(dir);node1.stats.migrate++;if(Aios.options.fastcopy&&chan.virtual)msg=Aios.Code.toObject(current.process);else msg=Aios.Code.ofCode(current.process,false);current.process.move=dir;chan.send({agent:msg,to:dest,context:current.process});if(!nokill)current.process.kill=true;else current.process.suspended=true;}
module.exports={agent:{move:move,opposite:opposite,DIR:DIR},current:function(module){current=module.current;Aios=module;},DIR:DIR,DIRS:DIRS,options:options}};BundleModuleCode['jam/watchdog']=function(module,exports){var Fs=Require('fs');function search(index,module){if(PATH.length==index)return module;var path=PATH[index];if(Fs.existsSync(path+'/'+module))return path+'/'+module;else return search(index+1,module);}
try{var watchdog;try{watchdog=process&&process.binding&&process.binding&&process.binding('watchdog')}catch(e){};if(!watchdog)watchdog=process&&process.watchdog;if(!watchdog&&process&&process.startWatchdog)watchdog={start:process.startWatchdog,stop:process.stopWatchdog,init:process.initWatchdog,tick:process.tick};if(!watchdog&&process&&process.version&&Fs){var nativePath,platformVersion;if(process.version.match(/^v0.12/))platformVersion="0.12";else if(process.version.match(/^v3/))platformVersion="3.x";else if(process.version.match(/^v4/))platformVersion="4.x";else if(process.version.match(/^v5/))platformVersion="5.x";else if(process.version.match(/^v6/))platformVersion="6.x";else if(process.version.match(/^v7/))platformVersion="7.x";else if(process.version.match(/^v8/))platformVersion="8.x";else if(process.version.match(/^v9/))platformVersion="9.x";if(platformVersion&&process.platform&&process.arch)
nativePath='native/'+process.platform+'/'+platformVersion+'/'+process.arch+'/watchdog';if(PATH)
if(nativePath)watchdog=require(nativePath);}}catch(e){}
if(watchdog){module.exports={start:watchdog.start||watchdog.startWatchdog,stop:watchdog.stop||watchdog.stopWatchdog,init:watchdog.init||watchdog.initWatchdog,checkPoint:watchdog.checkPoint,tick:watchdog.tick,protect:watchdog.protect}}else module=undefined;};BundleModuleCode['dos/ext/satelize']=function(module,exports){var http=Require("http"),serviceHost="ip-api.com",servicePort=80,servicePath="/json",serviceJSONP="";function Satelize(options){this.init()}
Satelize.prototype.init=function(options){return this}
Satelize.prototype.satelize=function(a,b){var c=(a.ip?"/"+a.ip:"")+(a.JSONP?serviceJSONP:""),d=a.timeout||1e3,h=a.url||a.host||serviceHost,p=a.port||servicePort,e,f;if(!http)return b('ENOTSUPPORTED',null);if(!http.xhr&&http.request){e={hostname:h,path:servicePath+c,method:"GET",port:p};f=http.request(e,function(a){a.setEncoding("utf8");var c="";a.on("data",function(a){c+=a}),a.on("end",function(){try{return b(null,JSON.parse(c));}catch(err){b(err.toString()+', '+e.hostname+':'+e.port);}})});return f.on("error",function(a){return b(a)}),f.setTimeout(d,function(){return b(new Error("timeout"))}),f.end(),this;}else{e={uri:a.url?a.url:(a.proto?a.proto:'http')+'://'+h+':'+p+servicePath+c,method:"GET",headers:{}};console.log(e);http.request(e,function(err,xhr,body){if(err)return b(err);else try{b(null,JSON.parse(body));}catch(err){b(err.toString()+', '+e.uri)}})
return this;}}
var sat=new Satelize
module.exports=sat;};BundleModuleCode['geoip/gps5']=function(module,exports){var serviceHost="location.services.mozilla.com",servicePath="/v1/geolocate?key=test";function geolocate(cb){var https;if(typeof require=='function')try{https=require('https');}catch(e){}
if(!https)return cb(new Error('ENETWORK'));var req=https.request({hostname:serviceHost,port:443,path:servicePath,method:'GET'},function(res){res.on('data',function(d){try{var json=JSON.parse(d);cb(json)}catch(e){cb(e)};});})
req.on('error',function(e){console.error(e);cb(e);});req.end();}
module.exports={geolocate:geolocate};};BundleModuleCode['geoip/geoloc5']=function(module,exports){var options={locate:{primary:{http:'ag-0.de:9999',https:'ag-0.de:9998',timeout:1000},secondary:{http:'ip-api.com:80',https:'ip-api.com:80',path:'/json',timeout:2000},},locate5:{secondary:{https:'location.services.mozilla.com:443',path:'/v1/geolocate?key=test'},},reverse:{primary:{https:'api.opencagedata.com',path:'/geocode/v1/json?q=LAT+LON&key=8e7c3730678842468d6acf450ecbca16'},secondary:{https:'nominatim.openstreetmap.org',path:'/reverse/?format=json&lat=LAT&lon=LON'},},}
var http=Require("http"),https;function ip(url){return url.split(':')[0]}
function port(url){return url.split(':')[1]}
function stage1(cb,options,location){var e,r;if(!http.xhr&&http.request){e={hostname:ip(options.http),path:options.path||'',method:"GET",port:port(options.http)};r=http.request(e,function(a){a.setEncoding("utf8");var c="";a.on("data",function(a){c+=a}),a.on("end",function(){try{var info=JSON.parse(c);Object.assign(location,{ip:info.query,gps:{lat:info.lat,lon:info.lon},geo:{city:info.city,country:info.country,countryCode:info.countryCode,region:info.region,zip:info.zip}})
return cb(location);}catch(err){return cb(err);}})});r.on("error",function(a){return cb(a);})
r.setTimeout(options.timeout,function(){return cb(new Error("ETIMEOUT"));})
r.end();}else{var proto=document.URL.indexOf('https')==0?'https':'http';e={uri:proto+'://'+options[proto]+'/'+options.path,method:"GET",headers:{}};http.request(e,function(err,xhr,body){if(err)return cb(err);try{var info=JSON.parse(body);Object.assign(location,{ip:info.query,gps:{lat:info.lat,lon:info.lon},geo:{city:info.city,country:info.country,countryCode:info.countryCode,region:info.region,zip:info.zip}})
return cb(location);}catch(err){return cb(err);}})}}
function stage2(cb,options,location){if(!https||!https.request)return cb(new Error('ENETWORK'));if(!https.xhr&&https.request){var req=https.request({hostname:ip(options.https),port:port(options.https),path:options.path,method:'GET'},function(res){res.on('data',function(d){try{var pos=JSON.parse(d);location.gps5={lat:pos.location.lat,lon:pos.location.lng}
cb(location)}catch(e){cb(e)};});})
req.on('error',function(e){cb(e);});req.end();}else{e={uri:'https://'+options.https+'/'+options.path,method:"GET",headers:{}};https.request(e,function(err,xhr,body){if(err)return cb(err);try{var pos=JSON.parse(body);location.gps5={lat:pos.location.lat,lon:pos.location.lng}
return cb(location);}catch(err){return cb(err);}})}}
function stage3(cb,options,location){if(!https||!https.request)return cb(new Error('ENETWORK'));options.path=options.path.replace(/LAT/,location.gps5.lat).replace(/LON/,location.gps5.lon);if(!https.xhr&&https.request){var req=https.request({hostname:ip(options.https),port:port(options.https),path:options.path,method:'GET'},function(res){res.on('data',function(d){try{var res=JSON.parse(d);var loc;if(res.address)loc=res.address;else if(res.results&&res.results[0])loc=res.results[0].components;location.geo5={city:loc.city,zip:loc.postcode,street:loc.road,number:loc.house_number,country:loc.country}
cb(location)}catch(e){cb(e)};});})
req.on('error',function(e){cb(e);});req.end();}else{e={uri:'https://'+options.https+'/'+options.path,method:"GET",headers:{}};https.request(e,function(err,xhr,body){if(err)return cb(err);try{var res=JSON.parse(body);var loc;if(res.address)loc=res.address;else if(res.results&&res.results[0])loc=res.results[0].components;location.geo5={city:loc.city,zip:loc.postcode,street:loc.road,number:loc.house_number,country:loc.country}
return cb(location);}catch(err){return cb(err);}})}}
var todo={stage1A:function(cb,errors,location){stage1(function(res){if(res instanceof Error){errors.push({url:options.locate.primary,error:res});todo.stage1B(cb,errors,location);}else{todo.stage2A(cb,errors,location);}},options.locate.primary,location);},stage1B:function(cb,errors,location){stage1(function(res){if(res instanceof Error){errors.push({url:options.locate.secondary,error:res});todo.stage2A(cb,errors,location);}else{todo.stage2A(cb,errors,location);}},options.locate.secondary,location);},stage2A:function(cb,errors,location){stage2(function(res){if(res instanceof Error){errors.push({url:options.locate5.secondary,error:res});todo.finalize(cb,errors,location);}else{todo.stage2B(cb,errors,location);}},options.locate5.secondary,location);},stage2B:function(cb,errors,location){stage3(function(res){if(res instanceof Error){errors.push({url:options.reverse.primary,x:1,error:res});todo.finalize(cb,errors,location);}else{todo.finalize(cb,errors,location);}},options.reverse.primary,location);},finalize:function(cb,errors,location){cb(location,errors);}}
function locate(cb){var e;if(typeof require=='function'&&!https)try{https=require('https');}catch(e){}else if(http.xhr)https=http;if(!http)return cb(new Error('ENOTSUPPORTED'));todo.stage1A(cb,[],{});return;}
module.exports={locate:locate};};BundleModuleCode['os/platform']=function(module,exports){if(global.TARGET=='browser'){var objectTypes={'function':true,'object':true};var root=(objectTypes[typeof window]&&window)||this;var oldRoot=root;var freeExports=objectTypes[typeof exports]&&exports;var freeModule=objectTypes[typeof module]&&module&&!module.nodeType&&module;var freeGlobal=freeExports&&freeModule&&typeof global=='object'&&global;if(freeGlobal&&(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal||freeGlobal.self===freeGlobal)){root=freeGlobal;}
var maxSafeInteger=Math.pow(2,53)-1;var reOpera=/\bOpera/;var thisBinding=this;var objectProto=Object.prototype;var hasOwnProperty=objectProto.hasOwnProperty;var toString=objectProto.toString;function capitalize(string){string=String(string);return string.charAt(0).toUpperCase()+string.slice(1);}
function cleanupOS(os,pattern,label){var data={'10.0':'10','6.4':'10 Technical Preview','6.3':'8.1','6.2':'8','6.1':'Server 2008 R2 / 7','6.0':'Server 2008 / Vista','5.2':'Server 2003 / XP 64-bit','5.1':'XP','5.01':'2000 SP1','5.0':'2000','4.0':'NT','4.90':'ME'};if(pattern&&label&&/^Win/i.test(os)&&!/^Windows Phone /i.test(os)&&(data=data[/[\d.]+$/.exec(os)])){os='Windows '+data;}
os=String(os);if(pattern&&label){os=os.replace(RegExp(pattern,'i'),label);}
os=format(os.replace(/ ce$/i,' CE').replace(/\bhpw/i,'web').replace(/\bMacintosh\b/,'Mac OS').replace(/_PowerPC\b/i,' OS').replace(/\b(OS X) [^ \d]+/i,'$1').replace(/\bMac (OS X)\b/,'$1').replace(/\/(\d)/,' $1').replace(/_/g,'.').replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,'').replace(/\bx86\.64\b/gi,'x86_64').replace(/\b(Windows Phone) OS\b/,'$1').replace(/\b(Chrome OS \w+) [\d.]+\b/,'$1').split(' on ')[0]);return os;}
function each(object,callback){var index=-1,length=object?object.length:0;if(typeof length=='number'&&length>-1&&length<=maxSafeInteger){while(++index<length){callback(object[index],index,object);}}else{forOwn(object,callback);}}
function format(string){string=trim(string);return/^(?:webOS|i(?:OS|P))/.test(string)?string:capitalize(string);}
function forOwn(object,callback){for(var key in object){if(hasOwnProperty.call(object,key)){callback(object[key],key,object);}}}
function getClassOf(value){return value==null?capitalize(value):toString.call(value).slice(8,-1);}
function isHostType(object,property){var type=object!=null?typeof object[property]:'number';return!/^(?:boolean|number|string|undefined)$/.test(type)&&(type=='object'?!!object[property]:true);}
function qualify(string){return String(string).replace(/([ -])(?!$)/g,'$1?');}
function reduce(array,callback){var accumulator=null;each(array,function(value,index){accumulator=callback(accumulator,value,index,array);});return accumulator;}
function trim(string){return String(string).replace(/^ +| +$/g,'');}
function parse(ua){var context=root;var isCustomContext=ua&&typeof ua=='object'&&getClassOf(ua)!='String';if(isCustomContext){context=ua;ua=null;}
var nav=context.navigator||{};var userAgent=nav.userAgent||'';ua||(ua=userAgent);var isModuleScope=isCustomContext||thisBinding==oldRoot;var likeChrome=isCustomContext?!!nav.likeChrome:/\bChrome\b/.test(ua)&&!/internal|\n/i.test(toString.toString());var objectClass='Object',airRuntimeClass=isCustomContext?objectClass:'ScriptBridgingProxyObject',enviroClass=isCustomContext?objectClass:'Environment',javaClass=(isCustomContext&&context.java)?'JavaPackage':getClassOf(context.java),phantomClass=isCustomContext?objectClass:'RuntimeObject';var java=/\bJava/.test(javaClass)&&context.java;var rhino=java&&getClassOf(context.environment)==enviroClass;var alpha=java?'a':'\u03b1';var beta=java?'b':'\u03b2';var doc=context.document||{};var opera=context.operamini||context.opera;var operaClass=reOpera.test(operaClass=(isCustomContext&&opera)?opera['[[Class]]']:getClassOf(opera))?operaClass:(opera=null);var data;var arch=ua;var description=[];var prerelease=null;var useFeatures=ua==userAgent;var version=useFeatures&&opera&&typeof opera.version=='function'&&opera.version();var isSpecialCasedOS;var layout=getLayout([{'label':'EdgeHTML','pattern':'(?:Edge|EdgA|EdgiOS)'},'Trident',{'label':'WebKit','pattern':'AppleWebKit'},'iCab','Presto','NetFront','Tasman','KHTML','Gecko']);var name=getName(['Adobe AIR','Arora','Avant Browser','Breach','Camino','Electron','Epiphany','Fennec','Flock','Galeon','GreenBrowser','iCab','Iceweasel','K-Meleon','Konqueror','Lunascape','Maxthon',{'label':'Microsoft Edge','pattern':'(?:Edge|Edg|EdgA|EdgiOS)'},'Midori','Nook Browser','PaleMoon','PhantomJS','Raven','Rekonq','RockMelt',{'label':'Samsung Internet','pattern':'SamsungBrowser'},'SeaMonkey',{'label':'Silk','pattern':'(?:Cloud9|Silk-Accelerated)'},'Sleipnir','SlimBrowser',{'label':'SRWare Iron','pattern':'Iron'},'Sunrise','Swiftfox','Waterfox','WebPositive','Opera Mini',{'label':'Opera Mini','pattern':'OPiOS'},'Opera',{'label':'Opera','pattern':'OPR'},'Chrome',{'label':'Chrome Mobile','pattern':'(?:CriOS|CrMo)'},{'label':'Firefox','pattern':'(?:Firefox|Minefield)'},{'label':'Firefox for iOS','pattern':'FxiOS'},{'label':'IE','pattern':'IEMobile'},{'label':'IE','pattern':'MSIE'},'Safari']);var product=getProduct([{'label':'BlackBerry','pattern':'BB10'},'BlackBerry',{'label':'Galaxy S','pattern':'GT-I9000'},{'label':'Galaxy S2','pattern':'GT-I9100'},{'label':'Galaxy S3','pattern':'GT-I9300'},{'label':'Galaxy S4','pattern':'GT-I9500'},{'label':'Galaxy S5','pattern':'SM-G900'},{'label':'Galaxy S6','pattern':'SM-G920'},{'label':'Galaxy S6 Edge','pattern':'SM-G925'},{'label':'Galaxy S7','pattern':'SM-G930'},{'label':'Galaxy S7 Edge','pattern':'SM-G935'},'Google TV','Lumia','iPad','iPod','iPhone','Kindle',{'label':'Kindle Fire','pattern':'(?:Cloud9|Silk-Accelerated)'},'Nexus','Nook','PlayBook','PlayStation Vita','PlayStation','TouchPad','Transformer',{'label':'Wii U','pattern':'WiiU'},'Wii','Xbox One',{'label':'Xbox 360','pattern':'Xbox'},'Xoom']);var manufacturer=getManufacturer({'Apple':{'iPad':1,'iPhone':1,'iPod':1},'Archos':{},'Amazon':{'Kindle':1,'Kindle Fire':1},'Asus':{'Transformer':1},'Barnes & Noble':{'Nook':1},'BlackBerry':{'PlayBook':1},'Google':{'Google TV':1,'Nexus':1},'HP':{'TouchPad':1},'HTC':{},'LG':{},'Microsoft':{'Xbox':1,'Xbox One':1},'Motorola':{'Xoom':1},'Nintendo':{'Wii U':1,'Wii':1},'Nokia':{'Lumia':1},'Samsung':{'Galaxy S':1,'Galaxy S2':1,'Galaxy S3':1,'Galaxy S4':1},'Sony':{'PlayStation':1,'PlayStation Vita':1}});var os=getOS(['Windows Phone','Android','CentOS',{'label':'Chrome OS','pattern':'CrOS'},'Debian','Fedora','FreeBSD','Gentoo','Haiku','Kubuntu','Linux Mint','OpenBSD','Red Hat','SuSE','Ubuntu','Xubuntu','Cygwin','Symbian OS','hpwOS','webOS ','webOS','Tablet OS','Tizen','Linux','Mac OS X','Macintosh','Mac','Windows 98;','Windows ','SunOS',]);function getLayout(guesses){return reduce(guesses,function(result,guess){return result||RegExp('\\b'+(guess.pattern||qualify(guess))+'\\b','i').exec(ua)&&(guess.label||guess);});}
function getManufacturer(guesses){return reduce(guesses,function(result,value,key){return result||(value[product]||value[/^[a-z]+(?: +[a-z]+\b)*/i.exec(product)]||RegExp('\\b'+qualify(key)+'(?:\\b|\\w*\\d)','i').exec(ua))&&key;});}
function getName(guesses){return reduce(guesses,function(result,guess){return result||RegExp('\\b'+(guess.pattern||qualify(guess))+'\\b','i').exec(ua)&&(guess.label||guess);});}
function getOS(guesses){return reduce(guesses,function(result,guess){var pattern=guess.pattern||qualify(guess);if(!result&&(result=RegExp('\\b'+pattern+'(?:/[\\d.]+|[ \\w.]*)','i').exec(ua))){result=cleanupOS(result,pattern,guess.label||guess);}
return result;});}
function getProduct(guesses){return reduce(guesses,function(result,guess){var pattern=guess.pattern||qualify(guess);if(!result&&(result=RegExp('\\b'+pattern+' *\\d+[.\\w_]*','i').exec(ua)||RegExp('\\b'+pattern+' *\\w+-[\\w]*','i').exec(ua)||RegExp('\\b'+pattern+'(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)','i').exec(ua))){if((result=String((guess.label&&!RegExp(pattern,'i').test(guess.label))?guess.label:result).split('/'))[1]&&!/[\d.]+/.test(result[0])){result[0]+=' '+result[1];}
guess=guess.label||guess;result=format(result[0].replace(RegExp(pattern,'i'),guess).replace(RegExp('; *(?:'+guess+'[_-])?','i'),' ').replace(RegExp('('+guess+')[-_.]?(\\w)','i'),'$1 $2'));}
return result;});}
function getVersion(patterns){return reduce(patterns,function(result,pattern){return result||(RegExp(pattern+'(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)','i').exec(ua)||0)[1]||null;});}
function toStringPlatform(){return this.description||'';}
layout&&(layout=[layout]);if(manufacturer&&!product){product=getProduct([manufacturer]);}
if((data=/\bGoogle TV\b/.exec(product))){product=data[0];}
if(/\bSimulator\b/i.test(ua)){product=(product?product+' ':'')+'Simulator';}
if(name=='Opera Mini'&&/\bOPiOS\b/.test(ua)){description.push('running in Turbo/Uncompressed mode');}
if(name=='IE'&&/\blike iPhone OS\b/.test(ua)){data=parse(ua.replace(/like iPhone OS/,''));manufacturer=data.manufacturer;product=data.product;}
else if(/^iP/.test(product)){name||(name='Safari');os='iOS'+((data=/ OS ([\d_]+)/i.exec(ua))?' '+data[1].replace(/_/g,'.'):'');}
else if(name=='Konqueror'&&!/buntu/i.test(os)){os='Kubuntu';}
else if((manufacturer&&manufacturer!='Google'&&((/Chrome/.test(name)&&!/\bMobile Safari\b/i.test(ua))||/\bVita\b/.test(product)))||(/\bAndroid\b/.test(os)&&/^Chrome/.test(name)&&/\bVersion\//i.test(ua))){name='Android Browser';os=/\bAndroid\b/.test(os)?os:'Android';}
else if(name=='Silk'){if(!/\bMobi/i.test(ua)){os='Android';description.unshift('desktop mode');}
if(/Accelerated *= *true/i.test(ua)){description.unshift('accelerated');}}
else if(name=='PaleMoon'&&(data=/\bFirefox\/([\d.]+)\b/.exec(ua))){description.push('identifying as Firefox '+data[1]);}
else if(name=='Firefox'&&(data=/\b(Mobile|Tablet|TV)\b/i.exec(ua))){os||(os='Firefox OS');product||(product=data[1]);}
else if(!name||(data=!/\bMinefield\b/i.test(ua)&&/\b(?:Firefox|Safari)\b/.exec(name))){if(name&&!product&&/[\/,]|^[^(]+?\)/.test(ua.slice(ua.indexOf(data+'/')+8))){name=null;}
if((data=product||manufacturer||os)&&(product||manufacturer||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(os))){name=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(os)?os:data)+' Browser';}}
else if(name=='Electron'&&(data=(/\bChrome\/([\d.]+)\b/.exec(ua)||0)[1])){description.push('Chromium '+data);}
if(!version){version=getVersion(['(?:Cloud9|CriOS|CrMo|Edge|Edg|EdgA|EdgiOS|FxiOS|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$))','Version',qualify(name),'(?:Firefox|Minefield|NetFront)']);}
if((data=layout=='iCab'&&parseFloat(version)>3&&'WebKit'||/\bOpera\b/.test(name)&&(/\bOPR\b/.test(ua)?'Blink':'Presto')||/\b(?:Midori|Nook|Safari)\b/i.test(ua)&&!/^(?:Trident|EdgeHTML)$/.test(layout)&&'WebKit'||!layout&&/\bMSIE\b/i.test(ua)&&(os=='Mac OS'?'Tasman':'Trident')||layout=='WebKit'&&/\bPlayStation\b(?! Vita\b)/i.test(name)&&'NetFront')){layout=[data];}
if(name=='IE'&&(data=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(ua)||0)[1])){name+=' Mobile';os='Windows Phone '+(/\+$/.test(data)?data:data+'.x');description.unshift('desktop mode');}
else if(/\bWPDesktop\b/i.test(ua)){name='IE Mobile';os='Windows Phone 8.x';description.unshift('desktop mode');version||(version=(/\brv:([\d.]+)/.exec(ua)||0)[1]);}
else if(name!='IE'&&layout=='Trident'&&(data=/\brv:([\d.]+)/.exec(ua))){if(name){description.push('identifying as '+name+(version?' '+version:''));}
name='IE';version=data[1];}
if(useFeatures){if(isHostType(context,'global')){if(java){data=java.lang.System;arch=data.getProperty('os.arch');os=os||data.getProperty('os.name')+' '+data.getProperty('os.version');}
if(rhino){try{version=context.require('ringo/engine').version.join('.');name='RingoJS';}catch(e){if((data=context.system)&&data.global.system==context.system){name='Narwhal';os||(os=data[0].os||null);}}
if(!name){name='Rhino';}}
else if(typeof context.process=='object'&&!context.process.browser&&(data=context.process)){if(typeof data.versions=='object'){if(typeof data.versions.electron=='string'){description.push('Node '+data.versions.node);name='Electron';version=data.versions.electron;}else if(typeof data.versions.nw=='string'){description.push('Chromium '+version,'Node '+data.versions.node);name='NW.js';version=data.versions.nw;}}
if(!name){name='Node.js';arch=data.arch;os=data.platform;version=/[\d.]+/.exec(data.version);version=version?version[0]:null;}}}
else if(getClassOf((data=context.runtime))==airRuntimeClass){name='Adobe AIR';os=data.flash.system.Capabilities.os;}
else if(getClassOf((data=context.phantom))==phantomClass){name='PhantomJS';version=(data=data.version||null)&&(data.major+'.'+data.minor+'.'+data.patch);}
else if(typeof doc.documentMode=='number'&&(data=/\bTrident\/(\d+)/i.exec(ua))){version=[version,doc.documentMode];if((data=+data[1]+4)!=version[1]){description.push('IE '+version[1]+' mode');layout&&(layout[1]='');version[1]=data;}
version=name=='IE'?String(version[1].toFixed(1)):version[0];}
else if(typeof doc.documentMode=='number'&&/^(?:Chrome|Firefox)\b/.test(name)){description.push('masking as '+name+' '+version);name='IE';version='11.0';layout=['Trident'];os='Windows';}
os=os&&format(os);}
if(version&&(data=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(version)||/(?:alpha|beta)(?: ?\d)?/i.exec(ua+';'+(useFeatures&&nav.appMinorVersion))||/\bMinefield\b/i.test(ua)&&'a')){prerelease=/b/i.test(data)?'beta':'alpha';version=version.replace(RegExp(data+'\\+?$'),'')+
(prerelease=='beta'?beta:alpha)+(/\d+\+?/.exec(data)||'');}
if(name=='Fennec'||name=='Firefox'&&/\b(?:Android|Firefox OS)\b/.test(os)){name='Firefox Mobile';}
else if(name=='Maxthon'&&version){version=version.replace(/\.[\d.]+/,'.x');}
else if(/\bXbox\b/i.test(product)){if(product=='Xbox 360'){os=null;}
if(product=='Xbox 360'&&/\bIEMobile\b/.test(ua)){description.unshift('mobile mode');}}
else if((/^(?:Chrome|IE|Opera)$/.test(name)||name&&!product&&!/Browser|Mobi/.test(name))&&(os=='Windows CE'||/Mobi/i.test(ua))){name+=' Mobile';}
else if(name=='IE'&&useFeatures){try{if(context.external===null){description.unshift('platform preview');}}catch(e){description.unshift('embedded');}}
else if((/\bBlackBerry\b/.test(product)||/\bBB10\b/.test(ua))&&(data=(RegExp(product.replace(/ +/g,' *')+'/([.\\d]+)','i').exec(ua)||0)[1]||version)){data=[data,/BB10/.test(ua)];os=(data[1]?(product=null,manufacturer='BlackBerry'):'Device Software')+' '+data[0];version=null;}
else if(this!=forOwn&&product!='Wii'&&((useFeatures&&opera)||(/Opera/.test(name)&&/\b(?:MSIE|Firefox)\b/i.test(ua))||(name=='Firefox'&&/\bOS X (?:\d+\.){2,}/.test(os))||(name=='IE'&&((os&&!/^Win/.test(os)&&version>5.5)||/\bWindows XP\b/.test(os)&&version>8||version==8&&!/\bTrident\b/.test(ua))))&&!reOpera.test((data=parse.call(forOwn,ua.replace(reOpera,'')+';')))&&data.name){data='ing as '+data.name+((data=data.version)?' '+data:'');if(reOpera.test(name)){if(/\bIE\b/.test(data)&&os=='Mac OS'){os=null;}
data='identify'+data;}
else{data='mask'+data;if(operaClass){name=format(operaClass.replace(/([a-z])([A-Z])/g,'$1 $2'));}else{name='Opera';}
if(/\bIE\b/.test(data)){os=null;}
if(!useFeatures){version=null;}}
layout=['Presto'];description.push(data);}
if((data=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(ua)||0)[1])){data=[parseFloat(data.replace(/\.(\d)$/,'.0$1')),data];if(name=='Safari'&&data[1].slice(-1)=='+'){name='WebKit Nightly';prerelease='alpha';version=data[1].slice(0,-1);}
else if(version==data[1]||version==(data[2]=(/\bSafari\/([\d.]+\+?)/i.exec(ua)||0)[1])){version=null;}
data[1]=(/\bChrome\/([\d.]+)/i.exec(ua)||0)[1];if(data[0]==537.36&&data[2]==537.36&&parseFloat(data[1])>=28&&layout=='WebKit'){layout=['Blink'];}
if(!useFeatures||(!likeChrome&&!data[1])){layout&&(layout[1]='like Safari');data=(data=data[0],data<400?1:data<500?2:data<526?3:data<533?4:data<534?'4+':data<535?5:data<537?6:data<538?7:data<601?8:'8');}else{layout&&(layout[1]='like Chrome');data=data[1]||(data=data[0],data<530?1:data<532?2:data<532.05?3:data<533?4:data<534.03?5:data<534.07?6:data<534.10?7:data<534.13?8:data<534.16?9:data<534.24?10:data<534.30?11:data<535.01?12:data<535.02?'13+':data<535.07?15:data<535.11?16:data<535.19?17:data<536.05?18:data<536.10?19:data<537.01?20:data<537.11?'21+':data<537.13?23:data<537.18?24:data<537.24?25:data<537.36?26:layout!='Blink'?'27':'28');}
layout&&(layout[1]+=' '+(data+=typeof data=='number'?'.x':/[.+]/.test(data)?'':'+'));if(name=='Safari'&&(!version||parseInt(version)>45)){version=data;}}
if(name=='Opera'&&(data=/\bzbov|zvav$/.exec(os))){name+=' ';description.unshift('desktop mode');if(data=='zvav'){name+='Mini';version=null;}else{name+='Mobile';}
os=os.replace(RegExp(' *'+data+'$'),'');}
else if(name=='Safari'&&/\bChrome\b/.exec(layout&&layout[1])){description.unshift('desktop mode');name='Chrome Mobile';version=null;if(/\bOS X\b/.test(os)){manufacturer='Apple';os='iOS 4.3+';}else{os=null;}}
if(version&&version.indexOf((data=/[\d.]+$/.exec(os)))==0&&ua.indexOf('/'+data+'-')>-1){os=trim(os.replace(data,''));}
if(layout&&!/\b(?:Avant|Nook)\b/.test(name)&&(/Browser|Lunascape|Maxthon/.test(name)||name!='Safari'&&/^iOS/.test(os)&&/\bSafari\b/.test(layout[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|Web)/.test(name)&&layout[1])){(data=layout[layout.length-1])&&description.push(data);}
if(description.length){description=['('+description.join('; ')+')'];}
if(manufacturer&&product&&product.indexOf(manufacturer)<0){description.push('on '+manufacturer);}
if(product){description.push((/^on /.test(description[description.length-1])?'':'on ')+product);}
if(os){data=/ ([\d.+]+)$/.exec(os);isSpecialCasedOS=data&&os.charAt(os.length-data[0].length-1)=='/';os={'architecture':32,'family':(data&&!isSpecialCasedOS)?os.replace(data[0],''):os,'version':data?data[1]:null,'toString':function(){var version=this.version;return this.family+((version&&!isSpecialCasedOS)?' '+version:'')+(this.architecture==64?' 64-bit':'');}};}
if((data=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(arch))&&!/\bi686\b/i.test(arch)){if(os){os.architecture=64;os.family=os.family.replace(RegExp(' *'+data),'');}
if(name&&(/\bWOW64\b/i.test(ua)||(useFeatures&&/\w(?:86|32)$/.test(nav.cpuClass||nav.platform)&&!/\bWin64; x64\b/i.test(ua)))){description.unshift('32-bit');}}
else if(os&&/^OS X/.test(os.family)&&name=='Chrome'&&parseFloat(version)>=39){os.architecture=64;}
ua||(ua=null);var platform={};platform.description=ua;platform.engine=layout&&layout[0];platform.manufacturer=manufacturer;platform.name=name;platform.prerelease=prerelease;platform.product=product;platform.ua=ua;platform.version=name&&version;platform.os=os||{'architecture':null,'family':null,'version':null,'toString':function(){return'null';}};platform.parse=parse;platform.toString=toStringPlatform;if(platform.version){description.unshift(version);}
if(platform.name){description.unshift(name);}
if(os&&name&&!(os==String(os).split(' ')[0]&&(os==name.split(' ')[0]||product))){description.push(product?'('+os+')':'on '+os);}
if(description.length){platform.description=description.join(' ');}
function popupsAllowed(){var allowed=false;if(!window.open)return;var w=window.open("about:blank","","directories=no,height=1,width=1,menubar=no,resizable=no,scrollbars=no,status=no,titlebar=no,left=0,top=0,location=no");if(w){allowed=true;w.close();}
return allowed;}
function isTouch(){try{document.createEvent("TouchEvent");return true;}
catch(e){return("ontouchstart"in window)?true:false;}}
function isMobile(){try{if(typeof navigator=='undefined')return false;if(typeof sessionStorage!='undefined'&&sessionStorage.desktop)
return false;else if(typeof localStorage!='undefined'&&localStorage.mobile)
return true;var mobile=['iphone','ipad','android','blackberry','nokia','opera mini','windows mobile','windows phone','iemobile'];for(var i in mobile)if(navigator.userAgent.toLowerCase().indexOf(mobile[i].toLowerCase())>0)return true;}catch(e){}
return false;}
global.jsVersion=1.0;function _detectJsVersion(){if(!document.write)return;document.write('<script language="JavaScript1.0">');document.write('jsVersion=1.0;');document.write('<\/script>');document.write('<script language="JavaScript1.1">');document.write('jsVersion=1.1;');document.write('<\/script>');document.write('<script language="JavaScript1.2">');document.write('jsVersion=1.2;');document.write('<\/script>');document.write('<script language="JavaScript1.3">');document.write('jsVersion=1.3;');document.write('<\/script>');document.write('<script language="JavaScript1.4">');document.write('jsVersion=1.4;');document.write('<\/script>');document.write('<script language="JavaScript1.5">');document.write('jsVersion=1.5;');document.write('<\/script>');document.write('<script language="JavaScript1.6">');document.write('jsVersion=1.6;');document.write('<\/script>');document.write('<script language="JavaScript1.7">');document.write('jsVersion=1.7;');document.write('<\/script>');document.write('<script language="JavaScript1.8">');document.write('jsVersion=1.8;');document.write('<\/script>');document.write('<script language="JavaScript2.0">');document.write('jsVersion=2.0;');document.write('<\/script>');}
function detectJsVersion(){_detectJsVersion();}
detectJsVersion();platform.jsVersion=function(){return jsVersion};if(typeof navigator!='undefined')
platform.hasWebRTC=(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)?1:undefined;platform.touch=isTouch();platform.mobile=isMobile();platform.geoloc=(typeof navigator!='undefined'&&navigator.geolocation&&typeof navigator.geolocation.getCurrentPosition=='function')?true:false;return platform;}
var platform=parse();}else{var platform={}}
module.exports=platform;};BundleModuleCode['jam/analyzer']=function(module,exports){var Io=Require('com/io');var Comp=Require('com/compat');var Aios=none;var current=none;var util=Require('util');var options={version:'1.7.1',}
var out=function(msg){Io.out('[AJS] '+msg)};var corefuncs={act:{obj:{add:{argn:2},delete:{argn:1},update:{argn:2}}},add:{argn:2},angle:{argn:[1,2]},alt:{argn:[2,3],obj:{try:{argn:[2,3,4]}}},collect:{argn:2},concat:{argn:2},connectTo:{argn:1},copyto:{argn:2},delta:{argn:2},distance:{argn:[1,2]},empty:{argn:1},equal:{argn:2},Export:{argn:2},exists:{argn:1},filter:{argn:2,this:[1]},head:{argn:1},iter:{argn:2,this:[1]},Import:{argn:1},inp:{argn:[2,3],this:[1],obj:{try:{argn:[2,3,4]}}},kill:{argn:[0,1]},last:{argn:1},length:{argn:1},log:{argn:[1,2,3,4,5,6,7,8,9,10]},mark:{argn:2},map:{argn:2,this:[1]},matrix:{argn:[2,3]},max:{argn:[1,2]},me:{argn:0},min:{argn:[1,2]},myClass:{argn:0},myNode:{argn:0},myParent:{argn:0},myPosition:{argn:0},Number:{argn:1},object:{argn:1},out:{argn:1},opposite:{argn:1},privilege:{argn:0},random:{argn:[1,2,3]},reduce:{argn:2,this:[1]},reverse:{argn:1,this:[1]},rd:{argn:[2,3],this:[1],obj:{try:{argn:[2,3,4]}}},rm:{argn:[1,2]},send:{argn:[2,3]},sendto:{argn:[2,3]},sort:{argn:2,this:[1]},sleep:{argn:[0,1]},store:{argn:2},string:{argn:1},sum:{argn:[1,2]},tail:{argn:1},time:{argn:0},timer:{obj:{add:{argn:[2,3]},delete:{argn:1},update:{argn:2}}},try_alt:{argn:[2,3,4],this:[2]},try_inp:{argn:[2,3,4],this:[2]},try_rd:{argn:[2,3,4],this:[2]},ts:{argn:2},zero:{argn:1},B:{argn:[1,2],this:[0,1]},I:{argn:[3,4],this:[1,2,3]},L:{argn:[4,5],this:[1,2,3,4]},Vector:{argn:[1,2,3]}};function check_args(arguments,corefun){var len=arguments?arguments.length:0,passed=false;if(Comp.obj.isArray(corefun.argn))Comp.array.iter(corefun.argn,function(n){if(n==len)passed=true;});else passed=(len==corefun.argn);return passed;}
var jamc=function(options){};var properties={indexOf:'string.indexOf',push:'array.push',shift:'array.shift'}
var literals={none:'Literal',undefined:'Literal'}
literals['_']='Literal';var syntax={find:function(root,typ,name){if(root.type==typ&&root.id&&root.id.type=='Identifier'&&root.id.name==name)return root;switch(root.type){case'Program':return Comp.array.findmap(root.body,function(el){return syntax.find(el,typ,name)});break;case'VariableDeclaration':return Comp.array.findmap(root.declarations,function(el){return syntax.find(el,typ,name)});break;}
return null;},location:function(elem,short){var str='';if(elem.loc){if(elem.loc.start)str='line '+(elem.loc.start.line+syntax.offset)+', position '+elem.loc.start.column;if(elem.loc.end)str+=' to line '+(elem.loc.end.line+syntax.offset)+', position '+elem.loc.end.column;return str;}else return"unknown location";},name:function(elem){switch(elem.type){case'ThisExpression':return'this';case'Identifier':return elem.name;case'MemberExpression':return syntax.name(elem.object)+'.'+syntax.name(elem.property);default:return elem.toString();}},offset:0}
jamc.prototype.syntax=syntax;jamc.prototype.analyze=function(syntax,_options){var self=this,classname=_options.classname,level=_options.level,ep,elem,cp,declarator,ac,val,syms={id:{type:'Literal'},ac:{type:'Literal'}},nextVal,transObj,actObj,subclassObj,transitions={},activities={},subclasses,aios,options={},errors=[],verbose=_options.verbose||0,err=function(msg){errors.push(msg);(_options.err||this.err||Io.err)(msg)},out=_options.out||this.out||Io.out,warn=_options.warn||this.warn||Io.warn;switch(level){case 0:aios=Aios.aios0;break;case 1:aios=Aios.aios1;break;case 2:aios=Aios.aios2;break;case 3:aios=Aios.aios3;break;}
function unwrap(elem){switch(elem.type){case'BlockStatement':if(elem.body.length==1)return elem.body[0];else return elem;break;default:return elem;}}
function isThisExpr(elem){switch(elem.type){case'MemberExpression':return isThisExpr(elem.object);case'ThisExpression':return true;}
return false;}
function isEmpty(o){if(!o)return true;for(var p in o){if(o[p]!=undefined)return false;};return true;}
function iterMemberExpression(elem,options){var part,corefun,obj;switch(elem.type){case'Identifier':if(!aios[elem.name]&&!corefuncs[elem.name])
err('['+classname+'] Call of undefined function: '+
elem.name+', in level '+level+' ,at '+self.syntax.location(elem));else if(corefuncs[elem.name]){corefun=corefuncs[elem.name];if(!check_args(options.arguments,corefun)){err('['+classname+']: Call of AIOS function '+elem.name+' with invalid number of arguments, '+'(expecting '+(corefun.argn.toString())+' argument(s), got '+options.arguments.length+'), in level '+level+' ,at '+self.syntax.location(elem));}
return aios[elem.name];}else return aios[elem.name];break;case'MemberExpression':switch(elem.object.type){case'ThisExpression':if(!syms[elem.property.name]||syms[elem.property.name].context!='ThisExpression')
err("['+classname+'] Undefined 'this' reference: "+
elem.property.name+', at '+self.syntax.location(elem));if(syms[elem.property.name].type=='ObjectExpression'){var Osyms={};Comp.array.iter(syms[elem.property.name].properties,function(p){Osyms[p.key.name]=p.type;});if(!isEmpty(Osyms))
return Osyms;else
return none;}else return none;break;case'Identifier':if(!aios[elem.object.name]&&!corefuncs[elem.object.name]&&!options.syms[elem.object.name]){err('['+classname+'] Access of undefined object variable: '+
elem.object.name+', in level '+level+' ,at '+self.syntax.location(elem));}
if(properties[elem.property.name])return undefined;if(elem.computed)return undefined;if(corefuncs[elem.object.name]){obj=corefuncs[elem.object.name].obj||corefuncs[elem.object.name];if(!obj[elem.property.name]){err('['+classname+'] Access of unknown AIOS(corefuncs) object attribute: '+
elem.object.name+'.'+elem.property.name+', in level '+level+' ,at '+self.syntax.location(elem));}
return obj[elem.property.name];}else if(aios[elem.object.name]){obj=aios[elem.object.name].obj||aios[elem.object.name];if(!obj[elem.property.name])
err('['+classname+'] Access of unknown AIOS object attribute: '+
elem.object.name+'.'+elem.property.name+', in level '+level+' ,at '+self.syntax.location(elem));return obj[elem.property.name];}
else if(options.syms[elem.object.name]){return none;}
return;break;case'MemberExpression':part=iterMemberExpression(elem.object,options);if(part&&part.obj)part=part.obj;if(!elem.computed&&part&&!part[elem.property.name]&&!properties[elem.property.name]){err('['+classname+'] Access of unknown object attribute: '+
self.syntax.name(elem)+' ('+elem.property.name+'), in level '+
level+' ,at '+self.syntax.location(elem));}
if(elem.computed)check(elem.property,{reference:true,syms:options.syms});if(part&&(typeof part[elem.property.name]=='object')&&!isEmpty(part[elem.property.name]))
return part[elem.property.name];else
return none;break;}
break;}
return;}
function addDeclaration(elem,options){var ep,el;switch(elem.type){case'VariableDeclaration':for(ep in elem.declarations){el=elem.declarations[ep];if(!options.shadow[el.id.name])options.shadow[el.id.name]=options.syms[el.id.name];if(el.type=='VariableDeclarator'){if(el.id.type=='Identifier'){options.syms[el.id.name]=el;}}}
break;case'FunctionDeclaration':if(!options.shadow[elem.id.name])options.shadow[elem.id.name]=options.syms[elem.id.name];options.syms[elem.id.name]=elem;break;case'ForStatement':addDeclaration(elem.init,options);break;}}
function check(elem,options){var ep,el,name,thismaybe,shadow,locshadow;if(options.left&&options.this){switch(elem.type){case'Identifier':err('['+classname+'] Assignment may not contain free variables: var '+
elem.name+', at '+self.syntax.location(elem));break;case'MemberExpression':if(elem.object.type!='ThisExpression')
err('['+classname+'] Assignment may not contain non-this MemberExpression on left side: '+
self.syntax.name(elem.object)+', at '+self.syntax.location(elem));switch(elem.property.type){case'Identifier':if(syms[elem.property.name])
err('['+classname+'] Found duplicate property definition: '+
elem.property.name+' ('+syms[elem.property.name].type+'), at '+self.syntax.location(elem));else{syms[elem.property.name]=options.target;syms[elem.property.name].context=elem.object.type;}
switch(elem.property.name){case'act':actObj=options.target;break;case'trans':transObj=options.target;break;case'subclass':subclassObj=options.target;break;}
break;}
break;}}
else if(options.right&&options.this){switch(elem.type){case'Literal':case'Identifier':switch(options.target.property.name){case'next':val=elem.value||elem.name;if(!Comp.obj.isString(val))
err('['+classname+'] Invalid next property, expected string, got '+
val+', at '+self.syntax.location(elem));nextVal=val;break;}
break;case'ObjectExpression':switch(options.target.property.name){case'trans':for(ep in elem.properties){el=elem.properties[ep];if(el.type=='Property'){transitions[el.key.name]=el.value;}}
break;case'act':for(ep in elem.properties){el=elem.properties[ep];if(el.type=='Property'){if(aios[el.key.name])
err('['+classname+'] Activity name '+el.key.name+' shadows AIOS function or object, at '+self.syntax.location(elem));activities[el.key.name]=el.value;}}
break;case'subclass':subclasses={};for(ep in elem.properties){el=elem.properties[ep];if(el.type=='Property'){subclasses[el.key.name]=el.value;}}
break;}
break;case'FunctionExpression':locshadow={};for(ep in elem.params){param=elem.params[ep];if(param.type!='Identifier')
err('['+classname+'] Invalid function parameter type'+param.type+', expected Identifier'+', at '+self.syntax.location(elem));locshadow[param.name]=options.syms[param.name];options.syms[param.name]=param.type;}
check(elem.body,{funbody:true,this:true,syms:options.syms});for(ep in locshadow){options.syms[ep]=locshadow[ep];}
break;}}
else if(options.funbody&&options.this){elem=unwrap(elem);switch(elem.type){case'BlockStatement':if(options.shadow)shadow=options.shadow;options.shadow={};if(!options.syms)options.syms={};Comp.array.iter(elem.body,function(el){addDeclaration(el,options);});Comp.array.iter(elem.body,function(el){check(el,options)});if(options.syms)for(ep in options.shadow){options.syms[ep]=options.shadow[ep];}
options.shadow=shadow;break;case'ExpressionStatement':switch(elem.expression.type){case'AssignmentExpression':switch(elem.expression.left.type){case'MemberExpression':if(isThisExpr(elem.expression.left.object))
check(elem.expression.left,{this:true});break;case'Identifier':check(elem.expression.left,{reference:true,syms:options.syms});break;}
check(elem.expression.right,{reference:true,syms:options.syms});break;case'CallExpression':thismaybe=[];if(elem.expression.callee.object&&isThisExpr(elem.expression.callee.object)){check(elem.expression.callee,{this:true,funcall:true,arguments:elem.expression.arguments});}else{if(corefuncs[elem.expression.callee.name]&&corefuncs[elem.expression.callee.name].this)
{thismaybe=corefuncs[elem.expression.callee.name].this;}
if(options.syms[elem.expression.callee.name]){if(options.syms[elem.expression.callee.name].type!='FunctionDeclaration')
err('['+classname+'] Not a function:'+elem.expression.callee.name+', at '+self.syntax.location(elem));}else
check(elem.expression.callee,{funcall:true,external:true,syms:options.syms,arguments:elem.expression.arguments});}
Comp.array.iter(elem.expression.arguments,function(el,i){var ep,param,shadow;if(!Comp.array.member(thismaybe,i)){check(el,{reference:true,syms:options.syms});}else{switch(el.type){case'ArrayExpression':Comp.array.iter(el.elements,function(el_block,block_i){if(el_block.type!='FunctionExpression')
err('['+classname+'] Invalid argument '+(i+1)+' of AIOS core function '+
elem.expression.callee.name+': Expeceted FunctionExpression array, but got '+
el_block.type+' element (array index '+(block_i+1)+')'+', at '+self.syntax.location(elem));check(el_block.body,{funbody:true,this:true,syms:options.syms});});break;case'FunctionExpression':shadow={};for(ep in el.params){param=el.params[ep];if(param.type!='Identifier')
err('['+classname+'] Invalid function parameter type'+param.type+', expected Identifier'+', at '+self.syntax.location(elem));if(options.syms[param.name])shadow[param.name]=options.syms[param.name];options.syms[param.name]=param.type;}
check(el.body,{funbody:true,this:true,syms:options.syms});for(ep in shadow){options.syms[ep]=shadow[ep];}
break;case'ArrowFunctionExpression':shadow={};for(ep in el.params){param=el.params[ep];if(param.type!='Identifier')
err('['+classname+'] Invalid function parameter type'+param.type+', expected Identifier'+', at '+self.syntax.location(elem));if(options.syms[param.name])shadow[param.name]=options.syms[param.name];options.syms[param.name]=param.type;}
check(el.body,{funbody:true,this:true,syms:options.syms});for(ep in shadow){options.syms[ep]=shadow[ep];}
break;case'CallExpression':break;case'Identifier':break;default:err('['+classname+'] Invalid argument '+(i+1)+' of AIOS core function '+
elem.expression.callee.name+': Expeceted FunctionExpression, ArrowFunctionExpression, ArrayExpression, or Identifier, but got '+
el.type+', at '+self.syntax.location(elem));}}});break;case'UpdateExpression':check(elem.expression.argument,{reference:true,syms:options.syms});break;}
break;case'VariableDeclaration':if(!options.shadow)options.shadow={};for(ep in elem.declarations){el=elem.declarations[ep];if(!options.shadow[el.id.name])options.shadow[el.id.name]=options.syms[el.id.name];if(el.type=='VariableDeclarator'){if(el.id.type=='Identifier'){options.syms[el.id.name]=el;}}}
break;case'IfStatement':check(elem.consequent,options);if(elem.alternate)check(elem.alternate,options);check(elem.test,{reference:true,syms:options.syms});break;case'ForStatement':check(elem.body,options);check(elem.init,{reference:true,syms:options.syms});check(elem.test,{reference:true,syms:options.syms});check(elem.update,{reference:true,syms:options.syms});break;case'WhileStatement':check(elem.body,options);check(elem.test,{reference:true,syms:options.syms});break;case'ReturnStatement':if(elem.argument)
check(elem.argument,{reference:true,syms:options.syms});break;case'FunctionDeclaration':if(!options.shadow[elem.id.name])options.shadow[elem.id.name]=options.syms[elem.id.name];options.syms[elem.id.name]=elem;locshadow={};for(ep in elem.params){param=elem.params[ep];if(param.type!='Identifier')
err('['+classname+'] Invalid function parameter type'+param.type+', expected Identifier'+', at '+self.syntax.location(elem));locshadow[param.name]=options.syms[param.name];options.syms[param.name]=param.type;}
check(elem.body,{funbody:true,syms:options.syms});for(ep in locshadow){options.syms[ep]=locshadow[ep];}
break;}}
else if(options.funbody){elem=unwrap(elem);switch(elem.type){case'BlockStatement':if(options.shadow)shadow=options.shadow;options.shadow={};if(!options.syms)options.syms={};Comp.array.iter(elem.body,function(el){addDeclaration(el,options);});Comp.array.iter(elem.body,function(el){check(el,options)});if(options.syms)for(ep in options.shadow){options.syms[ep]=options.shadow[ep];}
options.shadow=shadow;break;case'ExpressionStatement':switch(elem.expression.type){case'AssignmentExpression':switch(elem.expression.left.type){case'MemberExpression':if(elem.expression.left.object&&isThisExpr(elem.expression.left.object))
check(elem.expression.left,{syms:options.syms});break;case'Identifier':check(elem.expression.left,{reference:true,syms:options.syms});break;}
check(elem.expression.right,{reference:true,syms:options.syms});break;case'CallExpression':thismaybe=[];if(elem.expression.callee.object&&isThisExpr(elem.expression.callee.object)){check(elem.expression.callee,{this:true,funcall:true,arguments:elem.expression.arguments});}else{if(corefuncs[elem.expression.callee.name]&&corefuncs[elem.expression.callee.name].this)
{thismaybe=corefuncs[elem.expression.callee.name].this;}
if(options.syms[elem.expression.callee.name]){if(options.syms[elem.expression.callee.name].type!='FunctionDeclaration')
err('['+classname+'] Not a function:'+elem.expression.callee.name+', at '+self.syntax.location(elem));}else
check(elem.expression.callee,{funcall:true,external:true,syms:options.syms,arguments:elem.expression.arguments});}
Comp.array.iter(elem.expression.arguments,function(el,i){var ep,param,shadow;if(!Comp.array.member(thismaybe,i)){check(el,{reference:true,syms:options.syms});}else{switch(el.type){case'ArrayExpression':Comp.array.iter(el.elements,function(el_block,block_i){if(el_block.type!='FunctionExpression')
err('['+classname+'] Invalid argument '+(i+1)+' of AIOS core function '+
elem.expression.callee.name+': Expeceted FunctionExpression array, but got '+
el_block.type+' element (array index '+(block_i+1)+')'+', at '+self.syntax.location(elem));check(el_block.body,{funbody:true,this:true,syms:options.syms});});break;case'FunctionExpression':shadow={};for(ep in el.params){param=el.params[ep];if(param.type!='Identifier')
err('['+classname+'] Invalid function parameter type'+param.type+', expected Identifier'+', at '+self.syntax.location(elem));if(options.syms[param.name])shadow[param.name]=options.syms[param.name];options.syms[param.name]=param.type;}
check(el.body,{funbody:true,this:true,syms:options.syms});for(ep in shadow){options.syms[ep]=shadow[ep];}
break;case'ArrowFunctionExpression':shadow={};for(ep in el.params){param=el.params[ep];if(param.type!='Identifier')
err('['+classname+'] Invalid function parameter type'+param.type+', expected Identifier'+', at '+self.syntax.location(elem));if(options.syms[param.name])shadow[param.name]=options.syms[param.name];options.syms[param.name]=param.type;}
check(el.body,{funbody:true,this:true,syms:options.syms});for(ep in shadow){options.syms[ep]=shadow[ep];}
break;case'CallExpression':break;case'Identifier':break;default:err('['+classname+'] Invalid argument '+(i+1)+' of AIOS core function '+
elem.expression.callee.name+': Expeceted FunctionExpression, ArrowFunctionExpression, ArrayExpression, or Identifier, but got '+
el.type+', at '+self.syntax.location(elem));}}});break;case'UpdateExpression':check(elem.expression.argument,{reference:true,syms:options.syms});break;}
break;case'VariableDeclaration':for(ep in elem.declarations){el=elem.declarations[ep];if(!options.shadow[el.id.name])options.shadow[el.id.name]=options.syms[el.id.name];if(el.type=='VariableDeclarator'){if(el.id.type=='Identifier'){options.syms[el.id.name]=el;}}}
break;case'IfStatement':check(elem.consequent,options);if(elem.alternate)check(elem.alternate,options);check(elem.test,{reference:true,syms:options.syms});break;case'ForStatement':check(elem.body,options);check(elem.init,{reference:true,syms:options.syms});check(elem.test,{reference:true,syms:options.syms});check(elem.update,{reference:true,syms:options.syms});break;case'WhileStatement':check(elem.body,options);check(elem.test,{reference:true,syms:options.syms});break;case'ReturnStatement':if(elem.argument)
check(elem.argument,{reference:true,syms:options.syms});break;case'FunctionDeclaration':if(!options.shadow[elem.id.name])options.shadow[elem.id.name]=options.syms[elem.id.name];options.syms[elem.id.name]=elem;locshadow={};for(ep in elem.params){param=elem.params[ep];if(param.type!='Identifier')
err('['+classname+'] Invalid function parameter type '+param.type+', expected Identifier'+', at '+self.syntax.location(elem));locshadow[param.name]=options.syms[param.name];options.syms[param.name]=param.type;}
check(elem.body,{funbody:true,syms:options.syms});for(ep in locshadow){options.syms[ep]=locshadow[ep];}
break;}}
else if(options.this){switch(elem.object.type){case'MemberExpression':check(elem.object,{this:true});break;case'ThisExpression':if(!syms[elem.property.name])
err('['+classname+"] Undefined 'this' reference: "+
elem.property.name+', at '+self.syntax.location(elem));if(options.funcall&&syms[elem.property.name].type!='FunctionExpression')
err('['+classname+"] Not a function: this."+
elem.property.name+', at '+self.syntax.location(elem));}}
else if(options.reference){switch(elem.type){case'Identifier':if(!options.syms[elem.name]&&!literals[elem.name]&&!aios[elem.name]&&!activities[elem.name])
err('['+classname+'] Undefined variable reference: '+
elem.name+', at '+self.syntax.location(elem));break;case'BinaryExpression':check(elem.left,options);check(elem.right,options);break;case'AssignmentExpression':switch(elem.left.type){case'MemberExpression':if(elem.left.object&&isThisExpr(elem.left.object))
check(elem.left,{this:true});break;case'Identifier':check(elem.left,{reference:true,syms:options.syms});break;}
check(elem.right,options);break;case'UpdateExpression':check(elem.argument,options);break;case'MemberExpression':switch(elem.object.type){case'ThisExpression':check(elem,{this:true,syms:options.syms});break;case'Identifier':check(elem.object,{reference:true,syms:options.syms});if(elem.computed)switch(elem.property.type){case'Identifier':check(elem.property,{reference:true,syms:options.syms});break;}
break;case'MemberExpression':iterMemberExpression(elem,options);}
break;case'ArrayExpression':Comp.array.iter(elem.elements,function(el2,i){if(el2)check(el2,{reference:true,syms:options.syms});});break;case'CallExpression':if(elem.callee.object&&isThisExpr(elem.callee.object)){check(elem.callee,{this:true,funobj:true,arguments:elem.arguments});}else{if(options.syms[elem.callee.name]){if(options.syms[elem.callee.name].type!='FunctionDeclaration')
err('['+classname+'] Not a function:'+elem.callee.name+', at '+self.syntax.location(elem));}else
check(elem.callee,{funcall:true,external:true,syms:options.syms,arguments:elem.arguments});}
Comp.array.iter(elem.arguments,function(el){check(el,{reference:true,syms:options.syms,arguments:elem.arguments})});break;}}
else if(options.funcall&&options.external){switch(elem.type){case'Identifier':case'MemberExpression':iterMemberExpression(elem,options);break;}}
else if(options.trans){switch(elem.type){case'BlockStatement':Comp.array.iter(elem.body,function(el){check(el,options)});break;case'IfStatement':check(elem.consequent,options);if(elem.alternate)check(elem.alternate,options);break;case'ReturnStatement':options.ret++;if(elem.argument)
check(elem.argument,options);else
if(verbose)warn('['+classname+'] Returns undefined in transition '+
options.trans+', at '+self.syntax.location(elem)+'.');break;case'Literal':if(!activities[elem.value])
err('['+classname+'] Returns unknown activity reference '+
elem.value+' in transition '+options.trans+', at '+self.syntax.location(elem)+'.');break;case'Identifier':if(!activities[elem.name])
err('['+classname+'] Returns unknown activity reference '+
elem.name+' in transition '+options.trans+', at '+self.syntax.location(elem)+'.');break;}}}
if(verbose)out('Analyzing agent class "'+classname+'" ..');if(syntax.type!='Program')
err('Syntax is not a program: '+syntax.type);loop1:for(ep in syntax.body){var elem=syntax.body[ep];if(elem.type!='VariableDeclaration')
err('Body element is not a variable declaration: '+elem.type);for(cp in elem.declarations){var declarator=elem.declarations[cp];if(declarator.type!='VariableDeclarator'){err('VariableDeclaration element is not a variable declarator: '+declarator.type);}
if(declarator.id.name!='ac')
err('['+classname+'] Entry not found, expected ac, got: '+declarator.id.name);else{ac=declarator;break loop1;};}}
if(!ac)
err('No agent class template found.');if(!ac.init||ac.init.type!='FunctionExpression')
err('['+classname+'] Entry is invalid, expected function, got: '+ac.init.type);if(ac.init.type!='FunctionExpression')
err('['+classname+'] Entry is invalid, expected function, got: '+ac.init.type);if(ac.init.body.type!='BlockStatement')
err('['+classname+'] Entry is invalid, expected function body, got: '+ac.init.body.type);loop2:for(ep in ac.init.body.body){var elem=ac.init.body.body[ep];switch(elem.type){case'VariableDeclaration':err('['+classname+'] May not contain free variable declarations: '+
Comp.printf.list(Comp.array.map(elem.declarations,function(decl){if(decl.type!='VariableDeclarator')return'?';else return'var '+self.syntax.name(decl.id)}))+', at '+self.syntax.location(elem));break;case'ExpressionStatement':switch(elem.expression.type){case'AssignmentExpression':check(elem.expression.left,{left:true,this:true,target:elem.expression.right});check(elem.expression.right,{right:true,this:true,target:elem.expression.left,syms:syms});break;case'MemberExpression':if(elem.expression.object&&elem.expression.object.type=='ThisExpression')
check(elem.expression,{left:true,this:true,target:{type:'undefined'}});break;}
break;default:err('['+classname+'] Invalid top-level '+elem.type+', at '+self.syntax.location(elem));break;}}
if(!syms['act']||syms['act'].type!='ObjectExpression')
err('['+classname+'] Found no or no valid activity section, expecting this.act={..}.');if(!syms['trans']||syms['trans'].type!='ObjectExpression')
err('['+classname+'] Found no or no valid transition section, expecting this.trans={..}.');if(syms['on']&&syms['on'].type!='ObjectExpression')
err('['+classname+'] Found invalid handler section, expecting this.on={..}.');if(!syms['on']&&verbose)
warn('['+classname+'] Found no handler section, expecting this.on={..}.');if(!nextVal)
err('['+classname+'] Found no next attribute, expecting  this.next="<nextact>".');if(!activities[nextVal])
err('['+classname+'] Found invalid next attribute pointing to undefined activity '+nextVal+'.');loop3A:for(ep in activities){var elem=activities[ep];if(!transitions[ep]&&verbose)warn('['+classname+'] No transition entry found for activity '+ep);switch(elem.type){case'FunctionExpression':options={funbody:true,this:true,syms:{}};check(elem.body,options);elem.syms=syms;break;case'ArrowFunctionExpression':options={funbody:true,this:true,syms:{}};check(elem.body,options);elem.syms=syms;break;default:err('['+classname+'] Found invalid activity entry, expecting FunctionExpression or ArrowFunctionExpression, got '+
elem.type+', at '+self.syntax.location(elem));}}
loop3B:for(ep in transitions){var elem=transitions[ep],opt;if(!activities[ep])
err('['+classname+'] Transition entry found referencing unknown activity: '+
ep+', at '+self.syntax.location(elem));switch(elem.type){case'Identifier':if(!activities[elem.name])
err('['+classname+'] Unknown transition found: '+
elem.name+', at '+self.syntax.location(elem));break;case'Literal':if(!activities[elem.value])
err('['+classname+'] Unknown transition found: '+
elem.value+', at '+self.syntax.location(elem));break;case'FunctionExpression':opt={trans:ep,ret:0};check(elem.body,opt);if(opt.ret==0&&verbose)
warn('['+classname+'] Missing return (undefined) in transition '+
opt.trans+', at '+self.syntax.location(elem)+'.');break;case'ArrowFunctionExpression':opt={trans:ep,ret:0};check(elem.body,opt);if(opt.ret==0&&verbose)
warn('['+classname+'] Missing return (undefined) in transition '+
opt.trans+', at '+self.syntax.location(elem)+'.');break;default:err('['+classname+'] Found invalid transition entry, expecting FunctionExpression or ArrowFunctionExpression, Identifier, or String Literal, got '+
elem.type+', at '+self.syntax.location(elem));}}
if(verbose)out(classname+' passed check.');if(verbose){out(classname+' has the following top-level object properties:');for(ep in syms){var sym=syms[ep];if(!sym)continue;out('       '+ep+' : '+sym.type);}
out(classname+' has the following activities:');for(ep in activities){var elem=activities[ep];out('       '+ep);}
out(classname+' next activity: '+nextVal);out(classname+' has the following transition entries:');for(ep in transitions){var elem=transitions[ep];out('       '+ep);}
if(subclasses){out(classname+' has the following subclass entries:');for(ep in subclasses){var elem=subclasses[ep];out('       '+ep);}}}
if(verbose>1){out(classname+' has the following top-level symbols:');for(ep in syms){if(!syms[ep])continue;out('       '+ep+':'+(verbose>2?Io.inspect(syms[ep]):syms[ep].type));}}
return{activities:activities,transitions:transitions,subclasses:subclasses,symbols:syms,errors:errors}}
module.exports={corefuncs:corefuncs,extend:function(funcs){var p;for(p in funcs){corefuncs[p]=funcs[p];}},jamc:jamc,options:options,current:function(module){current=module.current;Aios=module;}};};BundleModuleCode['com/getenv']=function(module,exports){var util=Require("util");var url=Require("url");var fallbacksDisabled=false;function _value(varName,fallback){var value=process.env[varName];if(value===undefined){if(fallback===undefined){throw new Error('GetEnv.Nonexistent: '+varName+' does not exist '+'and no fallback value provided.');}
if(fallbacksDisabled){throw new Error('GetEnv.DisabledFallbacks: '+varName+' relying on fallback '+'when fallbacks have been disabled');}
return''+fallback;}
return value;}
var convert={string:function(value){return''+value;},int:function(value){var isInt=value.match(/^-?\d+$/);if(!isInt){throw new Error('GetEnv.NoInteger: '+value+' is not an integer.');}
return+value;},float:function(value){var isInfinity=(+value===Infinity||+value===-Infinity);if(isInfinity){throw new Error('GetEnv.Infinity: '+value+' is set to +/-Infinity.');}
var isFloat=!(isNaN(value)||value==='');if(!isFloat){throw new Error('GetEnv.NoFloat: '+value+' is not a number.');}
return+value;},bool:function(value){var isBool=(value==='true'||value==='false');if(!isBool){throw new Error('GetEnv.NoBoolean: '+value+' is not a boolean.');}
return(value==='true')},boolish:function(value){try{return convert.bool(value)}
catch(err){var isBool=(value==='1'||value==='0');if(!isBool){throw new Error('GetEnv.NoBoolean: '+value+' is not a boolean.');}
return(value==='1');}},url:url.parse};function converter(type){return function(varName,fallback){if(typeof varName=='string'){var value=_value(varName,fallback);return convert[type](value);}else{return getenv.multi(varName);}};};var getenv=converter('string');Object.keys(convert).forEach(function(type){getenv[type]=converter(type);});getenv.array=function array(varName,type,fallback){type=type||'string';if(Object.keys(convert).indexOf(type)===-1){throw new Error('GetEnv.ArrayUndefinedType: Unknown array type '+type);}
var value=_value(varName,fallback);return value.split(/\s*,\s*/).map(convert[type]);};getenv.multi=function multi(spec){var key,value;var result={};for(var key in spec){var value=spec[key];if(util.isArray(value)){switch(value.length){case 1:case 2:result[key]=getenv(value[0],value[1]);break;case 3:result[key]=getenv[value[2]](value[0],value[1]);break;default:throw('getenv.multi(): invalid spec');break;}}else{result[key]=getenv(value);}}
return result;};getenv.disableFallbacks=function(){fallbacksDisabled=true;};getenv.enableFallbacks=function(){fallbacksDisabled=false;};module.exports=getenv;};BundleModuleCode['os/url']=function(module,exports){function Url(url){this.parse(url);}
Url.parseSearch=function(search){var query={};if(search.length>1){search.slice(1).split('&').forEach(function(s){var pair=s.split('=');var key=decodeURIComponent(pair[0]);var value=pair.length==1?'':decodeURIComponent(pair[1]);if(query[key]==undefined){query[key]=value;}else{if(query[key].constructor!=Array)
query[key]=[query[key]];query[key].push(value);}});}
return query;};Url.formatSearch=function(query){var search='';for(var p in query){[].concat(query[p]).forEach(function(val){if(val==null)
return;search+='&'+encodeURIComponent(p);if(val!=='')
search+='='+encodeURIComponent(val);});}
return search?'?'+search.slice(1):'';};Url.prototype={parse:function(url){if(!url){var obj=location;}else{var obj=document.createElement('a');obj.href=url;obj.href=obj.href;}
this.protocol=obj.protocol;this.hostname=obj.hostname;this.port=obj.port;this.search=obj.search;this.hash=obj.hash;this.query=Url.parseSearch(obj.search);this.pathname=obj.pathname;if(this.pathname.charAt(0)!='/'){this.pathname='/'+this.pathname;}},get host(){return this.hostname+(this.port?':'+this.port:'');},set host(h){h=h.split(':');this.hostname=h[0];if(h[1]){this.port=h[1];}},get port(){return this._port;},set port(p){if((this.protocol=='http:'&&p=='80')||(this.protocol=='https:'&&p=='443')){p='';}
this._port=p||'';},get href(){return this.format();},set href(url){this.parse(url);},get search(){return Url.formatSearch(this.query);},set search(s){this.query=Url.parseSearch(s);},set:function(key,value){this[key]=value;return this;},format:function(){return this.protocol+'//'+this.host+this.pathname+this.search+this.hash;},addQuery:function(name,value){if(name!=null){if(name.constructor==String){var obj={};obj[name]=value;}else{var obj=name;}
for(var p in obj){this.query[p]=obj[p];}}
return this;},removeQuery:function(){for(var i=arguments.length-1;i>=0;i--){delete this.query[arguments[i]];}
return this;},setQuery:function(query){this.query=query;return this;},valueOf:function(){return this.format();},toString:function(){return this.format();}};if(typeof module!='undefined'&&module.exports){module.exports=Url;}};BundleModuleCode['ui/app/app']=function(module,exports){var Io=Require('com/io');var Comp=Require('com/compat');var blessed=Require('term/blessed');var options={version:'1.8.2'}
var LAYOUT={SMALL:'small',NORMAL:'normal',LARGE:'large',XLARGE:'xlarge',PORTRAIT:'portrait',LANDSCAPE:'landscape',from:function(screen){if(screen.width>screen.height){if(screen.width<70)return{small:true,landscape:true};else return{normal:true,landscape:true};}else{if(screen.height<70)return{small:true,portrait:true};else return{normal:true,portrait:true};}}}
function UI(options){var self=this,i;if(!(this instanceof UI)){return new UI(options);}
this.options=options||{};if(!this.options.pages)this.options.pages=1;if(!this.options.terminal){this.options.terminal=(process.platform==='win32'?'windows-ansi':'xterm-color');}
if(this.options.forceCursor==undefined)this.options.forceCursor=true;this.page=1;this.pages=[];this.static={};this.styles=options.styles||{};for(i=0;i<=this.options.pages;i++){this.pages.push({});}
this.pages.show=function(page){var thepage,p,current=self.page;switch(page){case'prev':if(self.pages[self.page]&&self.pages[self.page].prev)page=self.pages[self.page].prev;else if(self.pages[self.page-1])page=self.page-1;break;case'next':if(self.pages[self.page]&&self.pages[self.page].next)page=self.pages[self.page].next;else if(self.pages[self.page+1])page=self.page+1;break;case'this':case undefined:page=self.page;break;}
thepage=self.pages[page];if(self.events[page]&&self.events[page]['load'])
self.events[page]['load']();for(p in thepage){if(thepage[p]&&thepage[p].show&&!thepage[p].noshow)thepage[p].show();}
self.screen.render();self.page=page;};this.pages.hide=function(page){var thepage,p;if(page=='this'||page==undefined)page=self.page;thepage=self.pages[page];for(p in thepage)
if(thepage[p]&&thepage[p].hide)thepage[p].hide();if(self.options.terminal.indexOf('xterm')!=-1&&self.options.forceCursor)
self.screen.program.hideCursor(true);};this.events=[];this.pages.on=function(page,event,callback){if(!self.events[page])self.events[page]=[];self.events[page][event]=callback;}}
UI.prototype.button=function(options){var self=this,width=options.width;if(Comp.obj.isString(options.width)){width=Comp.pervasives.int_of_string(options.width);width=this.screen.width*width/100;}
var obj=blessed.button({width:options.width||(options.content.length+4),left:(options.center?int(this.screen.width/2-width/2):options.left),right:options.right,top:options.top||0,height:3,align:'center',content:options.content||'?',mouse:true,focus:false,border:options.border||this.getStyle('button.border',{type:'line'}),style:{fg:options.fg||this.getStyle('button.fg','white'),bg:options.bg||this.getStyle('button.bg','blue'),bold:true,border:{fg:this.getStyle('button.border.fg','black'),bg:this.getStyle('button.border.bg',undefined),},hover:{border:{fg:'red'}}}});obj.noshow=options.hidden;this.screen.append(obj);if(options.click)obj.on('press',options.click);if(options.action){switch(typeof options.action){case'function':obj.on('press',options.action);break;case'string':if(options.action=='next'||options.action=='prev'){obj.on('press',function(){if(self.pages[self.page][options.action]){self.pages.hide('this');self.pages.show(self.pages[self.page][options.action]);}});}else{obj.on('press',function(){if(self.pages[options.action]){self.pages.hide('this');self.pages.show(options.action);}});}
break;}}
return obj;}
UI.prototype.chat=function(options){var self=this,width=options.width||(this.screen.width-(options.left*2||2));options.scrollable=true;options.scrollbar={ch:' ',track:{bg:'yellow'},style:{fg:'cyan',inverse:true}};options.mouse=true;var obj=blessed.chat({label:options.label||'My Text',value:options.value||'',bg:'default',barBg:'default',barFg:'blue',width:width,height:options.height||8,left:(options.center?int(this.screen.width/2-width/2):options.left),right:options.right,top:options.top||0,keys:true,vi:false,mouse:true,inputOnFocus:true,tags:true,focus:true,wrap:options.wrap,multiline:true,scrollbar:options.scrollbar,scrollable:options.scrollable,prompt:options.prompt,border:this.getStyle('input.border',{type:'line'}),style:{fg:options.fg||this.getStyle('input.fg','blue'),bg:options.bg||this.getStyle('input.bg',undefined),user:options.user,bot:options.bot,border:{fg:this.getStyle('input.border.fg','black'),bg:this.getStyle('input.border.bg',undefined),},label:this.getStyle('input.label',undefined),focus:{border:{fg:'red'}}}});obj.noshow=options.hidden;this.screen.append(obj);obj.on('focus',function(){if(!self.options.keyboard)
return self.options.terminal.indexOf('xterm')!=-1&&self.options.forceCursor?self.screen.program._write('\x1b[?12;25h'):0;if(!self._keyboard)
self._keyboard=self.keyboard({width:self.screen.width<60?'100%':'80%',height:self.layout.small?'100%':'90%',compact:self.layout.small});self._keyboard.setCallback(function(v){if(v)obj.setValue(v),obj.update();});self._keyboard.setValue(obj.getValue());self._keyboard.setLabel(obj.getLabel());self._keyboard.show();});return obj;}
UI.prototype.checkbox=function(options){var obj=blessed.checkbox({checked:options.value||false,left:options.left,right:options.right,top:options.top||0,mouse:true,inputOnFocus:true,height:1,text:options.text||'empty'});obj.noshow=options.hidden;this.screen.append(obj);return obj;}
UI.prototype.dialog=function(options){var width=options.width,height=options.height;if(Comp.obj.isString(options.width)){width=Comp.pervasives.int_of_string(options.width);width=int(this.screen.width*width/100);}
if(Comp.obj.isString(options.height)){height=Comp.pervasives.int_of_string(options.height);height=int(this.screen.height*height/100);}
var obj=blessed.Question({width:width,left:(options.center?int(this.screen.width/2-width/2):options.left),right:options.right,top:options.top||(options.center?int(this.screen.height/2-height/2):0),height:height,noshow:true,okButton:options.okButton||'Okay',cancelButton:options.cancelButton,style:{bg:this.getStyle('dialog.bg','red'),fg:this.getStyle('dialog.fg','white'),bold:true}});this.screen.append(obj);return obj;}
UI.prototype.fileManager=function(options){if(options.box){options.box.border=this.getStyle('filemanager.box.border',options.box.border);options.box.bg=this.getStyle('filemanager.box.bg',options.box.bg);options.input=this.getStyle('filemanager.input',options.input);}
if(options.arrows){options.arrows.fg=this.getStyle('filemanager.arrows.fg',options.arrows.fg);options.arrows.bg=this.getStyle('filemanager.arrows.bg',options.arrows.bg);}
var obj=blessed.FileManager({parent:options.parent,border:options.border||this.getStyle('filemanager.border',{}),style:{fg:options.fg||this.getStyle('filemanager.fg',undefined),bg:options.bg||this.getStyle('filemanager.bg',undefined),label:options.label||this.getStyle('filemanager.label',undefined),selected:{bg:'blue',fg:'white'},focus:{border:{fg:'red'}}},height:options.height||'half',width:options.width||'half',top:options.top||'center',left:options.left||'center',label:'%path',cwd:options.cwd||process.env.PWD||process.env.CWD||process.env.HOME,autohide:options.autohide,hidden:options.hidden,noshow:options.hidden,keys:true,vi:true,scrollbar:{bg:'white',ch:' '},okayButton:options.okayButton||'OK',cancelButton:options.cancelButton||'Cancel',input:options.input,arrows:options.arrows,box:options.box,border:this.getStyle('filemanager.border',undefined)});this.screen.append(obj);return obj;}
UI.prototype.filterOptions=function(options,wname){var self=this,attr,wopts={};for(attr in options){switch(attr){case'type':case'index':break;case'on':switch(options.type){case'button':if(options.on.click&&typeof options.on.click=='function')
wopts.click=function(){options[attr](wname)};if(options.on.onclick&&typeof options.on.onclick=='function')
wopts.click=function(){options[attr](wname)};break;}
break;case'click':case'onclick':switch(options.type){case'button':if(typeof options[attr]=='string')
wopts.click=function(){if(!self.pages[options[attr]])return;self.pages.hide('this');self.pages.show(options[attr]);};else
wopts.click=options[attr];break;}
break;default:wopts[attr]=options[attr];}}
return wopts;}
UI.prototype.getStyle=function(attr,def){var path=attr.split('.'),elem,style=this.styles;while(path.length&&style){elem=path.shift();style=style[elem];}
return style!=undefined?style:def;}
UI.prototype.info=function(options){var width=options.width;if(Comp.obj.isString(options.width)){width=Comp.pervasives.int_of_string(options.width);width=this.screen.width*width/100;}
if(options.scrollable&&!options.scrollbar){options.scrollbar={ch:' ',track:{bg:'yellow'},style:{fg:'cyan',inverse:true}};options.mouse=true;}
var obj=blessed.textbox({top:options.top||1,left:(options.center?int(this.screen.width/2-width/2):options.left||(options.right?undefined:1)),right:options.right,width:options.width||(this.screen.width-(options.left*2||2)),height:options.height||3,label:options.label,value:options.value||'',focus:true,wrap:options.wrap,multiline:options.multiline,scrollbar:options.scrollbar,scrollable:options.scrollable,mouse:options.mouse,border:this.getStyle('info.border',{type:'line'}),style:{fg:options.fg||this.getStyle('info.fg','blue'),bg:options.bg||this.getStyle('info.bg',undefined),label:this.getStyle('info.label',undefined),border:{fg:this.getStyle('info.border.fg','black'),bg:this.getStyle('info.border.bg',undefined),},}});obj.noshow=options.hidden;this.screen.append(obj);return obj;}
UI.prototype.init=function(){var self=this;this.screen=blessed.screen({smartCSR:false,terminal:this.options.terminal,forceCursor:this.options.forceCursor,});this.screen.title=this.options.title||'APP (C) Stefan Bosse';this.screen.cursor.color='red';this.layout=LAYOUT.from(this.screen);if(this.options.terminal.indexOf('xterm')!=-1&&this.options.forceCursor)
process.on('exit',function(){self.screen.program._write('\x1b[?12;25h')});}
UI.prototype.input=function(options){var self=this,width=options.width||(this.screen.width-(options.left*2||2));var obj=blessed.textbox({label:options.label||'My Input',value:options.value||'',bg:'default',barBg:'default',barFg:'blue',width:width,height:options.height||3,left:(options.center?int(this.screen.width/2-width/2):options.left),right:options.right,top:options.top,bottom:options.bottom,keys:true,mouse:true,inputOnFocus:true,focus:true,wrap:options.wrap,multiline:options.multiline,border:this.getStyle('input.border',{type:'line'}),style:{fg:options.fg||this.getStyle('input.fg','blue'),bg:options.bg||this.getStyle('input.bg',undefined),border:{fg:this.getStyle('input.border.fg','black'),bg:this.getStyle('input.border.bg',undefined),},label:this.getStyle('input.label',undefined),focus:{border:{fg:'red'}}}});obj.noshow=options.hidden;this.screen.append(obj);obj.on('focus',function(){if(!self.options.keyboard)
return self.options.terminal.indexOf('xterm')!=-1&&self.options.forceCursor?self.screen.program._write('\x1b[?12;25h'):0;if(!self._keyboard)
self._keyboard=self.keyboard({width:self.screen.width<60?'100%':'80%',height:self.layout.small?'100%':'90%',compact:self.layout.small});self._keyboard.setCallback(function(v){if(v)obj.setValue(v),obj.update();});self._keyboard.setValue(obj.getValue());self._keyboard.setLabel(obj.getLabel());self._keyboard.show();});return obj;}
UI.prototype.keyboard=function(options){var obj=blessed.keyboard({parent:options.parent||this.screen,border:'line',height:options.height||'half',width:options.width||'half',top:options.top||'center',left:options.left||'center',label:'Keyboard',hidden:options.hidden,compact:options.compact,okayButton:options.okayButton||'OK',cancelButton:options.cancelButton||(this.layout.small?'CAN':'Cancel'),delButton:'DEL',shiftButton:'>>',border:options.border||this.getStyle('keyboard.border',{}),style:{bg:options.bg||this.getStyle('keyboard.bg',undefined),label:options.label||this.getStyle('keyboard.label',undefined),}});this.screen.append(obj);return obj;}
UI.prototype.label=function(options){var obj=blessed.text({width:options.width||(options.content.length),left:(options.center?int(this.screen.width/2-options.content.length/2):options.left),right:options.right,top:options.top||0,height:options.height||1,focus:false,align:'center',content:options.content||'?',style:{bg:options.style?options.style.bg:this.getStyle('label.bg',undefined),fg:options.style?options.style.fg:this.getStyle('label.fg',undefined),bold:this.getStyle('label.bold',false)}});if(options.mutable)
obj.setValue=function(content){obj.setContent('');obj.position.left=(options.center?int(this.screen.width/2-content.length/2):options.left);obj.setContent(content);};obj.noshow=options.hidden;this.screen.append(obj);return obj;}
UI.prototype.list=function(options){var obj=blessed.list({top:options.top,left:options.left,width:options.width||(this.screen.width-options.left*2),height:options.height||(this.screen.height-options.top-4),label:options.label||'Log',focus:true,mouse:true,keys:true,arrows:options.arrows,border:this.getStyle('list.border',{type:'line'}),style:{bg:options.bg||this.getStyle('list.bg',undefined),selected:options.selected||{fg:'white',bg:'red',bold:true},item:options.item||{bold:true},border:{fg:this.getStyle('list.border.fg','black')},label:this.getStyle('list.label',undefined),hover:{border:{fg:'red'}},focus:{border:{fg:'red'}}}});obj.noshow=options.hidden;obj.set=obj.update=function(data){var p,items=[];obj.clearItems();if(Comp.obj.isArray(data))items=data;else for(p in data){items.push(p);}
obj.setItems(items);obj.screen.render();}
this.screen.append(obj);return obj;}
UI.prototype.log=function(options){if(options.top==undefined)options.top=2;if(options.left==undefined&&options.right==undefined)options.left=1;var obj=blessed.log({top:options.top,left:options.left,right:options.right,width:options.width||(this.screen.width-options.left*2),height:options.height||(this.screen.height-options.top-4),label:options.label||'Log',mouse:true,keys:true,scrollback:options.scrollback||100,border:this.getStyle('log.border',{type:'line'}),scrollbar:{ch:' ',track:{bg:'yellow'},style:{fg:'cyan',inverse:true}},alwaysScroll:true,scrollOnInput:true,style:{fg:options.fg||this.getStyle('log.fg','white'),bg:options.bg||this.getStyle('log.bg','black'),label:this.getStyle('log.label',undefined),border:{fg:this.getStyle('log.border.fg','green'),bg:this.getStyle('log.border.bg',undefined),},focus:{border:{fg:'red'}}},arrows:options.arrows,});obj.noshow=options.hidden;this.screen.append(obj);return obj;}
UI.prototype.postOptions=function(options,widget,wname){var self=this,attr;for(attr in options){switch(attr){case'on':switch(options.type){case'checkbox':if(options.on.click&&typeof options.on.click=='function')
widget.on('check',function(){options.on.click(wname,true)}),widget.on('uncheck',function(){options.on.click(wname,false)});if(options.on.onclick&&typeof options.on.onclick=='function')
widget.on('check',function(){options.on.onclick(wname,true)}),widget.on('uncheck',function(){options.on.onclick(wname,false)});if(options.on.check&&typeof options.on.check=='function')
widget.on('check',function(){options.on.check(wname,true)});if(options.on.uncheck&&typeof options.on.uncheck=='function')
widget.on('uncheck',function(){options.on.uncheck(wname,false)});if(options.on.selected&&typeof options.on.selected=='function')
widget.on('selected',function(data){options.on.uncheck(wname,data)});if(options.on.change&&typeof options.on.change=='function')
widget.on('change',function(data){options.on.change(wname,data)});break;}
break;case'click':case'onclick':switch(options.type){case'checkbox':if(typeof options[attr]=='function')
widget.on('check',function(){options[attr](wname,true)}),widget.on('uncheck',function(){options[attr](wname,false)})
break;case'list':if(typeof options[attr]=='function')
widget.on('selected',function(data){options[attr](wname,data.content,data)})
break;case'tree':if(typeof options[attr]=='function')
widget.on('selected',function(data){var _data=data,path=data.name;data=data.parent;while(data)
path=data.name+(data.name!='/'?'/':'')+path,data=data.parent;options[attr](wname,_data.name,path,_data)})
break;}
break;case'onchange':switch(options.type){case'input':if(typeof options[attr]=='function')
widget.on('change',function(data){var content=widget.getContent();options[attr](wname,content)})
break;}
break;}}}
UI.prototype.radiobutton=function(options){var obj=blessed.radiobutton({checked:options.value||false,left:options.left,right:options.right,top:options.top||0,group:options.group,mouse:true,inputOnFocus:true,height:1,text:options.text||'empty'});obj.noshow=options.hidden;this.screen.append(obj);return obj;}
UI.prototype.start=function(main){var self=this;if(main==undefined)main=this.pages.main?'main':null;Object.keys(this.pages).forEach(function(page){if(typeof self.pages[page]!='object')return;if(Object.keys(self.pages[page]).length==0)return;self.pages.hide(page);if(!main)main=page;});if(main)this.pages.show(main);this.screen.render();this.screen.program.hideCursor(this.options.terminal.indexOf('xterm')!=-1&&this.options.forceCursor);}
UI.prototype.status=function(options){var self=this,width=options.width||(this.screen.width-(options.left*2||2));var obj=blessed.textbox({label:options.label||'My Input',value:options.value||'',bg:'default',barBg:'default',barFg:'blue',width:width,height:options.height||3,left:(options.center?int(this.screen.width/2-width/2):options.left),right:options.right,top:options.top,bottom:options.bottom,wrap:options.wrap,multiline:options.multiline,border:this.getStyle('input.border',{type:'line'}),style:{fg:options.fg||this.getStyle('input.fg','blue'),bg:options.bg||this.getStyle('input.bg',undefined),border:{fg:this.getStyle('input.border.fg','black'),bg:this.getStyle('input.border.bg',undefined),},label:this.getStyle('input.label',undefined),focus:{border:{fg:'red'}}}});obj.noshow=options.hidden;this.screen.append(obj);return obj;}
UI.prototype.table=function(options){if(options.top==undefined)options.top=2;if(options.left==undefined&&options.right==undefined)options.left=1;var obj=blessed.table({top:options.top,left:options.left,right:options.right,width:options.width||(this.screen.width-options.left*2),height:options.height||(this.screen.height-options.top-4),label:options.label||'Table',data:options.data,border:this.getStyle('table.border',{type:'line'}),style:{fg:options.fg||this.getStyle('log.fg','white'),bg:options.bg||this.getStyle('log.bg','black'),label:this.getStyle('log.label',undefined),border:{fg:this.getStyle('log.border.fg','green'),bg:this.getStyle('log.border.bg',undefined),},header:options.header,cell:options.cell,focus:{border:{fg:'red'}}},});obj.noshow=options.hidden;this.screen.append(obj);return obj;}
UI.prototype.terminal=function(options){var self=this,width=options.width||(this.screen.width-(options.left*2||2));options.scrollable=true;if(options.scrollable&&!options.scrollbar){options.scrollbar={ch:' ',track:{bg:'yellow'},style:{fg:'cyan',inverse:true}};options.mouse=true;}
var obj=blessed.terminal({label:options.label||'My Text',value:options.value||'',bg:'default',barBg:'default',barFg:'blue',width:width,height:options.height||8,left:(options.center?int(this.screen.width/2-width/2):options.left),right:options.right,top:options.top||0,keys:true,vi:false,mouse:true,inputOnFocus:true,focus:true,wrap:options.wrap,multiline:true,scrollbar:options.scrollbar,scrollable:options.scrollable,prompt:options.prompt,border:this.getStyle('input.border',{type:'line'}),style:{fg:options.fg||this.getStyle('input.fg','blue'),bg:options.bg||this.getStyle('input.bg',undefined),border:{fg:this.getStyle('input.border.fg','black'),bg:this.getStyle('input.border.bg',undefined),},label:this.getStyle('input.label',undefined),focus:{border:{fg:'red'}}}});obj.noshow=options.hidden;this.screen.append(obj);obj.on('focus',function(){if(!self.options.keyboard)
return self.options.terminal.indexOf('xterm')!=-1&&self.options.forceCursor?self.screen.program._write('\x1b[?12;25h'):0;if(!self._keyboard)
self._keyboard=self.keyboard({width:self.screen.width<60?'100%':'80%',height:self.layout.small?'100%':'90%',compact:self.layout.small});self._keyboard.setCallback(function(v){if(v)obj.setValue(v),obj.update();});self._keyboard.setValue(obj.getValue());self._keyboard.setLabel(obj.getLabel());self._keyboard.show();});return obj;}
UI.prototype.text=function(options){var self=this,width=options.width||(this.screen.width-(options.left*2||2));if(options.scrollable&&!options.scrollbar){options.scrollbar={ch:' ',track:{bg:'yellow'},style:{fg:'cyan',inverse:true}};options.mouse=true;}
var obj=blessed.textarea({label:options.label||'My Text',value:options.value||'',bg:'default',barBg:'default',barFg:'blue',width:width,height:options.height||8,left:(options.center?int(this.screen.width/2-width/2):options.left),right:options.right,top:options.top||0,keys:true,vi:false,mouse:true,inputOnFocus:true,focus:true,wrap:options.wrap,multiline:true,scrollbar:options.scrollbar,scrollable:options.scrollable,border:this.getStyle('input.border',{type:'line'}),style:{fg:options.fg||this.getStyle('input.fg','blue'),bg:options.bg||this.getStyle('input.bg',undefined),border:{fg:this.getStyle('input.border.fg','black'),bg:this.getStyle('input.border.bg',undefined),},label:this.getStyle('input.label',undefined),focus:{border:{fg:'red'}}}});obj.noshow=options.hidden;this.screen.append(obj);obj.on('focus',function(){if(!self.options.keyboard)
return self.options.terminal.indexOf('xterm')!=-1&&self.options.forceCursor?self.screen.program._write('\x1b[?12;25h'):0;if(!self._keyboard)
self._keyboard=self.keyboard({width:self.screen.width<60?'100%':'80%',height:self.layout.small?'100%':'90%',compact:self.layout.small});self._keyboard.setCallback(function(v){if(v)obj.setValue(v),obj.update();});self._keyboard.setValue(obj.getValue());self._keyboard.setLabel(obj.getLabel());self._keyboard.show();});return obj;}
UI.prototype.tree=function(options){var obj=blessed.tree({top:options.top,left:options.left,width:options.width||(this.screen.width-options.left*2),height:options.height||(this.screen.height-options.top-4),label:options.label||'Log',focus:true,arrows:options.arrows,border:this.getStyle('tree.border',{type:'line'}),style:{bold:true,border:{fg:this.getStyle('tree.border.fg','black')},label:this.getStyle('tree.label',undefined),hover:{border:{fg:'red'}},focus:{border:{fg:'red'}}}});function makeleaf(element,reference,data){var content,children,name,funpat,isfun,p;children={};name=element.toString();funpat=/function[\s0-9a-zA-Z_$]*\(/i;isfun=Comp.obj.isFunction(element)||funpat.test(name);if(isfun){element=Comp.string.sub(name,0,name.indexOf('{'));}
if(!isfun||(isfun&&options.showfun)){children[element]={};content={children:children,reference:reference,data:data};}
return content;}
function maketree(element,reference){var content,children,p;children={};if(element&&(Comp.obj.isObject(element)||Comp.obj.isArray(element))){if(element._update!=undefined)element._update(element);if(element._value!=undefined)return makeleaf(element._value,_,element);for(p in element){if(p!='_update')
children[p]={};}
content={children:children,data:element}}else if(element!=undefined){return makeleaf(element,reference);}else{children[element]={};content={children:children};}
return content;};obj.noshow=options.hidden;obj.on('preselect',function(node){var content,children,element,data,name;if(node.name!='/'&&!node.extended){data=node.data;if(data!=none&&(Comp.obj.isObject(data)||Comp.obj.isArray(data))){node.children={};if(Comp.obj.isArray(data)&&Comp.array.empty(data)&&Comp.hashtbl.empty(data)){node.children={'[]':{}};}else{if(data._update!=undefined)data._update(data);if(data._value!=undefined)return node.children=makeleaf(data._value,_,data).children;for(var p in data){if(p!='_update'){element=data[p];content=maketree(element,data);if(content)node.children[p]=content;}}}}else if(data==none&&node.reference){node.children={};element=node.reference[node.name];name=element.toString();var funpat=/function[\s0-9a-zA-Z_$]*\(/i;var isfun=Comp.obj.isFunction(element)||funpat.test(name);if(isfun){element=Comp.string.sub(name,0,name.indexOf('{'));}
node.children[element]={};}}else if(node.name=='/'&&node.extended){if(node.data&&node.data._update){node.data._update()}}});obj.set=obj.update=function(data){obj.DATA={name:'/',extended:true,children:{},data:data,};for(var p in data){var element=data[p];var content=options.depth&&options.depth==1?{}:maketree(element,data);if(content)obj.DATA.children[p]=content;}
obj.setData(obj.DATA);};obj.DATA={name:'/',extended:true,children:{},};obj.setData(obj.DATA);this.screen.append(obj);return obj;}
UI.prototype.builder=function(styles,content,options){var self=this,pagename,page,pagedesc,entryname,entry,handler,o,childs,index;this.styles=Comp.obj.inherit(this.styles,styles);if(!content.pages)throw Error("UI.builder: empty or invalid pages template (missing pages)");if(!content.pages.main)throw Error("UI.builder: no main page");function addhandler(obj,event,handler,arg1,arg2){obj.on(event,function(){handler(arg1,arg2)})}
function addhandlerP(page,event,handler,arg1,arg2){self.pages.on(page,event,function(){handler(arg1,arg2)})}
for(pagename in content.pages){pagedesc=content.pages[pagename];this.pages[pagename]=page={};for(entryname in pagedesc){entry=pagedesc[entryname];switch(entryname){case'next':page.next=entry;continue;break;case'prev':page.prev=entry;continue;break;case'on':if(pagedesc.on.show)addhandlerP(pagename,'load',pagedesc.on.show,pagename);if(pagedesc.on.load)addhandlerP(pagename,'load',pagedesc.on.load,pagename);continue;break;case'onclick':continue;break;}
switch(entry.type){case'label':page[entryname]=this.label(this.filterOptions(entry,entryname));break;case'button':page[entryname]=this.button(this.filterOptions(entry,entryname));break;case'input':page[entryname]=this.input(this.filterOptions(entry,entryname));this.postOptions(entry,page[entryname],entryname);break;case'info':page[entryname]=this.info(this.filterOptions(entry,entryname));break;case'tree':page[entryname]=this.tree(this.filterOptions(entry,entryname));this.postOptions(entry,page[entryname],entryname);break;case'list':page[entryname]=this.list(this.filterOptions(entry,entryname));this.postOptions(entry,page[entryname],entryname);break;case'checkbox':page[entryname]=this.checkbox(this.filterOptions(entry,entryname));this.postOptions(entry,page[entryname],entryname);break;case'radiobutton':break;case'log':page[entryname]=this.log(this.filterOptions(entry,entryname));this.postOptions(entry,page[entryname],entryname);break;case'group':childs={};handler=undefined;for(o in entry){switch(o){case'type':break;case'onclick':handler=entry[o];break;default:if(entry[o].type=='radiobutton')childs[o]=entry[o];}}
for(o in childs){options=this.filterOptions(childs[o],entryname);options.group=entryname;page[entryname+'.'+o]=this.radiobutton(options);if(handler){if(childs[o].index!=undefined)index=childs[o].index;else index=childs[o].text;addhandler(page[entryname+'.'+o],'check',handler,entryname,index);}}
break;default:throw Error("UI.builder: invalid or unsupported widget type "+entry.type+" in "+entryname);}}}
if(content.static){for(entryname in content.static){entry=content.static[entryname];switch(entry.type){case'info':this.static[entryname]=this.info(this.filterOptions(entry,entryname));break;}}}
if(content.on&&content.on.keypress&&Comp.obj.isArray(content.on.keypress)){content.on.keypress.forEach(function(entry){if(typeof entry.key=='string')
self.screen.key([entry.key],entry.handler);else if(entry.key&&Comp.obj.isArray(entry.key))
self.screen.key(entry.key,entry.handler);});}
for(page in this.pages)this.pages.hide(page);this.pages.show('main');}
module.exports={options:options,LAYOUT:LAYOUT,UI:UI}};BundleModuleCode['term/blessed']=function(module,exports){function blessed(){return blessed.program.apply(null,arguments);}
blessed.program=blessed.Program=Require('term/program');blessed.tput=blessed.Tput=Require('term/tput');blessed.widget=Require('term/widget');blessed.colors=Require('term/colors');blessed.unicode=Require('term/unicode');blessed.helpers=Require('term/helpers');blessed.helpers.sprintf=blessed.tput.sprintf;blessed.helpers.tryRead=blessed.tput.tryRead;blessed.helpers.merge(blessed,blessed.helpers);blessed.helpers.merge(blessed,blessed.widget);module.exports=blessed;};BundleModuleCode['term/program']=function(module,exports){var options={version:'1.9.3'}
var Comp=Require('com/compat');var EventEmitter=Require('events').EventEmitter,StringDecoder=Require('string_decoder').StringDecoder,cp=Require('child_process'),util=Require('util'),fs=Require('fs');var Tput=Require('term/tput'),colors=Require('term/colors'),slice=Array.prototype.slice;var nextTick=global.setImmediate||process.nextTick.bind(process);function Program(options){var self=this;if(!instanceOf(this,Program)){return new Program(options);}
Program.bind(this);EventEmitter.call(this);if(!options){options={input:arguments[0],output:arguments[1]};}
this.options=options;this.input=options.input||process.stdin;this.output=options.output||process.stdout;options.log=options.log||options.dump;if(options.log){this._logger=fs.createWriteStream(options.log);if(options.dump)this.setupDump();}
this.zero=options.zero!==false;this.useBuffer=options.buffer;this.x=0;this.y=0;this.savedX=0;this.savedY=0;this.cols=this.output.columns||80;this.rows=this.output.rows||20;console.log('Terminal: '+this.cols+' x '+this.rows);this.scrollTop=0;this.scrollBottom=this.rows-1;this._terminal=options.terminal||options.term||process.env.TERM||(process.platform==='win32'?'windows-ansi':'xterm');this._terminal=this._terminal.toLowerCase();this.isOSXTerm=process.env.TERM_PROGRAM==='Apple_Terminal';this.isiTerm2=process.env.TERM_PROGRAM==='iTerm.app'||!!process.env.ITERM_SESSION_ID;this.isXFCE=/xfce/i.test(process.env.COLORTERM);this.isTerminator=!!process.env.TERMINATOR_UUID;this.isLXDE=false;this.isVTE=!!process.env.VTE_VERSION||this.isXFCE||this.isTerminator||this.isLXDE;this.isRxvt=/rxvt/i.test(process.env.COLORTERM);this.isXterm=false;this.tmux=!!process.env.TMUX;this.tmuxVersion=(function(){if(!self.tmux)return 2;try{var version=cp.execFileSync('tmux',['-V'],{encoding:'utf8'});return+/^tmux ([\d.]+)/i.exec(version.trim().split('\n')[0])[1];}catch(e){return 2;}})();this._buf='';this._flush=this.flush.bind(this);if(options.tput!==false){this.setupTput();}
this.listen();if(process.platform=='win32'){process.winmouse.init(function(x,y,button,action){var key={name:'mouse',ctrl:false,meta:false,shift:false,action:action,x:x,y:y};self.emit('mouse',key);});}}
Program.global=null;Program.total=0;Program.instances=[];Program.bind=function(program){if(!Program.global){Program.global=program;}
if(!~Program.instances.indexOf(program)){Program.instances.push(program);program.index=Program.total;Program.total++;}
if(Program._bound)return;Program._bound=true;unshiftEvent(process,'exit',Program._exitHandler=function(){Program.instances.forEach(function(program){if(program._originalTitle){program.setTitle(program._originalTitle);}
program.flush();program._exiting=true;});});};inheritPrototype(Program,EventEmitter);Program.prototype.type='program';Program.prototype.log=function(){return this._log('LOG',util.format.apply(util,arguments));};Program.prototype.debug=function(){if(!this.options.debug)return;return this._log('DEBUG',util.format.apply(util,arguments));};Program.prototype._log=function(pre,msg){if(!this._logger)return;return this._logger.write(pre+': '+msg+'\n-\n');};Program.prototype.setupDump=function(){var self=this,write=this.output.write,decoder=new StringDecoder('utf8');function stringify(data){return caret(data.replace(/\r/g,'\\r').replace(/\n/g,'\\n').replace(/\t/g,'\\t')).replace(/[^ -~]/g,function(ch){if(ch.charCodeAt(0)>0xff)return ch;ch=ch.charCodeAt(0).toString(16);if(ch.length>2){if(ch.length<4)ch='0'+ch;return'\\u'+ch;}
if(ch.length<2)ch='0'+ch;return'\\x'+ch;});}
function caret(data){return data.replace(/[\0\x80\x1b-\x1f\x7f\x01-\x1a]/g,function(ch){switch(ch){case'\0':case'\200':ch='@';break;case'\x1b':ch='[';break;case'\x1c':ch='\\';break;case'\x1d':ch=']';break;case'\x1e':ch='^';break;case'\x1f':ch='_';break;case'\x7f':ch='?';break;default:ch=ch.charCodeAt(0);if(ch>=1&&ch<=26){ch=String.fromCharCode(ch+64);}else{return String.fromCharCode(ch);}
break;}
return'^'+ch;});}
this.input.on('data',function(data){self._log('IN',stringify(decoder.write(data)));});this.output.write=function(data){self._log('OUT',stringify(data));return write.apply(this,arguments);};};Program.prototype.setupTput=function(){if(this._tputSetup)return;this._tputSetup=true;var self=this,options=this.options,write=this._write.bind(this);var tput=this.tput=new Tput({terminal:this.terminal,padding:options.padding,extended:options.extended,printf:options.printf,termcap:options.termcap,forceUnicode:options.forceUnicode});if(tput.error){nextTick(function(){self.emit('warning',tput.error.message);});}
if(tput.padding){nextTick(function(){self.emit('warning','Terminfo padding has been enabled.');});}
this.put=function(){var args=slice.call(arguments),cap=args.shift();if(tput[cap]){return this._write(tput[cap].apply(tput,args));}};Object.keys(tput).forEach(function(key){if(self[key]==null){self[key]=tput[key];}
if(typeof tput[key]!=='function'){self.put[key]=tput[key];return;}
if(tput.padding){self.put[key]=function(){return tput._print(tput[key].apply(tput,arguments),write);};}else{self.put[key]=function(){return self._write(tput[key].apply(tput,arguments));};}});};Object.defineProperty(Program.prototype,'terminal',{get:function(){return this._terminal;},set:function(terminal){this.setTerminal(terminal);return this.terminal;}});Program.prototype.setTerminal=function(terminal){this._terminal=terminal.toLowerCase();delete this._tputSetup;this.setupTput();};Program.prototype.has=function(name){return this.tput?this.tput.has(name):false;};Program.prototype.term=function(is){return this.terminal.indexOf(is)===0;};Program.prototype.listen=function(){var self=this;if(!this.input._blessedInput){this.input._blessedInput=1;this._listenInput();}else{this.input._blessedInput++;}
this.on('newListener',this._newHandler=function fn(type){if(type==='keypress'||type==='mouse'){self.removeListener('newListener',fn);if(self.input.setRawMode&&!self.input.isRaw){self.input.setRawMode(true);self.input.resume();}}});this.on('newListener',function fn(type){if(type==='mouse'){self.removeListener('newListener',fn);self.bindMouse();}});if(!this.output._blessedOutput){this.output._blessedOutput=1;this._listenOutput();}else{this.output._blessedOutput++;}};var _keys=Require('term/keys');Program.prototype._listenInput=function(){var keys=_keys,self=this;this.input.on('keypress',this.input._keypressHandler=function(ch,key){key=key||{ch:ch};if(key.name==='undefined'&&(key.code==='[M'||key.code==='[I'||key.code==='[O')){return;}
if(key.name==='undefined'){return;}
if(key.name==='enter'&&key.sequence==='\n'){key.name='linefeed';}
if(key.name==='return'&&key.sequence==='\r'){self.input.emit('keypress',ch,merge({},key,{name:'enter'}));}
var name=(key.ctrl?'C-':'')
+(key.meta?'M-':'')
+(key.shift&&key.name?'S-':'')
+(key.name||ch);key.full=name;Program.instances.forEach(function(program){if(program.input!==self.input)return;program.emit('keypress',ch,key);program.emit('key '+name,ch,key);});});this.input.on('data',this.input._dataHandler=function(data){Program.instances.forEach(function(program){if(program.input!==self.input)return;program.emit('data',data);});});keys.emitKeypressEvents(this.input);};Program.prototype._listenOutput=function(){var self=this;if(!this.output.isTTY){nextTick(function(){self.emit('warning','Output is not a TTY');});}
function resize(){Program.instances.forEach(function(program){if(program.output!==self.output)return;program.cols=program.output.columns;program.rows=program.output.rows;program.emit('resize');});}
this.output.on('resize',this.output._resizeHandler=function(){Program.instances.forEach(function(program){if(program.output!==self.output)return;if(!program.options.resizeTimeout){return resize();}
if(program._resizeTimer){clearTimeout(program._resizeTimer);delete program._resizeTimer;}
var time=typeof program.options.resizeTimeout==='number'?program.options.resizeTimeout:300;program._resizeTimer=setTimeout(resize,time);});});};Program.prototype.destroy=function(){var index=Program.instances.indexOf(this);if(~index){Program.instances.splice(index,1);Program.total--;this.flush();this._exiting=true;Program.global=Program.instances[0];if(Program.total===0){Program.global=null;process.removeListener('exit',Program._exitHandler);delete Program._exitHandler;delete Program._bound;}
this.input._blessedInput--;this.output._blessedOutput--;if(this.input._blessedInput===0){this.input.removeListener('keypress',this.input._keypressHandler);this.input.removeListener('data',this.input._dataHandler);delete this.input._keypressHandler;delete this.input._dataHandler;if(this.input.setRawMode){if(this.input.isRaw){this.input.setRawMode(false);}
if(!this.input.destroyed){this.input.pause();}}}
if(this.output._blessedOutput===0){this.output.removeListener('resize',this.output._resizeHandler);delete this.output._resizeHandler;}
this.removeListener('newListener',this._newHandler);delete this._newHandler;this.destroyed=true;this.emit('destroy');}};Program.prototype.key=function(key,listener){if(typeof key==='string')key=key.split(/\s*,\s*/);key.forEach(function(key){return this.on('key '+key,listener);},this);};Program.prototype.onceKey=function(key,listener){if(typeof key==='string')key=key.split(/\s*,\s*/);key.forEach(function(key){return this.once('key '+key,listener);},this);};Program.prototype.unkey=Program.prototype.removeKey=function(key,listener){if(typeof key==='string')key=key.split(/\s*,\s*/);key.forEach(function(key){return this.removeListener('key '+key,listener);},this);};Program.prototype.bindMouse=function(){if(this._boundMouse)return;this._boundMouse=true;var decoder=new StringDecoder('utf8'),self=this;this.on('data',function(data){var text,seq=[data],_data,i,n=0,m=0;if(data.length&&data.indexOf(0x1b,1)>0){seq=[];while(n<data.length){m=data.indexOf(0x1b,m+1);if(m==-1)m=data.length;seq.push(data.slice(n,m));n=m;}}
for(i in seq){_data=seq[i];text=decoder.write(_data);if(!text)continue;self._bindMouse(text,_data);}});};Program.prototype._bindMouse=function(s,buf){var self=this,key,parts,b,x,y,mod,params,down,page,button;key={name:undefined,ctrl:false,meta:false,shift:false};if(Buffer.isBuffer(s)){if(s[0]>127&&s[1]===undefined){s[0]-=128;s='\x1b'+s.toString('utf-8');}else{s=s.toString('utf-8');}}
var bx=s.charCodeAt(4);var by=s.charCodeAt(5);if(buf[0]===0x1b&&buf[1]===0x5b&&buf[2]===0x4d&&(this.isVTE||bx>=65533||by>=65533||(bx>0x00&&bx<0x20)||(by>0x00&&by<0x20)||(buf[4]>223&&buf[4]<248&&buf.length===6)||(buf[5]>223&&buf[5]<248&&buf.length===6))){b=buf[3];x=buf[4];y=buf[5];if(x<0x20)x+=0xff;if(y<0x20)y+=0xff;s='\x1b[M'
+String.fromCharCode(b)
+String.fromCharCode(x)
+String.fromCharCode(y);}
if(parts=/^\x1b\[M([\x00\u0020-\ufffe]{3})/.exec(s)){b=parts[1].charCodeAt(0);x=parts[1].charCodeAt(1);y=parts[1].charCodeAt(2);key.name='mouse';key.type='X10';key.raw=[b,x,y,parts[0]];key.buf=buf;key.x=x-32;key.y=y-32;if(this.zero)key.x--,key.y--;if(x===0)key.x=255;if(y===0)key.y=255;mod=b>>2;key.shift=!!(mod&1);key.meta=!!((mod>>1)&1);key.ctrl=!!((mod>>2)&1);b-=32;if((b>>6)&1){key.action=b&1?'wheeldown':'wheelup';key.button='middle';}else if(b===3&&this._lastButton){key.action='mouseup';key.button=this._lastButton;delete this._lastButton;}else if((b&3)<3){key.action='mousedown';button=b&3;key.button=button===0?'left':button===1?'middle':button===2?'right':'unknown';this._lastButton=key.button;}
if(b===35||b===39||b===51||b===43||(this.isVTE&&(b===32||b===36||b===48||b===40))){delete key.button;key.action='mousemove';}
self.emit('mouse',key);return;}
if(parts=/^\x1b\[(\d+;\d+;\d+)M/.exec(s)){params=parts[1].split(';');b=+params[0];x=+params[1];y=+params[2];key.name='mouse';key.type='urxvt';key.raw=[b,x,y,parts[0]];key.buf=buf;key.x=x;key.y=y;if(this.zero)key.x--,key.y--;mod=b>>2;key.shift=!!(mod&1);key.meta=!!((mod>>1)&1);key.ctrl=!!((mod>>2)&1);if(b===128||b===129){b=67;}
b-=32;if((b>>6)&1){key.action=b&1?'wheeldown':'wheelup';key.button='middle';}else if(b===3){key.action='mouseup';key.button=this._lastButton||'unknown';delete this._lastButton;}else{key.action='mousedown';button=b&3;key.button=button===0?'left':button===1?'middle':button===2?'right':'unknown';this._lastButton=key.button;}
if(b===35||b===39||b===51||b===43||(this.isVTE&&(b===32||b===36||b===48||b===40))){delete key.button;key.action='mousemove';}
self.emit('mouse',key);return;}
if(parts=/^\x1b\[<(\d+;\d+;\d+)([mM])/.exec(s)){down=parts[2]==='M';params=parts[1].split(';');b=+params[0];x=+params[1];y=+params[2];key.name='mouse';key.type='sgr';key.raw=[b,x,y,parts[0]];key.buf=buf;key.x=x;key.y=y;if(this.zero)key.x--,key.y--;mod=b>>2;key.shift=!!(mod&1);key.meta=!!((mod>>1)&1);key.ctrl=!!((mod>>2)&1);if((b>>6)&1){key.action=b&1?'wheeldown':'wheelup';key.button='middle';}else{key.action=down?'mousedown':'mouseup';button=b&3;key.button=button===0?'left':button===1?'middle':button===2?'right':'unknown';}
if(b===35||b===39||b===51||b===43||(this.isVTE&&(b===32||b===36||b===48||b===40))){delete key.button;key.action='mousemove';}
self.emit('mouse',key);return;}
if(parts=/^\x1b\[<(\d+;\d+;\d+;\d+)&w/.exec(s)){params=parts[1].split(';');b=+params[0];x=+params[1];y=+params[2];page=+params[3];key.name='mouse';key.type='dec';key.raw=[b,x,y,parts[0]];key.buf=buf;key.x=x;key.y=y;key.page=page;if(this.zero)key.x--,key.y--;key.action=b===3?'mouseup':'mousedown';key.button=b===2?'left':b===4?'middle':b===6?'right':'unknown';self.emit('mouse',key);return;}
if(parts=/^\x1b\[24([0135])~\[(\d+),(\d+)\]\r/.exec(s)){b=+parts[1];x=+parts[2];y=+parts[3];key.name='mouse';key.type='vt300';key.raw=[b,x,y,parts[0]];key.buf=buf;key.x=x;key.y=y;if(this.zero)key.x--,key.y--;key.action='mousedown';key.button=b===1?'left':b===2?'middle':b===5?'right':'unknown';self.emit('mouse',key);return;}
if(parts=/^\x1b\[(O|I)/.exec(s)){key.action=parts[1]==='I'?'focus':'blur';self.emit('mouse',key);self.emit(key.action);return;}};Program.prototype.enableGpm=function(){var self=this;var gpmclient=Require('term/gpmclient');if(this.gpm)return;this.gpm=gpmclient();this.gpm.on('btndown',function(btn,modifier,x,y){x--,y--;var key={name:'mouse',type:'GPM',action:'mousedown',button:self.gpm.ButtonName(btn),raw:[btn,modifier,x,y],x:x,y:y,shift:self.gpm.hasShiftKey(modifier),meta:self.gpm.hasMetaKey(modifier),ctrl:self.gpm.hasCtrlKey(modifier)};self.emit('mouse',key);});this.gpm.on('btnup',function(btn,modifier,x,y){x--,y--;var key={name:'mouse',type:'GPM',action:'mouseup',button:self.gpm.ButtonName(btn),raw:[btn,modifier,x,y],x:x,y:y,shift:self.gpm.hasShiftKey(modifier),meta:self.gpm.hasMetaKey(modifier),ctrl:self.gpm.hasCtrlKey(modifier)};self.emit('mouse',key);});this.gpm.on('move',function(btn,modifier,x,y){x--,y--;var key={name:'mouse',type:'GPM',action:'mousemove',button:self.gpm.ButtonName(btn),raw:[btn,modifier,x,y],x:x,y:y,shift:self.gpm.hasShiftKey(modifier),meta:self.gpm.hasMetaKey(modifier),ctrl:self.gpm.hasCtrlKey(modifier)};self.emit('mouse',key);});this.gpm.on('drag',function(btn,modifier,x,y){x--,y--;var key={name:'mouse',type:'GPM',action:'mousemove',button:self.gpm.ButtonName(btn),raw:[btn,modifier,x,y],x:x,y:y,shift:self.gpm.hasShiftKey(modifier),meta:self.gpm.hasMetaKey(modifier),ctrl:self.gpm.hasCtrlKey(modifier)};self.emit('mouse',key);});this.gpm.on('mousewheel',function(btn,modifier,x,y,dx,dy){var key={name:'mouse',type:'GPM',action:dy>0?'wheelup':'wheeldown',button:self.gpm.ButtonName(btn),raw:[btn,modifier,x,y,dx,dy],x:x,y:y,shift:self.gpm.hasShiftKey(modifier),meta:self.gpm.hasMetaKey(modifier),ctrl:self.gpm.hasCtrlKey(modifier)};self.emit('mouse',key);});};Program.prototype.disableGpm=function(){if(this.gpm){this.gpm.stop();delete this.gpm;}};Program.prototype.bindResponse=function(){if(this._boundResponse)return;this._boundResponse=true;var decoder=new StringDecoder('utf8'),self=this;this.on('data',function(data){data=decoder.write(data);if(!data)return;self._bindResponse(data);});};Program.prototype._bindResponse=function(s){var out={},parts;if(Buffer.isBuffer(s)){if(s[0]>127&&s[1]===undefined){s[0]-=128;s='\x1b'+s.toString('utf-8');}else{s=s.toString('utf-8');}}
if(parts=/^\x1b\[(\?|>)(\d*(?:;\d*)*)c/.exec(s)){parts=parts[2].split(';').map(function(ch){return+ch||0;});out.event='device-attributes';out.code='DA';if(parts[1]==='?'){out.type='primary-attribute';if(parts[0]===1&&parts[2]===2){out.term='vt100';out.advancedVideo=true;}else if(parts[0]===1&&parts[2]===0){out.term='vt101';}else if(parts[0]===6){out.term='vt102';}else if(parts[0]===60&&parts[1]===1&&parts[2]===2&&parts[3]===6&&parts[4]===8&&parts[5]===9&&parts[6]===15){out.term='vt220';}else{parts.forEach(function(attr){switch(attr){case 1:out.cols132=true;break;case 2:out.printer=true;break;case 6:out.selectiveErase=true;break;case 8:out.userDefinedKeys=true;break;case 9:out.nationalReplacementCharsets=true;break;case 15:out.technicalCharacters=true;break;case 18:out.userWindows=true;break;case 21:out.horizontalScrolling=true;break;case 22:out.ansiColor=true;break;case 29:out.ansiTextLocator=true;break;}});}}else{out.type='secondary-attribute';switch(parts[0]){case 0:out.term='vt100';break;case 1:out.term='vt220';break;case 2:out.term='vt240';break;case 18:out.term='vt330';break;case 19:out.term='vt340';break;case 24:out.term='vt320';break;case 41:out.term='vt420';break;case 61:out.term='vt510';break;case 64:out.term='vt520';break;case 65:out.term='vt525';break;}
out.firmwareVersion=parts[1];out.romCartridgeRegistrationNumber=parts[2];}
out.deviceAttributes=out;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts=/^\x1b\[(\?)?(\d+)(?:;(\d+);(\d+);(\d+))?n/.exec(s)){out.event='device-status';out.code='DSR';if(!parts[1]&&parts[2]==='0'&&!parts[3]){out.type='device-status';out.status='OK';out.deviceStatus=out.status;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts[1]&&(parts[2]==='10'||parts[2]==='11')&&!parts[3]){out.type='printer-status';out.status=parts[2]==='10'?'ready':'not ready';out.printerStatus=out.status;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts[1]&&(parts[2]==='20'||parts[2]==='21')&&!parts[3]){out.type='udk-status';out.status=parts[2]==='20'?'unlocked':'locked';out.UDKStatus=out.status;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts[1]&&parts[2]==='27'&&parts[3]==='1'&&parts[4]==='0'&&parts[5]==='0'){out.type='keyboard-status';out.status='OK';out.keyboardStatus=out.status;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts[1]&&(parts[2]==='53'||parts[2]==='50')&&!parts[3]){out.type='locator-status';out.status=parts[2]==='53'?'available':'unavailable';out.locator=out.status;this.emit('response',out);this.emit('response '+out.event,out);return;}
out.type='error';out.text='Unhandled: '+JSON.stringify(parts);out.error=out.text;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts=/^\x1b\[(\?)?(\d+);(\d+)R/.exec(s)){out.event='device-status';out.code='DSR';out.type='cursor-status';out.status={x:+parts[3],y:+parts[2],page:!parts[1]?undefined:0};out.x=out.status.x;out.y=out.status.y;out.page=out.status.page;out.cursor=out.status;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts=/^\x1b\[(\d+)(?:;(\d+);(\d+))?t/.exec(s)){out.event='window-manipulation';out.code='';if((parts[1]==='1'||parts[1]==='2')&&!parts[2]){out.type='window-state';out.state=parts[1]==='1'?'non-iconified':'iconified';out.windowState=out.state;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts[1]==='3'&&parts[2]){out.type='window-position';out.position={x:+parts[2],y:+parts[3]};out.x=out.position.x;out.y=out.position.y;out.windowPosition=out.position;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts[1]==='4'&&parts[2]){out.type='window-size-pixels';out.size={height:+parts[2],width:+parts[3]};out.height=out.size.height;out.width=out.size.width;out.windowSizePixels=out.size;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts[1]==='8'&&parts[2]){out.type='textarea-size';out.size={height:+parts[2],width:+parts[3]};out.height=out.size.height;out.width=out.size.width;out.textAreaSizeCharacters=out.size;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts[1]==='9'&&parts[2]){out.type='screen-size';out.size={height:+parts[2],width:+parts[3]};out.height=out.size.height;out.width=out.size.width;out.screenSizeCharacters=out.size;this.emit('response',out);this.emit('response '+out.event,out);return;}
out.type='error';out.text='Unhandled: '+JSON.stringify(parts);out.error=out.text;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts=/^\x1b\](l|L)([^\x07\x1b]*)$/.exec(s)){parts[2]='rxvt';s='\x1b]'+parts[1]+parts[2]+'\x1b\\';}
if(parts=/^\x1b\](l|L)([^\x07\x1b]*)(?:\x07|\x1b\\)/.exec(s)){out.event='window-manipulation';out.code='';if(parts[1]==='L'){out.type='window-icon-label';out.text=parts[2];out.windowIconLabel=out.text;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts[1]==='l'){out.type='window-title';out.text=parts[2];out.windowTitle=out.text;this.emit('response',out);this.emit('response '+out.event,out);return;}
out.type='error';out.text='Unhandled: '+JSON.stringify(parts);out.error=out.text;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts=/^\x1b\[(\d+(?:;\d+){4})&w/.exec(s)){parts=parts[1].split(';').map(function(ch){return+ch;});out.event='locator-position';out.code='DECRQLP';switch(parts[0]){case 0:out.status='locator-unavailable';break;case 1:out.status='request';break;case 2:out.status='left-button-down';break;case 3:out.status='left-button-up';break;case 4:out.status='middle-button-down';break;case 5:out.status='middle-button-up';break;case 6:out.status='right-button-down';break;case 7:out.status='right-button-up';break;case 8:out.status='m4-button-down';break;case 9:out.status='m4-button-up';break;case 10:out.status='locator-outside';break;}
out.mask=parts[1];out.row=parts[2];out.col=parts[3];out.page=parts[4];out.locatorPosition=out;this.emit('response',out);this.emit('response '+out.event,out);return;}
if(parts=/^\x1b\](\d+);([^\x07\x1b]+)(?:\x07|\x1b\\)/.exec(s)){out.event='text-params';out.code='Set Text Parameters';out.ps=+s[1];out.pt=s[2];this.emit('response',out);this.emit('response '+out.event,out);}};Program.prototype.response=function(name,text,callback,noBypass){var self=this;if(arguments.length===2){callback=text;text=name;name=null;}
if(!callback){callback=function(){};}
this.bindResponse();name=name?'response '+name:'response';var onresponse;this.once(name,onresponse=function(event){if(timeout)clearTimeout(timeout);if(event.type==='error'){return callback(new Error(event.event+': '+event.text));}
return callback(null,event);});var timeout=setTimeout(function(){self.removeListener(name,onresponse);return callback(new Error('Timeout.'));},2000);return noBypass?this._write(text):this._twrite(text);};Program.prototype._owrite=Program.prototype.write=function(text){if(!this.output.writable)return;return this.output.write(text);};Program.prototype._buffer=function(text){if(this._exiting){this.flush();this._owrite(text);return;}
if(this._buf){this._buf+=text;return;}
this._buf=text;nextTick(this._flush);return true;};Program.prototype.flush=function(){if(!this._buf)return;this._owrite(this._buf);this._buf='';};Program.prototype._write=function(text){if(this.ret)return text;if(this.useBuffer){return this._buffer(text);}
return this._owrite(text);};Program.prototype._twrite=function(data){var self=this,iterations=0,timer;if(this.tmux){data=data.replace(/\x1b\\/g,'\x07');data='\x1bPtmux;\x1b'+data+'\x1b\\';if(this.output.bytesWritten===0){timer=setInterval(function(){if(self.output.bytesWritten>0||++iterations===50){clearInterval(timer);self.flush();self._owrite(data);}},100);return true;}
this.flush();return this._owrite(data);}
return this._write(data);};Program.prototype.echo=Program.prototype.print=function(text,attr){return attr?this._write(this.text(text,attr)):this._write(text);};Program.prototype._ncoords=function(){if(this.x<0)this.x=0;else if(this.x>=this.cols)this.x=this.cols-1;if(this.y<0)this.y=0;else if(this.y>=this.rows)this.y=this.rows-1;};Program.prototype.setx=function(x){return this.cursorCharAbsolute(x);};Program.prototype.sety=function(y){return this.linePosAbsolute(y);};Program.prototype.move=function(x,y){return this.cursorPos(y,x);};Program.prototype.omove=function(x,y){if(!this.zero){x=(x||1)-1;y=(y||1)-1;}else{x=x||0;y=y||0;}
if(y===this.y&&x===this.x){return;}
if(y===this.y){if(x>this.x){this.cuf(x-this.x);}else if(x<this.x){this.cub(this.x-x);}}else if(x===this.x){if(y>this.y){this.cud(y-this.y);}else if(y<this.y){this.cuu(this.y-y);}}else{if(!this.zero)x++,y++;this.cup(y,x);}};Program.prototype.rsetx=function(x){if(!x)return;return x>0?this.forward(x):this.back(-x);};Program.prototype.rsety=function(y){if(!y)return;return y>0?this.up(y):this.down(-y);};Program.prototype.rmove=function(x,y){this.rsetx(x);this.rsety(y);};Program.prototype.simpleInsert=function(ch,i,attr){return this._write(this.repeat(ch,i),attr);};Program.prototype.repeat=function(ch,i){if(!i||i<0)i=0;return Array(i+1).join(ch);};Object.defineProperty(Program.prototype,'title',{get:function(){return this._title;},set:function(title){this.setTitle(title);return this._title;}});Program.prototype.copyToClipboard=function(text){if(this.isiTerm2){this._twrite('\x1b]50;CopyToCliboard='+text+'\x07');return true;}
return false;};Program.prototype.cursorShape=function(shape,blink){if(this.isiTerm2){switch(shape){case'block':if(!blink){this._twrite('\x1b]50;CursorShape=0;BlinkingCursorEnabled=0\x07');}else{this._twrite('\x1b]50;CursorShape=0;BlinkingCursorEnabled=1\x07');}
break;case'underline':if(!blink){}else{}
break;case'line':if(!blink){this._twrite('\x1b]50;CursorShape=1;BlinkingCursorEnabled=0\x07');}else{this._twrite('\x1b]50;CursorShape=1;BlinkingCursorEnabled=1\x07');}
break;}
return true;}else if(this.term('xterm')||this.term('xterm-color')||this.term('screen')){switch(shape){case'block':if(!blink){this._twrite('\x1b[0 q');}else{this._twrite('\x1b[1 q');}
break;case'underline':if(!blink){this._twrite('\x1b[2 q');}else{this._twrite('\x1b[3 q');}
break;case'line':if(!blink){this._twrite('\x1b[4 q');}else{this._twrite('\x1b[5 q');}
break;}
return true;}
return false;};Program.prototype.cursorColor=function(color){if(this.term('xterm')||this.term('rxvt')||this.term('screen')){this._twrite('\x1b]12;'+color+'\x07');return true;}
return false;};Program.prototype.cursorReset=Program.prototype.resetCursor=function(){if(this.term('xterm')||this.term('xterm-color')||this.term('rxvt')||this.term('screen')){this._twrite('\x1b[0 q');this._twrite('\x1b]112\x07');this._twrite('\x1b]12;white\x07');return true;}
return false;};Program.prototype.getTextParams=function(param,callback){return this.response('text-params','\x1b]'+param+';?\x07',function(err,data){if(err)return callback(err);return callback(null,data.pt);});};Program.prototype.getCursorColor=function(callback){return this.getTextParams(12,callback);};Program.prototype.nul=function(){return this._write('\200');};Program.prototype.bel=Program.prototype.bell=function(){if(this.has('bel'))return this.put.bel();return this._write('\x07');};Program.prototype.vtab=function(){this.y++;this._ncoords();return this._write('\x0b');};Program.prototype.ff=Program.prototype.form=function(){if(this.has('ff'))return this.put.ff();return this._write('\x0c');};Program.prototype.kbs=Program.prototype.backspace=function(){this.x--;this._ncoords();if(this.has('kbs'))return this.put.kbs();return this._write('\x08');};Program.prototype.ht=Program.prototype.tab=function(){this.x+=8;this._ncoords();if(this.has('ht'))return this.put.ht();return this._write('\t');};Program.prototype.shiftOut=function(){return this._write('\x0e');};Program.prototype.shiftIn=function(){return this._write('\x0f');};Program.prototype.cr=Program.prototype.return=function(){this.x=0;if(this.has('cr'))return this.put.cr();return this._write('\r');};Program.prototype.nel=Program.prototype.newline=Program.prototype.feed=function(){if(this.tput&&this.tput.bools.eat_newline_glitch&&this.x>=this.cols){return;}
this.x=0;this.y++;this._ncoords();if(this.has('nel'))return this.put.nel();return this._write('\n');};Program.prototype.ind=Program.prototype.index=function(){this.y++;this._ncoords();if(this.tput)return this.put.ind();return this._write('\x1bD');};Program.prototype.ri=Program.prototype.reverse=Program.prototype.reverseIndex=function(){this.y--;this._ncoords();if(this.tput)return this.put.ri();return this._write('\x1bM');};Program.prototype.nextLine=function(){this.y++;this.x=0;this._ncoords();if(this.has('nel'))return this.put.nel();return this._write('\x1bE');};Program.prototype.reset=function(){this.x=this.y=0;if(this.has('rs1')||this.has('ris')){return this.has('rs1')?this.put.rs1():this.put.ris();}
return this._write('\x1bc');};Program.prototype.tabSet=function(){if(this.tput)return this.put.hts();return this._write('\x1bH');};Program.prototype.sc=Program.prototype.saveCursor=function(key){if(key)return this.lsaveCursor(key);this.savedX=this.x||0;this.savedY=this.y||0;if(this.tput)return this.put.sc();return this._write('\x1b7');};Program.prototype.rc=Program.prototype.restoreCursor=function(key,hide){if(key)return this.lrestoreCursor(key,hide);this.x=this.savedX||0;this.y=this.savedY||0;if(this.tput)return this.put.rc();return this._write('\x1b8');};Program.prototype.lsaveCursor=function(key){key=key||'local';this._saved=this._saved||{};this._saved[key]=this._saved[key]||{};this._saved[key].x=this.x;this._saved[key].y=this.y;this._saved[key].hidden=this.cursorHidden;};Program.prototype.lrestoreCursor=function(key,hide){var pos;key=key||'local';if(!this._saved||!this._saved[key])return;pos=this._saved[key];this.cup(pos.y,pos.x);if(hide&&pos.hidden!==this.cursorHidden){if(pos.hidden){this.hideCursor();}else{this.showCursor();}}};Program.prototype.lineHeight=function(){return this._write('\x1b#');};Program.prototype.charset=function(val,level){level=level||0;switch(level){case 0:level='(';break;case 1:level=')';break;case 2:level='*';break;case 3:level='+';break;}
var name=typeof val==='string'?val.toLowerCase():val;switch(name){case'acs':case'scld':if(this.tput)return this.put.smacs();val='0';break;case'uk':val='A';break;case'us':case'usascii':case'ascii':if(this.tput)return this.put.rmacs();val='B';break;case'dutch':val='4';break;case'finnish':val='C';val='5';break;case'french':val='R';break;case'frenchcanadian':val='Q';break;case'german':val='K';break;case'italian':val='Y';break;case'norwegiandanish':val='E';val='6';break;case'spanish':val='Z';break;case'swedish':val='H';val='7';break;case'swiss':val='=';break;case'isolatin':val='/A';break;default:if(this.tput)return this.put.rmacs();val='B';break;}
return this._write('\x1b('+val);};Program.prototype.enter_alt_charset_mode=Program.prototype.as=Program.prototype.smacs=function(){return this.charset('acs');};Program.prototype.exit_alt_charset_mode=Program.prototype.ae=Program.prototype.rmacs=function(){return this.charset('ascii');};Program.prototype.setG=function(val){switch(val){case 1:val='~';break;case 2:val='n';val='}';val='N';break;case 3:val='o';val='|';val='O';break;}
return this._write('\x1b'+val);};Program.prototype.setTitle=function(title){this._title=title;return this._twrite('\x1b]0;'+title+'\x07');};Program.prototype.resetColors=function(param){if(this.has('Cr')){return this.put.Cr(param);}
return this._twrite('\x1b]112\x07');};Program.prototype.dynamicColors=function(param){if(this.has('Cs')){return this.put.Cs(param);}
return this._twrite('\x1b]12;'+param+'\x07');};Program.prototype.selData=function(a,b){if(this.has('Ms')){return this.put.Ms(a,b);}
return this._twrite('\x1b]52;'+a+';'+b+'\x07');};Program.prototype.cuu=Program.prototype.up=Program.prototype.cursorUp=function(param){this.y-=param||1;this._ncoords();if(this.tput){if(!this.tput.strings.parm_up_cursor){return this._write(this.repeat(this.tput.cuu1(),param));}
return this.put.cuu(param);}
return this._write('\x1b['+(param||'')+'A');};Program.prototype.cud=Program.prototype.down=Program.prototype.cursorDown=function(param){this.y+=param||1;this._ncoords();if(this.tput){if(!this.tput.strings.parm_down_cursor){return this._write(this.repeat(this.tput.cud1(),param));}
return this.put.cud(param);}
return this._write('\x1b['+(param||'')+'B');};Program.prototype.cuf=Program.prototype.right=Program.prototype.forward=Program.prototype.cursorForward=function(param){this.x+=param||1;this._ncoords();if(this.tput){if(!this.tput.strings.parm_right_cursor){return this._write(this.repeat(this.tput.cuf1(),param));}
return this.put.cuf(param);}
return this._write('\x1b['+(param||'')+'C');};Program.prototype.cub=Program.prototype.left=Program.prototype.back=Program.prototype.cursorBackward=function(param){this.x-=param||1;this._ncoords();if(this.tput){if(!this.tput.strings.parm_left_cursor){return this._write(this.repeat(this.tput.cub1(),param));}
return this.put.cub(param);}
return this._write('\x1b['+(param||'')+'D');};Program.prototype.cup=Program.prototype.pos=Program.prototype.cursorPos=function(row,col){if(!this.zero){row=(row||1)-1;col=(col||1)-1;}else{row=row||0;col=col||0;}
this.x=col;this.y=row;this._ncoords();if(this.tput)return this.put.cup(row,col);return this._write('\x1b['+(row+1)+';'+(col+1)+'H');};Program.prototype.ed=Program.prototype.eraseInDisplay=function(param){if(this.tput){switch(param){case'above':param=1;break;case'all':param=2;break;case'saved':param=3;break;case'below':default:param=0;break;}
return this.put.ed(param);}
switch(param){case'above':return this._write('\X1b[1J');case'all':return this._write('\x1b[2J');case'saved':return this._write('\x1b[3J');case'below':default:return this._write('\x1b[J');}};Program.prototype.clear=function(){this.x=0;this.y=0;if(this.tput)return this.put.clear();return this._write('\x1b[H\x1b[J');};Program.prototype.el=Program.prototype.eraseInLine=function(param){if(this.tput){switch(param){case'left':param=1;break;case'all':param=2;break;case'right':default:param=0;break;}
return this.put.el(param);}
switch(param){case'left':return this._write('\x1b[1K');case'all':return this._write('\x1b[2K');case'right':default:return this._write('\x1b[K');}};Program.prototype.sgr=Program.prototype.attr=Program.prototype.charAttributes=function(param,val){return this._write(this._attr(param,val));};Program.prototype.text=function(text,attr){return this._attr(attr,true)+text+this._attr(attr,false);};Program.prototype._attr=function(param,val){var self=this,parts,color,m;if(Array.isArray(param)){parts=param;param=parts[0]||'normal';}else{param=param||'normal';parts=param.split(/\s*[,;]\s*/);}
if(parts.length>1){var used={},out=[];parts.forEach(function(part){part=self._attr(part,val).slice(2,-1);if(part==='')return;if(used[part])return;used[part]=true;out.push(part);});return'\x1b['+out.join(';')+'m';}
if(param.indexOf('no ')===0){param=param.substring(3);val=false;}else if(param.indexOf('!')===0){param=param.substring(1);val=false;}
switch(param){case'normal':case'default':if(val===false)return'';return'\x1b[m';case'bold':return val===false?'\x1b[22m':'\x1b[1m';case'ul':case'underline':case'underlined':return val===false?'\x1b[24m':'\x1b[4m';case'blink':return val===false?'\x1b[25m':'\x1b[5m';case'inverse':return val===false?'\x1b[27m':'\x1b[7m';case'invisible':return val===false?'\x1b[28m':'\x1b[8m';case'black fg':return val===false?'\x1b[39m':'\x1b[30m';case'red fg':return val===false?'\x1b[39m':'\x1b[31m';case'green fg':return val===false?'\x1b[39m':'\x1b[32m';case'yellow fg':return val===false?'\x1b[39m':'\x1b[33m';case'blue fg':return val===false?'\x1b[39m':'\x1b[34m';case'magenta fg':return val===false?'\x1b[39m':'\x1b[35m';case'cyan fg':return val===false?'\x1b[39m':'\x1b[36m';case'white fg':case'light grey fg':case'light gray fg':case'bright grey fg':case'bright gray fg':return val===false?'\x1b[39m':'\x1b[37m';case'default fg':if(val===false)return'';return'\x1b[39m';case'black bg':return val===false?'\x1b[49m':'\x1b[40m';case'red bg':return val===false?'\x1b[49m':'\x1b[41m';case'green bg':return val===false?'\x1b[49m':'\x1b[42m';case'yellow bg':return val===false?'\x1b[49m':'\x1b[43m';case'blue bg':return val===false?'\x1b[49m':'\x1b[44m';case'magenta bg':return val===false?'\x1b[49m':'\x1b[45m';case'cyan bg':return val===false?'\x1b[49m':'\x1b[46m';case'white bg':case'light grey bg':case'light gray bg':case'bright grey bg':case'bright gray bg':return val===false?'\x1b[49m':'\x1b[47m';case'default bg':if(val===false)return'';return'\x1b[49m';case'light black fg':case'bright black fg':case'grey fg':case'gray fg':return val===false?'\x1b[39m':'\x1b[90m';case'light red fg':case'bright red fg':return val===false?'\x1b[39m':'\x1b[91m';case'light green fg':case'bright green fg':return val===false?'\x1b[39m':'\x1b[92m';case'light yellow fg':case'bright yellow fg':return val===false?'\x1b[39m':'\x1b[93m';case'light blue fg':case'bright blue fg':return val===false?'\x1b[39m':'\x1b[94m';case'light magenta fg':case'bright magenta fg':return val===false?'\x1b[39m':'\x1b[95m';case'light cyan fg':case'bright cyan fg':return val===false?'\x1b[39m':'\x1b[96m';case'light white fg':case'bright white fg':return val===false?'\x1b[39m':'\x1b[97m';case'light black bg':case'bright black bg':case'grey bg':case'gray bg':return val===false?'\x1b[49m':'\x1b[100m';case'light red bg':case'bright red bg':return val===false?'\x1b[49m':'\x1b[101m';case'light green bg':case'bright green bg':return val===false?'\x1b[49m':'\x1b[102m';case'light yellow bg':case'bright yellow bg':return val===false?'\x1b[49m':'\x1b[103m';case'light blue bg':case'bright blue bg':return val===false?'\x1b[49m':'\x1b[104m';case'light magenta bg':case'bright magenta bg':return val===false?'\x1b[49m':'\x1b[105m';case'light cyan bg':case'bright cyan bg':return val===false?'\x1b[49m':'\x1b[106m';case'light white bg':case'bright white bg':return val===false?'\x1b[49m':'\x1b[107m';case'default fg bg':if(val===false)return'';return this.term('rxvt')?'\x1b[100m':'\x1b[39;49m';default:if(param[0]==='#'){param=param.replace(/#(?:[0-9a-f]{3}){1,2}/i,colors.match);}
m=/^(-?\d+) (fg|bg)$/.exec(param);if(m){color=+m[1];if(val===false||color===-1){return this._attr('default '+m[2]);}
color=colors.reduce(color,this.tput.colors);if(color<16||(this.tput&&this.tput.colors<=16)){if(m[2]==='fg'){if(color<8){color+=30;}else if(color<16){color-=8;color+=90;}}else if(m[2]==='bg'){if(color<8){color+=40;}else if(color<16){color-=8;color+=100;}}
return'\x1b['+color+'m';}
if(m[2]==='fg'){return'\x1b[38;5;'+color+'m';}
if(m[2]==='bg'){return'\x1b[48;5;'+color+'m';}}
if(/^[\d;]*$/.test(param)){return'\x1b['+param+'m';}
return null;}};Program.prototype.fg=Program.prototype.setForeground=function(color,val){color=color.split(/\s*[,;]\s*/).join(' fg, ')+' fg';return this.attr(color,val);};Program.prototype.bg=Program.prototype.setBackground=function(color,val){color=color.split(/\s*[,;]\s*/).join(' bg, ')+' bg';return this.attr(color,val);};Program.prototype.dsr=Program.prototype.deviceStatus=function(param,callback,dec,noBypass){if(dec){return this.response('device-status','\x1b[?'+(param||'0')+'n',callback,noBypass);}
return this.response('device-status','\x1b['+(param||'0')+'n',callback,noBypass);};Program.prototype.getCursor=function(callback){return this.deviceStatus(6,callback,false,true);};Program.prototype.saveReportedCursor=function(callback){var self=this;if(this.tput.strings.user7==='\x1b[6n'||this.term('screen')){return this.getCursor(function(err,data){if(data){self._rx=data.status.x;self._ry=data.status.y;}
if(!callback)return;return callback(err);});}
if(!callback)return;return callback();};Program.prototype.restoreReportedCursor=function(){if(this._rx==null)return;return this.cup(this._ry,this._rx);};Program.prototype.ich=Program.prototype.insertChars=function(param){this.x+=param||1;this._ncoords();if(this.tput)return this.put.ich(param);return this._write('\x1b['+(param||1)+'@');};Program.prototype.cnl=Program.prototype.cursorNextLine=function(param){this.y+=param||1;this._ncoords();return this._write('\x1b['+(param||'')+'E');};Program.prototype.cpl=Program.prototype.cursorPrecedingLine=function(param){this.y-=param||1;this._ncoords();return this._write('\x1b['+(param||'')+'F');};Program.prototype.cha=Program.prototype.cursorCharAbsolute=function(param){if(!this.zero){param=(param||1)-1;}else{param=param||0;}
this.x=param;this.y=0;this._ncoords();if(this.tput)return this.put.hpa(param);return this._write('\x1b['+(param+1)+'G');};Program.prototype.il=Program.prototype.insertLines=function(param){if(this.tput)return this.put.il(param);return this._write('\x1b['+(param||'')+'L');};Program.prototype.dl=Program.prototype.deleteLines=function(param){if(this.tput)return this.put.dl(param);return this._write('\x1b['+(param||'')+'M');};Program.prototype.dch=Program.prototype.deleteChars=function(param){if(this.tput)return this.put.dch(param);return this._write('\x1b['+(param||'')+'P');};Program.prototype.ech=Program.prototype.eraseChars=function(param){if(this.tput)return this.put.ech(param);return this._write('\x1b['+(param||'')+'X');};Program.prototype.hpa=Program.prototype.charPosAbsolute=function(param){this.x=param||0;this._ncoords();if(this.tput){return this.put.hpa.apply(this.put,arguments);}
param=slice.call(arguments).join(';');return this._write('\x1b['+(param||'')+'`');};Program.prototype.hpr=Program.prototype.HPositionRelative=function(param){if(this.tput)return this.cuf(param);this.x+=param||1;this._ncoords();return this._write('\x1b['+(param||'')+'a');};Program.prototype.da=Program.prototype.sendDeviceAttributes=function(param,callback){return this.response('device-attributes','\x1b['+(param||'')+'c',callback);};Program.prototype.vpa=Program.prototype.linePosAbsolute=function(param){this.y=param||1;this._ncoords();if(this.tput){return this.put.vpa.apply(this.put,arguments);}
param=slice.call(arguments).join(';');return this._write('\x1b['+(param||'')+'d');};Program.prototype.vpr=Program.prototype.VPositionRelative=function(param){if(this.tput)return this.cud(param);this.y+=param||1;this._ncoords();return this._write('\x1b['+(param||'')+'e');};Program.prototype.hvp=Program.prototype.HVPosition=function(row,col){if(!this.zero){row=(row||1)-1;col=(col||1)-1;}else{row=row||0;col=col||0;}
this.y=row;this.x=col;this._ncoords();if(this.tput)return this.put.cup(row,col);return this._write('\x1b['+(row+1)+';'+(col+1)+'f');};Program.prototype.sm=Program.prototype.setMode=function(){var param=slice.call(arguments).join(';');return this._write('\x1b['+(param||'')+'h');};Program.prototype.decset=function(){var param=slice.call(arguments).join(';');return this.setMode('?'+param);};Program.prototype.dectcem=Program.prototype.cnorm=Program.prototype.cvvis=Program.prototype.showCursor=function(){this.cursorHidden=false;if(this.tput)return this.put.cnorm();return this.setMode('?25');};Program.prototype.alternate=Program.prototype.smcup=Program.prototype.alternateBuffer=function(){this.isAlt=true;if(this.tput)return this.put.smcup();if(this.term('vt')||this.term('linux'))return;this.setMode('?47');return this.setMode('?1049');};Program.prototype.rm=Program.prototype.resetMode=function(){var param=slice.call(arguments).join(';');return this._write('\x1b['+(param||'')+'l');};Program.prototype.decrst=function(){var param=slice.call(arguments).join(';');return this.resetMode('?'+param);};Program.prototype.dectcemh=Program.prototype.cursor_invisible=Program.prototype.vi=Program.prototype.civis=Program.prototype.hideCursor=function(force){this.cursorHidden=true;if(!force&&this.tput)return this.put.civis();return this.resetMode('?25');};Program.prototype.rmcup=Program.prototype.normalBuffer=function(){this.isAlt=false;if(this.tput)return this.put.rmcup();this.resetMode('?47');return this.resetMode('?1049');};Program.prototype.enableMouse=function(){if(process.env.BLESSED_FORCE_MODES){var modes=process.env.BLESSED_FORCE_MODES.split(',');var options={};for(var n=0;n<modes.length;++n){var pair=modes[n].split('=');var v=pair[1]!=='0';switch(pair[0].toUpperCase()){case'SGRMOUSE':options.sgrMouse=v;break;case'UTFMOUSE':options.utfMouse=v;break;case'VT200MOUSE':options.vt200Mouse=v;break;case'URXVTMOUSE':options.urxvtMouse=v;break;case'X10MOUSE':options.x10Mouse=v;break;case'DECMOUSE':options.decMouse=v;break;case'PTERMMOUSE':options.ptermMouse=v;break;case'JSBTERMMOUSE':options.jsbtermMouse=v;break;case'VT200HILITE':options.vt200Hilite=v;break;case'GPMMOUSE':options.gpmMouse=v;break;case'CELLMOTION':options.cellMotion=v;break;case'ALLMOTION':options.allMotion=v;break;case'SENDFOCUS':options.sendFocus=v;break;}}
return this.setMouse(options,true);}
if(this.term('rxvt-unicode')){return this.setMouse({urxvtMouse:true,cellMotion:true,allMotion:true},true);}
if(this.term('rxvt')){return this.setMouse({vt200Mouse:true,x10Mouse:true,cellMotion:true,allMotion:true},true);}
if(this.isVTE){return this.setMouse({sgrMouse:true,cellMotion:true,allMotion:true},true);}
if(this.term('linux')){return this.setMouse({vt200Mouse:true,gpmMouse:true},true);}
if(this.term('xterm')||this.term('screen')||(this.tput&&this.tput.strings.key_mouse)){return this.setMouse({vt200Mouse:true,utfMouse:true,cellMotion:true,allMotion:true},true);}};Program.prototype.disableMouse=function(){if(!this._currentMouse)return;var obj={};Object.keys(this._currentMouse).forEach(function(key){obj[key]=false;});return this.setMouse(obj,false);};Program.prototype.setMouse=function(opt,enable){if(opt.normalMouse!=null){opt.vt200Mouse=opt.normalMouse;opt.allMotion=opt.normalMouse;}
if(opt.hiliteTracking!=null){opt.vt200Hilite=opt.hiliteTracking;}
if(enable===true){if(this._currentMouse){this.setMouse(opt);Object.keys(opt).forEach(function(key){this._currentMouse[key]=opt[key];},this);return;}
this._currentMouse=opt;this.mouseEnabled=true;}else if(enable===false){delete this._currentMouse;this.mouseEnabled=false;}
if(opt.x10Mouse!=null){if(opt.x10Mouse)this.setMode('?9');else this.resetMode('?9');}
if(opt.vt200Mouse!=null){if(opt.vt200Mouse)this.setMode('?1000');else this.resetMode('?1000');}
if(opt.vt200Hilite!=null){if(opt.vt200Hilite)this.setMode('?1001');else this.resetMode('?1001');}
if(opt.cellMotion!=null){if(opt.cellMotion)this.setMode('?1002');else this.resetMode('?1002');}
if(opt.allMotion!=null){if(this.tmux&&this.tmuxVersion>=2){if(opt.allMotion)this._twrite('\x1b[?1003h');else this._twrite('\x1b[?1003l');}else{if(opt.allMotion)this.setMode('?1003');else this.resetMode('?1003');}}
if(opt.sendFocus!=null){if(opt.sendFocus)this.setMode('?1004');else this.resetMode('?1004');}
if(opt.utfMouse!=null){if(opt.utfMouse)this.setMode('?1005');else this.resetMode('?1005');}
if(opt.sgrMouse!=null){if(opt.sgrMouse)this.setMode('?1006');else this.resetMode('?1006');}
if(opt.urxvtMouse!=null){if(opt.urxvtMouse)this.setMode('?1015');else this.resetMode('?1015');}
if(opt.decMouse!=null){if(opt.decMouse)this._write('\x1b[1;2\'z\x1b[1;3\'{');else this._write('\x1b[\'z');}
if(opt.ptermMouse!=null){if(opt.ptermMouse)this._write('\x1b[>1h\x1b[>6h\x1b[>7h\x1b[>1h\x1b[>9l');else this._write('\x1b[>1l\x1b[>6l\x1b[>7l\x1b[>1l\x1b[>9h');}
if(opt.jsbtermMouse!=null){if(opt.jsbtermMouse)this._write('\x1b[0~ZwLMRK+1Q\x1b\\');else this._write('\x1b[0~ZwQ\x1b\\');}
if(opt.gpmMouse!=null){if(opt.gpmMouse)this.enableGpm();else this.disableGpm();}};Program.prototype.decstbm=Program.prototype.csr=Program.prototype.setScrollRegion=function(top,bottom){if(!this.zero){top=(top||1)-1;bottom=(bottom||this.rows)-1;}else{top=top||0;bottom=bottom||(this.rows-1);}
this.scrollTop=top;this.scrollBottom=bottom;this.x=0;this.y=0;this._ncoords();if(this.tput)return this.put.csr(top,bottom);return this._write('\x1b['+(top+1)+';'+(bottom+1)+'r');};Program.prototype.scA=Program.prototype.saveCursorA=function(){this.savedX=this.x;this.savedY=this.y;if(this.tput)return this.put.sc();return this._write('\x1b[s');};Program.prototype.rcA=Program.prototype.restoreCursorA=function(){this.x=this.savedX||0;this.y=this.savedY||0;if(this.tput)return this.put.rc();return this._write('\x1b[u');};Program.prototype.cht=Program.prototype.cursorForwardTab=function(param){this.x+=8;this._ncoords();if(this.tput)return this.put.tab(param);return this._write('\x1b['+(param||1)+'I');};Program.prototype.su=Program.prototype.scrollUp=function(param){this.y-=param||1;this._ncoords();if(this.tput)return this.put.parm_index(param);return this._write('\x1b['+(param||1)+'S');};Program.prototype.sd=Program.prototype.scrollDown=function(param){this.y+=param||1;this._ncoords();if(this.tput)return this.put.parm_rindex(param);return this._write('\x1b['+(param||1)+'T');};Program.prototype.initMouseTracking=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'T');};Program.prototype.resetTitleModes=function(){return this._write('\x1b[>'+slice.call(arguments).join(';')+'T');};Program.prototype.cbt=Program.prototype.cursorBackwardTab=function(param){this.x-=8;this._ncoords();if(this.tput)return this.put.cbt(param);return this._write('\x1b['+(param||1)+'Z');};Program.prototype.rep=Program.prototype.repeatPrecedingCharacter=function(param){this.x+=param||1;this._ncoords();if(this.tput)return this.put.rep(param);return this._write('\x1b['+(param||1)+'b');};Program.prototype.tbc=Program.prototype.tabClear=function(param){if(this.tput)return this.put.tbc(param);return this._write('\x1b['+(param||0)+'g');};Program.prototype.mc=Program.prototype.mediaCopy=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'i');};Program.prototype.print_screen=Program.prototype.ps=Program.prototype.mc0=function(){if(this.tput)return this.put.mc0();return this.mc('0');};Program.prototype.prtr_on=Program.prototype.po=Program.prototype.mc5=function(){if(this.tput)return this.put.mc5();return this.mc('5');};Program.prototype.prtr_off=Program.prototype.pf=Program.prototype.mc4=function(){if(this.tput)return this.put.mc4();return this.mc('4');};Program.prototype.prtr_non=Program.prototype.pO=Program.prototype.mc5p=function(){if(this.tput)return this.put.mc5p();return this.mc('?5');};Program.prototype.setResources=function(){return this._write('\x1b[>'+slice.call(arguments).join(';')+'m');};Program.prototype.disableModifiers=function(param){return this._write('\x1b[>'+(param||'')+'n');};Program.prototype.setPointerMode=function(param){return this._write('\x1b[>'+(param||'')+'p');};Program.prototype.decstr=Program.prototype.rs2=Program.prototype.softReset=function(){if(this.tput)return this.put.rs2();return this._write('\x1b[!p\x1b[?3;4l\x1b[4l\x1b>');};Program.prototype.decrqm=Program.prototype.requestAnsiMode=function(param){return this._write('\x1b['+(param||'')+'$p');};Program.prototype.decrqmp=Program.prototype.requestPrivateMode=function(param){return this._write('\x1b[?'+(param||'')+'$p');};Program.prototype.decscl=Program.prototype.setConformanceLevel=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'"p');};Program.prototype.decll=Program.prototype.loadLEDs=function(param){return this._write('\x1b['+(param||'')+'q');};Program.prototype.decscusr=Program.prototype.setCursorStyle=function(param){switch(param){case'blinking block':param=1;break;case'block':case'steady block':param=2;break;case'blinking underline':param=3;break;case'underline':case'steady underline':param=4;break;case'blinking bar':param=5;break;case'bar':case'steady bar':param=6;break;}
if(param===2&&this.has('Se')){return this.put.Se();}
if(this.has('Ss')){return this.put.Ss(param);}
return this._write('\x1b['+(param||1)+' q');};Program.prototype.decsca=Program.prototype.setCharProtectionAttr=function(param){return this._write('\x1b['+(param||0)+'"q');};Program.prototype.restorePrivateValues=function(){return this._write('\x1b[?'+slice.call(arguments).join(';')+'r');};Program.prototype.deccara=Program.prototype.setAttrInRectangle=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'$r');};Program.prototype.savePrivateValues=function(){return this._write('\x1b[?'+slice.call(arguments).join(';')+'s');};Program.prototype.manipulateWindow=function(){var args=slice.call(arguments);var callback=typeof args[args.length-1]==='function'?args.pop():function(){};return this.response('window-manipulation','\x1b['+args.join(';')+'t',callback);};Program.prototype.getWindowSize=function(callback){return this.manipulateWindow(18,callback);};Program.prototype.decrara=Program.prototype.reverseAttrInRectangle=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'$t');};Program.prototype.setTitleModeFeature=function(){return this._twrite('\x1b[>'+slice.call(arguments).join(';')+'t');};Program.prototype.decswbv=Program.prototype.setWarningBellVolume=function(param){return this._write('\x1b['+(param||'')+' t');};Program.prototype.decsmbv=Program.prototype.setMarginBellVolume=function(param){return this._write('\x1b['+(param||'')+' u');};Program.prototype.deccra=Program.prototype.copyRectangle=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'$v');};Program.prototype.decefr=Program.prototype.enableFilterRectangle=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'\'w');};Program.prototype.decreqtparm=Program.prototype.requestParameters=function(param){return this._write('\x1b['+(param||0)+'x');};Program.prototype.decsace=Program.prototype.selectChangeExtent=function(param){return this._write('\x1b['+(param||0)+'x');};Program.prototype.decfra=Program.prototype.fillRectangle=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'$x');};Program.prototype.decelr=Program.prototype.enableLocatorReporting=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'\'z');};Program.prototype.decera=Program.prototype.eraseRectangle=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'$z');};Program.prototype.decsle=Program.prototype.setLocatorEvents=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'\'{');};Program.prototype.decsera=Program.prototype.selectiveEraseRectangle=function(){return this._write('\x1b['+slice.call(arguments).join(';')+'${');};Program.prototype.decrqlp=Program.prototype.req_mouse_pos=Program.prototype.reqmp=Program.prototype.requestLocatorPosition=function(param,callback){if(this.has('req_mouse_pos')){var code=this.tput.req_mouse_pos(param);return this.response('locator-position',code,callback);}
return this.response('locator-position','\x1b['+(param||'')+'\'|',callback);};Program.prototype.decic=Program.prototype.insertColumns=function(){return this._write('\x1b['+slice.call(arguments).join(';')+' }');};Program.prototype.decdc=Program.prototype.deleteColumns=function(){return this._write('\x1b['+slice.call(arguments).join(';')+' ~');};Program.prototype.out=function(name){var args=Array.prototype.slice.call(arguments,1);this.ret=true;var out=this[name].apply(this,args);this.ret=false;return out;};Program.prototype.sigtstp=function(callback){var resume=this.pause();process.once('SIGCONT',function(){resume();if(callback)callback();});process.kill(process.pid,'SIGTSTP');};Program.prototype.pause=function(callback){var self=this,isAlt=this.isAlt,mouseEnabled=this.mouseEnabled;this.lsaveCursor('pause');if(isAlt)this.normalBuffer();this.showCursor();if(mouseEnabled)this.disableMouse();var write=this.output.write;this.output.write=function(){};if(this.input.setRawMode){this.input.setRawMode(false);}
this.input.pause();return this._resume=function(){delete self._resume;if(self.input.setRawMode){self.input.setRawMode(true);}
self.input.resume();self.output.write=write;if(isAlt)self.alternateBuffer();if(mouseEnabled)self.enableMouse();self.lrestoreCursor('pause',true);if(callback)callback();};};Program.prototype.resume=function(){if(this._resume)return this._resume();};function unshiftEvent(obj,event,listener){var listeners;if(obj.listeners){listeners=obj.listeners(event);obj.removeAllListeners(event);obj.on(event,listener);listeners.forEach(function(listener){obj.on(event,listener);});}else{if(obj==process)process.on(event,listener);}}
function merge(out){slice.call(arguments,1).forEach(function(obj){Object.keys(obj).forEach(function(key){out[key]=obj[key];});});return out;}
module.exports=Program;};BundleModuleCode['os/events']=function(module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined;}
module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))
throw TypeError('n must be a positive number');this._maxListeners=n;return this;};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)
this._events={};if(type==='error'){if(!this._events.error||(isObject(this._events.error)&&!this._events.error.length)){er=arguments[1];if(er instanceof Error){throw er;}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+')');err.context=er;throw err;}}}
handler=this._events[type];if(isUndefined(handler))
return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args);}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)
listeners[i].apply(this,args);}
return true;};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))
throw TypeError('listener must be a function');if(!this._events)
this._events={};if(this._events.newListener)
this.emit('newListener',type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])
this._events[type]=listener;else if(isObject(this._events[type]))
this._events[type].push(listener);else
this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners;}else{m=EventEmitter.defaultMaxListeners;}
if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error('(node) warning: possible EventEmitter memory '+'leak detected. %d listeners added. '+'Use emitter.setMaxListeners() to increase limit.',this._events[type].length);if(typeof console.trace==='function'){console.trace();}}}
return this;};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))
throw TypeError('listener must be a function');var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments);}}
g.listener=listener;this.on(type,g);return this;};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))
throw TypeError('listener must be a function');if(!this._events||!this._events[type])
return this;list=this._events[type];length=list.length;position=-1;if(list===listener||(isFunction(list.listener)&&list.listener===listener)){delete this._events[type];if(this._events.removeListener)
this.emit('removeListener',type,listener);}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||(list[i].listener&&list[i].listener===listener)){position=i;break;}}
if(position<0)
return this;if(list.length===1){list.length=0;delete this._events[type];}else{list.splice(position,1);}
if(this._events.removeListener)
this.emit('removeListener',type,listener);}
return this;};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)
return this;if(!this._events.removeListener){if(arguments.length===0)
this._events={};else if(this._events[type])
delete this._events[type];return this;}
if(arguments.length===0){for(key in this._events){if(key==='removeListener')continue;this.removeAllListeners(key);}
this.removeAllListeners('removeListener');this._events={};return this;}
listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners);}else if(listeners){while(listeners.length)
this.removeListener(type,listeners[listeners.length-1]);}
delete this._events[type];return this;};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])
ret=[];else if(isFunction(this._events[type]))
ret=[this._events[type]];else
ret=this._events[type].slice();return ret;};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))
return 1;else if(evlistener)
return evlistener.length;}
return 0;};EventEmitter._listenerCount=function(ee,event){var listeners=ee&&ee._events&&ee._events[event]
if(Array.isArray(listeners)){return listeners.length}else if(typeof listeners==='function'){return 1}else{return 0}}
EventEmitter.listenerCount=function(emitter,type){if(emitter.listenerCount==undefined)return EventEmitter._listenerCount(emitter,type)
else
return emitter.listenerCount(type);};function isFunction(arg){return typeof arg==='function';}
function isNumber(arg){return typeof arg==='number';}
function isObject(arg){return typeof arg==='object'&&arg!==null;}
function isUndefined(arg){return arg===void 0;}};BundleModuleCode['os/string_decoder']=function(module,exports){var Buffer=require('buffer').Buffer;var isBufferEncoding=Buffer.isEncoding||function(encoding){switch(encoding&&encoding.toLowerCase()){case'hex':case'utf8':case'utf-8':case'ascii':case'binary':case'base64':case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':case'raw':return true;default:return false;}}
function assertEncoding(encoding){if(encoding&&!isBufferEncoding(encoding)){throw new Error('Unknown encoding: '+encoding);}}
var StringDecoder=exports.StringDecoder=function(encoding){this.encoding=(encoding||'utf8').toLowerCase().replace(/[-_]/,'');assertEncoding(encoding);switch(this.encoding){case'utf8':this.surrogateSize=3;break;case'ucs2':case'utf16le':this.surrogateSize=2;this.detectIncompleteChar=utf16DetectIncompleteChar;break;case'base64':this.surrogateSize=3;this.detectIncompleteChar=base64DetectIncompleteChar;break;default:this.write=passThroughWrite;return;}
this.charBuffer=new Buffer(6);this.charReceived=0;this.charLength=0;};StringDecoder.prototype.write=function(buffer){var charStr='';var offset=0;while(this.charLength){var i=(buffer.length>=this.charLength-this.charReceived)?this.charLength-this.charReceived:buffer.length;buffer.copy(this.charBuffer,this.charReceived,offset,i);this.charReceived+=(i-offset);offset=i;if(this.charReceived<this.charLength){return'';}
charStr=this.charBuffer.slice(0,this.charLength).toString(this.encoding);var charCode=charStr.charCodeAt(charStr.length-1);if(charCode>=0xD800&&charCode<=0xDBFF){this.charLength+=this.surrogateSize;charStr='';continue;}
this.charReceived=this.charLength=0;if(i==buffer.length)return charStr;buffer=buffer.slice(i,buffer.length);break;}
var lenIncomplete=this.detectIncompleteChar(buffer);var end=buffer.length;if(this.charLength){buffer.copy(this.charBuffer,0,buffer.length-lenIncomplete,end);this.charReceived=lenIncomplete;end-=lenIncomplete;}
charStr+=buffer.toString(this.encoding,0,end);var end=charStr.length-1;var charCode=charStr.charCodeAt(end);if(charCode>=0xD800&&charCode<=0xDBFF){var size=this.surrogateSize;this.charLength+=size;this.charReceived+=size;this.charBuffer.copy(this.charBuffer,size,0,size);this.charBuffer.write(charStr.charAt(charStr.length-1),this.encoding);return charStr.substring(0,end);}
return charStr;};StringDecoder.prototype.detectIncompleteChar=function(buffer){var i=(buffer.length>=3)?3:buffer.length;for(;i>0;i--){var c=buffer[buffer.length-i];if(i==1&&c>>5==0x06){this.charLength=2;break;}
if(i<=2&&c>>4==0x0E){this.charLength=3;break;}
if(i<=3&&c>>3==0x1E){this.charLength=4;break;}}
return i;};StringDecoder.prototype.end=function(buffer){var res='';if(buffer&&buffer.length)
res=this.write(buffer);if(this.charReceived){var cr=this.charReceived;var buf=this.charBuffer;var enc=this.encoding;res+=buf.slice(0,cr).toString(enc);}
return res;};function passThroughWrite(buffer){return buffer.toString(this.encoding);}
function utf16DetectIncompleteChar(buffer){var incomplete=this.charReceived=buffer.length%2;this.charLength=incomplete?2:0;return incomplete;}
function base64DetectIncompleteChar(buffer){var incomplete=this.charReceived=buffer.length%3;this.charLength=incomplete?3:0;return incomplete;}};BundleModuleCode['term/tput']=function(module,exports){var assert=Require('assert'),path=Require('path'),fs=Require('fs'),cp=Require('child_process');FileEmbedd('term/def/xterm');FileEmbedd('term/def/windows-ansi');function Tput(options){if(!(this instanceof Tput)){return new Tput(options);}
options=options||{};if(typeof options==='string'){options={terminal:options};}
this.options=options;this.terminal=options.terminal||options.term||process.env.TERM||(process.platform==='win32'?'windows-ansi':'xterm');this.terminal=this.terminal.toLowerCase();this.debug=options.debug;this.padding=options.padding;this.extended=options.extended;this.printf=options.printf;this.termcap=options.termcap;this.error=null;this.terminfoPrefix=options.terminfoPrefix;this.terminfoFile=options.terminfoFile;this.termcapFile=options.termcapFile;if(options.terminal||options.term){this.setup();}}
Tput.prototype.setup=function(){this.error=null;try{if(this.termcap){try{this.injectTermcap();}catch(e){if(this.debug)throw e;this.error=new Error('Termcap parse error.');this._useInternalCap(this.terminal);}}else{try{this.injectTerminfo();}catch(e){if(this.debug)throw e;this.error=new Error('Terminfo parse error.');this._useInternalInfo(this.terminal);}}}catch(e){if(this.debug)throw e;this.error=new Error('Terminfo not found.');this._useXtermInfo();}};Tput.prototype.term=function(is){return this.terminal.indexOf(is)===0;};Tput.prototype._debug=function(){if(!this.debug)return;return console.log.apply(console,arguments);};Tput.prototype._useVt102Cap=function(){return this.injectTermcap('vt102');};Tput.prototype._useXtermCap=function(){return this.injectTermcap('term/def/xterm.termcap');};Tput.prototype._useXtermInfo=function(){return this.injectTerminfo('term/def/xterm');};Tput.prototype._useInternalInfo=function(name){name=path.basename(name);return this.injectTerminfo('term/def/'+name);};Tput.prototype._useInternalCap=function(name){name=path.basename(name);return this.injectTermcap('term/def/'+name+'.termcap');};Tput.ipaths=[__dirname+'/..',process.env.TERMINFO||'',(process.env.TERMINFO_DIRS||'').split(':'),(process.env.HOME||'')+'/.terminfo','/usr/share/terminfo','/usr/share/lib/terminfo','/usr/lib/terminfo','/usr/local/share/terminfo','/usr/local/share/lib/terminfo','/usr/local/lib/terminfo','/usr/local/ncurses/lib/terminfo','/lib/terminfo'];Tput.prototype.readTerminfo=function(term){var data,file,info;term=term||this.terminal;try{data=FileEmbedded(term);}catch(e){};if(!data){file=path.normalize(this._prefix(term));console.log('Reading '+file);data=fs.readFileSync(file);}else file=term;info=this.parseTerminfo(data,file);if(this.debug){this._terminfo=info;}
return info;};Tput._prefix=Tput.prototype._prefix=function(term){if(term){if(term.indexOf(path.sep)==0){return term;}
if(this.terminfoFile){return this.terminfoFile;}}
var paths=Tput.ipaths.slice(),file;if(this.terminfoPrefix){paths.unshift(this.terminfoPrefix);}
file=this._tprefix(paths,term);if(file)return file;file=this._tprefix(paths,term,true);if(file)return file;throw new Error('Terminfo directory not found.');};Tput._tprefix=Tput.prototype._tprefix=function(prefix,term,soft){if(!prefix)return;var file,dir,i,sdiff,sfile,list;try{file=prefix+'/'+term;fs.statSync(file);return file;}catch(e){;}
if(Array.isArray(prefix)){for(i=0;i<prefix.length;i++){file=this._tprefix(prefix[i],term,soft);if(file)return file;}
return;}
var find=function(word){var file,ch;file=path.resolve(prefix,word[0]);try{fs.statSync(file);return file;}catch(e){;}
ch=word[0].charCodeAt(0).toString(16);if(ch.length<2)ch='0'+ch;file=path.resolve(prefix,ch);try{fs.statSync(file);return file;}catch(e){;}};if(!term){try{dir=fs.readdirSync(prefix).filter(function(file){return file.length!==1&&!/^[0-9a-fA-F]{2}$/.test(file);});if(!dir.length){return prefix;}}catch(e){;}
return;}
term=path.basename(term);dir=find(term);if(!dir)return;if(soft){try{list=fs.readdirSync(dir);}catch(e){return;}
list.forEach(function(file){if(file.indexOf(term)===0){var diff=file.length-term.length;if(!sfile||diff<sdiff){sdiff=diff;sfile=file;}}});return sfile&&(soft||sdiff===0)?path.resolve(dir,sfile):null;}
file=path.resolve(dir,term);try{fs.statSync(file);return file;}catch(e){;}};Tput.prototype.parseTerminfo=function(data,file){var info={},extended,l=data.length,i=0,v,o;var h=info.header={dataSize:data.length,headerSize:12,magicNumber:(data[1]<<8)|data[0],namesSize:(data[3]<<8)|data[2],boolCount:(data[5]<<8)|data[4],numCount:(data[7]<<8)|data[6],strCount:(data[9]<<8)|data[8],strTableSize:(data[11]<<8)|data[10]};console.log('parseTerminfo '+file+':'+data.length)
h.total=h.headerSize
+h.namesSize
+h.boolCount
+h.numCount*2
+h.strCount*2
+h.strTableSize;i+=h.headerSize;var names=data.toString('ascii',i,i+h.namesSize-1),parts=names.split('|'),name=parts[0],desc=parts.pop();info.name=name;info.names=parts;info.desc=desc;info.dir=path.resolve(file,'..','..');info.file=file;i+=h.namesSize-1;assert.equal(data[i],0);i++;info.bools={};l=i+h.boolCount;o=0;for(;i<l;i++){v=Tput.bools[o++];info.bools[v]=data[i]===1;}
if(i%2){assert.equal(data[i],0);i++;}
info.numbers={};l=i+h.numCount*2;o=0;for(;i<l;i+=2){v=Tput.numbers[o++];if(data[i+1]===0377&&data[i]===0377){info.numbers[v]=-1;}else{info.numbers[v]=(data[i+1]<<8)|data[i];}}
info.strings={};l=i+h.strCount*2;o=0;for(;i<l;i+=2){v=Tput.strings[o++];if(data[i+1]===0377&&data[i]===0377){info.strings[v]=-1;}else{info.strings[v]=(data[i+1]<<8)|data[i];}}
Object.keys(info.strings).forEach(function(key){if(info.strings[key]===-1){delete info.strings[key];return;}
if(info.strings[key]===65534){delete info.strings[key];return;}
var s=i+info.strings[key],j=s;while(data[j])j++;assert(j<data.length);info.strings[key]=data.toString('ascii',s,j);});if(this.extended!==false){i--;i+=h.strTableSize;if(i%2){assert.equal(data[i],0);i++;}
l=data.length;if(i<l-1){try{extended=this.parseExtended(data.slice(i));}catch(e){if(this.debug){throw e;}
return info;}
info.header.extended=extended.header;['bools','numbers','strings'].forEach(function(key){merge(info[key],extended[key]);});}}
return info;};Tput.prototype.parseExtended=function(data){var info={},l=data.length,i=0;var h=info.header={dataSize:data.length,headerSize:10,boolCount:(data[i+1]<<8)|data[i+0],numCount:(data[i+3]<<8)|data[i+2],strCount:(data[i+5]<<8)|data[i+4],strTableSize:(data[i+7]<<8)|data[i+6],lastStrTableOffset:(data[i+9]<<8)|data[i+8]};h.total=h.headerSize
+h.boolCount
+h.numCount*2
+h.strCount*2
+h.strTableSize;i+=h.headerSize;var _bools=[];l=i+h.boolCount;for(;i<l;i++){_bools.push(data[i]===1);}
if(i%2){assert.equal(data[i],0);i++;}
var _numbers=[];l=i+h.numCount*2;for(;i<l;i+=2){if(data[i+1]===0377&&data[i]===0377){_numbers.push(-1);}else{_numbers.push((data[i+1]<<8)|data[i]);}}
var _strings=[];l=i+h.strCount*2;for(;i<l;i+=2){if(data[i+1]===0377&&data[i]===0377){_strings.push(-1);}else{_strings.push((data[i+1]<<8)|data[i]);}}
i=data.length-h.lastStrTableOffset;var high=0;_strings.forEach(function(offset,k){if(offset===-1){_strings[k]='';return;}
var s=i+offset,j=s;while(data[j])j++;assert(j<data.length);if(high<j-i){high=j-i;}
_strings[k]=data.toString('ascii',s,j);});i+=high+1;l=data.length;var sym=[],j;for(;i<l;i++){j=i;while(data[j])j++;sym.push(data.toString('ascii',i,j));i=j;}
j=0;info.bools={};_bools.forEach(function(bool){info.bools[sym[j++]]=bool;});info.numbers={};_numbers.forEach(function(number){info.numbers[sym[j++]]=number;});info.strings={};_strings.forEach(function(string){info.strings[sym[j++]]=string;});assert.equal(i,data.length);return info;};Tput.prototype.compileTerminfo=function(term){return this.compile(this.readTerminfo(term));};Tput.prototype.injectTerminfo=function(term){return this.inject(this.compileTerminfo(term));};Tput.prototype.compile=function(info){var self=this;if(!info){throw new Error('Terminal not found.');}
this.detectFeatures(info);this._debug(info);info.all={};info.methods={};['bools','numbers','strings'].forEach(function(type){Object.keys(info[type]).forEach(function(key){info.all[key]=info[type][key];info.methods[key]=self._compile(info,key,info.all[key]);});});Tput.bools.forEach(function(key){if(info.methods[key]==null)info.methods[key]=false;});Tput.numbers.forEach(function(key){if(info.methods[key]==null)info.methods[key]=-1;});Tput.strings.forEach(function(key){if(!info.methods[key])info.methods[key]=noop;});Object.keys(info.methods).forEach(function(key){if(!Tput.alias[key])return;Tput.alias[key].forEach(function(alias){info.methods[alias]=info.methods[key];});});return info;};Tput.prototype.inject=function(info){var self=this,methods=info.methods||info;Object.keys(methods).forEach(function(key){if(typeof methods[key]!=='function'){self[key]=methods[key];return;}
self[key]=function(){var args=Array.prototype.slice.call(arguments);return methods[key].call(self,args);};});this.info=info;this.all=info.all;this.methods=info.methods;this.bools=info.bools;this.numbers=info.numbers;this.strings=info.strings;if(!~info.names.indexOf(this.terminal)){this.terminal=info.name;}
this.features=info.features;Object.keys(info.features).forEach(function(key){if(key==='padding'){if(!info.features.padding&&self.options.padding!==true){self.padding=false;}
return;}
self[key]=info.features[key];});};Tput.prototype._compile=function(info,key,str){var v;this._debug('Compiling %s: %s',key,JSON.stringify(str));switch(typeof str){case'boolean':return str;case'number':return str;case'string':break;default:return noop;}
if(!str){return noop;}
if(key==='init_file'||key==='reset_file'){try{str=fs.readFileSync(str,'utf8');if(this.debug){v=('return '+JSON.stringify(str)+';').replace(/\x1b/g,'\\x1b').replace(/\r/g,'\\r').replace(/\n/g,'\\n');process.stdout.write(v+'\n');}
return function(){return str;};}catch(e){return noop;}}
var tkey=info.name+'.'+key,header='var v, dyn = {}, stat = {}, stack = [], out = [];',footer=';return out.join("");',code=header,val=str,buff='',cap,ch,fi,then,els,end;function read(regex,no){cap=regex.exec(val);if(!cap)return;val=val.substring(cap[0].length);ch=cap[1];if(!no)clear();return cap;}
function stmt(c){if(code[code.length-1]===','){code=code.slice(0,-1);}
code+=c;}
function expr(c){code+=c+',';}
function echo(c){if(c==='""')return;expr('out.push('+c+')');}
function print(c){buff+=c;}
function clear(){if(buff){echo(JSON.stringify(buff).replace(/\\u00([0-9a-fA-F]{2})/g,'\\x$1'));buff='';}}
while(val){if(read(/^\n /,true)){continue;}
if(read(/^\^(.)/i,true)){if(!(ch>=' '&&ch<='~')){this._debug('%s: bad caret char.',tkey);print(cap[0]);continue;}
if(ch==='?'){ch='\x7f';}else{ch=ch.charCodeAt(0)&31;if(ch===0)ch=128;ch=String.fromCharCode(ch);}
print(ch);continue;}
if(read(/^\\([0-7]{3})/,true)){print(String.fromCharCode(parseInt(ch,8)));continue;}
if(read(/^\\([eEnlrtbfs\^\\,:0]|.)/,true)){switch(ch){case'e':case'E':ch='\x1b';break;case'n':ch='\n';break;case'l':ch='\x85';break;case'r':ch='\r';break;case't':ch='\t';break;case'b':ch='\x08';break;case'f':ch='\x0c';break;case's':ch=' ';break;case'^':ch='^';break;case'\\':ch='\\';break;case',':ch=',';break;case':':ch=':';break;case'0':ch='\200';break;case'a':ch='\x07';break;default:this._debug('%s: bad backslash char.',tkey);ch=cap[0];break;}
print(ch);continue;}
if(read(/^\$<(\d+)([*\/]{0,2})>/,true)){if(this.padding)print(cap[0]);continue;}
if(read(/^%%/,true)){print('%');continue;}
if(read(/^%((?::-|[+# ]){1,4})?(\d+(?:\.\d+)?)?([doxXsc])/)){if(this.printf||cap[1]||cap[2]||~'oxX'.indexOf(cap[3])){echo('sprintf("'+cap[0].replace(':-','-')+'", stack.pop())');}else if(cap[3]==='c'){echo('(v = stack.pop(), isFinite(v) '
+'? String.fromCharCode(v || 0200) : "")');}else{echo('stack.pop()');}
continue;}
if(read(/^%p([1-9])/)){expr('(stack.push(v = params['+(ch-1)+']), v)');continue;}
if(read(/^%P([a-z])/)){expr('dyn.'+ch+' = stack.pop()');continue;}
if(read(/^%g([a-z])/)){expr('(stack.push(dyn.'+ch+'), dyn.'+ch+')');continue;}
if(read(/^%P([A-Z])/)){expr('stat.'+ch+' = stack.pop()');continue;}
if(read(/^%g([A-Z])/)){expr('(stack.push(v = stat.'+ch+'), v)');continue;}
if(read(/^%'(.)'/)){expr('(stack.push(v = '+ch.charCodeAt(0)+'), v)');continue;}
if(read(/^%\{(\d+)\}/)){expr('(stack.push(v = '+ch+'), v)');continue;}
if(read(/^%l/)){expr('(stack.push(v = (stack.pop() || "").length || 0), v)');continue;}
if(read(/^%([+\-*\/m&|\^=><])/)){if(ch==='=')ch='===';else if(ch==='m')ch='%';expr('(v = stack.pop(),'
+' stack.push(v = (stack.pop() '+ch+' v) || 0),'
+' v)');continue;}
if(read(/^%([AO])/)){expr('(stack.push(v = (stack.pop() '
+(ch==='A'?'&&':'||')
+' stack.pop())), v)');continue;}
if(read(/^%([!~])/)){expr('(stack.push(v = '+ch+'stack.pop()), v)');continue;}
if(read(/^%i/)){expr('(params[0]++, params[1]++)');continue;}
if(read(/^%\?/)){end=-1;stmt(';if (');continue;}
if(read(/^%t/)){end=-1;stmt(') {');continue;}
if(read(/^%e/)){fi=val.indexOf('%?');then=val.indexOf('%t');els=val.indexOf('%e');end=val.indexOf('%;');if(end===-1)end=Infinity;if(then!==-1&&then<end&&(fi===-1||then<fi)&&(els===-1||then<els)){stmt('} else if (');}else{stmt('} else {');}
continue;}
if(read(/^%;/)){end=null;stmt('}');continue;}
buff+=val[0];val=val.substring(1);}
clear();if(end!=null){stmt('}');}
stmt(footer);v=code.slice(header.length,-footer.length);if(!v.length){code='return "";';}else if(v=/^out\.push\(("(?:[^"]|\\")+")\)$/.exec(v)){code='return '+v[1]+';';}else{code=code.replace(/\(stack\.push\(v = params\[(\d+)\]\), v\),out\.push\(stack\.pop\(\)\)/g,'out.push(params[$1])');v=code.slice(header.length,-footer.length);if(!~v.indexOf('v = '))code=code.replace('v, ','');if(!~v.indexOf('dyn'))code=code.replace('dyn = {}, ','');if(!~v.indexOf('stat'))code=code.replace('stat = {}, ','');if(!~v.indexOf('stack'))code=code.replace('stack = [], ','');code=code.replace(/out = \[\];out\.push\(("(?:[^"]|\\")+")\),/,'out = [$1];');}
if(str==='\u001b%?'){code='return "\\x1b";';}
if(this.debug){v=code.replace(/\x1b/g,'\\x1b').replace(/\r/g,'\\r').replace(/\n/g,'\\n');process.stdout.write(v+'\n');}
try{if(this.options.stringify&&code.indexOf('return ')===0){return new Function('',code)();}
return this.printf||~code.indexOf('sprintf(')?new Function('sprintf, params',code).bind(null,sprintf):new Function('params',code);}catch(e){console.error('');console.error('Error on %s:',tkey);console.error(JSON.stringify(str));console.error('');console.error(code.replace(/(,|;)/g,'$1\n'));e.stack=e.stack.replace(/\x1b/g,'\\x1b');throw e;}};Tput.prototype._print=function(code,print,done){var xon=!this.bools.needs_xon_xoff||this.bools.xon_xoff;print=print||write;done=done||noop;if(!this.padding){print(code);return done();}
var parts=code.split(/(?=\$<[\d.]+[*\/]{0,2}>)/),i=0;(function next(){if(i===parts.length){return done();}
var part=parts[i++],padding=/^\$<([\d.]+)([*\/]{0,2})>/.exec(part),amount,suffix;if(!padding){print(part);return next();}
part=part.substring(padding[0].length);amount=+padding[1];suffix=padding[2];if(xon&&!~suffix.indexOf('/')){print(part);return next();}
if(~suffix.indexOf('*')){amount=amount;}
return setTimeout(function(){print(part);return next();},amount);})();};Tput.print=function(){var fake={padding:true,bools:{needs_xon_xoff:true,xon_xoff:false}};return Tput.prototype._print.apply(fake,arguments);};Tput.cpaths=[process.env.TERMCAP||'',(process.env.TERMPATH||'').split(/[: ]/),(process.env.HOME||'')+'/.termcap','/usr/share/misc/termcap','/etc/termcap'];Tput.prototype.readTermcap=function(term){var self=this,terms,term_,root,paths;term=term||this.terminal;if(~term.indexOf(path.sep)&&(terms=this._tryCap(path.resolve(term)))){term_=path.basename(term).split('.')[0];if(terms[process.env.TERM]){term=process.env.TERM;}else if(terms[term_]){term=term_;}else{term=Object.keys(terms)[0];}}else{paths=Tput.cpaths.slice();if(this.termcapFile){paths.unshift(this.termcapFile);}
paths.push(Tput.termcap);terms=this._tryCap(paths,term);}
if(!terms){throw new Error('Cannot find termcap for: '+term);}
root=terms[term];if(this.debug){this._termcap=terms;}
(function tc(term){if(term&&term.strings.tc){root.inherits=root.inherits||[];root.inherits.push(term.strings.tc);var names=terms[term.strings.tc]?terms[term.strings.tc].names:[term.strings.tc];self._debug('%s inherits from %s.',term.names.join('/'),names.join('/'));var inherit=tc(terms[term.strings.tc]);if(inherit){['bools','numbers','strings'].forEach(function(type){merge(term[type],inherit[type]);});}}
return term;})(root);root=this.translateTermcap(root);return root;};Tput.prototype._tryCap=function(file,term){if(!file)return;var terms,data,i;if(Array.isArray(file)){for(i=0;i<file.length;i++){data=this._tryCap(file[i],term);if(data)return data;}
return;}
data=file[0]==='/'?tryRead(file):file;if(!data)return;terms=this.parseTermcap(data,file);if(term&&!terms[term]){return;}
return terms;};Tput.prototype.parseTermcap=function(data,file){var terms={},parts,term,entries,fields,field,names,i,j,k;data=data.replace(/\\\n[ \t]*/g,'');data=data.replace(/^#[^\n]+/gm,'');entries=data.trim().split(/\n+/);for(i=0;i<entries.length;i++){fields=entries[i].split(/:+/);for(j=0;j<fields.length;j++){field=fields[j].trim();if(!field)continue;if(j===0){names=field.split('|');term={name:names[0],names:names,desc:names.pop(),file:~file.indexOf(path.sep)?path.resolve(file):file,termcap:true};for(k=0;k<names.length;k++){terms[names[k]]=term;}
term.bools={};term.numbers={};term.strings={};continue;}
if(~field.indexOf('=')){parts=field.split('=');term.strings[parts[0]]=parts.slice(1).join('=');}else if(~field.indexOf('#')){parts=field.split('#');term.numbers[parts[0]]=+parts.slice(1).join('#');}else{term.bools[field]=true;}}}
return terms;};Tput.prototype.translateTermcap=function(info){var self=this,out={};if(!info)return;this._debug(info);['name','names','desc','file','termcap'].forEach(function(key){out[key]=info[key];});var map=(function(){var out={};Object.keys(Tput.alias).forEach(function(key){var aliases=Tput.alias[key];out[aliases.termcap]=key;});return out;})();['bools','numbers','strings'].forEach(function(key){out[key]={};Object.keys(info[key]).forEach(function(cap){if(key==='strings'){info.strings[cap]=self._captoinfo(cap,info.strings[cap],1);}
if(map[cap]){out[key][map[cap]]=info[key][cap];}else{out[key][cap]=info[key][cap];}});});return out;};Tput.prototype.compileTermcap=function(term){return this.compile(this.readTermcap(term));};Tput.prototype.injectTermcap=function(term){return this.inject(this.compileTermcap(term));};Tput.prototype._captoinfo=function(cap,s,parameterized){var self=this;var capstart;if(parameterized==null){parameterized=0;}
var MAX_PUSHED=16,stack=[];var stackptr=0,onstack=0,seenm=0,seenn=0,seenr=0,param=1,i=0,out='';function warn(){var args=Array.prototype.slice.call(arguments);args[0]='captoinfo: '+(args[0]||'');return self._debug.apply(self,args);}
function isdigit(ch){return ch>='0'&&ch<='9';}
function isgraph(ch){return ch>' '&&ch<='~';}
function cvtchar(sp){var c='\0',len;var j=i;switch(sp[j]){case'\\':switch(sp[++j]){case'\'':case'$':case'\\':case'%':c=sp[j];len=2;break;case'\0':c='\\';len=1;break;case'0':case'1':case'2':case'3':len=1;while(isdigit(sp[j])){c=String.fromCharCode(8*c.charCodeAt(0)
+(sp[j++].charCodeAt(0)-'0'.charCodeAt(0)));len++;}
break;default:c=sp[j];len=2;break;}
break;case'^':c=String.fromCharCode(sp[++j].charCodeAt(0)&0x1f);len=2;break;default:c=sp[j];len=1;}
if(isgraph(c)&&c!==','&&c!=='\''&&c!=='\\'&&c!==':'){out+='%\'';out+=c;out+='\'';}else{out+='%{';if(c.charCodeAt(0)>99){out+=String.fromCharCode((c.charCodeAt(0)/100|0)+'0'.charCodeAt(0));}
if(c.charCodeAt(0)>9){out+=String.fromCharCode((c.charCodeAt(0)/10|0)%10+'0'.charCodeAt(0));}
out+=String.fromCharCode(c.charCodeAt(0)%10+'0'.charCodeAt(0));out+='}';}
return len;}
function getparm(parm,n){if(seenr){if(parm===1){parm=2;}else if(parm===2){parm=1;}}
if(onstack===parm){if(n>1){warn('string may not be optimal');out+='%Pa';while(n--){out+='%ga';}}
return;}
if(onstack!==0){push();}
onstack=parm;while(n--){out+='%p';out+=String.fromCharCode('0'.charCodeAt(0)+parm);}
if(seenn&&parm<3){out+='%{96}%^';}
if(seenm&&parm<3){out+='%{127}%^';}}
function push(){if(stackptr>=MAX_PUSHED){warn('string too complex to convert');}else{stack[stackptr++]=onstack;}}
function pop(){if(stackptr===0){if(onstack===0){warn('I\'m confused');}else{onstack=0;}}else{onstack=stack[--stackptr];}
param++;}
function see03(){getparm(param,1);out+='%3d';pop();}
function invalid(){out+='%';i--;warn('unknown %% code %s (%#x) in %s',JSON.stringify(s[i]),s[i].charCodeAt(0),cap);}
capstart=null;if(s==null)s='';if(parameterized>=0&&isdigit(s[i])){for(capstart=i;;i++){if(!(isdigit(s[i])||s[i]==='*'||s[i]==='.')){break;}}}
while(s[i]){switch(s[i]){case'%':i++;if(parameterized<1){out+='%';break;}
switch(s[i++]){case'%':out+='%';break;case'r':if(seenr++===1){warn('saw %%r twice in %s',cap);}
break;case'm':if(seenm++===1){warn('saw %%m twice in %s',cap);}
break;case'n':if(seenn++===1){warn('saw %%n twice in %s',cap);}
break;case'i':out+='%i';break;case'6':case'B':getparm(param,1);out+='%{10}%/%{16}%*';getparm(param,1);out+='%{10}%m%+';break;case'8':case'D':getparm(param,2);out+='%{2}%*%-';break;case'>':getparm(param,2);out+='%?';i+=cvtchar(s);out+='%>%t';i+=cvtchar(s);out+='%+%;';break;case'a':if((s[i]==='='||s[i]==='+'||s[i]==='-'||s[i]==='*'||s[i]==='/')&&(s[i+1]==='p'||s[i+1]==='c')&&s[i+2]!=='\0'&&s[i+2]){var l;l=2;if(s[i]!=='='){getparm(param,1);}
if(s[i+1]==='p'){getparm(param+s[i+2].charCodeAt(0)-'@'.charCodeAt(0),1);if(param!==onstack){pop();param--;}
l++;}else{i+=2,l+=cvtchar(s),i-=2;}
switch(s[i]){case'+':out+='%+';break;case'-':out+='%-';break;case'*':out+='%*';break;case'/':out+='%/';break;case'=':if(seenr){if(param===1){onstack=2;}else if(param===2){onstack=1;}else{onstack=param;}}else{onstack=param;}
break;}
i+=l;break;}
getparm(param,1);i+=cvtchar(s);out+='%+';break;case'+':getparm(param,1);i+=cvtchar(s);out+='%+%c';pop();break;case's':getparm(param,1);out+='%s';pop();break;case'-':i+=cvtchar(s);getparm(param,1);out+='%-%c';pop();break;case'.':getparm(param,1);out+='%c';pop();break;case'0':if(s[i]==='3'){see03();break;}else if(s[i]!=='2'){invalid();break;}
case'2':getparm(param,1);out+='%2d';pop();break;case'3':see03();break;case'd':getparm(param,1);out+='%d';pop();break;case'f':param++;break;case'b':param--;break;case'\\':out+='%\\';break;default:invalid();break;}
break;default:out+=s[i++];break;}}
if(capstart!=null){out+='$<';for(i=capstart;;i++){if(isdigit(s[i])||s[i]==='*'||s[i]==='.'){out+=s[i];}else{break;}}
out+='/>';}
if(s!==out){warn('Translating %s from %s to %s.',cap,JSON.stringify(s),JSON.stringify(out));}
return out;};Tput.prototype.getAll=function(){var dir=this._prefix(),list=asort(fs.readdirSync(dir)),infos=[];list.forEach(function(letter){var terms=asort(fs.readdirSync(path.resolve(dir,letter)));infos.push.apply(infos,terms);});function asort(obj){return obj.sort(function(a,b){a=a.toLowerCase().charCodeAt(0);b=b.toLowerCase().charCodeAt(0);return a-b;});}
return infos;};Tput.prototype.compileAll=function(start){var self=this,all={};this.getAll().forEach(function(name){if(start&&name!==start){return;}else{start=null;}
all[name]=self.compileTerminfo(name);});return all;};Tput.prototype.detectFeatures=function(info){var data=this.parseACS(info);info.features={unicode:this.detectUnicode(info),brokenACS:this.detectBrokenACS(info),PCRomSet:this.detectPCRomSet(info),magicCookie:this.detectMagicCookie(info),padding:this.detectPadding(info),setbuf:this.detectSetbuf(info),acsc:data.acsc,acscr:data.acscr};return info.features;};Tput.prototype.detectUnicode=function(){if(this.options.forceUnicode!=null){return this.options.forceUnicode;}
var LANG=process.env.LANG
+':'+process.env.LANGUAGE
+':'+process.env.LC_ALL
+':'+process.env.LC_CTYPE;return/utf-?8/i.test(LANG)||(this.GetConsoleCP()===65001);};Tput.prototype.detectBrokenACS=function(info){if(process.env.NCURSES_NO_UTF8_ACS!=null){return!!+process.env.NCURSES_NO_UTF8_ACS;}
if(info.numbers.U8>=0){return!!info.numbers.U8;}
if(info.name==='linux'){return true;}
if(this.detectPCRomSet(info)){return true;}
if(this.termcap&&info.name.indexOf('screen')===0&&process.env.TERMCAP&&~process.env.TERMCAP.indexOf('screen')&&~process.env.TERMCAP.indexOf('hhII00')){if(~info.strings.enter_alt_charset_mode.indexOf('\016')||~info.strings.enter_alt_charset_mode.indexOf('\017')||~info.strings.set_attributes.indexOf('\016')||~info.strings.set_attributes.indexOf('\017')){return true;}}
return false;};Tput.prototype.detectPCRomSet=function(info){var s=info.strings;if(s.enter_pc_charset_mode&&s.enter_alt_charset_mode&&s.enter_pc_charset_mode===s.enter_alt_charset_mode&&s.exit_pc_charset_mode===s.exit_alt_charset_mode){return true;}
return false;};Tput.prototype.detectMagicCookie=function(){return process.env.NCURSES_NO_MAGIC_COOKIE==null;};Tput.prototype.detectPadding=function(){return process.env.NCURSES_NO_PADDING==null;};Tput.prototype.detectSetbuf=function(){return process.env.NCURSES_NO_SETBUF==null;};Tput.prototype.parseACS=function(info){var data={};data.acsc={};data.acscr={};if(this.detectPCRomSet(info)){return data;}
Object.keys(Tput.acsc).forEach(function(ch){var acs_chars=info.strings.acs_chars||'',i=acs_chars.indexOf(ch),next=acs_chars[i+1];if(!next||i===-1||!Tput.acsc[next]){return;}
data.acsc[ch]=Tput.acsc[next];data.acscr[Tput.acsc[next]]=ch;});return data;};Tput.prototype.GetConsoleCP=function(){var ccp;if(process.platform!=='win32'){return-1;}
if(+process.env.NCURSES_UNICODE!==0){return 65001;}
try{ccp=cp.execFileSync(process.env.WINDIR+'\\system32\\chcp.com',[],{stdio:['ignore','pipe','ignore'],encoding:'ascii',timeout:1500});}catch(e){;}
ccp=/\d+/.exec(ccp);if(!ccp){return-1;}
ccp=+ccp[0];return ccp;};function noop(){return'';}
noop.unsupported=true;function merge(a,b){Object.keys(b).forEach(function(key){a[key]=b[key];});return a;}
function write(data){return process.stdout.write(data);}
function tryRead(file){if(Array.isArray(file)){for(var i=0;i<file.length;i++){var data=tryRead(file[i]);if(data)return data;}
return'';}
if(!file)return'';file=path.resolve.apply(path,arguments);try{return fs.readFileSync(file,'utf8');}catch(e){return'';}}
function sprintf(src){var params=Array.prototype.slice.call(arguments,1),rule=/%([\-+# ]{1,4})?(\d+(?:\.\d+)?)?([doxXsc])/g,i=0;return src.replace(rule,function(_,flag,width,type){var flags=(flag||'').split(''),param=params[i]!=null?params[i]:'',initial=param,opt={},pre='';i++;switch(type){case'd':param=(+param).toString(10);break;case'o':param=(+param).toString(8);break;case'x':param=(+param).toString(16);break;case'X':param=(+param).toString(16).toUppercase();break;case's':break;case'c':param=isFinite(param)?String.fromCharCode(param||0200):'';break;}
flags.forEach(function(flag){switch(flag){case'-':opt.left=true;break;case'+':opt.signs=true;break;case'#':opt.hexpoint=true;break;case' ':opt.space=true;break;}});width=+width.split('.')[0];if(width&&!opt.left){param=param+'';while(param.length<width){param='0'+param;}}
if(opt.signs){if(+initial>=0){pre+='+';}}
if(opt.space){if(!opt.signs&&+initial>=0){pre+=' ';}}
if(opt.hexpoint){switch(type){case'o':pre+='0';break;case'x':pre+='0x';break;case'X':pre+='0X';break;}}
if(opt.left){if(width>(pre.length+param.length)){width-=pre.length+param.length;pre=Array(width+1).join(' ')+pre;}}
return pre+param;});}
Tput._alias=Require('term/alias');Tput.alias={};['bools','numbers','strings'].forEach(function(type){Object.keys(Tput._alias[type]).forEach(function(key){var aliases=Tput._alias[type][key];Tput.alias[key]=[aliases[0]];Tput.alias[key].terminfo=aliases[0];Tput.alias[key].termcap=aliases[1];});});Tput.alias.no_esc_ctlc.push('beehive_glitch');Tput.alias.dest_tabs_magic_smso.push('teleray_glitch');Tput.alias.micro_col_size.push('micro_char_size');Tput.aliasMap={};Object.keys(Tput.alias).forEach(function(key){Tput.aliasMap[key]=key;Tput.alias[key].forEach(function(k){Tput.aliasMap[k]=key;});});Tput.prototype.has=function(name){name=Tput.aliasMap[name];var val=this.all[name];if(!name)return false;if(typeof val==='number'){return val!==-1;}
return!!val;};Tput.termcap=''
+'vt102|dec vt102:'
+':do=^J:co#80:li#24:cl=50\\E[;H\\E[2J:'
+':le=^H:bs:cm=5\\E[%i%d;%dH:nd=2\\E[C:up=2\\E[A:'
+':ce=3\\E[K:cd=50\\E[J:so=2\\E[7m:se=2\\E[m:us=2\\E[4m:ue=2\\E[m:'
+':md=2\\E[1m:mr=2\\E[7m:mb=2\\E[5m:me=2\\E[m:is=\\E[1;24r\\E[24;1H:'
+':rs=\\E>\\E[?3l\\E[?4l\\E[?5l\\E[?7h\\E[?8h:ks=\\E[?1h\\E=:ke=\\E[?1l\\E>:'
+':ku=\\EOA:kd=\\EOB:kr=\\EOC:kl=\\EOD:kb=^H:\\\n'
+':ho=\\E[H:k1=\\EOP:k2=\\EOQ:k3=\\EOR:k4=\\EOS:pt:sr=5\\EM:vt#3:'
+':sc=\\E7:rc=\\E8:cs=\\E[%i%d;%dr:vs=\\E[?7l:ve=\\E[?7h:'
+':mi:al=\\E[L:dc=\\E[P:dl=\\E[M:ei=\\E[4l:im=\\E[4h:';Tput.bools=['auto_left_margin','auto_right_margin','no_esc_ctlc','ceol_standout_glitch','eat_newline_glitch','erase_overstrike','generic_type','hard_copy','has_meta_key','has_status_line','insert_null_glitch','memory_above','memory_below','move_insert_mode','move_standout_mode','over_strike','status_line_esc_ok','dest_tabs_magic_smso','tilde_glitch','transparent_underline','xon_xoff','needs_xon_xoff','prtr_silent','hard_cursor','non_rev_rmcup','no_pad_char','non_dest_scroll_region','can_change','back_color_erase','hue_lightness_saturation','col_addr_glitch','cr_cancels_micro_mode','has_print_wheel','row_addr_glitch','semi_auto_right_margin','cpi_changes_res','lpi_changes_res','backspaces_with_bs','crt_no_scrolling','no_correctly_working_cr','gnu_has_meta_key','linefeed_is_newline','has_hardware_tabs','return_does_clr_eol'];Tput.numbers=['columns','init_tabs','lines','lines_of_memory','magic_cookie_glitch','padding_baud_rate','virtual_terminal','width_status_line','num_labels','label_height','label_width','max_attributes','maximum_windows','max_colors','max_pairs','no_color_video','buffer_capacity','dot_vert_spacing','dot_horz_spacing','max_micro_address','max_micro_jump','micro_col_size','micro_line_size','number_of_pins','output_res_char','output_res_line','output_res_horz_inch','output_res_vert_inch','print_rate','wide_char_size','buttons','bit_image_entwining','bit_image_type','magic_cookie_glitch_ul','carriage_return_delay','new_line_delay','backspace_delay','horizontal_tab_delay','number_of_function_keys'];Tput.strings=['back_tab','bell','carriage_return','change_scroll_region','clear_all_tabs','clear_screen','clr_eol','clr_eos','column_address','command_character','cursor_address','cursor_down','cursor_home','cursor_invisible','cursor_left','cursor_mem_address','cursor_normal','cursor_right','cursor_to_ll','cursor_up','cursor_visible','delete_character','delete_line','dis_status_line','down_half_line','enter_alt_charset_mode','enter_blink_mode','enter_bold_mode','enter_ca_mode','enter_delete_mode','enter_dim_mode','enter_insert_mode','enter_secure_mode','enter_protected_mode','enter_reverse_mode','enter_standout_mode','enter_underline_mode','erase_chars','exit_alt_charset_mode','exit_attribute_mode','exit_ca_mode','exit_delete_mode','exit_insert_mode','exit_standout_mode','exit_underline_mode','flash_screen','form_feed','from_status_line','init_1string','init_2string','init_3string','init_file','insert_character','insert_line','insert_padding','key_backspace','key_catab','key_clear','key_ctab','key_dc','key_dl','key_down','key_eic','key_eol','key_eos','key_f0','key_f1','key_f10','key_f2','key_f3','key_f4','key_f5','key_f6','key_f7','key_f8','key_f9','key_home','key_ic','key_il','key_left','key_ll','key_npage','key_ppage','key_right','key_sf','key_sr','key_stab','key_up','keypad_local','keypad_xmit','lab_f0','lab_f1','lab_f10','lab_f2','lab_f3','lab_f4','lab_f5','lab_f6','lab_f7','lab_f8','lab_f9','meta_off','meta_on','newline','pad_char','parm_dch','parm_delete_line','parm_down_cursor','parm_ich','parm_index','parm_insert_line','parm_left_cursor','parm_right_cursor','parm_rindex','parm_up_cursor','pkey_key','pkey_local','pkey_xmit','print_screen','prtr_off','prtr_on','repeat_char','reset_1string','reset_2string','reset_3string','reset_file','restore_cursor','row_address','save_cursor','scroll_forward','scroll_reverse','set_attributes','set_tab','set_window','tab','to_status_line','underline_char','up_half_line','init_prog','key_a1','key_a3','key_b2','key_c1','key_c3','prtr_non','char_padding','acs_chars','plab_norm','key_btab','enter_xon_mode','exit_xon_mode','enter_am_mode','exit_am_mode','xon_character','xoff_character','ena_acs','label_on','label_off','key_beg','key_cancel','key_close','key_command','key_copy','key_create','key_end','key_enter','key_exit','key_find','key_help','key_mark','key_message','key_move','key_next','key_open','key_options','key_previous','key_print','key_redo','key_reference','key_refresh','key_replace','key_restart','key_resume','key_save','key_suspend','key_undo','key_sbeg','key_scancel','key_scommand','key_scopy','key_screate','key_sdc','key_sdl','key_select','key_send','key_seol','key_sexit','key_sfind','key_shelp','key_shome','key_sic','key_sleft','key_smessage','key_smove','key_snext','key_soptions','key_sprevious','key_sprint','key_sredo','key_sreplace','key_sright','key_srsume','key_ssave','key_ssuspend','key_sundo','req_for_input','key_f11','key_f12','key_f13','key_f14','key_f15','key_f16','key_f17','key_f18','key_f19','key_f20','key_f21','key_f22','key_f23','key_f24','key_f25','key_f26','key_f27','key_f28','key_f29','key_f30','key_f31','key_f32','key_f33','key_f34','key_f35','key_f36','key_f37','key_f38','key_f39','key_f40','key_f41','key_f42','key_f43','key_f44','key_f45','key_f46','key_f47','key_f48','key_f49','key_f50','key_f51','key_f52','key_f53','key_f54','key_f55','key_f56','key_f57','key_f58','key_f59','key_f60','key_f61','key_f62','key_f63','clr_bol','clear_margins','set_left_margin','set_right_margin','label_format','set_clock','display_clock','remove_clock','create_window','goto_window','hangup','dial_phone','quick_dial','tone','pulse','flash_hook','fixed_pause','wait_tone','user0','user1','user2','user3','user4','user5','user6','user7','user8','user9','orig_pair','orig_colors','initialize_color','initialize_pair','set_color_pair','set_foreground','set_background','change_char_pitch','change_line_pitch','change_res_horz','change_res_vert','define_char','enter_doublewide_mode','enter_draft_quality','enter_italics_mode','enter_leftward_mode','enter_micro_mode','enter_near_letter_quality','enter_normal_quality','enter_shadow_mode','enter_subscript_mode','enter_superscript_mode','enter_upward_mode','exit_doublewide_mode','exit_italics_mode','exit_leftward_mode','exit_micro_mode','exit_shadow_mode','exit_subscript_mode','exit_superscript_mode','exit_upward_mode','micro_column_address','micro_down','micro_left','micro_right','micro_row_address','micro_up','order_of_pins','parm_down_micro','parm_left_micro','parm_right_micro','parm_up_micro','select_char_set','set_bottom_margin','set_bottom_margin_parm','set_left_margin_parm','set_right_margin_parm','set_top_margin','set_top_margin_parm','start_bit_image','start_char_set_def','stop_bit_image','stop_char_set_def','subscript_characters','superscript_characters','these_cause_cr','zero_motion','char_set_names','key_mouse','mouse_info','req_mouse_pos','get_mouse','set_a_foreground','set_a_background','pkey_plab','device_type','code_set_init','set0_des_seq','set1_des_seq','set2_des_seq','set3_des_seq','set_lr_margin','set_tb_margin','bit_image_repeat','bit_image_newline','bit_image_carriage_return','color_names','define_bit_image_region','end_bit_image_region','set_color_band','set_page_length','display_pc_char','enter_pc_charset_mode','exit_pc_charset_mode','enter_scancode_mode','exit_scancode_mode','pc_term_options','scancode_escape','alt_scancode_esc','enter_horizontal_hl_mode','enter_left_hl_mode','enter_low_hl_mode','enter_right_hl_mode','enter_top_hl_mode','enter_vertical_hl_mode','set_a_attributes','set_pglen_inch','termcap_init2','termcap_reset','linefeed_if_not_lf','backspace_if_not_bs','other_non_function_keys','arrow_key_map','acs_ulcorner','acs_llcorner','acs_urcorner','acs_lrcorner','acs_ltee','acs_rtee','acs_btee','acs_ttee','acs_hline','acs_vline','acs_plus','memory_lock','memory_unlock','box_chars_1'];Tput.acsc={'`':'\u25c6','a':'\u2592','b':'\u0009','c':'\u000c','d':'\u000d','e':'\u000a','f':'\u00b0','g':'\u00b1','h':'\u2424','i':'\u000b','j':'\u2518','k':'\u2510','l':'\u250c','m':'\u2514','n':'\u253c','o':'\u23ba','p':'\u23bb','q':'\u2500','r':'\u23bc','s':'\u23bd','t':'\u251c','u':'\u2524','v':'\u2534','w':'\u252c','x':'\u2502','y':'\u2264','z':'\u2265','{':'\u03c0','|':'\u2260','}':'\u00a3','~':'\u00b7'};Tput.utoa=Tput.prototype.utoa={'\u25c6':'*','\u2592':' ','\u00b0':'*','\u00b1':'+','\u2424':'\n','\u2518':'+','\u2510':'+','\u250c':'+','\u2514':'+','\u253c':'+','\u23ba':'-','\u23bb':'-','\u2500':'-','\u23bc':'-','\u23bd':'_','\u251c':'+','\u2524':'+','\u2534':'+','\u252c':'+','\u2502':'|','\u2264':'<','\u2265':'>','\u03c0':'?','\u2260':'=','\u00a3':'?','\u00b7':'*'};exports=Tput;exports.sprintf=sprintf;exports.tryRead=tryRead;module.exports=exports;};BundleModuleCode['os/assert']=function(module,exports){'use strict';function compare(a,b){if(a===b){return 0;}
var x=a.length;var y=b.length;for(var i=0,len=Math.min(x,y);i<len;++i){if(a[i]!==b[i]){x=a[i];y=b[i];break;}}
if(x<y){return-1;}
if(y<x){return 1;}
return 0;}
function isBuffer(b){if(global.Buffer&&typeof global.Buffer.isBuffer==='function'){return global.Buffer.isBuffer(b);}
return!!(b!=null&&b._isBuffer);}
var util=Require('util');var hasOwn=Object.prototype.hasOwnProperty;var pSlice=Array.prototype.slice;var functionsHaveNames=(function(){return function foo(){}.name==='foo';}());function pToString(obj){return Object.prototype.toString.call(obj);}
function isView(arrbuf){if(isBuffer(arrbuf)){return false;}
if(typeof global.ArrayBuffer!=='function'){return false;}
if(typeof ArrayBuffer.isView==='function'){return ArrayBuffer.isView(arrbuf);}
if(!arrbuf){return false;}
if(arrbuf instanceof DataView){return true;}
if(arrbuf.buffer&&arrbuf.buffer instanceof ArrayBuffer){return true;}
return false;}
var assert=module.exports=ok;var regex=/\s*function\s+([^\(\s]*)\s*/;function getName(func){if(!util.isFunction(func)){return;}
if(functionsHaveNames){return func.name;}
var str=func.toString();var match=str.match(regex);return match&&match[1];}
assert.AssertionError=function AssertionError(options){this.name='AssertionError';this.actual=options.actual;this.expected=options.expected;this.operator=options.operator;if(options.message){this.message=options.message;this.generatedMessage=false;}else{this.message=getMessage(this);this.generatedMessage=true;}
var stackStartFunction=options.stackStartFunction||fail;if(Error.captureStackTrace){Error.captureStackTrace(this,stackStartFunction);}else{var err=new Error();if(err.stack){var out=err.stack;var fn_name=getName(stackStartFunction);var idx=out.indexOf('\n'+fn_name);if(idx>=0){var next_line=out.indexOf('\n',idx+1);out=out.substring(next_line+1);}
this.stack=out;}}};util.inherits(assert.AssertionError,Error);function truncate(s,n){if(typeof s==='string'){return s.length<n?s:s.slice(0,n);}else{return s;}}
function inspect(something){if(functionsHaveNames||!util.isFunction(something)){return util.inspect(something);}
var rawname=getName(something);var name=rawname?': '+rawname:'';return'[Function'+name+']';}
function getMessage(self){return truncate(inspect(self.actual),128)+' '+
self.operator+' '+
truncate(inspect(self.expected),128);}
function fail(actual,expected,message,operator,stackStartFunction){throw new assert.AssertionError({message:message,actual:actual,expected:expected,operator:operator,stackStartFunction:stackStartFunction});}
assert.fail=fail;function ok(value,message){if(!value)fail(value,true,message,'==',assert.ok);}
assert.ok=ok;assert.equal=function equal(actual,expected,message){if(actual!=expected)fail(actual,expected,message,'==',assert.equal);};assert.notEqual=function notEqual(actual,expected,message){if(actual==expected){fail(actual,expected,message,'!=',assert.notEqual);}};assert.deepEqual=function deepEqual(actual,expected,message){if(!_deepEqual(actual,expected,false)){fail(actual,expected,message,'deepEqual',assert.deepEqual);}};assert.deepStrictEqual=function deepStrictEqual(actual,expected,message){if(!_deepEqual(actual,expected,true)){fail(actual,expected,message,'deepStrictEqual',assert.deepStrictEqual);}};function _deepEqual(actual,expected,strict,memos){if(actual===expected){return true;}else if(isBuffer(actual)&&isBuffer(expected)){return compare(actual,expected)===0;}else if(util.isDate(actual)&&util.isDate(expected)){return actual.getTime()===expected.getTime();}else if(util.isRegExp(actual)&&util.isRegExp(expected)){return actual.source===expected.source&&actual.global===expected.global&&actual.multiline===expected.multiline&&actual.lastIndex===expected.lastIndex&&actual.ignoreCase===expected.ignoreCase;}else if((actual===null||typeof actual!=='object')&&(expected===null||typeof expected!=='object')){return strict?actual===expected:actual==expected;}else if(isView(actual)&&isView(expected)&&pToString(actual)===pToString(expected)&&!(actual instanceof Float32Array||actual instanceof Float64Array)){return compare(new Uint8Array(actual.buffer),new Uint8Array(expected.buffer))===0;}else if(isBuffer(actual)!==isBuffer(expected)){return false;}else{memos=memos||{actual:[],expected:[]};var actualIndex=memos.actual.indexOf(actual);if(actualIndex!==-1){if(actualIndex===memos.expected.indexOf(expected)){return true;}}
memos.actual.push(actual);memos.expected.push(expected);return objEquiv(actual,expected,strict,memos);}}
function isArguments(object){return Object.prototype.toString.call(object)=='[object Arguments]';}
function objEquiv(a,b,strict,actualVisitedObjects){if(a===null||a===undefined||b===null||b===undefined)
return false;if(util.isPrimitive(a)||util.isPrimitive(b))
return a===b;if(strict&&Object.getPrototypeOf(a)!==Object.getPrototypeOf(b))
return false;var aIsArgs=isArguments(a);var bIsArgs=isArguments(b);if((aIsArgs&&!bIsArgs)||(!aIsArgs&&bIsArgs))
return false;if(aIsArgs){a=pSlice.call(a);b=pSlice.call(b);return _deepEqual(a,b,strict);}
var ka=objectKeys(a);var kb=objectKeys(b);var key,i;if(ka.length!==kb.length)
return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!==kb[i])
return false;}
for(i=ka.length-1;i>=0;i--){key=ka[i];if(!_deepEqual(a[key],b[key],strict,actualVisitedObjects))
return false;}
return true;}
assert.notDeepEqual=function notDeepEqual(actual,expected,message){if(_deepEqual(actual,expected,false)){fail(actual,expected,message,'notDeepEqual',assert.notDeepEqual);}};assert.notDeepStrictEqual=notDeepStrictEqual;function notDeepStrictEqual(actual,expected,message){if(_deepEqual(actual,expected,true)){fail(actual,expected,message,'notDeepStrictEqual',notDeepStrictEqual);}}
assert.strictEqual=function strictEqual(actual,expected,message){if(actual!==expected){fail(actual,expected,message,'===',assert.strictEqual);}};assert.notStrictEqual=function notStrictEqual(actual,expected,message){if(actual===expected){fail(actual,expected,message,'!==',assert.notStrictEqual);}};function expectedException(actual,expected){if(!actual||!expected){return false;}
if(Object.prototype.toString.call(expected)=='[object RegExp]'){return expected.test(actual);}
try{if(actual instanceof expected){return true;}}catch(e){}
if(Error.isPrototypeOf(expected)){return false;}
return expected.call({},actual)===true;}
function _tryBlock(block){var error;try{block();}catch(e){error=e;}
return error;}
function _throws(shouldThrow,block,expected,message){var actual;if(typeof block!=='function'){throw new TypeError('"block" argument must be a function');}
if(typeof expected==='string'){message=expected;expected=null;}
actual=_tryBlock(block);message=(expected&&expected.name?' ('+expected.name+').':'.')+
(message?' '+message:'.');if(shouldThrow&&!actual){fail(actual,expected,'Missing expected exception'+message);}
var userProvidedMessage=typeof message==='string';var isUnwantedException=!shouldThrow&&util.isError(actual);var isUnexpectedException=!shouldThrow&&actual&&!expected;if((isUnwantedException&&userProvidedMessage&&expectedException(actual,expected))||isUnexpectedException){fail(actual,expected,'Got unwanted exception'+message);}
if((shouldThrow&&actual&&expected&&!expectedException(actual,expected))||(!shouldThrow&&actual)){throw actual;}}
assert.throws=function(block,error,message){_throws(true,block,error,message);};assert.doesNotThrow=function(block,error,message){_throws(false,block,error,message);};assert.ifError=function(err){if(err)throw err;};var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj){if(hasOwn.call(obj,key))keys.push(key);}
return keys;};};BundleModuleCode['os/path']=function(module,exports){var Fs=Require('fs');var _process=process||{};(function(){"use strict";var isWindows=_process.platform==='win32';var util=Require('util');if(!util.deprecate)util.deprecate=function(f,w){return f;};function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==='.'){parts.splice(i,1);}else if(last==='..'){parts.splice(i,1);up++;}else if(up){parts.splice(i,1);up--;}}
if(allowAboveRoot){for(;up--;up){parts.unshift('..');}}
return parts;}
if(isWindows){var splitDeviceRe=/^([a-zA-Z]:|[\\\/]{2}[^\\\/]+[\\\/]+[^\\\/]+)?([\\\/])?([\s\S]*?)$/;var splitTailRe=/^([\s\S]*?)((?:\.{1,2}|[^\\\/]+?|)(\.[^.\/\\]*|))(?:[\\\/]*)$/;var splitPath=function(filename){var result=splitDeviceRe.exec(filename),device=(result[1]||'')+(result[2]||''),tail=result[3]||'';var result2=splitTailRe.exec(tail),dir=result2[1],basename=result2[2],ext=result2[3];return[device,dir,basename,ext];};var normalizeUNCRoot=function(device){return'\\\\'+device.replace(/^[\\\/]+/,'').replace(/[\\\/]+/g,'\\');};exports.resolve=function(){var resolvedDevice='',resolvedTail='',resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1;i--){var path;if(i>=0){path=arguments[i];}else if(!resolvedDevice){path=_process.cwd();}else{path=_process.env['='+resolvedDevice];if(!path||path.substr(0,3).toLowerCase()!==resolvedDevice.toLowerCase()+'\\'){path=resolvedDevice+'\\';}}
if(!util.isString(path)){throw new TypeError('Arguments to path.resolve must be strings');}else if(!path){continue;}
var result=splitDeviceRe.exec(path),device=result[1]||'',isUnc=device&&device.charAt(1)!==':',isAbsolute=exports.isAbsolute(path),tail=result[3];if(device&&resolvedDevice&&device.toLowerCase()!==resolvedDevice.toLowerCase()){continue;}
if(!resolvedDevice){resolvedDevice=device;}
if(!resolvedAbsolute){resolvedTail=tail+'\\'+resolvedTail;resolvedAbsolute=isAbsolute;}
if(resolvedDevice&&resolvedAbsolute){break;}}
if(isUnc){resolvedDevice=normalizeUNCRoot(resolvedDevice);}
function f(p){return!!p;}
resolvedTail=normalizeArray(resolvedTail.split(/[\\\/]+/).filter(f),!resolvedAbsolute).join('\\');return(resolvedDevice+(resolvedAbsolute?'\\':'')+resolvedTail)||'.';};exports.normalize=function(path){var result=splitDeviceRe.exec(path),device=result[1]||'',isUnc=device&&device.charAt(1)!==':',isAbsolute=exports.isAbsolute(path),tail=result[3],trailingSlash=/[\\\/]$/.test(tail);if(device&&device.charAt(1)===':'){device=device[0].toLowerCase()+device.substr(1);}
tail=normalizeArray(tail.split(/[\\\/]+/).filter(function(p){return!!p;}),!isAbsolute).join('\\');if(!tail&&!isAbsolute){tail='.';}
if(tail&&trailingSlash){tail+='\\';}
if(isUnc){device=normalizeUNCRoot(device);}
return device+(isAbsolute?'\\':'')+tail;};exports.isAbsolute=function(path){var result=splitDeviceRe.exec(path),device=result[1]||'',isUnc=!!device&&device.charAt(1)!==':';return!!result[2]||isUnc;};exports.join=function(){function f(p){if(!util.isString(p)){throw new TypeError('Arguments to path.join must be strings');}
return p;}
var paths=Array.prototype.filter.call(arguments,f);var joined=paths.join('\\');if(!/^[\\\/]{2}[^\\\/]/.test(paths[0])){joined=joined.replace(/^[\\\/]{2,}/,'\\');}
return exports.normalize(joined);};exports.relative=function(from,to){from=exports.resolve(from);to=exports.resolve(to);var lowerFrom=from.toLowerCase();var lowerTo=to.toLowerCase();function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=='')break;}
var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=='')break;}
if(start>end)return[];return arr.slice(start,end+1);}
var toParts=trim(to.split('\\'));var lowerFromParts=trim(lowerFrom.split('\\'));var lowerToParts=trim(lowerTo.split('\\'));var length=Math.min(lowerFromParts.length,lowerToParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(lowerFromParts[i]!==lowerToParts[i]){samePartsLength=i;break;}}
if(samePartsLength==0){return to;}
var outputParts=[];for(var i=samePartsLength;i<lowerFromParts.length;i++){outputParts.push('..');}
outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join('\\');};exports.sep='\\';exports.delimiter=';';}else{var splitPathRe=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;var splitPath=function(filename){return splitPathRe.exec(filename).slice(1);};exports.resolve=function(){var resolvedPath='',resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=(i>=0)?arguments[i]:_process.cwd();if(!util.isString(path)){throw new TypeError('Arguments to path.resolve must be strings');}else if(!path){continue;}
resolvedPath=path+'/'+resolvedPath;resolvedAbsolute=path.charAt(0)==='/';}
resolvedPath=normalizeArray(resolvedPath.split('/').filter(function(p){return!!p;}),!resolvedAbsolute).join('/');return((resolvedAbsolute?'/':'')+resolvedPath)||'.';};exports.normalize=function(path){var isAbsolute=exports.isAbsolute(path),trailingSlash=path[path.length-1]==='/',segments=path.split('/'),nonEmptySegments=[];for(var i=0;i<segments.length;i++){if(segments[i]){nonEmptySegments.push(segments[i]);}}
path=normalizeArray(nonEmptySegments,!isAbsolute).join('/');if(!path&&!isAbsolute){path='.';}
if(path&&trailingSlash){path+='/';}
return(isAbsolute?'/':'')+path;};exports.isAbsolute=function(path){return path.charAt(0)==='/';};exports.join=function(){var path='';for(var i=0;i<arguments.length;i++){var segment=arguments[i];if(!util.isString(segment)){throw new TypeError('Arguments to path.join must be strings');}
if(segment){if(!path){path+=segment;}else{path+='/'+segment;}}}
return exports.normalize(path);};exports.relative=function(from,to){from=exports.resolve(from).substr(1);to=exports.resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=='')break;}
var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=='')break;}
if(start>end)return[];return arr.slice(start,end+1);}
var fromParts=trim(from.split('/'));var toParts=trim(to.split('/'));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break;}}
var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push('..');}
outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join('/');};exports.sep='/';exports.delimiter=':';}
exports.dirname=function(path){var result=splitPath(path),root=result[0],dir=result[1];if(!root&&!dir){return'.';}
if(dir){dir=dir.substr(0,dir.length-1);}
return root+dir;};exports.basename=function(path,ext){var f=splitPath(path)[2];if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length);}
return f;};exports.extname=function(path){return splitPath(path)[3];};exports.exists=util.deprecate(function(path,callback){if(Fs)Fs.exists(path,callback);else callback(false);},'path.exists is now called `fs.exists`.');exports.existsSync=util.deprecate(function(path){if(Fs)return Fs.existsSync(path);else return false;},'path.existsSync is now called `fs.existsSync`.');if(isWindows){exports._makeLong=function(path){if(!util.isString(path))
return path;if(!path){return'';}
var resolvedPath=exports.resolve(path);if(/^[a-zA-Z]\:\\/.test(resolvedPath)){return'\\\\?\\'+resolvedPath;}else if(/^\\\\[^?.]/.test(resolvedPath)){return'\\\\?\\UNC\\'+resolvedPath.substring(2);}
return path;};}else{exports._makeLong=function(path){return path;};}}());};BundleModuleCode['term/alias']=function(module,exports){var alias=exports;alias.bools={'auto_left_margin':['bw','bw'],'auto_right_margin':['am','am'],'back_color_erase':['bce','ut'],'can_change':['ccc','cc'],'ceol_standout_glitch':['xhp','xs'],'col_addr_glitch':['xhpa','YA'],'cpi_changes_res':['cpix','YF'],'cr_cancels_micro_mode':['crxm','YB'],'dest_tabs_magic_smso':['xt','xt'],'eat_newline_glitch':['xenl','xn'],'erase_overstrike':['eo','eo'],'generic_type':['gn','gn'],'hard_copy':['hc','hc'],'hard_cursor':['chts','HC'],'has_meta_key':['km','km'],'has_print_wheel':['daisy','YC'],'has_status_line':['hs','hs'],'hue_lightness_saturation':['hls','hl'],'insert_null_glitch':['in','in'],'lpi_changes_res':['lpix','YG'],'memory_above':['da','da'],'memory_below':['db','db'],'move_insert_mode':['mir','mi'],'move_standout_mode':['msgr','ms'],'needs_xon_xoff':['nxon','nx'],'no_esc_ctlc':['xsb','xb'],'no_pad_char':['npc','NP'],'non_dest_scroll_region':['ndscr','ND'],'non_rev_rmcup':['nrrmc','NR'],'over_strike':['os','os'],'prtr_silent':['mc5i','5i'],'row_addr_glitch':['xvpa','YD'],'semi_auto_right_margin':['sam','YE'],'status_line_esc_ok':['eslok','es'],'tilde_glitch':['hz','hz'],'transparent_underline':['ul','ul'],'xon_xoff':['xon','xo']};alias.numbers={'columns':['cols','co'],'init_tabs':['it','it'],'label_height':['lh','lh'],'label_width':['lw','lw'],'lines':['lines','li'],'lines_of_memory':['lm','lm'],'magic_cookie_glitch':['xmc','sg'],'max_attributes':['ma','ma'],'max_colors':['colors','Co'],'max_pairs':['pairs','pa'],'maximum_windows':['wnum','MW'],'no_color_video':['ncv','NC'],'num_labels':['nlab','Nl'],'padding_baud_rate':['pb','pb'],'virtual_terminal':['vt','vt'],'width_status_line':['wsl','ws'],'bit_image_entwining':['bitwin','Yo'],'bit_image_type':['bitype','Yp'],'buffer_capacity':['bufsz','Ya'],'buttons':['btns','BT'],'dot_horz_spacing':['spinh','Yc'],'dot_vert_spacing':['spinv','Yb'],'max_micro_address':['maddr','Yd'],'max_micro_jump':['mjump','Ye'],'micro_col_size':['mcs','Yf'],'micro_line_size':['mls','Yg'],'number_of_pins':['npins','Yh'],'output_res_char':['orc','Yi'],'output_res_horz_inch':['orhi','Yk'],'output_res_line':['orl','Yj'],'output_res_vert_inch':['orvi','Yl'],'print_rate':['cps','Ym'],'wide_char_size':['widcs','Yn']};alias.strings={'acs_chars':['acsc','ac'],'back_tab':['cbt','bt'],'bell':['bel','bl'],'carriage_return':['cr','cr'],'change_char_pitch':['cpi','ZA'],'change_line_pitch':['lpi','ZB'],'change_res_horz':['chr','ZC'],'change_res_vert':['cvr','ZD'],'change_scroll_region':['csr','cs'],'char_padding':['rmp','rP'],'clear_all_tabs':['tbc','ct'],'clear_margins':['mgc','MC'],'clear_screen':['clear','cl'],'clr_bol':['el1','cb'],'clr_eol':['el','ce'],'clr_eos':['ed','cd'],'column_address':['hpa','ch'],'command_character':['cmdch','CC'],'create_window':['cwin','CW'],'cursor_address':['cup','cm'],'cursor_down':['cud1','do'],'cursor_home':['home','ho'],'cursor_invisible':['civis','vi'],'cursor_left':['cub1','le'],'cursor_mem_address':['mrcup','CM'],'cursor_normal':['cnorm','ve'],'cursor_right':['cuf1','nd'],'cursor_to_ll':['ll','ll'],'cursor_up':['cuu1','up'],'cursor_visible':['cvvis','vs'],'define_char':['defc','ZE'],'delete_character':['dch1','dc'],'delete_line':['dl1','dl'],'dial_phone':['dial','DI'],'dis_status_line':['dsl','ds'],'display_clock':['dclk','DK'],'down_half_line':['hd','hd'],'ena_acs':['enacs','eA'],'enter_alt_charset_mode':['smacs','as'],'enter_am_mode':['smam','SA'],'enter_blink_mode':['blink','mb'],'enter_bold_mode':['bold','md'],'enter_ca_mode':['smcup','ti'],'enter_delete_mode':['smdc','dm'],'enter_dim_mode':['dim','mh'],'enter_doublewide_mode':['swidm','ZF'],'enter_draft_quality':['sdrfq','ZG'],'enter_insert_mode':['smir','im'],'enter_italics_mode':['sitm','ZH'],'enter_leftward_mode':['slm','ZI'],'enter_micro_mode':['smicm','ZJ'],'enter_near_letter_quality':['snlq','ZK'],'enter_normal_quality':['snrmq','ZL'],'enter_protected_mode':['prot','mp'],'enter_reverse_mode':['rev','mr'],'enter_secure_mode':['invis','mk'],'enter_shadow_mode':['sshm','ZM'],'enter_standout_mode':['smso','so'],'enter_subscript_mode':['ssubm','ZN'],'enter_superscript_mode':['ssupm','ZO'],'enter_underline_mode':['smul','us'],'enter_upward_mode':['sum','ZP'],'enter_xon_mode':['smxon','SX'],'erase_chars':['ech','ec'],'exit_alt_charset_mode':['rmacs','ae'],'exit_am_mode':['rmam','RA'],'exit_attribute_mode':['sgr0','me'],'exit_ca_mode':['rmcup','te'],'exit_delete_mode':['rmdc','ed'],'exit_doublewide_mode':['rwidm','ZQ'],'exit_insert_mode':['rmir','ei'],'exit_italics_mode':['ritm','ZR'],'exit_leftward_mode':['rlm','ZS'],'exit_micro_mode':['rmicm','ZT'],'exit_shadow_mode':['rshm','ZU'],'exit_standout_mode':['rmso','se'],'exit_subscript_mode':['rsubm','ZV'],'exit_superscript_mode':['rsupm','ZW'],'exit_underline_mode':['rmul','ue'],'exit_upward_mode':['rum','ZX'],'exit_xon_mode':['rmxon','RX'],'fixed_pause':['pause','PA'],'flash_hook':['hook','fh'],'flash_screen':['flash','vb'],'form_feed':['ff','ff'],'from_status_line':['fsl','fs'],'goto_window':['wingo','WG'],'hangup':['hup','HU'],'init_1string':['is1','i1'],'init_2string':['is2','is'],'init_3string':['is3','i3'],'init_file':['if','if'],'init_prog':['iprog','iP'],'initialize_color':['initc','Ic'],'initialize_pair':['initp','Ip'],'insert_character':['ich1','ic'],'insert_line':['il1','al'],'insert_padding':['ip','ip'],'key_a1':['ka1','K1'],'key_a3':['ka3','K3'],'key_b2':['kb2','K2'],'key_backspace':['kbs','kb'],'key_beg':['kbeg','@1'],'key_btab':['kcbt','kB'],'key_c1':['kc1','K4'],'key_c3':['kc3','K5'],'key_cancel':['kcan','@2'],'key_catab':['ktbc','ka'],'key_clear':['kclr','kC'],'key_close':['kclo','@3'],'key_command':['kcmd','@4'],'key_copy':['kcpy','@5'],'key_create':['kcrt','@6'],'key_ctab':['kctab','kt'],'key_dc':['kdch1','kD'],'key_dl':['kdl1','kL'],'key_down':['kcud1','kd'],'key_eic':['krmir','kM'],'key_end':['kend','@7'],'key_enter':['kent','@8'],'key_eol':['kel','kE'],'key_eos':['ked','kS'],'key_exit':['kext','@9'],'key_f0':['kf0','k0'],'key_f1':['kf1','k1'],'key_f10':['kf10','k;'],'key_f11':['kf11','F1'],'key_f12':['kf12','F2'],'key_f13':['kf13','F3'],'key_f14':['kf14','F4'],'key_f15':['kf15','F5'],'key_f16':['kf16','F6'],'key_f17':['kf17','F7'],'key_f18':['kf18','F8'],'key_f19':['kf19','F9'],'key_f2':['kf2','k2'],'key_f20':['kf20','FA'],'key_f21':['kf21','FB'],'key_f22':['kf22','FC'],'key_f23':['kf23','FD'],'key_f24':['kf24','FE'],'key_f25':['kf25','FF'],'key_f26':['kf26','FG'],'key_f27':['kf27','FH'],'key_f28':['kf28','FI'],'key_f29':['kf29','FJ'],'key_f3':['kf3','k3'],'key_f30':['kf30','FK'],'key_f31':['kf31','FL'],'key_f32':['kf32','FM'],'key_f33':['kf33','FN'],'key_f34':['kf34','FO'],'key_f35':['kf35','FP'],'key_f36':['kf36','FQ'],'key_f37':['kf37','FR'],'key_f38':['kf38','FS'],'key_f39':['kf39','FT'],'key_f4':['kf4','k4'],'key_f40':['kf40','FU'],'key_f41':['kf41','FV'],'key_f42':['kf42','FW'],'key_f43':['kf43','FX'],'key_f44':['kf44','FY'],'key_f45':['kf45','FZ'],'key_f46':['kf46','Fa'],'key_f47':['kf47','Fb'],'key_f48':['kf48','Fc'],'key_f49':['kf49','Fd'],'key_f5':['kf5','k5'],'key_f50':['kf50','Fe'],'key_f51':['kf51','Ff'],'key_f52':['kf52','Fg'],'key_f53':['kf53','Fh'],'key_f54':['kf54','Fi'],'key_f55':['kf55','Fj'],'key_f56':['kf56','Fk'],'key_f57':['kf57','Fl'],'key_f58':['kf58','Fm'],'key_f59':['kf59','Fn'],'key_f6':['kf6','k6'],'key_f60':['kf60','Fo'],'key_f61':['kf61','Fp'],'key_f62':['kf62','Fq'],'key_f63':['kf63','Fr'],'key_f7':['kf7','k7'],'key_f8':['kf8','k8'],'key_f9':['kf9','k9'],'key_find':['kfnd','@0'],'key_help':['khlp','%1'],'key_home':['khome','kh'],'key_ic':['kich1','kI'],'key_il':['kil1','kA'],'key_left':['kcub1','kl'],'key_ll':['kll','kH'],'key_mark':['kmrk','%2'],'key_message':['kmsg','%3'],'key_move':['kmov','%4'],'key_next':['knxt','%5'],'key_npage':['knp','kN'],'key_open':['kopn','%6'],'key_options':['kopt','%7'],'key_ppage':['kpp','kP'],'key_previous':['kprv','%8'],'key_print':['kprt','%9'],'key_redo':['krdo','%0'],'key_reference':['kref','&1'],'key_refresh':['krfr','&2'],'key_replace':['krpl','&3'],'key_restart':['krst','&4'],'key_resume':['kres','&5'],'key_right':['kcuf1','kr'],'key_save':['ksav','&6'],'key_sbeg':['kBEG','&9'],'key_scancel':['kCAN','&0'],'key_scommand':['kCMD','*1'],'key_scopy':['kCPY','*2'],'key_screate':['kCRT','*3'],'key_sdc':['kDC','*4'],'key_sdl':['kDL','*5'],'key_select':['kslt','*6'],'key_send':['kEND','*7'],'key_seol':['kEOL','*8'],'key_sexit':['kEXT','*9'],'key_sf':['kind','kF'],'key_sfind':['kFND','*0'],'key_shelp':['kHLP','#1'],'key_shome':['kHOM','#2'],'key_sic':['kIC','#3'],'key_sleft':['kLFT','#4'],'key_smessage':['kMSG','%a'],'key_smove':['kMOV','%b'],'key_snext':['kNXT','%c'],'key_soptions':['kOPT','%d'],'key_sprevious':['kPRV','%e'],'key_sprint':['kPRT','%f'],'key_sr':['kri','kR'],'key_sredo':['kRDO','%g'],'key_sreplace':['kRPL','%h'],'key_sright':['kRIT','%i'],'key_srsume':['kRES','%j'],'key_ssave':['kSAV','!1'],'key_ssuspend':['kSPD','!2'],'key_stab':['khts','kT'],'key_sundo':['kUND','!3'],'key_suspend':['kspd','&7'],'key_undo':['kund','&8'],'key_up':['kcuu1','ku'],'keypad_local':['rmkx','ke'],'keypad_xmit':['smkx','ks'],'lab_f0':['lf0','l0'],'lab_f1':['lf1','l1'],'lab_f10':['lf10','la'],'lab_f2':['lf2','l2'],'lab_f3':['lf3','l3'],'lab_f4':['lf4','l4'],'lab_f5':['lf5','l5'],'lab_f6':['lf6','l6'],'lab_f7':['lf7','l7'],'lab_f8':['lf8','l8'],'lab_f9':['lf9','l9'],'label_format':['fln','Lf'],'label_off':['rmln','LF'],'label_on':['smln','LO'],'meta_off':['rmm','mo'],'meta_on':['smm','mm'],'micro_column_address':['mhpa','ZY'],'micro_down':['mcud1','ZZ'],'micro_left':['mcub1','Za'],'micro_right':['mcuf1','Zb'],'micro_row_address':['mvpa','Zc'],'micro_up':['mcuu1','Zd'],'newline':['nel','nw'],'order_of_pins':['porder','Ze'],'orig_colors':['oc','oc'],'orig_pair':['op','op'],'pad_char':['pad','pc'],'parm_dch':['dch','DC'],'parm_delete_line':['dl','DL'],'parm_down_cursor':['cud','DO'],'parm_down_micro':['mcud','Zf'],'parm_ich':['ich','IC'],'parm_index':['indn','SF'],'parm_insert_line':['il','AL'],'parm_left_cursor':['cub','LE'],'parm_left_micro':['mcub','Zg'],'parm_right_cursor':['cuf','RI'],'parm_right_micro':['mcuf','Zh'],'parm_rindex':['rin','SR'],'parm_up_cursor':['cuu','UP'],'parm_up_micro':['mcuu','Zi'],'pkey_key':['pfkey','pk'],'pkey_local':['pfloc','pl'],'pkey_xmit':['pfx','px'],'plab_norm':['pln','pn'],'print_screen':['mc0','ps'],'prtr_non':['mc5p','pO'],'prtr_off':['mc4','pf'],'prtr_on':['mc5','po'],'pulse':['pulse','PU'],'quick_dial':['qdial','QD'],'remove_clock':['rmclk','RC'],'repeat_char':['rep','rp'],'req_for_input':['rfi','RF'],'reset_1string':['rs1','r1'],'reset_2string':['rs2','r2'],'reset_3string':['rs3','r3'],'reset_file':['rf','rf'],'restore_cursor':['rc','rc'],'row_address':['vpa','cv'],'save_cursor':['sc','sc'],'scroll_forward':['ind','sf'],'scroll_reverse':['ri','sr'],'select_char_set':['scs','Zj'],'set_attributes':['sgr','sa'],'set_background':['setb','Sb'],'set_bottom_margin':['smgb','Zk'],'set_bottom_margin_parm':['smgbp','Zl'],'set_clock':['sclk','SC'],'set_color_pair':['scp','sp'],'set_foreground':['setf','Sf'],'set_left_margin':['smgl','ML'],'set_left_margin_parm':['smglp','Zm'],'set_right_margin':['smgr','MR'],'set_right_margin_parm':['smgrp','Zn'],'set_tab':['hts','st'],'set_top_margin':['smgt','Zo'],'set_top_margin_parm':['smgtp','Zp'],'set_window':['wind','wi'],'start_bit_image':['sbim','Zq'],'start_char_set_def':['scsd','Zr'],'stop_bit_image':['rbim','Zs'],'stop_char_set_def':['rcsd','Zt'],'subscript_characters':['subcs','Zu'],'superscript_characters':['supcs','Zv'],'tab':['ht','ta'],'these_cause_cr':['docr','Zw'],'to_status_line':['tsl','ts'],'tone':['tone','TO'],'underline_char':['uc','uc'],'up_half_line':['hu','hu'],'user0':['u0','u0'],'user1':['u1','u1'],'user2':['u2','u2'],'user3':['u3','u3'],'user4':['u4','u4'],'user5':['u5','u5'],'user6':['u6','u6'],'user7':['u7','u7'],'user8':['u8','u8'],'user9':['u9','u9'],'wait_tone':['wait','WA'],'xoff_character':['xoffc','XF'],'xon_character':['xonc','XN'],'zero_motion':['zerom','Zx'],'alt_scancode_esc':['scesa','S8'],'bit_image_carriage_return':['bicr','Yv'],'bit_image_newline':['binel','Zz'],'bit_image_repeat':['birep','Xy'],'char_set_names':['csnm','Zy'],'code_set_init':['csin','ci'],'color_names':['colornm','Yw'],'define_bit_image_region':['defbi','Yx'],'device_type':['devt','dv'],'display_pc_char':['dispc','S1'],'end_bit_image_region':['endbi','Yy'],'enter_pc_charset_mode':['smpch','S2'],'enter_scancode_mode':['smsc','S4'],'exit_pc_charset_mode':['rmpch','S3'],'exit_scancode_mode':['rmsc','S5'],'get_mouse':['getm','Gm'],'key_mouse':['kmous','Km'],'mouse_info':['minfo','Mi'],'pc_term_options':['pctrm','S6'],'pkey_plab':['pfxl','xl'],'req_mouse_pos':['reqmp','RQ'],'scancode_escape':['scesc','S7'],'set0_des_seq':['s0ds','s0'],'set1_des_seq':['s1ds','s1'],'set2_des_seq':['s2ds','s2'],'set3_des_seq':['s3ds','s3'],'set_a_background':['setab','AB'],'set_a_foreground':['setaf','AF'],'set_color_band':['setcolor','Yz'],'set_lr_margin':['smglr','ML'],'set_page_length':['slines','YZ'],'set_tb_margin':['smgtb','MT'],'enter_horizontal_hl_mode':['ehhlm','Xh'],'enter_left_hl_mode':['elhlm','Xl'],'enter_low_hl_mode':['elohlm','Xo'],'enter_right_hl_mode':['erhlm','Xr'],'enter_top_hl_mode':['ethlm','Xt'],'enter_vertical_hl_mode':['evhlm','Xv'],'set_a_attributes':['sgr1','sA'],'set_pglen_inch':['slength','sL']};};BundleModuleCode['term/colors']=function(module,exports){exports.match=function(r1,g1,b1){if(typeof r1==='string'){var hex=r1;if(hex[0]!=='#'){return-1;}
hex=exports.hexToRGB(hex);r1=hex[0],g1=hex[1],b1=hex[2];}else if(Array.isArray(r1)){b1=r1[2],g1=r1[1],r1=r1[0];}
var hash=(r1<<16)|(g1<<8)|b1;if(exports._cache[hash]!=null){return exports._cache[hash];}
var ldiff=Infinity,li=-1,i=0,c,r2,g2,b2,diff;for(;i<exports.vcolors.length;i++){c=exports.vcolors[i];r2=c[0];g2=c[1];b2=c[2];diff=colorDistance(r1,g1,b1,r2,g2,b2);if(diff===0){li=i;break;}
if(diff<ldiff){ldiff=diff;li=i;}}
return exports._cache[hash]=li;};exports.RGBToHex=function(r,g,b){if(Array.isArray(r)){b=r[2],g=r[1],r=r[0];}
function hex(n){n=n.toString(16);if(n.length<2)n='0'+n;return n;}
return'#'+hex(r)+hex(g)+hex(b);};exports.hexToRGB=function(hex){if(hex.length===4){hex=hex[0]
+hex[1]+hex[1]
+hex[2]+hex[2]
+hex[3]+hex[3];}
var col=parseInt(hex.substring(1),16),r=(col>>16)&0xff,g=(col>>8)&0xff,b=col&0xff;return[r,g,b];};function colorDistance(r1,g1,b1,r2,g2,b2){return Math.pow(30*(r1-r2),2)
+Math.pow(59*(g1-g2),2)
+Math.pow(11*(b1-b2),2);}
exports.mixColors=function(c1,c2,alpha){if(c1===0x1ff)c1=0;if(c2===0x1ff)c2=0;if(alpha==null)alpha=0.5;c1=exports.vcolors[c1];var r1=c1[0];var g1=c1[1];var b1=c1[2];c2=exports.vcolors[c2];var r2=c2[0];var g2=c2[1];var b2=c2[2];r1+=(r2-r1)*alpha|0;g1+=(g2-g1)*alpha|0;b1+=(b2-b1)*alpha|0;return exports.match([r1,g1,b1]);};exports.blend=function blend(attr,attr2,alpha){var name,i,c,nc;var bg=attr&0x1ff;if(attr2!=null){var bg2=attr2&0x1ff;if(bg===0x1ff)bg=0;if(bg2===0x1ff)bg2=0;bg=exports.mixColors(bg,bg2,alpha);}else{if(blend._cache[bg]!=null){bg=blend._cache[bg];}else if(bg>=8&&bg<=15){bg-=8;}else{name=exports.ncolors[bg];if(name){for(i=0;i<exports.ncolors.length;i++){if(name===exports.ncolors[i]&&i!==bg){c=exports.vcolors[bg];nc=exports.vcolors[i];if(nc[0]+nc[1]+nc[2]<c[0]+c[1]+c[2]){blend._cache[bg]=i;bg=i;break;}}}}}}
attr&=~0x1ff;attr|=bg;var fg=(attr>>9)&0x1ff;if(attr2!=null){var fg2=(attr2>>9)&0x1ff;if(fg===0x1ff){fg=248;}else{if(fg===0x1ff)fg=7;if(fg2===0x1ff)fg2=7;fg=exports.mixColors(fg,fg2,alpha);}}else{if(blend._cache[fg]!=null){fg=blend._cache[fg];}else if(fg>=8&&fg<=15){fg-=8;}else{name=exports.ncolors[fg];if(name){for(i=0;i<exports.ncolors.length;i++){if(name===exports.ncolors[i]&&i!==fg){c=exports.vcolors[fg];nc=exports.vcolors[i];if(nc[0]+nc[1]+nc[2]<c[0]+c[1]+c[2]){blend._cache[fg]=i;fg=i;break;}}}}}}
attr&=~(0x1ff<<9);attr|=fg<<9;return attr;};exports.blend._cache={};exports._cache={};exports.reduce=function(color,total){if(color>=16&&total<=16){color=exports.ccolors[color];}else if(color>=8&&total<=8){color-=8;}else if(color>=2&&total<=2){color%=2;}
return color;};exports.xterm=['#000000','#cd0000','#00cd00','#cdcd00','#0000ee','#cd00cd','#00cdcd','#e5e5e5','#7f7f7f','#ff0000','#00ff00','#ffff00','#5c5cff','#ff00ff','#00ffff','#ffffff'];exports.colors=(function(){var cols=exports.colors=[],_cols=exports.vcolors=[],r,g,b,i,l;function hex(n){n=n.toString(16);if(n.length<2)n='0'+n;return n;}
function push(i,r,g,b){cols[i]='#'+hex(r)+hex(g)+hex(b);_cols[i]=[r,g,b];}
exports.xterm.forEach(function(c,i){c=parseInt(c.substring(1),16);push(i,(c>>16)&0xff,(c>>8)&0xff,c&0xff);});for(r=0;r<6;r++){for(g=0;g<6;g++){for(b=0;b<6;b++){i=16+(r*36)+(g*6)+b;push(i,r?(r*40+55):0,g?(g*40+55):0,b?(b*40+55):0);}}}
for(g=0;g<24;g++){l=(g*10)+8;i=232+g;push(i,l,l,l);}
return cols;})();exports.ccolors=(function(){var _cols=exports.vcolors.slice(),cols=exports.colors.slice(),out;exports.vcolors=exports.vcolors.slice(0,8);exports.colors=exports.colors.slice(0,8);out=cols.map(exports.match);exports.colors=cols;exports.vcolors=_cols;exports.ccolors=out;return out;})();var colorNames=exports.colorNames={default:-1,normal:-1,bg:-1,fg:-1,black:0,red:1,green:2,yellow:3,blue:4,magenta:5,cyan:6,white:7,lightblack:8,lightred:9,lightgreen:10,lightyellow:11,lightblue:12,lightmagenta:13,lightcyan:14,lightwhite:15,brightblack:8,brightred:9,brightgreen:10,brightyellow:11,brightblue:12,brightmagenta:13,brightcyan:14,brightwhite:15,grey:8,gray:8,lightgrey:7,lightgray:7,brightgrey:7,brightgray:7};exports.convert=function(color){if(typeof color==='number'){;}else if(typeof color==='string'){color=color.replace(/[\- ]/g,'');if(colorNames[color]!=null){color=colorNames[color];}else{color=exports.match(color);}}else if(Array.isArray(color)){color=exports.match(color);}else{color=-1;}
return color!==-1?color:0x1ff;};exports.ccolors={blue:[4,12,[17,21],[24,27],[31,33],[38,39],45,[54,57],[60,63],[67,69],[74,75],81,[91,93],[97,99],[103,105],[110,111],117,[128,129],[134,135],[140,141],[146,147],153,165,171,177,183,189],green:[2,10,22,[28,29],[34,36],[40,43],[46,50],[64,65],[70,72],[76,79],[82,86],[106,108],[112,115],[118,122],[148,151],[154,158],[190,194]],cyan:[6,14,23,30,37,44,51,66,73,80,87,109,116,123,152,159,195],red:[1,9,52,[88,89],[94,95],[124,126],[130,132],[136,138],[160,163],[166,169],[172,175],[178,181],[196,200],[202,206],[208,212],[214,218],[220,224]],magenta:[5,13,53,90,96,127,133,139,164,170,176,182,201,207,213,219,225],yellow:[3,11,58,[100,101],[142,144],[184,187],[226,230]],black:[0,8,16,59,102,[232,243]],white:[7,15,145,188,231,[244,255]]};exports.ncolors=[];Object.keys(exports.ccolors).forEach(function(name){exports.ccolors[name].forEach(function(offset){if(typeof offset==='number'){exports.ncolors[offset]=name;exports.ccolors[offset]=exports.colorNames[name];return;}
for(var i=offset[0],l=offset[1];i<=l;i++){exports.ncolors[i]=name;exports.ccolors[i]=exports.colorNames[name];}});delete exports.ccolors[name];});};BundleModuleCode['term/keys']=function(module,exports){var EventEmitter=Require('events').EventEmitter;function listenerCount(stream,event){return EventEmitter.listenerCount?EventEmitter.listenerCount(stream,event):stream.listeners(event).length;}
function emitKeypressEvents(stream){if(stream._keypressDecoder)return;var StringDecoder=Require('string_decoder').StringDecoder;stream._keypressDecoder=new StringDecoder('utf8');function onData(b){if(listenerCount(stream,'keypress')>0){var r=stream._keypressDecoder.write(b);if(r)emitKeys(stream,r);}else{stream.removeListener('data',onData);stream.on('newListener',onNewListener);}}
function onNewListener(event){if(event==='keypress'){stream.on('data',onData);stream.removeListener('newListener',onNewListener);}}
if(listenerCount(stream,'keypress')>0){stream.on('data',onData);}else{stream.on('newListener',onNewListener);}}
exports.emitKeypressEvents=emitKeypressEvents;var metaKeyCodeReAnywhere=/(?:\x1b)([a-zA-Z0-9])/;var metaKeyCodeRe=new RegExp('^'+metaKeyCodeReAnywhere.source+'$');var functionKeyCodeReAnywhere=new RegExp('(?:\x1b+)(O|N|\\[|\\[\\[)(?:'+['(\\d+)(?:;(\\d+))?([~^$])','(?:M([@ #!a`])(.)(.))','(?:1;)?(\\d+)?([a-zA-Z])'].join('|')+')');var functionKeyCodeRe=new RegExp('^'+functionKeyCodeReAnywhere.source);var escapeCodeReAnywhere=new RegExp([functionKeyCodeReAnywhere.source,metaKeyCodeReAnywhere.source,/\x1b./.source].join('|'));function emitKeys(stream,s){if(Buffer.isBuffer(s)){if(s[0]>127&&s[1]===undefined){s[0]-=128;s='\x1b'+s.toString(stream.encoding||'utf-8');}else{s=s.toString(stream.encoding||'utf-8');}}
if(isMouse(s))return;var buffer=[];var match;while(match=escapeCodeReAnywhere.exec(s)){buffer=buffer.concat(s.slice(0,match.index).split(''));buffer.push(match[0]);s=s.slice(match.index+match[0].length);}
buffer=buffer.concat(s.split(''));buffer.forEach(function(s){var ch,key={sequence:s,name:undefined,ctrl:false,meta:false,shift:false},parts;if(s==='\r'){key.name='return';}else if(s==='\n'){key.name='enter';}else if(s==='\t'){key.name='tab';}else if(s==='\b'||s==='\x7f'||s==='\x1b\x7f'||s==='\x1b\b'){key.name='backspace';key.meta=(s.charAt(0)==='\x1b');}else if(s==='\x1b'||s==='\x1b\x1b'){key.name='escape';key.meta=(s.length===2);}else if(s===' '||s==='\x1b '){key.name='space';key.meta=(s.length===2);}else if(s.length===1&&s<='\x1a'){key.name=String.fromCharCode(s.charCodeAt(0)+'a'.charCodeAt(0)-1);key.ctrl=true;}else if(s.length===1&&s>='a'&&s<='z'){key.name=s;}else if(s.length===1&&s>='A'&&s<='Z'){key.name=s.toLowerCase();key.shift=true;}else if(parts=metaKeyCodeRe.exec(s)){key.name=parts[1].toLowerCase();key.meta=true;key.shift=/^[A-Z]$/.test(parts[1]);}else if(parts=functionKeyCodeRe.exec(s)){var code=(parts[1]||'')+(parts[2]||'')+
(parts[4]||'')+(parts[9]||''),modifier=(parts[3]||parts[8]||1)-1;key.ctrl=!!(modifier&4);key.meta=!!(modifier&10);key.shift=!!(modifier&1);key.code=code;switch(code){case'OP':key.name='f1';break;case'OQ':key.name='f2';break;case'OR':key.name='f3';break;case'OS':key.name='f4';break;case'[11~':key.name='f1';break;case'[12~':key.name='f2';break;case'[13~':key.name='f3';break;case'[14~':key.name='f4';break;case'[[A':key.name='f1';break;case'[[B':key.name='f2';break;case'[[C':key.name='f3';break;case'[[D':key.name='f4';break;case'[[E':key.name='f5';break;case'[15~':key.name='f5';break;case'[17~':key.name='f6';break;case'[18~':key.name='f7';break;case'[19~':key.name='f8';break;case'[20~':key.name='f9';break;case'[21~':key.name='f10';break;case'[23~':key.name='f11';break;case'[24~':key.name='f12';break;case'[A':key.name='up';break;case'[B':key.name='down';break;case'[C':key.name='right';break;case'[D':key.name='left';break;case'[E':key.name='clear';break;case'[F':key.name='end';break;case'[H':key.name='home';break;case'OA':key.name='up';break;case'OB':key.name='down';break;case'OC':key.name='right';break;case'OD':key.name='left';break;case'OE':key.name='clear';break;case'OF':key.name='end';break;case'OH':key.name='home';break;case'[1~':key.name='home';break;case'[2~':key.name='insert';break;case'[3~':key.name='delete';break;case'[4~':key.name='end';break;case'[5~':key.name='pageup';break;case'[6~':key.name='pagedown';break;case'[[5~':key.name='pageup';break;case'[[6~':key.name='pagedown';break;case'[7~':key.name='home';break;case'[8~':key.name='end';break;case'[a':key.name='up';key.shift=true;break;case'[b':key.name='down';key.shift=true;break;case'[c':key.name='right';key.shift=true;break;case'[d':key.name='left';key.shift=true;break;case'[e':key.name='clear';key.shift=true;break;case'[2$':key.name='insert';key.shift=true;break;case'[3$':key.name='delete';key.shift=true;break;case'[5$':key.name='pageup';key.shift=true;break;case'[6$':key.name='pagedown';key.shift=true;break;case'[7$':key.name='home';key.shift=true;break;case'[8$':key.name='end';key.shift=true;break;case'Oa':key.name='up';key.ctrl=true;break;case'Ob':key.name='down';key.ctrl=true;break;case'Oc':key.name='right';key.ctrl=true;break;case'Od':key.name='left';key.ctrl=true;break;case'Oe':key.name='clear';key.ctrl=true;break;case'[2^':key.name='insert';key.ctrl=true;break;case'[3^':key.name='delete';key.ctrl=true;break;case'[5^':key.name='pageup';key.ctrl=true;break;case'[6^':key.name='pagedown';key.ctrl=true;break;case'[7^':key.name='home';key.ctrl=true;break;case'[8^':key.name='end';key.ctrl=true;break;case'[Z':key.name='tab';key.shift=true;break;default:key.name='undefined';break;}}
if(key.name===undefined){key=undefined;}
if(s.length===1){ch=s;}
if(key||ch){stream.emit('keypress',ch,key);}});}
function isMouse(s){return/\x1b\[M/.test(s)||/\x1b\[M([\x00\u0020-\ufffe]{3})/.test(s)||/\x1b\[(\d+;\d+;\d+)M/.test(s)||/\x1b\[<(\d+;\d+;\d+)([mM])/.test(s)||/\x1b\[<(\d+;\d+;\d+;\d+)&w/.test(s)||/\x1b\[24([0135])~\[(\d+),(\d+)\]\r/.test(s)||/\x1b\[(O|I)/.test(s);}};BundleModuleCode['term/widget']=function(module,exports){var widget=exports;widget.classes=['Node','Screen','Element','Box','Chat','Text','Line','ScrollableBox','ScrollableText','BigText','List','Form','Input','Textarea','Textbox','Button','ProgressBar','FileManager','Checkbox','RadioSet','RadioButton','Prompt','Question','Message','Keyboard','Loading','Listbar','Log','Table','ListTable','Terminal','Image','ANSIImage','OverlayImage','Video','Layout','Log','Tree'];widget.classes.forEach(function(name){var file=name.toLowerCase();widget[name]=widget[file]=Require('term/widgets/'+file);});widget.aliases={'ListBar':'Listbar','PNG':'ANSIImage'};Object.keys(widget.aliases).forEach(function(key){var name=widget.aliases[key];widget[key]=widget[name];widget[key.toLowerCase()]=widget[name];});};BundleModuleCode['term/widgets/node']=function(module,exports){var Comp=Require('com/compat');var EventEmitter=Require('term/events').EventEmitter;function Node(options){var self=this;var Screen=Require('term/widgets/screen');if(!instanceOf(this,Node)){return new Node(options);}
EventEmitter.call(this);options=options||{};this.options=options;this.screen=this.screen||options.screen;if(!this.screen){if(this.type==='screen'){this.screen=this;}else if(Screen.total===1){this.screen=Screen.global;}else if(options.parent){this.screen=options.parent;while(this.screen&&this.screen.type!=='screen'){this.screen=this.screen.parent;}}else if(Screen.total){this.screen=Screen.instances[Screen.instances.length-1];process.nextTick(function(){if(!self.parent){throw new Error('Element ('+self.type+')'
+' was not appended synchronously after the'
+' screen\'s creation. Please set a `parent`'
+' or `screen` option in the element\'s constructor'
+' if you are going to use multiple screens and'
+' append the element later.');}});}else{throw new Error('No active screen.');}}
this.parent=options.parent||null;this.children=[];this.$=this._=this.data={};this.uid=Node.uid++;this.index=this.index!=null?this.index:-1;if(this.type!=='screen'){this.detached=true;}
if(this.parent){this.parent.append(this);}
(options.children||[]).forEach(this.append.bind(this));}
Node.uid=0;inheritPrototype(Node,EventEmitter);Node.prototype.type='node';Node.prototype.insert=function(element,i){var self=this;if(element.screen&&element.screen!==this.screen){throw new Error('Cannot switch a node\'s screen.');}
element.detach();element.parent=this;element.screen=this.screen;if(i===0){this.children.unshift(element);}else if(i===this.children.length){this.children.push(element);}else{this.children.splice(i,0,element);}
element.emit('reparent',this);this.emit('adopt',element);(function emit(el){var n=el.detached!==self.detached;el.detached=self.detached;if(n)el.emit('attach');el.children.forEach(emit);})(element);if(!this.screen.focused){this.screen.focused=element;}};Node.prototype.prepend=function(element){this.insert(element,0);};Node.prototype.append=function(element){this.insert(element,this.children.length);};Node.prototype.insertBefore=function(element,other){var i=this.children.indexOf(other);if(~i)this.insert(element,i);};Node.prototype.insertAfter=function(element,other){var i=this.children.indexOf(other);if(~i)this.insert(element,i+1);};Node.prototype.remove=function(element){if(element.parent!==this)return;var i=this.children.indexOf(element);if(!~i)return;element.clearPos();element.parent=null;this.children.splice(i,1);i=this.screen.clickable.indexOf(element);if(~i)this.screen.clickable.splice(i,1);i=this.screen.keyable.indexOf(element);if(~i)this.screen.keyable.splice(i,1);element.emit('reparent',null);this.emit('remove',element);(function emit(el){var n=el.detached!==true;el.detached=true;if(n)el.emit('detach');el.children.forEach(emit);})(element);if(this.screen.focused===element){this.screen.rewindFocus();}};Node.prototype.detach=function(){if(this.parent)this.parent.remove(this);};Node.prototype.free=function(){return;};Node.prototype.destroy=function(){this.detach();this.forDescendants(function(el){el.free();el.destroyed=true;el.emit('destroy');},this);};Node.prototype.forDescendants=function(iter,s){if(s)iter(this);this.children.forEach(function emit(el){iter(el);el.children.forEach(emit);});};Node.prototype.forAncestors=function(iter,s){var el=this;if(s)iter(this);while(el=el.parent){iter(el);}};Node.prototype.collectDescendants=function(s){var out=[];this.forDescendants(function(el){out.push(el);},s);return out;};Node.prototype.collectAncestors=function(s){var out=[];this.forAncestors(function(el){out.push(el);},s);return out;};Node.prototype.emitDescendants=function(){var args=Array.prototype.slice(arguments),iter;if(typeof args[args.length-1]==='function'){iter=args.pop();}
return this.forDescendants(function(el){if(iter)iter(el);el.emit.apply(el,args);},true);};Node.prototype.emitAncestors=function(){var args=Array.prototype.slice(arguments),iter;if(typeof args[args.length-1]==='function'){iter=args.pop();}
return this.forAncestors(function(el){if(iter)iter(el);el.emit.apply(el,args);},true);};Node.prototype.hasDescendant=function(target){return(function find(el){for(var i=0;i<el.children.length;i++){if(el.children[i]===target){return true;}
if(find(el.children[i])===true){return true;}}
return false;})(this);};Node.prototype.hasAncestor=function(target){var el=this;while(el=el.parent){if(el===target)return true;}
return false;};Node.prototype.get=function(name,value){if(this.data.hasOwnProperty(name)){return this.data[name];}
return value;};Node.prototype.set=function(name,value){return this.data[name]=value;};module.exports=Node;};BundleModuleCode['term/events']=function(module,exports){var slice=Array.prototype.slice;function EventEmitter(){if(!this._events)this._events={};}
EventEmitter.prototype.setMaxListeners=function(n){this._maxListeners=n;};EventEmitter.prototype.addListener=function(type,listener){if(!this._events[type]){this._events[type]=listener;}else if(typeof this._events[type]==='function'){this._events[type]=[this._events[type],listener];}else{this._events[type].push(listener);}
this._emit('newListener',[type,listener]);};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.removeListener=function(type,listener){var handler=this._events[type];if(!handler)return;if(typeof handler==='function'){if(!(handler===listener))return;delete this._events[type];this._emit('removeListener',[type,listener]);return;}
if(handler.length===1){if(!(handler[0]===listener))return;delete this._events[type];this._emit('removeListener',[type,listener]);return;}
for(var i=0;i<handler.length;i++){if(handler[i]===listener||handler[i].listener===listener){handler.splice(i,1);this._emit('removeListener',[type,listener]);return;}}};EventEmitter.prototype.off=EventEmitter.prototype.removeListener;EventEmitter.prototype.removeAllListeners=function(type){if(type){delete this._events[type];}else{this._events={};}};EventEmitter.prototype.once=function(type,listener){function on(){this.removeListener(type,on);return listener.apply(this,arguments);}
on.listener=listener;return this.on(type,on);};EventEmitter.prototype.listeners=function(type){return typeof this._events[type]==='function'?[this._events[type]]:this._events[type]||[];};EventEmitter.prototype._emit=function(type,args){var handler=this._events[type],ret;if(!handler){if(type==='error'){throw new args[0];}
return;}
if(typeof handler==='function'){return handler.apply(this,args);}
for(var i=0;i<handler.length;i++){if(handler[i].apply(this,args)===false){ret=false;}}
return ret!==false;};EventEmitter.prototype.emit=function(type){var args=slice.call(arguments,1),params=slice.call(arguments),el=this;this._emit('event',params);if(this.type==='screen'){return this._emit(type,args);}
if(this._emit(type,args)===false){return false;}
type='element '+type;args.unshift(this);do{if(!el._events[type])continue;if(el._emit(type,args)===false){return false;}}while(el=el.parent);return true;};exports=EventEmitter;exports.EventEmitter=EventEmitter;module.exports=exports;};BundleModuleCode['term/widgets/screen']=function(module,exports){var Comp=Require('com/compat');var path=Require('path'),fs=Require('fs'),cp=Require('child_process');var colors=Require('term/colors'),program=Require('term/program'),unicode=Require('term/unicode');var nextTick=global.setImmediate||process.nextTick.bind(process);var helpers=Require('term/helpers');var Node=Require('term/widgets/node');var Log=Require('term/widgets/log');var Element=Require('term/widgets/element');var Box=Require('term/widgets/box');function Screen(options){var self=this;if(!instanceOf(this,Node)){return new Screen(options);}
Screen.bind(this);options=options||{};if(options.rsety&&options.listen){options={program:options};}
this.program=options.program;if(!this.program){this.program=program({input:options.input,output:options.output,log:options.log,debug:options.debug,dump:options.dump,terminal:options.terminal||options.term,resizeTimeout:options.resizeTimeout,forceUnicode:options.forceUnicode,tput:true,buffer:true,zero:true});}else{this.program.setupTput();this.program.useBuffer=true;this.program.zero=true;this.program.options.resizeTimeout=options.resizeTimeout;if(options.forceUnicode!=null){this.program.tput.features.unicode=options.forceUnicode;this.program.tput.unicode=options.forceUnicode;}}
this.tput=this.program.tput;Node.call(this,options);this.autoPadding=options.autoPadding!==false;this.tabc=Array((options.tabSize||4)+1).join(' ');this.dockBorders=options.dockBorders;this.forceCursor=options.forceCursor;this.ignoreLocked=options.ignoreLocked||[];this._unicode=this.tput.unicode||this.tput.numbers.U8===1;this.fullUnicode=this.options.fullUnicode&&this._unicode;this.dattr=((0<<18)|(0x1ff<<9))|0x1ff;this.renders=0;this.position={left:this.left=this.aleft=this.rleft=0,right:this.right=this.aright=this.rright=0,top:this.top=this.atop=this.rtop=0,bottom:this.bottom=this.abottom=this.rbottom=0,get height(){return self.height;},get width(){return self.width;}};this.ileft=0;this.itop=0;this.iright=0;this.ibottom=0;this.iheight=0;this.iwidth=0;this.padding={left:0,top:0,right:0,bottom:0};this.hover=null;this.history=[];this.clickable=[];this.keyable=[];this.grabKeys=false;this.lockKeys=false;this.focused;this._buf='';this._ci=-1;if(options.title){this.title=options.title;}
options.cursor=options.cursor||{artificial:options.artificialCursor,shape:options.cursorShape,blink:options.cursorBlink,color:options.cursorColor};this.cursor={artificial:options.cursor.artificial||false,shape:options.cursor.shape||'block',blink:options.cursor.blink||false,color:options.cursor.color||null,_set:false,_state:1,_hidden:true};this.program.on('resize',function(){self.alloc();self.render();(function emit(el){el.emit('resize');el.children.forEach(emit);})(self);});this.program.on('focus',function(){self.emit('focus');});this.program.on('blur',function(){self.emit('blur');});this.program.on('warning',function(text){self.emit('warning',text);});this.on('newListener',function fn(type){if(type==='keypress'||type.indexOf('key ')===0||type==='mouse'){if(type==='keypress'||type.indexOf('key ')===0)self._listenKeys();if(type==='mouse')self._listenMouse();}
if(type==='mouse'||type==='click'||type==='mouseover'||type==='mouseout'||type==='mousedown'||type==='mouseup'||type==='mousewheel'||type==='wheeldown'||type==='wheelup'||type==='mousemove'){self._listenMouse();}});this.setMaxListeners(Infinity);this.enter();this.postEnter();}
Screen.global=null;Screen.total=0;Screen.instances=[];Screen.bind=function(screen){if(!Screen.global){Screen.global=screen;}
if(!~Screen.instances.indexOf(screen)){Screen.instances.push(screen);screen.index=Screen.total;Screen.total++;}
if(Screen._bound)return;Screen._bound=true;process.on('uncaughtException',Screen._exceptionHandler=function(err){if(process.listeners('uncaughtException').length>1){return;}
Screen.instances.slice().forEach(function(screen){screen.destroy();});err=err||new Error('Uncaught Exception.');console.error(err.stack?err.stack+'':err+'');nextTick(function(){process.exit(1);});});['SIGTERM','SIGINT','SIGQUIT'].forEach(function(signal){var name='_'+signal.toLowerCase()+'Handler';process.on(signal,Screen[name]=function(){if(process.listeners(signal).length>1){return;}
nextTick(function(){process.exit(0);});});});process.on('exit',Screen._exitHandler=function(){Screen.instances.slice().forEach(function(screen){screen.destroy();});});};inheritPrototype(Screen,Node);Screen.prototype.type='screen';defineGetter(Screen,'title',function(){return this.program.title;});defineSetter(Screen,'title',function(title){return this.program.title=title;});defineGetter(Screen,'terminal',function(){return this.program.terminal;});defineSetter(Screen,'terminal',function(terminal){this.setTerminal(terminal);return this.program.terminal;});Screen.prototype.setTerminal=function(terminal){var entered=!!this.program.isAlt;if(entered){this._buf='';this.program._buf='';this.leave();}
this.program.setTerminal(terminal);this.tput=this.program.tput;if(entered){this.enter();}};Screen.prototype.enter=function(){if(this.program.isAlt)return;if(!this.cursor._set){if(this.options.cursor.shape){this.cursorShape(this.cursor.shape,this.cursor.blink);}
if(this.options.cursor.color){this.cursorColor(this.cursor.color);}}
if(process.platform==='win32'){try{cp.execSync('cls',{stdio:'ignore',timeout:1000});}catch(e){;}}
this.program.alternateBuffer();this.program.put.keypad_xmit();this.program.csr(0,this.height-1);this.program.hideCursor();this.program.cup(0,0);if(this.tput.strings.ena_acs){this.program._write(this.tput.enacs());}
this.alloc();};Screen.prototype.leave=function(){if(!this.program.isAlt)return;this.program.put.keypad_local();if(this.program.scrollTop!==0||this.program.scrollBottom!==this.rows-1){this.program.csr(0,this.height-1);}
this.program.showCursor();this.alloc();if(this._listenedMouse){this.program.disableMouse();}
this.program.normalBuffer();if(this.cursor._set)this.cursorReset();this.program.flush();if(process.platform==='win32'){try{cp.execSync('cls',{stdio:'ignore',timeout:1000});}catch(e){;}}};Screen.prototype.postEnter=function(){var self=this;if(this.options.debug){this.debugLog=new Log({screen:this,parent:this,hidden:true,draggable:true,left:'center',top:'center',width:'30%',height:'30%',border:'line',label:' {bold}Debug Log{/bold} ',tags:true,keys:true,vi:true,mouse:true,scrollbar:{ch:' ',track:{bg:'yellow'},style:{inverse:true}}});this.debugLog.toggle=function(){if(self.debugLog.hidden){self.saveFocus();self.debugLog.show();self.debugLog.setFront();self.debugLog.focus();}else{self.debugLog.hide();self.restoreFocus();}
self.render();};this.debugLog.key(['q','escape'],self.debugLog.toggle);this.key('f12',self.debugLog.toggle);}
if(this.options.warnings){this.on('warning',function(text){var warning=new Box({screen:self,parent:self,left:'center',top:'center',width:'shrink',padding:1,height:'shrink',align:'center',valign:'middle',border:'line',label:' {red-fg}{bold}WARNING{/} ',content:'{bold}'+text+'{/bold}',tags:true});self.render();var timeout=setTimeout(function(){warning.destroy();self.render();},1500);if(timeout.unref){timeout.unref();}});}};Screen.prototype._destroy=Screen.prototype.destroy;Screen.prototype.destroy=function(){if(!this.program)return;this.leave();var index=Screen.instances.indexOf(this);if(~index){Screen.instances.splice(index,1);Screen.total--;Screen.global=Screen.instances[0];if(Screen.total===0){Screen.global=null;process.removeListener('uncaughtException',Screen._exceptionHandler);process.removeListener('SIGTERM',Screen._sigtermHandler);process.removeListener('SIGINT',Screen._sigintHandler);process.removeListener('SIGQUIT',Screen._sigquitHandler);process.removeListener('exit',Screen._exitHandler);delete Screen._exceptionHandler;delete Screen._sigtermHandler;delete Screen._sigintHandler;delete Screen._sigquitHandler;delete Screen._exitHandler;delete Screen._bound;}
this.destroyed=true;this.emit('destroy');this._destroy();}
this.program.destroy();};Screen.prototype.log=function(){return this.program.log.apply(this.program,arguments);};Screen.prototype.debug=function(){if(this.debugLog){this.debugLog.log.apply(this.debugLog,arguments);}
return this.program.debug.apply(this.program,arguments);};Screen.prototype._listenMouse=function(el){var self=this;if(el&&!~this.clickable.indexOf(el)){el.clickable=true;this.clickable.push(el);}
if(this._listenedMouse)return;this._listenedMouse=true;this.program.enableMouse();if(this.options.sendFocus){this.program.setMouse({sendFocus:true},true);}
this.on('render',function(){self._needsClickableSort=true;});this.program.on('mouse',function(data){if(self.lockKeys)return;if(self._needsClickableSort){self.clickable=helpers.hsort(self.clickable);self._needsClickableSort=false;}
var i=0,el,set,pos;for(;i<self.clickable.length;i++){el=self.clickable[i];if(el.detached||!el.visible){continue;}
pos=el.lpos;if(!pos)continue;if(data.x>=pos.xi&&data.x<pos.xl&&data.y>=pos.yi&&data.y<pos.yl){el.emit('mouse',data);if(data.action==='mousedown'){self.mouseDown=el;}else if(data.action==='mouseup'){(self.mouseDown||el).emit('click',data);self.mouseDown=null;}else if(data.action==='mousemove'){if(self.hover&&el.index>self.hover.index){set=false;}
if(self.hover!==el&&!set){if(self.hover){self.hover.emit('mouseout',data);}
el.emit('mouseover',data);self.hover=el;}
set=true;}
el.emit(data.action,data);break;}}
if((data.action==='mousemove'||data.action==='mousedown'||data.action==='mouseup')&&self.hover&&!set){self.hover.emit('mouseout',data);self.hover=null;}
self.emit('mouse',data);self.emit(data.action,data);});this.on('element click',function(el){if(el.clickable===true&&el.options.autoFocus!==false){el.focus();}});};Screen.prototype.enableMouse=function(el){this._listenMouse(el);};Screen.prototype._listenKeys=function(el){var self=this;if(el&&!~this.keyable.indexOf(el)){el.keyable=true;this.keyable.push(el);}
if(this._listenedKeys)return;this._listenedKeys=true;this.program.on('keypress',function(ch,key){if(key.name=='tab'){self.program.hideCursor(self.forceCursor);var last=self.focused;var first=undefined;var next=undefined;for(var c in self.children){var child=self.children[c];if(first==undefined)first=child;if(last==undefined&&next==undefined&&child&&child.options&&child.options.focus)next=child;if(last&&child==last)last=undefined;if(last&&child[last.type]==last)last=undefined;}
if(!next)next=first;if(next)next.focus();self.render();return;}
if(self.lockKeys&&!~self.ignoreLocked.indexOf(key.full)){return;}
var focused=self.focused,grabKeys=self.grabKeys;if(!grabKeys||~self.ignoreLocked.indexOf(key.full)){self.emit('keypress',ch,key);self.emit('key '+key.full,ch,key);}
if(self.grabKeys!==grabKeys||self.lockKeys){return;}
if(focused&&focused.keyable){focused.emit('keypress',ch,key);focused.emit('key '+key.full,ch,key);}});};Screen.prototype.enableKeys=function(el){this._listenKeys(el);};Screen.prototype.enableInput=function(el){this._listenMouse(el);this._listenKeys(el);};Screen.prototype._initHover=function(){var self=this;if(this._hoverText){return;}
this._hoverText=new Box({screen:this,left:0,top:0,tags:false,height:'shrink',width:'shrink',border:'line',style:{border:{fg:'default'},bg:'default',fg:'default'}});this.on('mousemove',function(data){if(self._hoverText.detached)return;self._hoverText.rleft=data.x+1;self._hoverText.rtop=data.y;self.render();});this.on('element mouseover',function(el,data){if(!el._hoverOptions)return;self._hoverText.parseTags=el.parseTags;self._hoverText.setContent(el._hoverOptions.text);self.append(self._hoverText);self._hoverText.rleft=data.x+1;self._hoverText.rtop=data.y;self.render();});this.on('element mouseout',function(){if(self._hoverText.detached)return;self._hoverText.detach();self.render();});this.on('element mouseup',function(el){if(!self._hoverText.getContent())return;if(!el._hoverOptions)return;self.append(self._hoverText);self.render();});};Object.defineProperty(Screen.prototype,'cols',{get:function(){return this.program.cols;},});Object.defineProperty(Screen.prototype,'rows',{get:function(){return this.program.rows;},});Object.defineProperty(Screen.prototype,'width',{get:function(){return this.program.cols;},});Object.defineProperty(Screen.prototype,'height',{get:function(){return this.program.rows;},});Screen.prototype.alloc=function(dirty){var x,y;this.lines=[];for(y=0;y<this.rows;y++){this.lines[y]=[];for(x=0;x<this.cols;x++){this.lines[y][x]=[this.dattr,' '];}
this.lines[y].dirty=!!dirty;}
this.olines=[];for(y=0;y<this.rows;y++){this.olines[y]=[];for(x=0;x<this.cols;x++){this.olines[y][x]=[this.dattr,' '];}}
this.program.clear();};Screen.prototype.realloc=function(){return this.alloc(true);};Screen.prototype.render=function(){var self=this;if(this.destroyed)return;this.emit('prerender');this._borderStops={};this._ci=0;this.children.forEach(function(el){el.index=self._ci++;el.render();});this._ci=-1;if(this.screen.dockBorders){this._dockBorders();}
this.draw(0,this.lines.length-1);if(this.focused&&this.focused._updateCursor){this.focused._updateCursor(true);}
this.renders++;this.emit('render');};Screen.prototype.blankLine=function(ch,dirty){var out=[];for(var x=0;x<this.cols;x++){out[x]=[this.dattr,ch||' '];}
out.dirty=dirty;return out;};Screen.prototype.insertLine=function(n,y,top,bottom){if(!this.tput.strings.change_scroll_region||!this.tput.strings.delete_line||!this.tput.strings.insert_line)return;this._buf+=this.tput.csr(top,bottom);this._buf+=this.tput.cup(y,0);this._buf+=this.tput.il(n);this._buf+=this.tput.csr(0,this.height-1);var j=bottom+1;while(n--){this.lines.splice(y,0,this.blankLine());this.lines.splice(j,1);this.olines.splice(y,0,this.blankLine());this.olines.splice(j,1);}};Screen.prototype.deleteLine=function(n,y,top,bottom){if(!this.tput.strings.change_scroll_region||!this.tput.strings.delete_line||!this.tput.strings.insert_line)return;this._buf+=this.tput.csr(top,bottom);this._buf+=this.tput.cup(y,0);this._buf+=this.tput.dl(n);this._buf+=this.tput.csr(0,this.height-1);var j=bottom+1;while(n--){this.lines.splice(j,0,this.blankLine());this.lines.splice(y,1);this.olines.splice(j,0,this.blankLine());this.olines.splice(y,1);}};Screen.prototype.insertLineNC=function(n,y,top,bottom){if(!this.tput.strings.change_scroll_region||!this.tput.strings.delete_line)return;this._buf+=this.tput.csr(top,bottom);this._buf+=this.tput.cup(top,0);this._buf+=this.tput.dl(n);this._buf+=this.tput.csr(0,this.height-1);var j=bottom+1;while(n--){this.lines.splice(j,0,this.blankLine());this.lines.splice(y,1);this.olines.splice(j,0,this.blankLine());this.olines.splice(y,1);}};Screen.prototype.deleteLineNC=function(n,y,top,bottom){if(!this.tput.strings.change_scroll_region||!this.tput.strings.delete_line)return;this._buf+=this.tput.csr(top,bottom);this._buf+=this.tput.cup(bottom,0);this._buf+=Array(n+1).join('\n');this._buf+=this.tput.csr(0,this.height-1);var j=bottom+1;while(n--){this.lines.splice(j,0,this.blankLine());this.lines.splice(y,1);this.olines.splice(j,0,this.blankLine());this.olines.splice(y,1);}};Screen.prototype.insertBottom=function(top,bottom){return this.deleteLine(1,top,top,bottom);};Screen.prototype.insertTop=function(top,bottom){return this.insertLine(1,top,top,bottom);};Screen.prototype.deleteBottom=function(top,bottom){return this.clearRegion(0,this.width,bottom,bottom);};Screen.prototype.deleteTop=function(top,bottom){return this.deleteLine(1,top,top,bottom);};Screen.prototype.cleanSides=function(el){var pos=el.lpos;if(!pos){return false;}
if(pos._cleanSides!=null){return pos._cleanSides;}
if(pos.xi<=0&&pos.xl>=this.width){return pos._cleanSides=true;}
if(this.options.fastCSR){if(pos.yi<0)return pos._cleanSides=false;if(pos.yl>this.height)return pos._cleanSides=false;if(this.width-(pos.xl-pos.xi)<40){return pos._cleanSides=true;}
return pos._cleanSides=false;}
if(!this.options.smartCSR){return false;}
var yi=pos.yi+el.itop,yl=pos.yl-el.ibottom,first,ch,x,y;if(pos.yi<0)return pos._cleanSides=false;if(pos.yl>this.height)return pos._cleanSides=false;if(pos.xi-1<0)return pos._cleanSides=true;if(pos.xl>this.width)return pos._cleanSides=true;for(x=pos.xi-1;x>=0;x--){if(!this.olines[yi])break;first=this.olines[yi][x];for(y=yi;y<yl;y++){if(!this.olines[y]||!this.olines[y][x])break;ch=this.olines[y][x];if(ch[0]!==first[0]||ch[1]!==first[1]){return pos._cleanSides=false;}}}
for(x=pos.xl;x<this.width;x++){if(!this.olines[yi])break;first=this.olines[yi][x];for(y=yi;y<yl;y++){if(!this.olines[y]||!this.olines[y][x])break;ch=this.olines[y][x];if(ch[0]!==first[0]||ch[1]!==first[1]){return pos._cleanSides=false;}}}
return pos._cleanSides=true;};Screen.prototype._dockBorders=function(){var lines=this.lines,stops=this._borderStops,i,y,x,ch;stops=Object.keys(stops).map(function(k){return+k;}).sort(function(a,b){return a-b;});for(i=0;i<stops.length;i++){y=stops[i];if(!lines[y])continue;for(x=0;x<this.width;x++){ch=lines[y][x][1];if(angles[ch]){lines[y][x][1]=this._getAngle(lines,x,y);lines[y].dirty=true;}}}};Screen.prototype._getAngle=function(lines,x,y){var angle=0,attr=lines[y][x][0],ch=lines[y][x][1];if(lines[y][x-1]&&langles[lines[y][x-1][1]]){if(!this.options.ignoreDockContrast){if(lines[y][x-1][0]!==attr)return ch;}
angle|=1<<3;}
if(lines[y-1]&&uangles[lines[y-1][x][1]]){if(!this.options.ignoreDockContrast){if(lines[y-1][x][0]!==attr)return ch;}
angle|=1<<2;}
if(lines[y][x+1]&&rangles[lines[y][x+1][1]]){if(!this.options.ignoreDockContrast){if(lines[y][x+1][0]!==attr)return ch;}
angle|=1<<1;}
if(lines[y+1]&&dangles[lines[y+1][x][1]]){if(!this.options.ignoreDockContrast){if(lines[y+1][x][0]!==attr)return ch;}
angle|=1<<0;}
return angleTable[angle]||ch;};Screen.prototype.draw=function(start,end){var x,y,line,out,ch,data,attr,fg,bg,flags;var main='',pre,post;var clr,neq,xx;var lx=-1,ly=-1,o;var acs;if(this._buf){main+=this._buf;this._buf='';}
for(y=start;y<=end;y++){line=this.lines[y];o=this.olines[y];if(!line.dirty&&!(this.cursor.artificial&&y===this.program.y)){continue;}
line.dirty=false;out='';attr=this.dattr;for(x=0;x<line.length;x++){data=line[x][0];ch=line[x][1];if(this.cursor.artificial&&!this.cursor._hidden&&this.cursor._state&&x===this.program.x&&y===this.program.y){var cattr=this._cursorAttr(this.cursor,data);if(cattr.ch)ch=cattr.ch;data=cattr.attr;}
if(this.options.useBCE&&ch===' '&&(this.tput.bools.back_color_erase||(data&0x1ff)===(this.dattr&0x1ff))&&((data>>18)&8)===((this.dattr>>18)&8)){clr=true;neq=false;for(xx=x;xx<line.length;xx++){if(line[xx][0]!==data||line[xx][1]!==' '){clr=false;break;}
if(line[xx][0]!==o[xx][0]||line[xx][1]!==o[xx][1]){neq=true;}}
if(clr&&neq){lx=-1,ly=-1;if(data!==attr){out+=this.codeAttr(data);attr=data;}
out+=this.tput.cup(y,x);out+=this.tput.el();for(xx=x;xx<line.length;xx++){o[xx][0]=data;o[xx][1]=' ';}
break;}}
if(data===o[x][0]&&ch===o[x][1]){if(lx===-1){lx=x;ly=y;}
continue;}else if(lx!==-1){if(this.tput.strings.parm_right_cursor){out+=y===ly?this.tput.cuf(x-lx):this.tput.cup(y,x);}else{out+=this.tput.cup(y,x);}
lx=-1,ly=-1;}
o[x][0]=data;o[x][1]=ch;if(data!==attr){if(attr!==this.dattr){out+='\x1b[m';}
if(data!==this.dattr){out+='\x1b[';bg=data&0x1ff;fg=(data>>9)&0x1ff;flags=data>>18;if(flags&1){out+='1;';}
if(flags&2){out+='4;';}
if(flags&4){out+='5;';}
if(flags&8){out+='7;';}
if(flags&16){out+='8;';}
if(bg!==0x1ff){bg=this._reduceColor(bg);if(bg<16){if(bg<8){bg+=40;}else if(bg<16){bg-=8;bg+=100;}
out+=bg+';';}else{out+='48;5;'+bg+';';}}
if(fg!==0x1ff){fg=this._reduceColor(fg);if(fg<16){if(fg<8){fg+=30;}else if(fg<16){fg-=8;fg+=90;}
out+=fg+';';}else{out+='38;5;'+fg+';';}}
if(out[out.length-1]===';')out=out.slice(0,-1);out+='m';}}
if(this.fullUnicode){if(unicode.charWidth(line[x][1])===2){if(x===line.length-1||angles[line[x+1][1]]){ch=' ';o[x][1]='\0';}else{o[x][1]='\0';o[++x][1]='\0';}}}
if(this.tput.strings.enter_alt_charset_mode&&!this.tput.brokenACS&&(this.tput.acscr[ch]||acs)){if(this.tput.acscr[ch]){if(acs){ch=this.tput.acscr[ch];}else{ch=this.tput.smacs()
+this.tput.acscr[ch];acs=true;}}else if(acs){ch=this.tput.rmacs()+ch;acs=false;}}else{if(!this.tput.unicode&&this.tput.numbers.U8!==1&&ch>'~'){ch=this.tput.utoa[ch]||'?';}}
out+=ch;attr=data;}
if(attr!==this.dattr){out+='\x1b[m';}
if(out){main+=this.tput.cup(y,0)+out;}}
if(acs){main+=this.tput.rmacs();acs=false;}
if(main){pre='';post='';pre+=this.tput.sc();post+=this.tput.rc();if(!this.program.cursorHidden){pre+=this.tput.civis();post+=this.tput.cnorm();}
this.program._write(pre+main+post);}};Screen.prototype._reduceColor=function(color){return colors.reduce(color,this.tput.colors);};Screen.prototype.attrCode=function(code,cur,def){var flags=(cur>>18)&0x1ff,fg=(cur>>9)&0x1ff,bg=cur&0x1ff,c,i;code=code.slice(2,-1).split(';');if(!code[0])code[0]='0';for(i=0;i<code.length;i++){c=+code[i]||0;switch(c){case 0:bg=def&0x1ff;fg=(def>>9)&0x1ff;flags=(def>>18)&0x1ff;break;case 1:flags|=1;break;case 22:flags=(def>>18)&0x1ff;break;case 4:flags|=2;break;case 24:flags=(def>>18)&0x1ff;break;case 5:flags|=4;break;case 25:flags=(def>>18)&0x1ff;break;case 7:flags|=8;break;case 27:flags=(def>>18)&0x1ff;break;case 8:flags|=16;break;case 28:flags=(def>>18)&0x1ff;break;case 39:fg=(def>>9)&0x1ff;break;case 49:bg=def&0x1ff;break;case 100:fg=(def>>9)&0x1ff;bg=def&0x1ff;break;default:if(c===48&&+code[i+1]===5){i+=2;bg=+code[i];break;}else if(c===48&&+code[i+1]===2){i+=2;bg=colors.match(+code[i],+code[i+1],+code[i+2]);if(bg===-1)bg=def&0x1ff;i+=2;break;}else if(c===38&&+code[i+1]===5){i+=2;fg=+code[i];break;}else if(c===38&&+code[i+1]===2){i+=2;fg=colors.match(+code[i],+code[i+1],+code[i+2]);if(fg===-1)fg=(def>>9)&0x1ff;i+=2;break;}
if(c>=40&&c<=47){bg=c-40;}else if(c>=100&&c<=107){bg=c-100;bg+=8;}else if(c===49){bg=def&0x1ff;}else if(c>=30&&c<=37){fg=c-30;}else if(c>=90&&c<=97){fg=c-90;fg+=8;}else if(c===39){fg=(def>>9)&0x1ff;}else if(c===100){fg=(def>>9)&0x1ff;bg=def&0x1ff;}
break;}}
return(flags<<18)|(fg<<9)|bg;};Screen.prototype.codeAttr=function(code){var flags=(code>>18)&0x1ff,fg=(code>>9)&0x1ff,bg=code&0x1ff,out='';if(flags&1){out+='1;';}
if(flags&2){out+='4;';}
if(flags&4){out+='5;';}
if(flags&8){out+='7;';}
if(flags&16){out+='8;';}
if(bg!==0x1ff){bg=this._reduceColor(bg);if(bg<16){if(bg<8){bg+=40;}else if(bg<16){bg-=8;bg+=100;}
out+=bg+';';}else{out+='48;5;'+bg+';';}}
if(fg!==0x1ff){fg=this._reduceColor(fg);if(fg<16){if(fg<8){fg+=30;}else if(fg<16){fg-=8;fg+=90;}
out+=fg+';';}else{out+='38;5;'+fg+';';}}
if(out[out.length-1]===';')out=out.slice(0,-1);return'\x1b['+out+'m';};Screen.prototype.focusOffset=function(offset){var shown=this.keyable.filter(function(el){return!el.detached&&el.visible;}).length;if(!shown||!offset){return;}
var i=this.keyable.indexOf(this.focused);if(!~i)return;if(offset>0){while(offset--){if(++i>this.keyable.length-1)i=0;if(this.keyable[i].detached||!this.keyable[i].visible)offset++;}}else{offset=-offset;while(offset--){if(--i<0)i=this.keyable.length-1;if(this.keyable[i].detached||!this.keyable[i].visible)offset++;}}
return this.keyable[i].focus();};Screen.prototype.focusPrev=Screen.prototype.focusPrevious=function(){return this.focusOffset(-1);};Screen.prototype.focusNext=function(){return this.focusOffset(1);};Screen.prototype.focusPush=function(el){if(!el)return;var old=this.history[this.history.length-1];if(this.history.length===10){this.history.shift();}
this.history.push(el);this._focus(el,old);};Screen.prototype.focusPop=function(){var old=this.history.pop();if(this.history.length){this._focus(this.history[this.history.length-1],old);}
return old;};Screen.prototype.saveFocus=function(){return this._savedFocus=this.focused;};Screen.prototype.restoreFocus=function(){if(!this._savedFocus)return;this._savedFocus.focus();delete this._savedFocus;return this.focused;};Screen.prototype.rewindFocus=function(){var old=this.history.pop(),el;while(this.history.length){el=this.history.pop();if(!el.detached&&el.visible){this.history.push(el);this._focus(el,old);return el;}}
if(old){old.emit('blur');}};Screen.prototype._focus=function(self,old){var el=self;while(el=el.parent){if(el.scrollable)break;}
if(el&&!el.detached){var visible=self.screen.height-el.atop-el.itop-el.abottom-el.ibottom;if(self.rtop<el.childBase){el.scrollTo(self.rtop);self.screen.render();}else if(self.rtop+self.height-self.ibottom>el.childBase+visible){el.scrollTo(self.rtop-(el.height-self.height)+el.itop,true);self.screen.render();}}
if(old){old.emit('blur',self);}
self.emit('focus',old);};Object.defineProperty(Screen.prototype,'focused',{get:function(){return this.history[this.history.length-1];},set:function(el){return this.focusPush(el);}});Screen.prototype.clearRegion=function(xi,xl,yi,yl,override){return this.fillRegion(this.dattr,' ',xi,xl,yi,yl,override);};Screen.prototype.fillRegion=function(attr,ch,xi,xl,yi,yl,override){var lines=this.lines,cell,xx;if(xi<0)xi=0;if(yi<0)yi=0;for(;yi<yl;yi++){if(!lines[yi])break;for(xx=xi;xx<xl;xx++){cell=lines[yi][xx];if(!cell)break;if(override||attr!==cell[0]||ch!==cell[1]){lines[yi][xx][0]=attr;lines[yi][xx][1]=ch;lines[yi].dirty=true;}}}};Screen.prototype.key=function(){return this.program.key.apply(this,arguments);};Screen.prototype.onceKey=function(){return this.program.onceKey.apply(this,arguments);};Screen.prototype.unkey=Screen.prototype.removeKey=function(){return this.program.unkey.apply(this,arguments);};Screen.prototype.spawn=function(file,args,options){if(!Array.isArray(args)){options=args;args=[];}
var screen=this,program=screen.program,spawn=require('child_process').spawn,mouse=program.mouseEnabled,ps;options=options||{};options.stdio=options.stdio||'inherit';program.lsaveCursor('spawn');program.normalBuffer();program.showCursor();if(mouse)program.disableMouse();var write=program.output.write;program.output.write=function(){};program.input.pause();if(program.input.setRawMode){program.input.setRawMode(false);}
var resume=function(){if(resume.done)return;resume.done=true;if(program.input.setRawMode){program.input.setRawMode(true);}
program.input.resume();program.output.write=write;program.alternateBuffer();if(mouse){program.enableMouse();if(screen.options.sendFocus){screen.program.setMouse({sendFocus:true},true);}}
screen.alloc();screen.render();screen.program.lrestoreCursor('spawn',true);};ps=spawn(file,args,options);ps.on('error',resume);ps.on('exit',resume);return ps;};Screen.prototype.exec=function(file,args,options,callback){var ps=this.spawn(file,args,options);ps.on('error',function(err){if(!callback)return;return callback(err,false);});ps.on('exit',function(code){if(!callback)return;return callback(null,code===0);});return ps;};Screen.prototype.readEditor=function(options,callback){if(typeof options==='string'){options={editor:options};}
if(!callback){callback=options;options=null;}
if(!callback){callback=function(){};}
options=options||{};var self=this,editor=options.editor||process.env.EDITOR||'vi',name=options.name||process.title||'blessed',rnd=Math.random().toString(36).split('.').pop(),file='/tmp/'+name+'.'+rnd,args=[file],opt;opt={stdio:'inherit',env:process.env,cwd:process.env.HOME};function writeFile(callback){if(!options.value)return callback();return fs.writeFile(file,options.value,callback);}
return writeFile(function(err){if(err)return callback(err);return self.exec(editor,args,opt,function(err,success){if(err)return callback(err);return fs.readFile(file,'utf8',function(err,data){return fs.unlink(file,function(){if(!success)return callback(new Error('Unsuccessful.'));if(err)return callback(err);return callback(null,data);});});});});};Screen.prototype.displayImage=function(file,callback){if(!file){if(!callback)return;return callback(new Error('No image.'));}
file=path.resolve(process.cwd(),file);if(!~file.indexOf('://')){file='file://'+file;}
var args=['w3m','-T','text/html'];var input='<title>press q to exit</title>'
+'<img align="center" src="'+file+'">';var opt={stdio:['pipe',1,2],env:process.env,cwd:process.env.HOME};var ps=this.spawn(args[0],args.slice(1),opt);ps.on('error',function(err){if(!callback)return;return callback(err);});ps.on('exit',function(code){if(!callback)return;if(code!==0)return callback(new Error('Exit Code: '+code));return callback(null,code===0);});ps.stdin.write(input+'\n');ps.stdin.end();};Screen.prototype.setEffects=function(el,fel,over,out,effects,temp){if(!effects)return;var tmp={};if(temp)el[temp]=tmp;if(typeof el!=='function'){var _el=el;el=function(){return _el;};}
fel.on(over,function(){var element=el();Object.keys(effects).forEach(function(key){var val=effects[key];if(val!==null&&typeof val==='object'){tmp[key]=tmp[key]||{};Object.keys(val).forEach(function(k){var v=val[k];tmp[key][k]=element.style[key][k];element.style[key][k]=v;});return;}
tmp[key]=element.style[key];element.style[key]=val;});element.screen.render();});fel.on(out,function(){var element=el();Object.keys(effects).forEach(function(key){var val=effects[key];if(val!==null&&typeof val==='object'){tmp[key]=tmp[key]||{};Object.keys(val).forEach(function(k){if(tmp[key].hasOwnProperty(k)){element.style[key][k]=tmp[key][k];}});return;}
if(tmp.hasOwnProperty(key)){element.style[key]=tmp[key];}});element.screen.render();});};Screen.prototype.sigtstp=function(callback){var self=this;this.program.sigtstp(function(){self.alloc();self.render();self.program.lrestoreCursor('pause',true);if(callback)callback();});};Screen.prototype.copyToClipboard=function(text){return this.program.copyToClipboard(text);};Screen.prototype.cursorShape=function(shape,blink){var self=this;this.cursor.shape=shape||'block';this.cursor.blink=blink||false;this.cursor._set=true;if(this.cursor.artificial){if(!this.program.hideCursor_old){var hideCursor=this.program.hideCursor;this.program.hideCursor_old=this.program.hideCursor;this.program.hideCursor=function(){hideCursor.call(self.program);self.cursor._hidden=true;if(self.renders)self.render();};}
if(!this.program.showCursor_old){var showCursor=this.program.showCursor;this.program.showCursor_old=this.program.showCursor;this.program.showCursor=function(){self.cursor._hidden=false;if(self.program._exiting)showCursor.call(self.program);if(self.renders)self.render();};}
if(!this._cursorBlink){this._cursorBlink=setInterval(function(){if(!self.cursor.blink)return;self.cursor._state^=1;if(self.renders)self.render();},500);if(this._cursorBlink.unref){this._cursorBlink.unref();}}
return true;}
return this.program.cursorShape(this.cursor.shape,this.cursor.blink);};Screen.prototype.cursorColor=function(color){this.cursor.color=color!=null?colors.convert(color):null;this.cursor._set=true;if(this.cursor.artificial){return true;}
return this.program.cursorColor(colors.ncolors[this.cursor.color]);};Screen.prototype.cursorReset=Screen.prototype.resetCursor=function(){this.cursor.shape='block';this.cursor.blink=false;this.cursor.color=null;this.cursor._set=false;if(this.cursor.artificial){this.cursor.artificial=false;if(this.program.hideCursor_old){this.program.hideCursor=this.program.hideCursor_old;delete this.program.hideCursor_old;}
if(this.program.showCursor_old){this.program.showCursor=this.program.showCursor_old;delete this.program.showCursor_old;}
if(this._cursorBlink){clearInterval(this._cursorBlink);delete this._cursorBlink;}
return true;}
return this.program.cursorReset();};Screen.prototype._cursorAttr=function(cursor,dattr){var attr=dattr||this.dattr,cattr,ch;if(cursor.shape==='line'){attr&=~(0x1ff<<9);attr|=7<<9;ch='\u2502';}else if(cursor.shape==='underline'){attr&=~(0x1ff<<9);attr|=7<<9;attr|=2<<18;}else if(cursor.shape==='block'){attr&=~(0x1ff<<9);attr|=7<<9;attr|=8<<18;}else if(typeof cursor.shape==='object'&&cursor.shape){cattr=Element.prototype.sattr.call(cursor,cursor.shape);if(cursor.shape.bold||cursor.shape.underline||cursor.shape.blink||cursor.shape.inverse||cursor.shape.invisible){attr&=~(0x1ff<<18);attr|=((cattr>>18)&0x1ff)<<18;}
if(cursor.shape.fg){attr&=~(0x1ff<<9);attr|=((cattr>>9)&0x1ff)<<9;}
if(cursor.shape.bg){attr&=~(0x1ff<<0);attr|=cattr&0x1ff;}
if(cursor.shape.ch){ch=cursor.shape.ch;}}
if(cursor.color!=null){attr&=~(0x1ff<<9);attr|=cursor.color<<9;}
return{ch:ch,attr:attr};};Screen.prototype.screenshot=function(xi,xl,yi,yl,term){if(xi==null)xi=0;if(xl==null)xl=this.cols;if(yi==null)yi=0;if(yl==null)yl=this.rows;if(xi<0)xi=0;if(yi<0)yi=0;var x,y,line,out,ch,data,attr;var sdattr=this.dattr;if(term){this.dattr=term.defAttr;}
var main='';for(y=yi;y<yl;y++){line=term?term.lines[y]:this.lines[y];if(!line)break;out='';attr=this.dattr;for(x=xi;x<xl;x++){if(!line[x])break;data=line[x][0];ch=line[x][1];if(data!==attr){if(attr!==this.dattr){out+='\x1b[m';}
if(data!==this.dattr){var _data=data;if(term){if(((_data>>9)&0x1ff)===257)_data|=0x1ff<<9;if((_data&0x1ff)===256)_data|=0x1ff;}
out+=this.codeAttr(_data);}}
if(this.fullUnicode){if(unicode.charWidth(line[x][1])===2){if(x===xl-1){ch=' ';}else{x++;}}}
out+=ch;attr=data;}
if(attr!==this.dattr){out+='\x1b[m';}
if(out){main+=(y>0?'\n':'')+out;}}
main=main.replace(/(?:\s*\x1b\[40m\s*\x1b\[m\s*)*$/,'')+'\n';if(term){this.dattr=sdattr;}
return main;};Screen.prototype._getPos=function(){return this;};var angles={'\u2518':true,'\u2510':true,'\u250c':true,'\u2514':true,'\u253c':true,'\u251c':true,'\u2524':true,'\u2534':true,'\u252c':true,'\u2502':true,'\u2500':true};var langles={'\u250c':true,'\u2514':true,'\u253c':true,'\u251c':true,'\u2534':true,'\u252c':true,'\u2500':true};var uangles={'\u2510':true,'\u250c':true,'\u253c':true,'\u251c':true,'\u2524':true,'\u252c':true,'\u2502':true};var rangles={'\u2518':true,'\u2510':true,'\u253c':true,'\u2524':true,'\u2534':true,'\u252c':true,'\u2500':true};var dangles={'\u2518':true,'\u2514':true,'\u253c':true,'\u251c':true,'\u2524':true,'\u2534':true,'\u2502':true};var angleTable={'0000':'','0001':'\u2502','0010':'\u2500','0011':'\u250c','0100':'\u2502','0101':'\u2502','0110':'\u2514','0111':'\u251c','1000':'\u2500','1001':'\u2510','1010':'\u2500','1011':'\u252c','1100':'\u2518','1101':'\u2524','1110':'\u2534','1111':'\u253c'};Object.keys(angleTable).forEach(function(key){angleTable[parseInt(key,2)]=angleTable[key];delete angleTable[key];});module.exports=Screen;};BundleModuleCode['term/unicode']=function(module,exports){var stringFromCharCode=String.fromCharCode;var floor=Math.floor;exports.charWidth=function(str,i){var point=typeof str!=='number'?exports.codePointAt(str,i||0):str;if(point===0)return 0;if(point===0x09){if(!exports.blessed){}
return exports.blessed.screen.global?exports.blessed.screen.global.tabc.length:8;}
if(point<32||(point>=0x7f&&point<0xa0)){return 0;}
if(exports.combining[point]){return 0;}
if((0x3000===point)||(0xFF01<=point&&point<=0xFF60)||(0xFFE0<=point&&point<=0xFFE6)){return 2;}
if((0x1100<=point&&point<=0x115F)||(0x11A3<=point&&point<=0x11A7)||(0x11FA<=point&&point<=0x11FF)||(0x2329<=point&&point<=0x232A)||(0x2E80<=point&&point<=0x2E99)||(0x2E9B<=point&&point<=0x2EF3)||(0x2F00<=point&&point<=0x2FD5)||(0x2FF0<=point&&point<=0x2FFB)||(0x3001<=point&&point<=0x303E)||(0x3041<=point&&point<=0x3096)||(0x3099<=point&&point<=0x30FF)||(0x3105<=point&&point<=0x312D)||(0x3131<=point&&point<=0x318E)||(0x3190<=point&&point<=0x31BA)||(0x31C0<=point&&point<=0x31E3)||(0x31F0<=point&&point<=0x321E)||(0x3220<=point&&point<=0x3247)||(0x3250<=point&&point<=0x32FE)||(0x3300<=point&&point<=0x4DBF)||(0x4E00<=point&&point<=0xA48C)||(0xA490<=point&&point<=0xA4C6)||(0xA960<=point&&point<=0xA97C)||(0xAC00<=point&&point<=0xD7A3)||(0xD7B0<=point&&point<=0xD7C6)||(0xD7CB<=point&&point<=0xD7FB)||(0xF900<=point&&point<=0xFAFF)||(0xFE10<=point&&point<=0xFE19)||(0xFE30<=point&&point<=0xFE52)||(0xFE54<=point&&point<=0xFE66)||(0xFE68<=point&&point<=0xFE6B)||(0x1B000<=point&&point<=0x1B001)||(0x1F200<=point&&point<=0x1F202)||(0x1F210<=point&&point<=0x1F23A)||(0x1F240<=point&&point<=0x1F248)||(0x1F250<=point&&point<=0x1F251)||(0x20000<=point&&point<=0x2F73F)||(0x2B740<=point&&point<=0x2FFFD)||(0x30000<=point&&point<=0x3FFFD)){return 2;}
if(process.env.NCURSES_CJK_WIDTH){if((0x00A1===point)||(0x00A4===point)||(0x00A7<=point&&point<=0x00A8)||(0x00AA===point)||(0x00AD<=point&&point<=0x00AE)||(0x00B0<=point&&point<=0x00B4)||(0x00B6<=point&&point<=0x00BA)||(0x00BC<=point&&point<=0x00BF)||(0x00C6===point)||(0x00D0===point)||(0x00D7<=point&&point<=0x00D8)||(0x00DE<=point&&point<=0x00E1)||(0x00E6===point)||(0x00E8<=point&&point<=0x00EA)||(0x00EC<=point&&point<=0x00ED)||(0x00F0===point)||(0x00F2<=point&&point<=0x00F3)||(0x00F7<=point&&point<=0x00FA)||(0x00FC===point)||(0x00FE===point)||(0x0101===point)||(0x0111===point)||(0x0113===point)||(0x011B===point)||(0x0126<=point&&point<=0x0127)||(0x012B===point)||(0x0131<=point&&point<=0x0133)||(0x0138===point)||(0x013F<=point&&point<=0x0142)||(0x0144===point)||(0x0148<=point&&point<=0x014B)||(0x014D===point)||(0x0152<=point&&point<=0x0153)||(0x0166<=point&&point<=0x0167)||(0x016B===point)||(0x01CE===point)||(0x01D0===point)||(0x01D2===point)||(0x01D4===point)||(0x01D6===point)||(0x01D8===point)||(0x01DA===point)||(0x01DC===point)||(0x0251===point)||(0x0261===point)||(0x02C4===point)||(0x02C7===point)||(0x02C9<=point&&point<=0x02CB)||(0x02CD===point)||(0x02D0===point)||(0x02D8<=point&&point<=0x02DB)||(0x02DD===point)||(0x02DF===point)||(0x0300<=point&&point<=0x036F)||(0x0391<=point&&point<=0x03A1)||(0x03A3<=point&&point<=0x03A9)||(0x03B1<=point&&point<=0x03C1)||(0x03C3<=point&&point<=0x03C9)||(0x0401===point)||(0x0410<=point&&point<=0x044F)||(0x0451===point)||(0x2010===point)||(0x2013<=point&&point<=0x2016)||(0x2018<=point&&point<=0x2019)||(0x201C<=point&&point<=0x201D)||(0x2020<=point&&point<=0x2022)||(0x2024<=point&&point<=0x2027)||(0x2030===point)||(0x2032<=point&&point<=0x2033)||(0x2035===point)||(0x203B===point)||(0x203E===point)||(0x2074===point)||(0x207F===point)||(0x2081<=point&&point<=0x2084)||(0x20AC===point)||(0x2103===point)||(0x2105===point)||(0x2109===point)||(0x2113===point)||(0x2116===point)||(0x2121<=point&&point<=0x2122)||(0x2126===point)||(0x212B===point)||(0x2153<=point&&point<=0x2154)||(0x215B<=point&&point<=0x215E)||(0x2160<=point&&point<=0x216B)||(0x2170<=point&&point<=0x2179)||(0x2189===point)||(0x2190<=point&&point<=0x2199)||(0x21B8<=point&&point<=0x21B9)||(0x21D2===point)||(0x21D4===point)||(0x21E7===point)||(0x2200===point)||(0x2202<=point&&point<=0x2203)||(0x2207<=point&&point<=0x2208)||(0x220B===point)||(0x220F===point)||(0x2211===point)||(0x2215===point)||(0x221A===point)||(0x221D<=point&&point<=0x2220)||(0x2223===point)||(0x2225===point)||(0x2227<=point&&point<=0x222C)||(0x222E===point)||(0x2234<=point&&point<=0x2237)||(0x223C<=point&&point<=0x223D)||(0x2248===point)||(0x224C===point)||(0x2252===point)||(0x2260<=point&&point<=0x2261)||(0x2264<=point&&point<=0x2267)||(0x226A<=point&&point<=0x226B)||(0x226E<=point&&point<=0x226F)||(0x2282<=point&&point<=0x2283)||(0x2286<=point&&point<=0x2287)||(0x2295===point)||(0x2299===point)||(0x22A5===point)||(0x22BF===point)||(0x2312===point)||(0x2460<=point&&point<=0x24E9)||(0x24EB<=point&&point<=0x254B)||(0x2550<=point&&point<=0x2573)||(0x2580<=point&&point<=0x258F)||(0x2592<=point&&point<=0x2595)||(0x25A0<=point&&point<=0x25A1)||(0x25A3<=point&&point<=0x25A9)||(0x25B2<=point&&point<=0x25B3)||(0x25B6<=point&&point<=0x25B7)||(0x25BC<=point&&point<=0x25BD)||(0x25C0<=point&&point<=0x25C1)||(0x25C6<=point&&point<=0x25C8)||(0x25CB===point)||(0x25CE<=point&&point<=0x25D1)||(0x25E2<=point&&point<=0x25E5)||(0x25EF===point)||(0x2605<=point&&point<=0x2606)||(0x2609===point)||(0x260E<=point&&point<=0x260F)||(0x2614<=point&&point<=0x2615)||(0x261C===point)||(0x261E===point)||(0x2640===point)||(0x2642===point)||(0x2660<=point&&point<=0x2661)||(0x2663<=point&&point<=0x2665)||(0x2667<=point&&point<=0x266A)||(0x266C<=point&&point<=0x266D)||(0x266F===point)||(0x269E<=point&&point<=0x269F)||(0x26BE<=point&&point<=0x26BF)||(0x26C4<=point&&point<=0x26CD)||(0x26CF<=point&&point<=0x26E1)||(0x26E3===point)||(0x26E8<=point&&point<=0x26FF)||(0x273D===point)||(0x2757===point)||(0x2776<=point&&point<=0x277F)||(0x2B55<=point&&point<=0x2B59)||(0x3248<=point&&point<=0x324F)||(0xE000<=point&&point<=0xF8FF)||(0xFE00<=point&&point<=0xFE0F)||(0xFFFD===point)||(0x1F100<=point&&point<=0x1F10A)||(0x1F110<=point&&point<=0x1F12D)||(0x1F130<=point&&point<=0x1F169)||(0x1F170<=point&&point<=0x1F19A)||(0xE0100<=point&&point<=0xE01EF)||(0xF0000<=point&&point<=0xFFFFD)||(0x100000<=point&&point<=0x10FFFD)){return+process.env.NCURSES_CJK_WIDTH||1;}}
return 1;};exports.strWidth=function(str){var width=0;for(var i=0;i<str.length;i++){width+=exports.charWidth(str,i);if(exports.isSurrogate(str,i))i++;}
return width;};exports.isSurrogate=function(str,i){var point=typeof str!=='number'?exports.codePointAt(str,i||0):str;return point>0x00ffff;};exports.combiningTable=[[0x0300,0x036F],[0x0483,0x0486],[0x0488,0x0489],[0x0591,0x05BD],[0x05BF,0x05BF],[0x05C1,0x05C2],[0x05C4,0x05C5],[0x05C7,0x05C7],[0x0600,0x0603],[0x0610,0x0615],[0x064B,0x065E],[0x0670,0x0670],[0x06D6,0x06E4],[0x06E7,0x06E8],[0x06EA,0x06ED],[0x070F,0x070F],[0x0711,0x0711],[0x0730,0x074A],[0x07A6,0x07B0],[0x07EB,0x07F3],[0x0901,0x0902],[0x093C,0x093C],[0x0941,0x0948],[0x094D,0x094D],[0x0951,0x0954],[0x0962,0x0963],[0x0981,0x0981],[0x09BC,0x09BC],[0x09C1,0x09C4],[0x09CD,0x09CD],[0x09E2,0x09E3],[0x0A01,0x0A02],[0x0A3C,0x0A3C],[0x0A41,0x0A42],[0x0A47,0x0A48],[0x0A4B,0x0A4D],[0x0A70,0x0A71],[0x0A81,0x0A82],[0x0ABC,0x0ABC],[0x0AC1,0x0AC5],[0x0AC7,0x0AC8],[0x0ACD,0x0ACD],[0x0AE2,0x0AE3],[0x0B01,0x0B01],[0x0B3C,0x0B3C],[0x0B3F,0x0B3F],[0x0B41,0x0B43],[0x0B4D,0x0B4D],[0x0B56,0x0B56],[0x0B82,0x0B82],[0x0BC0,0x0BC0],[0x0BCD,0x0BCD],[0x0C3E,0x0C40],[0x0C46,0x0C48],[0x0C4A,0x0C4D],[0x0C55,0x0C56],[0x0CBC,0x0CBC],[0x0CBF,0x0CBF],[0x0CC6,0x0CC6],[0x0CCC,0x0CCD],[0x0CE2,0x0CE3],[0x0D41,0x0D43],[0x0D4D,0x0D4D],[0x0DCA,0x0DCA],[0x0DD2,0x0DD4],[0x0DD6,0x0DD6],[0x0E31,0x0E31],[0x0E34,0x0E3A],[0x0E47,0x0E4E],[0x0EB1,0x0EB1],[0x0EB4,0x0EB9],[0x0EBB,0x0EBC],[0x0EC8,0x0ECD],[0x0F18,0x0F19],[0x0F35,0x0F35],[0x0F37,0x0F37],[0x0F39,0x0F39],[0x0F71,0x0F7E],[0x0F80,0x0F84],[0x0F86,0x0F87],[0x0F90,0x0F97],[0x0F99,0x0FBC],[0x0FC6,0x0FC6],[0x102D,0x1030],[0x1032,0x1032],[0x1036,0x1037],[0x1039,0x1039],[0x1058,0x1059],[0x1160,0x11FF],[0x135F,0x135F],[0x1712,0x1714],[0x1732,0x1734],[0x1752,0x1753],[0x1772,0x1773],[0x17B4,0x17B5],[0x17B7,0x17BD],[0x17C6,0x17C6],[0x17C9,0x17D3],[0x17DD,0x17DD],[0x180B,0x180D],[0x18A9,0x18A9],[0x1920,0x1922],[0x1927,0x1928],[0x1932,0x1932],[0x1939,0x193B],[0x1A17,0x1A18],[0x1B00,0x1B03],[0x1B34,0x1B34],[0x1B36,0x1B3A],[0x1B3C,0x1B3C],[0x1B42,0x1B42],[0x1B6B,0x1B73],[0x1DC0,0x1DCA],[0x1DFE,0x1DFF],[0x200B,0x200F],[0x202A,0x202E],[0x2060,0x2063],[0x206A,0x206F],[0x20D0,0x20EF],[0x302A,0x302F],[0x3099,0x309A],[0xA806,0xA806],[0xA80B,0xA80B],[0xA825,0xA826],[0xFB1E,0xFB1E],[0xFE00,0xFE0F],[0xFE20,0xFE23],[0xFEFF,0xFEFF],[0xFFF9,0xFFFB],[0x10A01,0x10A03],[0x10A05,0x10A06],[0x10A0C,0x10A0F],[0x10A38,0x10A3A],[0x10A3F,0x10A3F],[0x1D167,0x1D169],[0x1D173,0x1D182],[0x1D185,0x1D18B],[0x1D1AA,0x1D1AD],[0x1D242,0x1D244],[0xE0001,0xE0001],[0xE0020,0xE007F],[0xE0100,0xE01EF]];exports.combining=exports.combiningTable.reduce(function(out,row){for(var i=row[0];i<=row[1];i++){out[i]=true;}
return out;},{});exports.isCombining=function(str,i){var point=typeof str!=='number'?exports.codePointAt(str,i||0):str;return exports.combining[point]===true;};exports.codePointAt=function(str,position){if(str==null){throw TypeError();}
var string=String(str);if(string.codePointAt){return string.codePointAt(position);}
var size=string.length;var index=position?Number(position):0;if(index!==index){index=0;}
if(index<0||index>=size){return undefined;}
var first=string.charCodeAt(index);var second;if(first>=0xD800&&first<=0xDBFF&&size>index+1){second=string.charCodeAt(index+1);if(second>=0xDC00&&second<=0xDFFF){return(first-0xD800)*0x400+second-0xDC00+0x10000;}}
return first;};exports.fromCodePoint=function(){if(String.fromCodePoint){return String.fromCodePoint.apply(String,arguments);}
var MAX_SIZE=0x4000;var codeUnits=[];var highSurrogate;var lowSurrogate;var index=-1;var length=arguments.length;if(!length){return'';}
var result='';while(++index<length){var codePoint=Number(arguments[index]);if(!isFinite(codePoint)||codePoint<0||codePoint>0x10FFFF||floor(codePoint)!==codePoint){throw RangeError('Invalid code point: '+codePoint);}
if(codePoint<=0xFFFF){codeUnits.push(codePoint);}else{codePoint-=0x10000;highSurrogate=(codePoint>>10)+0xD800;lowSurrogate=(codePoint%0x400)+0xDC00;codeUnits.push(highSurrogate,lowSurrogate);}
if(index+1===length||codeUnits.length>MAX_SIZE){result+=stringFromCharCode.apply(null,codeUnits);codeUnits.length=0;}}
return result;};exports.chars={};exports.chars.wide=new RegExp('(['
+'\\u1100-\\u115f'
+'\\u2329\\u232a'
+'\\u2e80-\\u303e\\u3040-\\ua4cf'
+'\\uac00-\\ud7a3'
+'\\uf900-\\ufaff'
+'\\ufe10-\\ufe19'
+'\\ufe30-\\ufe6f'
+'\\uff00-\\uff60'
+'\\uffe0-\\uffe6'
+'])','g');exports.chars.swide=new RegExp('('
+'[\\ud840-\\ud87f][\\udc00-\\udffd]'
+'|'
+'[\\ud880-\\ud8bf][\\udc00-\\udffd]'
+')','g');exports.chars.all=new RegExp('('
+exports.chars.swide.source.slice(1,-1)
+'|'
+exports.chars.wide.source.slice(1,-1)
+')','g');exports.chars.surrogate=/[\ud800-\udbff][\udc00-\udfff]/g;exports.chars.combining=exports.combiningTable.reduce(function(out,row){var low,high,range;if(row[0]>0x00ffff){low=exports.fromCodePoint(row[0]);low=[hexify(low.charCodeAt(0)),hexify(low.charCodeAt(1))];high=exports.fromCodePoint(row[1]);high=[hexify(high.charCodeAt(0)),hexify(high.charCodeAt(1))];range='[\\u'+low[0]+'-'+'\\u'+high[0]+']'
+'[\\u'+low[1]+'-'+'\\u'+high[1]+']';if(!~out.indexOf('|'))out+=']';out+='|'+range;}else{low=hexify(row[0]);high=hexify(row[1]);low='\\u'+low;high='\\u'+high;out+=low+'-'+high;}
return out;},'[');exports.chars.combining=new RegExp(exports.chars.combining,'g');function hexify(n){n=n.toString(16);while(n.length<4)n='0'+n;return n;}};BundleModuleCode['term/helpers']=function(module,exports){var fs=Require('fs');var Comp=Require('com/compat');var unicode=Require('term/unicode');var helpers=exports;helpers.asort=function(obj){return obj.sort(function(a,b){a=a.name.toLowerCase();b=b.name.toLowerCase();if(a[0]==='.'&&b[0]==='.'){a=a[1];b=b[1];}else{a=a[0];b=b[0];}
return a>b?1:(a<b?-1:0);});};helpers.attrToBinary=function(style,element){return helpers.Element.prototype.sattr.call(element||{},style);};helpers.bbox=function(parent,options){function eval(a,b){if(a.indexOf('%'))return int(Number(a.substring(0,a.length-1))*b/100);}
var bbox={width:options.width,height:options.height,top:options.top,left:options.left,right:options.right};if(bbox.width=='half')bbox.width=int(parent.width/2);if(typeof bbox.width=='string'&&bbox.width.indexOf('%')!=-1)bbox.width=eval(bbox.width,parent.width);if(bbox.height=='half')bbox.height=int(parent.height/2);if(typeof bbox.height=='string'&&bbox.height.indexOf('%')!=-1)bbox.height=eval(bbox.height,parent.height);if(bbox.left=='center')bbox.left=int((parent.width/2)-(bbox.width/2));if(bbox.top=='center')bbox.top=int((parent.height/2)-(bbox.height/2));return bbox;}
helpers.cleanTags=function(text){return helpers.stripTags(text).trim();};helpers.dropUnicode=function(text){if(!text)return'';return text.replace(unicode.chars.all,'??').replace(unicode.chars.combining,'').replace(unicode.chars.surrogate,'?');};helpers.findFile=function(start,target){return(function read(dir){var files,file,stat,out;if(dir==='/dev'||dir==='/sys'||dir==='/proc'||dir==='/net'){return null;}
try{files=fs.readdirSync(dir);}catch(e){files=[];}
for(var i=0;i<files.length;i++){file=files[i];if(file===target){return(dir==='/'?'':dir)+'/'+file;}
try{stat=fs.lstatSync((dir==='/'?'':dir)+'/'+file);}catch(e){stat=null;}
if(stat&&stat.isDirectory()&&!stat.isSymbolicLink()){out=read((dir==='/'?'':dir)+'/'+file);if(out)return out;}}
return null;})(start);};helpers.escape=function(text){return text.replace(/[{}]/g,function(ch){return ch==='{'?'{open}':'{close}';});};helpers.generateTags=function(style,text){var open='',close='';Object.keys(style||{}).forEach(function(key){var val=style[key];if(typeof val==='string'){val=val.replace(/^light(?!-)/,'light-');val=val.replace(/^bright(?!-)/,'bright-');open='{'+val+'-'+key+'}'+open;close+='{/'+val+'-'+key+'}';}else{if(val===true){open='{'+key+'}'+open;close+='{/'+key+'}';}}});if(text!=null){return open+text+close;}
return{open:open,close:close};};helpers.hsort=function(obj){return obj.sort(function(a,b){return b.index-a.index;});};helpers.merge=function(a,b){Object.keys(b).forEach(function(key){a[key]=b[key];});return a;};helpers.parseTags=function(text,screen){return helpers.Element.prototype._parseTags.call({parseTags:true,screen:screen||helpers.Screen.global},text);};helpers.stripTags=function(text){if(!text)return'';return text.replace(/\{(\/?)([\w\-,;!#]*)\}/g,'').replace(/\x1b\[[\d;]*m/g,'');};Object.defineProperty(helpers,'Screen',{get:function(){if(!helpers._screen){helpers._screen=Require('term/widgets/screen');}
return helpers._screen;}});Object.defineProperty(helpers,'Element',{get:function(){if(!helpers._element){helpers._element=Require('term/widgets/element');}
return helpers._element;}});};BundleModuleCode['term/widgets/log']=function(module,exports){var options={version:'1.3.2'}
var Comp=Require('com/compat');var util=require('util');var Helpers=Require('term/helpers');var Button=Require('term/widgets/button');var Arrows=Require('term/widgets/arrows');var nextTick=global.setImmediate||process.nextTick.bind(process);var Node=Require('term/widgets/node');var ScrollableText=Require('term/widgets/scrollabletext');function Log(options){var self=this,bbox;if(!instanceOf(this,Node)){return new Log(options);}
options=options||{};ScrollableText.call(this,options);this.scrollback=options.scrollback!=null?options.scrollback:Infinity;this.scrollOnInput=options.scrollOnInput;this._updating=false;if(options.arrows)
Arrows(self,options,function(){self.scroll(-2)},function(){self.scroll(2)});this.on('set content',function(){if(!self._updating&&!self._userScrolled&&self.scrollOnInput){self._updating=true;setTimeout(function(){self.setScrollPerc(100);self._userScrolled=false;self._updating=false;self.screen.render();},20);}});}
inheritPrototype(Log,ScrollableText);Log.prototype.type='log';Log.prototype.log=Log.prototype.add=function(){var args=Array.prototype.slice.call(arguments);if(typeof args[0]==='object'){args[0]=util.inspect(args[0],true,20,true);}
var text=util.format.apply(util,args);this.emit('log',text);var ret=this.pushLine(text);return ret;};Log.prototype.clear=function(){if(this._userScrolled)this.setScrollPerc(100);this.setContent('');this.resetScroll();}
Log.prototype._scroll=Log.prototype.scroll;Log.prototype.scroll=function(offset,always){if(offset>this.getScrollHeight()||(this.getScrollHeight()+offset)<0)return;if(offset===0)return this._scroll(offset,always);this._userScrolled=true;var ret=this._scroll(offset,always);if(this.getScrollPerc()===100){this._userScrolled=false;}
return ret;};module.exports=Log;Log.prototype.logold=function(str){var i;this.logLines.push(str)
if(this.logLines.length==1){this.setContent(str);}
else if(this.logLines.length>this.options.bufferLength){this.logLines.shift();this.setContent(this.logLines[0]);for(i=1;i<this.logLines.length;i++){this.insertLine(i,this.logLines[i]);}
this.scrollBottom();}else{this.scrollBottom();this.insertBottom(str);this.scrollBottom();}}};BundleModuleCode['term/widgets/button']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Input=Require('term/widgets/input');function Button(options){var self=this;if(!instanceOf(this,Node)){return new Button(options);}
options=options||{};if(options.autoFocus==null){options.autoFocus=false;}
if(!options.style)options.style={fg:'white',bg:'blue',bold:true,border:{fg:'black'},hover:{border:{fg:'red'}},focus:{border:{fg:'red'}}}
if(options.object)this.object=options.object;Input.call(this,options);this.on('keypress',function(ch,key){if(key.name=='enter'||key.name=='return'){return self.press();}});if(this.options.mouse){this.on('click',function(){return self.press();});}}
inheritPrototype(Button,Input);Button.prototype.type='button';Button.prototype.press=function(){this.focus();this.value=true;var result=this.emit('press');delete this.value;return result;};module.exports=Button;};BundleModuleCode['term/widgets/input']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function Input(options){if(!instanceOf(this,Node)){return new Input(options);}
options=options||{};Box.call(this,options);}
inheritPrototype(Input,Box);Input.prototype.type='input';Input.prototype.focus=function(){this.screen.rewindFocus();return this.screen.focused=this;}
module.exports=Input;};BundleModuleCode['term/widgets/box']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Element=Require('term/widgets/element');function Box(options){if(!instanceOf(this,Node)){return new Box(options);}
options=options||{};Element.call(this,options);}
inheritPrototype(Box,Element);Box.prototype.type='box';module.exports=Box;};BundleModuleCode['term/widgets/element']=function(module,exports){var Comp=Require('com/compat');var assert=Require('assert');var colors=Require('term/colors'),unicode=Require('term/unicode');var nextTick=global.setImmediate||process.nextTick.bind(process);var helpers=Require('term/helpers');var Node=Require('term/widgets/node');function Element(options){var self=this;if(!instanceOf(this,Node)){return new Element(options);}
options=options||{};if(options.scrollable&&!this._ignore&&this.type!=='scrollable-box'){var ScrollableBox=Require('term/widgets/scrollablebox');Object.getOwnPropertyNames(ScrollableBox.prototype).forEach(function(key){if(key==='type')return;Object.defineProperty(this,key,Object.getOwnPropertyDescriptor(ScrollableBox.prototype,key));},this);this._ignore=true;ScrollableBox.call(this,options);delete this._ignore;if(options.mouse){this.onScreenEvent('mouse',function(data){var x=data.x-self.aleft;var y=data.y-self.atop;if(!self.hidden&&data.action=='mousedown'&&x===self.width-self.iright-1){self.focus();var perc=(y-self.itop)/(self.height-self.iheight);self.setScrollPerc(perc*100|0);self.screen.render();}});}
return this;}
Node.call(this,options);this.name=options.name;options.position=options.position||{left:options.left,right:options.right,top:options.top,bottom:options.bottom,width:options.width,height:options.height};if(options.position.width==='shrink'||options.position.height==='shrink'){if(options.position.width==='shrink'){delete options.position.width;}
if(options.position.height==='shrink'){delete options.position.height;}
options.shrink=true;}
this.position=options.position;this.noOverflow=options.noOverflow;this.dockBorders=options.dockBorders;this.shadow=options.shadow;this.style=options.style;if(!this.style){this.style={};this.style.fg=options.fg;this.style.bg=options.bg;this.style.bold=options.bold;this.style.underline=options.underline;this.style.blink=options.blink;this.style.inverse=options.inverse;this.style.invisible=options.invisible;this.style.transparent=options.transparent;}
this.hidden=options.hidden||false;this.fixed=options.fixed||false;this.align=options.align||'left';this.valign=options.valign||'top';this.wrap=options.wrap!==false;this.shrink=options.shrink;this.ch=options.ch||' ';if(typeof options.padding==='number'||!options.padding){options.padding={left:options.padding,top:options.padding,right:options.padding,bottom:options.padding};}
this.padding={left:options.padding.left||0,top:options.padding.top||0,right:options.padding.right||0,bottom:options.padding.bottom||0};this.border=options.border;if(this.border){if(typeof this.border==='string'){this.border={type:this.border};}
this.border.type=this.border.type||'bg';if(this.border.type==='ascii')this.border.type='line';this.border.ch=this.border.ch||' ';this.style.border=this.style.border||this.border.style;if(!this.style.border){this.style.border={};this.style.border.fg=this.border.fg;this.style.border.bg=this.border.bg;}
if(this.border.left==null)this.border.left=true;if(this.border.top==null)this.border.top=true;if(this.border.right==null)this.border.right=true;if(this.border.bottom==null)this.border.bottom=true;}
if(options.clickable){this.screen._listenMouse(this);}
if(options.input||options.keyable){this.screen._listenKeys(this);}
this.parseTags=options.parseTags||options.tags;this.setContent(options.content||'',true);if(options.label){this.setLabel(options.label);}
if(options.hoverText){this.setHover(options.hoverText);}
this.on('newListener',function fn(type){if(type==='mouse'||type==='click'||type==='mouseover'||type==='mouseout'||type==='mousedown'||type==='mouseup'||type==='mousewheel'||type==='wheeldown'||type==='wheelup'||type==='mousemove'){self.screen._listenMouse(self);}else if(type==='keypress'||type.indexOf('key ')===0){self.screen._listenKeys(self);}});this.on('resize',function(){self.parseContent();});this.on('attach',function(){self.parseContent();});this.on('detach',function(){delete self.lpos;});if(options.hoverBg!=null){options.hoverEffects=options.hoverEffects||{};options.hoverEffects.bg=options.hoverBg;}
if(this.style.hover){options.hoverEffects=this.style.hover;}
if(this.style.focus){options.focusEffects=this.style.focus;}
if(options.effects){if(options.effects.hover)options.hoverEffects=options.effects.hover;if(options.effects.focus)options.focusEffects=options.effects.focus;}
[['hoverEffects','mouseover','mouseout','_htemp'],['focusEffects','focus','blur','_ftemp']].forEach(function(props){var pname=props[0],over=props[1],out=props[2],temp=props[3];self.screen.setEffects(self,self,over,out,self.options[pname],temp);});if(this.options.draggable){this.draggable=true;}
if(options.focused){this.focus();}}
inheritPrototype(Element,Node);Element.prototype.type='element';Object.defineProperty(Element.prototype,'focused',{get:function(){return this.screen.focused===this;}});Element.prototype.sattr=function(style,fg,bg){var bold=style.bold,underline=style.underline,blink=style.blink,inverse=style.inverse,invisible=style.invisible;if(fg==null&&bg==null){fg=style.fg;bg=style.bg;}
if(typeof bold==='function')bold=bold(this);if(typeof underline==='function')underline=underline(this);if(typeof blink==='function')blink=blink(this);if(typeof inverse==='function')inverse=inverse(this);if(typeof invisible==='function')invisible=invisible(this);if(typeof fg==='function')fg=fg(this);if(typeof bg==='function')bg=bg(this);return((invisible?16:0)<<18)|((inverse?8:0)<<18)|((blink?4:0)<<18)|((underline?2:0)<<18)|((bold?1:0)<<18)|(colors.convert(fg)<<9)|colors.convert(bg);};Element.prototype.onScreenEvent=function(type,handler){var listeners=this._slisteners=this._slisteners||[];listeners.push({type:type,handler:handler});this.screen.on(type,handler);};Element.prototype.onceScreenEvent=function(type,handler){var listeners=this._slisteners=this._slisteners||[];var entry={type:type,handler:handler};listeners.push(entry);this.screen.once(type,function(){var i=listeners.indexOf(entry);if(~i)listeners.splice(i,1);return handler.apply(this,arguments);});};Element.prototype.removeScreenEvent=function(type,handler){var listeners=this._slisteners=this._slisteners||[];for(var i=0;i<listeners.length;i++){var listener=listeners[i];if(listener.type===type&&listener.handler===handler){listeners.splice(i,1);if(this._slisteners.length===0){delete this._slisteners;}
break;}}
this.screen.removeListener(type,handler);};Element.prototype.free=function(){var listeners=this._slisteners=this._slisteners||[];for(var i=0;i<listeners.length;i++){var listener=listeners[i];this.screen.removeListener(listener.type,listener.handler);}
delete this._slisteners;};Element.prototype.hide=function(){if(this.hidden)return;this.clearPos();this.hidden=true;this.emit('hide');if(this.screen.focused===this){this.screen.rewindFocus();}};Element.prototype.show=function(){if(!this.hidden)return;this.hidden=false;this.emit('show');};Element.prototype.toggle=function(){return this.hidden?this.show():this.hide();};Element.prototype.focus=function(){return this.screen.focused=this;};Element.prototype.isfocus=function(){return this.screen.focused==this;};Element.prototype.setStyle=function(styles){for(var p in styles){if(this.style[p]!=undefined)this.style[p]=styles[p];}};Element.prototype.setContent=function(content,noClear,noTags){var changed=this.content!=content;if(!noClear)this.clearPos();this.content=content||'';this.parseContent(noTags);this.emit('set content');if(changed)this.emit('change',content);};Element.prototype.getContent=function(){if(!this._clines)return'';return this._clines.fake.join('\n');};Element.prototype.setText=function(content,noClear){content=content||'';content=content.replace(/\x1b\[[\d;]*m/g,'');return this.setContent(content,noClear,true);};Element.prototype.getText=function(){return this.getContent().replace(/\x1b\[[\d;]*m/g,'');};Element.prototype.parseContent=function(noTags){var self=this;if(this.detached)return false;var width=this.width-this.iwidth;if(this._clines==null||this._clines.width!==width||this._clines.content!==this.content){var content=this.content;content=content.replace(/[\x00-\x08\x0b-\x0c\x0e-\x1a\x1c-\x1f\x7f]/g,'').replace(/\x1b(?!\[[\d;]*m)/g,'').replace(/\r\n|\r/g,'\n').replace(/\t/g,this.screen.tabc);if(this.screen.fullUnicode){content=content.replace(unicode.chars.all,'$1\x03');if(this.screen.program.isiTerm2){content=content.replace(unicode.chars.combining,'');}}else{content=content.replace(unicode.chars.all,'??');content=content.replace(unicode.chars.combining,'');content=content.replace(unicode.chars.surrogate,'?');}
if(!noTags){content=this._parseTags(content);}
this._clines=this._wrapContent(content,width);this._clines.width=width;this._clines.content=this.content;this._clines.attr=this._parseAttr(this._clines);this._clines.ci=[];this._clines.reduce(function(total,line){self._clines.ci.push(total);return total+line.length+1;},0);this._pcontent=this._clines.join('\n');this.emit('parsed content');return true;}
this._clines.attr=this._parseAttr(this._clines)||this._clines.attr;return false;};Element.prototype._parseTags=function(text){if(!this.parseTags)return text;if(!/\{\/?[\w\-,;!#]*\}/.test(text))return text;var program=this.screen.program,out='',state,bg=[],fg=[],flag=[],cap,slash,param,attr,esc;for(;;){if(!esc&&(cap=/^\{escape\}/.exec(text))){text=text.substring(cap[0].length);esc=true;continue;}
if(esc&&(cap=/^([\s\S]+?)\{\/escape\}/.exec(text))){text=text.substring(cap[0].length);out+=cap[1];esc=false;continue;}
if(esc){out+=text;break;}
if(cap=/^\{(\/?)([\w\-,;!#]*)\}/.exec(text)){text=text.substring(cap[0].length);slash=cap[1]==='/';param=cap[2].replace(/-/g,' ');if(param==='open'){out+='{';continue;}else if(param==='close'){out+='}';continue;}
if(param.slice(-3)===' bg')state=bg;else if(param.slice(-3)===' fg')state=fg;else state=flag;if(slash){if(!param){out+=program._attr('normal');bg.length=0;fg.length=0;flag.length=0;}else{attr=program._attr(param,false);if(attr==null){out+=cap[0];}else{state.pop();if(state.length){out+=program._attr(state[state.length-1]);}else{out+=attr;}}}}else{if(!param){out+=cap[0];}else{attr=program._attr(param);if(attr==null){out+=cap[0];}else{state.push(param);out+=attr;}}}
continue;}
if(cap=/^[\s\S]+?(?=\{\/?[\w\-,;!#]*\})/.exec(text)){text=text.substring(cap[0].length);out+=cap[0];continue;}
out+=text;break;}
return out;};Element.prototype._parseAttr=function(lines){var dattr=this.sattr(this.style),attr=dattr,attrs=[],line,i,j,c;if(lines[0].attr===attr){return;}
for(j=0;j<lines.length;j++){line=lines[j];attrs[j]=attr;for(i=0;i<line.length;i++){if(line[i]==='\x1b'){if(c=/^\x1b\[[\d;]*m/.exec(line.substring(i))){attr=this.screen.attrCode(c[0],attr,dattr);i+=c[0].length-1;}}}}
return attrs;};Element.prototype._align=function(line,width,align){if(!align)return line;var cline=line.replace(/\x1b\[[\d;]*m/g,''),len=cline.length,s=width-len;if(this.shrink){s=0;}
if(len===0)return line;if(s<0)return line;if(align==='center'){s=Array(((s/2)|0)+1).join(' ');return s+line+s;}else if(align==='right'){s=Array(s+1).join(' ');return s+line;}else if(this.parseTags&&~line.indexOf('{|}')){var parts=line.split('{|}');var cparts=cline.split('{|}');s=Math.max(width-cparts[0].length-cparts[1].length,0);s=Array(s+1).join(' ');return parts[0]+s+parts[1];}
return line;};Element.prototype._wrapContent=function(content,width){var tags=this.parseTags,state=this.align,wrap=this.wrap,margin=0,rtof=[],ftor=[],out=[],no=0,line,align,cap,total,i,part,j,lines,rest;lines=content.split('\n');if(!content){out.push(content);out.rtof=[0];out.ftor=[[0]];out.fake=lines;out.real=out;out.mwidth=0;return out;}
if(this.scrollbar)margin++;if(this.type==='textarea')margin++;if(width>margin)width-=margin;main:for(;no<lines.length;no++){line=lines[no];align=state;ftor.push([]);if(tags){if(cap=/^\{(left|center|right)\}/.exec(line)){line=line.substring(cap[0].length);align=state=cap[1]!=='left'?cap[1]:null;}
if(cap=/\{\/(left|center|right)\}$/.exec(line)){line=line.slice(0,-cap[0].length);state=this.align;}}
while(line.length>width){if(this.break=='all')
i=width;else for(i=0,total=0;i<line.length;i++){while(line[i]==='\x1b'){while(line[i]&&line[i++]!=='m');}
if(!line[i])break;if(++total===width){i++;if(!wrap){rest=line.substring(i).match(/\x1b\[[^m]*m/g);rest=rest?rest.join(''):'';out.push(this._align(line.substring(0,i)+rest,width,align));ftor[no].push(out.length-1);rtof.push(no);continue main;}
if(!this.screen.fullUnicode){if(i!==line.length){j=i;while(j>i-10&&j>0&&line[--j]!==' ');if(line[j]===' ')i=j+1;}}else{if(i!==line.length){if(unicode.isSurrogate(line,i))i--;for(var s=0,n=0;n<i;n++){if(unicode.isSurrogate(line,n))s++,n++;}
i+=s;j=i;while(j>i-10&&j>0){j--;if(line[j]===' '||line[j]==='\x03'||(unicode.isSurrogate(line,j-1)&&line[j+1]!=='\x03')||unicode.isCombining(line,j)){break;}}
if(line[j]===' '||line[j]==='\x03'||(unicode.isSurrogate(line,j-1)&&line[j+1]!=='\x03')||unicode.isCombining(line,j)){i=j+1;}}}
break;}}
part=line.substring(0,i);line=line.substring(i);out.push(this._align(part,width,align));ftor[no].push(out.length-1);rtof.push(no);if(line==='')continue main;if(/^(?:\x1b[\[\d;]*m)+$/.test(line)){out[out.length-1]+=line;continue main;}}
out.push(this._align(line,width,align));ftor[no].push(out.length-1);rtof.push(no);}
out.rtof=rtof;out.ftor=ftor;out.fake=lines;out.real=out;out.mwidth=out.reduce(function(current,line){line=line.replace(/\x1b\[[\d;]*m/g,'');return line.length>current?line.length:current;},0);return out;};Object.defineProperty(Element.prototype,'visible',{get:function(){var el=this;do{if(el.detached)return false;if(el.hidden)return false;}while(el=el.parent);return true;}});Object.defineProperty(Element.prototype,'_detached',{get:function(){var el=this;do{if(el.type==='screen')return false;if(!el.parent)return true;}while(el=el.parent);return false;}});Element.prototype.enableMouse=function(){this.screen._listenMouse(this);};Element.prototype.enableKeys=function(){this.screen._listenKeys(this);};Element.prototype.enableInput=function(){this.screen._listenMouse(this);this.screen._listenKeys(this);};Object.defineProperty(Element.prototype,'draggable',{get:function(){return this._draggable===true;},set:function(draggable){return draggable?this.enableDrag(draggable):this.disableDrag();}});Element.prototype.enableDrag=function(verify){var self=this;if(this._draggable)return true;if(typeof verify!=='function'){verify=function(){return true;};}
this.enableMouse();this.on('mousedown',this._dragMD=function(data){if(self.screen._dragging)return;if(!verify(data))return;self.screen._dragging=self;self._drag={x:data.x-self.aleft,y:data.y-self.atop};self.setFront();});this.onScreenEvent('mouse',this._dragM=function(data){if(self.screen._dragging!==self)return;if(data.action!=='mousedown'&&data.action!=='mousemove'){delete self.screen._dragging;delete self._drag;return;}
if(!self.parent)return;var ox=self._drag.x,oy=self._drag.y,px=self.parent.aleft,py=self.parent.atop,x=data.x-px-ox,y=data.y-py-oy;if(self.position.right!=null){if(self.position.left!=null){self.width='100%-'+(self.parent.width-self.width);}
self.position.right=null;}
if(self.position.bottom!=null){if(self.position.top!=null){self.height='100%-'+(self.parent.height-self.height);}
self.position.bottom=null;}
self.rleft=x;self.rtop=y;self.screen.render();});return this._draggable=true;};Element.prototype.disableDrag=function(){if(!this._draggable)return false;delete this.screen._dragging;delete this._drag;this.removeListener('mousedown',this._dragMD);this.removeScreenEvent('mouse',this._dragM);return this._draggable=false;};Element.prototype.key=function(){return this.screen.program.key.apply(this,arguments);};Element.prototype.onceKey=function(){return this.screen.program.onceKey.apply(this,arguments);};Element.prototype.unkey=Element.prototype.removeKey=function(){return this.screen.program.unkey.apply(this,arguments);};Element.prototype.setIndex=function(index){if(!this.parent)return;if(index<0){index=this.parent.children.length+index;}
index=Math.max(index,0);index=Math.min(index,this.parent.children.length-1);var i=this.parent.children.indexOf(this);if(!~i)return;var item=this.parent.children.splice(i,1)[0];this.parent.children.splice(index,0,item);};Element.prototype.setFront=function(){return this.setIndex(-1);};Element.prototype.setBack=function(){return this.setIndex(0);};Element.prototype.clearPos=function(get,override){if(this.detached)return;var lpos=this._getCoords(get);if(!lpos)return;this.screen.clearRegion(lpos.xi,lpos.xl,lpos.yi,lpos.yl,override);};Element.prototype.getLabel=function(){if(this._label)return this._label.getContent();}
Element.prototype.setLabel=function(options){var self=this;var Box=Require('term/widgets/box');if(typeof options==='string'){options={text:options};}
if(this._label){this._label.setContent(options.text);if(options.side!=='right'){this._label.rleft=2+(this.border?-1:0);this._label.position.right=undefined;if(!this.screen.autoPadding){this._label.rleft=2;}}else{this._label.rright=2+(this.border?-1:0);this._label.position.left=undefined;if(!this.screen.autoPadding){this._label.rright=2;}}
return;}
this._label=new Box({screen:this.screen,parent:this,content:options.text,top:-this.itop,tags:this.parseTags,shrink:true,style:this.style.label});if(options.side!=='right'){this._label.rleft=2-this.ileft;}else{this._label.rright=2-this.iright;}
if(this.border&&this.border.type=='none')this._label.rleft=0;this._label._isLabel=true;if(!this.screen.autoPadding){if(options.side!=='right'){this._label.rleft=2;}else{this._label.rright=2;}
this._label.rtop=0;}
var reposition=function(){self._label.rtop=(self.childBase||0)-self.itop;if(!self.screen.autoPadding){self._label.rtop=(self.childBase||0);}
self.screen.render();};this.on('scroll',this._labelScroll=function(){reposition();});this.on('resize',this._labelResize=function(){nextTick(function(){reposition();});});};Element.prototype.removeLabel=function(){if(!this._label)return;this.removeListener('scroll',this._labelScroll);this.removeListener('resize',this._labelResize);this._label.detach();delete this._labelScroll;delete this._labelResize;delete this._label;};Element.prototype.setHover=function(options){if(typeof options==='string'){options={text:options};}
this._hoverOptions=options;this.enableMouse();this.screen._initHover();};Element.prototype.removeHover=function(){delete this._hoverOptions;if(!this.screen._hoverText||this.screen._hoverText.detached)return;this.screen._hoverText.detach();this.screen.render();};Element.prototype._getPos=function(){var pos=this.lpos;assert.ok(pos);if(pos.aleft!=null)return pos;pos.aleft=pos.xi;pos.atop=pos.yi;pos.aright=this.screen.cols-pos.xl;pos.abottom=this.screen.rows-pos.yl;pos.width=pos.xl-pos.xi;pos.height=pos.yl-pos.yi;return pos;};Element.prototype._getWidth=function(get){var parent=get?this.parent._getPos():this.parent,width=this.position.width,left,expr;if(typeof width==='string'){if(width==='half')width='50%';expr=width.split(/(?=\+|-)/);width=expr[0];width=+width.slice(0,-1)/100;width=parent.width*width|0;width+=+(expr[1]||0);return width;}
if(width==null){left=this.position.left||0;if(typeof left==='string'){if(left==='center')left='50%';expr=left.split(/(?=\+|-)/);left=expr[0];left=+left.slice(0,-1)/100;left=parent.width*left|0;left+=+(expr[1]||0);}
width=parent.width-(this.position.right||0)-left;if(this.screen.autoPadding){if((this.position.left!=null||this.position.right==null)&&this.position.left!=='center'){width-=this.parent.ileft;}
width-=this.parent.iright;}}
return width;};Object.defineProperty(Element.prototype,'width',{get:function(){return this._getWidth(false);},set:function(val){if(this.position.width===val)return;if(/^\d+$/.test(val))val=+val;this.emit('resize');this.clearPos();return this.position.width=val;}});Element.prototype._getHeight=function(get){var parent=get?this.parent._getPos():this.parent,height=this.position.height,top,expr;if(typeof height==='string'){if(height==='half')height='50%';expr=height.split(/(?=\+|-)/);height=expr[0];height=+height.slice(0,-1)/100;height=parent.height*height|0;height+=+(expr[1]||0);return height;}
if(height==null){top=this.position.top||0;if(typeof top==='string'){if(top==='center')top='50%';expr=top.split(/(?=\+|-)/);top=expr[0];top=+top.slice(0,-1)/100;top=parent.height*top|0;top+=+(expr[1]||0);}
height=parent.height-(this.position.bottom||0)-top;if(this.screen.autoPadding){if((this.position.top!=null||this.position.bottom==null)&&this.position.top!=='center'){height-=this.parent.itop;}
height-=this.parent.ibottom;}}
return height;};Object.defineProperty(Element.prototype,'height',{get:function(){return this._getHeight(false);},set:function(val){if(this.position.height===val)return;if(/^\d+$/.test(val))val=+val;this.emit('resize');this.clearPos();return this.position.height=val;}});Element.prototype._getLeft=function(get){var parent=get?this.parent._getPos():this.parent,left=this.position.left||0,expr;if(typeof left==='string'){if(left==='center')left='50%';expr=left.split(/(?=\+|-)/);left=expr[0];left=+left.slice(0,-1)/100;left=parent.width*left|0;left+=+(expr[1]||0);if(this.position.left==='center'){left-=this._getWidth(get)/2|0;}}
if(this.position.left==null&&this.position.right!=null){return this.screen.cols-this._getWidth(get)-this._getRight(get);}
if(this.screen.autoPadding){if((this.position.left!=null||this.position.right==null)&&this.position.left!=='center'){left+=this.parent.ileft;}}
return(parent.aleft||0)+left;};Object.defineProperty(Element.prototype,'aleft',{get:function(){return this._getLeft(false);},set:function(val){var expr;if(typeof val==='string'){if(val==='center'){val=this.screen.width/2|0;val-=this.width/2|0;}else{expr=val.split(/(?=\+|-)/);val=expr[0];val=+val.slice(0,-1)/100;val=this.screen.width*val|0;val+=+(expr[1]||0);}}
val-=this.parent.aleft;if(this.position.left===val)return;this.emit('move');this.clearPos();return this.position.left=val;}});Element.prototype._getRight=function(get){var parent=get?this.parent._getPos():this.parent,right=this.position.right||0;if(typeof right==='string'){expr=right.split(/(?=\+|-)/);right=expr[0];right=+right.slice(0,-1)/100;right=Math.ceil(parent.width*right)|0;return right;}
if(this.position.right==null&&this.position.left!=null){right=this.screen.cols-(this._getLeft(get)+this._getWidth(get));if(this.screen.autoPadding){right+=this.parent.iright;}
return right;}
right=(parent.aright||0)+(this.position.right||0);if(this.screen.autoPadding){right+=this.parent.iright;}
return right;};Object.defineProperty(Element.prototype,'aright',{get:function(){return this._getRight(false);},set:function(val){val-=this.parent.aright;if(this.position.right===val)return;this.emit('move');this.clearPos();return this.position.right=val;}});Element.prototype._getTop=function(get){var parent=get?this.parent._getPos():this.parent,top=this.position.top||0,expr;if(typeof top==='string'){if(top==='center')top='50%';expr=top.split(/(?=\+|-)/);top=expr[0];top=+top.slice(0,-1)/100;top=parent.height*top|0;top+=+(expr[1]||0);if(this.position.top==='center'){top-=this._getHeight(get)/2|0;}}
if(this.position.top==null&&this.position.bottom!=null){return this.screen.rows-this._getHeight(get)-this._getBottom(get);}
if(this.screen.autoPadding){if((this.position.top!=null||this.position.bottom==null)&&this.position.top!=='center'){top+=this.parent.itop;}}
return(parent.atop||0)+top;};Object.defineProperty(Element.prototype,'atop',{get:function(){return this._getTop(false);},set:function(val){var expr;if(typeof val==='string'){if(val==='center'){val=this.screen.height/2|0;val-=this.height/2|0;}else{expr=val.split(/(?=\+|-)/);val=expr[0];val=+val.slice(0,-1)/100;val=this.screen.height*val|0;val+=+(expr[1]||0);}}
val-=this.parent.atop;if(this.position.top===val)return;this.emit('move');this.clearPos();return this.position.top=val;}});Element.prototype._getBottom=function(get){var parent=get?this.parent._getPos():this.parent,bottom;if(this.position.bottom==null&&this.position.top!=null){bottom=this.screen.rows-(this._getTop(get)+this._getHeight(get));if(this.screen.autoPadding){bottom+=this.parent.ibottom;}
return bottom;}
bottom=(parent.abottom||0)+(this.position.bottom||0);if(this.screen.autoPadding){bottom+=this.parent.ibottom;}
return bottom;};Object.defineProperty(Element.prototype,'abottom',{get:function(){return this._getBottom(false);},set:function(val){val-=this.parent.abottom;if(this.position.bottom===val)return;this.emit('move');this.clearPos();return this.position.bottom=val;}});Object.defineProperty(Element.prototype,'rleft',{get:function(){return this.aleft-this.parent.aleft;},set:function(val){if(this.position.left===val)return;if(/^\d+$/.test(val))val=+val;this.emit('move');this.clearPos();return this.position.left=val;}});Object.defineProperty(Element.prototype,'rright',{get:function(){return this.aright-this.parent.aright;},set:function(val){if(this.position.right===val)return;this.emit('move');this.clearPos();return this.position.right=val;}});Object.defineProperty(Element.prototype,'rtop',{get:function(){return this.atop-this.parent.atop;},set:function(val){if(this.position.top===val)return;if(/^\d+$/.test(val))val=+val;this.emit('move');this.clearPos();return this.position.top=val;}});Object.defineProperty(Element.prototype,'rbottom',{get:function(){return this.abottom-this.parent.abottom;},set:function(val){if(this.position.bottom===val)return;this.emit('move');this.clearPos();return this.position.bottom=val;}});Object.defineProperty(Element.prototype,'ileft',{get:function(){return(this.border?1:0)+this.padding.left;}});Object.defineProperty(Element.prototype,'itop',{get:function(){return(this.border?1:0)+this.padding.top;}});Object.defineProperty(Element.prototype,'iright',{get:function(){return(this.border?1:0)+this.padding.right;}});Object.defineProperty(Element.prototype,'ibottom',{get:function(){return(this.border?1:0)+this.padding.bottom;}});Object.defineProperty(Element.prototype,'iwidth',{get:function(){return(this.border?2:0)+this.padding.left+this.padding.right;}});Object.defineProperty(Element.prototype,'iheight',{get:function(){return(this.border?2:0)+this.padding.top+this.padding.bottom;}});Object.defineProperty(Element.prototype,'tpadding',{get:function(){return this.padding.left+this.padding.top
+this.padding.right+this.padding.bottom;}});Object.defineProperty(Element.prototype,'left',{get:function(){return this.rleft;},set:function(val){return this.rleft=val;}});Object.defineProperty(Element.prototype,'right',{get:function(){return this.rright;},set:function(val){return this.rright=val;}});Object.defineProperty(Element.prototype,'top',{get:function(){return this.rtop;},set:function(val){return this.rtop=val;}});Object.defineProperty(Element.prototype,'bottom',{get:function(){return this.rbottom;},set:function(val){return this.rbottom=val;}});Element.prototype._getShrinkBox=function(xi,xl,yi,yl,get){if(!this.children.length){return{xi:xi,xl:xi+1,yi:yi,yl:yi+1};}
var i,el,ret,mxi=xi,mxl=xi+1,myi=yi,myl=yi+1;var _lpos;if(get){_lpos=this.lpos;this.lpos={xi:xi,xl:xl,yi:yi,yl:yl};}
for(i=0;i<this.children.length;i++){el=this.children[i];ret=el._getCoords(get);if(!ret)continue;if(el.position.left==null&&el.position.right!=null){ret.xl=xi+(ret.xl-ret.xi);ret.xi=xi;if(this.screen.autoPadding){ret.xl+=this.ileft;ret.xi+=this.ileft;}}
if(el.position.top==null&&el.position.bottom!=null){ret.yl=yi+(ret.yl-ret.yi);ret.yi=yi;if(this.screen.autoPadding){ret.yl+=this.itop;ret.yi+=this.itop;}}
if(ret.xi<mxi)mxi=ret.xi;if(ret.xl>mxl)mxl=ret.xl;if(ret.yi<myi)myi=ret.yi;if(ret.yl>myl)myl=ret.yl;}
if(get){this.lpos=_lpos;}
if(this.position.width==null&&(this.position.left==null||this.position.right==null)){if(this.position.left==null&&this.position.right!=null){xi=xl-(mxl-mxi);if(!this.screen.autoPadding){xi-=this.padding.left+this.padding.right;}else{xi-=this.ileft;}}else{xl=mxl;if(!this.screen.autoPadding){xl+=this.padding.left+this.padding.right;if(this.type==='list-table'){xl-=this.padding.left+this.padding.right;xl+=this.iright;}}else{xl+=this.iright;}}}
if(this.position.height==null&&(this.position.top==null||this.position.bottom==null)&&(!this.scrollable||this._isList)){if(this._isList){myi=0-this.itop;myl=this.items.length+this.ibottom;}
if(this.position.top==null&&this.position.bottom!=null){yi=yl-(myl-myi);if(!this.screen.autoPadding){yi-=this.padding.top+this.padding.bottom;}else{yi-=this.itop;}}else{yl=myl;if(!this.screen.autoPadding){yl+=this.padding.top+this.padding.bottom;}else{yl+=this.ibottom;}}}
return{xi:xi,xl:xl,yi:yi,yl:yl};};Element.prototype._getShrinkContent=function(xi,xl,yi,yl){if(!this._clines)return{xi:xi,xl:xl,yi:yi,yl:yl};var h=this._clines.length,w=this._clines.mwidth||1;if(this.position.width==null&&(this.position.left==null||this.position.right==null)){if(this.position.left==null&&this.position.right!=null){xi=xl-w-this.iwidth;}else{xl=xi+w+this.iwidth;}}
if(this.position.height==null&&(this.position.top==null||this.position.bottom==null)&&(!this.scrollable||this._isList)){if(this.position.top==null&&this.position.bottom!=null){yi=yl-h-this.iheight;}else{yl=yi+h+this.iheight;}}
return{xi:xi,xl:xl,yi:yi,yl:yl};};Element.prototype._getShrink=function(xi,xl,yi,yl,get){var shrinkBox=this._getShrinkBox(xi,xl,yi,yl,get),shrinkContent=this._getShrinkContent(xi,xl,yi,yl,get),xll=xl,yll=yl;if(shrinkBox.xl-shrinkBox.xi>shrinkContent.xl-shrinkContent.xi){xi=shrinkBox.xi;xl=shrinkBox.xl;}else{xi=shrinkContent.xi;xl=shrinkContent.xl;}
if(shrinkBox.yl-shrinkBox.yi>shrinkContent.yl-shrinkContent.yi){yi=shrinkBox.yi;yl=shrinkBox.yl;}else{yi=shrinkContent.yi;yl=shrinkContent.yl;}
if(xl<xll&&this.position.left==='center'){xll=(xll-xl)/2|0;xi+=xll;xl+=xll;}
if(yl<yll&&this.position.top==='center'){yll=(yll-yl)/2|0;yi+=yll;yl+=yll;}
return{xi:xi,xl:xl,yi:yi,yl:yl};};Element.prototype._getCoords=function(get,noscroll){if(this.hidden)return;var xi=this._getLeft(get),xl=xi+this._getWidth(get),yi=this._getTop(get),yl=yi+this._getHeight(get),base=this.childBase||0,el=this,fixed=this.fixed,coords,v,noleft,noright,notop,nobot,ppos,b;if(this.shrink){coords=this._getShrink(xi,xl,yi,yl,get);xi=coords.xi,xl=coords.xl;yi=coords.yi,yl=coords.yl;}
while(el=el.parent){if(el.scrollable){if(fixed){fixed=false;continue;}
break;}}
var thisparent=el;if(el&&!noscroll){ppos=thisparent.lpos;if(!ppos)return;yi-=ppos.base;yl-=ppos.base;b=thisparent.border?1:0;if(this._isLabel){b=0;}
if(yi<ppos.yi+b){if(yl-1<ppos.yi+b){return;}else{notop=true;v=ppos.yi-yi;if(this.border)v--;if(thisparent.border)v++;base+=v;yi+=v;}}else if(yl>ppos.yl-b){if(yi>ppos.yl-1-b){return;}else{nobot=true;v=yl-ppos.yl;if(this.border)v--;if(thisparent.border)v++;yl-=v;}}
if(yi>=yl)return;if(xi<el.lpos.xi){xi=el.lpos.xi;noleft=true;if(this.border)xi--;if(thisparent.border)xi++;}
if(xl>el.lpos.xl){xl=el.lpos.xl;noright=true;if(this.border)xl++;if(thisparent.border)xl--;}
if(xi>=xl)return;}
if(this.noOverflow&&this.parent.lpos){if(xi<this.parent.lpos.xi+this.parent.ileft){xi=this.parent.lpos.xi+this.parent.ileft;}
if(xl>this.parent.lpos.xl-this.parent.iright){xl=this.parent.lpos.xl-this.parent.iright;}
if(yi<this.parent.lpos.yi+this.parent.itop){yi=this.parent.lpos.yi+this.parent.itop;}
if(yl>this.parent.lpos.yl-this.parent.ibottom){yl=this.parent.lpos.yl-this.parent.ibottom;}}
return{xi:xi,xl:xl,yi:yi,yl:yl,base:base,noleft:noleft,noright:noright,notop:notop,nobot:nobot,renders:this.screen.renders};};Element.prototype.render=function(){this._emit('prerender');this.parseContent();var coords=this._getCoords(true);if(!coords){delete this.lpos;return;}
if(coords.xl-coords.xi<=0){coords.xl=Math.max(coords.xl,coords.xi);return;}
if(coords.yl-coords.yi<=0){coords.yl=Math.max(coords.yl,coords.yi);return;}
var lines=this.screen.lines,xi=coords.xi,xl=coords.xl,yi=coords.yi,yl=coords.yl,x,y,cell,attr,ch,content=this._pcontent,ci=this._clines.ci[coords.base],battr,dattr,c,visible,i,bch=this.ch;if(coords.base>=this._clines.ci.length){ci=this._pcontent.length;}
this.lpos=coords;if(this.border&&this.border.type==='line'){this.screen._borderStops[coords.yi]=true;this.screen._borderStops[coords.yl-1]=true;}
dattr=this.sattr(this.style);attr=dattr;if(ci>0){attr=this._clines.attr[Math.min(coords.base,this._clines.length-1)];}
if(this.border)xi++,xl--,yi++,yl--;if(this.tpadding||(this.valign&&this.valign!=='top')){if(this.style.transparent){for(y=Math.max(yi,0);y<yl;y++){if(!lines[y])break;for(x=Math.max(xi,0);x<xl;x++){if(!lines[y][x])break;lines[y][x][0]=colors.blend(attr,lines[y][x][0]);lines[y].dirty=true;}}}else{this.screen.fillRegion(dattr,bch,xi,xl,yi,yl);}}
if(this.tpadding){xi+=this.padding.left,xl-=this.padding.right;yi+=this.padding.top,yl-=this.padding.bottom;}
if(this.valign==='middle'||this.valign==='bottom'){visible=yl-yi;if(this._clines.length<visible){if(this.valign==='middle'){visible=visible/2|0;visible-=this._clines.length/2|0;}else if(this.valign==='bottom'){visible-=this._clines.length;}
ci-=visible*(xl-xi);}}
for(y=yi;y<yl;y++){if(!lines[y]){if(y>=this.screen.height||yl<this.ibottom){break;}else{continue;}}
for(x=xi;x<xl;x++){cell=lines[y][x];if(!cell){if(x>=this.screen.width||xl<this.iright){break;}else{continue;}}
ch=content[ci++]||bch;while(ch==='\x1b'){if(c=/^\x1b\[[\d;]*m/.exec(content.substring(ci-1))){ci+=c[0].length-1;attr=this.screen.attrCode(c[0],attr,dattr);if(this.parent._isList&&this.parent.interactive&&this.parent.items[this.parent.selected]===this&&this.parent.options.invertSelected!==false){attr=(attr&~(0x1ff<<9))|(dattr&(0x1ff<<9));}
ch=content[ci]||bch;ci++;}else{break;}}
if(ch==='\t')ch=bch;if(ch==='\n'){if(x===xi&&y!==yi&&content[ci-2]!=='\n'){x--;continue;}
ch=bch;for(;x<xl;x++){cell=lines[y][x];if(!cell)break;if(this.style.transparent){lines[y][x][0]=colors.blend(attr,lines[y][x][0]);if(content[ci])lines[y][x][1]=ch;lines[y].dirty=true;}else{if(attr!==cell[0]||ch!==cell[1]){lines[y][x][0]=attr;lines[y][x][1]=ch;lines[y].dirty=true;}}}
continue;}
if(this.screen.fullUnicode&&content[ci-1]){var point=unicode.codePointAt(content,ci-1);if(unicode.combining[point]){if(point>0x00ffff){ch=content[ci-1]+content[ci];ci++;}
if(x-1>=xi){lines[y][x-1][1]+=ch;}else if(y-1>=yi){lines[y-1][xl-1][1]+=ch;}
x--;continue;}
if(point>0x00ffff){ch=content[ci-1]+content[ci];ci++;}}
if(this._noFill)continue;if(this.style.transparent){lines[y][x][0]=colors.blend(attr,lines[y][x][0]);if(content[ci])lines[y][x][1]=ch;lines[y].dirty=true;}else{if(attr!==cell[0]||ch!==cell[1]){lines[y][x][0]=attr;lines[y][x][1]=ch;lines[y].dirty=true;}}}}
if(this.scrollbar){i=Math.max(this._clines.length,this._scrollBottom());}
if(coords.notop||coords.nobot)i=-Infinity;if(this.scrollbar&&(yl-yi)<i){x=xl-1;if(this.scrollbar.ignoreBorder&&this.border)x++;if(this.alwaysScroll){y=this.childBase/(i-(yl-yi));}else{y=(this.childBase+this.childOffset)/(i-1);}
y=yi+((yl-yi)*y|0);if(y>=yl)y=yl-1;cell=lines[y]&&lines[y][x];if(cell){if(this.track){ch=this.track.ch||' ';attr=this.sattr(this.style.track,this.style.track.fg||this.style.fg,this.style.track.bg||this.style.bg);this.screen.fillRegion(attr,ch,x,x+1,yi,yl);}
ch=this.scrollbar.ch||' ';attr=this.sattr(this.style.scrollbar,this.style.scrollbar.fg||this.style.fg,this.style.scrollbar.bg||this.style.bg);if(attr!==cell[0]||ch!==cell[1]){lines[y][x][0]=attr;lines[y][x][1]=ch;lines[y].dirty=true;}}}
if(this.border)xi--,xl++,yi--,yl++;if(this.tpadding){xi-=this.padding.left,xl+=this.padding.right;yi-=this.padding.top,yl+=this.padding.bottom;}
if(this.border){battr=this.sattr(this.style.border);y=yi;if(coords.notop)y=-1;for(x=xi;x<xl;x++){if(!lines[y])break;if(coords.noleft&&x===xi)continue;if(coords.noright&&x===xl-1)continue;cell=lines[y][x];if(!cell)continue;if(this.border.type==='line'){if(x===xi){if(!this.border.double)ch='\u250c';else ch='\u2554';if(!this.border.left){if(this.border.top){if(!this.border.double)ch='\u2500';else ch='\u2550';}else{continue;}}else{if(!this.border.top){if(!this.border.double)ch='\u2502';else ch='\u2551';}}}else if(x===xl-1){if(!this.border.double)ch='\u2510';else ch='\u2557';if(!this.border.right){if(this.border.top){if(!this.border.double)ch='\u2500';else ch='\u2550';}else{continue;}}else{if(!this.border.top){if(!this.border.double)ch='\u2502';else ch='\u2551';}}}else{if(!this.border.double)ch='\u2500';else ch='\u2550';}}else if(this.border.type==='bg'){ch=this.border.ch;}
if(!this.border.top&&x!==xi&&x!==xl-1){ch=' ';if(dattr!==cell[0]||ch!==cell[1]){lines[y][x][0]=dattr;lines[y][x][1]=ch;lines[y].dirty=true;continue;}}
if(battr!==cell[0]||ch!==cell[1]){lines[y][x][0]=battr;lines[y][x][1]=ch;lines[y].dirty=true;}}
y=yi+1;for(;y<yl-1;y++){if(!lines[y])continue;cell=lines[y][xi];if(cell){if(this.border.left){if(this.border.type==='line'){if(!this.border.double)ch='\u2502';else ch='\u2551';}else if(this.border.type==='bg'){ch=this.border.ch;}
if(!coords.noleft)
if(battr!==cell[0]||ch!==cell[1]){lines[y][xi][0]=battr;lines[y][xi][1]=ch;lines[y].dirty=true;}}else{ch=' ';if(dattr!==cell[0]||ch!==cell[1]){lines[y][xi][0]=dattr;lines[y][xi][1]=ch;lines[y].dirty=true;}}}
cell=lines[y][xl-1];if(cell){if(this.border.right){if(this.border.type==='line'){if(!this.border.double)ch='\u2502';else ch='\u2551';}else if(this.border.type==='bg'){ch=this.border.ch;}
if(!coords.noright)
if(battr!==cell[0]||ch!==cell[1]){lines[y][xl-1][0]=battr;lines[y][xl-1][1]=ch;lines[y].dirty=true;}}else{ch=' ';if(dattr!==cell[0]||ch!==cell[1]){lines[y][xl-1][0]=dattr;lines[y][xl-1][1]=ch;lines[y].dirty=true;}}}}
y=yl-1;if(coords.nobot)y=-1;for(x=xi;x<xl;x++){if(!lines[y])break;if(coords.noleft&&x===xi)continue;if(coords.noright&&x===xl-1)continue;cell=lines[y][x];if(!cell)continue;if(this.border.type==='line'){if(x===xi){if(!this.border.double)ch='\u2514';else ch='\u255a';if(!this.border.left){if(this.border.bottom){if(!this.border.double)ch='\u2500';else ch='\u2550';}else{continue;}}else{if(!this.border.bottom){if(!this.border.double)ch='\u2502';else ch='\u2551';}}}else if(x===xl-1){if(!this.border.double)ch='\u2518';else ch='\u255d';if(!this.border.right){if(this.border.bottom){if(!this.border.double)ch='\u2500';else ch='\u2550';}else{continue;}}else{if(!this.border.bottom){if(!this.border.double)ch='\u2502';else ch='\u2551';}}}else{if(!this.border.double)ch='\u2500';else ch='\u2550';}}else if(this.border.type==='bg'){ch=this.border.ch;}
if(!this.border.bottom&&x!==xi&&x!==xl-1){ch=' ';if(dattr!==cell[0]||ch!==cell[1]){lines[y][x][0]=dattr;lines[y][x][1]=ch;lines[y].dirty=true;}
continue;}
if(battr!==cell[0]||ch!==cell[1]){lines[y][x][0]=battr;lines[y][x][1]=ch;lines[y].dirty=true;}}}
if(this.shadow){y=Math.max(yi+1,0);for(;y<yl+1;y++){if(!lines[y])break;x=xl;for(;x<xl+2;x++){if(!lines[y][x])break;lines[y][x][0]=colors.blend(lines[y][x][0]);lines[y].dirty=true;}}
y=yl;for(;y<yl+1;y++){if(!lines[y])break;for(x=Math.max(xi+1,0);x<xl;x++){if(!lines[y][x])break;lines[y][x][0]=colors.blend(lines[y][x][0]);lines[y].dirty=true;}}}
this.children.forEach(function(el){if(el.screen._ci!==-1){el.index=el.screen._ci++;}
el.render();});this._emit('render',[coords]);return coords;};Element.prototype._render=Element.prototype.render;Element.prototype.insertLine=function(i,line){if(typeof line==='string')line=line.split('\n');if(i!==i||i==null){i=this._clines.ftor.length;}
i=Math.max(i,0);while(this._clines.fake.length<i){this._clines.fake.push('');this._clines.ftor.push([this._clines.push('')-1]);this._clines.rtof(this._clines.fake.length-1);}
var start=this._clines.length,diff,real;if(i>=this._clines.ftor.length){real=this._clines.ftor[this._clines.ftor.length-1];real=real[real.length-1]+1;}else{real=this._clines.ftor[i][0];}
for(var j=0;j<line.length;j++){this._clines.fake.splice(i+j,0,line[j]);}
this.setContent(this._clines.fake.join('\n'),true);diff=this._clines.length-start;if(diff>0){var pos=this._getCoords();if(!pos)return;var height=pos.yl-pos.yi-this.iheight,base=this.childBase||0,visible=real>=base&&real-base<height;if(pos&&visible&&this.screen.cleanSides(this)){this.screen.insertLine(diff,pos.yi+this.itop+real-base,pos.yi,pos.yl-this.ibottom-1);}}};Element.prototype.deleteLine=function(i,n){n=n||1;if(i!==i||i==null){i=this._clines.ftor.length-1;}
i=Math.max(i,0);i=Math.min(i,this._clines.ftor.length-1);var start=this._clines.length,diff,real=this._clines.ftor[i][0];while(n--){this._clines.fake.splice(i,1);}
this.setContent(this._clines.fake.join('\n'),true);diff=start-this._clines.length;var height=0;if(diff>0){var pos=this._getCoords();if(!pos)return;height=pos.yl-pos.yi-this.iheight;var base=this.childBase||0,visible=real>=base&&real-base<height;if(pos&&visible&&this.screen.cleanSides(this)){this.screen.deleteLine(diff,pos.yi+this.itop+real-base,pos.yi,pos.yl-this.ibottom-1);}}
if(this._clines.length<height){this.clearPos();}};Element.prototype.insertTop=function(line){var fake=this._clines.rtof[this.childBase||0];return this.insertLine(fake,line);};Element.prototype.insertBottom=function(line){var h=(this.childBase||0)+this.height-this.iheight,i=Math.min(h,this._clines.length),fake=this._clines.rtof[i-1]+1;return this.insertLine(fake,line);};Element.prototype.deleteTop=function(n){var fake=this._clines.rtof[this.childBase||0];return this.deleteLine(fake,n);};Element.prototype.deleteBottom=function(n){var h=(this.childBase||0)+this.height-1-this.iheight,i=Math.min(h,this._clines.length-1),fake=this._clines.rtof[i];n=n||1;return this.deleteLine(fake-(n-1),n);};Element.prototype.setLine=function(i,line){i=Math.max(i,0);while(this._clines.fake.length<i){this._clines.fake.push('');}
this._clines.fake[i]=line;return this.setContent(this._clines.fake.join('\n'),true);};Element.prototype.setBaseLine=function(i,line){var fake=this._clines.rtof[this.childBase||0];return this.setLine(fake+i,line);};Element.prototype.getLine=function(i){i=Math.max(i,0);i=Math.min(i,this._clines.fake.length-1);return this._clines.fake[i];};Element.prototype.getBaseLine=function(i){var fake=this._clines.rtof[this.childBase||0];return this.getLine(fake+i);};Element.prototype.clearLine=function(i){i=Math.min(i,this._clines.fake.length-1);return this.setLine(i,'');};Element.prototype.clearBaseLine=function(i){var fake=this._clines.rtof[this.childBase||0];return this.clearLine(fake+i);};Element.prototype.unshiftLine=function(line){return this.insertLine(0,line);};Element.prototype.shiftLine=function(n){return this.deleteLine(0,n);};Element.prototype.pushLine=function(line){if(!this.content)return this.setLine(0,line);return this.insertLine(this._clines.fake.length,line);};Element.prototype.popLine=function(n){return this.deleteLine(this._clines.fake.length-1,n);};Element.prototype.getLines=function(){return this._clines.fake.slice();};Element.prototype.getScreenLines=function(){return this._clines.slice();};Element.prototype.strWidth=function(text){text=this.parseTags?helpers.stripTags(text):text;return this.screen.fullUnicode?unicode.strWidth(text):helpers.dropUnicode(text).length;};Element.prototype.screenshot=function(xi,xl,yi,yl){xi=this.lpos.xi+this.ileft+(xi||0);if(xl!=null){xl=this.lpos.xi+this.ileft+(xl||0);}else{xl=this.lpos.xl-this.iright;}
yi=this.lpos.yi+this.itop+(yi||0);if(yl!=null){yl=this.lpos.yi+this.itop+(yl||0);}else{yl=this.lpos.yl-this.ibottom;}
return this.screen.screenshot(xi,xl,yi,yl);};module.exports=Element;};BundleModuleCode['term/widgets/arrows']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var Helpers=Require('term/helpers');var Button=Require('term/widgets/button');module.exports=function(parent,options,up,down,nocontrol){var bbox;bbox=Helpers.bbox(parent.screen,options);parent._.up=new Button({screen:parent.screen,top:bbox.top+1,height:options.arrows.height||1,left:bbox.left+bbox.width,width:options.arrows.width||3,content:options.arrows.up||'[-]',align:'center',style:{fg:options.arrows.fg||'red',bg:options.arrows.bg||'white',bold:true,},autoFocus:false,hidden:options.hidden,mouse:true});parent._.up.on('press',up);parent.screen.append(parent._.up);parent._.down=new Button({screen:this.screen,top:bbox.top+bbox.height-1-(options.arrows.height||1),height:options.arrows.height||1,left:bbox.left+bbox.width,width:options.arrows.width||3,content:options.arrows.down||'[+]',align:'center',style:{fg:options.arrows.fg||'red',bg:options.arrows.bg||'white',bold:true,},autoFocus:false,hidden:options.hidden,mouse:true});parent._.down.on('press',down);parent.screen.append(parent._.down);if(!nocontrol){parent._hide=parent.hide;parent.hide=function(){parent._hide();if(parent._.up)parent._.up.hide();if(parent._.down)parent._.down.hide();parent.screen.render();}
parent._show=parent.show;parent.show=function(){parent._show();if(parent._.up)parent._.up.show();if(parent._.down)parent._.down.show();parent.screen.render();}}}};BundleModuleCode['term/widgets/scrollabletext']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var ScrollableBox=Require('term/widgets/scrollablebox');function ScrollableText(options){if(!instanceOf(this,Node)){return new ScrollableText(options);}
options=options||{};options.alwaysScroll=true;ScrollableBox.call(this,options);}
inheritPrototype(ScrollableText,ScrollableBox);ScrollableText.prototype.type='scrollable-text';module.exports=ScrollableText;};BundleModuleCode['term/widgets/scrollablebox']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function ScrollableBox(options){var self=this;if(!instanceOf(this,Node)){return new ScrollableBox(options);}
options=options||{};Box.call(this,options);if(options.scrollable===false){return this;}
this.scrollable=true;this.childOffset=0;this.childBase=0;this.baseLimit=options.baseLimit||Infinity;this.alwaysScroll=options.alwaysScroll;this.scrollbar=options.scrollbar;if(this.scrollbar){this.scrollbar.ch=this.scrollbar.ch||' ';this.style.scrollbar=this.style.scrollbar||this.scrollbar.style;if(!this.style.scrollbar){this.style.scrollbar={};this.style.scrollbar.fg=this.scrollbar.fg;this.style.scrollbar.bg=this.scrollbar.bg;this.style.scrollbar.bold=this.scrollbar.bold;this.style.scrollbar.underline=this.scrollbar.underline;this.style.scrollbar.inverse=this.scrollbar.inverse;this.style.scrollbar.invisible=this.scrollbar.invisible;}
if(this.track||this.scrollbar.track){this.track=this.scrollbar.track||this.track;this.style.track=this.style.scrollbar.track||this.style.track;this.track.ch=this.track.ch||' ';this.style.track=this.style.track||this.track.style;if(!this.style.track){this.style.track={};this.style.track.fg=this.track.fg;this.style.track.bg=this.track.bg;this.style.track.bold=this.track.bold;this.style.track.underline=this.track.underline;this.style.track.inverse=this.track.inverse;this.style.track.invisible=this.track.invisible;}
this.track.style=this.style.track;}
if(options.mouse){this.on('mousedown',function(data){if(self._scrollingBar){delete self.screen._dragging;delete self._drag;return;}
var x=data.x-self.aleft;var y=data.y-self.atop;self.emit('clicked',{x:x-1,y:y-1,ev:'click'});if(x===self.width-self.iright-1){delete self.screen._dragging;delete self._drag;var perc=(y-self.itop)/(self.height-self.iheight);self.setScrollPerc(perc*100|0);self.screen.render();var smd,smu;self._scrollingBar=true;self.onScreenEvent('mousedown',smd=function(data){var y=data.y-self.atop;var perc=y/self.height;self.setScrollPerc(perc*100|0);self.screen.render();});self.onScreenEvent('mouseup',smu=function(){self._scrollingBar=false;self.removeScreenEvent('mousedown',smd);self.removeScreenEvent('mouseup',smu);});}});}}
if(options.mouse){this.on('wheeldown',function(){self.scroll(self.height/2|0||1);self.screen.render();});this.on('wheelup',function(){self.scroll(-(self.height/2|0)||-1);self.screen.render();});}
if(options.keys&&!options.ignoreKeys){this.on('keypress',function(ch,key){if(key.name==='up'||(options.vi&&key.name==='k')){self.scroll(-1);self.screen.render();return;}
if(key.name==='down'||(options.vi&&key.name==='j')){self.scroll(1);self.screen.render();return;}
if(key.name==='pageup'){self.scroll(-(self.height/2|0)||-1);self.screen.render();return;}
if(key.name==='pagedown'){self.scroll(self.height/2|0||1);self.screen.render();return;}
if(options.vi&&key.name==='u'&&key.ctrl){self.scroll(-(self.height/2|0)||-1);self.screen.render();return;}
if(options.vi&&key.name==='d'&&key.ctrl){self.scroll(self.height/2|0||1);self.screen.render();return;}
if(options.vi&&key.name==='b'&&key.ctrl){self.scroll(-self.height||-1);self.screen.render();return;}
if(options.vi&&key.name==='f'&&key.ctrl){self.scroll(self.height||1);self.screen.render();return;}
if(options.vi&&key.name==='g'&&!key.shift){self.scrollTo(0);self.screen.render();return;}
if(options.vi&&key.name==='g'&&key.shift){self.scrollTo(self.getScrollHeight());self.screen.render();return;}});}
this.on('parsed content',function(){self._recalculateIndex();});self._recalculateIndex();}
inheritPrototype(ScrollableBox,Box);ScrollableBox.prototype.type='scrollable-box';Object.defineProperty(ScrollableBox.prototype,'reallyScrollable',{get:function(){if(this.shrink)return this.scrollable;return this.getScrollHeight()>this.height;},set:function(val){}});ScrollableBox.prototype._scrollBottom=function(){if(!this.scrollable)return 0;if(this._isList){return this.items?this.items.length:0;}
if(this.lpos&&this.lpos._scrollBottom){return this.lpos._scrollBottom;}
var bottom=this.children.reduce(function(current,el){if(!el.detached){var lpos=el._getCoords(false,true);if(lpos){return Math.max(current,el.rtop+(lpos.yl-lpos.yi));}}
return Math.max(current,el.rtop+el.height);},0);if(this.lpos)this.lpos._scrollBottom=bottom;return bottom;};ScrollableBox.prototype.setScroll=ScrollableBox.prototype.scrollTo=function(offset,always){this.scroll(0);return this.scroll(offset-(this.childBase+this.childOffset),always);};ScrollableBox.prototype.getScroll=function(){return this.childBase+this.childOffset;};ScrollableBox.prototype.scroll=function(offset,always){if(!this.scrollable)return;if(this.detached)return;var visible=this.height-this.iheight,base=this.childBase,d,p,t,b,max,emax;if(this.alwaysScroll||always){this.childOffset=offset>0?visible-1+offset:offset;}else{this.childOffset+=offset;}
if(this.childOffset>visible-1){d=this.childOffset-(visible-1);this.childOffset-=d;this.childBase+=d;}else if(this.childOffset<0){d=this.childOffset;this.childOffset+=-d;this.childBase+=d;}
if(this.childBase<0){this.childBase=0;}else if(this.childBase>this.baseLimit){this.childBase=this.baseLimit;}
if(this.childBase===base){return this.emit('scroll');}
this.parseContent();max=this._clines.length-(this.height-this.iheight);if(max<0)max=0;emax=this._scrollBottom()-(this.height-this.iheight);if(emax<0)emax=0;this.childBase=Math.min(this.childBase,Math.max(emax,max));if(this.childBase<0){this.childBase=0;}else if(this.childBase>this.baseLimit){this.childBase=this.baseLimit;}
p=this.lpos;if(p&&this.childBase!==base&&this.screen.cleanSides(this)){t=p.yi+this.itop;b=p.yl-this.ibottom-1;d=this.childBase-base;if(d>0&&d<visible){this.screen.deleteLine(d,t,t,b);}else if(d<0&&-d<visible){d=-d;this.screen.insertLine(d,t,t,b);}}
return this.emit('scroll');};ScrollableBox.prototype.scrollBottom=function(){this.scrollTo(10000000);};ScrollableBox.prototype._recalculateIndex=function(){var max,emax;if(this.detached||!this.scrollable){return 0;}
max=this._clines.length-(this.height-this.iheight);if(max<0)max=0;emax=this._scrollBottom()-(this.height-this.iheight);if(emax<0)emax=0;this.childBase=Math.min(this.childBase,Math.max(emax,max));if(this.childBase<0){this.childBase=0;}else if(this.childBase>this.baseLimit){this.childBase=this.baseLimit;}};ScrollableBox.prototype.resetScroll=function(){if(!this.scrollable)return;this.childOffset=0;this.childBase=0;return this.emit('scroll');};ScrollableBox.prototype.getScrollHeight=function(){return Math.max(this._clines.length,this._scrollBottom());};ScrollableBox.prototype.getScrollPerc=function(s){var pos=this.lpos||this._getCoords();if(!pos)return s?-1:0;var height=(pos.yl-pos.yi)-this.iheight,i=this.getScrollHeight(),p;if(height<i){if(this.alwaysScroll){p=this.childBase/(i-height);}else{p=(this.childBase+this.childOffset)/(i-1);}
return p*100;}
return s?-1:0;};ScrollableBox.prototype.setScrollPerc=function(i){var m=Math.max(this._clines.length,this._scrollBottom());return this.scrollTo((i/100)*m|0);};module.exports=ScrollableBox;};BundleModuleCode['term/widgets/chat']=function(module,exports){var Comp=Require('com/compat');var unicode=Require('term/unicode');var nextTick=global.setImmediate||process.nextTick.bind(process);var Node=Require('term/widgets/node');var Input=Require('term/widgets/input');function setCharAt(str,index,chr){if(index>str.length-1)return str;return str.substring(0,index)+chr+str.substring(index+1);}
function Chat(options){var self=this;if(!instanceOf(this,Node)){return new Chat(options);}
options=options||{};options.scrollable=options.scrollable!==false;Input.call(this,options);this.screen._listenKeys(this);this.value=options.value||'';this.cpos={x:-1,y:-1};this.cursorControl=true;this.multiline=options.multiline;this.tags=true;this.input='text';this.history=[];this.historyTop=0;this.__updateCursor=this._updateCursor.bind(this);this.on('resize',this.__updateCursor);this.on('move',this.__updateCursor);if(options.inputOnFocus){this.on('focus',this.readInput.bind(this,null));}
if(!options.inputOnFocus&&options.keys){this.on('keypress',function(ch,key){if(self._reading)return;if(key.name==='enter'||(options.vi&&key.name==='i')){return self.readInput();}
if(key.name==='e'){return self.readEditor();}});}
if(options.mouse){this.on('click',function(data){if(self._reading)return;if(data.button!=='right')return;self.readEditor();});}
var offsetY=0;if(this._clines)offsetY=this._clines.length-(this.childBase||0);if(options.prompt){this.value=options.prompt;this.prompt=options.prompt;this.inputRange={x0:options.prompt.length,y0:offsetY,y1:offsetY,last:0,line:0};}else{this.inputRange={x0:0,y0:offsetY,y1:offsetY,last:0,line:0};this.prompt='';}}
inheritPrototype(Chat,Input);Chat.prototype.type='terminal';Chat.prototype._updateCursor=function(get){var offsetY=this.childBase||0;if(this.screen.focused!==this){this.cpos.y=Math.min(this._clines.length-1-offsetY,this.cpos.y);return;}
var lpos=get?this.lpos:this._getCoords();if(!lpos)return;var last=this._clines[this._clines.length-1],program=this.screen.program,line,offsetY=this.childBase||0,cx,cy;if(last===''&&this.value[this.value.length-1]!=='\n'){last=this._clines[this._clines.length-2]||'';}
line=Math.min(this._clines.length-1-(this.childBase||0),(lpos.yl-lpos.yi)-this.iheight-1);line=Math.max(0,line);if(this.cpos.x==-1||!this.cursorControl)this.cpos.x=this.strWidth(last);if(this.cpos.y==-1||!this.cursorControl)this.cpos.y=line;this.cpos.y=Math.min(this.cpos.y,line);this.cpos.x=Math.min(this.cpos.x,this.strWidth(this._clines[offsetY+this.cpos.y]));cx=lpos.xi+this.ileft+this.cpos.x;cy=lpos.yi+this.itop+this.cpos.y;if(cy===program.y&&cx===program.x){return;}
if(cy===program.y){if(cx>program.x){program.cuf(cx-program.x);}else if(cx<program.x){program.cub(program.x-cx);}}else if(cx===program.x){if(cy>program.y){program.cud(cy-program.y);}else if(cy<program.y){program.cuu(program.y-cy);}}else{program.cup(cy,cx);}};Chat.prototype.input=Chat.prototype.setInput=Chat.prototype.readInput=function(callback){var self=this,focused=this.screen.focused===this;if(this._reading)return;this._reading=true;this._callback=callback;if(!focused){this.screen.saveFocus();this.focus();}
this.screen.grabKeys=true;this._updateCursor();this.screen.program.showCursor();this._done=function fn(err,value){if(!self._reading)return;if(fn.done)return;fn.done=true;self._reading=false;delete self._callback;delete self._done;self.removeListener('keypress',self.__listener);delete self.__listener;self.removeListener('blur',self.__done);delete self.__done;self.screen.program.hideCursor();self.screen.grabKeys=false;if(!focused){self.screen.restoreFocus();}
if(self.options.inputOnFocus){self.screen.rewindFocus();}
if(err==='stop')return;if(err){self.emit('error',err);}else if(value!=null){self.emit('submit',value);}else{self.emit('cancel',value);}
self.emit('action',value);if(!callback)return;return err?callback(err):callback(null,value);};nextTick(function(){if(self.__listener){return;}
self.__listener=self._listener.bind(self);self.on('keypress',self.__listener);});this.__done=this._done.bind(this,null,null);this.on('blur',this.__done);};Chat.prototype.ask=function(message,options,callback){var offsetY=this.childBase||0,prompt=this.prompt,self=this;options=options||{};if(this.request){return;}
var restorePos=offsetY+this.cpos.y;function ask(command,restore){offsetY=self.childBase||0;var start=self.getLinearPos(self.value,offsetY+self.inputRange.y0,0),end=self.getLinearPos(self.value,offsetY+self.inputRange.y1,self._clines[offsetY+self.inputRange.y1].length);var line;if(restore)start=self.getLinearPos(self.value,restorePos,0);self.value=self.value.slice(0,start)+self.prompt+command+self.value.slice(end);self.screen.render();self.scrollBottom();self.cpos.x=self._clines[self._clines.length-1].length;self.cpos.y+=10;self._updateCursor(true);self.inputRange.y1=self.cpos.y;offsetY=self.childBase||0;var y0=self.cpos.y;self.inputRange.x0=self.prompt.length;self.inputRange.x1=null;while(self._clines[offsetY+y0].indexOf(self.prompt)!=0)y0--;self.inputRange.y0=y0;self.inputRange.last=self.inputRange.y1-self.inputRange.y0;}
this.print('{bold}'+message+'{/bold}');if(options.choices){var choices=options.choices.slice();this.prompt='? ';var delim=options.layout=='vertical'?'\n':' ',indent=options.layout=='vertical'?'  ':'';if(!options.mutable){line=choices.map(function(s,i){return(i>0?indent:'')+'[ ] '+s}).join(delim);line+=(delim+indent+'[Ok] [Cancel]');choices.push(restore1);choices.push(restore1);}else{line=choices.map(function(s,i){return(i>0?indent:'')+'['+s+']'}).join(delim);line+=(delim+indent+'[Cancel]');choices.push(restore1);}
ask(line);this.input='mouse';this.screen.program.hideCursor(true);var y=this.inputRange.y0,x=this.inputRange.x0;line=this._clines[offsetY+y];var actions=choices.map(function(choice,index){while(line[x]&&line[x]!='['){x++;if(!line[x]&&y<self.inputRange.y1){x=0;y++;line=self._clines[offsetY+y];}}
if(line[x]&&line[x+1]==' '){x++;return{choice:choice,index:index,fake:self.getLinearPos(self.value,offsetY+y,x),pos:{x:x,y:y}};}else{x++;var start={x:x,y:y};while(line[x]&&line[x]!=']'){x++;if(!line[x]&&y<self.inputRange.y1){x=0;y++;line=self._clines[offsetY+y];}}
var end={x:x-1,y:y}
return typeof choice=='string'?{choice:choice,index:index,pos:[start,end]}:{action:choice,index:index,pos:[start,end]};}});function clicked1(pos){var offsetY=self.childBase||0;function within(o){if(typeof o.x!='undefined'){return pos.x==o.x&&pos.y==o.y}else if(o.length==2){if(o[0].y==o[1].y&&o[0].y==pos.y)
return pos.x>=o[0].x&&pos.x<=o[1].x;else if(pos.y>=o[0].y&&pos.y<=o[1].y)
return pos.x>=o[0].x&&pos.x<=o[1].x}}
actions.forEach(function(action){if(!action)return;if(within(action.pos)){if(action.choice){if(self.selected.indexOf(action.choice)!=-1){self.selected=self.selected.filter(function(choice){return choice!=action.choice});self.value=setCharAt(self.value,action.fake,' ');self.screen.render();}else{if(!options.mutable){self.value=setCharAt(self.value,action.fake,'X');self.screen.render();changed1();}
self.selected.push(action.choice);if(options.mutable)restore1();}}
if(action.action){action.action();}}})};function changed1(){if(options.timeout){if(self.timer)clearTimeout(self.timer);self.timer=setTimeout(restore1,options.timeout);}}
function restore1(timeout){var result=callback?callback(self.selected):null;if(self.selected!=undefined&&self.selected.length)
self.print(self.selected.join(', '),self.style.user);if(result)self.print(result);self.prompt=prompt;ask('',!result&&self.selected.length==0);self.input='text';self.removeListener('clicked',clicked1);if(!timeout&&self.timer)clearTimeout(self.timer);self.timer=null;self.request=null;}
this.on('clicked',clicked1);this.selected=[];if(options.timeout){this.timer=setTimeout(restore1,options.timeout);}}
if(options.range){var sign=options.range[0]<0,step=options.step||1,digits=Math.floor(Math.log10(options.range[1]-options.range[0]+1))+1;if(sign)digits++;var value=options.default||options.value||options.range[0];line='[-] '+Comp.printf.sprintf("%"+digits+"d",value)+' [+] [Ok] [Cancel]';this.prompt='? ';ask(line);var x0=this._clines[offsetY+this.cpos.y].indexOf('[-] ')+4;var x1=this._clines[offsetY+this.cpos.y].indexOf(' [+]')-1;this.cpos.x=x1;this.inputRange.x0=x0;this.inputRange.x1=x1;this.inputRange.right=true;this.inputRange.action=function(){var _value=Number(self._clines[offsetY+self.cpos.y].slice(x0,x1+1));if(_value>=options.range[0]&&_value<=options.range[1]){self.selected=value;restore2();}else{value=options.range[0];line='[-] '+Comp.printf.sprintf("%"+digits+"d",value)+' [+] [Ok] [Cancel]';ask(line);self.inputRange.x0=x0;self.inputRange.x1=x1;self.cpos.x=x1;self._updateCursor();}}
this._updateCursor();actions=[{pos:{x:this._clines[offsetY+this.cpos.y].indexOf('[-]')+1,y:this.cpos.y},action:function(){value=Math.max(options.range[0],value-step);line='[-] '+Comp.printf.sprintf("%"+digits+"d",value)+' [+] [Ok] [Cancel]';ask(line);self.inputRange.x0=x0;self.inputRange.x1=x1;self.cpos.x=x1;self._updateCursor();}},{pos:{x:this._clines[offsetY+this.cpos.y].indexOf('[+]')+1,y:this.cpos.y},action:function(){value=Math.min(options.range[1],value+step);line='[-] '+Comp.printf.sprintf("%"+digits+"d",value)+' [+] [Ok] [Cancel]';ask(line);self.inputRange.x0=x0;self.inputRange.x1=x1;self.cpos.x=x1;self._updateCursor();}},{pos:[{x:this._clines[offsetY+this.cpos.y].indexOf('[Ok]')+1,y:this.cpos.y},{x:this._clines[offsetY+this.cpos.y].indexOf('[Ok]')+2,y:this.cpos.y}],action:function(){var _value=Number(self._clines[offsetY+self.cpos.y].slice(x0,x1+1));if(_value>=options.range[0]&&_value<=options.range[1]){self.selected=value;restore2();}else{value=options.range[0];line='[-] '+Comp.printf.sprintf("%"+digits+"d",value)+' [+] [Ok] [Cancel]';ask(line);self.inputRange.x0=x0;self.inputRange.x1=x1;self.cpos.x=x1;self._updateCursor();}}},{pos:[{x:this._clines[offsetY+this.cpos.y].indexOf('[Cancel]')+1,y:this.cpos.y},{x:this._clines[offsetY+this.cpos.y].indexOf('[Cancel]')+6,y:this.cpos.y}],action:function(){restore2()}}]
function clicked2(pos){var offsetY=self.childBase||0;function within(o){if(typeof o.x!='undefined'){return pos.x==o.x&&pos.y==o.y}else if(o.length==2){if(o[0].y==o[1].y&&o[0].y==pos.y)
return pos.x>=o[0].x&&pos.x<=o[1].x;else if(pos.y>=o[0].y&&pos.y<=o[1].y)
return pos.x>=o[0].x&&pos.x<=o[1].x}}
actions.forEach(function(action){if(!action)return;if(within(action.pos))action.action();})}
function changed2(){var _value=Number(self._clines[offsetY+self.cpos.y].slice(x0,x1+1));if(isNaN(_value)||_value<options.range[0]||_value>options.range[1]){}else value=_value;if(options.timeout){if(self.timer)clearTimeout(self.timer);self.timer=setTimeout(restore2,options.timeout);}}
function restore2(timeout){var result=callback?callback(self.selected):null;if(self.selected!=undefined)self.print(self.selected,self.style.user);if(result)self.print(result);self.prompt=prompt;ask('',!result&&self.selected==undefined);self.removeListener('clicked',clicked2);self.removeListener('modified',changed2);if(!timeout&&self.timer)clearTimeout(self.timer);self.timer=null;self.inputRange.action=null;self.inputRange.right=null;self.request=null;}
this.selected=null;this.on('clicked',clicked2);this.on('modified',changed2);if(options.timeout){this.timer=setTimeout(restore2,options.timeout);}}
if(options.text){this.selected=null;function changed3(){var offsetY=self.childBase||0,vpos=self.getLinearPos(self.value,offsetY+self.inputRange.y0,self.inputRange.x0);self.selected=value=self.value.slice(vpos,1000000);if(options.timeout){if(self.timer)clearTimeout(self.timer);self.timer=setTimeout(restore3,options.timeout);}}
function restore3(timeout){var result=callback?callback(self.selected):null;if(self.selected!=undefined)self.print(self.selected,self.style.user);if(result)self.print(result);self.prompt=prompt;ask('',!result&&self.selected==undefined);self.removeListener('modified',changed3);if(!timeout&&self.timer)clearTimeout(self.timer);self.timer=null;self.inputRange.action=null;self.request=null;}
this.inputRange.action=function(){restore3()}
this.on('modified',changed3);if(options.timeout){this.timer=setTimeout(restore3,options.timeout);}}
this.request={message:message,options:options,callback:callback};}
Chat.prototype.message=function(line,style){return this.print(line,style||this.style.bot);}
Chat.prototype.print=function(line,style){var offsetY=this.childBase||0,cn1=this._clines.length,y0=this.inputRange.y0,start=this.getLinearPos(this.value,offsetY+this.inputRange.y0,0),end=this.getLinearPos(this.value,offsetY+this.inputRange.y1,this._clines[offsetY+this.inputRange.y1].length);if(style){if(style.color)line='{'+style.color+'-fg}'+line+'{/'+style.color+'-fg}';if(style.align=='right')line='{right}'+line+'{/right}';}
var command=this.value.slice(start,end);this.value=this.value.slice(0,start)+line+'\n'+command+this.value.slice(end);this.screen.render();var cn2=this._clines.length;this.scrollBottom();this.cpos.y+=10;this.cpos.x=this.inputRange.x0=this.prompt.length;this._updateCursor(true);this.inputRange.y0=Math.min(this._clines.length-1,this.cpos.y-this.inputRange.last);this.inputRange.y1=Math.min(this._clines.length-1,this.cpos.y);}
Chat.prototype._listener=function(ch,key){var done=this._done,self=this,value=this.value,clinesLength=this._clines.length,offsetY=this.childBase||0,newline=false,lastchar=false,backspace=false,controlkey=false,lastline=(this.cpos.y+offsetY+1)==clinesLength;if(key.name==='return')return;if(key.name==='delete'){if(this.inputRange.x1!=undefined){vpos=this.getLinearPos(this.value,offsetY+this.cpos.y,this.cpos.x);var vpos0=vpos-(this.cpos.x-this.inputRange.x0);this.value=this.value.substr(0,vpos0)+' '+
this.value.substr(vpos0,vpos-vpos0)+
this.value.substr(vpos+1,1000000);this.screen.render();}
return;}
if(key.name==='enter'){if(this.inputRange.action)return this.inputRange.action();var start=this.getLinearPos(this.value,offsetY+this.inputRange.y0,0),end=this.getLinearPos(this.value,offsetY+this.inputRange.y1,this._clines[offsetY+this.inputRange.y1].length);var command=this.value.slice(start+this.prompt.length,end);if(command&&command!=this.history[this.historyTop-1]){this.history.push(command);this.historyTop=this.history.length;}
this.value=this.value.slice(0,start)+this.prompt+this.value.slice(end);this.screen.render();offsetY=this.childBase||0;self.cpos.y+=10;this._updateCursor(true);this.cpos.x=self._clines[offsetY+self.cpos.y].length;this.inputRange.y0=this.inputRange.y1=this.cpos.y;this.inputRange.last=0;this.print(command,this.style.user);this.emit('eval',command);return;}
if(this.input!='text')return;function history(delta){if(self.historyTop+delta<0)return self.scrollBottom();self.historyTop+=delta;var start=self.getLinearPos(self.value,offsetY+self.inputRange.y0,0),end=self.getLinearPos(self.value,offsetY+self.inputRange.y1,self._clines[offsetY+self.inputRange.y1].length);var command=self.history[self.historyTop]||'';self.historyTop=Math.min(Math.max(0,self.historyTop),self.history.length);self.value=self.value.slice(0,start)+self.prompt+command+self.value.slice(end);self.screen.render();self.scrollBottom();self.cpos.x=self._clines[self._clines.length-1].length;self.cpos.y+=10;self._updateCursor(true);self.inputRange.y1=self.cpos.y;offsetY=self.childBase||0;var y0=self.cpos.y;while(self._clines[offsetY+y0].indexOf(self.prompt)!=0)y0--;self.inputRange.y0=y0;self.inputRange.last=self.inputRange.y1-self.inputRange.y0;}
if(this.cursorControl)switch(key.name){case'left':controlkey=true;if(this.cpos.y==this.inputRange.y0&&this.cpos.x>this.inputRange.x0)this.cpos.x--;else if(this.cpos.y!=this.inputRange.y0&&this.cpos.x>0)this.cpos.x--;else if(this.cpos.y!=this.inputRange.y0&&this.cpos.x==0){this.cpos.y--;this.cpos.x=this._clines[offsetY+this.cpos.y].length;}
this._updateCursor(true);break;case'right':controlkey=true;if(this.inputRange.x1!=undefined&&this.cpos.x>=this.inputRange.x1)return;if(this.cpos.y>=this.inputRange.y0&&this.cpos.y<=this.inputRange.y1&&this.cpos.x<this._clines[offsetY+this.cpos.y].length-1){this.cpos.x++;}else if(this.cpos.y>=this.inputRange.y0&&this.cpos.y<this.inputRange.y1&&this.cpos.x==this._clines[offsetY+this.cpos.y].length-1){this.cpos.x=0;this.cpos.y++;}else if(this.cpos.y>=this.inputRange.y0&&this.cpos.y==this.inputRange.y1&&this.cpos.x<this._clines[offsetY+this.cpos.y].length){this.cpos.x++;}
this._updateCursor(true);break;case'up':controlkey=true;history(-1);return;break;case'down':controlkey=true;history(1);return;break;}
if(this.options.keys&&key.ctrl&&key.name==='e'){return this.readEditor();}
if(key.name==='escape'){done(null,null);}else if(key.name==='backspace'){backspace=true;if(this.cpos.y==this.inputRange.y0&&this.cpos.x<=this.inputRange.x0)return;if(this.inputRange.x1!=undefined){vpos=this.getLinearPos(this.value,offsetY+this.cpos.y,this.cpos.x);var vpos0=vpos-(this.cpos.x-this.inputRange.x0);this.value=this.value.substr(0,vpos0)+' '+
this.value.substr(vpos0,vpos-vpos0)+
this.value.substr(vpos+1,1000000);this.screen.render();return;}
if(this.value.length){if(this.screen.fullUnicode){if(unicode.isSurrogate(this.value,this.value.length-2)){this.value=this.value.slice(0,-2);}else{this.value=this.value.slice(0,-1);}}else{if(!this.cursorControl||this.cpos.x==-1||(this.cpos.x==this._clines[offsetY+this.cpos.y].length&&this.cpos.y==this._clines.length-1-offsetY)){this.value=this.value.slice(0,-1);}else{vpos=this.getLinearPos(this.value,offsetY+this.cpos.y,this.cpos.x);this.value=this.value.substr(0,vpos-1)+
this.value.substr(vpos,1000000);}}
if(this.cpos.x>0)this.cpos.x--;else{this.cpos.x=-1;if(offsetY==0&&this.cpos.y>0&&lastline)this.cpos.y--;};}}else if(!controlkey&&ch&&this.inputRange.x1==undefined){if(!/^[\x00-\x08\x0b-\x0c\x0e-\x1f\x7f]$/.test(ch)){if(!this.cursorControl||this.cpos.x==-1||(this.cpos.x==this._clines[offsetY+this.cpos.y].length&&this.cpos.y==this._clines.length-1-offsetY)){lastchar=true;this.value+=ch;}else{vpos=this.getLinearPos(this.value,offsetY+this.cpos.y,this.cpos.x);this.value=this.value.substr(0,vpos)+ch+
this.value.substr(vpos,1000000);}
if(newline){this.cpos.x=0;this.cpos.y++;}else
this.cpos.x++;}}else if(!controlkey&&ch&&this.inputRange.x1!=undefined){if(!/^[\x00-\x08\x0b-\x0c\x0e-\x1f\x7f]$/.test(ch)){vpos=this.getLinearPos(this.value,offsetY+this.cpos.y,this.cpos.x);if(this.cpos.x!=this.inputRange.x1){this.value=setCharAt(this.value,vpos,ch);}else{var vpos0=vpos-(this.inputRange.x1-this.inputRange.x0);this.value=this.value.substr(0,vpos0)+
this.value.substr(vpos0+1,vpos-vpos0)+ch+
this.value.substr(vpos+1,1000000);}
if(this.cpos.x<this.inputRange.x1)this.cpos.x++;}}
var rmline=this.cpos.x==-1;if(this.value!==value){var cn0=clinesLength,endofline=this.cpos.x==this._clines[offsetY+this.cpos.y].length+1,cn1=this._clines.length;var linelength1=this._clines[offsetY+this.cpos.y]&&this._clines[offsetY+this.cpos.y].length;this.screen.render();var linelength2=this._clines[offsetY+this.cpos.y]&&this._clines[offsetY+this.cpos.y].length;var cn2=this._clines.length;if(cn2>cn0&&endofline){this.scrollBottom();this.cpos.y++;this.inputRange.last++;if(this._clines[offsetY+this.cpos.y]&&lastchar)this.cpos.x=this._clines[offsetY+this.cpos.y].length;else this.cpos.x=linelength1-linelength2-1;this._updateCursor(true);this.inputRange.y0=this.cpos.y-this.inputRange.last;this.inputRange.y1=this.cpos.y;}else if(cn2<cn0&&!rmline){if(this.cpos.y>0&&!lastline&&lastchar)this.cpos.y--;this.inputRange.last--;if(this._clines[offsetY+this.cpos.y])this.cpos.x=this._clines[offsetY+this.cpos.y].length;this._updateCursor(true);this.inputRange.y0=this.cpos.y-this.inputRange.last;this.inputRange.y1=this.cpos.y;offsetY=this.childBase||0;this.cpos.x=this._clines[offsetY+this.cpos.y].length;this._updateCursor(true);}else if(linelength2<linelength1&&!backspace){this.cpos.y++;this.cpos.x=linelength1-linelength2;this._updateCursor(true);}
if(offsetY>0&&backspace){this.scroll(0);this.screen.render();if(rmline){if(this._clines[offsetY+this.cpos.y])this.cpos.x=this._clines[offsetY+this.cpos.y].length;else if(this._clines[offsetY+this.cpos.y-1])this.cpos.x=this._clines[offsetY+this.cpos.y-1].length;this._updateCursor(true);}}
this.emit('modified');}};Chat.prototype.getLinearPos=function(v,clineIndex,cposx){var lines=v.split('\n'),line=this._clines[clineIndex],flinenum=this._clines.rtof[clineIndex],vpos=flinenum>0?lines.slice(0,flinenum).map(function(line){return line.length+1}).reduce(function(a,b){return a+b}):0;function search(part,line){var i=line.indexOf(part);if(i==-1)return 0;else return i;}
if(lines[flinenum]){return vpos+search(line,lines[flinenum])+cposx;}else
return vpos+cposx;}
Chat.prototype._typeScroll=function(){var height=this.height-this.iheight;if(this.cpos.y==height){this.scroll(this._clines.length);}};Chat.prototype.getValue=function(){return this.value;};Chat.prototype.setValue=function(value){if(value==null){value=this.value;}
if(this._value!==value){this.value=value;this._value=value;this.setContent(this.value);this._typeScroll();this._updateCursor();}};Chat.prototype.clearInput=Chat.prototype.clearValue=function(){return this.setValue('');};Chat.prototype.submit=function(){if(!this.__listener)return;return this.__listener('\x1b',{name:'escape'});};Chat.prototype.cancel=function(){if(!this.__listener)return;return this.__listener('\x1b',{name:'escape'});};Chat.prototype.render=function(){this.setValue();return this._render();};Chat.prototype.editor=Chat.prototype.setEditor=Chat.prototype.readEditor=function(callback){var self=this;if(this._reading){var _cb=this._callback,cb=callback;this._done('stop');callback=function(err,value){if(_cb)_cb(err,value);if(cb)cb(err,value);};}
if(!callback){callback=function(){};}
return this.screen.readEditor({value:this.value},function(err,value){if(err){if(err.message==='Unsuccessful.'){self.screen.render();return self.readInput(callback);}
self.screen.render();self.readInput(callback);return callback(err);}
self.setValue(value);self.screen.render();return self.readInput(callback);});};module.exports=Chat;};BundleModuleCode['term/widgets/text']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Element=Require('term/widgets/element');function Text(options){if(!instanceOf(this,Node)){return new Text(options);}
options=options||{};options.shrink=true;Element.call(this,options);}
inheritPrototype(Text,Element);Text.prototype.type='text';module.exports=Text;};BundleModuleCode['term/widgets/line']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function Line(options){if(!instanceOf(this,Node)){return new Line(options);}
options=options||{};var orientation=options.orientation||'vertical';delete options.orientation;if(orientation==='vertical'){options.width=1;}else{options.height=1;}
Box.call(this,options);this.ch=!options.type||options.type==='line'?orientation==='horizontal'?'':'':options.ch||' ';this.border={type:'bg',__proto__:this};this.style.border=this.style;}
inheritPrototype(Line,Box);Line.prototype.type='line';module.exports=Line;};BundleModuleCode['term/widgets/bigtext']=function(module,exports){var Comp=Require('com/compat');var fs=require('fs');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function BigText(options){if(!instanceOf(this instanceof Node)){return new BigText(options);}
options=options||{};options.font=options.font||__dirname+'/../../usr/fonts/ter-u14n.json';options.fontBold=options.font||__dirname+'/../../usr/fonts/ter-u14b.json';this.fch=options.fch;this.ratio={};this.font=this.loadFont(options.font);this.fontBold=this.loadFont(options.font);Box.call(this,options);if(this.style.bold){this.font=this.fontBold;}}
inheritPrototype(BigText,Box);BigText.prototype.type='bigtext';BigText.prototype.loadFont=function(filename){var self=this,data,font;data=JSON.parse(fs.readFileSync(filename,'utf8'));this.ratio.width=data.width;this.ratio.height=data.height;function convertLetter(ch,lines){var line,i;while(lines.length>self.ratio.height){lines.shift();lines.pop();}
lines=lines.map(function(line){var chs=line.split('');chs=chs.map(function(ch){return ch===' '?0:1;});while(chs.length<self.ratio.width){chs.push(0);}
return chs;});while(lines.length<self.ratio.height){line=[];for(i=0;i<self.ratio.width;i++){line.push(0);}
lines.push(line);}
return lines;}
font=Object.keys(data.glyphs).reduce(function(out,ch){var lines=data.glyphs[ch].map;out[ch]=convertLetter(ch,lines);return out;},{});delete font[' '];return font;};BigText.prototype.setContent=function(content){this.content='';this.text=content||'';};BigText.prototype.render=function(){if(this.position.width==null||this._shrinkWidth){this.position.width=this.ratio.width*this.text.length+1;this._shrinkWidth=true;}
if(this.position.height==null||this._shrinkHeight){this.position.height=this.ratio.height+0;this._shrinkHeight=true;}
var coords=this._render();if(!coords)return;var lines=this.screen.lines,left=coords.xi+this.ileft,top=coords.yi+this.itop,right=coords.xl-this.iright,bottom=coords.yl-this.ibottom;var dattr=this.sattr(this.style),bg=dattr&0x1ff,fg=(dattr>>9)&0x1ff,flags=(dattr>>18)&0x1ff,attr=(flags<<18)|(bg<<9)|fg;for(var x=left,i=0;x<right;x+=this.ratio.width,i++){var ch=this.text[i];if(!ch)break;var map=this.font[ch];if(!map)continue;for(var y=top;y<Math.min(bottom,top+this.ratio.height);y++){if(!lines[y])continue;var mline=map[y-top];if(!mline)continue;for(var mx=0;mx<this.ratio.width;mx++){var mcell=mline[mx];if(mcell==null)break;if(this.fch&&this.fch!==' '){lines[y][x+mx][0]=dattr;lines[y][x+mx][1]=mcell===1?this.fch:this.ch;}else{lines[y][x+mx][0]=mcell===1?attr:dattr;lines[y][x+mx][1]=mcell===1?' ':this.ch;}}
lines[y].dirty=true;}}
return coords;};module.exports=BigText;};BundleModuleCode['term/widgets/list']=function(module,exports){var Comp=Require('com/compat');var Io=Require('com/io');var helpers=Require('term/helpers');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var Button=Require('term/widgets/button');var Arrows=Require('term/widgets/arrows');function List(options){var self=this;if(!instanceOf(this,Node)){return new List(options);}
options=options||{};options.ignoreKeys=true;options.scrollable=true;Box.call(this,options);this.value='';this.items=[];this.ritems=[];this.selected=0;this._isList=true;if(!this.style.selected){this.style.selected={};this.style.selected.bg=options.selectedBg;this.style.selected.fg=options.selectedFg;this.style.selected.bold=options.selectedBold;this.style.selected.underline=options.selectedUnderline;this.style.selected.blink=options.selectedBlink;this.style.selected.inverse=options.selectedInverse;this.style.selected.invisible=options.selectedInvisible;}
if(!this.style.item){this.style.item={};this.style.item.bg=options.itemBg;this.style.item.fg=options.itemFg;this.style.item.bold=options.itemBold;this.style.item.underline=options.itemUnderline;this.style.item.blink=options.itemBlink;this.style.item.inverse=options.itemInverse;this.style.item.invisible=options.itemInvisible;}
['bg','fg','bold','underline','blink','inverse','invisible'].forEach(function(name){if(self.style[name]!=null&&self.style.item[name]==null){self.style.item[name]=self.style[name];}});if(this.options.itemHoverBg){this.options.itemHoverEffects={bg:this.options.itemHoverBg};}
if(this.options.itemHoverEffects){this.style.item.hover=this.options.itemHoverEffects;}
if(this.options.itemFocusEffects){this.style.item.focus=this.options.itemFocusEffects;}
this.interactive=options.interactive!==false;this.mouse=options.mouse||false;if(options.items){this.ritems=options.items;options.items.forEach(this.add.bind(this));}
this.select(0);if(options.mouse){this.screen._listenMouse(this);this.on('element wheeldown',function(){self.select(self.selected+2);self.screen.render();});this.on('element wheelup',function(){self.select(self.selected-2);self.screen.render();});}
if(options.keys){this.on('keypress',function(ch,key){if(key.name==='up'||(options.vi&&key.name==='k')){self.up();self.screen.render();self.emit('selected',self.items[self.selected]);return;}
if(key.name==='down'||(options.vi&&key.name==='j')){self.down();self.screen.render();self.emit('selected',self.items[self.selected]);return;}
if(key.name==='enter'||(options.vi&&key.name==='l'&&!key.shift)){self.enterSelected();return;}
if(key.name==='escape'||(options.vi&&key.name==='q')){self.cancelSelected();return;}
if(options.vi&&key.name==='u'&&key.ctrl){self.move(-((self.height-self.iheight)/2)|0);self.screen.render();return;}
if(options.vi&&key.name==='d'&&key.ctrl){self.move((self.height-self.iheight)/2|0);self.screen.render();return;}
if(options.vi&&key.name==='b'&&key.ctrl){self.move(-(self.height-self.iheight));self.screen.render();return;}
if(options.vi&&key.name==='f'&&key.ctrl){self.move(self.height-self.iheight);self.screen.render();return;}
if(options.vi&&key.name==='h'&&key.shift){self.move(self.childBase-self.selected);self.screen.render();return;}
if(options.vi&&key.name==='m'&&key.shift){var visible=Math.min(self.height-self.iheight,self.items.length)/2|0;self.move(self.childBase+visible-self.selected);self.screen.render();return;}
if(options.vi&&key.name==='l'&&key.shift){self.down(self.childBase
+Math.min(self.height-self.iheight,self.items.length)
-self.selected);self.screen.render();return;}
if(options.vi&&key.name==='g'&&!key.shift){self.select(0);self.screen.render();return;}
if(options.vi&&key.name==='g'&&key.shift){self.select(self.items.length-1);self.screen.render();return;}
if(options.vi&&(key.ch==='/'||key.ch==='?')){if(typeof self.options.search!=='function'){return;}
return self.options.search(function(err,value){if(typeof err==='string'||typeof err==='function'||typeof err==='number'||(err&&err.test)){value=err;err=null;}
if(err||!value)return self.screen.render();self.select(self.fuzzyFind(value,key.ch==='?'));self.screen.render();});}});}
this.on('resize',function(){var visible=self.height-self.iheight;if(visible>=self.selected+1){self.childBase=0;self.childOffset=self.selected;}else{self.childBase=self.selected-visible+1;self.childOffset=visible-1;}});this.on('adopt',function(el){if(!~self.items.indexOf(el)){el.fixed=true;}});this.on('remove',function(el){self.removeItem(el);});if(options.arrows)
Arrows(self,options,function(){self.select(self.selected-2);self.screen.render()},function(){self.select(self.selected+2);self.screen.render()});}
inheritPrototype(List,Box);List.prototype.type='list';List.prototype.createItem=function(content){var self=this;var options={screen:this.screen,content:content,align:this.align||'left',top:0,left:0,right:(this.scrollbar?1:0),tags:this.parseTags,height:1,hoverEffects:this.mouse?this.style.item.hover:null,focusEffects:this.mouse?this.style.item.focus:null,autoFocus:false};if(!this.screen.autoPadding){options.top=1;options.left=this.ileft;options.right=this.iright+(this.scrollbar?1:0);}
if(this.shrink&&this.options.normalShrink){delete options.right;options.width='shrink';}
['bg','fg','bold','underline','blink','inverse','invisible'].forEach(function(name){options[name]=function(){var attr=self.items[self.selected]===item&&self.interactive?self.style.selected[name]:self.style.item[name];if(typeof attr==='function')attr=attr(item);return attr;};});if(this.style.transparent){options.transparent=true;}
var item=new Box(options);if(this.mouse){item.on('click',function(){self.focus();if(self.items[self.selected]===item){self.emit('action',item,self.selected);self.emit('select',item,self.selected);return;}
self.select(item);self.emit('selected',self.items[self.selected]);self.screen.render();});}
this.emit('create item');return item;};List.prototype.add=List.prototype.addItem=List.prototype.appendItem=function(content){content=typeof content==='string'?content:content.getContent();var item=this.createItem(content);item.position.top=this.items.length;if(!this.screen.autoPadding){item.position.top=this.itop+this.items.length;}
this.ritems.push(content);this.items.push(item);this.append(item);if(this.items.length===1){this.select(0);}
this.emit('add item');return item;};List.prototype.removeItem=function(child){var i=this.getItemIndex(child);if(~i&&this.items[i]){child=this.items.splice(i,1)[0];this.ritems.splice(i,1);this.remove(child);for(var j=i;j<this.items.length;j++){this.items[j].position.top--;}
if(i===this.selected){this.select(i-1);}}
this.emit('remove item');return child;};List.prototype.insertItem=function(child,content){content=typeof content==='string'?content:content.getContent();var i=this.getItemIndex(child);if(!~i)return;if(i>=this.items.length)return this.appendItem(content);var item=this.createItem(content);for(var j=i;j<this.items.length;j++){this.items[j].position.top++;}
item.position.top=i+(!this.screen.autoPadding?1:0);this.ritems.splice(i,0,content);this.items.splice(i,0,item);this.append(item);if(i===this.selected){this.select(i+1);}
this.emit('insert item');};List.prototype.getItem=function(child){return this.items[this.getItemIndex(child)];};List.prototype.setItem=function(child,content){content=typeof content==='string'?content:content.getContent();var i=this.getItemIndex(child);if(!~i)return;this.items[i].setContent(content);this.ritems[i]=content;};List.prototype.clearItems=function(){return this.setItems([]);};List.prototype.setItems=function(items){var original=this.items.slice(),selected=this.selected,sel=this.ritems[this.selected],i=0;items=items.slice();this.select(0);for(;i<items.length;i++){if(this.items[i]){this.items[i].setContent(items[i]);}else{this.add(items[i]);}}
for(;i<original.length;i++){this.remove(original[i]);}
this.ritems=items;sel=items.indexOf(sel);if(this.options.selectlast)this.select(selected);if(items.length===original.length){this.select(selected);}else{this.select(Math.min(selected,items.length-1));}
this.emit('set items');};List.prototype.pushItem=function(content){this.appendItem(content);return this.items.length;};List.prototype.popItem=function(){return this.removeItem(this.items.length-1);};List.prototype.unshiftItem=function(content){this.insertItem(0,content);return this.items.length;};List.prototype.shiftItem=function(){return this.removeItem(0);};List.prototype.spliceItem=function(child,n){var self=this;var i=this.getItemIndex(child);if(!~i)return;var items=Array.prototype.slice.call(arguments,2);var removed=[];while(n--){removed.push(this.removeItem(i));}
items.forEach(function(item){self.insertItem(i++,item);});return removed;};List.prototype.find=List.prototype.fuzzyFind=function(search,back){var start=this.selected+(back?-1:1),i;if(typeof search==='number')search+='';if(search&&search[0]==='/'&&search[search.length-1]==='/'){try{search=new RegExp(search.slice(1,-1));}catch(e){;}}
var test=typeof search==='string'?function(item){return!!~item.indexOf(search);}:(search.test?search.test.bind(search):search);if(typeof test!=='function'){if(this.screen.options.debug){throw new Error('fuzzyFind(): `test` is not a function.');}
return this.selected;}
if(!back){for(i=start;i<this.ritems.length;i++){if(test(helpers.cleanTags(this.ritems[i])))return i;}
for(i=0;i<start;i++){if(test(helpers.cleanTags(this.ritems[i])))return i;}}else{for(i=start;i>=0;i--){if(test(helpers.cleanTags(this.ritems[i])))return i;}
for(i=this.ritems.length-1;i>start;i--){if(test(helpers.cleanTags(this.ritems[i])))return i;}}
return this.selected;};List.prototype.getItemIndex=function(child){if(typeof child==='number'){return child;}else if(typeof child==='string'){var i=this.ritems.indexOf(child);if(~i)return i;for(i=0;i<this.ritems.length;i++){if(helpers.cleanTags(this.ritems[i])===child){return i;}}
return-1;}else{return this.items.indexOf(child);}};List.prototype.getSelected=function(){return this.items[this.selected];}
List.prototype.select=function(index){var lastindex=this.selected;if(!this.interactive){return;}
if(!this.items.length){this.selected=0;this.value='';this.scrollTo(0);return;}
if(typeof index==='object'){index=this.items.indexOf(index);}
if(index<0){index=0;}else if(index>=this.items.length){index=this.items.length-1;}
if(this.selected===index&&this._listInitialized)return;this._listInitialized=true;this.selected=index;this.value=helpers.cleanTags(this.ritems[this.selected]);if(!this.parent)return;if(index>=lastindex)
this.scrollTo(this.selected+(this.options.selectoffset||0));else
this.scrollTo(this.selected);this.emit('select item',this.items[this.selected],this.selected);};List.prototype.move=function(offset){this.select(this.selected+offset);};List.prototype.up=function(offset){this.move(-(offset||1));};List.prototype.down=function(offset){this.move(offset||1);};List.prototype.pick=function(label,callback){if(!callback){callback=label;label=null;}
if(!this.interactive){return callback();}
var self=this;var focused=this.screen.focused;if(focused&&focused._done)focused._done('stop');this.screen.saveFocus();this.focus();this.show();this.select(0);if(label)this.setLabel(label);this.screen.render();this.once('action',function(el,selected){if(label)self.removeLabel();self.screen.restoreFocus();self.hide();self.screen.render();if(!el)return callback();return callback(null,helpers.cleanTags(self.ritems[selected]));});};List.prototype.enterSelected=function(i){if(i!=null)this.select(i);this.emit('action',this.items[this.selected],this.selected);this.emit('select',this.items[this.selected],this.selected);};List.prototype.cancelSelected=function(i){if(i!=null)this.select(i);this.emit('action');this.emit('cancel');};module.exports=List;};BundleModuleCode['term/widgets/form']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function Form(options){var self=this;if(!instanceOf(this,Node)){return new Form(options);}
options=options||{};options.ignoreKeys=true;Box.call(this,options);if(options.keys){this.screen._listenKeys(this);this.on('element keypress',function(el,ch,key){if((key.name==='tab'&&!key.shift)||(el.type==='textbox'&&options.autoNext&&key.name==='enter')||key.name==='down'||(options.vi&&key.name==='j')){if(el.type==='textbox'||el.type==='textarea'){if(key.name==='j')return;if(key.name==='tab'){el.emit('keypress',null,{name:'backspace'});}
el.emit('keypress','\x1b',{name:'escape'});}
self.focusNext();return;}
if((key.name==='tab'&&key.shift)||key.name==='up'||(options.vi&&key.name==='k')){if(el.type==='textbox'||el.type==='textarea'){if(key.name==='k')return;el.emit('keypress','\x1b',{name:'escape'});}
self.focusPrevious();return;}
if(key.name==='escape'){self.focus();return;}});}}
inheritPrototype(Form,Box),Form.prototype.type='form';Form.prototype._refresh=function(){if(!this._children){var out=[];this.children.forEach(function fn(el){if(el.keyable)out.push(el);el.children.forEach(fn);});this._children=out;}};Form.prototype._visible=function(){return!!this._children.filter(function(el){return el.visible;}).length;};Form.prototype.next=function(){this._refresh();if(!this._visible())return;if(!this._selected){this._selected=this._children[0];if(!this._selected.visible)return this.next();if(this.screen.focused!==this._selected)return this._selected;}
var i=this._children.indexOf(this._selected);if(!~i||!this._children[i+1]){this._selected=this._children[0];if(!this._selected.visible)return this.next();return this._selected;}
this._selected=this._children[i+1];if(!this._selected.visible)return this.next();return this._selected;};Form.prototype.previous=function(){this._refresh();if(!this._visible())return;if(!this._selected){this._selected=this._children[this._children.length-1];if(!this._selected.visible)return this.previous();if(this.screen.focused!==this._selected)return this._selected;}
var i=this._children.indexOf(this._selected);if(!~i||!this._children[i-1]){this._selected=this._children[this._children.length-1];if(!this._selected.visible)return this.previous();return this._selected;}
this._selected=this._children[i-1];if(!this._selected.visible)return this.previous();return this._selected;};Form.prototype.focusNext=function(){var next=this.next();if(next)next.focus();};Form.prototype.focusPrevious=function(){var previous=this.previous();if(previous)previous.focus();};Form.prototype.resetSelected=function(){this._selected=null;};Form.prototype.focusFirst=function(){this.resetSelected();this.focusNext();};Form.prototype.focusLast=function(){this.resetSelected();this.focusPrevious();};Form.prototype.submit=function(){var out={};this.children.forEach(function fn(el){if(el.value!=null){var name=el.name||el.type;if(Array.isArray(out[name])){out[name].push(el.value);}else if(out[name]){out[name]=[out[name],el.value];}else{out[name]=el.value;}}
el.children.forEach(fn);});this.emit('submit',out);return this.submission=out;};Form.prototype.cancel=function(){this.emit('cancel');};Form.prototype.reset=function(){this.children.forEach(function fn(el){switch(el.type){case'screen':break;case'box':break;case'text':break;case'line':break;case'scrollable-box':break;case'list':el.select(0);return;case'form':break;case'input':break;case'textbox':el.clearInput();return;case'textarea':el.clearInput();return;case'button':delete el.value;break;case'progress-bar':el.setProgress(0);break;case'file-manager':el.refresh(el.options.cwd);return;case'checkbox':el.uncheck();return;case'radio-set':break;case'radio-button':el.uncheck();return;case'prompt':break;case'question':break;case'message':break;case'info':break;case'loading':break;case'list-bar':break;case'dir-manager':el.refresh(el.options.cwd);return;case'terminal':el.write('');return;case'image':return;}
el.children.forEach(fn);});this.emit('reset');};module.exports=Form;};BundleModuleCode['term/widgets/textarea']=function(module,exports){var Comp=Require('com/compat');var unicode=Require('term/unicode');var nextTick=global.setImmediate||process.nextTick.bind(process);var Node=Require('term/widgets/node');var Input=Require('term/widgets/input');function Textarea(options){var self=this;if(!instanceOf(this,Node)){return new Textarea(options);}
options=options||{};options.scrollable=options.scrollable!==false;Input.call(this,options);this.screen._listenKeys(this);this.value=options.value||'';this.cpos={x:-1,y:-1};this.cursorControl=true;this.multiline=options.multiline;this.__updateCursor=this._updateCursor.bind(this);this.on('resize',this.__updateCursor);this.on('move',this.__updateCursor);if(options.inputOnFocus){this.on('focus',this.readInput.bind(this,null));}
if(!options.inputOnFocus&&options.keys){this.on('keypress',function(ch,key){if(self._reading)return;if(key.name==='enter'||(options.vi&&key.name==='i')){return self.readInput();}
if(key.name==='e'){return self.readEditor();}});}
if(options.mouse){this.on('click',function(data){if(self._reading)return;if(data.button!=='right')return;self.readEditor();});}}
inheritPrototype(Textarea,Input);Textarea.prototype.type='textarea';Textarea.prototype._updateCursor=function(get){if(this.screen.focused!==this){return;}
var lpos=get?this.lpos:this._getCoords();if(!lpos)return;var last=this._clines[this._clines.length-1],program=this.screen.program,line,offsetY=this.childBase||0,cx,cy;if(last===''&&this.value[this.value.length-1]!=='\n'){last=this._clines[this._clines.length-2]||'';}
line=Math.min(this._clines.length-1-(this.childBase||0),(lpos.yl-lpos.yi)-this.iheight-1);line=Math.max(0,line);if(this.cpos.x==-1||!this.cursorControl)this.cpos.x=this.strWidth(last);if(this.cpos.y==-1||!this.cursorControl)this.cpos.y=line;this.cpos.y=Math.min(this.cpos.y,line);this.cpos.x=Math.min(this.cpos.x,this.strWidth(this._clines[offsetY+this.cpos.y]));cx=lpos.xi+this.ileft+this.cpos.x;cy=lpos.yi+this.itop+this.cpos.y;if(cy===program.y&&cx===program.x){return;}
if(cy===program.y){if(cx>program.x){program.cuf(cx-program.x);}else if(cx<program.x){program.cub(program.x-cx);}}else if(cx===program.x){if(cy>program.y){program.cud(cy-program.y);}else if(cy<program.y){program.cuu(program.y-cy);}}else{program.cup(cy,cx);}};Textarea.prototype.input=Textarea.prototype.setInput=Textarea.prototype.readInput=function(callback){var self=this,focused=this.screen.focused===this;if(this._reading)return;this._reading=true;this._callback=callback;if(!focused){this.screen.saveFocus();this.focus();}
this.screen.grabKeys=true;this._updateCursor();this.screen.program.showCursor();this._done=function fn(err,value){if(!self._reading)return;if(fn.done)return;fn.done=true;delete self._callback;delete self._done;self.removeListener('keypress',self.__listener);delete self.__listener;self.removeListener('blur',self.__done);delete self.__done;self.screen.program.hideCursor();self.screen.grabKeys=false;if(!focused){self.screen.restoreFocus();}
if(self.options.inputOnFocus){self.screen.rewindFocus();}
self._reading=false;if(err==='stop')return;if(err){self.emit('error',err);}else if(value!=null){self.emit('submit',value);}else{self.emit('cancel',value);}
self.emit('action',value);if(!callback)return;return err?callback(err):callback(null,value);};nextTick(function(){if(self.__listener){return;}
self.__listener=self._listener.bind(self);self.on('keypress',self.__listener);});this.__done=this._done.bind(this,null,null);this.on('blur',this.__done);};Textarea.prototype._listener=function(ch,key){var done=this._done,self=this,value=this.value,clinesLength=this._clines.length,offsetY=this.childBase||0,newline=false,backspace=false,lastline=(this.cpos.y+offsetY+1)==clinesLength;if(key.name=='linefeed'||(!this.multiline&&key.name=='enter'))return this.emit('enter',this.value);if(key.name==='return')return;if(key.name==='enter'){ch='\n';newline=true;}
if(this.cursorControl)switch(key.name){case'left':if(this.cpos.x>0)this.cpos.x--;else{if(this.cpos.y>0){this.cpos.y--;this.cpos.x=this._clines[offsetY+this.cpos.y].length;}else if(offsetY>0){if(this.scrollable)this.scroll(-1);self.screen.render();this.cpos.x=this._clines[offsetY+this.cpos.y-1].length;}}
this._updateCursor(true);break;case'right':var next=++this.cpos.x;this._updateCursor(true);if(this.cpos.x!=next&&(offsetY+this.cpos.y+1)<this._clines.length){next=++this.cpos.y;this.cpos.x=0;this._updateCursor(true);if(this.scrollable&&this.cpos.y!=next)this.scroll(1);}
break;case'up':if(this.cpos.y>0){this.cpos.y--;}
this._updateCursor(true);break;case'down':this.cpos.y++;this._updateCursor(true);break;}
if(this.options.keys&&key.ctrl&&key.name==='e'){return this.readEditor();}
if(key.name==='escape'){done(null,null);}else if(key.name==='backspace'){backspace=true;if(this.value.length){if(this.screen.fullUnicode){if(unicode.isSurrogate(this.value,this.value.length-2)){this.value=this.value.slice(0,-2);}else{this.value=this.value.slice(0,-1);}}else{if(!this.cursorControl||this.cpos.x==-1||(this.cpos.x==this._clines[offsetY+this.cpos.y].length&&this.cpos.y==this._clines.length-1-offsetY)){this.value=this.value.slice(0,-1);}else{vpos=this.getLinearPos(this.value,offsetY+this.cpos.y,this.cpos.x);this.value=this.value.substr(0,vpos-1)+
this.value.substr(vpos,1000000);}}
if(this.cpos.x>0)this.cpos.x--;else{this.cpos.x=-1;if(offsetY==0&&this.cpos.y>0&&lastline)this.cpos.y--;};}}else if(ch){if(!/^[\x00-\x08\x0b-\x0c\x0e-\x1f\x7f]$/.test(ch)){if(!this.cursorControl||this.cpos.x==-1||(this.cpos.x==this._clines[offsetY+this.cpos.y].length&&this.cpos.y==this._clines.length-1-offsetY))
this.value+=ch;else{vpos=this.getLinearPos(this.value,offsetY+this.cpos.y,this.cpos.x);this.value=this.value.substr(0,vpos)+ch+
this.value.substr(vpos,1000000);}
if(newline){this.cpos.x=0;this.cpos.y++;}else
this.cpos.x++;}}
var rmline=this.cpos.x==-1;if(this.value!==value){var cn0=clinesLength,cn1=this._clines.length,y0=this.cpos.y,linelength=this._clines[offsetY+this.cpos.y]&&this._clines[offsetY+this.cpos.y].length,endofline=this.cpos.x==linelength+1;this.screen.render();var cn2=this._clines.length;if(!newline&&endofline&&cn2>cn0){if(this.scrollable&&lastline)this.scrollBottom();this.cpos.y++;this._updateCursor(true);if(this._clines[offsetY+this.cpos.y])this.cpos.x=this._clines[offsetY+this.cpos.y].length;this._updateCursor(true);}else if(cn2<cn0&&!rmline){if(this.cpos.y>0&&!lastline&&endofline)this.cpos.y--;this._updateCursor(true);offsetY=this.childBase||0;if(this._clines[offsetY+this.cpos.y])this.cpos.x=this._clines[offsetY+this.cpos.y].length;this._updateCursor(true);}else if(cn2<cn0&&!rmline&&this.cpos.x==0){if(this._clines[offsetY+this.cpos.y])this.cpos.x=this._clines[offsetY+this.cpos.y].length;this._updateCursor(true);};if(offsetY>0&&backspace){if(this.scrollable)this.scroll(0);this.screen.render();if(rmline&&cn0!=cn2){if(this._clines[offsetY+this.cpos.y])this.cpos.x=this._clines[offsetY+this.cpos.y].length;else if(this._clines[offsetY+this.cpos.y-1])this.cpos.x=this._clines[offsetY+this.cpos.y-1].length;this._updateCursor(true);}}}};Textarea.prototype.getLinearPos=function(v,clineIndex,cposx){var vpos=0,len=v.length,cline,clinePos=0,clineNum=0;cline=this._clines[clineNum];while(vpos<len&&clineIndex){if(v.charAt(vpos)=='\n'){clinePos=-1;clineIndex--;clineNum++;cline=this._clines[clineNum];}else{if(v.charAt(vpos)!=cline.charAt(clinePos)){clinePos=0;clineIndex--;clineNum++;cline=this._clines[clineNum];continue;}}
vpos++;clinePos++;}
if(clineIndex==0)return vpos+cposx;else 0}
Textarea.prototype._typeScroll=function(){var height=this.height-this.iheight;if(this.cpos.y==height){if(this.scrollable)this.scroll(this._clines.length);}};Textarea.prototype.getValue=function(){return this.value;};Textarea.prototype.setValue=function(value){if(value==null){value=this.value;}
if(this._value!==value){this.value=value;this._value=value;this.setContent(this.value);this._typeScroll();this._updateCursor();}};Textarea.prototype.clearInput=Textarea.prototype.clearValue=function(){return this.setValue('');};Textarea.prototype.submit=function(){if(!this.__listener)return;return this.__listener('\x1b',{name:'escape'});};Textarea.prototype.cancel=function(){if(!this.__listener)return;return this.__listener('\x1b',{name:'escape'});};Textarea.prototype.render=function(){this.setValue();return this._render();};Textarea.prototype.editor=Textarea.prototype.setEditor=Textarea.prototype.readEditor=function(callback){var self=this;if(this._reading){var _cb=this._callback,cb=callback;this._done('stop');callback=function(err,value){if(_cb)_cb(err,value);if(cb)cb(err,value);};}
if(!callback){callback=function(){};}
return this.screen.readEditor({value:this.value},function(err,value){if(err){if(err.message==='Unsuccessful.'){self.screen.render();return self.readInput(callback);}
self.screen.render();self.readInput(callback);return callback(err);}
self.setValue(value);self.screen.render();return self.readInput(callback);});};module.exports=Textarea;};BundleModuleCode['term/widgets/textbox']=function(module,exports){var options={version:'1.5.2'}
var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Textarea=Require('term/widgets/textarea');function Textbox(options){if(!instanceOf(this,Node)){return new Textbox(options);}
options=options||{};options.scrollable=options.scrollable||false;Textarea.call(this,options);this.secret=options.secret;this.censor=options.censor;this.wrap=options.wrap;this.multiline=options.multiline;}
inheritPrototype(Textbox,Textarea);Textbox.prototype.type='textbox';Textbox.prototype.__olistener=Textbox.prototype._listener;Textbox.prototype._listener=function(ch,key){if(!this.multiline&&key.name==='enter'){this.emit('enter',this.value);this._done(null,this.value);return;}
return this.__olistener(ch,key);};Textbox.prototype.setValue=function(value){var visible,val,i,line,sep;if(value==null){value=this.value;}
if(this._value!==value){if(!this.multiline){value=value.replace(/\n/g,'');}
this.value=value;this._value=value;if(this.secret){this.setContent('');}else if(this.censor){this.setContent(Array(this.value.length+1).join('*'));}else if(this.wrap&&this.value.length>(this.width-this.iwidth-1)){line='';i=0,sep='';visible=this.width-this.iwidth-1;val=this.value;while(val.length>0){line=line+val.substr(0,visible);val=val.substr(visible,val.length-visible);sep='\n';}
this.setContent(line);}else if(this.multiline){val=this.value.replace(/\t/g,this.screen.tabc);this.setContent(val);}else{visible=-(this.width-this.iwidth-1);val=this.value.replace(/\t/g,this.screen.tabc);this.setContent(val.slice(visible));}
this._updateCursor();}};Textbox.prototype.update=function(value){this.setValue(value);this.screen.render();}
Textbox.prototype.submit=function(){if(!this.__listener)return;return this.__listener('\r',{name:'enter'});};module.exports=Textbox;};BundleModuleCode['term/widgets/progressbar']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Input=Require('term/widgets/input');function ProgressBar(options){var self=this;if(!instanceOf(this,Node)){return new ProgressBar(options);}
options=options||{};Input.call(this,options);this.filled=options.filled||0;if(typeof this.filled==='string'){this.filled=+this.filled.slice(0,-1);}
this.value=this.filled;this.pch=options.pch||' ';if(options.ch){this.pch=options.ch;this.ch=' ';}
if(options.bch){this.ch=options.bch;}
if(!this.style.bar){this.style.bar={};this.style.bar.fg=options.barFg;this.style.bar.bg=options.barBg;}
this.orientation=options.orientation||'horizontal';if(options.keys){this.on('keypress',function(ch,key){var back,forward;if(self.orientation==='horizontal'){back=['left','h'];forward=['right','l'];}else if(self.orientation==='vertical'){back=['down','j'];forward=['up','k'];}
if(key.name===back[0]||(options.vi&&key.name===back[1])){self.progress(-5);self.screen.render();return;}
if(key.name===forward[0]||(options.vi&&key.name===forward[1])){self.progress(5);self.screen.render();return;}});}
if(options.mouse){this.on('click',function(data){var x,y,m,p;if(!self.lpos)return;if(self.orientation==='horizontal'){x=data.x-self.lpos.xi;m=(self.lpos.xl-self.lpos.xi)-self.iwidth;p=x/m*100|0;}else if(self.orientation==='vertical'){y=data.y-self.lpos.yi;m=(self.lpos.yl-self.lpos.yi)-self.iheight;p=y/m*100|0;}
self.setProgress(p);});}}
inheritPrototype(ProgressBar,Input);ProgressBar.prototype.type='progress-bar';ProgressBar.prototype.render=function(){var ret=this._render();if(!ret)return;var xi=ret.xi,xl=ret.xl,yi=ret.yi,yl=ret.yl,dattr;if(this.border)xi++,yi++,xl--,yl--;if(this.orientation==='horizontal'){xl=xi+((xl-xi)*(this.filled/100))|0;}else if(this.orientation==='vertical'){yi=yi+((yl-yi)-(((yl-yi)*(this.filled/100))|0));}
dattr=this.sattr(this.style.bar);this.screen.fillRegion(dattr,this.pch,xi,xl,yi,yl);if(this.content){var line=this.screen.lines[yi];for(var i=0;i<this.content.length;i++){line[xi+i][1]=this.content[i];}
line.dirty=true;}
return ret;};ProgressBar.prototype.progress=function(filled){this.filled+=filled;if(this.filled<0)this.filled=0;else if(this.filled>100)this.filled=100;if(this.filled===100){this.emit('complete');}
this.value=this.filled;};ProgressBar.prototype.setProgress=function(filled){this.filled=0;this.progress(filled);};ProgressBar.prototype.reset=function(){this.emit('reset');this.filled=0;this.value=this.filled;};module.exports=ProgressBar;};BundleModuleCode['term/widgets/filemanager']=function(module,exports){var options={version:'1.4.2'}
var Comp=Require('com/compat');var path=Require('path'),fs=Require('fs');var Node=Require('term/widgets/node');var List=Require('term/widgets/list');var Button=Require('term/widgets/button');var Helpers=Require('term/helpers');var Box=Require('term/widgets/box');var TextBox=Require('term/widgets/textbox');var Arrows=Require('term/widgets/arrows');var Screen=Require('term/widgets/screen');function FileManager(options){var self=this,bbox,off1=0,off2=0,arrows=options.arrows;if(!instanceOf(this,Node)){return new FileManager(options);}
options=options||{};options.parseTags=true;options.mouse=true;options.arrows=_;if(options.parent==Screen.global){bbox=Helpers.bbox(Screen.global,options);if(options.box)bbox.top+=1,bbox.height-=2,bbox.width-=4,bbox.left+=2;if(options.input)bbox.height-=3;if(options.cancelButton||options.okayButton)bbox.height-=1;if(arrows)bbox.width-=4,bbox.left+=2;options.top=bbox.top;options.left=bbox.left;options.height=bbox.height;options.width=bbox.width;}
List.call(this,options);options.arrows=arrows;this.cwd=options.cwd||process.cwd();this.file=this.cwd;this.value=this.cwd;this.noshow=options.noshow;if(options.parent==this.screen){this._clickable=this.screen.clickable;this.screen.clickable=[];bbox=Helpers.bbox(this.screen,options);if(options.cancelButton||options.okayButton)off1=2;if(options.input)off2=3;if(options.box)
this._.box=new Box({top:bbox.top-2,width:bbox.width+8,left:bbox.left-4,height:bbox.height+3+off1+off2,hidden:options.hidden,border:options.box.border,style:{label:options.label,fg:options.box.fg,bg:options.box.bg||'white'}});if(this._.box)this.screen.append(this._.box);if(options.input){this._.input=new TextBox({screen:this.screen,top:bbox.top+bbox.height+(options.box?1:0)-1,height:options.input.border&&options.input.border.type=='line'?3:1,width:bbox.width,left:bbox.left,keys:options.input.mutable?true:undefined,vi:options.input.mutable?true:undefined,mouse:options.input.mutable?true:undefined,inputOnFocus:options.input.mutable?true:undefined,value:options.input.value||'<input>',hidden:options.hidden,border:options.input.border,style:{fg:options.input.fg||'black',bg:options.input.bg||'white',bold:true}});this.screen.append(this._.input);}
if(options.okayButton){this._.okay=new Button({screen:this.screen,top:bbox.top+bbox.height+(options.box?1:0)+off2,height:1,left:bbox.left+1,width:10,content:options.okayButton,align:'center',style:{fg:'white',bg:'blue',bold:true,},autoFocus:false,hidden:options.hidden,mouse:true});this._.okay.on('press',function(){var item=self.items[self.selected],value=self._.input?self._.input.getValue():item.content.replace(/\{[^{}]+\}/g,'').replace(/@$/,''),file=path.resolve(self.cwd,value);self.emit('file',file);self.hide();});this.screen.append(this._.okay);}
if(options.cancelButton){this._.cancel=new Button({screen:this.screen,top:bbox.top+bbox.height+(options.box?1:0)+off2,height:1,left:bbox.left+bbox.width-10-1,width:10,content:options.cancelButton,align:'center',style:{fg:'white',bg:'red',bold:true,},autoFocus:false,hidden:options.hidden,mouse:true});this._.cancel.on('press',function(){self.hide();});this.screen.append(this._.cancel);}
if(options.arrows)
Arrows(self,options,function(){self.emit('element wheelup')},function(){self.emit('element wheeldown')},true);this._hide=this.hide;this.hide=function(){self._hide();if(self._.box)self._.box.hide();if(self._.input)self._.input.hide();if(self._.okay)self._.okay.hide();if(self._.cancel)self._.cancel.hide();if(self._.up)self._.up.hide();if(self._.down)self._.down.hide();self.screen.render();self.screen.clickable=self._clickable;}
this._show=this.show;this.show=function(){self._clickable=self.screen.clickable;self.screen.clickable=self.clickable;self._show();if(self._.box)self._.box.show();if(self._.input)self._.input.show();if(self._.okay)self._.okay.show();if(self._.cancel)self._.cancel.show();if(self._.up)self._.up.show();if(self._.down)self._.down.show();self.screen.render();}
this.clickable=this.screen.clickable;this.screen.clickable=this._clickable;}
if(options.label&&~options.label.indexOf('%path')){this._label.setContent(options.label.replace('%path',this.cwd));}
if(this._.input)
this.on('selected',function(item){var value=item.content.replace(/\{[^{}]+\}/g,'').replace(/@$/,'');if(value.indexOf('/')!=-1)value='';self._.input.setValue(value);self._.input.update();});this.on('select',function(item){var value=item.content.replace(/\{[^{}]+\}/g,'').replace(/@$/,''),file=path.resolve(self.cwd,value);return fs.stat(file,function(err,stat){var _cwd=self.cwd;if(err){return self.emit('ioerror',err,file);}
self.file=file;self.value=file;if(stat.isDirectory()){self.cwd=file;self.refresh(undefined,function(err){if(err)self.cwd=_cwd;else if(options.label&&~options.label.indexOf('%path')){self._label.setContent(options.label.replace('%path',self.cwd));self.emit('cd',file,self.cwd);self.screen.render();}});}else{if(self.options.select)self.emit('file',file);if(self.options.select&&self.options.autohide)self.hide();}});});}
inheritPrototype(FileManager,List);FileManager.prototype.type='file-manager';FileManager.prototype.refresh=function(cwd,callback){var self=this;if(cwd)this.cwd=cwd;else cwd=this.cwd;return fs.readdir(cwd,function(err,list){if(err&&err.code==='ENOENT'){self.cwd=cwd!==process.env.HOME?process.env.HOME:'/';return self.refresh(undefined,callback);}
if(err){if(callback)return callback(err);return self.emit('ioerror',err,cwd);}
var dirs=[],files=[];list.unshift('..');list.forEach(function(name){var f=path.resolve(cwd,name),stat;try{stat=fs.lstatSync(f);}catch(e){;}
if((stat&&stat.isDirectory())||name==='..'){dirs.push({name:name,text:'{light-blue-fg}'+name+'{/light-blue-fg}/',dir:true});}else if(stat&&stat.isSymbolicLink()){files.push({name:name,text:'{light-cyan-fg}'+name+'{/light-cyan-fg}@',dir:false});}else{files.push({name:name,text:name,dir:false});}});dirs=Helpers.asort(dirs);files=Helpers.asort(files);list=dirs.concat(files).map(function(data){return data.text;});self.setItems(list);self.select(0);self.screen.render();self.emit('refresh');if(callback)callback();});};FileManager.prototype.pick=function(cwd,callback){if(!callback){callback=cwd;cwd=null;}
var self=this,focused=this.screen.focused===this,hidden=this.hidden,onfile,oncancel;function resume(){self.removeListener('file',onfile);self.removeListener('cancel',oncancel);if(hidden){self.hide();}
if(!focused){self.screen.restoreFocus();}
self.screen.render();}
this.on('file',onfile=function(file){resume();return callback(null,file);});this.on('cancel',oncancel=function(){resume();return callback();});this.refresh(cwd,function(err){if(err)return callback(err);if(hidden){self.show();}
if(!focused){self.screen.saveFocus();self.focus();}
self.screen.render();});};FileManager.prototype.reset=function(cwd,callback){if(!callback){callback=cwd;cwd=null;}
this.cwd=cwd||this.options.cwd;this.refresh(callback);};module.exports=FileManager;};BundleModuleCode['term/widgets/checkbox']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Input=Require('term/widgets/input');function Checkbox(options){var self=this;if(!instanceOf(this,Node)){return new Checkbox(options);}
options=options||{};Input.call(this,options);this.text=options.content||options.text||'';this.checked=this.value=options.checked||false;this.on('keypress',function(ch,key){if(key.name==='enter'||key.name==='space'){self.toggle();self.screen.render();}});if(options.mouse){this.on('click',function(){self.toggle();self.screen.render();});}
this.on('focus',function(){var lpos=self.lpos;if(!lpos)return;self.screen.program.lsaveCursor('checkbox');self.screen.program.cup(lpos.yi,lpos.xi+1);self.screen.program.showCursor();});this.on('blur',function(){self.screen.program.lrestoreCursor('checkbox',true);});}
inheritPrototype(Checkbox,Input);Checkbox.prototype.type='checkbox';Checkbox.prototype.render=function(){this.clearPos(true);this.setContent('['+(this.checked?'x':' ')+'] '+this.text,true);return this._render();};Checkbox.prototype.check=function(){if(this.checked)return;this.checked=this.value=true;this.emit('check',this);this.emit('select',true);};Checkbox.prototype.uncheck=function(){if(!this.checked)return;this.checked=this.value=false;this.emit('uncheck',this);this.emit('select',false);};Checkbox.prototype.toggle=function(){return this.checked?this.uncheck():this.check();};module.exports=Checkbox;};BundleModuleCode['term/widgets/radioset']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function RadioSet(options){if(!instanceOf(this,Node)){return new RadioSet(options);}
options=options||{};Box.call(this,options);}
inheritPrototype(RadioSet,Box);RadioSet.prototype.type='radio-set';module.exports=RadioSet;};BundleModuleCode['term/widgets/radiobutton']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Checkbox=Require('term/widgets/checkbox');function RadioButton(options){var self=this;if(!instanceOf(this,Node)){return new RadioButton(options);}
options=options||{};this.group=options.group;Checkbox.call(this,options);this.on('check',function(){var el=self,group=self.group;while(el=el.parent){if(el.type==='radio-set'||el.type==='form')break;}
el=el||self.parent;var index=0;el.forDescendants(function(el){if(el.type!=='radio-button'||el===self||el.group!=group){return;}
index++;el.uncheck();});});}
inheritPrototype(RadioButton,Checkbox);RadioButton.prototype.type='radio-button';RadioButton.prototype.render=function(){this.clearPos(true);this.setContent('('+(this.checked?'*':' ')+') '+this.text,true);return this._render();};RadioButton.prototype.toggle=RadioButton.prototype.check;module.exports=RadioButton;};BundleModuleCode['term/widgets/prompt']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var Button=Require('term/widgets/button');var Textbox=Require('term/widgets/textbox');function Prompt(options){if(!instanceOf(this,Node)){return new Prompt(options);}
options=options||{};options.hidden=true;Box.call(this,options);this._.input=new Textbox({parent:this,top:3,height:1,left:2,right:2,bg:'black'});this._.okay=new Button({parent:this,top:5,height:1,left:2,width:6,content:'Okay',align:'center',bg:'black',hoverBg:'blue',autoFocus:false,mouse:true});this._.cancel=new Button({parent:this,top:5,height:1,shrink:true,left:10,width:8,content:'Cancel',align:'center',bg:'black',hoverBg:'blue',autoFocus:false,mouse:true});}
inheritPrototype(Prompt,Box);Prompt.prototype.type='prompt';Prompt.prototype.input=Prompt.prototype.setInput=Prompt.prototype.readInput=function(text,value,callback){var self=this;var okay,cancel;if(!callback){callback=value;value='';}
this.show();this.setContent(' '+text);this._.input.value=value;this.screen.saveFocus();this._.okay.on('press',okay=function(){self._.input.submit();});this._.cancel.on('press',cancel=function(){self._.input.cancel();});this._.input.readInput(function(err,data){self.hide();self.screen.restoreFocus();self._.okay.removeListener('press',okay);self._.cancel.removeListener('press',cancel);return callback(err,data);});this.screen.render();};module.exports=Prompt;};BundleModuleCode['term/widgets/question']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var Button=Require('term/widgets/button');function Question(options){if(!instanceOf(this,Node)){return new Question(options);}
options=options||{};options.hidden=true;if(!options.height||options.height<5)options.height=5;Box.call(this,options);this._clickable=this.screen.clickable;this.screen.clickable=[];this._.okay=new Button({screen:this.screen,parent:this,top:options.height?(options.height-2):3,height:1,left:2,width:10,content:options.okButton||'Okay',align:'center',bg:'black',hoverBg:'blue',autoFocus:false,mouse:true});if(options.cancelButton)
this._.cancel=new Button({screen:this.screen,parent:this,top:options.height?(options.height-2):3,height:1,left:options.width?(options.width-12):10,width:10,content:options.cancelButton,align:'center',bg:'black',hoverBg:'blue',autoFocus:false,mouse:true});this.clickable=this.screen.clickable;this.screen.clickable=this._clickable;}
inheritPrototype(Question,Box);Question.prototype.type='question';Question.prototype.ask=function(text,callback){var self=this,press,okay,cancel,off,room;if(!callback)callback=function(){};this._clickable=this.screen.clickable;this.screen.clickable=this.clickable;this.show();if(text.length>this.options.width-4){var tokens=text.split(' '),curlen=0,temp='';for(var t in tokens){var token=tokens[t];if(curlen+token.length+1<this.options.width-4){temp=temp+token+' ';curlen=curlen+token.length+1;}else{if(token.length<this.options.width-4){temp=temp+'\n'+token+' ';curlen=token.length+1;}else{off=0,room=this.options.width-4-curlen;temp=temp+token.substr(0,room);off=room;room=this.options.width-4;while(off<token.length){frag=token.substr(off,room);temp=temp+'\n'+frag;off+=room;curlen=frag;}
temp=temp+' ';curlen++;}}}
text=temp;}
this.setContent('\n  '+text.replace(/\n/g,'\n  '));this.onScreenEvent('keypress',press=function(ch,key){if(key.name==='mouse')return;if(key.name!=='enter'&&key.name!=='escape'&&key.name!=='q'&&key.name!=='y'&&key.name!=='n'){return;}
done(null,key.name==='enter'||key.name==='y');});this._.okay.on('press',okay=function(){done(null,true);});if(this._.cancel)this._.cancel.on('press',cancel=function(){done(null,false);});this.screen.saveFocus();this.focus();function done(err,data){self.hide();self.screen.clickable=self._clickable;self.screen.restoreFocus();self.removeScreenEvent('keypress',press);self._.okay.removeListener('press',okay);if(self._.cancel)self._.cancel.removeListener('press',cancel);return callback(err,data);}
this.screen.render();};module.exports=Question;};BundleModuleCode['term/widgets/message']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function Message(options){if(!instanceOf(this,Node)){return new Message(options);}
options=options||{};options.tags=true;Box.call(this,options);}
inheritPrototype(Message,Box);Message.prototype.type='message';Message.prototype.log=Message.prototype.display=function(text,time,callback){var self=this;if(typeof time==='function'){callback=time;time=null;}
if(time==null)time=3;if(this.scrollable){this.screen.saveFocus();this.focus();this.scrollTo(0);}
this.show();this.setContent(text);this.screen.render();if(time===Infinity||time===-1||time===0){var end=function(){if(end.done)return;end.done=true;if(self.scrollable){try{self.screen.restoreFocus();}catch(e){;}}
self.hide();self.screen.render();if(callback)callback();};setTimeout(function(){self.onScreenEvent('keypress',function fn(ch,key){if(key.name==='mouse')return;if(self.scrollable){if((key.name==='up'||(self.options.vi&&key.name==='k'))||(key.name==='down'||(self.options.vi&&key.name==='j'))||(self.options.vi&&key.name==='u'&&key.ctrl)||(self.options.vi&&key.name==='d'&&key.ctrl)||(self.options.vi&&key.name==='b'&&key.ctrl)||(self.options.vi&&key.name==='f'&&key.ctrl)||(self.options.vi&&key.name==='g'&&!key.shift)||(self.options.vi&&key.name==='g'&&key.shift)){return;}}
if(self.options.ignoreKeys&&~self.options.ignoreKeys.indexOf(key.name)){return;}
self.removeScreenEvent('keypress',fn);end();});if(!self.options.mouse)return;self.onScreenEvent('mouse',function fn(data){if(data.action==='mousemove')return;self.removeScreenEvent('mouse',fn);end();});},10);return;}
setTimeout(function(){self.hide();self.screen.render();if(callback)callback();},time*1000);};Message.prototype.error=function(text,time,callback){return this.display('{red-fg}Error: '+text+'{/red-fg}',time,callback);};module.exports=Message;};BundleModuleCode['term/widgets/keyboard']=function(module,exports){var options={version:'1.2.3'}
var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var Button=Require('term/widgets/button');var TextBox=Require('term/widgets/textbox');var Helpers=Require('term/helpers');function Keyboard(options){var self=this,x,y,key,i=0,bbox;if(!instanceOf(this,Node)){return new Keyboard(options);}
options=options||{};options.hidden=true;if(!options.height||options.height<10)options.height=10;Box.call(this,options);this._clickable=this.screen.clickable;this.screen.clickable=[];if(!options.button)options.button={width:3,height:2};if(!options.margin)options.margin={x:2,y:1};this.shift=false;this.group=0;this._.buttons=[];var Keys=[['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'],['0','1','2','3','4','5','6','7','8','9','.','+','-','*',':',';'],['"','!','=','_','<','>','(',')','{','}','[',']','?','#','~',' ']];var keys=Comp.array.flatten(Keys);var complen=Keys[0].length+Keys[1].length;bbox=Helpers.bbox(this.screen,options);if(options.okayButton){this._.okay=new Button({screen:this.screen,parent:this,top:bbox.height-3,height:1,left:1,width:Math.max(6,options.okayButton.length+2),content:options.okayButton,align:'center',autoFocus:false,mouse:true,style:{bold:true,bg:'green',fg:'white'}});this._.okay.on('press',function(){self.hide();if(self._.callback)self._.callback(self._.input.getValue())});}
if(options.cancelButton){this._.cancel=new Button({screen:this.screen,parent:this,top:bbox.height-3,height:1,right:1,width:options.cancelButton.length+2,content:options.cancelButton,align:'center',autoFocus:false,mouse:true,style:{bold:true,bg:'red',fg:'white'}});this._.cancel.on('press',function(){self.hide();});}
this._.shift=new Button({screen:this.screen,parent:this,top:bbox.height-3,height:1,right:int(bbox.width/2)+(options.compact?1:int(options.margin.x)),width:(options.shiftButton&&options.shiftButton.length+2)||6,content:options.shiftButton||'Shft',align:'center',autoFocus:false,mouse:true});this._.shift.on('press',function(){self.shift=~self.shift;for(var i=0;i<26;i++){self._.buttons[i].setContent(self.shift?Keys[0][i].toUpperCase():Keys[0][i]);}
if(options.compact&&self.shift)for(i in Keys[1])self._.buttons[26+Number(i)].setContent(Keys[2][i]);if(options.compact&&!self.shift)for(i in Keys[1])self._.buttons[26+Number(i)].setContent(Keys[1][i]);if(self.shift&&options.nlButton)self._.delete.setContent(options.nlButton);else if(!self.shift&&options.nlButton)self._.delete.setContent(options.delButton||'DEL');self.screen.render();});this._.delete=new Button({screen:this.screen,parent:this,top:bbox.height-3,height:1,left:int(bbox.width/2)+(options.compact?0:int(options.margin.x)),width:(options.delButton&&options.delButton.length+2)||6,content:options.delButton||'DEL',align:'center',autoFocus:false,mouse:true});this._.delete.on('press',function(){var line=self._.input.getValue();if(!self.shift||!options.nlButton){self._.input.setValue(line.substring(0,line.length-1));}else if(self.shift&&options.nlButton){self._.input.setValue(line+'\n');}
self._.input.update();});this._.input=new TextBox({parent:this,value:options.value||'content',width:bbox.width-4,height:1,left:1,top:0,style:{fg:(options.style.input&&options.style.input.fg)||'black',bg:(options.style.input&&options.style.input.bg)||'white',bold:true}});y=1+options.margin.y;i=0;while((options.compact?i<complen:true)&&keys[i]&&y<(bbox.height-options.button.height-options.margin.y)-1){x=options.margin.x;while((options.compact?i<complen:true)&&keys[i]&&x<(bbox.width-options.button.width-options.margin.x)){function make(i){key=new Button({screen:self.screen,parent:self,top:y,height:options.button.height,left:x,width:options.button.width,content:keys[i],align:'center',autoFocus:false,mouse:true});self._.buttons.push(key);key.on('press',function(){self.emit('key',i)});}
make(i);i++,x+=(options.button.width+options.margin.x);}
y+=(options.button.height+options.margin.y);}
this.clickable=this.screen.clickable;this.screen.clickable=this._clickable;this._hide=this.hide;this.hide=function(){self._hide();self.screen.render();self.screen.clickable=self._clickable;}
this._show=this.show;this.show=function(){self._clickable=self.screen.clickable;self.screen.clickable=self.clickable;self._show();self.screen.render();}
this.on('key',function(index){var line=self._.input.getValue(),ch;if(options.compact){if(index<26){ch=self.shift?Keys[0][index].toUpperCase():Keys[0][index];}else{ch=self.shift?Keys[2][index-26]:Keys[1][index-26];}}else{if(!self.shift||index>26)ch=keys[index];else ch=keys[index].toUpperCase();}
line+=ch;self._.input.setValue(line);self._.input.update();});}
inheritPrototype(Keyboard,Box);Keyboard.prototype.setCallback=function(cb){this._.callback=cb}
Keyboard.prototype.setValue=function(line){this._.input.setValue(line);this._.input.update();}
Keyboard.prototype.type='keyboard';module.exports=Keyboard;};BundleModuleCode['term/widgets/loading']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var Text=Require('term/widgets/text');function Loading(options){if(!instanceOf(this,Node)){return new Loading(options);}
options=options||{};Box.call(this,options);this._.icon=new Text({parent:this,align:'center',top:2,left:1,right:1,height:1,content:'|'});}
inheritPrototype(Loading,Box);Loading.prototype.type='loading';Loading.prototype.load=function(text){var self=this;this.show();this.setContent(text);if(this._.timer){this.stop();}
this.screen.lockKeys=true;this._.timer=setInterval(function(){if(self._.icon.content==='|'){self._.icon.setContent('/');}else if(self._.icon.content==='/'){self._.icon.setContent('-');}else if(self._.icon.content==='-'){self._.icon.setContent('\\');}else if(self._.icon.content==='\\'){self._.icon.setContent('|');}
self.screen.render();},200);};Loading.prototype.stop=function(){this.screen.lockKeys=false;this.hide();if(this._.timer){clearInterval(this._.timer);delete this._.timer;}
this.screen.render();};module.exports=Loading;};BundleModuleCode['term/widgets/listbar']=function(module,exports){var Comp=Require('com/compat');var helpers=Require('term/helpers');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function Listbar(options){var self=this;if(!instanceOf(this,Node)){return new Listbar(options);}
options=options||{};this.items=[];this.ritems=[];this.commands=[];this.leftBase=0;this.leftOffset=0;this.mouse=options.mouse||false;Box.call(this,options);if(!this.style.selected){this.style.selected={};}
if(!this.style.item){this.style.item={};}
if(options.commands||options.items){this.setItems(options.commands||options.items);}
if(options.keys){this.on('keypress',function(ch,key){if(key.name==='left'||(options.vi&&key.name==='h')||(key.shift&&key.name==='tab')){self.moveLeft();self.screen.render();if(key.name==='tab')return false;return;}
if(key.name==='right'||(options.vi&&key.name==='l')||key.name==='tab'){self.moveRight();self.screen.render();if(key.name==='tab')return false;return;}
if(key.name==='enter'||(options.vi&&key.name==='k'&&!key.shift)){self.emit('action',self.items[self.selected],self.selected);self.emit('select',self.items[self.selected],self.selected);var item=self.items[self.selected];if(item._.cmd.callback){item._.cmd.callback();}
self.screen.render();return;}
if(key.name==='escape'||(options.vi&&key.name==='q')){self.emit('action');self.emit('cancel');return;}});}
if(options.autoCommandKeys){this.onScreenEvent('keypress',function(ch){if(/^[0-9]$/.test(ch)){var i=+ch-1;if(!~i)i=9;return self.selectTab(i);}});}
this.on('focus',function(){self.select(self.selected);});}
inheritPrototype(Listbar,Box);Listbar.prototype.type='listbar';Object.defineProperty(Listbar.prototype,'selected',{get:function(){return this.leftBase+this.leftOffset;}});Listbar.prototype.setItems=function(commands){var self=this;if(!Array.isArray(commands)){commands=Object.keys(commands).reduce(function(obj,key,i){var cmd=commands[key],cb;if(typeof cmd==='function'){cb=cmd;cmd={callback:cb};}
if(cmd.text==null)cmd.text=key;if(cmd.prefix==null)cmd.prefix=++i+'';if(cmd.text==null&&cmd.callback){cmd.text=cmd.callback.name;}
obj.push(cmd);return obj;},[]);}
this.items.forEach(function(el){el.detach();});this.items=[];this.ritems=[];this.commands=[];commands.forEach(function(cmd){self.add(cmd);});this.emit('set items');};Listbar.prototype.add=Listbar.prototype.addItem=Listbar.prototype.appendItem=function(item,callback){var self=this,prev=this.items[this.items.length-1],drawn,cmd,title,len;if(!this.parent){drawn=0;}else{drawn=prev?prev.aleft+prev.width:0;if(!this.screen.autoPadding){drawn+=this.ileft;}}
if(typeof item==='object'){cmd=item;if(cmd.prefix==null)cmd.prefix=(this.items.length+1)+'';}
if(typeof item==='string'){cmd={prefix:(this.items.length+1)+'',text:item,callback:callback};}
if(typeof item==='function'){cmd={prefix:(this.items.length+1)+'',text:item.name,callback:item};}
if(cmd.keys&&cmd.keys[0]){cmd.prefix=cmd.keys[0];}
var t=helpers.generateTags(this.style.prefix||{fg:'lightblack'});title=(cmd.prefix!=null?t.open+cmd.prefix+t.close+':':'')+cmd.text;len=((cmd.prefix!=null?cmd.prefix+':':'')+cmd.text).length;var options={screen:this.screen,top:0,left:drawn+1,height:1,content:title,width:len+2,align:'center',autoFocus:false,tags:true,mouse:true,style:helpers.merge({},this.style.item),noOverflow:true};if(!this.screen.autoPadding){options.top+=this.itop;options.left+=this.ileft;}
['bg','fg','bold','underline','blink','inverse','invisible'].forEach(function(name){options.style[name]=function(){var attr=self.items[self.selected]===el?self.style.selected[name]:self.style.item[name];if(typeof attr==='function')attr=attr(el);return attr;};});var el=new Box(options);this._[cmd.text]=el;cmd.element=el;el._.cmd=cmd;this.ritems.push(cmd.text);this.items.push(el);this.commands.push(cmd);this.append(el);if(cmd.callback){if(cmd.keys){this.screen.key(cmd.keys,function(){self.emit('action',el,self.selected);self.emit('select',el,self.selected);if(el._.cmd.callback){el._.cmd.callback();}
self.select(el);self.screen.render();});}}
if(this.items.length===1){this.select(0);}
if(this.mouse){el.on('click',function(){self.emit('action',el,self.selected);self.emit('select',el,self.selected);if(el._.cmd.callback){el._.cmd.callback();}
self.select(el);self.screen.render();});}
this.emit('add item');};Listbar.prototype.render=function(){var self=this,drawn=0;if(!this.screen.autoPadding){drawn+=this.ileft;}
this.items.forEach(function(el,i){if(i<self.leftBase){el.hide();}else{el.rleft=drawn+1;drawn+=el.width+2;el.show();}});return this._render();};Listbar.prototype.select=function(offset){if(typeof offset!=='number'){offset=this.items.indexOf(offset);}
if(offset<0){offset=0;}else if(offset>=this.items.length){offset=this.items.length-1;}
if(!this.parent){this.emit('select item',this.items[offset],offset);return;}
var lpos=this._getCoords();if(!lpos)return;var self=this,width=(lpos.xl-lpos.xi)-this.iwidth,drawn=0,visible=0,el;el=this.items[offset];if(!el)return;this.items.forEach(function(el,i){if(i<self.leftBase)return;var lpos=el._getCoords();if(!lpos)return;if(lpos.xl-lpos.xi<=0)return;drawn+=(lpos.xl-lpos.xi)+2;if(drawn<=width)visible++;});var diff=offset-(this.leftBase+this.leftOffset);if(offset>this.leftBase+this.leftOffset){if(offset>this.leftBase+visible-1){this.leftOffset=0;this.leftBase=offset;}else{this.leftOffset+=diff;}}else if(offset<this.leftBase+this.leftOffset){diff=-diff;if(offset<this.leftBase){this.leftOffset=0;this.leftBase=offset;}else{this.leftOffset-=diff;}}
this.emit('select item',el,offset);};Listbar.prototype.removeItem=function(child){var i=typeof child!=='number'?this.items.indexOf(child):child;if(~i&&this.items[i]){child=this.items.splice(i,1)[0];this.ritems.splice(i,1);this.commands.splice(i,1);this.remove(child);if(i===this.selected){this.select(i-1);}}
this.emit('remove item');};Listbar.prototype.move=function(offset){this.select(this.selected+offset);};Listbar.prototype.moveLeft=function(offset){this.move(-(offset||1));};Listbar.prototype.moveRight=function(offset){this.move(offset||1);};Listbar.prototype.selectTab=function(index){var item=this.items[index];if(item){if(item._.cmd.callback){item._.cmd.callback();}
this.select(index);this.screen.render();}
this.emit('select tab',item,index);};module.exports=Listbar;};BundleModuleCode['term/widgets/table']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function Table(options){var self=this;if(!instanceOf(this,Node)){return new Table(options);}
options=options||{};options.shrink=true;options.style=options.style||{};options.style.border=options.style.border||{};options.style.header=options.style.header||{};options.style.cell=options.style.cell||{};options.align=options.align||'center';delete options.height;Box.call(this,options);this.pad=options.pad!=null?options.pad:2;this.setData(options.rows||options.data);this.on('attach',function(){self.setContent('');self.setData(self.rows);});this.on('resize',function(){self.setContent('');self.setData(self.rows);self.screen.render();});}
inheritPrototype(Table,Box);Table.prototype.type='table';Table.prototype._calculateMaxes=function(){var self=this;var maxes=[];if(this.detached)return;this.rows=this.rows||[];this.rows.forEach(function(row){row.forEach(function(cell,i){var clen=self.strWidth(cell);if(!maxes[i]||maxes[i]<clen){maxes[i]=clen;}});});var total=maxes.reduce(function(total,max){return total+max;},0);total+=maxes.length+1;if(this.width<total){delete this.position.width;}
if(this.position.width!=null){var missing=this.width-total;var w=missing/maxes.length|0;var wr=missing%maxes.length;maxes=maxes.map(function(max,i){if(i===maxes.length-1){return max+w+wr;}
return max+w;});}else{maxes=maxes.map(function(max){return max+self.pad;});}
return this._maxes=maxes;};Table.prototype.setRows=Table.prototype.setData=function(rows){var self=this,text='',align=this.align;this.rows=rows||[];this._calculateMaxes();if(!this._maxes)return;this.rows.forEach(function(row,i){var isFooter=i===self.rows.length-1;row.forEach(function(cell,i){var width=self._maxes[i];var clen=self.strWidth(cell);if(i!==0){text+=' ';}
while(clen<width){if(align==='center'){cell=' '+cell+' ';clen+=2;}else if(align==='left'){cell=cell+' ';clen+=1;}else if(align==='right'){cell=' '+cell;clen+=1;}}
if(clen>width){if(align==='center'){cell=cell.substring(1);clen--;}else if(align==='left'){cell=cell.slice(0,-1);clen--;}else if(align==='right'){cell=cell.substring(1);clen--;}}
text+=cell;});if(!isFooter){text+='\n\n';}});delete this.align;this.setContent(text);this.align=align;};Table.prototype.render=function(){var self=this;var coords=this._render();if(!coords)return;this._calculateMaxes();if(!this._maxes)return coords;var lines=this.screen.lines,xi=coords.xi,yi=coords.yi,rx,ry,i;var dattr=this.sattr(this.style),hattr=this.sattr(this.style.header),cattr=this.sattr(this.style.cell),battr=this.sattr(this.style.border);var width=coords.xl-coords.xi-this.iright,height=coords.yl-coords.yi-this.ibottom;for(var y=this.itop;y<height;y++){if(!lines[yi+y])break;for(var x=this.ileft;x<width;x++){if(!lines[yi+y][xi+x])break;if(lines[yi+y][xi+x][0]!==dattr)continue;if(y===this.itop){lines[yi+y][xi+x][0]=hattr;}else{lines[yi+y][xi+x][0]=cattr;}
lines[yi+y].dirty=true;}}
if(!this.border||this.options.noCellBorders)return coords;ry=0;for(i=0;i<self.rows.length+1;i++){if(!lines[yi+ry])break;rx=0;self._maxes.forEach(function(max,i){rx+=max;if(i===0){if(!lines[yi+ry][xi+0])return;if(ry===0){lines[yi+ry][xi+0][0]=battr;}else if(ry/2===self.rows.length){lines[yi+ry][xi+0][0]=battr;}else{lines[yi+ry][xi+0][0]=battr;lines[yi+ry][xi+0][1]='\u251c';if(!self.border.left){lines[yi+ry][xi+0][1]='\u2500';}}
lines[yi+ry].dirty=true;}else if(i===self._maxes.length-1){if(!lines[yi+ry][xi+rx+1])return;if(ry===0){rx++;lines[yi+ry][xi+rx][0]=battr;}else if(ry/2===self.rows.length){rx++;lines[yi+ry][xi+rx][0]=battr;}else{rx++;lines[yi+ry][xi+rx][0]=battr;lines[yi+ry][xi+rx][1]='\u2524';if(!self.border.right){lines[yi+ry][xi+rx][1]='\u2500';}}
lines[yi+ry].dirty=true;return;}
if(!lines[yi+ry][xi+rx+1])return;if(ry===0){rx++;lines[yi+ry][xi+rx][0]=battr;lines[yi+ry][xi+rx][1]='\u252c';if(!self.border.top){lines[yi+ry][xi+rx][1]='\u2502';}}else if(ry/2===self.rows.length){rx++;lines[yi+ry][xi+rx][0]=battr;lines[yi+ry][xi+rx][1]='\u2534';if(!self.border.bottom){lines[yi+ry][xi+rx][1]='\u2502';}}else{if(self.options.fillCellBorders){var lbg=(ry<=2?hattr:cattr)&0x1ff;rx++;lines[yi+ry][xi+rx][0]=(battr&~0x1ff)|lbg;}else{rx++;lines[yi+ry][xi+rx][0]=battr;}
lines[yi+ry][xi+rx][1]='\u253c';}
lines[yi+ry].dirty=true;});ry+=2;}
for(ry=1;ry<self.rows.length*2;ry++){if(!lines[yi+ry])break;rx=0;self._maxes.slice(0,-1).forEach(function(max){rx+=max;if(!lines[yi+ry][xi+rx+1])return;if(ry%2!==0){if(self.options.fillCellBorders){var lbg=(ry<=2?hattr:cattr)&0x1ff;rx++;lines[yi+ry][xi+rx][0]=(battr&~0x1ff)|lbg;}else{rx++;lines[yi+ry][xi+rx][0]=battr;}
lines[yi+ry][xi+rx][1]='\u2502';lines[yi+ry].dirty=true;}else{rx++;}});rx=1;self._maxes.forEach(function(max){while(max--){if(ry%2===0){if(!lines[yi+ry])break;if(!lines[yi+ry][xi+rx+1])break;if(self.options.fillCellBorders){var lbg=(ry<=2?hattr:cattr)&0x1ff;lines[yi+ry][xi+rx][0]=(battr&~0x1ff)|lbg;}else{lines[yi+ry][xi+rx][0]=battr;}
lines[yi+ry][xi+rx][1]='\u2500';lines[yi+ry].dirty=true;}
rx++;}
rx++;});}
return coords;};module.exports=Table;};BundleModuleCode['term/widgets/listtable']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var List=Require('term/widgets/list');var Table=Require('term/widgets/table');function ListTable(options){var self=this;if(!instanceOf(this,Node)){return new ListTable(options);}
options=options||{};options.shrink=true;options.normalShrink=true;options.style=options.style||{};options.style.border=options.style.border||{};options.style.header=options.style.header||{};options.style.cell=options.style.cell||{};this.__align=options.align||'center';delete options.align;options.style.selected=options.style.cell.selected;options.style.item=options.style.cell;List.call(this,options);this._header=new Box({parent:this,left:this.screen.autoPadding?0:this.ileft,top:0,width:'shrink',height:1,style:options.style.header,tags:options.parseTags||options.tags});this.on('scroll',function(){self._header.setFront();self._header.rtop=self.childBase;if(!self.screen.autoPadding){self._header.rtop=self.childBase+(self.border?1:0);}});this.pad=options.pad!=null?options.pad:2;this.setData(options.rows||options.data);this.on('attach',function(){self.setData(self.rows);});this.on('resize',function(){var selected=self.selected;self.setData(self.rows);self.select(selected);self.screen.render();});}
inheritPrototype(ListTable,List);ListTable.prototype.type='list-table';ListTable.prototype._calculateMaxes=Table.prototype._calculateMaxes;ListTable.prototype.setRows=ListTable.prototype.setData=function(rows){var self=this,align=this.__align;if(this.visible&&this.lpos){this.clearPos();}
this.clearItems();this.rows=rows||[];this._calculateMaxes();if(!this._maxes)return;this.addItem('');this.rows.forEach(function(row,i){var isHeader=i===0;var text='';row.forEach(function(cell,i){var width=self._maxes[i];var clen=self.strWidth(cell);if(i!==0){text+=' ';}
while(clen<width){if(align==='center'){cell=' '+cell+' ';clen+=2;}else if(align==='left'){cell=cell+' ';clen+=1;}else if(align==='right'){cell=' '+cell;clen+=1;}}
if(clen>width){if(align==='center'){cell=cell.substring(1);clen--;}else if(align==='left'){cell=cell.slice(0,-1);clen--;}else if(align==='right'){cell=cell.substring(1);clen--;}}
text+=cell;});if(isHeader){self._header.setContent(text);}else{self.addItem(text);}});this._header.setFront();this.select(0);};ListTable.prototype._select=ListTable.prototype.select;ListTable.prototype.select=function(i){if(i===0){i=1;}
if(i<=this.childBase){this.setScroll(this.childBase-1);}
return this._select(i);};ListTable.prototype.render=function(){var self=this;var coords=this._render();if(!coords)return;this._calculateMaxes();if(!this._maxes)return coords;var lines=this.screen.lines,xi=coords.xi,yi=coords.yi,rx,ry,i;var battr=this.sattr(this.style.border);var height=coords.yl-coords.yi-this.ibottom;if(!this.border||this.options.noCellBorders)return coords;ry=0;for(i=0;i<height+1;i++){if(!lines[yi+ry])break;rx=0;self._maxes.slice(0,-1).forEach(function(max){rx+=max;if(!lines[yi+ry][xi+rx+1])return;if(ry===0){rx++;lines[yi+ry][xi+rx][0]=battr;lines[yi+ry][xi+rx][1]='\u252c';if(!self.border.top){lines[yi+ry][xi+rx][1]='\u2502';}
lines[yi+ry].dirty=true;}else if(ry===height){rx++;lines[yi+ry][xi+rx][0]=battr;lines[yi+ry][xi+rx][1]='\u2534';if(!self.border.bottom){lines[yi+ry][xi+rx][1]='\u2502';}
lines[yi+ry].dirty=true;}else{rx++;}});ry+=1;}
for(ry=1;ry<height;ry++){if(!lines[yi+ry])break;rx=0;self._maxes.slice(0,-1).forEach(function(max){rx+=max;if(!lines[yi+ry][xi+rx+1])return;if(self.options.fillCellBorders!==false){var lbg=lines[yi+ry][xi+rx][0]&0x1ff;rx++;lines[yi+ry][xi+rx][0]=(battr&~0x1ff)|lbg;}else{rx++;lines[yi+ry][xi+rx][0]=battr;}
lines[yi+ry][xi+rx][1]='\u2502';lines[yi+ry].dirty=true;});}
return coords;};module.exports=ListTable;};BundleModuleCode['term/widgets/terminal']=function(module,exports){var Comp=Require('com/compat');var unicode=Require('term/unicode');var nextTick=global.setImmediate||process.nextTick.bind(process);var Node=Require('term/widgets/node');var Input=Require('term/widgets/input');function Terminal(options){var self=this;if(!instanceOf(this,Node)){return new Terminal(options);}
options=options||{};options.scrollable=options.scrollable!==false;Input.call(this,options);this.screen._listenKeys(this);this.value=options.value||'';this.cpos={x:-1,y:-1};this.cursorControl=true;this.multiline=options.multiline;this.history=[];this.historyTop=0;this.break='all';this.__updateCursor=this._updateCursor.bind(this);this.on('resize',this.__updateCursor);this.on('move',this.__updateCursor);if(options.inputOnFocus){this.on('focus',this.readInput.bind(this,null));}
if(!options.inputOnFocus&&options.keys){this.on('keypress',function(ch,key){if(self._reading)return;if(key.name==='enter'||(options.vi&&key.name==='i')){return self.readInput();}
if(key.name==='e'){return self.readEditor();}});}
if(options.mouse){this.on('click',function(data){if(self._reading)return;if(data.button!=='right')return;self.readEditor();});}
var offsetY=0;if(this._clines)offsetY=this._clines.length-(this.childBase||0);if(options.prompt){this.value=options.prompt;this.prompt=options.prompt;this.inputRange={x0:options.prompt.length,y0:offsetY,y1:offsetY,last:0,line:0};}else{this.inputRange={x0:0,y0:offsetY,y1:offsetY,last:0,line:0};this.prompt='';}}
inheritPrototype(Terminal,Input);Terminal.prototype.type='terminal';Terminal.prototype._updateCursor=function(get){if(this.screen.focused!==this){return;}
var lpos=get?this.lpos:this._getCoords();if(!lpos)return;var last=this._clines[this._clines.length-1],program=this.screen.program,line,offsetY=this.childBase||0,cx,cy;if(last===''&&this.value[this.value.length-1]!=='\n'){last=this._clines[this._clines.length-2]||'';}
line=Math.min(this._clines.length-1-(this.childBase||0),(lpos.yl-lpos.yi)-this.iheight-1);line=Math.max(0,line);if(this.cpos.x==-1||!this.cursorControl)this.cpos.x=this.strWidth(last);if(this.cpos.y==-1||!this.cursorControl)this.cpos.y=line;this.cpos.y=Math.min(this.cpos.y,line);this.cpos.x=Math.min(this.cpos.x,this.strWidth(this._clines[offsetY+this.cpos.y]));cx=lpos.xi+this.ileft+this.cpos.x;cy=lpos.yi+this.itop+this.cpos.y;if(cy===program.y&&cx===program.x){return;}
if(cy===program.y){if(cx>program.x){program.cuf(cx-program.x);}else if(cx<program.x){program.cub(program.x-cx);}}else if(cx===program.x){if(cy>program.y){program.cud(cy-program.y);}else if(cy<program.y){program.cuu(program.y-cy);}}else{program.cup(cy,cx);}};Terminal.prototype.input=Terminal.prototype.setInput=Terminal.prototype.readInput=function(callback){var self=this,focused=this.screen.focused===this;if(this._reading)return;this._reading=true;this._callback=callback;if(!focused){this.screen.saveFocus();this.focus();}
this.screen.grabKeys=true;this._updateCursor();this.screen.program.showCursor();this._done=function fn(err,value){if(!self._reading)return;if(fn.done)return;fn.done=true;self._reading=false;delete self._callback;delete self._done;self.removeListener('keypress',self.__listener);delete self.__listener;self.removeListener('blur',self.__done);delete self.__done;self.screen.program.hideCursor();self.screen.grabKeys=false;if(!focused){self.screen.restoreFocus();}
if(self.options.inputOnFocus){self.screen.rewindFocus();}
if(err==='stop')return;if(err){self.emit('error',err);}else if(value!=null){self.emit('submit',value);}else{self.emit('cancel',value);}
self.emit('action',value);if(!callback)return;return err?callback(err):callback(null,value);};nextTick(function(){if(self.__listener){return;}
self.__listener=self._listener.bind(self);self.on('keypress',self.__listener);});this.__done=this._done.bind(this,null,null);this.on('blur',this.__done);};Terminal.prototype.print=function(line){var offsetY=this.childBase||0,cn1=this._clines.length,y0=this.inputRange.y0,start=this.getLinearPos(this.value,offsetY+this.inputRange.y0,0),end=this.getLinearPos(this.value,offsetY+this.inputRange.y1,this._clines[offsetY+this.inputRange.y1].length);var command=this.value.slice(start,end);this.value=this.value.slice(0,start)+line+'\n'+command+this.value.slice(end);this.screen.render();var cn2=this._clines.length;this.scrollBottom();this.cpos.y+=10;this.cpos.x=this.inputRange.x0=this.prompt.length;this._updateCursor(true);this.inputRange.y0=Math.min(this._clines.length-1,this.cpos.y-this.inputRange.last);this.inputRange.y1=Math.min(this._clines.length-1,this.cpos.y);}
Terminal.prototype._listener=function(ch,key){var done=this._done,self=this,value=this.value,clinesLength=this._clines.length,offsetY=this.childBase||0,newline=false,lastchar=false,backspace=false,controlkey=false,lastline=(this.cpos.y+offsetY+1)==clinesLength;if(key.name==='return')return;if(key.name==='enter'){var start=this.getLinearPos(this.value,offsetY+this.inputRange.y0,0),end=this.getLinearPos(this.value,offsetY+this.inputRange.y1,this._clines[offsetY+this.inputRange.y1].length);var command=this.value.slice(start+this.prompt.length,end);this.value=this.value.slice(0,start)+this.prompt+this.value.slice(end);if(command&&command!=this.history[this.historyTop-1]){this.history.push(command);this.historyTop=this.history.length;}
this.screen.render();offsetY=this.childBase||0;self.cpos.y+=10;this._updateCursor(true);this.cpos.x=self._clines[offsetY+self.cpos.y].length;this.inputRange.y0=this.inputRange.y1=this.cpos.y;this.inputRange.last=0;this.emit('eval',command);return;}
function history(delta){if(self.historyTop+delta<0)return self.scrollBottom();self.historyTop+=delta;var start=self.getLinearPos(self.value,offsetY+self.inputRange.y0,0),end=self.getLinearPos(self.value,offsetY+self.inputRange.y1,self._clines[offsetY+self.inputRange.y1].length);var command=self.history[self.historyTop]||'';self.historyTop=Math.min(Math.max(0,self.historyTop),self.history.length);self.value=self.value.slice(0,start)+self.prompt+command+self.value.slice(end);self.screen.render();self.scrollBottom();self.cpos.x=self._clines[self._clines.length-1].length;self.cpos.y+=10;self._updateCursor(true);self.inputRange.y1=self.cpos.y;offsetY=self.childBase||0;var y0=self.cpos.y;while(self._clines[offsetY+y0].indexOf(self.prompt)!=0)y0--;self.inputRange.y0=y0;self.inputRange.last=self.inputRange.y1-self.inputRange.y0;}
if(this.cursorControl)switch(key.name){case'left':controlkey=true;if(this.cpos.y==this.inputRange.y0&&this.cpos.x>this.inputRange.x0)this.cpos.x--;else if(this.cpos.y!=this.inputRange.y0&&this.cpos.x>0)this.cpos.x--;else if(this.cpos.y!=this.inputRange.y0&&this.cpos.x==0){this.cpos.y--;this.cpos.x=this._clines[offsetY+this.cpos.y].length;}
this._updateCursor(true);break;case'right':controlkey=true;if(this.cpos.y>=this.inputRange.y0&&this.cpos.y<=this.inputRange.y1&&this.cpos.x<this._clines[offsetY+this.cpos.y].length-1){this.cpos.x++;}else if(this.cpos.y>=this.inputRange.y0&&this.cpos.y<this.inputRange.y1&&this.cpos.x==this._clines[offsetY+this.cpos.y].length-1){this.cpos.x=0;this.cpos.y++;}else if(this.cpos.y>=this.inputRange.y0&&this.cpos.y==this.inputRange.y1&&this.cpos.x<this._clines[offsetY+this.cpos.y].length){this.cpos.x++;}
this._updateCursor(true);break;case'up':controlkey=true;history(-1);return;break;case'down':controlkey=true;history(1);return;break;}
if(this.options.keys&&key.ctrl&&key.name==='e'){return this.readEditor();}
if(key.name==='escape'){done(null,null);}else if(key.name==='backspace'){backspace=true;if(this.cpos.y==this.inputRange.y0&&this.cpos.x<=this.inputRange.x0)return;if(this.value.length){if(this.screen.fullUnicode){if(unicode.isSurrogate(this.value,this.value.length-2)){this.value=this.value.slice(0,-2);}else{this.value=this.value.slice(0,-1);}}else{if(!this.cursorControl||this.cpos.x==-1||(this.cpos.x==this._clines[offsetY+this.cpos.y].length&&this.cpos.y==this._clines.length-1-offsetY)){this.value=this.value.slice(0,-1);}else{vpos=this.getLinearPos(this.value,offsetY+this.cpos.y,this.cpos.x);this.value=this.value.substr(0,vpos-1)+
this.value.substr(vpos,1000000);}}
if(this.cpos.x>0)this.cpos.x--;else{this.cpos.x=-1;if(offsetY==0&&this.cpos.y>0&&lastline)this.cpos.y--;};}}else if(!controlkey&&ch){if(!/^[\x00-\x08\x0b-\x0c\x0e-\x1f\x7f]$/.test(ch)){if(!this.cursorControl||this.cpos.x==-1||(this.cpos.x==this._clines[offsetY+this.cpos.y].length&&this.cpos.y==this._clines.length-1-offsetY)){lastchar=true;this.value+=ch;}else{vpos=this.getLinearPos(this.value,offsetY+this.cpos.y,this.cpos.x);this.value=this.value.substr(0,vpos)+ch+
this.value.substr(vpos,1000000);}
if(newline){this.cpos.x=0;this.cpos.y++;}else
this.cpos.x++;}}
var rmline=this.cpos.x==-1;this.inputRange.line=this._clines.rtof[offsetY+this.cpos.y];if(this.value!==value){var cn0=clinesLength,endofline=this.cpos.x==this._clines[offsetY+this.cpos.y].length+1,cn1=this._clines.length;var linelength1=this._clines[offsetY+this.cpos.y]&&this._clines[offsetY+this.cpos.y].length;this.screen.render();var linelength2=this._clines[offsetY+this.cpos.y]&&this._clines[offsetY+this.cpos.y].length;var cn2=this._clines.length;if(cn2>cn0&&endofline){this.scrollBottom();this.cpos.y++;this.inputRange.last++;if(this._clines[offsetY+this.cpos.y]&&lastchar)this.cpos.x=this._clines[offsetY+this.cpos.y].length;else this.cpos.x=linelength1-linelength2-1;this._updateCursor(true);this.inputRange.y0=this.cpos.y-this.inputRange.last;this.inputRange.y1=this.cpos.y;}else if(cn2<cn0&&!rmline){if(this.cpos.y>0&&!lastline&&lastchar)this.cpos.y--;this.inputRange.last--;if(this._clines[offsetY+this.cpos.y])this.cpos.x=this._clines[offsetY+this.cpos.y].length;this._updateCursor(true);this.inputRange.y0=this.cpos.y-this.inputRange.last;this.inputRange.y1=this.cpos.y;offsetY=this.childBase||0;this.cpos.x=this._clines[offsetY+this.cpos.y].length;this._updateCursor(true);}else if(linelength2<linelength1&&!backspace){this.cpos.y++;this.cpos.x=linelength1-linelength2;this._updateCursor(true);}
if(offsetY>0&&backspace){this.scroll(0);this.screen.render();if(rmline){if(this._clines[offsetY+this.cpos.y])this.cpos.x=this._clines[offsetY+this.cpos.y].length;else if(this._clines[offsetY+this.cpos.y-1])this.cpos.x=this._clines[offsetY+this.cpos.y-1].length;this._updateCursor(true);}}}};Terminal.prototype.getLinearPos=function(v,clineIndex,cposx){var lines=v.split('\n'),line=this._clines[clineIndex],flinenum=this._clines.rtof[clineIndex],vpos=flinenum>0?lines.slice(0,flinenum).map(function(line){return line.length+1}).reduce(function(a,b){return a+b}):0;function search(part,line){var i=line.indexOf(part);if(i==-1)return 0;else return i;}
if(lines[flinenum]){return vpos+search(line,lines[flinenum])+cposx;}else
return vpos+cposx;var vpos=0,len=v.length,cline,clinePos=0,clineNum=0;cline=this._clines[clineNum];while(vpos<len&&clineIndex){if(v.charAt(vpos)=='\n'){clinePos=-1;clineIndex--;clineNum++;cline=this._clines[clineNum];}else{if(v.charAt(vpos)!=cline.charAt(clinePos)){clinePos=0;clineIndex--;clineNum++;cline=this._clines[clineNum];continue;}}
vpos++;clinePos++;}
if(clineIndex==0)return vpos+cposx;else 0}
Terminal.prototype._typeScroll=function(){var height=this.height-this.iheight;if(this.cpos.y==height){this.scroll(this._clines.length);}};Terminal.prototype.getValue=function(){return this.value;};Terminal.prototype.setValue=function(value){if(value==null){value=this.value;}
if(this._value!==value){this.value=value;this._value=value;this.setContent(this.value);this._typeScroll();this._updateCursor();}};Terminal.prototype.clearInput=Terminal.prototype.clearValue=function(){return this.setValue('');};Terminal.prototype.submit=function(){if(!this.__listener)return;return this.__listener('\x1b',{name:'escape'});};Terminal.prototype.cancel=function(){if(!this.__listener)return;return this.__listener('\x1b',{name:'escape'});};Terminal.prototype.render=function(){this.setValue();return this._render();};Terminal.prototype.editor=Terminal.prototype.setEditor=Terminal.prototype.readEditor=function(callback){var self=this;if(this._reading){var _cb=this._callback,cb=callback;this._done('stop');callback=function(err,value){if(_cb)_cb(err,value);if(cb)cb(err,value);};}
if(!callback){callback=function(){};}
return this.screen.readEditor({value:this.value},function(err,value){if(err){if(err.message==='Unsuccessful.'){self.screen.render();return self.readInput(callback);}
self.screen.render();self.readInput(callback);return callback(err);}
self.setValue(value);self.screen.render();return self.readInput(callback);});};module.exports=Terminal;};BundleModuleCode['term/widgets/image']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function Image(options){if(!instanceOf(this,Node)){return new Image(options);}
options=options||{};options.type=options.itype||options.type||'ansi';Box.call(this,options);if(options.type==='ansi'&&this.type!=='ansiimage'){var ANSIImage=require('./ansiimage');Object.getOwnPropertyNames(ANSIImage.prototype).forEach(function(key){if(key==='type')return;Object.defineProperty(this,key,Object.getOwnPropertyDescriptor(ANSIImage.prototype,key));},this);ANSIImage.call(this,options);return this;}
if(options.type==='overlay'&&this.type!=='overlayimage'){var OverlayImage=require('./overlayimage');Object.getOwnPropertyNames(OverlayImage.prototype).forEach(function(key){if(key==='type')return;Object.defineProperty(this,key,Object.getOwnPropertyDescriptor(OverlayImage.prototype,key));},this);OverlayImage.call(this,options);return this;}
throw new Error('`type` must either be `ansi` or `overlay`.');}
inheritPrototype(Image,Box);Image.prototype.type='image';module.exports=Image;};BundleModuleCode['term/widgets/ansiimage']=function(module,exports){var Comp=Require('com/compat');var cp=Require('child_process');var colors=Require('term/colors');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var tng=Require('term/tng');function ANSIImage(options){var self=this;if(!instanceOf(this,Node)){return new ANSIImage(options);}
options=options||{};options.shrink=true;Box.call(this,options);this.scale=this.options.scale||1.0;this.options.animate=this.options.animate!==false;this._noFill=true;if(this.options.file){this.setImage(this.options.file);}
this.screen.on('prerender',function(){var lpos=self.lpos;if(!lpos)return;self.screen.clearRegion(lpos.xi,lpos.xl,lpos.yi,lpos.yl);});this.on('destroy',function(){self.stop();});}
inheritPrototype(ANSIImage,Box);ANSIImage.prototype.type='ansiimage';ANSIImage.curl=function(url){try{return cp.execFileSync('curl',['-s','-A','',url],{stdio:['ignore','pipe','ignore']});}catch(e){;}
try{return cp.execFileSync('wget',['-U','','-O','-',url],{stdio:['ignore','pipe','ignore']});}catch(e){;}
throw new Error('curl or wget failed.');};ANSIImage.prototype.setImage=function(file){this.file=typeof file==='string'?file:null;if(/^https?:/.test(file)){file=ANSIImage.curl(file);}
var width=this.position.width;var height=this.position.height;if(width!=null){width=this.width;}
if(height!=null){height=this.height;}
try{this.setContent('');this.img=tng(file,{colors:colors,width:width,height:height,scale:this.scale,ascii:this.options.ascii,speed:this.options.speed,filename:this.file});if(width==null||height==null){this.width=this.img.cellmap[0].length;this.height=this.img.cellmap.length;}
if(this.img.frames&&this.options.animate){this.play();}else{this.cellmap=this.img.cellmap;}}catch(e){this.setContent('Image Error: '+e.message);this.img=null;this.cellmap=null;}};ANSIImage.prototype.play=function(){var self=this;if(!this.img)return;return this.img.play(function(bmp,cellmap){self.cellmap=cellmap;self.screen.render();});};ANSIImage.prototype.pause=function(){if(!this.img)return;return this.img.pause();};ANSIImage.prototype.stop=function(){if(!this.img)return;return this.img.stop();};ANSIImage.prototype.clearImage=function(){this.stop();this.setContent('');this.img=null;this.cellmap=null;};ANSIImage.prototype.render=function(){var coords=this._render();if(!coords)return;if(this.img&&this.cellmap){this.img.renderElement(this.cellmap,this);}
return coords;};module.exports=ANSIImage;};BundleModuleCode['term/tng']=function(module,exports){var fs=Require('fs'),util=Require('util'),path=Require('path'),zlib=Require('zlib'),assert=Require('assert'),cp=Require('child_process'),exec=cp?cp.execFileSync:_;function PNG(file,options){var buf,chunks,idat,pixels;if(!(this instanceof PNG)){return new PNG(file,options);}
if(!file)throw new Error('no file');this.options=options||{};this.colors=options.colors||Require('term/colors');this.optimization=this.options.optimization||'mem';this.speed=this.options.speed||1;if(Buffer.isBuffer(file)){this.file=this.options.filename||null;buf=file;}else{this.options.filename=file;this.file=path.resolve(process.cwd(),file);buf=fs.readFileSync(this.file);}
this.format=buf.readUInt32BE(0)===0x89504e47?'png':buf.slice(0,3).toString('ascii')==='GIF'?'gif':buf.readUInt16BE(0)===0xffd8?'jpg':path.extname(this.file).slice(1).toLowerCase()||'png';if(this.format!=='png'){try{return this.toPNG(buf);}catch(e){throw e;}}
chunks=this.parseRaw(buf);idat=this.parseChunks(chunks);pixels=this.parseLines(idat);this.bmp=this.createBitmap(pixels);this.cellmap=this.createCellmap(this.bmp);this.frames=this.compileFrames(this.frames);}
PNG.prototype.parseRaw=function(buf){var chunks=[],index=0,i=0,buf,len,type,name,data,crc,check,critical,public_,conforming,copysafe,pos;this._debug(this.file);if(buf.readUInt32BE(0)!==0x89504e47||buf.readUInt32BE(4)!==0x0d0a1a0a){throw new Error('bad header');}
i+=8;while(i<buf.length){try{len=buf.readUInt32BE(i);i+=4;pos=i;type=buf.slice(i,i+4);name=type.toString('ascii');i+=4;data=buf.slice(i,i+len);i+=len;check=this.crc32(buf.slice(pos,i));crc=buf.readInt32BE(i);i+=4;critical=!!(~type[0]&32);public_=!!(~type[1]&32);conforming=!!(~type[2]&32);copysafe=!!(~type[3]&32);if(crc!==check){throw new Error(name+': bad crc');}}catch(e){if(this.options.debug)throw e;break;}
chunks.push({index:index++,id:name.toLowerCase(),len:len,pos:pos,end:i,type:type,name:name,data:data,crc:crc,check:check,raw:buf.slice(pos,i),flags:{critical:critical,public_:public_,conforming:conforming,copysafe:copysafe}});}
return chunks;};PNG.prototype.parseChunks=function(chunks){var i,chunk,name,data,p,idat,info;for(i=0;i<chunks.length;i++){chunk=chunks[i];name=chunk.id;data=chunk.data;info={};switch(name){case'ihdr':{this.width=info.width=data.readUInt32BE(0);this.height=info.height=data.readUInt32BE(4);this.bitDepth=info.bitDepth=data.readUInt8(8);this.colorType=info.colorType=data.readUInt8(9);this.compression=info.compression=data.readUInt8(10);this.filter=info.filter=data.readUInt8(11);this.interlace=info.interlace=data.readUInt8(12);switch(this.bitDepth){case 1:case 2:case 4:case 8:case 16:case 24:case 32:break;default:throw new Error('bad bit depth: '+this.bitDepth);}
switch(this.colorType){case 0:case 2:case 3:case 4:case 6:break;default:throw new Error('bad color: '+this.colorType);}
switch(this.compression){case 0:break;default:throw new Error('bad compression: '+this.compression);}
switch(this.filter){case 0:case 1:case 2:case 3:case 4:break;default:throw new Error('bad filter: '+this.filter);}
switch(this.interlace){case 0:case 1:break;default:throw new Error('bad interlace: '+this.interlace);}
break;}
case'plte':{this.palette=info.palette=[];for(p=0;p<data.length;p+=3){this.palette.push({r:data[p+0],g:data[p+1],b:data[p+2],a:255});}
break;}
case'idat':{this.size=this.size||0;this.size+=data.length;this.idat=this.idat||[];this.idat.push(data);info.size=data.length;break;}
case'iend':{this.end=true;break;}
case'trns':{this.alpha=info.alpha=Array.prototype.slice.call(data);if(this.palette){for(p=0;p<data.length;p++){if(!this.palette[p])break;this.palette[p].a=data[p];}}
break;}
case'actl':{this.actl=info={};this.frames=[];this.actl.numFrames=data.readUInt32BE(0);this.actl.numPlays=data.readUInt32BE(4);break;}
case'fctl':{if(!this.idat){this.idat=[];this.frames.push({idat:true,fctl:info,fdat:this.idat});}else{this.frames.push({fctl:info,fdat:[]});}
info.sequenceNumber=data.readUInt32BE(0);info.width=data.readUInt32BE(4);info.height=data.readUInt32BE(8);info.xOffset=data.readUInt32BE(12);info.yOffset=data.readUInt32BE(16);info.delayNum=data.readUInt16BE(20);info.delayDen=data.readUInt16BE(22);info.disposeOp=data.readUInt8(24);info.blendOp=data.readUInt8(25);break;}
case'fdat':{info.sequenceNumber=data.readUInt32BE(0);info.data=data.slice(4);this.frames[this.frames.length-1].fdat.push(info.data);break;}}
chunk.info=info;}
this._debug(chunks);if(this.frames){this.frames=this.frames.map(function(frame,i){frame.fdat=this.decompress(frame.fdat);if(!frame.fdat.length)throw new Error('no data');return frame;},this);}
idat=this.decompress(this.idat);if(!idat.length)throw new Error('no data');return idat;};PNG.prototype.parseLines=function(data){var pixels=[],x,p,prior,line,filter,samples,pendingSamples,ch,shiftStart,i,toShift,sample;this.sampleDepth=this.colorType===0?1:this.colorType===2?3:this.colorType===3?1:this.colorType===4?2:this.colorType===6?4:1;this.bitsPerPixel=this.bitDepth*this.sampleDepth;this.bytesPerPixel=Math.ceil(this.bitsPerPixel/8);this.wastedBits=((this.width*this.bitsPerPixel)/8)-((this.width*this.bitsPerPixel/8)|0);this.byteWidth=Math.ceil(this.width*(this.bitsPerPixel/8));this.shiftStart=((this.bitDepth+(8/this.bitDepth-this.bitDepth))-1)|0;this.shiftMult=this.bitDepth>=8?0:this.bitDepth;this.mask=this.bitDepth===32?0xffffffff:(1<<this.bitDepth)-1;if(this.interlace===1){samples=this.sampleInterlacedLines(data);for(i=0;i<samples.length;i+=this.sampleDepth){pixels.push(samples.slice(i,i+this.sampleDepth));}
return pixels;}
for(p=0;p<data.length;p+=this.byteWidth){prior=line||[];filter=data[p++];line=data.slice(p,p+this.byteWidth);line=this.unfilterLine(filter,line,prior);samples=this.sampleLine(line);for(i=0;i<samples.length;i+=this.sampleDepth){pixels.push(samples.slice(i,i+this.sampleDepth));}}
return pixels;};PNG.prototype.unfilterLine=function(filter,line,prior){for(var x=0;x<line.length;x++){if(filter===0){break;}else if(filter===1){line[x]=this.filters.sub(x,line,prior,this.bytesPerPixel);}else if(filter===2){line[x]=this.filters.up(x,line,prior,this.bytesPerPixel);}else if(filter===3){line[x]=this.filters.average(x,line,prior,this.bytesPerPixel);}else if(filter===4){line[x]=this.filters.paeth(x,line,prior,this.bytesPerPixel);}}
return line;};PNG.prototype.sampleLine=function(line,width){var samples=[],x=0,pendingSamples,ch,i,sample,shiftStart,toShift;while(x<line.length){pendingSamples=this.sampleDepth;while(pendingSamples--){ch=line[x];if(this.bitDepth===16){ch=(ch<<8)|line[++x];}else if(this.bitDepth===24){ch=(ch<<16)|(line[++x]<<8)|line[++x];}else if(this.bitDepth===32){ch=(ch<<24)|(line[++x]<<16)|(line[++x]<<8)|line[++x];}else if(this.bitDepth>32){throw new Error('bitDepth '+this.bitDepth+' unsupported.');}
shiftStart=this.shiftStart;toShift=shiftStart-(x===line.length-1?this.wastedBits:0);for(i=0;i<=toShift;i++){sample=(ch>>(this.shiftMult*shiftStart))&this.mask;if(this.colorType!==3){if(this.bitDepth<8){sample*=0xff/this.mask;sample|=0;}else if(this.bitDepth>8){sample=(sample/this.mask)*255|0;}}
samples.push(sample);shiftStart--;}
x++;}}
if(width!=null){samples=samples.slice(0,width*this.sampleDepth);}
return samples;};PNG.prototype.filters={sub:function Sub(x,line,prior,bpp){if(x<bpp)return line[x];return(line[x]+line[x-bpp])%256;},up:function Up(x,line,prior,bpp){return(line[x]+(prior[x]||0))%256;},average:function Average(x,line,prior,bpp){if(x<bpp)return Math.floor((prior[x]||0)/2);return(line[x]
+Math.floor((line[x-bpp]+prior[x])/2))%256;},paeth:function Paeth(x,line,prior,bpp){if(x<bpp)return prior[x]||0;return(line[x]+this._predictor(line[x-bpp],prior[x]||0,prior[x-bpp]||0))%256;},_predictor:function PaethPredictor(a,b,c){var p=a+b-c,pa=Math.abs(p-a),pb=Math.abs(p-b),pc=Math.abs(p-c);if(pa<=pb&&pa<=pc)return a;if(pb<=pc)return b;return c;}};PNG.prototype.sampleInterlacedLines=function(raw){var psize,vpr,samples,source_offset,i,pass,xstart,ystart,xstep,ystep,recon,ppr,row_size,y,filter_type,scanline,flat,offset,k,end_offset,skip,j,k,f;var adam7=[[0,0,8,8],[4,0,8,8],[0,4,4,8],[2,0,4,4],[0,2,2,4],[1,0,2,2],[0,1,1,2]];psize=(this.bitDepth/8)*this.sampleDepth;vpr=this.width*this.sampleDepth;samples=new Buffer(vpr*this.height);samples.fill(0);source_offset=0;for(i=0;i<adam7.length;i++){pass=adam7[i];xstart=pass[0];ystart=pass[1];xstep=pass[2];ystep=pass[3];if(xstart>=this.width)continue;recon=[];ppr=Math.ceil((this.width-xstart)/xstep);row_size=Math.ceil(psize*ppr);for(y=ystart;y<this.height;y+=ystep){filter_type=raw[source_offset];source_offset+=1;scanline=raw.slice(source_offset,source_offset+row_size);source_offset+=row_size;recon=this.unfilterLine(filter_type,scanline,recon);flat=this.sampleLine(recon,ppr);if(xstep===1){assert.equal(xstart,0);offset=y*vpr;for(k=offset,f=0;k<offset+vpr;k++,f++){samples[k]=flat[f];}}else{offset=y*vpr+xstart*this.sampleDepth;end_offset=(y+1)*vpr;skip=this.sampleDepth*xstep;for(j=0;j<this.sampleDepth;j++){for(k=offset+j,f=j;k<end_offset;k+=skip,f+=this.sampleDepth){samples[k]=flat[f];}}}}}
return samples;};PNG.prototype.createBitmap=function(pixels){var bmp=[],i;if(this.colorType===0){pixels=pixels.map(function(sample){return{r:sample[0],g:sample[0],b:sample[0],a:255};});}else if(this.colorType===2){pixels=pixels.map(function(sample){return{r:sample[0],g:sample[1],b:sample[2],a:255};});}else if(this.colorType===3){pixels=pixels.map(function(sample){if(!this.palette[sample[0]])throw new Error('bad palette index');return this.palette[sample[0]];},this);}else if(this.colorType===4){pixels=pixels.map(function(sample){return{r:sample[0],g:sample[0],b:sample[0],a:sample[1]};});}else if(this.colorType===6){pixels=pixels.map(function(sample){return{r:sample[0],g:sample[1],b:sample[2],a:sample[3]};});}
for(i=0;i<pixels.length;i+=this.width){bmp.push(pixels.slice(i,i+this.width));}
return bmp;};PNG.prototype.createCellmap=function(bmp,options){var bmp=bmp||this.bmp,options=options||this.options,cellmap=[],scale=options.scale||0.20,height=bmp.length,width=bmp[0].length,cmwidth=options.width,cmheight=options.height,line,x,y,xx,yy,scale,xs,ys;if(cmwidth){scale=cmwidth/width;}else if(cmheight){scale=cmheight/height;}
if(!cmheight){cmheight=Math.round(height*scale);}
if(!cmwidth){cmwidth=Math.round(width*scale);}
ys=height/cmheight;xs=width/cmwidth;for(y=0;y<bmp.length;y+=ys){line=[];yy=Math.round(y);if(!bmp[yy])break;for(x=0;x<bmp[yy].length;x+=xs){xx=Math.round(x);if(!bmp[yy][xx])break;line.push(bmp[yy][xx]);}
cellmap.push(line);}
return cellmap;};PNG.prototype.renderANSI=function(bmp){var self=this,out='';bmp.forEach(function(line,y){line.forEach(function(pixel,x){var outch=self.getOutch(x,y,line,pixel);out+=self.pixelToSGR(pixel,outch);});out+='\n';});return out;};PNG.prototype.renderContent=function(bmp,el){var self=this,out='';bmp.forEach(function(line,y){line.forEach(function(pixel,x){var outch=self.getOutch(x,y,line,pixel);out+=self.pixelToTags(pixel,outch);});out+='\n';});el.setContent(out);return out;};PNG.prototype.renderScreen=function(bmp,screen,xi,xl,yi,yl){var self=this,lines=screen.lines,cellLines,y,yy,x,xx,alpha,attr,ch;cellLines=bmp.reduce(function(cellLines,line,y){var cellLine=[];line.forEach(function(pixel,x){var outch=self.getOutch(x,y,line,pixel),cell=self.pixelToCell(pixel,outch);cellLine.push(cell);});cellLines.push(cellLine);return cellLines;},[]);for(y=yi;y<yl;y++){yy=y-yi;for(x=xi;x<xl;x++){xx=x-xi;if(lines[y]&&lines[y][x]&&cellLines[yy]&&cellLines[yy][xx]){alpha=cellLines[yy][xx].pop();if(alpha===0.0){continue;}
if(alpha<1.0){attr=cellLines[yy][xx][0];ch=cellLines[yy][xx][1];lines[y][x][0]=this.colors.blend(lines[y][x][0],attr,alpha);if(ch!==' ')lines[y][x][1]=ch;lines[y].dirty=true;continue;}
lines[y][x]=cellLines[yy][xx];lines[y].dirty=true;}}}};PNG.prototype.renderElement=function(bmp,el){var xi=el.aleft+el.ileft,xl=el.aleft+el.width-el.iright,yi=el.atop+el.itop,yl=el.atop+el.height-el.ibottom;return this.renderScreen(bmp,el.screen,xi,xl,yi,yl);};PNG.prototype.pixelToSGR=function(pixel,ch){var bga=1.0,fga=0.5,a=pixel.a/255,bg,fg;bg=this.colors.match(pixel.r*a*bga|0,pixel.g*a*bga|0,pixel.b*a*bga|0);if(ch&&this.options.ascii){fg=this.colors.match(pixel.r*a*fga|0,pixel.g*a*fga|0,pixel.b*a*fga|0);if(a===0){return'\x1b[38;5;'+fg+'m'+ch+'\x1b[m';}
return'\x1b[38;5;'+fg+'m\x1b[48;5;'+bg+'m'+ch+'\x1b[m';}
if(a===0)return' ';return'\x1b[48;5;'+bg+'m \x1b[m';};PNG.prototype.pixelToTags=function(pixel,ch){var bga=1.0,fga=0.5,a=pixel.a/255,bg,fg;bg=this.colors.RGBtoHex(pixel.r*a*bga|0,pixel.g*a*bga|0,pixel.b*a*bga|0);if(ch&&this.options.ascii){fg=this.colors.RGBtoHex(pixel.r*a*fga|0,pixel.g*a*fga|0,pixel.b*a*fga|0);if(a===0){return'{'+fg+'-fg}'+ch+'{/}';}
return'{'+fg+'-fg}{'+bg+'-bg}'+ch+'{/}';}
if(a===0)return' ';return'{'+bg+'-bg} {/'+bg+'-bg}';};PNG.prototype.pixelToCell=function(pixel,ch){var bga=1.0,fga=0.5,a=pixel.a/255,bg,fg;bg=this.colors.match(pixel.r*bga|0,pixel.g*bga|0,pixel.b*bga|0);if(ch&&this.options.ascii){fg=this.colors.match(pixel.r*fga|0,pixel.g*fga|0,pixel.b*fga|0);}else{fg=0x1ff;ch=null;}
return[(0<<18)|(fg<<9)|(bg<<0),ch||' ',a];};PNG.prototype.getOutch=(function(){var dchars='????8@8@#8@8##8#MKXWwz$&%x><\\/xo;+=|^-:i\'.`,  `.        ';var luminance=function(pixel){var a=pixel.a/255,r=pixel.r*a,g=pixel.g*a,b=pixel.b*a,l=0.2126*r+0.7152*g+0.0722*b;return l/255;};return function(x,y,line,pixel){var lumi=luminance(pixel),outch=dchars[lumi*(dchars.length-1)|0];return outch;};})();PNG.prototype.compileFrames=function(frames){return this.optimization==='mem'?this.compileFrames_lomem(frames):this.compileFrames_locpu(frames);};PNG.prototype.compileFrames_lomem=function(frames){if(!this.actl)return;return frames.map(function(frame,i){this.width=frame.fctl.width;this.height=frame.fctl.height;var pixels=frame._pixels||this.parseLines(frame.fdat),bmp=frame._bmp||this.createBitmap(pixels),fc=frame.fctl;return{actl:this.actl,fctl:frame.fctl,delay:(fc.delayNum/(fc.delayDen||100))*1000|0,bmp:bmp};},this);};PNG.prototype.compileFrames_locpu=function(frames){if(!this.actl)return;this._curBmp=null;this._lastBmp=null;return frames.map(function(frame,i){this.width=frame.fctl.width;this.height=frame.fctl.height;var pixels=frame._pixels||this.parseLines(frame.fdat),bmp=frame._bmp||this.createBitmap(pixels),renderBmp=this.renderFrame(bmp,frame,i),cellmap=this.createCellmap(renderBmp),fc=frame.fctl;return{actl:this.actl,fctl:frame.fctl,delay:(fc.delayNum/(fc.delayDen||100))*1000|0,bmp:renderBmp,cellmap:cellmap};},this);};PNG.prototype.renderFrame=function(bmp,frame,i){var first=this.frames[0],last=this.frames[i-1],fc=frame.fctl,xo=fc.xOffset,yo=fc.yOffset,lxo,lyo,x,y,line,p;if(!this._curBmp){this._curBmp=[];for(y=0;y<first.fctl.height;y++){line=[];for(x=0;x<first.fctl.width;x++){p=bmp[y][x];line.push({r:p.r,g:p.g,b:p.b,a:p.a});}
this._curBmp.push(line);}}
if(last&&last.fctl.disposeOp!==0){lxo=last.fctl.xOffset;lyo=last.fctl.yOffset;for(y=0;y<last.fctl.height;y++){for(x=0;x<last.fctl.width;x++){if(last.fctl.disposeOp===0){}else if(last.fctl.disposeOp===1){this._curBmp[lyo+y][lxo+x]={r:0,g:0,b:0,a:0};}else if(last.fctl.disposeOp===2){p=this._lastBmp[y][x];this._curBmp[lyo+y][lxo+x]={r:p.r,g:p.g,b:p.b,a:p.a};}}}}
if(frame.fctl.disposeOp===2){this._lastBmp=[];for(y=0;y<frame.fctl.height;y++){line=[];for(x=0;x<frame.fctl.width;x++){p=this._curBmp[yo+y][xo+x];line.push({r:p.r,g:p.g,b:p.b,a:p.a});}
this._lastBmp.push(line);}}else{this._lastBmp=null;}
for(y=0;y<frame.fctl.height;y++){for(x=0;x<frame.fctl.width;x++){p=bmp[y][x];if(fc.blendOp===0){this._curBmp[yo+y][xo+x]={r:p.r,g:p.g,b:p.b,a:p.a};}else if(fc.blendOp===1){if(p.a!==0){this._curBmp[yo+y][xo+x]={r:p.r,g:p.g,b:p.b,a:p.a};}}}}
return this._curBmp;};PNG.prototype._animate=function(callback){if(!this.frames){return callback(this.bmp,this.cellmap);}
var self=this,numPlays=this.actl.numPlays||Infinity,running=0,i=-1;this._curBmp=null;this._lastBmp=null;var next_lomem=function(){if(!running)return;var frame=self.frames[++i];if(!frame){if(!--numPlays)return callback();i=-1;self._curBmp=null;self._lastBmp=null;return setImmediate(next);}
var bmp=frame.bmp,renderBmp=self.renderFrame(bmp,frame,i),cellmap=self.createCellmap(renderBmp);callback(renderBmp,cellmap);return setTimeout(next,frame.delay/self.speed|0);};var next_locpu=function(){if(!running)return;var frame=self.frames[++i];if(!frame){if(!--numPlays)return callback();i=-1;return setImmediate(next);}
callback(frame.bmp,frame.cellmap);return setTimeout(next,frame.delay/self.speed|0);};var next=this.optimization==='mem'?next_lomem:next_locpu;this._control=function(state){if(state===-1){i=-1;self._curBmp=null;self._lastBmp=null;running=0;callback(self.frames[0].bmp,self.frames[0].cellmap||self.createCellmap(self.frames[0].bmp));return;}
if(state===running)return;running=state;return next();};this._control(1);};PNG.prototype.play=function(callback){if(!this._control||callback){this.stop();return this._animate(callback);}
this._control(1);};PNG.prototype.pause=function(){if(!this._control)return;this._control(0);};PNG.prototype.stop=function(){if(!this._control)return;this._control(-1);};PNG.prototype.toPNG=function(input){var options=this.options,file=this.file,format=this.format,buf,img,gif,i,control,disposeOp;if(format!=='gif'){buf=exec('convert',[format+':-','png:-'],{stdio:['pipe','pipe','ignore'],input:input});img=PNG(buf,options);img.file=file;return img;}
gif=GIF(input,options);this.width=gif.width;this.height=gif.height;this.frames=[];for(i=0;i<gif.images.length;i++){img=gif.images[i];control=img.control||gif;disposeOp=Math.max(0,(control.disposeMethod||0)-1);if(disposeOp>2)disposeOp=0;this.frames.push({fctl:{sequenceNumber:i,width:img.width,height:img.height,xOffset:img.left,yOffset:img.top,delayNum:control.delay,delayDen:100,disposeOp:disposeOp,blendOp:1},fdat:[],_pixels:[],_bmp:img.bmp});}
this.bmp=this.frames[0]._bmp;this.cellmap=this.createCellmap(this.bmp);if(this.frames.length>1){this.actl={numFrames:gif.images.length,numPlays:gif.numPlays||0};this.frames=this.compileFrames(this.frames);}else{this.frames=undefined;}
return this;};PNG.prototype.gifMagick=function(input){var options=this.options,file=this.file,format=this.format,buf,fmt,img,frames,frame,width,height,iwidth,twidth,i,lines,line,x,y;buf=exec('convert',[format+':-','-coalesce','+append','png:-'],{stdio:['pipe','pipe','ignore'],input:input});fmt='{"W":%W,"H":%H,"w":%w,"h":%h,"d":%T,"x":"%X","y":"%Y"},'
frames=exec('identify',['-format',fmt,format+':-'],{encoding:'utf8',stdio:['pipe','pipe','ignore'],input:input});frames=JSON.parse('['+frames.trim().slice(0,-1)+']');img=PNG(buf,options);img.file=file;Object.keys(img).forEach(function(key){this[key]=img[key];},this);width=frames[0].W;height=frames[0].H;iwidth=0;twidth=0;this.width=width;this.height=height;this.frames=[];for(i=0;i<frames.length;i++){frame=frames[i];frame.x=+frame.x;frame.y=+frame.y;iwidth=twidth;twidth+=width;lines=[];for(y=frame.y;y<height;y++){line=[];for(x=iwidth+frame.x;x<twidth;x++){line.push(img.bmp[y][x]);}
lines.push(line);}
this.frames.push({fctl:{sequenceNumber:i,width:frame.w,height:frame.h,xOffset:frame.x,yOffset:frame.y,delayNum:frame.d,delayDen:100,disposeOp:0,blendOp:0},fdat:[],_pixels:[],_bmp:lines});}
this.bmp=this.frames[0]._bmp;this.cellmap=this.createCellmap(this.bmp);if(this.frames.length>1){this.actl={numFrames:frames.length,numPlays:0};this.frames=this.compileFrames(this.frames);}else{this.frames=undefined;}
return this;};PNG.prototype.decompress=function(buffers){return zlib.inflateSync(new Buffer(buffers.reduce(function(out,data){return out.concat(Array.prototype.slice.call(data));},[])));};PNG.prototype.crc32=(function(){var crcTable=[0x00000000,0x77073096,0xee0e612c,0x990951ba,0x076dc419,0x706af48f,0xe963a535,0x9e6495a3,0x0edb8832,0x79dcb8a4,0xe0d5e91e,0x97d2d988,0x09b64c2b,0x7eb17cbd,0xe7b82d07,0x90bf1d91,0x1db71064,0x6ab020f2,0xf3b97148,0x84be41de,0x1adad47d,0x6ddde4eb,0xf4d4b551,0x83d385c7,0x136c9856,0x646ba8c0,0xfd62f97a,0x8a65c9ec,0x14015c4f,0x63066cd9,0xfa0f3d63,0x8d080df5,0x3b6e20c8,0x4c69105e,0xd56041e4,0xa2677172,0x3c03e4d1,0x4b04d447,0xd20d85fd,0xa50ab56b,0x35b5a8fa,0x42b2986c,0xdbbbc9d6,0xacbcf940,0x32d86ce3,0x45df5c75,0xdcd60dcf,0xabd13d59,0x26d930ac,0x51de003a,0xc8d75180,0xbfd06116,0x21b4f4b5,0x56b3c423,0xcfba9599,0xb8bda50f,0x2802b89e,0x5f058808,0xc60cd9b2,0xb10be924,0x2f6f7c87,0x58684c11,0xc1611dab,0xb6662d3d,0x76dc4190,0x01db7106,0x98d220bc,0xefd5102a,0x71b18589,0x06b6b51f,0x9fbfe4a5,0xe8b8d433,0x7807c9a2,0x0f00f934,0x9609a88e,0xe10e9818,0x7f6a0dbb,0x086d3d2d,0x91646c97,0xe6635c01,0x6b6b51f4,0x1c6c6162,0x856530d8,0xf262004e,0x6c0695ed,0x1b01a57b,0x8208f4c1,0xf50fc457,0x65b0d9c6,0x12b7e950,0x8bbeb8ea,0xfcb9887c,0x62dd1ddf,0x15da2d49,0x8cd37cf3,0xfbd44c65,0x4db26158,0x3ab551ce,0xa3bc0074,0xd4bb30e2,0x4adfa541,0x3dd895d7,0xa4d1c46d,0xd3d6f4fb,0x4369e96a,0x346ed9fc,0xad678846,0xda60b8d0,0x44042d73,0x33031de5,0xaa0a4c5f,0xdd0d7cc9,0x5005713c,0x270241aa,0xbe0b1010,0xc90c2086,0x5768b525,0x206f85b3,0xb966d409,0xce61e49f,0x5edef90e,0x29d9c998,0xb0d09822,0xc7d7a8b4,0x59b33d17,0x2eb40d81,0xb7bd5c3b,0xc0ba6cad,0xedb88320,0x9abfb3b6,0x03b6e20c,0x74b1d29a,0xead54739,0x9dd277af,0x04db2615,0x73dc1683,0xe3630b12,0x94643b84,0x0d6d6a3e,0x7a6a5aa8,0xe40ecf0b,0x9309ff9d,0x0a00ae27,0x7d079eb1,0xf00f9344,0x8708a3d2,0x1e01f268,0x6906c2fe,0xf762575d,0x806567cb,0x196c3671,0x6e6b06e7,0xfed41b76,0x89d32be0,0x10da7a5a,0x67dd4acc,0xf9b9df6f,0x8ebeeff9,0x17b7be43,0x60b08ed5,0xd6d6a3e8,0xa1d1937e,0x38d8c2c4,0x4fdff252,0xd1bb67f1,0xa6bc5767,0x3fb506dd,0x48b2364b,0xd80d2bda,0xaf0a1b4c,0x36034af6,0x41047a60,0xdf60efc3,0xa867df55,0x316e8eef,0x4669be79,0xcb61b38c,0xbc66831a,0x256fd2a0,0x5268e236,0xcc0c7795,0xbb0b4703,0x220216b9,0x5505262f,0xc5ba3bbe,0xb2bd0b28,0x2bb45a92,0x5cb36a04,0xc2d7ffa7,0xb5d0cf31,0x2cd99e8b,0x5bdeae1d,0x9b64c2b0,0xec63f226,0x756aa39c,0x026d930a,0x9c0906a9,0xeb0e363f,0x72076785,0x05005713,0x95bf4a82,0xe2b87a14,0x7bb12bae,0x0cb61b38,0x92d28e9b,0xe5d5be0d,0x7cdcefb7,0x0bdbdf21,0x86d3d2d4,0xf1d4e242,0x68ddb3f8,0x1fda836e,0x81be16cd,0xf6b9265b,0x6fb077e1,0x18b74777,0x88085ae6,0xff0f6a70,0x66063bca,0x11010b5c,0x8f659eff,0xf862ae69,0x616bffd3,0x166ccf45,0xa00ae278,0xd70dd2ee,0x4e048354,0x3903b3c2,0xa7672661,0xd06016f7,0x4969474d,0x3e6e77db,0xaed16a4a,0xd9d65adc,0x40df0b66,0x37d83bf0,0xa9bcae53,0xdebb9ec5,0x47b2cf7f,0x30b5ffe9,0xbdbdf21c,0xcabac28a,0x53b39330,0x24b4a3a6,0xbad03605,0xcdd70693,0x54de5729,0x23d967bf,0xb3667a2e,0xc4614ab8,0x5d681b02,0x2a6f2b94,0xb40bbe37,0xc30c8ea1,0x5a05df1b,0x2d02ef8d];return function crc32(buf){var crc=-1;for(var i=0,len=buf.length;i<len;i++){crc=crcTable[(crc^buf[i])&0xff]^(crc>>>8);}
return crc^-1;};})();PNG.prototype._debug=function(){if(!this.options.log)return;return this.options.log.apply(null,arguments);};function GIF(file,options){var self=this;if(!(this instanceof GIF)){return new GIF(file,options);}
var info={},p=0,buf,i,total,sig,desc,img,ext,label,size;if(!file)throw new Error('no file');options=options||{};this.options=options;this.pixelLimit=this.options.pixelLimit||7622550;this.totalPixels=0;if(Buffer.isBuffer(file)){buf=file;file=null;}else{file=path.resolve(process.cwd(),file);buf=fs.readFileSync(file);}
sig=buf.slice(0,6).toString('ascii');if(sig!=='GIF87a'&&sig!=='GIF89a'){throw new Error('bad header: '+sig);}
this.width=buf.readUInt16LE(6);this.height=buf.readUInt16LE(8);this.flags=buf.readUInt8(10);this.gct=!!(this.flags&0x80);this.gctsize=(this.flags&0x07)+1;this.bgIndex=buf.readUInt8(11);this.aspect=buf.readUInt8(12);p+=13;if(this.gct){this.colors=[];total=1<<this.gctsize;for(i=0;i<total;i++,p+=3){this.colors.push([buf[p],buf[p+1],buf[p+2],255]);}}
this.images=[];this.extensions=[];try{while(p<buf.length){desc=buf.readUInt8(p);p+=1;if(desc===0x2c){img={};img.left=buf.readUInt16LE(p);p+=2;img.top=buf.readUInt16LE(p);p+=2;img.width=buf.readUInt16LE(p);p+=2;img.height=buf.readUInt16LE(p);p+=2;img.flags=buf.readUInt8(p);p+=1;img.lct=!!(img.flags&0x80);img.ilace=!!(img.flags&0x40);img.lctsize=(img.flags&0x07)+1;if(img.lct){img.lcolors=[];total=1<<img.lctsize;for(i=0;i<total;i++,p+=3){img.lcolors.push([buf[p],buf[p+1],buf[p+2],255]);}}
img.codeSize=buf.readUInt8(p);p+=1;img.size=buf.readUInt8(p);p+=1;img.lzw=[buf.slice(p,p+img.size)];p+=img.size;while(buf[p]!==0x00){if(buf[p]===0x3b&&p===buf.length-1){p--;break;}
size=buf.readUInt8(p);p+=1;img.lzw.push(buf.slice(p,p+size));p+=size;}
assert.equal(buf.readUInt8(p),0x00);p+=1;if(ext&&ext.label===0xf9){img.control=ext;}
this.totalPixels+=img.width*img.height;this.images.push(img);if(this.totalPixels>=this.pixelLimit){break;}}else if(desc===0x21){ext={};label=buf.readUInt8(p);p+=1;ext.label=label;if(label===0xf9){size=buf.readUInt8(p);assert.equal(size,0x04);p+=1;ext.fields=buf.readUInt8(p);ext.disposeMethod=(ext.fields>>2)&0x07;ext.useTransparent=!!(ext.fields&0x01);p+=1;ext.delay=buf.readUInt16LE(p);p+=2;ext.transparentColor=buf.readUInt8(p);p+=1;while(buf[p]!==0x00){size=buf.readUInt8(p);p+=1;p+=size;}
assert.equal(buf.readUInt8(p),0x00);p+=1;this.delay=ext.delay;this.transparentColor=ext.transparentColor;this.disposeMethod=ext.disposeMethod;this.useTransparent=ext.useTransparent;}else if(label===0xff){size=buf.readUInt8(p);p+=1;ext.id=buf.slice(p,p+8).toString('ascii');p+=8;ext.auth=buf.slice(p,p+3).toString('ascii');p+=3;ext.data=[];while(buf[p]!==0x00){size=buf.readUInt8(p);p+=1;ext.data.push(buf.slice(p,p+size));p+=size;}
ext.data=new Buffer(ext.data.reduce(function(out,data){return out.concat(Array.prototype.slice.call(data));},[]));if(ext.id==='ANIMEXTS'&&ext.auth==='1.0'){ext.id='NETSCAPE';ext.auth='2.0';ext.animexts=true;}
if(ext.id==='NETSCAPE'&&ext.auth==='2.0'){if(ext.data.readUInt8(0)===0x01){ext.numPlays=ext.data.readUInt16LE(1);this.numPlays=ext.numPlays;}else if(ext.data.readUInt8(0)===0x02){this.minBuffer=ext.data;}}
if(ext.id==='XMP Data'&&ext.auth==='XMP'){ext.xmp=ext.data.toString('utf8');this.xmp=ext.xmp;}
if(ext.id==='ICCRGBG1'&&ext.auth==='012'){this.icc=ext.data;}
if(ext.id==='fractint'&&/^00[1-7]$/.test(ext.auth)){this.fractint=ext.data;}
assert.equal(buf.readUInt8(p),0x00);p+=1;}else{ext.data=[];while(buf[p]!==0x00){size=buf.readUInt8(p);p+=1;ext.data.push(buf.slice(p,p+size));p+=size;}
assert.equal(buf.readUInt8(p),0x00);p+=1;}
this.extensions.push(ext);}else if(desc===0x3b){break;}else if(p===buf.length-1){break;}else{throw new Error('unknown block');}}}catch(e){if(options.debug){throw e;}}
this.images=this.images.map(function(img,imageIndex){var control=img.control||this;img.lzw=new Buffer(img.lzw.reduce(function(out,data){return out.concat(Array.prototype.slice.call(data));},[]));try{img.data=this.decompress(img.lzw,img.codeSize);}catch(e){if(options.debug)throw e;return;}
var interlacing=[[0,8],[4,8],[2,4],[1,2],[0,0]];var table=img.lcolors||this.colors,row=0,col=0,ilp=0,p=0,b,idx,i,y,x,line,pixel;img.samples=[];for(;;){b=img.data[p++];if(b==null)break;idx=(row*img.width+col)*4;if(!table[b]){if(options.debug)throw new Error('bad samples');table[b]=[0,0,0,0];}
img.samples[idx]=table[b][0];img.samples[idx+1]=table[b][1];img.samples[idx+2]=table[b][2];img.samples[idx+3]=table[b][3];if(control.useTransparent&&b===control.transparentColor){img.samples[idx+3]=0;}
if(++col>=img.width){col=0;if(img.ilace){row+=interlacing[ilp][1];if(row>=img.height){row=interlacing[++ilp][0];}}else{row++;}}}
img.pixels=[];for(i=0;i<img.samples.length;i+=4){img.pixels.push(img.samples.slice(i,i+4));}
img.bmp=[];for(y=0,p=0;y<img.height;y++){line=[];for(x=0;x<img.width;x++){pixel=img.pixels[p++];if(!pixel){if(options.debug)throw new Error('no pixel');line.push({r:0,g:0,b:0,a:0});continue;}
line.push({r:pixel[0],g:pixel[1],b:pixel[2],a:pixel[3]});}
img.bmp.push(line);}
return img;},this).filter(Boolean);if(!this.images.length){throw new Error('no image data or bad decompress');}}
GIF.prototype.decompress=function(input,codeSize){var bitDepth=codeSize+1,CC=1<<codeSize,EOI=CC+1,stack=[],table=[],ntable=0,oldCode=null,buffer=0,nbuffer=0,p=0,buf=[],bits,read,ans,n,code,i,K,b,maxElem;for(;;){if(stack.length===0){bits=bitDepth;read=0;ans=0;while(read<bits){if(nbuffer===0){if(p>=input.length)return buf;buffer=input[p++];nbuffer=8;}
n=Math.min(bits-read,nbuffer);ans|=(buffer&((1<<n)-1))<<read;read+=n;nbuffer-=n;buffer>>=n;}
code=ans;if(code===EOI){break;}
if(code===CC){table=[];for(i=0;i<CC;++i){table[i]=[i,-1,i];}
bitDepth=codeSize+1;maxElem=1<<bitDepth;ntable=CC+2;oldCode=null;continue;}
if(oldCode===null){oldCode=code;buf.push(table[code][0]);continue;}
if(code<ntable){for(i=code;i>=0;i=table[i][1]){stack.push(table[i][0]);}
table[ntable++]=[table[code][2],oldCode,table[oldCode][2]];}else{K=table[oldCode][2];table[ntable++]=[K,oldCode,K];for(i=code;i>=0;i=table[i][1]){stack.push(table[i][0]);}}
oldCode=code;if(ntable===maxElem){maxElem=1<<(++bitDepth);if(bitDepth>12)bitDepth=12;}}
b=stack.pop();if(b==null)break;buf.push(b);}
return buf;};exports=PNG;exports.png=PNG;exports.gif=GIF;module.exports=exports;};BundleModuleCode['term/widgets/overlayimage']=function(module,exports){var Comp=Require('com/compat');var fs=Require('fs'),cp=Require('child_process');var helpers=Require('term/helpers');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');function OverlayImage(options){var self=this;if(!instanceOf(this,Node)){return new OverlayImage(options);}
options=options||{};Box.call(this,options);if(options.w3m){OverlayImage.w3mdisplay=options.w3m;}
if(OverlayImage.hasW3MDisplay==null){if(fs.existsSync(OverlayImage.w3mdisplay)){OverlayImage.hasW3MDisplay=true;}else if(options.search!==false){var file=helpers.findFile('/usr','w3mimgdisplay')||helpers.findFile('/lib','w3mimgdisplay')||helpers.findFile('/bin','w3mimgdisplay');if(file){OverlayImage.hasW3MDisplay=true;OverlayImage.w3mdisplay=file;}else{OverlayImage.hasW3MDisplay=false;}}}
this.on('hide',function(){self._lastFile=self.file;self.clearImage();});this.on('show',function(){if(!self._lastFile)return;self.setImage(self._lastFile);});this.on('detach',function(){self._lastFile=self.file;self.clearImage();});this.on('attach',function(){if(!self._lastFile)return;self.setImage(self._lastFile);});this.onScreenEvent('resize',function(){self._needsRatio=true;});this.onScreenEvent('render',function(){self.screen.program.flush();if(!self._noImage){self.setImage(self.file);}});if(this.options.file||this.options.img){this.setImage(this.options.file||this.options.img);}}
inheritPrototype(OverlayImage,Box);OverlayImage.prototype.type='overlayimage';OverlayImage.w3mdisplay='/usr/lib/w3m/w3mimgdisplay';OverlayImage.prototype.spawn=function(file,args,opt,callback){var spawn=require('child_process').spawn,ps;opt=opt||{};ps=spawn(file,args,opt);ps.on('error',function(err){if(!callback)return;return callback(err);});ps.on('exit',function(code){if(!callback)return;if(code!==0)return callback(new Error('Exit Code: '+code));return callback(null,code===0);});return ps;};OverlayImage.prototype.setImage=function(img,callback){var self=this;if(this._settingImage){this._queue=this._queue||[];this._queue.push([img,callback]);return;}
this._settingImage=true;var reset=function(){self._settingImage=false;self._queue=self._queue||[];var item=self._queue.shift();if(item){self.setImage(item[0],item[1]);}};if(OverlayImage.hasW3MDisplay===false){reset();if(!callback)return;return callback(new Error('W3M Image Display not available.'));}
if(!img){reset();if(!callback)return;return callback(new Error('No image.'));}
this.file=img;return this.getPixelRatio(function(err,ratio){if(err){reset();if(!callback)return;return callback(err);}
return self.renderImage(img,ratio,function(err,success){if(err){reset();if(!callback)return;return callback(err);}
if(self.shrink||self.options.autofit){delete self.shrink;delete self.options.shrink;self.options.autofit=true;return self.imageSize(function(err,size){if(err){reset();if(!callback)return;return callback(err);}
if(self._lastSize&&ratio.tw===self._lastSize.tw&&ratio.th===self._lastSize.th&&size.width===self._lastSize.width&&size.height===self._lastSize.height&&self.aleft===self._lastSize.aleft&&self.atop===self._lastSize.atop){reset();if(!callback)return;return callback(null,success);}
self._lastSize={tw:ratio.tw,th:ratio.th,width:size.width,height:size.height,aleft:self.aleft,atop:self.atop};self.position.width=size.width/ratio.tw|0;self.position.height=size.height/ratio.th|0;self._noImage=true;self.screen.render();self._noImage=false;reset();return self.renderImage(img,ratio,callback);});}
reset();if(!callback)return;return callback(null,success);});});};OverlayImage.prototype.renderImage=function(img,ratio,callback){var self=this;if(cp.execSync){callback=callback||function(err,result){return result;};try{return callback(null,this.renderImageSync(img,ratio));}catch(e){return callback(e);}}
if(OverlayImage.hasW3MDisplay===false){if(!callback)return;return callback(new Error('W3M Image Display not available.'));}
if(!ratio){if(!callback)return;return callback(new Error('No ratio.'));}
var _file=self.file;var _lastSize=self._lastSize;return self.clearImage(function(err){if(err)return callback(err);self.file=_file;self._lastSize=_lastSize;var opt={stdio:'pipe',env:process.env,cwd:process.env.HOME};var ps=self.spawn(OverlayImage.w3mdisplay,[],opt,function(err,success){if(!callback)return;return err?callback(err):callback(null,success);});var width=self.width*ratio.tw|0,height=self.height*ratio.th|0,aleft=self.aleft*ratio.tw|0,atop=self.atop*ratio.th|0;var input='0;1;'
+aleft+';'
+atop+';'
+width+';'
+height+';;;;;'
+img
+'\n4;\n3;\n';self._props={aleft:aleft,atop:atop,width:width,height:height};ps.stdin.write(input);ps.stdin.end();});};OverlayImage.prototype.clearImage=function(callback){if(cp.execSync){callback=callback||function(err,result){return result;};try{return callback(null,this.clearImageSync());}catch(e){return callback(e);}}
if(OverlayImage.hasW3MDisplay===false){if(!callback)return;return callback(new Error('W3M Image Display not available.'));}
if(!this._props){if(!callback)return;return callback(null);}
var opt={stdio:'pipe',env:process.env,cwd:process.env.HOME};var ps=this.spawn(OverlayImage.w3mdisplay,[],opt,function(err,success){if(!callback)return;return err?callback(err):callback(null,success);});var width=this._props.width+2,height=this._props.height+2,aleft=this._props.aleft,atop=this._props.atop;if(this._drag){aleft-=10;atop-=10;width+=10;height+=10;}
var input='6;'
+aleft+';'
+atop+';'
+width+';'
+height
+'\n4;\n3;\n';delete this.file;delete this._props;delete this._lastSize;ps.stdin.write(input);ps.stdin.end();};OverlayImage.prototype.imageSize=function(callback){var img=this.file;if(cp.execSync){callback=callback||function(err,result){return result;};try{return callback(null,this.imageSizeSync());}catch(e){return callback(e);}}
if(OverlayImage.hasW3MDisplay===false){if(!callback)return;return callback(new Error('W3M Image Display not available.'));}
if(!img){if(!callback)return;return callback(new Error('No image.'));}
var opt={stdio:'pipe',env:process.env,cwd:process.env.HOME};var ps=this.spawn(OverlayImage.w3mdisplay,[],opt);var buf='';ps.stdout.setEncoding('utf8');ps.stdout.on('data',function(data){buf+=data;});ps.on('error',function(err){if(!callback)return;return callback(err);});ps.on('exit',function(){if(!callback)return;var size=buf.trim().split(/\s+/);return callback(null,{raw:buf.trim(),width:+size[0],height:+size[1]});});var input='5;'+img+'\n';ps.stdin.write(input);ps.stdin.end();};OverlayImage.prototype.termSize=function(callback){var self=this;if(cp.execSync){callback=callback||function(err,result){return result;};try{return callback(null,this.termSizeSync());}catch(e){return callback(e);}}
if(OverlayImage.hasW3MDisplay===false){if(!callback)return;return callback(new Error('W3M Image Display not available.'));}
var opt={stdio:'pipe',env:process.env,cwd:process.env.HOME};var ps=this.spawn(OverlayImage.w3mdisplay,['-test'],opt);var buf='';ps.stdout.setEncoding('utf8');ps.stdout.on('data',function(data){buf+=data;});ps.on('error',function(err){if(!callback)return;return callback(err);});ps.on('exit',function(){if(!callback)return;if(!buf.trim()){return self.termSize(callback);}
var size=buf.trim().split(/\s+/);return callback(null,{raw:buf.trim(),width:+size[0],height:+size[1]});});ps.stdin.end();};OverlayImage.prototype.getPixelRatio=function(callback){var self=this;if(cp.execSync){callback=callback||function(err,result){return result;};try{return callback(null,this.getPixelRatioSync());}catch(e){return callback(e);}}
if(this._ratio&&!this._needsRatio){return callback(null,this._ratio);}
return this.termSize(function(err,dimensions){if(err)return callback(err);self._ratio={tw:dimensions.width/self.screen.width,th:dimensions.height/self.screen.height};self._needsRatio=false;return callback(null,self._ratio);});};OverlayImage.prototype.renderImageSync=function(img,ratio){if(OverlayImage.hasW3MDisplay===false){throw new Error('W3M Image Display not available.');}
if(!ratio){throw new Error('No ratio.');}
var _file=this.file;var _lastSize=this._lastSize;this.clearImageSync();this.file=_file;this._lastSize=_lastSize;var width=this.width*ratio.tw|0,height=this.height*ratio.th|0,aleft=this.aleft*ratio.tw|0,atop=this.atop*ratio.th|0;var input='0;1;'
+aleft+';'
+atop+';'
+width+';'
+height+';;;;;'
+img
+'\n4;\n3;\n';this._props={aleft:aleft,atop:atop,width:width,height:height};try{cp.execFileSync(OverlayImage.w3mdisplay,[],{env:process.env,encoding:'utf8',input:input,timeout:1000});}catch(e){;}
return true;};OverlayImage.prototype.clearImageSync=function(){if(OverlayImage.hasW3MDisplay===false){throw new Error('W3M Image Display not available.');}
if(!this._props){return false;}
var width=this._props.width+2,height=this._props.height+2,aleft=this._props.aleft,atop=this._props.atop;if(this._drag){aleft-=10;atop-=10;width+=10;height+=10;}
var input='6;'
+aleft+';'
+atop+';'
+width+';'
+height
+'\n4;\n3;\n';delete this.file;delete this._props;delete this._lastSize;try{cp.execFileSync(OverlayImage.w3mdisplay,[],{env:process.env,encoding:'utf8',input:input,timeout:1000});}catch(e){;}
return true;};OverlayImage.prototype.imageSizeSync=function(){var img=this.file;if(OverlayImage.hasW3MDisplay===false){throw new Error('W3M Image Display not available.');}
if(!img){throw new Error('No image.');}
var buf='';var input='5;'+img+'\n';try{buf=cp.execFileSync(OverlayImage.w3mdisplay,[],{env:process.env,encoding:'utf8',input:input,timeout:1000});}catch(e){;}
var size=buf.trim().split(/\s+/);return{raw:buf.trim(),width:+size[0],height:+size[1]};};OverlayImage.prototype.termSizeSync=function(_,recurse){if(OverlayImage.hasW3MDisplay===false){throw new Error('W3M Image Display not available.');}
var buf='';try{buf=cp.execFileSync(OverlayImage.w3mdisplay,['-test'],{env:process.env,encoding:'utf8',timeout:1000});}catch(e){;}
if(!buf.trim()){recurse=recurse||0;if(++recurse===5){throw new Error('Term size not determined.');}
return this.termSizeSync(_,recurse);}
var size=buf.trim().split(/\s+/);return{raw:buf.trim(),width:+size[0],height:+size[1]};};OverlayImage.prototype.getPixelRatioSync=function(){if(this._ratio&&!this._needsRatio){return this._ratio;}
this._needsRatio=false;var dimensions=this.termSizeSync();this._ratio={tw:dimensions.width/this.screen.width,th:dimensions.height/this.screen.height};return this._ratio;};OverlayImage.prototype.displayImage=function(callback){return this.screen.displayImage(this.file,callback);};module.exports=OverlayImage;};BundleModuleCode['term/widgets/video']=function(module,exports){var Comp=Require('com/compat');var cp=Require('child_process');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var Terminal=Require('term/widgets/terminal');function Video(options){var self=this,shell,args;if(!instanceOf(this,Node)){return new Video(options);}
options=options||{};Box.call(this,options);if(this.exists('mplayer')){shell='mplayer';args=['-vo','caca','-quiet',options.file];}else if(this.exists('mpv')){shell='mpv';args=['--vo','caca','--really-quiet',options.file];}else{this.parseTags=true;this.setContent('{red-fg}{bold}Error:{/bold}'
+' mplayer or mpv not installed.{/red-fg}');return this;}
var opts={parent:this,left:0,top:0,width:this.width-this.iwidth,height:this.height-this.iheight,shell:shell,args:args.slice()};this.now=Date.now()/1000|0;this.start=opts.start||0;if(this.start){if(shell==='mplayer'){opts.args.unshift('-ss',this.start+'');}else if(shell==='mpv'){opts.args.unshift('--start',this.start+'');}}
var DISPLAY=process.env.DISPLAY;delete process.env.DISPLAY;this.tty=new Terminal(opts);process.env.DISPLAY=DISPLAY;this.on('click',function(){self.tty.pty.write('p');});this.on('resize',function(){self.tty.destroy();var opts={parent:self,left:0,top:0,width:self.width-self.iwidth,height:self.height-self.iheight,shell:shell,args:args.slice()};var watched=(Date.now()/1000|0)-self.now;self.now=Date.now()/1000|0;self.start+=watched;if(shell==='mplayer'){opts.args.unshift('-ss',self.start+'');}else if(shell==='mpv'){opts.args.unshift('--start',self.start+'');}
var DISPLAY=process.env.DISPLAY;delete process.env.DISPLAY;self.tty=new Terminal(opts);process.env.DISPLAY=DISPLAY;self.screen.render();});}
inheritPrototype(Video,Box);Video.prototype.type='video';Video.prototype.exists=function(program){try{return!!+cp.execSync('type '
+program+' > /dev/null 2> /dev/null'
+' && echo 1',{encoding:'utf8'}).trim();}catch(e){return false;}};module.exports=Video;};BundleModuleCode['term/widgets/layout']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Element=Require('term/widgets/element');function Layout(options){if(!instanceOf(this,Node)){return new Layout(options);}
options=options||{};if((options.width==null&&(options.left==null&&options.right==null))||(options.height==null&&(options.top==null&&options.bottom==null))){throw new Error('`Layout` must have a width and height!');}
options.layout=options.layout||'inline';Element.call(this,options);if(options.renderer){this.renderer=options.renderer;}}
inheritPrototype(Layout,Element);Layout.prototype.type='layout';Layout.prototype.isRendered=function(el){if(!el.lpos)return false;return(el.lpos.xl-el.lpos.xi)>0&&(el.lpos.yl-el.lpos.yi)>0;};Layout.prototype.getLast=function(i){while(this.children[--i]){var el=this.children[i];if(this.isRendered(el))return el;}};Layout.prototype.getLastCoords=function(i){var last=this.getLast(i);if(last)return last.lpos;};Layout.prototype._renderCoords=function(){var coords=this._getCoords(true);var children=this.children;this.children=[];this._render();this.children=children;return coords;};Layout.prototype.renderer=function(coords){var self=this;var width=coords.xl-coords.xi,height=coords.yl-coords.yi,xi=coords.xi,yi=coords.yi;var rowOffset=0;var rowIndex=0;var lastRowIndex=0;if(this.options.layout==='grid'){var highWidth=this.children.reduce(function(out,el){out=Math.max(out,el.width);return out;},0);}
return function iterator(el,i){el.shrink=true;var last=self.getLast(i);if(!last){el.position.left=0;el.position.top=0;}else{el.position.left=last.lpos.xl-xi;if(self.options.layout==='grid'){el.position.left+=highWidth-(last.lpos.xl-last.lpos.xi);}
if(el.position.left+el.width<=width){el.position.top=rowOffset;}else{rowOffset+=self.children.slice(rowIndex,i).reduce(function(out,el){if(!self.isRendered(el))return out;out=Math.max(out,el.lpos.yl-el.lpos.yi);return out;},0);lastRowIndex=rowIndex;rowIndex=i;el.position.left=0;el.position.top=rowOffset;}}
if(self.options.layout==='inline'){var above=null;var abovea=Infinity;for(var j=lastRowIndex;j<rowIndex;j++){var l=self.children[j];if(!self.isRendered(l))continue;var abs=Math.abs(el.position.left-(l.lpos.xi-xi));if(abs<abovea){above=l;abovea=abs;}}
if(above){el.position.top=above.lpos.yl-yi;}}
if(el.position.top+el.height>height){}};};Layout.prototype.render=function(){this._emit('prerender');var coords=this._renderCoords();if(!coords){delete this.lpos;return;}
if(coords.xl-coords.xi<=0){coords.xl=Math.max(coords.xl,coords.xi);return;}
if(coords.yl-coords.yi<=0){coords.yl=Math.max(coords.yl,coords.yi);return;}
this.lpos=coords;if(this.border)coords.xi++,coords.xl--,coords.yi++,coords.yl--;if(this.tpadding){coords.xi+=this.padding.left,coords.xl-=this.padding.right;coords.yi+=this.padding.top,coords.yl-=this.padding.bottom;}
var iterator=this.renderer(coords);if(this.border)coords.xi--,coords.xl++,coords.yi--,coords.yl++;if(this.tpadding){coords.xi-=this.padding.left,coords.xl+=this.padding.right;coords.yi-=this.padding.top,coords.yl+=this.padding.bottom;}
this.children.forEach(function(el,i){if(el.screen._ci!==-1){el.index=el.screen._ci++;}
var rendered=iterator(el,i);if(rendered===false){delete el.lpos;return;}
el.render();});this._emit('render',[coords]);return coords;};module.exports=Layout;};BundleModuleCode['term/widgets/tree']=function(module,exports){var Comp=Require('com/compat');var Node=Require('term/widgets/node');var Box=Require('term/widgets/box');var List=Require('term/widgets/list');var Arrows=Require('term/widgets/arrows');function Tree(options){var self=this,height=0;function strequal(str1,str2){var i;var eq=true;if(str1.length!=str2.length)return false;for(i=0;i<str1.length;i++){if(str1.charAt(i)!=str2.charAt(i))eq=false;}
return eq;};if(!instanceOf(this,Node)){return new Tree(options);}
options=options||{};if(!options.style)options.style={border:{fg:'black'},focus:{border:{fg:'red'}}};if(!options.border)options.border={type:'line'};options.style.border._fg=options.style.border.fg;options.bold=true;var self=this;this.options=options;this.data={};this.nodeLines=[];this.lineNbr=0;this.init=true;Box.call(this,options);var boxfocus=this.focus;if(options.height){if(typeof options.height=='number')height=options.height;else if(typeof options.height=='string'){var perc=0;perc=parseInt(options.height);height=this.screen.height*perc/100;}}
options.extended=options.extended||false;options.keys=options.keys||['space','enter'];options.template=options.template||{};options.template.extend=options.template.extend||' [+]';options.template.retract=options.template.retract||' [-]';options.template.lines=options.template.lines||true;this.listOptions={height:0,top:1,width:0,left:1,selectedFg:'white',selectedBg:'blue',fg:"green",keys:true,mouse:true,selectoffset:height>8?4:2,};if(!options.scrollbar)this.listOptions.scrollbar={ch:' ',track:{bg:'yellow'},style:{fg:'cyan',inverse:true}};else if(options.scrollbar!=null)
this.listOptions.scrollbar=options.scrollbar;this.list=new List(this.listOptions);this.list.key(options.keys,function(){var ind=this.getItemIndex(this.selected);var line=self.nodeLines[ind];self.emit('preselect',line);self.nodeLines[ind].extended=!self.nodeLines[ind].extended;self.setData(self.data);self.screen.render();self.emit('select',line);});this.list.on('element click',function(w,ev){var ind=this.getItemIndex(this.selected);var line=self.nodeLines[ind];var pos=ev.x-w.aleft;var item=this.ritems[ind];if(item){self.emit('preselect',line);var len1=self.options.template.extend.length;var len2=self.options.template.retract.length;var roi1=item.indexOf(self.options.template.extend);var roi2=item.indexOf(self.options.template.retract);if((pos>roi1&&pos<roi1+len1)||(pos>roi2&&pos<roi2+len1)){self.nodeLines[ind].extended=!self.nodeLines[ind].extended;self.setData(self.data);self.screen.render();self.emit('select',line);}}});if(options.arrows)
Arrows(self,options,function(){self.list.select(self.list.selected-2);self.screen.render()},function(){self.list.select(self.list.selected+2);self.screen.render()});this.on('mousedown',function(data){self.focus();Box.prototype.render.call(self);self.screen.render();});this.list.on('selected',function(){var ind=this.getItemIndex(this.selected);var line=self.nodeLines[ind];self.emit('selected',line);});this.append(this.list);}
Tree.prototype.walk=function(node,treeDepth){var lines=[];if(!node.parent)
node.parent=null;if(treeDepth==''&&node.name){this.lineNbr=0;this.nodeLines[this.lineNbr++]=node;lines.push(node.name);treeDepth=' ';}
node.depth=treeDepth.length-1;if(node.children&&node.extended){var i=0;if(typeof node.children=='function')
node.childrenContent=node.children(node);if(!node.childrenContent)
node.childrenContent=node.children;for(var child in node.childrenContent){if(!node.childrenContent[child].name)
node.childrenContent[child].name=child;var childIndex=child;child=node.childrenContent[child];child.parent=node;child.position=i++;if(typeof child.extended=='undefined')
child.extended=this.options.extended;if(typeof child.children=='function')
child.childrenContent=child.children(child);else
child.childrenContent=child.children;var isLastChild=child.position==Object.keys(child.parent.childrenContent).length-1;var tree;var suffix='';if(isLastChild){tree='';}else{tree='';}
if(!child.childrenContent||Object.keys(child.childrenContent).length==0){tree+='';}else if(child.extended){tree+='';suffix=this.options.template.retract;}else{tree+='';suffix=this.options.template.extend;}
if(!this.options.template.lines){tree='|-';}
lines.push(treeDepth+tree+child.name+suffix);this.nodeLines[this.lineNbr++]=child;var parentTree;if(isLastChild||!this.options.template.lines){parentTree=treeDepth+" ";}else{parentTree=treeDepth+"";}
lines=lines.concat(this.walk(child,parentTree));}}
return lines;}
Tree.prototype.focus=function(){this.list.focus();}
Tree.prototype.render=function(){if((this.screen.focused==this.list||this.screen.focused==this)){if(this.style.focus.border.fg)this.style.border.fg=this.style.focus.border.fg;}else if((this.screen.focused!=this.list&&this.screen.focused!=this)){if(this.style.border._fg)this.style.border.fg=this.style.border._fg;}
this.list.width=this.width-3;this.list.height=this.height-3;Box.prototype.render.call(this);}
Tree.prototype.setData=function(data){var formatted=[];formatted=this.walk(data,'');this.data=data;if(this.init){this.screen.render();this.init=false;};this.list.setItems(formatted);this.screen.render();}
inheritPrototype(Tree,Box);Tree.prototype.type='tree';module.exports=Tree};FilesEmbedded['term/def/xterm']=function(format){return Base64.decodeBuf('GgEcACYADwCdAWwFeHRlcm18WDExIHRlcm1pbmFsIGVtdWxhdG9yAAABAAABAAAAAQAAAAABAQAAAAAAAAABAAABAAABAAAAAAAAAAABUAAIABgA//////////////////////////8IAEAAAAAEAAYACAAZAB4AJgAqAC4A//85AEoATABQAFcA//9ZAGYA//9qAG4AeAB8AP////+AAIQAiQCOAP////+XAJwA//+hAKYAqwCwALkAvQDEAP//zQDSANgA3gD////////wAP///////wIB//8GAf///////wgB//8NAf//////////EQEVARsBHwEjAScBLQEzATkBPwFFAUkB//9OAf//UgFXAVwBYAFnAf//bgFyAXoB/////////////////////////////4IBiwH/////lAGdAaYBrwG4AcEBygHTAdwB5QH////////uAfIB9wH///wB/wH/////EQIUAh8CIgIkAicCeQL//3wC////////////////fgL//////////4IC//+3Av////+7AsEC/////////////////////////////8cCywL//////////////////////////////////////////////////////////////////88C/////9YC///////////dAuQC6wL/////8gL///kC////////AAP/////////////BwMNAxMDGgMhAygDLwM3Az8DRwNPA1cDXwNnA28DdgN9A4QDiwOTA5sDowOrA7MDuwPDA8sD0gPZA+AD5wPvA/cD/wMHBA8EFwQfBCcELgQ1BDwEQwRLBFMEWwRjBGsEcwR7BIMEigSRBJgE/////////////////////////////////////////////////////////////50EqAStBLUEuQT//////////8IECAX///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9OBf///////1IFXAX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////ZgVpBRtbWgAHAA0AG1slaSVwMSVkOyVwMiVkcgAbWzNnABtbSBtbMkoAG1tLABtbSgAbWyVpJXAxJWRHABtbJWklcDElZDslcDIlZEgACgAbW0gAG1s/MjVsAAgAG1s/MTJsG1s/MjVoABtbQwAbW0EAG1s/MTI7MjVoABtbUAAbW00AGygwABtbNW0AG1sxbQAbWz8xMDQ5aAAbWzRoABtbOG0AG1s3bQAbWzdtABtbNG0AG1slcDElZFgAGyhCABsoQhtbbQAbWz8xMDQ5bAAbWzRsABtbMjdtABtbMjRtABtbPzVoJDwxMDAvPhtbPzVsABtbIXAbWz8zOzRsG1s0bBs+ABtbTAAIABtbM34AG09CABtPUAAbWzIxfgAbT1EAG09SABtPUwAbWzE1fgAbWzE3fgAbWzE4fgAbWzE5fgAbWzIwfgAbT0gAG1syfgAbT0QAG1s2fgAbWzV+ABtPQwAbWzE7MkIAG1sxOzJBABtPQQAbWz8xbBs+ABtbPzFoGz0AG1s/MTAzNGwAG1s/MTAzNGgAG1slcDElZFAAG1slcDElZE0AG1slcDElZEIAG1slcDElZEAAG1slcDElZFMAG1slcDElZEwAG1slcDElZEQAG1slcDElZEMAG1slcDElZFQAG1slcDElZEEAG1tpABtbNGkAG1s1aQAbYwAbWyFwG1s/Mzs0bBtbNGwbPgAbOAAbWyVpJXAxJWRkABs3AAoAG00AJT8lcDkldBsoMCVlGyhCJTsbWzAlPyVwNiV0OzElOyU/JXAyJXQ7NCU7JT8lcDElcDMlfCV0OzclOyU/JXA0JXQ7NSU7JT8lcDcldDs4JTttABtIAAkAG09FAGBgYWFmZmdnaWlqamtrbGxtbW5ub29wcHFxcnJzc3R0dXV2dnd3eHh5eXp6e3t8fH19fn4AG1taABtbPzdoABtbPzdsABtPRgAbT00AG1szOzJ+ABtbMTsyRgAbWzE7MkgAG1syOzJ+ABtbMTsyRAAbWzY7Mn4AG1s1OzJ+ABtbMTsyQwAbWzIzfgAbWzI0fgAbWzE7MlAAG1sxOzJRABtbMTsyUgAbWzE7MlMAG1sxNTsyfgAbWzE3OzJ+ABtbMTg7Mn4AG1sxOTsyfgAbWzIwOzJ+ABtbMjE7Mn4AG1syMzsyfgAbWzI0OzJ+ABtbMTs1UAAbWzE7NVEAG1sxOzVSABtbMTs1UwAbWzE1OzV+ABtbMTc7NX4AG1sxODs1fgAbWzE5OzV+ABtbMjA7NX4AG1syMTs1fgAbWzIzOzV+ABtbMjQ7NX4AG1sxOzZQABtbMTs2UQAbWzE7NlIAG1sxOzZTABtbMTU7Nn4AG1sxNzs2fgAbWzE4OzZ+ABtbMTk7Nn4AG1syMDs2fgAbWzIxOzZ+ABtbMjM7Nn4AG1syNDs2fgAbWzE7M1AAG1sxOzNRABtbMTszUgAbWzE7M1MAG1sxNTszfgAbWzE3OzN+ABtbMTg7M34AG1sxOTszfgAbWzIwOzN+ABtbMjE7M34AG1syMzszfgAbWzI0OzN+ABtbMTs0UAAbWzE7NFEAG1sxOzRSABtbMUsAG1slaSVkOyVkUgAbWzZuABtbPzE7MmMAG1tjABtbMzk7NDltABtbMyU/JXAxJXsxfSU9JXQ0JWUlcDElezN9JT0ldDYlZSVwMSV7NH0lPSV0MSVlJXAxJXs2fSU9JXQzJWUlcDElZCU7bQAbWzQlPyVwMSV7MX0lPSV0NCVlJXAxJXszfSU9JXQ2JWUlcDElezR9JT0ldDElZSVwMSV7Nn0lPSV0MyVlJXAxJWQlO20AG1tNABtbMyVwMSVkbQAbWzQlcDElZG0AG2wAG20AAgAAAD4AfgDvAgEBAAAHABMAGQArADEAOwBCAEkAUABXAF4AZQBsAHMAegCBAIgAjwCWAJ0ApACrALIAuQDAAMcAzgDVANwA4wDqAPEA+AD/AAYBDQEUARsBIgEpATABNwE+AUUBTAFTAVoBYQFoAW8BdgF9AYQBiwGSAZkBoAH//////////wAAAwAGAAkADAAPABIAFQAYAB0AIgAnACwAMQA1ADoAPwBEAEkATgBUAFoAYABmAGwAcgB4AH4AhACKAI8AlACZAJ4AowCpAK8AtQC7AMEAxwDNANMA2QDfAOUA6wDxAPcA/QADAQkBDwEVARsBHwEkASkBLgEzATgBPAFAAUQBG10xMTIHABtdMTI7JXAxJXMHABtbMztKABtdNTI7JXAxJXM7JXAyJXMHABtbMiBxABtbJXAxJWQgcQAbWzM7M34AG1szOzR+ABtbMzs1fgAbWzM7Nn4AG1szOzd+ABtbMTsyQgAbWzE7M0IAG1sxOzRCABtbMTs1QgAbWzE7NkIAG1sxOzdCABtbMTszRgAbWzE7NEYAG1sxOzVGABtbMTs2RgAbWzE7N0YAG1sxOzNIABtbMTs0SAAbWzE7NUgAG1sxOzZIABtbMTs3SAAbWzI7M34AG1syOzR+ABtbMjs1fgAbWzI7Nn4AG1syOzd+ABtbMTszRAAbWzE7NEQAG1sxOzVEABtbMTs2RAAbWzE7N0QAG1s2OzN+ABtbNjs0fgAbWzY7NX4AG1s2OzZ+ABtbNjs3fgAbWzU7M34AG1s1OzR+ABtbNTs1fgAbWzU7Nn4AG1s1Ozd+ABtbMTszQwAbWzE7NEMAG1sxOzVDABtbMTs2QwAbWzE7N0MAG1sxOzJBABtbMTszQQAbWzE7NEEAG1sxOzVBABtbMTs2QQAbWzE7N0EAQVgAWFQAQ3IAQ3MARTMATXMAU2UAU3MAa0RDMwBrREM0AGtEQzUAa0RDNgBrREM3AGtETgBrRE4zAGtETjQAa0RONQBrRE42AGtETjcAa0VORDMAa0VORDQAa0VORDUAa0VORDYAa0VORDcAa0hPTTMAa0hPTTQAa0hPTTUAa0hPTTYAa0hPTTcAa0lDMwBrSUM0AGtJQzUAa0lDNgBrSUM3AGtMRlQzAGtMRlQ0AGtMRlQ1AGtMRlQ2AGtMRlQ3AGtOWFQzAGtOWFQ0AGtOWFQ1AGtOWFQ2AGtOWFQ3AGtQUlYzAGtQUlY0AGtQUlY1AGtQUlY2AGtQUlY3AGtSSVQzAGtSSVQ0AGtSSVQ1AGtSSVQ2AGtSSVQ3AGtVUABrVVAzAGtVUDQAa1VQNQBrVVA2AGtVUDcAa2EyAGtiMQBrYjMAa2MyAA==')};FilesEmbedded['term/def/windows-ansi']=function(format){return Base64.decodeBuf('GgEoACYAEAB9AUQCYW5zaXxhbnNpL3BjLXRlcm0gY29tcGF0aWJsZSB3aXRoIGNvbG9yAAABAAAAAAAAAAAAAAABAQAAAAAAAAABAAAAAAAAAAAAAAAAAAABUAAIABgA//////////////////////////8IAEAAAwAAAAQABgD//wgADQAUABgAHAD//ycAOAA8AP//QAD/////RAD//0gA//9MAFAA/////1QAWgBfAP//////////ZAD//2kAbgBzAHgAgQCHAP///////48AkwD/////////////////////lwD//5sA/////////////50A/////////////////////////////////////6EApQD//6kA////////rQD///////+xAP///////////////////////////////////////7UA//+6AMMAzADVAN4A5wDwAPkAAgELAf//////////FAEZAR4B/////////////zIB//89Af//PwGVAf//mAH/////////////////////////////nAH//9sB////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////3wH/////////////////////////////////////////////////////////////5AHvAfQBBwILAv//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////FAIeAv///////ygCLAIwAjQC/////////////////////////////zgCPgIbW1oABwANABtbMmcAG1tIG1tKABtbSwAbW0oAG1slaSVwMSVkRwAbWyVpJXAxJWQ7JXAyJWRIABtbQgAbW0gAG1tEABtbQwAbW0EAG1tQABtbTQAbWzExbQAbWzVtABtbMW0AG1s4bQAbWzdtABtbN20AG1s0bQAbWyVwMSVkWAAbWzEwbQAbWzA7MTBtABtbbQAbW20AG1tMAAgAG1tCABtbSAAbW0wAG1tEABtbQwAbW0EADRtbUwAbWyVwMSVkUAAbWyVwMSVkTQAbWyVwMSVkQgAbWyVwMSVkQAAbWyVwMSVkUwAbWyVwMSVkTAAbWyVwMSVkRAAbWyVwMSVkQwAbWyVwMSVkVAAbWyVwMSVkQQAbWzRpABtbNWkAJXAxJWMbWyVwMiV7MX0lLSVkYgAbWyVpJXAxJWRkAAoAG1swOzEwJT8lcDEldDs3JTslPyVwMiV0OzQlOyU/JXAzJXQ7NyU7JT8lcDQldDs1JTslPyVwNiV0OzElOyU/JXA3JXQ7OCU7JT8lcDkldDsxMSU7bQAbSAAbW0kAKxAsES0YLhkw22AEYbGm+C3xaLBq2Wu/bNptwG7Fb35wxHHEcsRzX3TDdbR2wXfCeLN583rye+N82H2cfv4AG1taABtbMUsAG1slaSVkOyVkUgAbWzZuABtbPyVbOzAxMjM0NTY3ODldYwAbW2MAG1szOTs0OW0AG1szJXAxJWRtABtbNCVwMSVkbQAbKEIAGylCABsqQgAbK0IAG1sxMW0AG1sxMG0AAQAAAAAAAQADAAEAAABBWAA=')};FilesEmbedded['xterm-color']=undefined
var Base64=Require('os/base64');module.exports=Require('/home/sbosse/proj/jam/js/top/jamapp.js');